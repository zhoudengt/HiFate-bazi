# 办公桌风水分析系统 - 快速开始 🚀

## ✨ 功能概述

**办公桌风水分析系统**是一个基于AI图像识别和传统风水理论的智能分析工具。

### 核心功能
- 📸 **智能识别**：使用 YOLOv8 自动识别办公桌上的物品
- 📍 **方位计算**：精准计算物品位置和八卦方位
- 🎯 **规则匹配**：基于15+条风水规则智能分析
- 💡 **个性化建议**：结合用户八字（喜神忌神）提供定制建议
- 📊 **可视化报告**：美观的前端界面展示分析结果

### 技术架构
```
YOLOv8 图像识别 + gRPC微服务 + FastAPI + MySQL + Redis
```

---

## 🎬 快速开始（3分钟）

### 步骤1：初始化系统
```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
./scripts/init_desk_fengshui.sh
```
这会自动完成数据库、依赖、gRPC代码的初始化。

### 步骤2：启动服务
```bash
# 启动办公桌风水微服务
./scripts/start_desk_fengshui_service.sh

# 启动主服务（如果未运行）
./restart_server.sh
```

### 步骤3：打开前端页面
在浏览器中访问：
```
http://localhost:8001/frontend/desk-fengshui.html
```

### 步骤4：开始分析
1. 上传您的办公桌照片
2. （可选）填写八字信息获得个性化建议
3. 点击"开始分析"
4. 查看风水评分和优化建议

---

## 📁 项目文件结构

```
HiFate-bazi/
├── services/desk_fengshui/          # 微服务目录
│   ├── analyzer.py                  # 主分析器
│   ├── item_detector.py             # 物品检测器（YOLO）
│   ├── position_calculator.py       # 方位计算器
│   ├── rule_engine.py               # 规则引擎
│   ├── bazi_client.py               # 八字客户端
│   ├── grpc_server.py               # gRPC服务器
│   └── requirements.txt             # Python依赖
│
├── server/
│   ├── api/v2/desk_fengshui_api.py  # API接口
│   └── db/migrations/               # 数据库迁移
│       └── create_desk_fengshui_tables.sql
│
├── frontend/
│   ├── desk-fengshui.html           # 前端页面
│   ├── js/desk-fengshui.js          # 前端交互
│   └── css/desk-fengshui.css        # 前端样式
│
├── proto/
│   └── desk_fengshui.proto          # gRPC协议定义
│
├── scripts/
│   ├── init_desk_fengshui.sh        # 初始化脚本
│   ├── start_desk_fengshui_service.sh  # 启动脚本
│   └── stop_desk_fengshui_service.sh   # 停止脚本
│
└── docs/
    ├── 员工工位风水分析-技术方案.md
    ├── 办公桌风水分析-使用指南.md
    └── 办公桌风水分析-测试指南.md
```

---

## 📊 数据库表

### `desk_fengshui_rules` - 风水规则表
```sql
-- 已预装15+条规则，包括：
- 5条基础规则（烧水壶、绿植、电脑、书籍、水杯等）
- 2条禁忌规则（仙人掌、镜子）
- 5条五行个性化规则（木火土金水）
- 其他辅助规则
```

### `desk_analysis_records` - 分析记录表
记录每次分析的结果，用于数据统计和用户历史查询。

---

## 🔌 API 接口

### 1. 分析接口
```http
POST /api/v2/desk-fengshui/analyze
Content-Type: multipart/form-data

参数：
- image: 办公桌照片（必需）
- solar_date: 出生日期（可选）
- solar_time: 出生时间（可选）
- gender: 性别（可选）
- use_bazi: 是否使用八字分析（默认true）
```

### 2. 规则查询接口
```http
GET /api/v2/desk-fengshui/rules?rule_type=basic&item_name=kettle
```

### 3. 健康检查
```http
GET /api/v2/desk-fengshui/health
```

---

## 🎯 使用示例

### 示例1：基础分析（不使用八字）
```bash
curl -X POST http://localhost:8001/api/v2/desk-fengshui/analyze \
  -F "image=@my_desk.jpg" \
  -F "use_bazi=false"
```

### 示例2：完整分析（包含八字）
```bash
curl -X POST http://localhost:8001/api/v2/desk-fengshui/analyze \
  -F "image=@my_desk.jpg" \
  -F "solar_date=1990-01-01" \
  -F "solar_time=12:00" \
  -F "gender=male" \
  -F "use_bazi=true"
```

### 响应示例
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "name": "laptop",
        "label": "笔记本电脑",
        "position": {
          "relative": "center",
          "relative_name": "中央"
        }
      }
    ],
    "adjustments": [
      {
        "item": "烧水壶",
        "current_position": "右侧（白虎位）",
        "ideal_position": "左侧（青龙位）",
        "reason": "烧水壶五行属火，应放在青龙位（左侧）...",
        "priority": "high"
      }
    ],
    "additions": [
      {
        "item_label": "水养植物",
        "position": "北方",
        "reason": "您的喜神为水，建议放置水相关摆件...",
        "element": "水"
      }
    ],
    "score": 75,
    "summary": "您的办公桌整体风水布局良好，有1处需要调整...",
    "xishen": "水",
    "jishen": "火"
  }
}
```

---

## 🔧 管理命令

### 启动/停止服务
```bash
# 启动
./scripts/start_desk_fengshui_service.sh

# 停止
./scripts/stop_desk_fengshui_service.sh

# 查看状态
ps aux | grep desk_fengshui
```

### 查看日志
```bash
# 实时日志
tail -f logs/desk_fengshui_9010.log

# 最近50行
tail -n 50 logs/desk_fengshui_9010.log

# 搜索错误
grep "ERROR" logs/desk_fengshui_9010.log
```

### 数据库操作
```bash
# 连接数据库
mysql -h 127.0.0.1 -P 13306 -u root -proot123456 bazi_system

# 查看规则
SELECT rule_code, item_label, rule_type FROM desk_fengshui_rules;

# 查看分析记录
SELECT id, score, created_at FROM desk_analysis_records ORDER BY id DESC LIMIT 10;
```

---

## 📚 文档索引

| 文档 | 说明 |
|------|------|
| [技术方案](docs/员工工位风水分析-技术方案.md) | 详细的技术设计和实现方案 |
| [使用指南](docs/办公桌风水分析-使用指南.md) | 用户使用手册和FAQ |
| [测试指南](docs/办公桌风水分析-测试指南.md) | 测试流程和检查清单 |

---

## ⚙️ 配置说明

### 服务端口
- 主服务：8001
- 办公桌风水微服务：9010
- MySQL：13306
- Redis：16379

### 依赖服务
- 八字核心服务（9001）：计算八字
- 旺衰分析服务（9003）：计算喜神忌神

### Python依赖
主要依赖包：
- `ultralytics` - YOLO v8
- `opencv-python` - 图像处理
- `grpcio` - gRPC通信
- `fastapi` - Web框架
- `pymysql` - MySQL驱动

---

## 🐛 常见问题

### Q: 物品检测不准确怎么办？
A: 确保照片清晰、光线充足。目前使用YOLO预训练模型，支持常见物品。如需识别特殊物品，需要自定义训练模型。

### Q: 如何添加新的风水规则？
A: 直接在 `desk_fengshui_rules` 表中插入新规则，或修改 `create_desk_fengshui_tables.sql` 脚本。

### Q: 支持哪些物品类型？
A: 
- ✅ 已支持：笔记本电脑、鼠标、键盘、杯子、水瓶、书籍、绿植、手机、时钟等
- 🔧 扩展中：烧水壶、笔筒、日历、相框、仙人掌、招财猫、鱼缸、镜子

### Q: 分析需要多长时间？
A: 通常2-5秒，具体取决于图片大小和服务器性能。

---

## 🎉 功能特点

### ✅ 已实现
- [x] 图像上传（拖拽/点击）
- [x] 物品识别（YOLO v8）
- [x] 方位计算（九宫格+八卦）
- [x] 规则匹配（15+条规则）
- [x] 八字集成（喜神忌神）
- [x] 评分系统（0-100分）
- [x] 建议生成（调整/增加/删除）
- [x] 美观的前端界面
- [x] 完整的API文档

### 🚧 未来优化
- [ ] 自定义YOLO模型训练
- [ ] 支持多角度照片
- [ ] 生成PDF报告
- [ ] 3D可视化展示
- [ ] 用户历史记录
- [ ] 分享功能

---

## 👥 开发规范

本项目遵循 [HiFate-bazi 开发规范](README.md)：
- ✅ 最小影响原则
- ✅ 独立微服务架构
- ✅ 不影响现有功能
- ✅ 完整的文档和测试

---

## 📝 总结

**办公桌风水分析系统**是一个完整的端到端解决方案，从图像识别到风水建议，从后端服务到前端界面，全部实现并可直接使用。

### 核心优势
1. 🚀 **开箱即用**：一键初始化，快速启动
2. 🎯 **准确可靠**：基于YOLO和传统风水理论
3. 💡 **智能个性化**：结合用户八字定制建议
4. 🎨 **界面美观**：现代化的用户体验
5. 📚 **文档完善**：详细的使用和开发文档

祝您使用愉快，办公室风水旺旺旺！🌟

---

**如有问题，请参考完整文档或提交Issue。**

