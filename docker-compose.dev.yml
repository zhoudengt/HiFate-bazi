# HiFate-bazi Docker Compose 开发环境配置
# 使用方式：docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

version: '3.8'

services:
  # 主服务 - 开发模式
  web:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      # 挂载源代码，支持热更新
      - ./:/app
      # 排除缓存目录，避免权限问题
      - /app/__pycache__
      - /app/.pytest_cache
      - /app/logs
    environment:
      # 开发环境配置
      APP_ENV: development
      DEBUG: "True"
      FLASK_ENV: development
      HOT_RELOAD: "True"
      LOG_LEVEL: DEBUG
    command: python server/start.py 8001 --reload
    # 开发模式：失败后不自动重启（方便调试）
    restart: "no"
    
  # 八字分析服务 - 开发模式
  bazi-analyzer:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - ./:/app
      - /app/__pycache__
    environment:
      APP_ENV: development
      DEBUG: "True"
      LOG_LEVEL: DEBUG
    restart: "no"
    
  # 运势分析服务 - 开发模式
  fortune-analyzer:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - ./:/app
      - /app/__pycache__
    environment:
      APP_ENV: development
      DEBUG: "True"
      LOG_LEVEL: DEBUG
    restart: "no"
    
  # 规则服务 - 开发模式
  rule-service:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - ./:/app
      - /app/__pycache__
    environment:
      APP_ENV: development
      DEBUG: "True"
      LOG_LEVEL: DEBUG
    restart: "no"

  # MySQL - 开发模式（保留数据，方便调试）
  mysql:
    ports:
      - "13306:3306"  # 暴露到宿主机，方便 TablePlus 连接
    environment:
      MYSQL_ROOT_PASSWORD: root  # 开发环境使用简单密码
    volumes:
      # 挂载测试数据
      - ./scripts/test_data.sql:/docker-entrypoint-initdb.d/test_data.sql

  # Redis - 开发模式
  redis:
    ports:
      - "16379:6379"  # 暴露到宿主机
    command: redis-server --appendonly no  # 开发环境不持久化

