# 系统资源占用分析报告

## 概述

本报告分析 Node1 (8.210.52.217) 和 Node2 (47.243.160.43) 的系统资源占用情况，包括磁盘、内存、CPU 和 Docker 资源。

## 快速诊断命令

### 在服务器上执行以下命令获取资源占用信息：

```bash
# 1. 磁盘空间使用情况
echo "=== 磁盘空间使用 ==="
df -h

# 2. 各目录占用情况（TOP 20）
echo "=== 目录占用 TOP 20 ==="
du -sh /* 2>/dev/null | sort -rh | head -20

# 3. 项目目录占用
echo "=== 项目目录占用 ==="
du -sh /opt/* 2>/dev/null | sort -rh

# 4. 内存使用情况
echo "=== 内存使用情况 ==="
free -h

# 5. CPU 使用情况
echo "=== CPU 使用情况 ==="
top -bn1 | grep "Cpu(s)" | awk '{print $2 $3 $4 $5 $6 $7 $8}'

# 6. Docker 资源占用
echo "=== Docker 资源占用 ==="
docker system df

# 7. 各容器资源占用
echo "=== 容器资源占用 ==="
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}\t{{.NetIO}}\t{{.BlockIO}}"

# 8. 容器磁盘占用
echo "=== 容器磁盘占用 ==="
docker ps -s --format "table {{.Names}}\t{{.Size}}"

# 9. Docker 镜像占用
echo "=== Docker 镜像占用 ==="
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | sort -k3 -h -r | head -20

# 10. 大文件查找（>100MB）
echo "=== 大文件查找（>100MB）==="
find / -type f -size +100M 2>/dev/null | head -20

# 11. 日志文件占用
echo "=== 日志文件占用 ==="
du -sh /var/log/* 2>/dev/null | sort -rh | head -10
du -sh /opt/HiFate-bazi/logs/* 2>/dev/null | sort -rh | head -10

# 12. Docker 日志占用
echo "=== Docker 日志占用 ==="
docker ps --format "{{.Names}}" | while read container; do
    size=$(docker inspect --format='{{.LogPath}}' $container 2>/dev/null | xargs ls -lh 2>/dev/null | awk '{print $5}')
    if [ -n "$size" ]; then
        echo "$container: $size"
    fi
done
```

## 常见资源占用来源

### 1. 磁盘空间占用

#### Docker 资源（最常见）
- **未使用的镜像**：可能占用数 GB
- **停止的容器**：每个容器占用少量空间
- **未使用的卷**：可能占用大量空间
- **构建缓存**：Docker buildx 缓存

**检查命令**：
```bash
docker system df
```

**清理命令**（谨慎使用）：
```bash
# 清理未使用的镜像、容器、网络
docker system prune -a

# 清理构建缓存
docker builder prune -a

# 清理未使用的卷（危险！）
docker volume prune
```

#### 日志文件
- **系统日志**：`/var/log/` 目录
- **应用日志**：`/opt/HiFate-bazi/logs/`
- **Docker 日志**：`/var/lib/docker/containers/`
- **Nginx 日志**：`/var/log/nginx/`

**检查命令**：
```bash
# 系统日志
du -sh /var/log/* | sort -rh | head -10

# 应用日志
du -sh /opt/HiFate-bazi/logs/* | sort -rh | head -10

# Docker 日志
docker ps --format "{{.Names}}" | while read name; do
    size=$(docker inspect --format='{{.LogPath}}' $name 2>/dev/null | xargs ls -lh 2>/dev/null | awk '{print $5}')
    echo "$name: $size"
done
```

**清理命令**：
```bash
# 清理旧日志（30天前）
find /var/log -name "*.log" -mtime +30 -delete
find /opt/HiFate-bazi/logs -name "*.log" -mtime +30 -delete

# 清理 Docker 日志（需要配置日志轮转）
# 在 /etc/docker/daemon.json 中配置：
# {
#   "log-driver": "json-file",
#   "log-opts": {
#     "max-size": "10m",
#     "max-file": "3"
#   }
# }
```

#### 数据库文件
- **MySQL 数据文件**：`/var/lib/docker/volumes/` 或容器内
- **MySQL 日志**：慢查询日志、错误日志
- **数据库备份**：如果配置了自动备份

**检查命令**：
```bash
# MySQL 数据目录
docker exec hifate-mysql-master du -sh /var/lib/mysql

# MySQL 日志
docker exec hifate-mysql-master ls -lh /var/lib/mysql/*.log
```

#### 代码和依赖
- **项目代码**：`/opt/HiFate-bazi/`（通常 < 1GB）
- **Python 依赖**：虚拟环境、pip 缓存
- **模型文件**：YOLO 模型、BERT 模型等

**检查命令**：
```bash
# 项目目录
du -sh /opt/HiFate-bazi

# Python 缓存
find /opt/HiFate-bazi -name "__pycache__" -type d -exec du -sh {} \; | sort -rh | head -10
find /opt/HiFate-bazi -name "*.pyc" -exec du -sh {} \; | sort -rh | head -10

# 模型文件
du -sh /opt/HiFate-bazi/models_cache/* 2>/dev/null
du -sh /opt/HiFate-bazi/tuned_models/* 2>/dev/null
du -sh /opt/HiFate-bazi/*.pt 2>/dev/null
```

### 2. 内存占用

#### 系统内存分布
- **应用程序内存**：Docker 容器内存使用
- **系统缓存**：buff/cache（正常，可自动释放）
- **系统进程**：系统服务、守护进程

**检查命令**：
```bash
# 系统内存
free -h

# 容器内存使用
docker stats --no-stream

# 系统进程内存占用 TOP 10
ps aux --sort=-%mem | head -11
```

#### Docker 容器内存占用
根据项目配置，主要容器包括：
- **hifate-web**：主 Web 服务（通常 200-500MB）
- **hifate-mysql-master/slave**：MySQL 数据库（通常 500MB-1GB）
- **hifate-redis-master/slave**：Redis 缓存（通常 100-200MB）
- **hifate-nginx**：Nginx 负载均衡（通常 50-100MB）
- **微服务容器**：bazi-core, bazi-fortune 等（每个 100-300MB）

**检查命令**：
```bash
# 容器内存使用详情
docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}\t{{.MemPerc}}"

# 容器内存限制
docker inspect $(docker ps -q) --format '{{.Name}}: {{.HostConfig.Memory}}' | grep -v ": 0"
```

### 3. CPU 占用

#### CPU 使用情况
- **系统负载**：`load average`
- **各进程 CPU 使用率**
- **容器 CPU 使用率**

**检查命令**：
```bash
# 系统负载
uptime

# CPU 使用率
top -bn1 | grep "Cpu(s)"

# 容器 CPU 使用率
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}"
```

### 4. Docker 资源占用详情

#### 镜像占用
- **基础镜像**：nginx:alpine, python:3.11 等
- **应用镜像**：hifate-bazi:latest 等
- **未使用的镜像**：旧版本镜像

**检查命令**：
```bash
# 镜像列表和大小
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | sort -k3 -h -r

# 未使用的镜像
docker images -f "dangling=true"
```

#### 容器占用
- **运行中的容器**：实际占用空间
- **停止的容器**：占用少量空间
- **容器日志**：可能占用大量空间

**检查命令**：
```bash
# 容器大小
docker ps -s

# 停止的容器
docker ps -a -f "status=exited"
```

#### 卷占用
- **数据卷**：MySQL 数据、Redis 数据等
- **未使用的卷**：可能占用大量空间

**检查命令**：
```bash
# 卷列表和大小
docker volume ls
docker system df -v
```

## 资源占用分析脚本

### 使用项目提供的脚本

```bash
# 资源使用情况分析
cd /opt/HiFate-bazi
bash scripts/deploy/analyze_resource_usage.sh

# 服务器诊断
bash diagnose_server.sh
```

### 自定义分析脚本

创建 `check_system_resources.sh`：

```bash
#!/bin/bash
# 系统资源占用检查脚本

echo "========================================"
echo "系统资源占用分析"
echo "时间: $(date '+%Y-%m-%d %H:%M:%S')"
echo "========================================"
echo ""

# 1. 磁盘空间
echo "【1】磁盘空间使用情况："
df -h | grep -E "^/dev|Filesystem"
echo ""

# 2. 目录占用 TOP 10
echo "【2】目录占用 TOP 10："
du -sh /* 2>/dev/null | sort -rh | head -10
echo ""

# 3. 项目目录占用
echo "【3】项目目录占用："
if [ -d "/opt/HiFate-bazi" ]; then
    du -sh /opt/HiFate-bazi
fi
if [ -d "/opt/hifate-frontend" ]; then
    du -sh /opt/hifate-frontend
fi
echo ""

# 4. 内存使用
echo "【4】内存使用情况："
free -h
echo ""

# 5. Docker 资源
echo "【5】Docker 资源占用："
docker system df 2>/dev/null || echo "Docker 未运行"
echo ""

# 6. 容器资源占用
echo "【6】容器资源占用："
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}" 2>/dev/null || echo "无法获取容器信息"
echo ""

# 7. 大文件查找
echo "【7】大文件（>100MB）："
find / -type f -size +100M 2>/dev/null | head -10
echo ""

# 8. 日志文件占用
echo "【8】日志文件占用："
echo "系统日志："
du -sh /var/log/* 2>/dev/null | sort -rh | head -5
echo "应用日志："
if [ -d "/opt/HiFate-bazi/logs" ]; then
    du -sh /opt/HiFate-bazi/logs/* 2>/dev/null | sort -rh | head -5
fi
echo ""

# 9. Docker 镜像占用
echo "【9】Docker 镜像占用 TOP 10："
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" 2>/dev/null | sort -k3 -h -r | head -10 || echo "无法获取镜像信息"
echo ""

echo "========================================"
echo "分析完成"
echo "========================================"
```

## 资源清理建议

### 安全清理（推荐）

```bash
# 1. 清理未使用的 Docker 镜像
docker image prune -a

# 2. 清理停止的容器
docker container prune

# 3. 清理未使用的网络
docker network prune

# 4. 清理构建缓存
docker builder prune -a

# 5. 清理旧日志（30天前）
find /var/log -name "*.log" -mtime +30 -delete
find /opt/HiFate-bazi/logs -name "*.log" -mtime +30 -delete

# 6. 清理 Python 缓存
find /opt/HiFate-bazi -name "__pycache__" -type d -exec rm -r {} + 2>/dev/null
find /opt/HiFate-bazi -name "*.pyc" -delete 2>/dev/null
```

### 谨慎清理（需要确认）

```bash
# 1. 清理所有未使用的 Docker 资源（包括卷）
docker system prune -a --volumes

# 2. 清理未使用的卷（可能包含数据）
docker volume prune

# 3. 清理所有 Docker 日志（需要重启容器）
truncate -s 0 /var/lib/docker/containers/*/*-json.log
```

### 危险操作（不推荐）

```bash
# ❌ 不要执行以下命令，除非完全确定：
# rm -rf /var/lib/docker/  # 会删除所有 Docker 数据
# rm -rf /opt/HiFate-bazi/  # 会删除项目代码
# docker system prune -a --volumes --force  # 会删除所有未使用的资源
```

## 资源优化建议

### 1. Docker 日志轮转

配置 `/etc/docker/daemon.json`：

```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

然后重启 Docker：
```bash
sudo systemctl restart docker
```

### 2. 定期清理脚本

创建定时任务（crontab）：

```bash
# 每天凌晨 2 点清理
0 2 * * * docker system prune -af --filter "until=168h" >> /var/log/docker-cleanup.log 2>&1
```

### 3. 监控告警

配置磁盘使用率告警：
- 磁盘使用率 > 80%：警告
- 磁盘使用率 > 90%：严重告警

## 常见问题

### Q1: 磁盘满了怎么办？

**立即处理**：
```bash
# 1. 清理 Docker 资源
docker system prune -a

# 2. 清理日志
find /var/log -name "*.log" -mtime +7 -delete

# 3. 清理旧镜像
docker image prune -a
```

### Q2: 内存不足怎么办？

**检查内存使用**：
```bash
free -h
docker stats --no-stream
```

**优化建议**：
1. 限制容器内存使用（在 docker-compose.yml 中配置）
2. 增加 swap 空间
3. 优化应用内存使用

### Q3: CPU 使用率过高？

**检查 CPU 使用**：
```bash
top
docker stats --no-stream
```

**优化建议**：
1. 限制容器 CPU 使用
2. 优化应用性能
3. 考虑升级服务器配置

## 相关文档

- `deploy/docs/04-日常运维.md` - 日常运维指南
- `deploy/docs/05-故障处理.md` - 故障处理指南
- `scripts/deploy/analyze_resource_usage.sh` - 资源使用分析脚本
- `diagnose_server.sh` - 服务器诊断脚本






