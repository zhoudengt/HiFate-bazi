# HiFate-bazi å…«å­—ç³»ç»Ÿ - AI å¼€å‘è§„èŒƒ

## âš ï¸ æ ¸å¿ƒåŸåˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰

### ğŸ”´ 0. é›¶åœæœºåŸåˆ™ ã€è®¾è®¡å‰æã€‘

> **æ‰€æœ‰è®¾è®¡å¿…é¡»ä¿è¯æœåŠ¡ä¸ä¸­æ–­ï¼Œè¿™æ˜¯ä¸€åˆ‡è®¾è®¡çš„åŸºç¡€ã€‚**

| åœºæ™¯ | è¦æ±‚ | å®ç°æ–¹å¼ |
|------|------|----------|
| **çƒ­æ›´æ–°** | âœ… é›¶åœæœº | ä»£ç ä¿®æ”¹è‡ªåŠ¨é‡è½½ï¼Œæ— éœ€é‡å¯ |
| **ç‰ˆæœ¬å‘å¸ƒ** | âœ… é›¶åœæœº | æ»šåŠ¨æ›´æ–°ï¼Œæ–°æ—§å®¹å™¨å¹³æ»‘åˆ‡æ¢ |
| **åŠŸèƒ½å¢åŠ ** | âœ… é›¶åœæœº | å‘åå…¼å®¹ï¼Œå¢é‡éƒ¨ç½² |
| **æ•°æ®åº“å˜æ›´** | âœ… é›¶åœæœº | åªåŠ å­—æ®µä¸åˆ å­—æ®µï¼Œè¿ç§»è„šæœ¬ |
| **é…ç½®æ›´æ–°** | âœ… é›¶åœæœº | ç¯å¢ƒå˜é‡/Redis çƒ­åŠ è½½ |
| **è§„åˆ™æ›´æ–°** | âœ… é›¶åœæœº | æ•°æ®åº“+æ¸…ç¼“å­˜ï¼Œæ— éœ€é‡å¯ |

### 1. æœ€å°å½±å“åŸåˆ™ ã€æœ€é‡è¦ã€‘
- **åšå†³ä¸å¯æ”¹åŠ¨ä¸ä¹‹æ— å…³çš„ä»£ç **
- ä¿®æ”¹ä¼šå¼•èµ·å…¶ä»–åŠŸèƒ½å˜åŒ–æ—¶ï¼Œ**å¿…é¡»å…ˆå’¨è¯¢ç”¨æˆ·**
- æ¯æ¬¡ä¿®æ”¹å‰æ˜ç¡®å½±å“èŒƒå›´ï¼ˆä½/ä¸­/é«˜ï¼‰
- é«˜å½±å“ä¿®æ”¹å¿…é¡»ç”¨æˆ·ç¡®è®¤

### 2. gRPC ä¼˜å…ˆåŸåˆ™ ã€æ¶æ„åŸºç¡€ã€‘
- **æ‰€æœ‰æœåŠ¡é—´äº¤äº’å¿…é¡»ä½¿ç”¨ gRPC**
- **å‰ç«¯ä¸åç«¯äº¤äº’é€šè¿‡ gRPC-Web ç½‘å…³**
- REST API ä»…ä½œä¸ºå…¼å®¹å±‚ï¼Œæ–°åŠŸèƒ½å¿…é¡»åŒæ—¶æ³¨å†Œ gRPC ç«¯ç‚¹

---

## ğŸ”Œ gRPC äº¤äº’è§„èŒƒ ã€é‡è¦ã€‘

### æ¶æ„æ¦‚è§ˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    gRPC-Web     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     gRPC      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  Web æœåŠ¡      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  å¾®æœåŠ¡     â”‚
â”‚  (Browser)  â”‚                 â”‚  (Port 8001)   â”‚               â”‚ (9001-9010) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                â”‚                                â”‚
      â”‚                                â†“                                â”‚
      â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
      â”‚                         â”‚   MySQL     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                         â”‚   Redis     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‰ç«¯è°ƒç”¨è§„èŒƒ
```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ gRPC-Web ç½‘å…³
const result = await api.post('/bazi/formula-analysis', {
    solar_date: '2025-01-15',
    solar_time: '12:00',
    gender: 'male'
});

// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ REST API
const result = await fetch('/api/v1/bazi/formula-analysis', {...});
```

### åç«¯æ³¨å†Œè§„èŒƒ
```python
# 1. åœ¨ server/api/v1/ ä¸‹åˆ›å»º REST API
@router.post("/bazi/new-feature")
async def new_feature(request: NewFeatureRequest):
    ...

# 2. åœ¨ server/api/grpc_gateway.py æ³¨å†Œ gRPC ç«¯ç‚¹ï¼ˆå¿…é¡»ï¼ï¼‰
@_register("/bazi/new-feature")
async def _handle_new_feature(payload: Dict[str, Any]):
    request_model = NewFeatureRequest(**payload)
    return await new_feature(request_model)
```

### æœåŠ¡é—´è°ƒç”¨è§„èŒƒ
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ gRPC å®¢æˆ·ç«¯
from src.clients.bazi_core_client_grpc import BaziCoreClientGrpc
result = BaziCoreClientGrpc.calculate_bazi(...)

# âŒ é”™è¯¯ï¼šç›´æ¥ HTTP è°ƒç”¨
import requests
result = requests.get('http://localhost:9001/api/...')
```

### gRPC æœåŠ¡ç«¯å£æ¸…å•
| æœåŠ¡ | ç«¯å£ | ç”¨é€” |
|------|------|------|
| Web æœåŠ¡ | 8001 | HTTP + gRPC-Web ç½‘å…³ |
| bazi-core | 9001 | å…«å­—æ ¸å¿ƒè®¡ç®— |
| bazi-fortune | 9002 | è¿åŠ¿è®¡ç®— |
| bazi-analyzer | 9003 | å…«å­—åˆ†æ |
| bazi-rule | 9004 | è§„åˆ™åŒ¹é… |
| fortune-analysis | 9005 | è¿åŠ¿åˆ†æ |
| payment | 9006 | æ”¯ä»˜æœåŠ¡ |
| fortune-rule | 9007 | è¿åŠ¿è§„åˆ™ |
| intent | 9008 | æ„å›¾è¯†åˆ« |
| optimizer | 9009 | æç¤ºä¼˜åŒ– |
| desk-fengshui | 9010 | é£æ°´åˆ†æ |

---

## ğŸ“œ è§„åˆ™å¼€å‘è§„èŒƒ ã€æ ¸å¿ƒã€‘

### ğŸ”´ è§„åˆ™å­˜å‚¨è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

> **æ‰€æœ‰è§„åˆ™å¿…é¡»å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œç¦æ­¢ä»æ–‡ä»¶è¯»å–ï¼**

| å­˜å‚¨æ–¹å¼ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| **MySQL æ•°æ®åº“** | âœ… **å”¯ä¸€æ¥æº** | æ‰€æœ‰è§„åˆ™å­˜å‚¨åœ¨ `bazi_rules` è¡¨ |
| Excel æ–‡ä»¶ (.xlsx) | âŒ **ç¦æ­¢** | ä»…ç”¨äºå¯¼å…¥ï¼Œå¯¼å…¥ååˆ é™¤æˆ–å½’æ¡£ |
| Word æ–‡ä»¶ (.docx) | âŒ **ç¦æ­¢** | ä»…ç”¨äºå¯¼å…¥ï¼Œå¯¼å…¥ååˆ é™¤æˆ–å½’æ¡£ |
| JSON æ–‡ä»¶ (.json) | âŒ **ç¦æ­¢** | ä»…ç”¨äºå¯¼å…¥ï¼Œå¯¼å…¥ååˆ é™¤æˆ–å½’æ¡£ |
| é…ç½®æ–‡ä»¶ | âŒ **ç¦æ­¢** | ä¸å…è®¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç è§„åˆ™ |

**å®ç°è¦æ±‚**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä»æ•°æ®åº“åŠ è½½è§„åˆ™
from server.services.rule_service import RuleService
rules = RuleService.match_rules(bazi_data, rule_types=['wealth'])

# âŒ é”™è¯¯ï¼šä»æ–‡ä»¶è¯»å–è§„åˆ™
import json
with open('rules.json') as f:
    rules = json.load(f)  # ç¦æ­¢ï¼

# âŒ é”™è¯¯ï¼šä» Excel è¯»å–è§„åˆ™
import pandas as pd
df = pd.read_excel('rules.xlsx')  # ç¦æ­¢ï¼
```

**ä»£ç æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ‰€æœ‰è§„åˆ™åŒ¹é…ä½¿ç”¨ `RuleService`
- [ ] æ²¡æœ‰ `load_from_file`ã€`read_excel`ã€`read_json` ç­‰æ–‡ä»¶è¯»å–è°ƒç”¨
- [ ] æ²¡æœ‰ç¡¬ç¼–ç çš„è§„åˆ™æ•°æ®
- [ ] è§„åˆ™å¯¼å…¥è„šæœ¬ä»…ç”¨äºä¸€æ¬¡æ€§å¯¼å…¥ï¼Œä¸ç”¨äºè¿è¡Œæ—¶è¯»å–

**åºŸå¼ƒä»£ç æ ‡è®°**ï¼š
```python
# âš ï¸ å·²åºŸå¼ƒï¼šä»¥ä¸‹æ–¹æ³•ä»…ç”¨äºå…¼å®¹ï¼Œæ–°ä»£ç ç¦æ­¢ä½¿ç”¨
# - RuleEngine.load_from_file()  # å·²åºŸå¼ƒ
# - FormulaRuleService.load_rules()  # å·²åºŸå¼ƒï¼Œæ”¹ç”¨ RuleService
```

---

### è§„åˆ™å¼€å‘å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è§„åˆ™å¼€å‘æ ‡å‡†æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. å‡†å¤‡é˜¶æ®µ                                                                â”‚
â”‚     â”œâ”€â”€ è·å–è§„åˆ™æ–‡æ¡£ï¼ˆExcel/JSONï¼‰                                           â”‚
â”‚     â”œâ”€â”€ åˆ†æè§„åˆ™ç»“æ„ï¼ˆç±»å‹ã€æ¡ä»¶ã€ç»“æœï¼‰                                       â”‚
â”‚     â””â”€â”€ è¯†åˆ«æ–°æ¡ä»¶ç±»å‹ï¼ˆæ˜¯å¦éœ€è¦æ‰©å±•è§„åˆ™å¼•æ“ï¼‰                                  â”‚
â”‚                                                                             â”‚
â”‚  2. æ¡ä»¶ç±»å‹æ£€æŸ¥                                                             â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥ rule_condition.py æ˜¯å¦æ”¯æŒæ‰€éœ€æ¡ä»¶                               â”‚
â”‚     â”œâ”€â”€ å¦‚ä¸æ”¯æŒ â†’ å…ˆæ‰©å±•è§„åˆ™å¼•æ“                                             â”‚
â”‚     â””â”€â”€ æ‰©å±•åç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯                                                â”‚
â”‚                                                                             â”‚
â”‚  3. ç¼–å†™å¯¼å…¥è„šæœ¬                                                             â”‚
â”‚     â”œâ”€â”€ ä½ç½®ï¼šscripts/migration/import_xxx_rules.py                         â”‚
â”‚     â”œâ”€â”€ è§£æè§„åˆ™æ–‡æ¡£                                                         â”‚
â”‚     â”œâ”€â”€ è½¬æ¢ä¸ºæ•°æ®åº“æ ¼å¼                                                     â”‚
â”‚     â”œâ”€â”€ æ ‡è®°æ­§ä¹‰è§„åˆ™å¾…ç¡®è®¤                                                   â”‚
â”‚     â””â”€â”€ æ”¯æŒ --dry-run é¢„è§ˆ                                                  â”‚
â”‚                                                                             â”‚
â”‚  4. æ‰§è¡Œå¯¼å…¥                                                                 â”‚
â”‚     â”œâ”€â”€ å…ˆ --dry-run ç¡®è®¤æ— è¯¯                                                â”‚
â”‚     â”œâ”€â”€ å¤„ç†æ­§ä¹‰è§„åˆ™ï¼ˆä¸ç”¨æˆ·ç¡®è®¤ï¼‰                                            â”‚
â”‚     â”œâ”€â”€ æ­£å¼å¯¼å…¥æ•°æ®åº“                                                       â”‚
â”‚     â””â”€â”€ éªŒè¯è§„åˆ™æ•°é‡å’Œå†…å®¹                                                   â”‚
â”‚                                                                             â”‚
â”‚  5. å‰ç«¯é€‚é…                                                                 â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥ typeLabels æ˜¯å¦åŒ…å«æ–°ç±»å‹                                       â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥ statistics ç»Ÿè®¡æ˜¯å¦æ˜¾ç¤º                                         â”‚
â”‚     â””â”€â”€ æµ‹è¯•å‰ç«¯é¡µé¢å±•ç¤º                                                     â”‚
â”‚                                                                             â”‚
â”‚  6. åç«¯é€‚é…                                                                 â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥ formula_analysis.py ç±»å‹æ˜ å°„                                    â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥ matched_rules åˆå§‹åŒ–                                            â”‚
â”‚     â””â”€â”€ æ£€æŸ¥ statistics è¿”å›å­—æ®µ                                             â”‚
â”‚                                                                             â”‚
â”‚  7. æµ‹è¯•éªŒè¯                                                                 â”‚
â”‚     â”œâ”€â”€ API æµ‹è¯•ï¼šcurl éªŒè¯è¿”å›æ•°æ®                                          â”‚
â”‚     â”œâ”€â”€ å‰ç«¯æµ‹è¯•ï¼šé¡µé¢å±•ç¤ºæ­£å¸¸                                               â”‚
â”‚     â””â”€â”€ è§„åˆ™åŒ¹é…ï¼šæŠ½æ ·éªŒè¯è§„åˆ™åŒ¹é…å‡†ç¡®æ€§                                      â”‚
â”‚                                                                             â”‚
â”‚  8. æäº¤ä»£ç                                                                  â”‚
â”‚     â”œâ”€â”€ æäº¤å¯¼å…¥è„šæœ¬                                                         â”‚
â”‚     â”œâ”€â”€ æäº¤è§„åˆ™å¼•æ“æ‰©å±•ï¼ˆå¦‚æœ‰ï¼‰                                             â”‚
â”‚     â”œâ”€â”€ æäº¤å‰åç«¯é€‚é…ä»£ç                                                    â”‚
â”‚     â””â”€â”€ åŒæ­¥ç”Ÿäº§æ•°æ®åº“                                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§„åˆ™æ•°æ®åº“ç»“æ„

**è¡¨ï¼š`bazi_rules`**
```sql
CREATE TABLE bazi_rules (
    id INT AUTO_INCREMENT PRIMARY KEY,
    rule_code VARCHAR(100) NOT NULL UNIQUE,    -- è§„åˆ™ç¼–ç ï¼šFORMULA_ç±»å‹_ç¼–å·
    rule_name VARCHAR(200),                     -- è§„åˆ™åç§°
    rule_type VARCHAR(50) NOT NULL,             -- è§„åˆ™ç±»å‹ï¼ˆè‹±æ–‡ï¼‰
    conditions JSON,                            -- åŒ¹é…æ¡ä»¶ï¼ˆJSONæ ¼å¼ï¼‰
    content JSON,                               -- è§„åˆ™å†…å®¹/ç»“æœ
    description JSON,                           -- åŸå§‹æè¿°ä¿¡æ¯
    priority INT DEFAULT 100,                   -- ä¼˜å…ˆçº§
    enabled TINYINT DEFAULT 1,                  -- æ˜¯å¦å¯ç”¨
    version INT DEFAULT 1,                      -- ç‰ˆæœ¬å·
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### è§„åˆ™ç¼–ç è§„èŒƒ

| æ ¼å¼ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|
| `FORMULA_ç±»å‹_ç¼–å·` | `FORMULA_äº‹ä¸š_80001` | æ–°ç‰ˆæ ¼å¼ï¼ˆæ¨èï¼‰ |
| `FORMULA_ç¼–å·` | `FORMULA_10901` | æ—§ç‰ˆæ ¼å¼ï¼ˆå…¼å®¹ï¼‰ |

**ç±»å‹æ˜ å°„ï¼ˆä¸­è‹±æ–‡ï¼‰ï¼š**
| ä¸­æ–‡ | è‹±æ–‡ | è¯´æ˜ |
|------|------|------|
| è´¢å¯Œ | wealth | è´¢è¿ç›¸å…³ |
| å©šå§» | marriage | å©šé…ç›¸å…³ |
| äº‹ä¸š | career | äº‹ä¸šç›¸å…³ |
| å­å¥³ | children | å­å¥³ç›¸å…³ |
| æ€§æ ¼ | character | æ€§æ ¼ç‰¹å¾ |
| æ€»è¯„ | summary | ç»¼åˆè¯„ä»· |
| èº«ä½“ | health | å¥åº·ç›¸å…³ |
| æ¡ƒèŠ± | peach_blossom | æ¡ƒèŠ±è¿ |
| åç¥å‘½æ ¼ | shishen | åç¥åˆ†æ |

### è§„åˆ™æ¡ä»¶ç±»å‹æ¸…å•

#### åŸºç¡€æ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `gender` | `"male"` / `"female"` / `"*"` | æ€§åˆ«æ¡ä»¶ |
| `wangshuai` | `["èº«æ—º"]` / `["èº«å¼±"]` | æ—ºè¡°æ¡ä»¶ |

#### å››æŸ±æ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `pillar_in` | `{"pillar": "day", "part": "stem", "values": ["ç”²", "ä¹™"]}` | æŸ±ä½åŒ¹é… |
| `pillar_equals` | `{"pillar": "day", "values": ["åºšè¾°"]}` | å®Œæ•´æŸ±åŒ¹é… |
| `pillar_relation` | `{"pillar_a": "day", "pillar_b": "hour", "relation": "chong"}` | æŸ±é—´å…³ç³» |

#### åç¥æ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `ten_gods_main` | `{"names": ["æ­£å®˜", "ä¸ƒæ€"], "min": 2}` | ä¸»æ˜Ÿæ•°é‡ |
| `ten_gods_sub` | `{"names": ["é£Ÿç¥"], "pillars": ["day"], "min": 1}` | å‰¯æ˜Ÿæ•°é‡ |
| `ten_gods_total` | `{"names": ["æ¯”è‚©", "åŠ«è´¢"], "min": 3}` | æ€»åç¥æ•°é‡ |
| `main_star_in_day` | `"ä¸ƒæ€"` | æ—¥æŸ±ä¸»æ˜Ÿ |
| `main_star_in_any_pillar` | `"é£Ÿç¥"` | ä»»æ„æŸ±ä¸»æ˜Ÿ |
| `ten_gods_main_chong_count` | `{"min": 2}` | ä¸»æ˜Ÿè¢«å†²æ¬¡æ•° |

#### äº”è¡Œæ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `element_total` | `{"element": "æœ¨", "min": 3}` | äº”è¡Œæ•°é‡ |
| `elements_count` | `{"æœ¨": {"min": 2}, "ç«": {"max": 1}}` | å¤šäº”è¡Œæ•°é‡ |

#### ç¥ç…æ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `deities_in_any_pillar` | `"å¤©ä¹™è´µäºº"` | ä»»æ„æŸ±æœ‰ç¥ç… |
| `deities_in_year` | `"åç›–"` | å¹´æŸ±æœ‰ç¥ç… |
| `deities_in_month` | `"ç©ºäº¡"` | æœˆæŸ±æœ‰ç¥ç… |
| `deities_in_day` | `"æ¡ƒèŠ±"` | æ—¥æŸ±æœ‰ç¥ç… |
| `deities_in_hour` | `"é©¿é©¬"` | æ—¶æŸ±æœ‰ç¥ç… |
| `deities_same_pillar` | `["åç›–", "ç©ºäº¡"]` | åŒæŸ±å¤šç¥ç… |

#### åäºŒé•¿ç”Ÿæ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `star_fortune_in_day` | `"å¸æ—º"` / `["æ­»", "ç»"]` | æ—¥æ”¯åäºŒé•¿ç”Ÿ |
| `star_fortune_in_hour` | `"å¢“"` | æ—¶æ”¯åäºŒé•¿ç”Ÿ |
| `liunian_star_fortune` | `"ç»"` | æµå¹´åäºŒé•¿ç”Ÿ |

#### å…³ç³»æ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `branch_sanxing` | `true` | åœ°æ”¯ä¸‰åˆ‘ |
| `stem_wuhe_pairs` | `{"min": 1}` | å¤©å¹²äº”åˆå¯¹æ•° |
| `pillar_branch_xing_chong` | `true` | æŸ±åœ°æ”¯è¢«åˆ‘å†² |
| `multi_chong` | `{"min": 2}` | å¤šé‡å†² |

#### ç‰¹æ®Šæ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `xishen` | `"æ¯”è‚©"` | å–œç”¨ç¥åŒ¹é… |
| `xishen_in` | `["é£Ÿç¥", "ä¼¤å®˜"]` | å–œç”¨ç¥åœ¨åˆ—è¡¨ä¸­ |
| `taiyuan_shengong_minggong` | `{"taiyuan": "ç™¸ä¸‘"}` | èƒå…ƒèº«å®«å‘½å®« |
| `stems_branches_count` | `{"names": ["å£¬", "ç™¸", "å­"], "min": 3}` | å¤©å¹²åœ°æ”¯æ··åˆè®¡æ•° |
| `not` | `{...æ¡ä»¶...}` | å¦å®šæ¡ä»¶ |

#### ç»„åˆæ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `all` | `[æ¡ä»¶1, æ¡ä»¶2, ...]` | æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³ï¼ˆANDï¼‰ |
| `any` | `[æ¡ä»¶1, æ¡ä»¶2, ...]` | ä»»ä¸€æ¡ä»¶æ»¡è¶³ï¼ˆORï¼‰ |

### è§„åˆ™å¯¼å…¥è„šæœ¬æ¨¡æ¿

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è§„åˆ™å¯¼å…¥è„šæœ¬ï¼šimport_xxx_rules.py

ä½¿ç”¨æ–¹æ³•ï¼š
  python scripts/migration/import_xxx_rules.py --dry-run  # é¢„è§ˆ
  python scripts/migration/import_xxx_rules.py            # æ­£å¼å¯¼å…¥
"""

import sys
import os
import json
import argparse
from typing import Dict, Any, Tuple, Optional, List

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from server.config.mysql_config import get_mysql_connection, return_mysql_connection


class RuleConverter:
    """è§„åˆ™è½¬æ¢å™¨"""
    
    # ç±»å‹æ˜ å°„
    TYPE_MAPPING = {
        'è´¢å¯Œ': 'wealth',
        'å©šå§»': 'marriage',
        'äº‹ä¸š': 'career',
        'å­å¥³': 'children',
        'æ€§æ ¼': 'character',
        'æ€»è¯„': 'summary',
        'èº«ä½“': 'health',
        'æ¡ƒèŠ±': 'peach_blossom',
    }
    
    def convert(self, raw_rule: Dict) -> Tuple[Optional[Dict], Optional[str]]:
        """
        è½¬æ¢åŸå§‹è§„åˆ™ä¸ºæ•°æ®åº“æ ¼å¼
        
        Returns:
            (rule_dict, ambiguity_reason) - å¦‚æœæœ‰æ­§ä¹‰è¿”å›åŸå› 
        """
        # 1. æå–å­—æ®µ
        rule_id = raw_rule.get('ID')
        rule_type_cn = raw_rule.get('ç±»å‹', '')
        condition1 = raw_rule.get('ç­›é€‰æ¡ä»¶1', '')
        condition2 = raw_rule.get('ç­›é€‰æ¡ä»¶2', '')
        result = raw_rule.get('ç»“æœ', '')
        gender = raw_rule.get('æ€§åˆ«', '')
        
        # 2. è½¬æ¢ç±»å‹
        rule_type = self.TYPE_MAPPING.get(rule_type_cn, rule_type_cn.lower())
        
        # 3. è§£ææ¡ä»¶
        conditions, ambiguity = self._parse_conditions(condition1, condition2, gender)
        if ambiguity:
            return None, f"ID {rule_id}: {ambiguity}"
        
        # 4. æ„å»ºè§„åˆ™
        rule = {
            'rule_code': f'FORMULA_{rule_type_cn}_{rule_id}',
            'rule_name': f'{rule_type_cn}è§„åˆ™-{rule_id}',
            'rule_type': rule_type,
            'conditions': conditions,
            'content': {'text': result},
            'description': {
                'ç­›é€‰æ¡ä»¶1': condition1,
                'ç­›é€‰æ¡ä»¶2': condition2,
                'æ€§åˆ«': gender
            }
        }
        
        return rule, None
    
    def _parse_conditions(self, cond1: str, cond2: str, gender: str) -> Tuple[Dict, Optional[str]]:
        """è§£ææ¡ä»¶æ–‡æœ¬ä¸ºJSONæ ¼å¼"""
        conditions = {}
        
        # è§£ææ€§åˆ«
        if gender == 'ç”·':
            conditions['gender'] = 'male'
        elif gender == 'å¥³':
            conditions['gender'] = 'female'
        
        # è§£æå…·ä½“æ¡ä»¶ï¼ˆæ ¹æ®å®é™…è§„åˆ™æ ¼å¼å®ç°ï¼‰
        # ...
        
        return conditions, None


def import_rules(rules: List[Dict], dry_run: bool = False) -> Tuple[int, int, List[str]]:
    """
    å¯¼å…¥è§„åˆ™åˆ°æ•°æ®åº“
    
    Returns:
        (inserted, updated, ambiguous_rules)
    """
    inserted = 0
    updated = 0
    ambiguous = []
    
    if dry_run:
        print("=== DRY RUN æ¨¡å¼ï¼Œä¸ä¼šä¿®æ”¹æ•°æ®åº“ ===\n")
    
    conn = get_mysql_connection()
    try:
        with conn.cursor() as cursor:
            for rule in rules:
                if dry_run:
                    print(f"å°†å¯¼å…¥: {rule['rule_code']}")
                    continue
                
                # æ£€æŸ¥æ˜¯å¦å­˜åœ¨
                cursor.execute(
                    "SELECT id FROM bazi_rules WHERE rule_code = %s",
                    (rule['rule_code'],)
                )
                existing = cursor.fetchone()
                
                if existing:
                    # æ›´æ–°
                    cursor.execute("""
                        UPDATE bazi_rules SET
                            rule_name = %s,
                            rule_type = %s,
                            conditions = %s,
                            content = %s,
                            description = %s,
                            version = version + 1
                        WHERE rule_code = %s
                    """, (
                        rule['rule_name'],
                        rule['rule_type'],
                        json.dumps(rule['conditions'], ensure_ascii=False),
                        json.dumps(rule['content'], ensure_ascii=False),
                        json.dumps(rule['description'], ensure_ascii=False),
                        rule['rule_code']
                    ))
                    updated += 1
                else:
                    # æ’å…¥
                    cursor.execute("""
                        INSERT INTO bazi_rules 
                        (rule_code, rule_name, rule_type, conditions, content, description)
                        VALUES (%s, %s, %s, %s, %s, %s)
                    """, (
                        rule['rule_code'],
                        rule['rule_name'],
                        rule['rule_type'],
                        json.dumps(rule['conditions'], ensure_ascii=False),
                        json.dumps(rule['content'], ensure_ascii=False),
                        json.dumps(rule['description'], ensure_ascii=False)
                    ))
                    inserted += 1
            
            if not dry_run:
                conn.commit()
    finally:
        return_mysql_connection(conn)
    
    return inserted, updated, ambiguous


def main():
    parser = argparse.ArgumentParser(description='è§„åˆ™å¯¼å…¥è„šæœ¬')
    parser.add_argument('--dry-run', action='store_true', help='é¢„è§ˆæ¨¡å¼ï¼Œä¸ä¿®æ”¹æ•°æ®åº“')
    args = parser.parse_args()
    
    # åŠ è½½è§„åˆ™æ•°æ®
    # ...
    
    # å¯¼å…¥è§„åˆ™
    inserted, updated, ambiguous = import_rules(rules, args.dry_run)
    
    print(f"\n=== å¯¼å…¥ç»“æœ ===")
    print(f"æ–°å¢: {inserted} æ¡")
    print(f"æ›´æ–°: {updated} æ¡")
    print(f"æ­§ä¹‰: {len(ambiguous)} æ¡")


if __name__ == '__main__':
    main()
```

---

## ğŸ”„ é—®é¢˜å¤ç›˜æœºåˆ¶ ã€é‡è¦ã€‘

### å¤ç›˜æµç¨‹

æ¯æ¬¡é‡åˆ°é—®é¢˜åï¼Œå¿…é¡»å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š

1. **é—®é¢˜è®°å½•**
   - è®°å½•é—®é¢˜ç°è±¡ã€é”™è¯¯ä¿¡æ¯ã€å¤ç°æ­¥éª¤
   - è®°å½•é—®é¢˜å‘ç”Ÿæ—¶é—´ã€å½±å“èŒƒå›´

2. **æ ¹å› åˆ†æ**
   - åˆ†æé—®é¢˜æ ¹æœ¬åŸå› ï¼ˆä¸æ˜¯è¡¨é¢ç°è±¡ï¼‰
   - æ£€æŸ¥æ˜¯å¦è¿åå¼€å‘è§„èŒƒ
   - æ£€æŸ¥æ˜¯å¦æœ‰ç±»ä¼¼é—®é¢˜å†å²

3. **è§£å†³æ–¹æ¡ˆ**
   - å®æ–½ä¿®å¤æ–¹æ¡ˆ
   - éªŒè¯ä¿®å¤æ•ˆæœ
   - ç¡®ä¿ä¸ä¼šå†æ¬¡å‡ºç°

4. **è§„èŒƒæ›´æ–°**
   - å°†é—®é¢˜å¤ç›˜è®°å½•åˆ°å¼€å‘è§„èŒƒ
   - æ›´æ–°ç›¸å…³æ£€æŸ¥æ¸…å•
   - æ·»åŠ é¢„é˜²æªæ–½

5. **ä»£ç å®¡æŸ¥**
   - æ£€æŸ¥æ˜¯å¦æœ‰ç±»ä¼¼ä»£ç éœ€è¦ä¿®å¤
   - ç¡®ä¿æ‰€æœ‰ç›¸å…³ä»£ç éƒ½ç¬¦åˆè§„èŒƒ

### å¤ç›˜è®°å½•æ ¼å¼

```markdown
## é—®é¢˜å¤ç›˜ï¼š[é—®é¢˜æ ‡é¢˜] - YYYY-MM-DD

### é—®é¢˜æè¿°
- **ç°è±¡**ï¼šå…·ä½“é—®é¢˜è¡¨ç°
- **å½±å“**ï¼šå½±å“èŒƒå›´å’Œä¸¥é‡ç¨‹åº¦
- **å¤ç°**ï¼šå¤ç°æ­¥éª¤

### æ ¹å› åˆ†æ
- **ç›´æ¥åŸå› **ï¼šè¡¨é¢åŸå› 
- **æ ¹æœ¬åŸå› **ï¼šæ·±å±‚åŸå› 
- **è§„èŒƒè¿å**ï¼šè¿åäº†å“ªäº›å¼€å‘è§„èŒƒ

### è§£å†³æ–¹æ¡ˆ
- **ä¿®å¤å†…å®¹**ï¼šå…·ä½“ä¿®æ”¹
- **éªŒè¯ç»“æœ**ï¼šæµ‹è¯•éªŒè¯æƒ…å†µ

### é¢„é˜²æªæ–½
- **è§„èŒƒæ›´æ–°**ï¼šæ›´æ–°çš„è§„èŒƒå†…å®¹
- **æ£€æŸ¥æ¸…å•**ï¼šæ–°å¢çš„æ£€æŸ¥é¡¹
- **ä»£ç å®¡æŸ¥**ï¼šéœ€è¦æ£€æŸ¥çš„ä»£ç èŒƒå›´
```

---

## ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜å¤ç›˜ï¼šåç¥å‘½æ ¼è§„åˆ™åŒ¹é…å¤±è´¥ - 2025-11-28

#### é—®é¢˜æè¿°
- **ç°è±¡**ï¼šç”Ÿæ—¥ 1987-01-07 09:00 æ— æ³•åŒ¹é…åç¥å‘½æ ¼è§„åˆ™
- **å½±å“**ï¼šæ‰€æœ‰åç¥å‘½æ ¼è§„åˆ™éƒ½æ— æ³•åŒ¹é…ï¼Œå½±å“è§„åˆ™åˆ†æåŠŸèƒ½
- **å¤ç°**ï¼šè°ƒç”¨ `/bazi/formula-analysis` APIï¼Œ`shishen_count` å§‹ç»ˆä¸º 0

#### æ ¹å› åˆ†æ
1. **ç›´æ¥åŸå› **ï¼š
   - `formula_analysis.py` ä¸­åç¥å‘½æ ¼ä½¿ç”¨ `FormulaRuleService` åŒ¹é…
   - `FormulaRuleService` æœŸæœ›æ—§æ ¼å¼ï¼ˆæ–‡æœ¬æ¡ä»¶ï¼‰ï¼Œä½†æ•°æ®åº“è§„åˆ™å·²è¿ç§»ä¸º JSON æ ¼å¼
   - è§„åˆ™æ¡ä»¶æ ¼å¼é—®é¢˜ï¼š`hidden_stars_in_year` åŒ…å«æ–‡æœ¬æè¿°ï¼ˆå¦‚"æ—¥æŸ±å‰¯æ˜Ÿæœ‰æ­£è´¢"ï¼‰

2. **æ ¹æœ¬åŸå› **ï¼š
   - è§„åˆ™è¿ç§»åæœªç»Ÿä¸€åŒ¹é…æœåŠ¡
   - è§„åˆ™å¼•æ“æœªæ”¯æŒæ··åˆæ¡ä»¶æ ¼å¼ï¼ˆæ–‡æœ¬æè¿°+åç¥åç§°ï¼‰
   - ç¼ºå°‘è§„åˆ™åŒ¹é…çš„ç»Ÿä¸€æµ‹è¯•

3. **è§„èŒƒè¿å**ï¼š
   - âŒ æœªä½¿ç”¨ç»Ÿä¸€çš„ `RuleService` åŒ¹é…è§„åˆ™
   - âŒ è§„åˆ™æ¡ä»¶æ ¼å¼ä¸ç»Ÿä¸€
   - âŒ ç¼ºå°‘è§„åˆ™åŒ¹é…çš„éªŒè¯æµ‹è¯•

#### è§£å†³æ–¹æ¡ˆ
1. **ä¿®æ”¹ `formula_analysis.py`**ï¼š
   - ç§»é™¤ `FormulaRuleService` ç‰¹æ®Šå¤„ç†
   - ç»Ÿä¸€ä½¿ç”¨ `RuleService` åŒ¹é…æ‰€æœ‰è§„åˆ™ï¼ˆåŒ…æ‹¬åç¥å‘½æ ¼ï¼‰

2. **å¢å¼º `rule_condition.py`**ï¼š
   - å¢å¼º `hidden_stars_in_*` æ¡ä»¶å¤„ç†
   - æ”¯æŒè§£ææ–‡æœ¬æè¿°ï¼ˆå¦‚"æ—¥æŸ±å‰¯æ˜Ÿæœ‰æ­£è´¢"ï¼‰å¹¶æ£€æŸ¥å¯¹åº”æŸ±

#### é¢„é˜²æªæ–½
1. **è§„èŒƒæ›´æ–°**ï¼š
   - âœ… æ‰€æœ‰è§„åˆ™å¿…é¡»ä½¿ç”¨ `RuleService` åŒ¹é…
   - âœ… è§„åˆ™æ¡ä»¶æ ¼å¼å¿…é¡»ç»Ÿä¸€ä¸º JSON
   - âœ… æ–°å¢è§„åˆ™ç±»å‹å¿…é¡»åŒæ­¥æ›´æ–°å‰åç«¯

2. **æ£€æŸ¥æ¸…å•**ï¼š
   - [ ] æ–°è§„åˆ™ç±»å‹æ˜¯å¦ä½¿ç”¨ `RuleService` åŒ¹é…
   - [ ] è§„åˆ™æ¡ä»¶æ ¼å¼æ˜¯å¦ç¬¦åˆ JSON è§„èŒƒ
   - [ ] å‰åç«¯æ˜¯å¦åŒæ­¥æ”¯æŒæ–°è§„åˆ™ç±»å‹
   - [ ] æ˜¯å¦ç¼–å†™äº†è§„åˆ™åŒ¹é…æµ‹è¯•

3. **ä»£ç å®¡æŸ¥**ï¼š
   - æ£€æŸ¥æ‰€æœ‰ä½¿ç”¨ `FormulaRuleService` çš„ä»£ç 
   - æ£€æŸ¥è§„åˆ™æ¡ä»¶æ ¼å¼æ˜¯å¦ç»Ÿä¸€
   - æ£€æŸ¥è§„åˆ™åŒ¹é…é€»è¾‘æ˜¯å¦å®Œæ•´

---

### é—®é¢˜1ï¼šæ•°æ®åº“åé…ç½®é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
Unknown database 'bazi_system'
```

**åŸå› **ï¼š`server/config/mysql_config.py` ä¸­é»˜è®¤æ•°æ®åº“åä¸æ­£ç¡®

**è§£å†³**ï¼š
```python
# ä¿®æ”¹ mysql_config.py
'database': os.getenv('MYSQL_DATABASE', 'hifate_bazi'),  # ä¸æ˜¯ bazi_system
```

**é¢„é˜²**ï¼š
- æ£€æŸ¥ `env.template` ä¸­çš„ `MYSQL_DATABASE` å€¼
- ç¡®ä¿é»˜è®¤å€¼ä¸å®é™…æ•°æ®åº“ä¸€è‡´

---

### é—®é¢˜2ï¼šè§„åˆ™IDåŒ…å«ä¸­æ–‡å¯¼è‡´è§£æå¤±è´¥

**ç—‡çŠ¶**ï¼š
```
invalid literal for int() with base 10: 'è´¢å¯Œ_20106'
```

**åŸå› **ï¼šè§„åˆ™IDæ ¼å¼ä¸ç»Ÿä¸€ï¼ˆ`FORMULA_80001` vs `FORMULA_è´¢å¯Œ_20106`ï¼‰

**è§£å†³**ï¼š
```python
# å…¼å®¹ä¸¤ç§æ ¼å¼
try:
    numeric_id = int(original_id)
except ValueError:
    parts = original_id.rsplit('_', 1)
    if len(parts) == 2 and parts[1].isdigit():
        numeric_id = int(parts[1])
    else:
        numeric_id = hash(original_id) % 1000000
```

**é¢„é˜²**ï¼š
- å¯¼å…¥æ—¶ç»Ÿä¸€ä½¿ç”¨ `FORMULA_ç±»å‹_ç¼–å·` æ ¼å¼
- åœ¨æ•°æ®åº“ä¸­ä¿æŒ `rule_type` å­—æ®µä¸ºè‹±æ–‡

---

### é—®é¢˜3ï¼šè§„åˆ™ç±»å‹ä¸ä¸€è‡´

**ç—‡çŠ¶**ï¼šå‰ç«¯æ˜¾ç¤ºä¸å‡ºæ–°å¢çš„è§„åˆ™ç±»å‹ï¼ˆå¦‚äº‹ä¸šã€å­å¥³ï¼‰

**åŸå› **ï¼šæ•°æ®åº“ `rule_type` å­—æ®µå€¼ä¸ç»Ÿä¸€ï¼ˆ`formula_career` vs `career`ï¼‰

**è§£å†³**ï¼š
```sql
-- ç»Ÿä¸€è§„åˆ™ç±»å‹åç§°
UPDATE bazi_rules SET rule_type = 'career' WHERE rule_type = 'formula_career';
UPDATE bazi_rules SET rule_type = 'children' WHERE rule_type = 'formula_children';
```

**é¢„é˜²**ï¼š
- å¯¼å…¥è„šæœ¬ä¸­ä½¿ç”¨ç»Ÿä¸€çš„è‹±æ–‡ç±»å‹å
- ä¸è¦ä½¿ç”¨ `formula_` å‰ç¼€

---

### é—®é¢˜4ï¼šå‰ç«¯ç±»å‹æ ‡ç­¾ç¼ºå¤±

**ç—‡çŠ¶**ï¼šå‰ç«¯é¡µé¢æ²¡æœ‰æ˜¾ç¤ºæ–°ç±»å‹çš„æ ‡ç­¾é¡µ

**åŸå› **ï¼š`frontend/formula-analysis.html` ä¸­ `typeLabels` æœªå®šä¹‰æ–°ç±»å‹

**è§£å†³**ï¼š
```javascript
const typeLabels = {
    'wealth': { name: 'ğŸ’° è´¢å¯Œ', color: '#f39c12' },
    'marriage': { name: 'ğŸ’‘ å©šé…', color: '#e74c3c' },
    'career': { name: 'ğŸ’¼ äº‹ä¸š', color: '#1abc9c' },      // æ–°å¢
    'children': { name: 'ğŸ‘¶ å­å¥³', color: '#e67e22' },    // æ–°å¢
    // ...
};
```

**é¢„é˜²**ï¼š
- æ–°å¢è§„åˆ™ç±»å‹æ—¶åŒæ­¥æ›´æ–°å‰ç«¯ `typeLabels`
- åŒæ­¥æ›´æ–° `displayStatistics` å‡½æ•°

---

### é—®é¢˜5ï¼šæ–°æ¡ä»¶ç±»å‹ä¸æ”¯æŒ

**ç—‡çŠ¶**ï¼šè§„åˆ™æ— æ³•åŒ¹é…ï¼Œæ—¥å¿—æ˜¾ç¤ºæ¡ä»¶æœªå¤„ç†

**åŸå› **ï¼š`rule_condition.py` ä¸­æœªå®ç°å¯¹åº”æ¡ä»¶ç±»å‹

**è§£å†³**ï¼šåœ¨ `EnhancedRuleCondition.match` ä¸­æ·»åŠ æ¡ä»¶å¤„ç†é€»è¾‘

**é¢„é˜²**ï¼š
- å¯¼å…¥å‰æ£€æŸ¥æ‰€æœ‰æ¡ä»¶ç±»å‹æ˜¯å¦å·²æ”¯æŒ
- ä¸æ”¯æŒçš„æ¡ä»¶å…ˆæ‰©å±•è§„åˆ™å¼•æ“å†å¯¼å…¥

---

### é—®é¢˜6ï¼šgRPC ç«¯ç‚¹æœªæ³¨å†Œ

**ç—‡çŠ¶**ï¼šå‰ç«¯è°ƒç”¨ API è¿”å›é”™è¯¯æˆ–æ— å“åº”

**åŸå› **ï¼š`grpc_gateway.py` ä¸­æœªæ³¨å†Œå¯¹åº”ç«¯ç‚¹

**è§£å†³**ï¼š
```python
# åœ¨ grpc_gateway.py ä¸­æ³¨å†Œ
@_register("/bazi/new-feature")
async def _handle_new_feature(payload: Dict[str, Any]):
    request_model = NewFeatureRequest(**payload)
    return await new_feature(request_model)
```

**é¢„é˜²**ï¼š
- æ–°å¢ API æ—¶å¿…é¡»åŒæ—¶æ³¨å†Œ gRPC ç«¯ç‚¹
- æµ‹è¯•æ—¶éªŒè¯ gRPC-Web è°ƒç”¨æ˜¯å¦æ­£å¸¸

---

## ğŸ“ é¡¹ç›®æ¶æ„

### å‰ç«¯æ¶æ„ `frontend/`
```
frontend/
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ api.js                  # gRPC-Web å®¢æˆ·ç«¯ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”œâ”€â”€ config.js               # API é…ç½®
â”‚   â”œâ”€â”€ fortune.js              # è¿åŠ¿æ•°æ®é€»è¾‘
â”‚   â”œâ”€â”€ fortune-timeline.js     # è¿åŠ¿ UI æ¸²æŸ“
â”‚   â””â”€â”€ ...
â”œâ”€â”€ css/                        # æ ·å¼æ–‡ä»¶
â””â”€â”€ *.html                      # é¡µé¢æ–‡ä»¶
```

### åç«¯æ¶æ„ `server/`
```
server/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ grpc_gateway.py         # gRPC-Web ç½‘å…³ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â””â”€â”€ v1/                     # REST API
â”‚       â”œâ”€â”€ formula_analysis.py # ç®—æ³•å…¬å¼åˆ†æ
â”‚       â””â”€â”€ ...
â”œâ”€â”€ services/                   # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ rule_service.py         # è§„åˆ™åŒ¹é…æœåŠ¡
â”‚   â””â”€â”€ ...
â”œâ”€â”€ engines/                    # è§„åˆ™å¼•æ“
â”‚   â”œâ”€â”€ rule_engine.py          # æ ¸å¿ƒå¼•æ“
â”‚   â””â”€â”€ rule_condition.py       # æ¡ä»¶åŒ¹é…ï¼ˆæ‰©å±•ç‚¹ï¼‰
â”œâ”€â”€ config/
â”‚   â””â”€â”€ mysql_config.py         # MySQL é…ç½®ï¼ˆæ³¨æ„é»˜è®¤å€¼ï¼‰
â””â”€â”€ db/                         # æ•°æ®åº“è¿æ¥
```

### å¾®æœåŠ¡æ¶æ„ `services/`
```
services/
â”œâ”€â”€ bazi_core/                  # å…«å­—æ ¸å¿ƒæœåŠ¡ (9001)
â”œâ”€â”€ bazi_fortune/               # è¿åŠ¿æœåŠ¡ (9002)
â”œâ”€â”€ bazi_analyzer/              # åˆ†ææœåŠ¡ (9003)
â”œâ”€â”€ bazi_rule/                  # è§„åˆ™æœåŠ¡ (9004)
â”œâ”€â”€ fortune_analysis/           # è¿åŠ¿åˆ†æ (9005)
â”œâ”€â”€ payment_service/            # æ”¯ä»˜æœåŠ¡ (9006)
â”œâ”€â”€ fortune_rule/               # è¿åŠ¿è§„åˆ™ (9007)
â”œâ”€â”€ intent_service/             # æ„å›¾è¯†åˆ« (9008)
â”œâ”€â”€ prompt_optimizer/           # æç¤ºä¼˜åŒ– (9009)
â””â”€â”€ desk_fengshui/              # é£æ°´åˆ†æ (9010)
```

### è„šæœ¬ç›®å½• `scripts/`
```
scripts/
â”œâ”€â”€ migration/                  # æ•°æ®è¿ç§»è„šæœ¬
â”‚   â”œâ”€â”€ import_2025_1128_rules.py   # è§„åˆ™å¯¼å…¥ç¤ºä¾‹
â”‚   â””â”€â”€ import_confirmed_rules.py   # ç¡®è®¤è§„åˆ™å¯¼å…¥
â”œâ”€â”€ db/                         # æ•°æ®åº“è„šæœ¬
â”‚   â””â”€â”€ sync_db.sh              # æ•°æ®åº“åŒæ­¥
â””â”€â”€ ...
```

---

## ğŸ”’ æ ¸å¿ƒæ–‡ä»¶ï¼ˆä¿®æ”¹å‰å¿…é¡»å’¨è¯¢ï¼‰

| æ–‡ä»¶ | ä½œç”¨ | é£é™© |
|------|------|------|
| `server/api/grpc_gateway.py` | gRPC-Web ç½‘å…³ | æé«˜ |
| `server/engines/rule_condition.py` | è§„åˆ™æ¡ä»¶åŒ¹é… | é«˜ |
| `server/config/mysql_config.py` | MySQL é…ç½® | é«˜ |
| `src/bazi_calculator.py` | æ ¸å¿ƒå…«å­—è®¡ç®— | æé«˜ |
| `frontend/js/api.js` | å‰ç«¯ gRPC å®¢æˆ·ç«¯ | é«˜ |
| `proto/*.proto` | gRPC åè®®å®šä¹‰ | é«˜ |

---

## ğŸ“ ä»£ç è§„èŒƒ

### æ•°æ®åº“é…ç½®é»˜è®¤å€¼
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨å®é™…çš„æ•°æ®åº“å
'database': os.getenv('MYSQL_DATABASE', 'hifate_bazi'),

# âŒ é”™è¯¯ï¼šä½¿ç”¨è¿‡æ—¶çš„æ•°æ®åº“å
'database': os.getenv('MYSQL_DATABASE', 'bazi_system'),
```

### JSON åºåˆ—åŒ–
```python
# âœ… æ­£ç¡®ï¼šæ”¯æŒä¸­æ–‡
json.dumps(data, ensure_ascii=False)

# âŒ é”™è¯¯ï¼šä¸­æ–‡è¢«è½¬ä¹‰
json.dumps(data)  # è¾“å‡º \u4e2d\u6587
```

### è§„åˆ™ç±»å‹å‘½å
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨è‹±æ–‡å°å†™
rule_type = 'career'
rule_type = 'children'

# âŒ é”™è¯¯ï¼šä½¿ç”¨ä¸­æ–‡æˆ–å¸¦å‰ç¼€
rule_type = 'äº‹ä¸š'
rule_type = 'formula_career'
```

---

## ğŸš€ æœåŠ¡ç®¡ç†

### å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨ä¸»æœåŠ¡
python3 server/start.py

# æˆ–ä½¿ç”¨è„šæœ¬
./start.sh
```

### æµ‹è¯• API
```bash
# æµ‹è¯• gRPC-Web ç½‘å…³
curl -s -X POST 'http://127.0.0.1:8001/api/v1/bazi/formula-analysis' \
  -H 'Content-Type: application/json' \
  -d '{"solar_date": "1990-01-15", "solar_time": "12:00", "gender": "male"}'
```

### æŸ¥çœ‹æ—¥å¿—
```bash
tail -f logs/server_8001.log
```

---

## ğŸ“¦ Git æäº¤è§„èŒƒ

### Commit Message æ ¼å¼
```
[ç±»å‹] ç®€çŸ­æè¿°

- ä¿®æ”¹æ–‡ä»¶ï¼šåˆ—å‡ºæ–‡ä»¶
- åŠŸèƒ½è¯´æ˜ï¼šè¯¦ç»†è¯´æ˜
- æµ‹è¯•æƒ…å†µï¼šæµ‹è¯•ç»“æœ
```

### ç±»å‹æ ‡ç­¾
- `[æ–°å¢]` - æ–°åŠŸèƒ½/æ–°è§„åˆ™
- `[ä¿®å¤]` - Bugä¿®å¤
- `[ä¼˜åŒ–]` - æ€§èƒ½ä¼˜åŒ–
- `[é‡æ„]` - ä»£ç é‡æ„
- `[è§„åˆ™]` - è§„åˆ™ç›¸å…³å˜æ›´
- `[é…ç½®]` - é…ç½®ä¿®æ”¹

---

## ğŸ“– Gitee ä»“åº“

| é¡¹ç›® | å€¼ |
|------|-----|
| **ä»“åº“åœ°å€** | https://gitee.com/zhoudengtang/hifate-prod.git |
| **æœ¬åœ° remote** | gitee |
| **é»˜è®¤åˆ†æ”¯** | master |

### æäº¤æµç¨‹
```bash
git add .
git commit -m "[ç±»å‹] æè¿°"
git push gitee master
```

### éƒ¨ç½²åˆ°ç”Ÿäº§
```bash
./deploy.sh  # é€‰æ‹© 1) å®Œæ•´éƒ¨ç½²
```

---

## ğŸ³ Docker åŸºç¡€é•œåƒä¼˜åŒ–

### ğŸ“‹ åŸç†

ä½¿ç”¨é¢„æ„å»ºçš„åŸºç¡€é•œåƒï¼ˆåŒ…å«æ‰€æœ‰ Python ä¾èµ–ï¼‰ï¼Œå¤§å¹…åŠ é€Ÿéƒ¨ç½²ï¼š

```
ä¼ ç»Ÿæ–¹å¼ï¼šæ¯æ¬¡éƒ¨ç½²éƒ½å®‰è£…ä¾èµ–ï¼ˆ5-10åˆ†é’Ÿï¼‰
ä¼˜åŒ–æ–¹å¼ï¼šåŸºç¡€é•œåƒå·²å«ä¾èµ–ï¼Œåªéœ€å¤åˆ¶ä»£ç ï¼ˆ10-20ç§’ï¼‰
```

### ğŸš€ ä½¿ç”¨æµç¨‹

**1. é¦–æ¬¡æ„å»ºåŸºç¡€é•œåƒ**ï¼ˆä»…éœ€ä¸€æ¬¡ï¼Œçº¦ 5-10 åˆ†é’Ÿï¼‰

```bash
./scripts/docker/build_base.sh
```

**2. æ£€æŸ¥åŸºç¡€é•œåƒçŠ¶æ€**

```bash
./scripts/docker/check_base.sh
```

**3. æ­£å¸¸éƒ¨ç½²**ï¼ˆå¿«é€Ÿï¼Œ10-20ç§’ï¼‰

```bash
docker compose up -d --build web
```

### âš ï¸ ä½•æ—¶éœ€è¦é‡å»ºåŸºç¡€é•œåƒ

| åœºæ™¯ | æ˜¯å¦éœ€è¦é‡å»º | è¯´æ˜ |
|------|------------|------|
| ä¿®æ”¹ä»£ç  | âŒ ä¸éœ€è¦ | ç›´æ¥éƒ¨ç½²å³å¯ |
| ä¿®æ”¹ requirements.txt | âœ… **å¿…é¡»é‡å»º** | ä¾èµ–å˜æ›´ |
| ä¿®æ”¹ Dockerfile.base | âœ… éœ€è¦é‡å»º | åŸºç¡€é•œåƒé…ç½®å˜æ›´ |

### ğŸ”’ å®‰å…¨æœºåˆ¶

1. **è·¨å¹³å°å…¼å®¹**ï¼šä½¿ç”¨ `--platform linux/amd64` ç¡®ä¿ Mac M1/Intel éƒ½èƒ½æ„å»º
2. **ä¿é™©å±‚**ï¼šåº”ç”¨ Dockerfile ä¼šå†æ¬¡æ‰§è¡Œ `pip install`ï¼Œç¡®ä¿ä¾èµ–å®Œæ•´
3. **è‡ªåŠ¨æ£€æŸ¥**ï¼š`check_base.sh` ä¼šæ£€æµ‹ requirements.txt æ˜¯å¦å˜æ›´

### ğŸ“Š æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | ä¼ ç»Ÿæ–¹å¼ | åŸºç¡€é•œåƒ | æå‡ |
|------|---------|---------|------|
| é¦–æ¬¡éƒ¨ç½² | 10-15åˆ†é’Ÿ | 5-10åˆ†é’Ÿï¼ˆæ„å»ºåŸºç¡€é•œåƒï¼‰ | 1æ¬¡æ€§ |
| ä»£ç æ›´æ–° | 1-2åˆ†é’Ÿ | **10-20ç§’** | **6-12å€** |
| ä¾èµ–æ›´æ–° | 10-15åˆ†é’Ÿ | 5-10åˆ†é’Ÿï¼ˆé‡å»ºåŸºç¡€é•œåƒï¼‰ | 1æ¬¡æ€§ |

### ğŸ› ï¸ ç»´æŠ¤å‘½ä»¤

```bash
# æ„å»ºåŸºç¡€é•œåƒ
./scripts/docker/build_base.sh

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
./scripts/docker/check_base.sh

# æŸ¥çœ‹åŸºç¡€é•œåƒä¿¡æ¯
docker images hifate-base

# åˆ é™¤æ—§ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
docker rmi hifate-base:20241128
```

---

## ğŸ’¡ å¼€å‘åŸåˆ™

1. **ğŸ”´ é›¶åœæœºä¼˜å…ˆ**ï¼šæ‰€æœ‰è®¾è®¡å¿…é¡»æ”¯æŒä¸åœæœºæ›´æ–°
2. **ğŸ”Œ gRPC ä¼˜å…ˆ**ï¼šæœåŠ¡é—´äº¤äº’å¿…é¡»ä½¿ç”¨ gRPC
3. **ğŸ“œ è§„åˆ™æ•°æ®åº“åŒ–**ï¼šè§„åˆ™å­˜æ•°æ®åº“ï¼Œæ”¯æŒçƒ­æ›´æ–°ï¼Œ**ç¦æ­¢ä»æ–‡ä»¶è¯»å–**
4. **ğŸ”„ å‘åå…¼å®¹**ï¼šåªåŠ ä¸åˆ ï¼Œä¿æŒå…¼å®¹
5. **âœ… å…ˆæµ‹è¯•åæäº¤**ï¼šä¿®æ”¹åç«‹å³æµ‹è¯•
6. **ğŸ“ è§„èŒƒå‘½å**ï¼šç±»å‹ç”¨è‹±æ–‡ï¼ŒID ç»Ÿä¸€æ ¼å¼
7. **ğŸ”„ é—®é¢˜å¤ç›˜**ï¼šæ¯æ¬¡é—®é¢˜å¿…é¡»å¤ç›˜å¹¶æ›´æ–°è§„èŒƒ

---

**è®°ä½**ï¼š
- æ–°å¢ API å¿…é¡»åŒæ—¶æ³¨å†Œ gRPC ç«¯ç‚¹
- æ–°å¢è§„åˆ™ç±»å‹å¿…é¡»åŒæ­¥æ›´æ–°å‰åç«¯
- æ•°æ®åº“é…ç½®ä½¿ç”¨ `hifate_bazi` è€Œé `bazi_system`
- è§„åˆ™ `rule_type` ä½¿ç”¨è‹±æ–‡å°å†™
- **æ‰€æœ‰è§„åˆ™å¿…é¡»ä»æ•°æ®åº“è¯»å–ï¼Œç¦æ­¢ä»æ–‡ä»¶è¯»å–**
- **æ‰€æœ‰è§„åˆ™åŒ¹é…å¿…é¡»ä½¿ç”¨ `RuleService`ï¼Œç¦æ­¢ä½¿ç”¨ `FormulaRuleService`**
- **æ¯æ¬¡é—®é¢˜å¿…é¡»å¤ç›˜å¹¶æ›´æ–°å¼€å‘è§„èŒƒ**
