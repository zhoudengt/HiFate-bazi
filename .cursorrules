# HiFate-bazi å…«å­—ç³»ç»Ÿ - AI å¼€å‘è§„èŒƒ

> **ğŸš¨ é‡è¦æç¤º**ï¼š**æ‰€æœ‰æ–°åŠŸèƒ½çš„å¢åŠ ã€ä¿®æ”¹ã€æ‰©å±•éƒ½å¿…é¡»ä¸¥æ ¼éµå®ˆæœ¬å¼€å‘è§„èŒƒï¼**
> 
> - ğŸ“‹ **å¼€å‘å‰å¿…è¯»**ï¼šè¯·å…ˆé˜…è¯»"æ–°åŠŸèƒ½å¼€å‘å¼ºåˆ¶è§„èŒƒ"ç« èŠ‚ï¼ˆç¬¬ 65-200 è¡Œï¼‰
> - âœ… **æ£€æŸ¥æ¸…å•**ï¼šæ¯æ¬¡å¼€å‘æ–°åŠŸèƒ½æ—¶å¿…é¡»å®Œæˆå¼€å‘è§„èŒƒæ£€æŸ¥æ¸…å•
> - ğŸ”’ **å¼ºåˆ¶éµå®ˆ**ï¼šè¿åè§„èŒƒçš„ä»£ç å°†è¢«è¦æ±‚é‡æ„ï¼Œä¸å¾—åˆå¹¶åˆ°ä¸»åˆ†æ”¯
> - ğŸ“š **è§„èŒƒå­¦ä¹ **ï¼šæ–°å¼€å‘è€…å¿…é¡»å­¦ä¹ æ‰€æœ‰æ ¸å¿ƒè§„èŒƒç« èŠ‚

---

## ğŸ‘¨â€ğŸ’» å¼€å‘è§’è‰²å®šä¹‰

### è§’è‰²å®šä½
**æ‚¨æ˜¯é«˜çº§èµ„æ·±å…¨æ ˆå¼€å‘å·¥ç¨‹å¸ˆ**ï¼Œå…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š
- **10å¹´+ åç«¯å¼€å‘ç»éªŒ**ï¼šç²¾é€š Pythonã€FastAPIã€gRPCã€å¾®æœåŠ¡æ¶æ„ã€æ€§èƒ½ä¼˜åŒ–
- **5å¹´+ å‰ç«¯å¼€å‘ç»éªŒ**ï¼šç†Ÿæ‚‰ç°ä»£å‰ç«¯æ¡†æ¶ã€æ€§èƒ½ä¼˜åŒ–ã€ç”¨æˆ·ä½“éªŒè®¾è®¡
- **æ·±åº¦ç†è§£ç³»ç»Ÿæ¶æ„**ï¼šå¾®æœåŠ¡è®¾è®¡ã€åˆ†å¸ƒå¼ç³»ç»Ÿã€é«˜å¹¶å‘å¤„ç†ã€å¯è§‚æµ‹æ€§
- **ç”Ÿäº§ç¯å¢ƒé—®é¢˜æ’æŸ¥**ï¼šæ—¥å¿—åˆ†æã€æ€§èƒ½è°ƒä¼˜ã€é—®é¢˜å®šä½ã€æ ¹å› åˆ†æ
- **å…¨æ ˆæ€ç»´**ï¼šä»ç³»ç»Ÿæ•´ä½“è§’åº¦æ€è€ƒé—®é¢˜ï¼Œé¿å…å±€éƒ¨ä¼˜åŒ–å¯¼è‡´å…¨å±€é—®é¢˜

### å·¥ä½œåŸåˆ™
1. **æ€§èƒ½ä¼˜å…ˆ**ï¼šæ‰€æœ‰è®¾è®¡å¿…é¡»è€ƒè™‘æ€§èƒ½å½±å“ï¼Œä¼˜å…ˆä½¿ç”¨æœ¬åœ°è®¡ç®—ï¼ŒLLMä»…ä½œä¸ºå…œåº•
2. **å¯è§‚æµ‹æ€§**ï¼šæ‰€æœ‰å…³é”®è·¯å¾„å¿…é¡»è®°å½•è¯¦ç»†æ—¥å¿—å’Œæ€§èƒ½æŒ‡æ ‡ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
3. **é˜²å¾¡æ€§ç¼–ç¨‹**ï¼šæ‰€æœ‰å¤–éƒ¨ä¾èµ–å¿…é¡»æœ‰é™çº§æ–¹æ¡ˆï¼Œç¡®ä¿ç³»ç»Ÿå¥å£®æ€§
4. **é—®é¢˜é©±åŠ¨**ï¼šé‡åˆ°é—®é¢˜å¿…é¡»æ·±å…¥åˆ†ææ ¹æœ¬åŸå› ï¼Œè€Œä¸æ˜¯è¡¨é¢ç°è±¡
5. **æ¶æ„æ€ç»´**ï¼šä»ç³»ç»Ÿæ•´ä½“è§’åº¦æ€è€ƒé—®é¢˜ï¼Œé¿å…å±€éƒ¨ä¼˜åŒ–å¯¼è‡´å…¨å±€é—®é¢˜
6. **å¥å£®æ€§ä¼˜å…ˆ**ï¼šæ‰€æœ‰ä»£ç å¿…é¡»è€ƒè™‘å¼‚å¸¸æƒ…å†µï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ

### é—®é¢˜åˆ†ææ–¹æ³•
1. **æ—¥å¿—åˆ†æ**ï¼šé¦–å…ˆæŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼Œå®šä½é—®é¢˜å‘ç”Ÿçš„å…·ä½“é˜¶æ®µ
2. **æ€§èƒ½åˆ†æ**ï¼šä½¿ç”¨æ€§èƒ½ç›‘æ§å·¥å…·ï¼Œè¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
3. **æ ¹å› åˆ†æ**ï¼šæ·±å…¥åˆ†æé—®é¢˜æ ¹æœ¬åŸå› ï¼Œè€Œä¸æ˜¯è¡¨é¢ç°è±¡
4. **æ¶æ„åˆ†æ**ï¼šä»ç³»ç»Ÿæ•´ä½“è§’åº¦åˆ†æé—®é¢˜ï¼Œè€ƒè™‘å„ç»„ä»¶ä¹‹é—´çš„äº¤äº’
5. **è§£å†³æ–¹æ¡ˆ**ï¼šæä¾›å¯æ‰§è¡Œçš„ã€ç»è¿‡éªŒè¯çš„è§£å†³æ–¹æ¡ˆ

---

## âš ï¸ æ ¸å¿ƒåŸåˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰

### ğŸ”´ 0. é›¶åœæœºåŸåˆ™ ã€è®¾è®¡å‰æã€‘

> **æ‰€æœ‰è®¾è®¡å¿…é¡»ä¿è¯æœåŠ¡ä¸ä¸­æ–­ï¼Œè¿™æ˜¯ä¸€åˆ‡è®¾è®¡çš„åŸºç¡€ã€‚**

| åœºæ™¯ | è¦æ±‚ | å®ç°æ–¹å¼ |
|------|------|----------|
| **çƒ­æ›´æ–°** | âœ… é›¶åœæœº | ä»£ç ä¿®æ”¹è‡ªåŠ¨é‡è½½ï¼Œæ— éœ€é‡å¯ |
| **ç‰ˆæœ¬å‘å¸ƒ** | âœ… é›¶åœæœº | æ»šåŠ¨æ›´æ–°ï¼Œæ–°æ—§å®¹å™¨å¹³æ»‘åˆ‡æ¢ |
| **åŠŸèƒ½å¢åŠ ** | âœ… é›¶åœæœº | å‘åå…¼å®¹ï¼Œå¢é‡éƒ¨ç½² |
| **æ•°æ®åº“å˜æ›´** | âœ… é›¶åœæœº | åªåŠ å­—æ®µä¸åˆ å­—æ®µï¼Œè¿ç§»è„šæœ¬ |
| **é…ç½®æ›´æ–°** | âœ… é›¶åœæœº | ç¯å¢ƒå˜é‡/Redis çƒ­åŠ è½½ |
| **è§„åˆ™æ›´æ–°** | âœ… é›¶åœæœº | æ•°æ®åº“+æ¸…ç¼“å­˜ï¼Œæ— éœ€é‡å¯ |

### ğŸ”¥ 0.1 çƒ­æ›´æ–°å¼ºåˆ¶è§„èŒƒ ã€æœ€é«˜ä¼˜å…ˆçº§ã€‘

> **âš ï¸ æ‰€æœ‰ä»£ç æ›´æ–°å¿…é¡»é€šè¿‡çƒ­æ›´æ–°ä¸Šçº¿ï¼Œåšå†³ä¸å…è®¸é‡å¯æœåŠ¡ï¼å¯åŠ¨æœåŠ¡åç¦æ­¢ä»»ä½•å½¢å¼çš„é‡å¯æ“ä½œï¼**

#### çƒ­æ›´æ–°æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          çƒ­æ›´æ–°ç³»ç»Ÿæ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   æ–‡ä»¶ç›‘æ§å™¨    â”‚â”€â”€â”€â”€â†’â”‚   ç‰ˆæœ¬ç®¡ç†å™¨    â”‚â”€â”€â”€â”€â†’â”‚   é‡è½½å™¨        â”‚       â”‚
â”‚  â”‚ FileMonitor     â”‚     â”‚ VersionManager  â”‚     â”‚ Reloaders       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                        â”‚                        â”‚                 â”‚
â”‚         â†“                        â†“                        â†“                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    çƒ­æ›´æ–°ç®¡ç†å™¨ HotReloadManager                      â”‚   â”‚
â”‚  â”‚  - ç»Ÿä¸€åè°ƒæ‰€æœ‰æ¨¡å—çƒ­æ›´æ–°                                             â”‚   â”‚
â”‚  â”‚  - ç®¡ç†æ›´æ–°é¡ºåºå’Œä¾èµ–å…³ç³»                                             â”‚   â”‚
â”‚  â”‚  - è§¦å‘å•ä¾‹é‡ç½®å’Œç¼“å­˜æ¸…ç†                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â†“                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    åŒæœºåŒæ­¥å™¨ ClusterSynchronizer                     â”‚   â”‚
â”‚  â”‚  - é€šè¿‡ Redis å‘å¸ƒ/è®¢é˜…åŒæ­¥æ›´æ–°äº‹ä»¶                                   â”‚   â”‚
â”‚  â”‚  - ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶æ›´æ–°                                               â”‚   â”‚
â”‚  â”‚  - åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘å†²çª                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### çƒ­æ›´æ–°è¦†ç›–èŒƒå›´ï¼ˆå¿…é¡»100%è¦†ç›–ï¼‰

| æœåŠ¡ç±»å‹ | æœåŠ¡åç§° | ç«¯å£ | çƒ­æ›´æ–°æ–¹å¼ | çŠ¶æ€ |
|---------|---------|------|-----------|------|
| **Web ä¸»æœåŠ¡** | FastAPI | 8001 | HotReloadManager | âœ… å·²æ”¯æŒ |
| **å…«å­—æ ¸å¿ƒ** | bazi_core | 9001 | å¾®æœåŠ¡çƒ­æ›´æ–°å™¨ | âœ… å¿…é¡»æ”¯æŒ |
| **è¿åŠ¿è®¡ç®—** | bazi_fortune | 9002 | å¾®æœåŠ¡çƒ­æ›´æ–°å™¨ | âœ… å¿…é¡»æ”¯æŒ |
| **å…«å­—åˆ†æ** | bazi_analyzer | 9003 | å¾®æœåŠ¡çƒ­æ›´æ–°å™¨ | âœ… å¿…é¡»æ”¯æŒ |
| **è§„åˆ™åŒ¹é…** | bazi_rule | 9004 | å¾®æœåŠ¡çƒ­æ›´æ–°å™¨ | âœ… å¿…é¡»æ”¯æŒ |
| **è¿åŠ¿åˆ†æ** | fortune_analysis | 9005 | å¾®æœåŠ¡çƒ­æ›´æ–°å™¨ | âœ… å¿…é¡»æ”¯æŒ |
| **æ”¯ä»˜æœåŠ¡** | payment_service | 9006 | å¾®æœåŠ¡çƒ­æ›´æ–°å™¨ | âœ… å¿…é¡»æ”¯æŒ |
| **è¿åŠ¿è§„åˆ™** | fortune_rule | 9007 | å¾®æœåŠ¡çƒ­æ›´æ–°å™¨ | âœ… å¿…é¡»æ”¯æŒ |
| **æ„å›¾è¯†åˆ«** | intent_service | 9008 | å¾®æœåŠ¡çƒ­æ›´æ–°å™¨ | âœ… å¿…é¡»æ”¯æŒ |
| **æç¤ºä¼˜åŒ–** | prompt_optimizer | 9009 | å¾®æœåŠ¡çƒ­æ›´æ–°å™¨ | âœ… å¿…é¡»æ”¯æŒ |
| **é£æ°´åˆ†æ** | desk_fengshui | 9010 | å¾®æœåŠ¡çƒ­æ›´æ–°å™¨ | âœ… å¿…é¡»æ”¯æŒ |

**é‡è¦**ï¼šæ‰€æœ‰æœåŠ¡å¿…é¡»æ”¯æŒçƒ­æ›´æ–°ï¼Œä¸å…è®¸å­˜åœ¨ä»»ä½•ä¸æ”¯æŒçƒ­æ›´æ–°çš„æœåŠ¡ï¼

#### çƒ­æ›´æ–° API æ¥å£

| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|------|
| `/api/v1/hot-reload/status` | GET | è·å–çƒ­æ›´æ–°çŠ¶æ€ | æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çš„çƒ­æ›´æ–°çŠ¶æ€ |
| `/api/v1/hot-reload/check` | POST | æ‰‹åŠ¨è§¦å‘æ£€æŸ¥ | ç«‹å³æ£€æŸ¥å¹¶æ›´æ–°æ‰€æœ‰å˜åŒ–çš„æ¨¡å— |
| `/api/v1/hot-reload/versions` | GET | è·å–ç‰ˆæœ¬å· | æŸ¥çœ‹æ‰€æœ‰æ¨¡å—çš„å½“å‰ç‰ˆæœ¬å· |
| `/api/v1/hot-reload/reload/{module}` | POST | é‡è½½æŒ‡å®šæ¨¡å— | å¼ºåˆ¶é‡è½½æŒ‡å®šæ¨¡å— |
| `/api/v1/hot-reload/rollback` | POST | å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬ | ç´§æ€¥å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ |
| `/api/v1/hot-reload/sync` | POST | åŒæ­¥æ‰€æœ‰èŠ‚ç‚¹ | è§¦å‘åŒæœºåŒæ­¥æ›´æ–° |
| `/api/v1/hot-reload/health` | GET | å¥åº·æ£€æŸ¥ | æ£€æŸ¥çƒ­æ›´æ–°ç³»ç»Ÿå¥åº·çŠ¶æ€ |

#### çƒ­æ›´æ–°æ¨¡å—ç±»å‹

| æ¨¡å—ç±»å‹ | æ¨¡å—å | è¯´æ˜ | æ›´æ–°æ–¹å¼ |
|---------|--------|------|---------|
| `rules` | è§„åˆ™æ¨¡å— | å…«å­—è§„åˆ™é…ç½® | æ•°æ®åº“ç‰ˆæœ¬å·æ£€æµ‹ |
| `content` | å†…å®¹æ¨¡å— | è§„åˆ™æè¿°å†…å®¹ | æ•°æ®åº“ç‰ˆæœ¬å·æ£€æµ‹ |
| `config` | é…ç½®æ¨¡å— | ç³»ç»Ÿé…ç½® | Redis/ç¯å¢ƒå˜é‡æ£€æµ‹ |
| `cache` | ç¼“å­˜æ¨¡å— | ç¼“å­˜æ•°æ® | æ¸…ç©ºç¼“å­˜ |
| `source` | æºä»£ç æ¨¡å— | Pythonæºä»£ç  | æ–‡ä»¶ä¿®æ”¹æ—¶é—´æ£€æµ‹ |
| `microservice` | å¾®æœåŠ¡æ¨¡å— | gRPCå¾®æœåŠ¡ä»£ç  | æ–‡ä»¶ä¿®æ”¹æ—¶é—´æ£€æµ‹ |

#### çƒ­æ›´æ–°æ£€æµ‹æœºåˆ¶

**æ£€æµ‹é—´éš”**ï¼š
- æ–‡ä»¶ç›‘æ§å™¨ï¼šæ¯ **5ç§’** æ£€æŸ¥ä¸€æ¬¡æ–‡ä»¶å˜åŒ–
- ç‰ˆæœ¬æ£€æŸ¥å™¨ï¼šæ¯ **60ç§’** æ£€æŸ¥ä¸€æ¬¡æ•°æ®åº“ç‰ˆæœ¬å·
- å¾®æœåŠ¡æ£€æŸ¥å™¨ï¼šæ¯ **30ç§’** æ£€æŸ¥ä¸€æ¬¡å¾®æœåŠ¡ä»£ç å˜åŒ–

**æ£€æµ‹èŒƒå›´**ï¼š
- `src/` - æ ¸å¿ƒè®¡ç®—æ¨¡å—
- `server/` - æœåŠ¡å±‚ä»£ç 
- `services/` - å¾®æœåŠ¡ä»£ç ï¼ˆ**å¿…é¡»åŒ…å«ï¼**ï¼‰

#### çƒ­æ›´æ–°å®‰å…¨æœºåˆ¶

**1. è¯­æ³•éªŒè¯**ï¼š
```python
# çƒ­æ›´æ–°å‰å¿…é¡»éªŒè¯è¯­æ³•
import ast
try:
    ast.parse(source_code)  # è¯­æ³•æ­£ç¡®æ‰å…è®¸æ›´æ–°
except SyntaxError:
    # è¯­æ³•é”™è¯¯ï¼Œæ‹’ç»æ›´æ–°ï¼Œä¿æŒæ—§ç‰ˆæœ¬è¿è¡Œ
```

**2. ä¾èµ–é¡ºåº**ï¼š
```python
# æŒ‰ä¾èµ–å…³ç³»é¡ºåºæ›´æ–°
RELOAD_ORDER = [
    'config',      # 1. å…ˆæ›´æ–°é…ç½®
    'rules',       # 2. æ›´æ–°è§„åˆ™
    'content',     # 3. æ›´æ–°å†…å®¹
    'source',      # 4. æ›´æ–°æºä»£ç 
    'microservice', # 5. æ›´æ–°å¾®æœåŠ¡
    'cache',       # 6. æœ€åæ¸…ç†ç¼“å­˜
]
```

**3. å•ä¾‹é‡ç½®**ï¼š
```python
# çƒ­æ›´æ–°æ—¶è‡ªåŠ¨é‡ç½®æ‰€æœ‰å•ä¾‹
SINGLETON_RESET_LIST = [
    'RuleService._engine',
    'RuleService._cache',
    'MetricsCollector._instance',
    'AlertManager._instance',
    'Tracer._instance',
]
```

**4. å›æ»šæœºåˆ¶**ï¼š
```python
# æ¯æ¬¡æ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½æ‰€æœ‰ç›‘æ§æ–‡ä»¶åˆ° .hot_reload_backups/
# å¦‚æœæ›´æ–°å¤±è´¥ï¼Œè‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
# æ”¯æŒä¸¤ç§å›æ»šæ–¹å¼ï¼š
#   - æ–‡ä»¶å¤‡ä»½å›æ»šï¼šæ¢å¤å¤‡ä»½çš„æ–‡ä»¶
#   - Git å›æ»šï¼šä½¿ç”¨ git checkout æ¢å¤æ–‡ä»¶ï¼ˆå½“å¤‡ä»½ä¸å¯ç”¨æ—¶ï¼‰
```

**5. ä»£ç å¤‡ä»½æœºåˆ¶**ï¼š
```python
# çƒ­æ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½æ‰€æœ‰ç›‘æ§æ–‡ä»¶
# å¤‡ä»½ä½ç½®ï¼š.hot_reload_backups/{service_name}/v{version}/
# ä¿ç•™æœ€è¿‘ 10 ä¸ªç‰ˆæœ¬çš„å¤‡ä»½
# å¤‡ä»½ä¿¡æ¯ä¿å­˜åœ¨ backup_info.json
```

**6. ä¾èµ–å…³ç³»ç®¡ç†**ï¼š
```python
# è‡ªåŠ¨æ£€æµ‹å…±äº«æ–‡ä»¶å˜åŒ–ï¼ˆsrc/ã€server/ï¼‰
# è‡ªåŠ¨è§¦å‘æ‰€æœ‰ä¾èµ–æœåŠ¡çš„çƒ­æ›´æ–°
# ä¾èµ–å…³ç³»æ˜ å°„ï¼šDEPENDENCY_MAP
# ç¡®ä¿æ‰€æœ‰ä¾èµ–æœåŠ¡åŒæ­¥æ›´æ–°
```

**7. é”™è¯¯å¤„ç†å’Œæ—¥å¿—**ï¼š
```python
# è¯¦ç»†é”™è¯¯æ—¥å¿—ä¿å­˜åˆ° logs/hot_reload_errors/
# é”™è¯¯æ—¥å¿—åŒ…å«ï¼šé”™è¯¯ä¿¡æ¯ã€å †æ ˆè·Ÿè¸ªã€æ—¶é—´æˆ³ã€ç‰ˆæœ¬å·
# æ”¯æŒå‘Šè­¦æœºåˆ¶ï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡å¯ç”¨ï¼‰
# è‡ªåŠ¨æ¸…ç†æ—§æ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘ 50 ä¸ªï¼‰
```

**8. å¹¶å‘å®‰å…¨**ï¼š
```python
# ä½¿ç”¨åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼
# Servicer å®ä¾‹éªŒè¯ï¼ˆåœ¨æ›¿æ¢å‰éªŒè¯ï¼‰
# åŸå­æ›¿æ¢æœºåˆ¶ï¼ˆç¡®ä¿ç‰ˆæœ¬å·ä¸å®ä¾‹ä¸€è‡´æ€§ï¼‰
# é˜²æ­¢å¹¶å‘æ›´æ–°å†²çª
```

**9. æ€§èƒ½ä¼˜åŒ–**ï¼š
```python
# ä¼˜å…ˆä½¿ç”¨æ–‡ä»¶ä¿®æ”¹æ—¶é—´ï¼ˆé¿å…é‡å¤è®¡ç®—å“ˆå¸Œï¼‰
# åªåœ¨å¿…è¦æ—¶è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
# å‡å°‘ä¸å¿…è¦çš„æ–‡ä»¶è¯»å–
# æ–¹æ³•ç¼“å­˜æœºåˆ¶ï¼ˆDynamicServicerï¼‰
```

#### åŒæœºåŒæ­¥æœºåˆ¶

**åŒæ­¥æµç¨‹**ï¼š
```
1. Node1 æ£€æµ‹åˆ°ä»£ç å˜åŒ–
2. Node1 æ‰§è¡Œçƒ­æ›´æ–°
3. Node1 éªŒè¯æ›´æ–°æˆåŠŸ
4. Node1 é€šè¿‡ Redis å‘å¸ƒæ›´æ–°äº‹ä»¶
5. Node2 æ”¶åˆ°äº‹ä»¶ï¼Œæ‰§è¡Œç›¸åŒçš„çƒ­æ›´æ–°
6. Node2 ç¡®è®¤æ›´æ–°æˆåŠŸ
7. åŒæœºåŒæ­¥å®Œæˆ
```

**Redis é¢‘é“**ï¼š
- `hifate:hot-reload:trigger` - è§¦å‘æ›´æ–°äº‹ä»¶
- `hifate:hot-reload:confirm` - ç¡®è®¤æ›´æ–°å®Œæˆ
- `hifate:hot-reload:rollback` - å›æ»šäº‹ä»¶

**åˆ†å¸ƒå¼é”**ï¼š
```python
# é˜²æ­¢å¹¶å‘æ›´æ–°å†²çª
LOCK_KEY = "hifate:hot-reload:lock"
LOCK_TIMEOUT = 60  # 60ç§’è¶…æ—¶
```

#### çƒ­æ›´æ–°å¼€å‘è§„èŒƒ

**1. ä»£ç ç¼–å†™è§„èŒƒ**ï¼š
- âœ… é¿å…åœ¨æ¨¡å—çº§åˆ«åˆå§‹åŒ–å…¨å±€çŠ¶æ€
- âœ… ä½¿ç”¨å‡½æ•°/ç±»æ–¹æ³•è€Œä¸æ˜¯æ¨¡å—çº§ä»£ç 
- âœ… å•ä¾‹ç±»å¿…é¡»æä¾› `reset()` æ–¹æ³•
- âœ… é¿å…å¾ªç¯ä¾èµ–
- âœ… æ‰€æœ‰é…ç½®é€šè¿‡çƒ­åŠ è½½æœºåˆ¶è·å–

**2. å•ä¾‹ç±»å¿…é¡»æ”¯æŒé‡ç½®**ï¼š
```python
class MySingleton:
    _instance = None
    
    @classmethod
    def get_instance(cls):
        if cls._instance is None:
            cls._instance = cls()
        return cls._instance
    
    @classmethod
    def reset(cls):
        """çƒ­æ›´æ–°æ—¶è°ƒç”¨ï¼Œé‡ç½®å•ä¾‹"""
        cls._instance = None
```

**3. ç¼“å­˜å¿…é¡»æ”¯æŒæ¸…ç†**ï¼š
```python
class MyService:
    _cache = {}
    
    @classmethod
    def clear_cache(cls):
        """çƒ­æ›´æ–°æ—¶è°ƒç”¨ï¼Œæ¸…ç†ç¼“å­˜"""
        cls._cache.clear()
```

**4. é…ç½®å¿…é¡»æ”¯æŒçƒ­åŠ è½½**ï¼š
```python
# âœ… æ­£ç¡®ï¼šæ¯æ¬¡ä½¿ç”¨æ—¶è·å–é…ç½®
def get_config():
    return os.getenv("MY_CONFIG", "default")

# âŒ é”™è¯¯ï¼šæ¨¡å—åŠ è½½æ—¶å›ºå®šé…ç½®
MY_CONFIG = os.getenv("MY_CONFIG", "default")  # çƒ­æ›´æ–°åä¸ä¼šå˜åŒ–
```

#### çƒ­æ›´æ–°æµ‹è¯•è§„èŒƒ

**æ¯æ¬¡ä»£ç ä¿®æ”¹åå¿…é¡»éªŒè¯**ï¼š
```bash
# 1. æ£€æŸ¥çƒ­æ›´æ–°çŠ¶æ€
curl http://localhost:8001/api/v1/hot-reload/status

# 2. æ‰‹åŠ¨è§¦å‘çƒ­æ›´æ–°
curl -X POST http://localhost:8001/api/v1/hot-reload/check

# 3. éªŒè¯ç‰ˆæœ¬å·æ›´æ–°
curl http://localhost:8001/api/v1/hot-reload/versions

# 4. éªŒè¯åŠŸèƒ½æ­£å¸¸
# è°ƒç”¨ç›¸å…³ API æµ‹è¯•åŠŸèƒ½
```

**å¾®æœåŠ¡çƒ­æ›´æ–°æµ‹è¯•æµç¨‹**ï¼š
```bash
# 1. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
python3 scripts/hot_reload/test_microservice_hot_reload.py

# 2. æµ‹è¯•åŸºæœ¬åŠŸèƒ½
# - åŸºæœ¬çƒ­æ›´æ–°åŠŸèƒ½
# - å›æ»šæœºåˆ¶
# - ä¾èµ–å…³ç³»ç®¡ç†
# - é”™è¯¯å¤„ç†
# - æ€§èƒ½ä¼˜åŒ–
# - å¹¶å‘å®‰å…¨
# - DynamicServicer æ–¹æ³•è½¬å‘

# 3. éªŒè¯å¾®æœåŠ¡çƒ­æ›´æ–°çŠ¶æ€
curl http://localhost:8001/api/v1/hot-reload/microservices

# 4. æµ‹è¯•å®é™…çƒ­æ›´æ–°
# ä¿®æ”¹å¾®æœåŠ¡ä»£ç åï¼Œç­‰å¾…30ç§’è‡ªåŠ¨æ›´æ–°ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘ï¼š
curl -X POST http://localhost:8001/api/v1/hot-reload/reload/microservice
```

**æµ‹è¯•æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼ˆ7/7ï¼‰
- [ ] å¤‡ä»½ç›®å½•åˆ›å»ºæ­£å¸¸ï¼ˆ`.hot_reload_backups/`ï¼‰
- [ ] é”™è¯¯æ—¥å¿—ç›®å½•åˆ›å»ºæ­£å¸¸ï¼ˆ`logs/hot_reload_errors/`ï¼‰
- [ ] ä¾èµ–å…³ç³»è¯†åˆ«æ­£ç¡®
- [ ] é”™è¯¯æ—¥å¿—å†™å…¥æ­£å¸¸
- [ ] æ–‡ä»¶ä¿®æ”¹æ—¶é—´æ£€æŸ¥æ­£å¸¸
- [ ] é”æœºåˆ¶å­˜åœ¨
- [ ] DynamicServicer æ–¹æ³•è½¬å‘æ­£å¸¸

#### å¾®æœåŠ¡çƒ­æ›´æ–°æµ‹è¯•æµç¨‹

**æ ‡å‡†æµ‹è¯•æµç¨‹**ï¼š
```bash
# 1. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
python3 scripts/hot_reload/test_microservice_hot_reload.py

# 2. éªŒè¯æµ‹è¯•ç»“æœ
# åº”è¯¥çœ‹åˆ°ï¼šğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ï¼ˆ7/7 é€šè¿‡ï¼‰

# 3. æµ‹è¯•å®é™…çƒ­æ›´æ–°ï¼ˆå¯é€‰ï¼‰
# a. ä¿®æ”¹å¾®æœåŠ¡ä»£ç 
vim services/bazi_core/grpc_server.py

# b. ç­‰å¾…è‡ªåŠ¨æ›´æ–°ï¼ˆ30ç§’ï¼‰æˆ–æ‰‹åŠ¨è§¦å‘
curl -X POST http://localhost:8001/api/v1/hot-reload/reload/microservice

# c. éªŒè¯æ›´æ–°æˆåŠŸ
curl http://localhost:8001/api/v1/hot-reload/microservices

# d. æµ‹è¯•å›æ»šï¼ˆå¦‚æœéœ€è¦ï¼‰
curl -X POST http://localhost:8001/api/v1/hot-reload/rollback
```

**æµ‹è¯•è¦†ç›–èŒƒå›´**ï¼š
- âœ… åŸºæœ¬çƒ­æ›´æ–°åŠŸèƒ½
- âœ… å›æ»šæœºåˆ¶ï¼ˆå¤‡ä»½å’Œ Git å›æ»šï¼‰
- âœ… ä¾èµ–å…³ç³»ç®¡ç†
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- âœ… æ€§èƒ½ä¼˜åŒ–
- âœ… å¹¶å‘å®‰å…¨
- âœ… DynamicServicer æ–¹æ³•è½¬å‘

**æµ‹è¯•æ–‡ä»¶ä½ç½®**ï¼š
- `scripts/hot_reload/test_microservice_hot_reload.py` - å®Œæ•´æµ‹è¯•å¥—ä»¶

#### çƒ­æ›´æ–°ç›‘æ§å‘Šè­¦

**ç›‘æ§æŒ‡æ ‡**ï¼š
- çƒ­æ›´æ–°æˆåŠŸ/å¤±è´¥æ¬¡æ•°
- çƒ­æ›´æ–°å»¶è¿Ÿæ—¶é—´
- æ¨¡å—ç‰ˆæœ¬å·å˜åŒ–
- åŒæœºåŒæ­¥çŠ¶æ€

**å‘Šè­¦æ¡ä»¶**ï¼š
- çƒ­æ›´æ–°å¤±è´¥ â†’ ç«‹å³å‘Šè­¦
- åŒæœºç‰ˆæœ¬ä¸ä¸€è‡´ â†’ ç«‹å³å‘Šè­¦
- çƒ­æ›´æ–°å»¶è¿Ÿ > 5åˆ†é’Ÿ â†’ è­¦å‘Š
- å›æ»šå‘ç”Ÿ â†’ ç«‹å³å‘Šè­¦

#### ä¸¥æ ¼ç¦æ­¢çš„æ“ä½œ

| æ“ä½œ | åŸå›  | æ›¿ä»£æ–¹æ¡ˆ |
|------|------|---------|
| âŒ `docker restart` | ä¸­æ–­æœåŠ¡ | ä½¿ç”¨çƒ­æ›´æ–° API |
| âŒ `docker-compose restart` | ä¸­æ–­æœåŠ¡ | ä½¿ç”¨çƒ­æ›´æ–° API |
| âŒ `systemctl restart` | ä¸­æ–­æœåŠ¡ | ä½¿ç”¨çƒ­æ›´æ–° API |
| âŒ æ‰‹åŠ¨åœæ­¢å¯åŠ¨æœåŠ¡ | ä¸­æ–­æœåŠ¡ | ä½¿ç”¨çƒ­æ›´æ–° API |
| âŒ ç›´æ¥ä¿®æ”¹ç”Ÿäº§æœåŠ¡å™¨ä»£ç  | ä¸å¯è¿½æº¯ | é€šè¿‡ Git æ¨é€ |
| âŒ è·³è¿‡çƒ­æ›´æ–°ç›´æ¥éƒ¨ç½² | å¯èƒ½å¯¼è‡´é—®é¢˜ | å¿…é¡»ç»è¿‡çƒ­æ›´æ–° |

#### å”¯ä¸€å…è®¸é‡å¯çš„ä¾‹å¤–æƒ…å†µ

ä»¥ä¸‹æƒ…å†µ**å¿…é¡»ç»è¿‡å®¡æ‰¹**æ‰èƒ½é‡å¯ï¼š
1. **æ–°å¢ä¾èµ–åŒ…**ï¼šéœ€è¦å®‰è£…æ–°çš„ Python åŒ…
2. **ä¿®æ”¹çƒ­æ›´æ–°ç³»ç»Ÿæœ¬èº«**ï¼š`server/hot_reload/` ç›®å½•
3. **ä¿®æ”¹å¯åŠ¨è„šæœ¬**ï¼š`server/main.py` çš„å¯åŠ¨é€»è¾‘
4. **ç³»ç»Ÿçº§åˆ«é—®é¢˜**ï¼šå†…å­˜æ³„æ¼ã€è¿›ç¨‹åƒµæ­»ç­‰

**å³ä½¿å…è®¸é‡å¯ï¼Œä¹Ÿå¿…é¡»**ï¼š
1. é€‰æ‹©ä½å³°æœŸï¼ˆå‡Œæ™¨ 2:00-6:00ï¼‰
2. ä½¿ç”¨æ»šåŠ¨æ›´æ–°ï¼ˆåŒæœºè½®æµé‡å¯ï¼‰
3. å‡†å¤‡å›æ»šæ–¹æ¡ˆ
4. è®°å½•é‡å¯åŸå› å’Œæ—¶é—´

#### çƒ­æ›´æ–°æ£€æŸ¥æ¸…å•

æ¯æ¬¡å¼€å‘æ–°åŠŸèƒ½æ—¶ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

- [ ] ä»£ç æ˜¯å¦åœ¨çƒ­æ›´æ–°ç›‘æ§èŒƒå›´å†…ï¼ˆ`src/`, `server/`, `services/`ï¼‰
- [ ] æ˜¯å¦å¼•å…¥äº†æ–°çš„å…¨å±€çŠ¶æ€ï¼ˆéœ€è¦æ”¯æŒé‡ç½®ï¼‰
- [ ] å•ä¾‹ç±»æ˜¯å¦æä¾›äº† `reset()` æ–¹æ³•
- [ ] ç¼“å­˜æ˜¯å¦æ”¯æŒæ¸…ç†
- [ ] é…ç½®æ˜¯å¦æ”¯æŒçƒ­åŠ è½½
- [ ] æ˜¯å¦æµ‹è¯•äº†çƒ­æ›´æ–°åŠŸèƒ½
- [ ] æ˜¯å¦éªŒè¯äº†åŠŸèƒ½æ­£å¸¸
- [ ] æ˜¯å¦æ›´æ–°äº†çƒ­æ›´æ–°æ–‡æ¡£

**å¾®æœåŠ¡çƒ­æ›´æ–°ä¸“é¡¹æ£€æŸ¥**ï¼š
- [ ] å¾®æœåŠ¡æ˜¯å¦å·²é›†æˆçƒ­æ›´æ–°ï¼ˆä½¿ç”¨ `create_hot_reload_server`ï¼‰
- [ ] æ˜¯å¦æ³¨å†Œäº†çƒ­æ›´æ–°å™¨ï¼ˆ`register_microservice_reloader`ï¼‰
- [ ] ä¾èµ–å¯¹è±¡æ˜¯å¦æ”¯æŒé‡ç½®ï¼ˆå•ä¾‹ã€ç¼“å­˜ç­‰ï¼‰
- [ ] æ˜¯å¦æµ‹è¯•äº†å›æ»šæœºåˆ¶
- [ ] æ˜¯å¦éªŒè¯äº†ä¾èµ–å…³ç³»ç®¡ç†
- [ ] æ˜¯å¦æ£€æŸ¥äº†é”™è¯¯æ—¥å¿—
- [ ] æ˜¯å¦è¿è¡Œäº†å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆ`test_microservice_hot_reload.py`ï¼‰

#### å¾®æœåŠ¡çƒ­æ›´æ–°ç¼ºé™·ä¿®å¤æ¸…å•

**å·²ä¿®å¤çš„ç¼ºé™·**ï¼ˆ2025-01-XXï¼‰ï¼š

1. âœ… **å›æ»šæœºåˆ¶ä¸å®Œæ•´**
   - æ·»åŠ ä»£ç å¤‡ä»½æœºåˆ¶ï¼ˆ`.hot_reload_backups/`ï¼‰
   - æ”¯æŒ Git å›æ»šï¼ˆå½“å¤‡ä»½ä¸å¯ç”¨æ—¶ï¼‰
   - æ”¹è¿›å›æ»šé€»è¾‘ï¼Œæ¢å¤å¤‡ä»½æ–‡ä»¶

2. âœ… **DynamicServicer æ–¹æ³•è½¬å‘**
   - ä½¿ç”¨ `__getattribute__` ç¡®ä¿æ‰€æœ‰å±æ€§è®¿é—®éƒ½ç»è¿‡è½¬å‘
   - æ·»åŠ æ–¹æ³•ç¼“å­˜æœºåˆ¶ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
   - æ”¯æŒåŠ¨æ€æ–¹æ³•ç»‘å®š

3. âœ… **ä¾èµ–å¯¹è±¡ä¸æ›´æ–°**
   - è‡ªåŠ¨æ£€æµ‹ä¾èµ–å¯¹è±¡ï¼ˆServicer å®ä¾‹çš„æ‰€æœ‰å±æ€§ï¼‰
   - é‡ç½®å•ä¾‹å¯¹è±¡ï¼ˆè‡ªåŠ¨æ£€æµ‹å¹¶é‡ç½® `_instance`ï¼‰
   - æ”¯æŒé‡ç½®æ–¹æ³•ï¼ˆè‡ªåŠ¨è°ƒç”¨ `reset()` å’Œ `clear_cache()`ï¼‰

4. âœ… **å•ä¾‹ä¸é‡ç½®**
   - é›†æˆ SingletonReloader
   - åœ¨çƒ­æ›´æ–°æ—¶è‡ªåŠ¨é‡ç½®æ‰€æœ‰æ³¨å†Œçš„å•ä¾‹

5. âœ… **ä¾èµ–æ¨¡å—ä¸åŒæ­¥**
   - æ·»åŠ ä¾èµ–å…³ç³»æ˜ å°„ï¼ˆDEPENDENCY_MAPï¼‰
   - è‡ªåŠ¨è§¦å‘æ›´æ–°ï¼ˆæ£€æµ‹åˆ°å…±äº«æ–‡ä»¶å˜åŒ–æ—¶ï¼‰
   - åŒæ­¥æ›´æ–°ï¼ˆç¡®ä¿æ‰€æœ‰ä¾èµ–æœåŠ¡ä½¿ç”¨æœ€æ–°ä»£ç ï¼‰

6. âœ… **é”™è¯¯å¤„ç†**
   - è¯¦ç»†é”™è¯¯æ—¥å¿—ï¼ˆä¿å­˜åˆ° `logs/hot_reload_errors/`ï¼‰
   - å‘Šè­¦æœºåˆ¶ï¼ˆæ”¯æŒå‘Šè­¦ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡å¯ç”¨ï¼‰
   - é”™è¯¯æ¢å¤ï¼ˆæ”¹è¿›é”™è¯¯æ¢å¤æµç¨‹ï¼Œè‡ªåŠ¨æ¸…ç†æ—§æ—¥å¿—ï¼‰

7. âœ… **å¹¶å‘å®‰å…¨**
   - åŸå­æ›¿æ¢æœºåˆ¶ï¼ˆä½¿ç”¨åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼ï¼‰
   - Servicer éªŒè¯ï¼ˆåœ¨æ›¿æ¢å‰éªŒè¯æ–°å®ä¾‹æ˜¯å¦å¯ç”¨ï¼‰
   - ç‰ˆæœ¬ä¸€è‡´æ€§ï¼ˆç¡®ä¿ç‰ˆæœ¬å·ä¸å®ä¾‹çš„ä¸€è‡´æ€§ï¼‰

8. âœ… **æ€§èƒ½ä¼˜åŒ–**
   - ä¼˜åŒ–æ–‡ä»¶æ‰«æï¼ˆä¼˜å…ˆä½¿ç”¨ä¿®æ”¹æ—¶é—´ï¼Œåªåœ¨å¿…è¦æ—¶è®¡ç®—å“ˆå¸Œï¼‰
   - å‡å°‘æ–‡ä»¶è¯»å–ï¼ˆé¿å…é‡å¤è¯»å–æ–‡ä»¶å†…å®¹ï¼‰
   - ç¼“å­˜ä¼˜åŒ–ï¼ˆå¤ç”¨å·²è¯»å–çš„æ–‡ä»¶å†…å®¹ï¼‰

**æµ‹è¯•éªŒè¯**ï¼š
- âœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼ˆ7/7ï¼‰
- âœ… å¤‡ä»½æœºåˆ¶æ­£å¸¸
- âœ… é”™è¯¯æ—¥å¿—æ­£å¸¸
- âœ… ä¾èµ–å…³ç³»è¯†åˆ«æ­£ç¡®
- âœ… æ€§èƒ½ä¼˜åŒ–æœ‰æ•ˆ

#### æœ¬åœ°/æµ‹è¯•/ç”Ÿäº§ä¸€è‡´æ€§è§„èŒƒ ã€æœ€é«˜ä¼˜å…ˆçº§ã€‘

**ğŸ”´ æ ¸å¿ƒåŸåˆ™**ï¼šæœ¬åœ°ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„ä»£ç å’Œé…ç½®å¿…é¡»å®Œå…¨ä¸€è‡´ï¼**åšå†³ç¦æ­¢ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šä¿®æ”¹ä»£ç ï¼**

**ğŸ”´ ä¸¥æ ¼ç¦æ­¢çš„æ“ä½œ**ï¼š

| æ“ä½œ | çŠ¶æ€ | åŸå›  | æ­£ç¡®æ–¹å¼ |
|------|------|------|---------|
| âŒ **ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šä¿®æ”¹ä»£ç ** | **ç¦æ­¢** | ç ´åä»£ç ä¸€è‡´æ€§ï¼Œæ— æ³•ç‰ˆæœ¬æ§åˆ¶ | æœ¬åœ°ä¿®æ”¹ â†’ GitHub â†’ æœåŠ¡å™¨ |
| âŒ **ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šä¿®æ”¹é…ç½®æ–‡ä»¶** | **ç¦æ­¢** | é…ç½®ä¸ä¸€è‡´ï¼Œéš¾ä»¥è¿½è¸ª | æœ¬åœ°ä¿®æ”¹ â†’ GitHub â†’ æœåŠ¡å™¨ |
| âŒ **åœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶** | **ç¦æ­¢** | æ— æ³•ç‰ˆæœ¬æ§åˆ¶ï¼Œå®¹æ˜“ä¸¢å¤± | æœ¬åœ°ä¿®æ”¹ â†’ GitHub â†’ æœåŠ¡å™¨ |
| âŒ **è·³è¿‡ Git ç›´æ¥éƒ¨ç½²** | **ç¦æ­¢** | æ— æ³•è¿½è¸ªå˜æ›´ï¼Œæ— æ³•å›æ»š | å¿…é¡»é€šè¿‡ Git ç‰ˆæœ¬æ§åˆ¶ |
| âŒ **æœåŠ¡å™¨ä»£ç ä¸ GitHub ä¸ä¸€è‡´** | **ç¦æ­¢** | ç ´åä¸€è‡´æ€§åŸåˆ™ | å¿…é¡»ä¿æŒä¸€è‡´ |

**âœ… å”¯ä¸€æ­£ç¡®çš„ä»£ç ä¿®æ”¹æµç¨‹**ï¼š

```
æœ¬åœ°å¼€å‘ â†’ æäº¤åˆ° Git â†’ æ¨é€åˆ° GitHub â†’ æœåŠ¡å™¨æ‹‰å– â†’ çƒ­æ›´æ–°
   â†“           â†“              â†“              â†“           â†“
 ä¿®æ”¹ä»£ç     git commit    git push      git pull    è‡ªåŠ¨æ›´æ–°
```

**è¯¦ç»†æµç¨‹**ï¼š

1. **æœ¬åœ°å¼€å‘**
   ```bash
   # åœ¨æœ¬åœ° Mac ä¸Šä¿®æ”¹ä»£ç 
   vim server/api/v1/bazi.py
   ```

2. **æäº¤åˆ° Git**
   ```bash
   git add server/api/v1/bazi.py
   git commit -m "feat: æ–°åŠŸèƒ½"
   ```

3. **æ¨é€åˆ° GitHub**
   ```bash
   git push origin master
   ```

4. **æœåŠ¡å™¨æ‹‰å–ï¼ˆè‡ªåŠ¨æˆ–æ‰‹åŠ¨ï¼‰**
   ```bash
   # å¢é‡éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨æ‹‰å–
   bash deploy/scripts/incremental_deploy_production.sh
   
   # æˆ–æ‰‹åŠ¨æ‹‰å–
   ssh root@server "cd /opt/HiFate-bazi && git pull origin master"
   ```

5. **çƒ­æ›´æ–°ï¼ˆè‡ªåŠ¨ï¼‰**
   ```bash
   # çƒ­æ›´æ–°ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¹¶æ›´æ–°ï¼ˆ30ç§’å†…ï¼‰
   # æˆ–æ‰‹åŠ¨è§¦å‘
   curl -X POST http://server:8001/api/v1/hot-reload/check
   ```

**ä¸€è‡´æ€§è¦æ±‚**ï¼š
| é¡¹ç›® | è¦æ±‚ | æ£€æŸ¥æ–¹å¼ | è¿ååæœ |
|------|------|---------|---------|
| **ä»£ç ç‰ˆæœ¬** | ä¸‰ç¯å¢ƒå®Œå…¨ä¸€è‡´ | `git log --oneline -1` | å¯èƒ½å¯¼è‡´åŠŸèƒ½ä¸ä¸€è‡´ |
| **æ–‡ä»¶å†…å®¹** | ä¸‰ç¯å¢ƒå®Œå…¨ä¸€è‡´ | `git diff` æ£€æŸ¥æœåŠ¡å™¨ä»£ç  | å¯èƒ½å¯¼è‡´ Bug |
| **é…ç½®æ–‡ä»¶** | ä¸‰ç¯å¢ƒå®Œå…¨ä¸€è‡´ | å¯¹æ¯”é…ç½®æ–‡ä»¶å†…å®¹ | å¯èƒ½å¯¼è‡´é…ç½®é”™è¯¯ |
| **çƒ­æ›´æ–°é…ç½®** | ä¸‰ç¯å¢ƒå®Œå…¨ä¸€è‡´ | æ£€æŸ¥ `HOT_RELOAD_*` ç¯å¢ƒå˜é‡ | å¯èƒ½å¯¼è‡´çƒ­æ›´æ–°å¤±è´¥ |
| **ä¾èµ–åŒ…ç‰ˆæœ¬** | ä¸‰ç¯å¢ƒå®Œå…¨ä¸€è‡´ | æ£€æŸ¥ `requirements.txt` | å¯èƒ½å¯¼è‡´ä¾èµ–é—®é¢˜ |

**æœåŠ¡å™¨ä»£ç æ£€æŸ¥æœºåˆ¶**ï¼š

å¢é‡éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶å¤„ç†æœåŠ¡å™¨ä¸Šçš„æœ¬åœ°æ›´æ”¹ï¼š

```bash
# åœ¨æ‹‰å–ä»£ç å‰ï¼Œè‡ªåŠ¨ä¿å­˜æœåŠ¡å™¨ä¸Šçš„æœ¬åœ°æ›´æ”¹
git stash || true

# æ‹‰å–æœ€æ–°ä»£ç ï¼ˆç¡®ä¿ä¸ GitHub ä¸€è‡´ï¼‰
git pull origin master

# å¦‚æœæœåŠ¡å™¨ä¸Šæœ‰æœ¬åœ°æ›´æ”¹ï¼Œä¼šæ˜¾ç¤ºè­¦å‘Š
```

**å¦‚æœå‘ç°æœåŠ¡å™¨ä¸Šæœ‰æœ¬åœ°æ›´æ”¹**ï¼š

1. **æ£€æŸ¥æ›´æ”¹å†…å®¹**ï¼š
   ```bash
   ssh root@server "cd /opt/HiFate-bazi && git stash list"
   ssh root@server "cd /opt/HiFate-bazi && git stash show -p"
   ```

2. **åˆ¤æ–­æ˜¯å¦éœ€è¦ä¿ç•™**ï¼š
   - å¦‚æœæ˜¯å¿…è¦çš„é…ç½®ï¼ˆå¦‚ IP åœ°å€ï¼‰ï¼Œåº”è¯¥åœ¨æœ¬åœ°ä¿®æ”¹å¹¶æäº¤åˆ° GitHub
   - å¦‚æœæ˜¯ä¸´æ—¶ä¿®æ”¹ï¼Œåº”è¯¥åˆ é™¤

3. **æ­£ç¡®å¤„ç†**ï¼š
   ```bash
   # å¦‚æœéœ€è¦ä¿ç•™ï¼Œåœ¨æœ¬åœ°ä¿®æ”¹å¹¶æäº¤
   # 1. åœ¨æœ¬åœ°ä¿®æ”¹ç›¸åŒæ–‡ä»¶
   # 2. æäº¤åˆ° GitHub
   git add deploy/nginx/conf.d/hifate.conf
   git commit -m "é…ç½®ç”Ÿäº§ç¯å¢ƒ Nginx é…ç½®"
   git push origin master
   
   # 3. æœåŠ¡å™¨ä¸Šåˆ é™¤ stash
   ssh root@server "cd /opt/HiFate-bazi && git stash drop"
   ```

**ç¦æ­¢çš„æ“ä½œ**ï¼š
- âŒ æœ¬åœ°ä»£ç ä¸ç”Ÿäº§ä¸åŒ
- âŒ æœ¬åœ°çƒ­æ›´æ–°é…ç½®ä¸ç”Ÿäº§ä¸åŒ
- âŒ æœ¬åœ°æµ‹è¯•é€šè¿‡ä½†ç”Ÿäº§å¤±è´¥
- âŒ è·³è¿‡æµ‹è¯•ç¯å¢ƒç›´æ¥éƒ¨ç½²ç”Ÿäº§
- âŒ **ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šä¿®æ”¹ä»£ç ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ç¦æ­¢ï¼‰**
- âŒ **è·³è¿‡ Git ç›´æ¥éƒ¨ç½²**
- âŒ **æœåŠ¡å™¨ä»£ç ä¸ GitHub ä¸ä¸€è‡´**

**æ­£ç¡®çš„éƒ¨ç½²æµç¨‹**ï¼š
```
1. æœ¬åœ°å¼€å‘ â†’ æœ¬åœ°çƒ­æ›´æ–°æµ‹è¯•é€šè¿‡
2. æäº¤åˆ° Git â†’ git commit
3. æ¨é€åˆ° GitHub â†’ git push origin master
4. æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨çƒ­æ›´æ–°ï¼ˆæˆ–æ‰‹åŠ¨è§¦å‘ï¼‰
5. æµ‹è¯•ç¯å¢ƒéªŒè¯ â†’ é€šè¿‡åæ¨é€åˆ°ç”Ÿäº§åˆ†æ”¯
6. ç”Ÿäº§ç¯å¢ƒå¢é‡éƒ¨ç½² â†’ è‡ªåŠ¨æ‹‰å– GitHub ä»£ç 
7. ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨çƒ­æ›´æ–° â†’ åŒæœºåŒæ­¥
8. éªŒè¯ç”Ÿäº§ç¯å¢ƒåŠŸèƒ½æ­£å¸¸
```

**ä»£ç ä¸€è‡´æ€§æ£€æŸ¥æ¸…å•**ï¼š

æ¯æ¬¡éƒ¨ç½²å‰å¿…é¡»æ£€æŸ¥ï¼š
- [ ] æœ¬åœ°ä»£ç å·²æäº¤åˆ° Git
- [ ] æœ¬åœ°ä»£ç å·²æ¨é€åˆ° GitHub
- [ ] æœåŠ¡å™¨ä»£ç ä¸ GitHub ä¸€è‡´ï¼ˆ`git status` æ— æœ¬åœ°æ›´æ”¹ï¼‰
- [ ] ä¸‰ç¯å¢ƒä»£ç ç‰ˆæœ¬ä¸€è‡´ï¼ˆ`git log --oneline -1`ï¼‰
- [ ] é…ç½®æ–‡ä»¶ä¸‰ç¯å¢ƒä¸€è‡´
- [ ] æ— æœåŠ¡å™¨æœ¬åœ°æœªæäº¤çš„æ›´æ”¹

**è¿åä¸€è‡´æ€§åŸåˆ™çš„å¤„ç†**ï¼š

å¦‚æœå‘ç°æœåŠ¡å™¨ä¸Šæœ‰æœ¬åœ°æ›´æ”¹ï¼š
1. **ç«‹å³åœæ­¢éƒ¨ç½²**
2. **æ£€æŸ¥æ›´æ”¹å†…å®¹**ï¼š`git stash show -p`
3. **åˆ¤æ–­æ˜¯å¦éœ€è¦ä¿ç•™**ï¼š
   - éœ€è¦ä¿ç•™ â†’ åœ¨æœ¬åœ°ä¿®æ”¹å¹¶æäº¤åˆ° GitHub
   - ä¸éœ€è¦ä¿ç•™ â†’ åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ›´æ”¹
4. **ç¡®ä¿ä¸€è‡´æ€§åç»§ç»­éƒ¨ç½²**

**æ ¸å¿ƒè¦ç‚¹**ï¼š
- ğŸ”´ **æœ€é«˜ä¼˜å…ˆçº§**ï¼š**åšå†³ç¦æ­¢ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šä¿®æ”¹ä»£ç **
- âœ… **å”¯ä¸€æ­£ç¡®æ–¹å¼**ï¼šæœ¬åœ°ä¿®æ”¹ â†’ GitHub â†’ æœåŠ¡å™¨æ‹‰å–
- ğŸ”’ **å¼ºåˆ¶è¦æ±‚**ï¼šæœ¬åœ°ã€GitHubã€æœåŠ¡å™¨ä¸‰å¤„ä»£ç å¿…é¡»å®Œå…¨ä¸€è‡´
- ğŸ“‹ **å¿…é¡»æ£€æŸ¥**ï¼šæ¯æ¬¡éƒ¨ç½²å‰æ£€æŸ¥æœåŠ¡å™¨ä»£ç ä¸ GitHub æ˜¯å¦ä¸€è‡´

---

### ğŸ”„ ä»£ç ä¸€è‡´æ€§æ ‡å‡†æµç¨‹ ã€å¿…é¡»éµå®ˆã€‘

**æ ‡å‡†æµç¨‹ï¼ˆæ¨èï¼‰**ï¼š

```
1. æœ¬åœ°ä¿®æ”¹ä»£ç 
   â†“
2. æœ¬åœ°æµ‹è¯•éªŒè¯
   â†“
3. æäº¤åˆ° Gitï¼ˆgit commitï¼‰
   â†“
4. æ¨é€åˆ° GitHubï¼ˆgit pushï¼‰
   â†“
5. å¢é‡éƒ¨ç½²åˆ°ç”Ÿäº§ï¼ˆbash deploy/scripts/incremental_deploy_production.shï¼‰
   â†“
6. éªŒè¯ç”Ÿäº§ç¯å¢ƒ
   â†“
7. å¦‚æœå‘ç°é—®é¢˜ï¼Œå›åˆ°æ­¥éª¤1é‡æ–°ä¿®æ”¹
```

**è¯¦ç»†æ­¥éª¤**ï¼š

#### æ­¥éª¤ 1ï¼šæœ¬åœ°ä¿®æ”¹ä»£ç 

```bash
# åœ¨æœ¬åœ° Mac ä¸Šä¿®æ”¹ä»£ç 
vim server/api/v1/bazi.py
vim local_frontend/fortune.html
# ... ä¿®æ”¹å…¶ä»–æ–‡ä»¶ ...
```

#### æ­¥éª¤ 2ï¼šæœ¬åœ°æµ‹è¯•éªŒè¯

```bash
# æœ¬åœ°å¯åŠ¨æœåŠ¡æµ‹è¯•
python3 server/start.py

# è®¿é—®æœ¬åœ°æµ‹è¯•
curl http://localhost:8001/health
```

#### æ­¥éª¤ 3ï¼šæäº¤åˆ° Git

```bash
# æŸ¥çœ‹ä¿®æ”¹
git status

# æ·»åŠ ä¿®æ”¹çš„æ–‡ä»¶
git add server/api/v1/bazi.py local_frontend/fortune.html

# æäº¤
git commit -m "fix: ä¿®å¤é¦–é¡µ404é”™è¯¯"
```

#### æ­¥éª¤ 4ï¼šæ¨é€åˆ° GitHub

```bash
# æ¨é€åˆ°è¿œç¨‹
git push origin master
```

#### æ­¥éª¤ 5ï¼šå¢é‡éƒ¨ç½²åˆ°ç”Ÿäº§

```bash
# ä½¿ç”¨å¢é‡éƒ¨ç½²è„šæœ¬ï¼ˆè‡ªåŠ¨æ‹‰å–GitHubä»£ç å¹¶çƒ­æ›´æ–°ï¼‰
export SSH_PASSWORD="Yuanqizhan@163"
bash deploy/scripts/incremental_deploy_production.sh
```

#### æ­¥éª¤ 6ï¼šéªŒè¯ç”Ÿäº§ç¯å¢ƒ

```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://8.210.52.217:8001/health
curl http://47.243.160.43:8001/health

# æ£€æŸ¥åŠŸèƒ½
curl http://8.210.52.217/fortune.html
```

#### æ­¥éª¤ 7ï¼šå¦‚æœå‘ç°é—®é¢˜ï¼Œå›åˆ°æ­¥éª¤1

```bash
# å¦‚æœç”Ÿäº§ç¯å¢ƒæœ‰é—®é¢˜ï¼Œå›åˆ°æœ¬åœ°ä¿®æ”¹
# é‡å¤æ­¥éª¤1-6ï¼Œç›´åˆ°é—®é¢˜è§£å†³
```

---

### âš¡ å¿«é€Ÿä¿®å¤æµç¨‹ï¼ˆç´§æ€¥æƒ…å†µï¼Œéœ€ç¡®ä¿ä»£ç ä¸€è‡´æ€§ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šç´§æ€¥ä¿®å¤ï¼Œéœ€è¦å¿«é€Ÿéƒ¨ç½²ï¼Œä½†**å¿…é¡»ç¡®ä¿ä»£ç ä¸€è‡´æ€§**

**æµç¨‹**ï¼š

```
1. æœ¬åœ°ä¿®æ”¹ä»£ç ï¼ˆç¡®ä¿ä¸æœåŠ¡å™¨ä»£ç ä¸€è‡´ï¼‰
   â†“
2. ç›´æ¥éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆè·³è¿‡GitHubï¼Œä½†å¿…é¡»éªŒè¯ä¸€è‡´æ€§ï¼‰
   â†“
3. éªŒè¯éƒ¨ç½²æˆåŠŸ
   â†“
4. ç«‹å³æäº¤åˆ°GitHubï¼ˆç¡®ä¿ä»£ç ä¸€è‡´æ€§ï¼‰
   â†“
5. æœåŠ¡å™¨æ‹‰å–GitHubä»£ç ï¼ˆç¡®ä¿æœ€ç»ˆä¸€è‡´ï¼‰
```

**è¯¦ç»†æ­¥éª¤**ï¼š

#### æ­¥éª¤ 1ï¼šæœ¬åœ°ä¿®æ”¹ä»£ç ï¼ˆç¡®ä¿ä¸æœåŠ¡å™¨ä»£ç ä¸€è‡´ï¼‰

```bash
# 1.1 å…ˆæ‹‰å–æœåŠ¡å™¨å½“å‰ä»£ç ï¼ˆç¡®ä¿æœ¬åœ°ä¸æœåŠ¡å™¨ä¸€è‡´ï¼‰
ssh root@8.210.52.217 "cd /opt/HiFate-bazi && git rev-parse HEAD" > /tmp/server_commit.txt
git fetch origin
git checkout $(cat /tmp/server_commit.txt)  # åˆ‡æ¢åˆ°æœåŠ¡å™¨å½“å‰ç‰ˆæœ¬

# 1.2 åœ¨æœ¬åœ°ä¿®æ”¹ä»£ç 
vim server/api/v1/bazi.py

# 1.3 éªŒè¯ä¿®æ”¹
python3 -c "import ast; ast.parse(open('server/api/v1/bazi.py').read())"
```

#### æ­¥éª¤ 2ï¼šç›´æ¥éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆè·³è¿‡GitHubï¼Œä½†å¿…é¡»éªŒè¯ä¸€è‡´æ€§ï¼‰

```bash
# 2.1 åˆ›å»ºä¸´æ—¶éƒ¨ç½²è„šæœ¬
cat > /tmp/quick_deploy.sh << 'EOF'
#!/bin/bash
# å¿«é€Ÿéƒ¨ç½²è„šæœ¬ - ç›´æ¥éƒ¨ç½²ä»£ç åˆ°æœåŠ¡å™¨ï¼Œç¡®ä¿ä¸€è‡´æ€§

SERVER_IP="8.210.52.217"
PROJECT_DIR="/opt/HiFate-bazi"
LOCAL_FILE="$1"
REMOTE_FILE="$2"

# å¤‡ä»½æœåŠ¡å™¨åŸæ–‡ä»¶
ssh root@$SERVER_IP "cd $PROJECT_DIR && cp $REMOTE_FILE ${REMOTE_FILE}.backup.$(date +%s)"

# ä¸Šä¼ æ–‡ä»¶
scp $LOCAL_FILE root@$SERVER_IP:$PROJECT_DIR/$REMOTE_FILE

# éªŒè¯æ–‡ä»¶ä¸€è‡´æ€§
LOCAL_HASH=$(md5 -q $LOCAL_FILE)
REMOTE_HASH=$(ssh root@$SERVER_IP "md5sum $PROJECT_DIR/$REMOTE_FILE | cut -d' ' -f1")

if [ "$LOCAL_HASH" != "$REMOTE_HASH" ]; then
    echo "âŒ æ–‡ä»¶ä¸€è‡´æ€§éªŒè¯å¤±è´¥"
    exit 1
fi

echo "âœ… æ–‡ä»¶ä¸€è‡´æ€§éªŒè¯é€šè¿‡"

# è§¦å‘çƒ­æ›´æ–°
curl -X POST http://$SERVER_IP:8001/api/v1/hot-reload/check
EOF

chmod +x /tmp/quick_deploy.sh

# 2.2 éƒ¨ç½²æ–‡ä»¶
/tmp/quick_deploy.sh local_frontend/fortune.html local_frontend/fortune.html
```

#### æ­¥éª¤ 3ï¼šéªŒè¯éƒ¨ç½²æˆåŠŸ

```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://8.210.52.217:8001/health

# æ£€æŸ¥åŠŸèƒ½
curl http://8.210.52.217/fortune.html
```

#### æ­¥éª¤ 4ï¼šç«‹å³æäº¤åˆ°GitHubï¼ˆç¡®ä¿ä»£ç ä¸€è‡´æ€§ï¼‰

```bash
# 4.1 æäº¤ä¿®æ”¹
git add local_frontend/fortune.html
git commit -m "fix: ä¿®å¤é¦–é¡µ404é”™è¯¯ï¼ˆç´§æ€¥ä¿®å¤ï¼‰"

# 4.2 æ¨é€åˆ°GitHub
git push origin master
```

#### æ­¥éª¤ 5ï¼šæœåŠ¡å™¨æ‹‰å–GitHubä»£ç ï¼ˆç¡®ä¿æœ€ç»ˆä¸€è‡´ï¼‰

```bash
# 5.1 åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–GitHubä»£ç 
ssh root@8.210.52.217 "cd /opt/HiFate-bazi && git pull origin master"

# 5.2 éªŒè¯æœåŠ¡å™¨ä»£ç ä¸GitHubä¸€è‡´
SERVER_COMMIT=$(ssh root@8.210.52.217 "cd /opt/HiFate-bazi && git rev-parse HEAD")
LOCAL_COMMIT=$(git rev-parse HEAD)

if [ "$SERVER_COMMIT" != "$LOCAL_COMMIT" ]; then
    echo "âŒ ä»£ç ä¸€è‡´æ€§éªŒè¯å¤±è´¥"
    exit 1
fi

echo "âœ… ä»£ç ä¸€è‡´æ€§éªŒè¯é€šè¿‡"
```

**å¿«é€Ÿä¿®å¤æµç¨‹æ£€æŸ¥æ¸…å•**ï¼š

- [ ] æœ¬åœ°ä»£ç ä¸æœåŠ¡å™¨ä»£ç ä¸€è‡´ï¼ˆæ­¥éª¤1.1ï¼‰
- [ ] æ–‡ä»¶ä¸€è‡´æ€§éªŒè¯é€šè¿‡ï¼ˆæ­¥éª¤2.2ï¼‰
- [ ] éƒ¨ç½²ååŠŸèƒ½éªŒè¯é€šè¿‡ï¼ˆæ­¥éª¤3ï¼‰
- [ ] å·²æäº¤åˆ°GitHubï¼ˆæ­¥éª¤4ï¼‰
- [ ] æœåŠ¡å™¨ä»£ç ä¸GitHubä¸€è‡´ï¼ˆæ­¥éª¤5.2ï¼‰

**é‡è¦æé†’**ï¼š

âš ï¸ **å¿«é€Ÿä¿®å¤æµç¨‹ä»…ç”¨äºç´§æ€¥æƒ…å†µ**ï¼Œæ ‡å‡†æµç¨‹ä»ç„¶æ˜¯æ¨èæ–¹å¼ï¼

âš ï¸ **å³ä½¿ä½¿ç”¨å¿«é€Ÿä¿®å¤æµç¨‹ï¼Œä¹Ÿå¿…é¡»ç¡®ä¿ä»£ç ä¸€è‡´æ€§**ï¼š
- éƒ¨ç½²å‰éªŒè¯æœ¬åœ°ä»£ç ä¸æœåŠ¡å™¨ä»£ç ä¸€è‡´
- éƒ¨ç½²åç«‹å³æäº¤åˆ°GitHub
- æœåŠ¡å™¨æœ€ç»ˆå¿…é¡»ä¸GitHubä»£ç ä¸€è‡´

---

### ğŸ“‹ ä»£ç ä¸€è‡´æ€§æ£€æŸ¥å·¥å…·

**åˆ›å»ºä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬**ï¼š

```bash
# scripts/check_code_consistency.sh
#!/bin/bash
# æ£€æŸ¥æœ¬åœ°ã€GitHubã€æœåŠ¡å™¨ä»£ç ä¸€è‡´æ€§

LOCAL_COMMIT=$(git rev-parse HEAD)
GITHUB_COMMIT=$(git ls-remote origin master | cut -f1)
SERVER_COMMIT=$(ssh root@8.210.52.217 "cd /opt/HiFate-bazi && git rev-parse HEAD" 2>/dev/null || echo "æ— æ³•è·å–")

echo "ä»£ç ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥ï¼š"
echo "  æœ¬åœ°:  $LOCAL_COMMIT"
echo "  GitHub: $GITHUB_COMMIT"
echo "  æœåŠ¡å™¨: $SERVER_COMMIT"

if [ "$LOCAL_COMMIT" = "$GITHUB_COMMIT" ] && [ "$GITHUB_COMMIT" = "$SERVER_COMMIT" ]; then
    echo "âœ… ä»£ç ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"
    exit 0
else
    echo "âŒ ä»£ç ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥"
    exit 1
fi
```

### 1. æœ€å°å½±å“åŸåˆ™ ã€æœ€é‡è¦ã€‘
- **åšå†³ä¸å¯æ”¹åŠ¨ä¸ä¹‹æ— å…³çš„ä»£ç **
- ä¿®æ”¹ä¼šå¼•èµ·å…¶ä»–åŠŸèƒ½å˜åŒ–æ—¶ï¼Œ**å¿…é¡»å…ˆå’¨è¯¢ç”¨æˆ·**
- æ¯æ¬¡ä¿®æ”¹å‰æ˜ç¡®å½±å“èŒƒå›´ï¼ˆä½/ä¸­/é«˜ï¼‰
- é«˜å½±å“ä¿®æ”¹å¿…é¡»ç”¨æˆ·ç¡®è®¤

### 1.1 Token èŠ‚çœåŸåˆ™ ã€å¿…é¡»éµå®ˆã€‘
- **åªè¯»å–å’Œæ“ä½œä¸å½“å‰ä»»åŠ¡ç›´æ¥ç›¸å…³çš„æ–‡ä»¶**
- **ç¦æ­¢è¯»å–ä¸ç›¸å…³çš„ä¿¡æ¯ã€ç¨‹åºã€æ–‡æ¡£**
- **ç¦æ­¢è¯»å–æ•´ä¸ªæ–‡ä»¶ï¼Œåªè¯»å–éœ€è¦çš„éƒ¨åˆ†**
- **ä½¿ç”¨ `offset` å’Œ `limit` å‚æ•°é™åˆ¶è¯»å–èŒƒå›´**
- **ä½¿ç”¨ `grep` æˆ– `codebase_search` ç²¾ç¡®å®šä½ï¼Œè€Œä¸æ˜¯å…¨æ–‡ä»¶è¯»å–**
- **é¿å…è¯»å–å¤§å‹æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶ã€æµ‹è¯•æ–‡ä»¶ï¼ˆé™¤éæ˜ç¡®éœ€è¦ï¼‰**
- **ç¦æ­¢è¯»å–ä¸ç›¸å…³çš„ç›®å½•å’Œå­ç›®å½•**

### 2. gRPC ä¼˜å…ˆåŸåˆ™ ã€æ¶æ„åŸºç¡€ã€‘
- **æ‰€æœ‰æœåŠ¡é—´äº¤äº’å¿…é¡»ä½¿ç”¨ gRPC**
- **å‰ç«¯ä¸åç«¯äº¤äº’é€šè¿‡ gRPC-Web ç½‘å…³**
- REST API ä»…ä½œä¸ºå…¼å®¹å±‚ï¼Œæ–°åŠŸèƒ½å¿…é¡»åŒæ—¶æ³¨å†Œ gRPC ç«¯ç‚¹

### ğŸ”´ 3. æ–°åŠŸèƒ½å¼€å‘å¼ºåˆ¶è§„èŒƒ ã€æœ€é«˜ä¼˜å…ˆçº§ã€‘

> **æ‰€æœ‰æ–°åŠŸèƒ½çš„å¢åŠ ã€ä¿®æ”¹ã€æ‰©å±•éƒ½å¿…é¡»ä¸¥æ ¼éµå®ˆæœ¬å¼€å‘è§„èŒƒï¼Œè¿™æ˜¯ç³»ç»Ÿç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§çš„åŸºç¡€ã€‚**

#### 3.1 å¼ºåˆ¶éµå®ˆåŸåˆ™

**æ ¸å¿ƒè¦æ±‚**ï¼š
- âœ… **æ‰€æœ‰æ–°åŠŸèƒ½å¼€å‘å‰å¿…é¡»é˜…è¯»å¹¶ç†è§£æœ¬å¼€å‘è§„èŒƒ**
- âœ… **æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»é€šè¿‡å¼€å‘è§„èŒƒæ£€æŸ¥æ¸…å•éªŒè¯**
- âœ… **è¿åè§„èŒƒçš„ä»£ç å°†è¢«è¦æ±‚é‡æ„ï¼Œä¸å¾—åˆå¹¶åˆ°ä¸»åˆ†æ”¯**
- âœ… **è§„èŒƒæ›´æ–°æ—¶ï¼Œæ‰€æœ‰ç›¸å…³ä»£ç å¿…é¡»åŒæ­¥æ›´æ–°**

#### 3.2 æ–°åŠŸèƒ½å¼€å‘æµç¨‹

**æ ‡å‡†æµç¨‹**ï¼š
```
1. éœ€æ±‚åˆ†æ
   â”œâ”€â”€ æ˜ç¡®åŠŸèƒ½éœ€æ±‚
   â”œâ”€â”€ è¯„ä¼°å½±å“èŒƒå›´ï¼ˆä½/ä¸­/é«˜ï¼‰
   â””â”€â”€ è¯†åˆ«éœ€è¦éµå®ˆçš„è§„èŒƒç« èŠ‚
   â†“
2. è§„èŒƒæ£€æŸ¥
   â”œâ”€â”€ é˜…è¯»ç›¸å…³è§„èŒƒç« èŠ‚
   â”œâ”€â”€ ç¡®è®¤æ¶æ„è®¾è®¡ç¬¦åˆè§„èŒƒ
   â””â”€â”€ å‡†å¤‡å¼€å‘è§„èŒƒæ£€æŸ¥æ¸…å•
   â†“
3. å¼€å‘å®ç°
   â”œâ”€â”€ æŒ‰ç…§è§„èŒƒç¼–å†™ä»£ç 
   â”œâ”€â”€ åŒæ­¥ç¼–å†™æµ‹è¯•æ¡ˆä¾‹
   â””â”€â”€ è®°å½•å¼€å‘æ—¥å¿—
   â†“
4. è§„èŒƒéªŒè¯
   â”œâ”€â”€ è¿è¡Œå¼€å‘è§„èŒƒæ£€æŸ¥æ¸…å•
   â”œâ”€â”€ éªŒè¯æ‰€æœ‰æ£€æŸ¥é¡¹é€šè¿‡
   â””â”€â”€ ä¿®å¤ä¸ç¬¦åˆè§„èŒƒçš„ä»£ç 
   â†“
5. ä»£ç å®¡æŸ¥
   â”œâ”€â”€ æ£€æŸ¥æ˜¯å¦ç¬¦åˆè§„èŒƒ
   â”œâ”€â”€ éªŒè¯æµ‹è¯•è¦†ç›–ç‡
   â””â”€â”€ ç¡®è®¤æ–‡æ¡£å·²æ›´æ–°
   â†“
6. åˆå¹¶ä»£ç 
   â”œâ”€â”€ æ‰€æœ‰æ£€æŸ¥é€šè¿‡
   â”œâ”€â”€ æµ‹è¯•å…¨éƒ¨é€šè¿‡
   â””â”€â”€ æ–‡æ¡£å·²åŒæ­¥æ›´æ–°
```

#### 3.3 å¼€å‘è§„èŒƒæ£€æŸ¥æ¸…å•

**æ¯æ¬¡å¼€å‘æ–°åŠŸèƒ½æ—¶ï¼Œå¿…é¡»å®Œæˆä»¥ä¸‹æ£€æŸ¥**ï¼š

##### æ¶æ„è®¾è®¡æ£€æŸ¥
- [ ] æ˜¯å¦éµå¾ª gRPC ä¼˜å…ˆåŸåˆ™ï¼ˆæœåŠ¡é—´äº¤äº’ä½¿ç”¨ gRPCï¼‰
- [ ] æ˜¯å¦åœ¨ `grpc_gateway.py` ä¸­æ³¨å†Œäº† gRPC ç«¯ç‚¹
- [ ] æ˜¯å¦éµå¾ªé›¶åœæœºåŸåˆ™ï¼ˆæ”¯æŒçƒ­æ›´æ–°ï¼‰
- [ ] æ˜¯å¦è€ƒè™‘äº†è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»

##### ä»£ç è§„èŒƒæ£€æŸ¥
- [ ] æ˜¯å¦ä½¿ç”¨ Pydantic æ¨¡å‹å®šä¹‰è¯·æ±‚/å“åº”
- [ ] æ˜¯å¦ä½¿ç”¨ `Field` æä¾›å­—æ®µæè¿°å’Œç¤ºä¾‹
- [ ] æ˜¯å¦ä½¿ç”¨ `@validator` éªŒè¯å…³é”®å­—æ®µ
- [ ] æ˜¯å¦éµå¾ª JSON åºåˆ—åŒ–è§„èŒƒï¼ˆ`ensure_ascii=False`ï¼‰
- [ ] æ˜¯å¦ä½¿ç”¨ `DataValidator` è¿›è¡Œæ•°æ®éªŒè¯

##### å®‰å…¨è§„èŒƒæ£€æŸ¥
- [ ] æ˜¯å¦éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥
- [ ] æ˜¯å¦ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆé˜²æ­¢ SQL æ³¨å…¥ï¼‰
- [ ] æ˜¯å¦å¯¹è¾“å‡ºè¿›è¡Œç¼–ç ï¼ˆé˜²æ­¢ XSSï¼‰
- [ ] æ˜¯å¦æ£€æŸ¥ç”¨æˆ·æƒé™ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] æ˜¯å¦ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯

##### æ€§èƒ½è§„èŒƒæ£€æŸ¥
- [ ] æ˜¯å¦è®°å½•æ€§èƒ½ç›‘æ§ï¼ˆä½¿ç”¨ `PerformanceMonitor`ï¼‰
- [ ] æ˜¯å¦ä¼˜åŒ–äº†æ•°æ®åº“æŸ¥è¯¢ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
- [ ] æ˜¯å¦è€ƒè™‘äº†ç¼“å­˜ç­–ç•¥
- [ ] æ˜¯å¦é¿å…äº† N+1 æŸ¥è¯¢é—®é¢˜

##### æµ‹è¯•è§„èŒƒæ£€æŸ¥
- [ ] æ˜¯å¦ç¼–å†™äº†å•å…ƒæµ‹è¯•
- [ ] æ˜¯å¦ç¼–å†™äº†é›†æˆæµ‹è¯•
- [ ] æ˜¯å¦ç¼–å†™äº† API æµ‹è¯•
- [ ] æµ‹è¯•è¦†ç›–ç‡æ˜¯å¦ â‰¥ 50%
- [ ] æ‰€æœ‰æµ‹è¯•æ˜¯å¦é€šè¿‡

##### æ–‡æ¡£è§„èŒƒæ£€æŸ¥
- [ ] æ˜¯å¦æ›´æ–°äº† API æ–‡æ¡£
- [ ] æ˜¯å¦æ›´æ–°äº†æ¶æ„æ–‡æ¡£ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] æ˜¯å¦æ›´æ–°äº†éƒ¨ç½²æ–‡æ¡£ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] æ˜¯å¦æ·»åŠ äº†ä»£ç æ³¨é‡Š

##### è§„åˆ™å¼€å‘æ£€æŸ¥ï¼ˆå¦‚æ¶‰åŠè§„åˆ™ï¼‰
- [ ] è§„åˆ™æ˜¯å¦å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼ˆç¦æ­¢ä»æ–‡ä»¶è¯»å–ï¼‰
- [ ] æ˜¯å¦ä½¿ç”¨ `RuleService` åŒ¹é…è§„åˆ™
- [ ] è§„åˆ™æ¡ä»¶æ ¼å¼æ˜¯å¦ç¬¦åˆ JSON è§„èŒƒ
- [ ] æ˜¯å¦æ›´æ–°äº†å‰åç«¯ç±»å‹æ˜ å°„

##### A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒæ£€æŸ¥ï¼ˆé‡è¦åŠŸèƒ½ï¼‰
- [ ] æ˜¯å¦åˆ›å»ºäº†åŠŸèƒ½å¼€å…³
- [ ] æ˜¯å¦æ”¯æŒ A/B æµ‹è¯•
- [ ] æ˜¯å¦å‡†å¤‡äº†å›æ»šæ–¹æ¡ˆ
- [ ] æ˜¯å¦å‡†å¤‡äº†æ•°æ®åº“å›æ»šè„šæœ¬ï¼ˆå¦‚æ¶‰åŠæ•°æ®åº“å˜æ›´ï¼‰

##### æ„å›¾è¯†åˆ«æ£€æŸ¥ï¼ˆå¦‚æ¶‰åŠæ„å›¾è¯†åˆ«ï¼‰
- [ ] æ˜¯å¦ä½¿ç”¨æ··åˆæ¶æ„
- [ ] å“åº”æ—¶é—´æ˜¯å¦ < 1ç§’
- [ ] æ˜¯å¦ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹/å…³é”®è¯è¿‡æ»¤
- [ ] LLM æ˜¯å¦ä»…ä½œä¸ºå…œåº•

#### 3.4 è§„èŒƒè¿åå¤„ç†

**å¦‚æœå‘ç°è¿åå¼€å‘è§„èŒƒ**ï¼š

1. **ç«‹å³åœæ­¢å¼€å‘**
   - åœæ­¢å½“å‰å¼€å‘å·¥ä½œ
   - é˜…è¯»ç›¸å…³è§„èŒƒç« èŠ‚
   - ç†è§£è§„èŒƒè¦æ±‚

2. **ä¿®å¤é—®é¢˜**
   - æŒ‰ç…§è§„èŒƒé‡æ„ä»£ç 
   - æ›´æ–°ç›¸å…³æ–‡æ¡£
   - è¡¥å……ç¼ºå¤±çš„æµ‹è¯•

3. **é‡æ–°éªŒè¯**
   - è¿è¡Œå¼€å‘è§„èŒƒæ£€æŸ¥æ¸…å•
   - ç¡®ä¿æ‰€æœ‰æ£€æŸ¥é¡¹é€šè¿‡
   - é‡æ–°è¿›è¡Œä»£ç å®¡æŸ¥

4. **è®°å½•é—®é¢˜**
   - è®°å½•è¿åçš„è§„èŒƒç« èŠ‚
   - åˆ†æè¿ååŸå› 
   - æ›´æ–°å¼€å‘è§„èŒƒï¼ˆå¦‚éœ€è¦ï¼‰

**ç¦æ­¢æ“ä½œ**ï¼š
- âŒ ç¦æ­¢ç»•è¿‡è§„èŒƒæ£€æŸ¥
- âŒ ç¦æ­¢åˆå¹¶ä¸ç¬¦åˆè§„èŒƒçš„ä»£ç 
- âŒ ç¦æ­¢é™ä½è§„èŒƒè¦æ±‚
- âŒ ç¦æ­¢è·³è¿‡æµ‹è¯•

#### 3.5 è§„èŒƒæ›´æ–°æœºåˆ¶

**å½“è§„èŒƒæ›´æ–°æ—¶**ï¼š

1. **é€šçŸ¥æœºåˆ¶**
   - åœ¨è§„èŒƒé¡¶éƒ¨æ ‡è®°æ›´æ–°æ—¥æœŸ
   - åœ¨ç›¸å…³ç« èŠ‚æ ‡è®°å˜æ›´å†…å®¹
   - é€šçŸ¥æ‰€æœ‰å¼€å‘è€…

2. **ä»£ç å®¡æŸ¥**
   - æ£€æŸ¥ç°æœ‰ä»£ç æ˜¯å¦ç¬¦åˆæ–°è§„èŒƒ
   - è¯†åˆ«éœ€è¦æ›´æ–°çš„ä»£ç 
   - åˆ¶å®šæ›´æ–°è®¡åˆ’

3. **é€æ­¥è¿ç§»**
   - æ–°åŠŸèƒ½å¿…é¡»ç¬¦åˆæ–°è§„èŒƒ
   - æ—§åŠŸèƒ½é€æ­¥è¿ç§»åˆ°æ–°è§„èŒƒ
   - è®°å½•è¿ç§»è¿›åº¦

#### 3.6 è§„èŒƒå­¦ä¹ èµ„æº

**æ–°å¼€å‘è€…å¿…é¡»å­¦ä¹ **ï¼š
1. **æ ¸å¿ƒåŸåˆ™**ï¼ˆç¬¬ 30-64 è¡Œï¼‰
2. **gRPC äº¤äº’è§„èŒƒ**ï¼ˆç¬¬ 67-185 è¡Œï¼‰
3. **gRPC åè®®ä¸åºåˆ—åŒ–è§„èŒƒ**ï¼ˆç¬¬ 188-542 è¡Œï¼‰
4. **è§„åˆ™å¼€å‘è§„èŒƒ**ï¼ˆç¬¬ 545-1069 è¡Œï¼‰
5. **å®‰å…¨è§„èŒƒ**ï¼ˆç¬¬ 1370-1889 è¡Œï¼‰
6. **A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒè§„èŒƒ**ï¼ˆç¬¬ 2266-2595 è¡Œï¼‰
7. **æµ‹è¯•å¼€å‘è§„èŒƒ**ï¼ˆç¬¬ 2966-3273 è¡Œï¼‰

**å®šæœŸå¤ä¹ **ï¼š
- æ¯æœˆå¤ä¹ ä¸€æ¬¡å¼€å‘è§„èŒƒ
- é‡åˆ°é—®é¢˜æ—¶æŸ¥é˜…ç›¸å…³ç« èŠ‚
- è§„èŒƒæ›´æ–°æ—¶åŠæ—¶å­¦ä¹ 

---

## ğŸ”Œ gRPC äº¤äº’è§„èŒƒ ã€é‡è¦ã€‘

## ğŸ”Œ gRPC äº¤äº’è§„èŒƒ ã€é‡è¦ã€‘

### æ¶æ„æ¦‚è§ˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    gRPC-Web     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     gRPC      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  Web æœåŠ¡      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  å¾®æœåŠ¡     â”‚
â”‚  (Browser)  â”‚                 â”‚  (Port 8001)   â”‚               â”‚ (9001-9010) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                â”‚                                â”‚
      â”‚                                â†“                                â”‚
      â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
      â”‚                         â”‚   MySQL     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                         â”‚   Redis     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‰ç«¯è°ƒç”¨è§„èŒƒ
```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ gRPC-Web ç½‘å…³
const result = await api.post('/bazi/formula-analysis', {
    solar_date: '2025-01-15',
    solar_time: '12:00',
    gender: 'male'
});

// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ REST API
const result = await fetch('/api/v1/bazi/formula-analysis', {...});
```

### ğŸ”´ å‰ç«¯é”™è¯¯å¤„ç†è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

#### 1. é”™è¯¯å¤„ç†å¿…é¡»æ˜¾ç¤ºUIåŒºåŸŸ

**è¦æ±‚**ï¼š
- æ‰€æœ‰é”™è¯¯å¤„ç†å‡½æ•°å¿…é¡»åŒæ—¶æ›´æ–°å†…å®¹å’Œæ˜¾ç¤ºçŠ¶æ€
- å¦‚æœUIåŒºåŸŸåˆå§‹ä¸º `display:none`ï¼Œé”™è¯¯å¤„ç†æ—¶å¿…é¡»æ˜¾ç¤º

**é”™è¯¯ç¤ºä¾‹**ï¼š
```javascript
// âŒ é”™è¯¯ï¼šåªæ›´æ–°å†…å®¹ï¼Œä¸æ˜¾ç¤ºåŒºåŸŸ
function displayError(message) {
    const content = document.getElementById('content');
    content.innerHTML = `<div class="error">${message}</div>`;
    // ç¼ºå°‘ï¼šsection.style.display = 'block';
}
```

**æ­£ç¡®ç¤ºä¾‹**ï¼š
```javascript
// âœ… æ­£ç¡®ï¼šåŒæ—¶æ›´æ–°å†…å®¹å’Œæ˜¾ç¤ºçŠ¶æ€
function displayError(message) {
    const section = document.getElementById('section');
    const content = document.getElementById('content');
    
    section.style.display = 'block';  // æ˜¾ç¤ºåŒºåŸŸ
    content.innerHTML = `<div class="error">${message}</div>`;
    section.scrollIntoView({ behavior: 'smooth' });  // æ»šåŠ¨åˆ°é”™è¯¯åŒºåŸŸ
}
```

#### 2. å…³é”®é˜¶æ®µæå‰æ˜¾ç¤ºUIåŒºåŸŸ

**è¦æ±‚**ï¼š
- åœ¨è¿›å…¥å…³é”®å¤„ç†é˜¶æ®µæ—¶ï¼Œæå‰æ˜¾ç¤ºç›¸å…³UIåŒºåŸŸ
- ç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°å¤„ç†è¿›åº¦å’Œç»“æœ

**ç¤ºä¾‹**ï¼š
```javascript
eventSource.addEventListener('status', function(e) {
    const data = JSON.parse(e.data);
    updateProgress(data.stage, data.message);
    
    // â­ å½“è¿›å…¥å…³é”®é˜¶æ®µæ—¶ï¼Œæå‰æ˜¾ç¤ºç›¸å…³UIåŒºåŸŸ
    if (data.stage === 'llm') {
        document.getElementById('llmAnalysisSection').style.display = 'block';
    }
});
```

#### 3. é”™è¯¯å¤„ç†ä¸æ­£å¸¸æµç¨‹ä¿æŒä¸€è‡´

**è¦æ±‚**ï¼š
- é”™è¯¯å¤„ç†å‡½æ•°çš„UIæ“ä½œå¿…é¡»ä¸æ­£å¸¸æµç¨‹å‡½æ•°ä¸€è‡´
- ç¡®ä¿é”™è¯¯åœºæ™¯ä¸‹ç”¨æˆ·ä½“éªŒä¸ä¸­æ–­

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] é”™è¯¯å¤„ç†å‡½æ•°æ˜¯å¦æ˜¾ç¤ºç›¸å…³UIåŒºåŸŸ
- [ ] æ˜¯å¦åœ¨å…³é”®é˜¶æ®µæå‰æ˜¾ç¤ºUIåŒºåŸŸ
- [ ] é”™è¯¯å¤„ç†é€»è¾‘æ˜¯å¦ä¸æ­£å¸¸æµç¨‹ä¸€è‡´
- [ ] æ˜¯å¦æ·»åŠ äº†ç”¨æˆ·å¯è§çš„é”™è¯¯æç¤º
- [ ] æ˜¯å¦æµ‹è¯•äº†æ‰€æœ‰é”™è¯¯åœºæ™¯

**ç›¸å…³å¤ç›˜**ï¼šè§ `docs/é—®é¢˜å¤ç›˜-AIæ·±åº¦è§£è¯»åŒºåŸŸä¸æ˜¾ç¤º.md`

### åç«¯æ³¨å†Œè§„èŒƒ
```python
# 1. åœ¨ server/api/v1/ ä¸‹åˆ›å»º REST API
@router.post("/bazi/new-feature")
async def new_feature(request: NewFeatureRequest):
    ...

# 2. åœ¨ server/api/grpc_gateway.py æ³¨å†Œ gRPC ç«¯ç‚¹ï¼ˆå¿…é¡»ï¼ï¼‰
@_register("/bazi/new-feature")
async def _handle_new_feature(payload: Dict[str, Any]):
    request_model = NewFeatureRequest(**payload)
    return await new_feature(request_model)
```

### æœåŠ¡é—´è°ƒç”¨è§„èŒƒ
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ gRPC å®¢æˆ·ç«¯
from src.clients.bazi_core_client_grpc import BaziCoreClientGrpc
result = BaziCoreClientGrpc.calculate_bazi(...)

# âŒ é”™è¯¯ï¼šç›´æ¥ HTTP è°ƒç”¨
import requests
result = requests.get('http://localhost:9001/api/...')
```

---

## ğŸ“‹ gRPC åè®®ä¸åºåˆ—åŒ–è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

### ğŸ”´ æ ¸å¿ƒåŸåˆ™

> **æ‰€æœ‰ gRPC åè®®å¼€å‘ã€æ¥å£æœåŠ¡å¼€å‘ã€åºåˆ—åŒ–/ååºåˆ—åŒ–å¿…é¡»éµå¾ªç»Ÿä¸€è§„èŒƒï¼Œç¦æ­¢è‡ªä½œä¸»å¼ å„è‡ªä¸ºæ”¿ã€‚**

---

### 1. gRPC Protocol Buffers å®šä¹‰è§„èŒƒ

#### 1.1 Proto æ–‡ä»¶å‘½åè§„èŒƒ

**æ–‡ä»¶å‘½å**ï¼š
- ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼š`bazi_core.proto`ã€`bazi_fortune.proto`
- æ–‡ä»¶ååº”åæ˜ æœåŠ¡åŠŸèƒ½

#### 1.2 Proto æ–‡ä»¶è¯­æ³•è§„èŒƒ

```protobuf
syntax = "proto3";  // å¿…é¡»ä½¿ç”¨ proto3

package bazi.core;  // åŒ…åæ ¼å¼ï¼šåŠŸèƒ½.å­åŠŸèƒ½

// æœåŠ¡æè¿°æ³¨é‡Š
// Bazi Core Service - å…«å­—æ’ç›˜æ ¸å¿ƒè®¡ç®—æœåŠ¡
```

#### 1.3 æ¶ˆæ¯å®šä¹‰è§„èŒƒ

```protobuf
// è¯·æ±‚æ¶ˆæ¯å‘½åï¼šServiceName + Request
message BaziCoreRequest {
  string solar_date = 1;  // å­—æ®µå¿…é¡»æœ‰æ³¨é‡Š
  string solar_time = 2;
  string gender = 3;
}

// å“åº”æ¶ˆæ¯å‘½åï¼šServiceName + Response
message BaziCoreResponse {
  map<string, string> basic_info = 1;  // ç®€å•é”®å€¼å¯¹ä½¿ç”¨ map
  string metadata_json = 2;             // å¤æ‚ç»“æ„ä½¿ç”¨ JSON å­—ç¬¦ä¸²
}
```

#### 1.4 å­—æ®µç±»å‹ä½¿ç”¨è§„èŒƒ

| æ•°æ®ç±»å‹ | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|---------|---------|------|
| `string` | æ–‡æœ¬æ•°æ® | `solar_date`, `gender` |
| `int32` | æ•´æ•° | `element_counts` |
| `map<string, string>` | ç®€å•é”®å€¼å¯¹ | `basic_info` |
| `map<string, int32>` | è®¡æ•°ç»Ÿè®¡ | `element_counts` |
| `repeated string` | å­—ç¬¦ä¸²åˆ—è¡¨ | `rule_types` |
| `string` (JSON) | **å¤æ‚åµŒå¥—ç»“æ„** | `metadata_json`, `detail_json` |
| è‡ªå®šä¹‰ `message` | å›ºå®šç»“æ„ | `Pillar`, `PillarDetail` |

**é‡è¦åŸåˆ™**ï¼š
- âœ… **å¤æ‚åµŒå¥—ç»“æ„å¿…é¡»ä½¿ç”¨ `string` å­—æ®µå­˜å‚¨ JSON å­—ç¬¦ä¸²**
- âœ… ç®€å•ç»“æ„ä¼˜å…ˆä½¿ç”¨ protobuf åŸç”Ÿç±»å‹
- âŒ ç¦æ­¢åœ¨ proto ä¸­å®šä¹‰æ·±åº¦åµŒå¥—çš„ message

#### 1.5 æœåŠ¡å®šä¹‰è§„èŒƒ

```protobuf
service BaziCoreService {
  // æ–¹æ³•å‘½åï¼šåŠ¨è¯ + åè¯ï¼Œé©¼å³°å‘½å
  rpc CalculateBazi(BaziCoreRequest) returns (BaziCoreResponse);
  
  // æ‰€æœ‰æœåŠ¡å¿…é¡»æä¾›å¥åº·æ£€æŸ¥
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}
```

**å¥åº·æ£€æŸ¥æ ‡å‡†**ï¼š
```protobuf
message HealthCheckRequest {}
message HealthCheckResponse {
  string status = 1;  // é€šå¸¸ä¸º "ok"
}
```

---

### 2. API æ¥å£æœåŠ¡è§„èŒƒ

#### 2.1 è¯·æ±‚æ¨¡å‹è§„èŒƒï¼ˆPydanticï¼‰

```python
from pydantic import BaseModel, Field, validator

class BaziRequest(BaseModel):
    """å…«å­—è®¡ç®—è¯·æ±‚æ¨¡å‹"""
    solar_date: str = Field(..., description="é˜³å†æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD", example="1990-05-15")
    solar_time: str = Field(..., description="å‡ºç”Ÿæ—¶é—´ï¼Œæ ¼å¼ï¼šHH:MM", example="14:30")
    gender: str = Field(..., description="æ€§åˆ«ï¼šmale(ç”·) æˆ– female(å¥³)", example="male")
    
    @validator('solar_date')
    def validate_date(cls, v):
        """éªŒè¯æ—¥æœŸæ ¼å¼"""
        try:
            from datetime import datetime
            datetime.strptime(v, '%Y-%m-%d')
        except ValueError:
            raise ValueError('æ—¥æœŸæ ¼å¼é”™è¯¯ï¼Œåº”ä¸º YYYY-MM-DD')
        return v
    
    @validator('gender')
    def validate_gender(cls, v):
        """éªŒè¯æ€§åˆ«"""
        if v not in ['male', 'female']:
            raise ValueError('æ€§åˆ«å¿…é¡»ä¸º male æˆ– female')
        return v
```

**è§„èŒƒè¦æ±‚**ï¼š
- âœ… æ‰€æœ‰å­—æ®µå¿…é¡»ä½¿ç”¨ `Field` æä¾› `description` å’Œ `example`
- âœ… å¿…é¡»ä½¿ç”¨ `@validator` éªŒè¯å…³é”®å­—æ®µ
- âœ… æ¨¡å‹ç±»å¿…é¡»æœ‰æ–‡æ¡£å­—ç¬¦ä¸²

#### 2.2 å“åº”æ¨¡å‹è§„èŒƒ

```python
class BaziResponse(BaseModel):
    """å…«å­—è®¡ç®—å“åº”æ¨¡å‹"""
    success: bool  # å¿…é¡»åŒ…å« success å­—æ®µ
    data: Optional[dict] = None
    message: Optional[str] = None
    error: Optional[str] = None  # é”™è¯¯ä¿¡æ¯
```

**è§„èŒƒè¦æ±‚**ï¼š
- âœ… å“åº”æ¨¡å‹å¿…é¡»åŒ…å« `success: bool`
- âœ… æˆåŠŸæ—¶è¿”å› `data`ï¼Œå¤±è´¥æ—¶è¿”å› `error`
- âœ… æ‰€æœ‰å¯é€‰å­—æ®µä½¿ç”¨ `Optional[...] = None`

#### 2.3 gRPC ç½‘å…³æ³¨å†Œè§„èŒƒ

**æ³¨å†Œæµç¨‹**ï¼š
```python
# 1. åœ¨ server/api/grpc_gateway.py ä¸­å¯¼å…¥
from server.api.v1.bazi import BaziRequest, BaziResponse, calculate_bazi

# 2. ä½¿ç”¨ @_register è£…é¥°å™¨æ³¨å†Œ
@_register("/bazi/calculate")
async def _handle_bazi_calculate(payload: Dict[str, Any]):
    """å¤„ç†å…«å­—è®¡ç®—è¯·æ±‚"""
    # 3. è½¬æ¢ä¸º Pydantic æ¨¡å‹
    request_model = BaziRequest(**payload)
    
    # 4. è°ƒç”¨åŸå§‹ API å‡½æ•°
    return await calculate_bazi(request_model)
```

**æ¥å£è·¯å¾„è§„èŒƒ**ï¼š
- æ ¼å¼ï¼š`/åŠŸèƒ½æ¨¡å—/æ“ä½œ`
- ç¤ºä¾‹ï¼š
  - `/bazi/calculate` - è®¡ç®—å…«å­—
  - `/bazi/formula-analysis` - å…¬å¼åˆ†æ
  - `/bazi/shengong-minggong` - èº«å®«å‘½å®«
  - `/payment/create-session` - åˆ›å»ºæ”¯ä»˜ä¼šè¯

**è§„èŒƒè¦æ±‚**ï¼š
- âœ… æ‰€æœ‰ API ç«¯ç‚¹å¿…é¡»åœ¨ `grpc_gateway.py` ä¸­æ³¨å†Œ
- âœ… æ³¨å†Œå‡½æ•°å¿…é¡»ä½¿ç”¨ `@_register` è£…é¥°å™¨
- âœ… å‡½æ•°åæ ¼å¼ï¼š`_handle_åŠŸèƒ½æ¨¡å—_æ“ä½œ`
- âœ… å¿…é¡»è½¬æ¢ä¸º Pydantic æ¨¡å‹åå†è°ƒç”¨

---

### 3. åºåˆ—åŒ–/ååºåˆ—åŒ–è§„èŒƒ

#### 3.1 æœåŠ¡ç«¯åºåˆ—åŒ–è§„èŒƒï¼ˆgRPC Serverï¼‰

**å­—å…¸åºåˆ—åŒ–**ï¼š
```python
# âœ… æ­£ç¡®ï¼šå¤æ‚å­—å…¸åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²
if isinstance(value, dict):
    response.metadata_json = json.dumps(value, ensure_ascii=False)
else:
    response.metadata_json = str(value)

# âœ… æ­£ç¡®ï¼šç®€å•é”®å€¼å¯¹ç›´æ¥ä½¿ç”¨ map
response.basic_info[key] = str(value)

# âŒ é”™è¯¯ï¼šä¸è¦ç›´æ¥å°†å­—å…¸èµ‹å€¼ç»™ string å­—æ®µ
response.metadata_json = value  # ä¼šå¯¼è‡´åºåˆ—åŒ–é”™è¯¯
```

**ç‰¹æ®Šå­—æ®µå¤„ç†**ï¼š
```python
# lunar_date æ˜¯å­—å…¸ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
if key == "lunar_date" and isinstance(value, dict):
    response.basic_info[key] = json.dumps(value, ensure_ascii=False)
else:
    response.basic_info[key] = str(value)
```

**JSON åºåˆ—åŒ–æ ‡å‡†**ï¼š
```python
import json

# âœ… å¿…é¡»ä½¿ç”¨ ensure_ascii=False æ”¯æŒä¸­æ–‡
json.dumps(data, ensure_ascii=False)

# âœ… å¤„ç†ä¸å¯åºåˆ—åŒ–å¯¹è±¡
json.dumps(data, ensure_ascii=False, default=str)
```

**è§„èŒƒè¦æ±‚**ï¼š
- âœ… æ‰€æœ‰å¤æ‚ç»“æ„å¿…é¡»ä½¿ç”¨ `json.dumps(ensure_ascii=False)` åºåˆ—åŒ–
- âœ… å¿…é¡»ä½¿ç”¨ `default=str` å¤„ç†ç‰¹æ®Šç±»å‹ï¼ˆdatetimeã€Decimal ç­‰ï¼‰
- âœ… å­—ç¬¦ä¸²ç±»å‹å­—æ®µåªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ï¼Œä¸èƒ½å­˜å‚¨å¯¹è±¡

#### 3.2 å®¢æˆ·ç«¯ååºåˆ—åŒ–è§„èŒƒï¼ˆgRPC Clientï¼‰

**JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–**ï¼š
```python
# âœ… æ­£ç¡®ï¼šå®‰å…¨åœ°ååºåˆ—åŒ– JSON å­—ç¬¦ä¸²
try:
    if isinstance(value_json, str):
        result = json.loads(value_json) if value_json else {}
    else:
        result = value_json
except (json.JSONDecodeError, TypeError):
    result = {}  # ä½¿ç”¨é»˜è®¤å€¼
```

**ç±»å‹éªŒè¯å’Œè½¬æ¢**ï¼š
```python
from server.utils.data_validator import DataValidator

# âœ… ä½¿ç”¨ DataValidator ç¡®ä¿ç±»å‹æ­£ç¡®
bazi_data = DataValidator.ensure_dict(bazi_data)
ten_gods = DataValidator.ensure_list(ten_gods)

# âœ… éªŒè¯å…«å­—æ•°æ®
bazi_data = DataValidator.validate_bazi_data(bazi_data)
```

**é˜²å¾¡æ€§ç¼–ç¨‹**ï¼š
```python
# âœ… æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
if response.basic_info:
    for key, value in response.basic_info.items():
        # å®‰å…¨åœ°å¤„ç†æ¯ä¸ªå­—æ®µ
        if key == "lunar_date" and isinstance(value, str):
            try:
                parsed = json.loads(value) if value else {}
            except (json.JSONDecodeError, TypeError):
                parsed = {}
```

**è§„èŒƒè¦æ±‚**ï¼š
- âœ… æ‰€æœ‰ JSON ååºåˆ—åŒ–å¿…é¡»ä½¿ç”¨ try-except
- âœ… å¿…é¡»ä½¿ç”¨ `DataValidator` è¿›è¡Œç±»å‹éªŒè¯
- âœ… å¿…é¡»æä¾›é»˜è®¤å€¼ï¼Œé¿å… None å¯¼è‡´çš„é”™è¯¯

#### 3.3 æ•°æ®éªŒè¯è§„èŒƒ

**ä½¿ç”¨ DataValidator**ï¼š
```python
from server.utils.data_validator import (
    ensure_dict,
    ensure_list,
    validate_bazi_data,
    safe_get_nested
)

# âœ… ç¡®ä¿å­—å…¸ç±»å‹
data = ensure_dict(data, default={})

# âœ… ç¡®ä¿åˆ—è¡¨ç±»å‹
items = ensure_list(items, default=[])

# âœ… éªŒè¯å…«å­—æ•°æ®
bazi_data = validate_bazi_data(bazi_data)

# âœ… å®‰å…¨åœ°è·å–åµŒå¥—å€¼
stem = safe_get_nested(bazi_data, 'bazi_pillars', 'day', 'stem', default='')
```

**éªŒè¯æ—¶æœº**ï¼š
- âœ… gRPC å®¢æˆ·ç«¯æ¥æ”¶å“åº”åç«‹å³éªŒè¯
- âœ… API å‡½æ•°å¤„ç†æ•°æ®å‰éªŒè¯
- âœ… ç¼“å­˜æ•°æ®å‰éªŒè¯

---

### 4. å¼€å‘è§„èŒƒå¼ºåˆ¶è¦æ±‚

#### 4.1 gRPC åè®®å¼€å‘æ£€æŸ¥æ¸…å•

æ¯æ¬¡å¼€å‘ gRPC æœåŠ¡æ—¶å¿…é¡»æ£€æŸ¥ï¼š
- [ ] Proto æ–‡ä»¶å®šä¹‰æ˜¯å¦ç¬¦åˆå‘½åè§„èŒƒ
- [ ] æ¶ˆæ¯å®šä¹‰æ˜¯å¦æœ‰å®Œæ•´æ³¨é‡Š
- [ ] å¤æ‚ç»“æ„æ˜¯å¦ä½¿ç”¨ JSON å­—ç¬¦ä¸²å­—æ®µ
- [ ] æ˜¯å¦å®ç° `HealthCheck` æ–¹æ³•
- [ ] æœåŠ¡æ–¹æ³•å‘½åæ˜¯å¦ç¬¦åˆè§„èŒƒ

#### 4.2 API æ¥å£å¼€å‘æ£€æŸ¥æ¸…å•

æ¯æ¬¡å¼€å‘ API æ¥å£æ—¶å¿…é¡»æ£€æŸ¥ï¼š
- [ ] æ˜¯å¦ä½¿ç”¨ Pydantic `BaseModel` å®šä¹‰æ¨¡å‹
- [ ] æ‰€æœ‰å­—æ®µæ˜¯å¦ä½¿ç”¨ `Field` æä¾›æè¿°å’Œç¤ºä¾‹
- [ ] å…³é”®å­—æ®µæ˜¯å¦ä½¿ç”¨ `@validator` éªŒè¯
- [ ] å“åº”æ¨¡å‹æ˜¯å¦åŒ…å« `success` å­—æ®µ
- [ ] æ˜¯å¦åœ¨ `grpc_gateway.py` ä¸­æ³¨å†Œç«¯ç‚¹

#### 4.3 åºåˆ—åŒ–/ååºåˆ—åŒ–æ£€æŸ¥æ¸…å•

æ¯æ¬¡å¤„ç†æ•°æ®åºåˆ—åŒ–æ—¶å¿…é¡»æ£€æŸ¥ï¼š
- [ ] å¤æ‚ç»“æ„æ˜¯å¦ä½¿ç”¨ `json.dumps(ensure_ascii=False)` åºåˆ—åŒ–
- [ ] JSON ååºåˆ—åŒ–æ˜¯å¦æœ‰ try-except é”™è¯¯å¤„ç†
- [ ] æ˜¯å¦ä½¿ç”¨ `DataValidator` è¿›è¡Œç±»å‹éªŒè¯
- [ ] æ˜¯å¦æä¾›é»˜è®¤å€¼ï¼Œé¿å… None é”™è¯¯
- [ ] æ˜¯å¦è¿›è¡Œé˜²å¾¡æ€§ç¼–ç¨‹ï¼ˆNone æ£€æŸ¥ã€ç±»å‹æ£€æŸ¥ï¼‰

---

### 5. ç›¸å…³æ–‡ä»¶å’Œå·¥å…·

| æ–‡ä»¶/å·¥å…· | ç”¨é€” |
|----------|------|
| `proto/*.proto` | gRPC åè®®å®šä¹‰æ–‡ä»¶ |
| `server/api/grpc_gateway.py` | gRPC-Web ç½‘å…³ï¼Œç»Ÿä¸€æ³¨å†Œç«¯ç‚¹ |
| `server/utils/data_validator.py` | æ•°æ®éªŒè¯å·¥å…·ç±» |
| `server/api/v1/*.py` | REST API å®šä¹‰ï¼ˆPydantic æ¨¡å‹ï¼‰ |
| `services/*/grpc_server.py` | gRPC æœåŠ¡ç«¯å®ç° |
| `src/clients/*_client_grpc.py` | gRPC å®¢æˆ·ç«¯å®ç° |

---

### 6. è¿åè§„èŒƒçš„åæœ

**ç¦æ­¢è¡Œä¸º**ï¼š
- âŒ ç¦æ­¢åœ¨ proto ä¸­å®šä¹‰æ·±åº¦åµŒå¥—çš„ messageï¼ˆåº”ä½¿ç”¨ JSON å­—ç¬¦ä¸²ï¼‰
- âŒ ç¦æ­¢ç›´æ¥ä½¿ç”¨ `str()` åºåˆ—åŒ–å­—å…¸ï¼ˆåº”ä½¿ç”¨ `json.dumps`ï¼‰
- âŒ ç¦æ­¢å¿½ç•¥ JSON ååºåˆ—åŒ–é”™è¯¯å¤„ç†
- âŒ ç¦æ­¢ç»•è¿‡ `DataValidator` ç›´æ¥æ“ä½œæ•°æ®
- âŒ ç¦æ­¢åœ¨ `grpc_gateway.py` å¤–ç›´æ¥å¤„ç† gRPC è¯·æ±‚

**è¿åè§„èŒƒçš„ä»£ç å°†è¢«è¦æ±‚é‡æ„**ï¼š
- æ‰€æœ‰ä¸ç¬¦åˆè§„èŒƒçš„ä»£ç å¿…é¡»æŒ‰ç…§æœ¬è§„èŒƒé‡æ„
- é‡æ„æ—¶å¿…é¡»è¿›è¡Œå®Œæ•´çš„æµ‹è¯•éªŒè¯
- é‡æ„åå¿…é¡»é€šè¿‡ä»£ç å®¡æŸ¥

---

**æ ¸å¿ƒåŸåˆ™**ï¼š
- ğŸ”’ **ä¸¥æ ¼ç±»å‹**ï¼šæ‰€æœ‰æ•°æ®å¿…é¡»æœ‰æ˜ç¡®çš„ç±»å‹å®šä¹‰å’ŒéªŒè¯
- ğŸ”„ **ç»Ÿä¸€è§„èŒƒ**ï¼šæ‰€æœ‰æœåŠ¡éµå¾ªç›¸åŒçš„åºåˆ—åŒ–/ååºåˆ—åŒ–è§„èŒƒ
- ğŸ›¡ï¸ **é˜²å¾¡ç¼–ç¨‹**ï¼šæ‰€æœ‰æ•°æ®æ“ä½œå¿…é¡»æœ‰é”™è¯¯å¤„ç†å’Œé»˜è®¤å€¼
- ğŸ“ **å®Œæ•´æ–‡æ¡£**ï¼šæ‰€æœ‰æ¨¡å‹å’Œæ¥å£å¿…é¡»æœ‰æ¸…æ™°çš„æ³¨é‡Šå’Œæ–‡æ¡£
- âš ï¸ **å¼ºåˆ¶éµå®ˆ**ï¼šæ‰€æœ‰åŠŸèƒ½å¼€å‘å¿…é¡»æŒ‰ç…§æœ¬è§„èŒƒæ‰§è¡Œï¼Œç¦æ­¢è‡ªä½œä¸»å¼ 

---

## ğŸ“œ è§„åˆ™å¼€å‘è§„èŒƒ ã€æ ¸å¿ƒã€‘

### ğŸ”´ è§„åˆ™å­˜å‚¨è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

> **æ‰€æœ‰è§„åˆ™å¿…é¡»å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œç¦æ­¢ä»æ–‡ä»¶è¯»å–ï¼**

| å­˜å‚¨æ–¹å¼ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| **MySQL æ•°æ®åº“** | âœ… **å”¯ä¸€æ¥æº** | æ‰€æœ‰è§„åˆ™å­˜å‚¨åœ¨ `bazi_rules` è¡¨ |
| Excel æ–‡ä»¶ (.xlsx) | âŒ **ç¦æ­¢** | ä»…ç”¨äºå¯¼å…¥ï¼Œå¯¼å…¥ååˆ é™¤æˆ–å½’æ¡£ |
| Word æ–‡ä»¶ (.docx) | âŒ **ç¦æ­¢** | ä»…ç”¨äºå¯¼å…¥ï¼Œå¯¼å…¥ååˆ é™¤æˆ–å½’æ¡£ |
| JSON æ–‡ä»¶ (.json) | âŒ **ç¦æ­¢** | ä»…ç”¨äºå¯¼å…¥ï¼Œå¯¼å…¥ååˆ é™¤æˆ–å½’æ¡£ |
| é…ç½®æ–‡ä»¶ | âŒ **ç¦æ­¢** | ä¸å…è®¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç è§„åˆ™ |

**å®ç°è¦æ±‚**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä»æ•°æ®åº“åŠ è½½è§„åˆ™
from server.services.rule_service import RuleService
rules = RuleService.match_rules(bazi_data, rule_types=['wealth'])

# âŒ é”™è¯¯ï¼šä»æ–‡ä»¶è¯»å–è§„åˆ™
import json
with open('rules.json') as f:
    rules = json.load(f)  # ç¦æ­¢ï¼

# âŒ é”™è¯¯ï¼šä» Excel è¯»å–è§„åˆ™
import pandas as pd
df = pd.read_excel('rules.xlsx')  # ç¦æ­¢ï¼
```

**ä»£ç æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ‰€æœ‰è§„åˆ™åŒ¹é…ä½¿ç”¨ `RuleService`
- [ ] æ²¡æœ‰ `load_from_file`ã€`read_excel`ã€`read_json` ç­‰æ–‡ä»¶è¯»å–è°ƒç”¨
- [ ] æ²¡æœ‰ç¡¬ç¼–ç çš„è§„åˆ™æ•°æ®
- [ ] è§„åˆ™å¯¼å…¥è„šæœ¬ä»…ç”¨äºä¸€æ¬¡æ€§å¯¼å…¥ï¼Œä¸ç”¨äºè¿è¡Œæ—¶è¯»å–

**åºŸå¼ƒä»£ç æ ‡è®°**ï¼š
```python
# âš ï¸ å·²åºŸå¼ƒï¼šä»¥ä¸‹æ–¹æ³•ä»…ç”¨äºå…¼å®¹ï¼Œæ–°ä»£ç ç¦æ­¢ä½¿ç”¨
# - RuleEngine.load_from_file()  # å·²åºŸå¼ƒ
# - FormulaRuleService.load_rules()  # å·²åºŸå¼ƒï¼Œæ”¹ç”¨ RuleService
```

---

### è§„åˆ™å¼€å‘å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è§„åˆ™å¼€å‘æ ‡å‡†æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. å‡†å¤‡é˜¶æ®µ                                                                â”‚
â”‚     â”œâ”€â”€ è·å–è§„åˆ™æ–‡æ¡£ï¼ˆExcel/JSONï¼‰                                           â”‚
â”‚     â”œâ”€â”€ åˆ†æè§„åˆ™ç»“æ„ï¼ˆç±»å‹ã€æ¡ä»¶ã€ç»“æœï¼‰                                       â”‚
â”‚     â””â”€â”€ è¯†åˆ«æ–°æ¡ä»¶ç±»å‹ï¼ˆæ˜¯å¦éœ€è¦æ‰©å±•è§„åˆ™å¼•æ“ï¼‰                                  â”‚
â”‚                                                                             â”‚
â”‚  2. æ¡ä»¶ç±»å‹æ£€æŸ¥                                                             â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥ rule_condition.py æ˜¯å¦æ”¯æŒæ‰€éœ€æ¡ä»¶                               â”‚
â”‚     â”œâ”€â”€ å¦‚ä¸æ”¯æŒ â†’ å…ˆæ‰©å±•è§„åˆ™å¼•æ“                                             â”‚
â”‚     â””â”€â”€ æ‰©å±•åç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯                                                â”‚
â”‚                                                                             â”‚
â”‚  3. ç¼–å†™è§£æè„šæœ¬                                                             â”‚
â”‚     â”œâ”€â”€ ä½ç½®ï¼šscripts/migration/import_xxx_rules.py                         â”‚
â”‚     â”œâ”€â”€ è§£æè§„åˆ™æ–‡æ¡£                                                         â”‚
â”‚     â”œâ”€â”€ è½¬æ¢ä¸ºæ•°æ®åº“æ ¼å¼                                                     â”‚
â”‚     â”œâ”€â”€ æ ‡è®°æ­§ä¹‰è§„åˆ™å¾…ç¡®è®¤                                                   â”‚
â”‚     â””â”€â”€ ç”Ÿæˆæœªè§£æè§„åˆ™JSONï¼ˆåŒ…å«è¯¦ç»†è¯´æ˜ï¼‰                                    â”‚
â”‚                                                                             â”‚
â”‚  4. è§£æè§„åˆ™                                                                 â”‚
â”‚     â”œâ”€â”€ è¿è¡Œè§£æè„šæœ¬ï¼špython scripts/migration/import_xxx_rules.py         â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥è§£æç‡ï¼ˆç›®æ ‡ï¼š>80%ï¼‰                                             â”‚
â”‚     â”œâ”€â”€ åˆ†ææœªè§£æè§„åˆ™åŸå›                                                    â”‚
â”‚     â””â”€â”€ ç”Ÿæˆæœªè§£æè§„åˆ™è¯¦ç»†è¯´æ˜JSON                                           â”‚
â”‚                                                                             â”‚
â”‚  5. æ‰©å±•è§£æèƒ½åŠ›ï¼ˆå¦‚éœ€è¦ï¼‰                                                   â”‚
â”‚     â”œâ”€â”€ åœ¨ RuleParser ä¸­æ·»åŠ æ–°çš„è§£ææ–¹æ³•                                     â”‚
â”‚     â”œâ”€â”€ åœ¨ rule_condition.py ä¸­æ·»åŠ æ–°çš„æ¡ä»¶åŒ¹é…é€»è¾‘                          â”‚
â”‚     â”œâ”€â”€ é‡æ–°è¿è¡Œè§£æè„šæœ¬éªŒè¯                                                 â”‚
â”‚     â””â”€â”€ ç¡®ä¿è§£æç‡æå‡                                                       â”‚
â”‚                                                                             â”‚
â”‚  6. å¯¼å…¥æ•°æ®åº“                                                               â”‚
â”‚     â”œâ”€â”€ ç¼–å†™å¯¼å…¥è„šæœ¬ï¼šscripts/migration/import_xxx_rules_to_db.py           â”‚
â”‚     â”œâ”€â”€ å…ˆ --dry-run é¢„è§ˆ                                                    â”‚
â”‚     â”œâ”€â”€ æ­£å¼å¯¼å…¥æ•°æ®åº“                                                       â”‚
â”‚     â””â”€â”€ éªŒè¯è§„åˆ™æ•°é‡å’Œå†…å®¹                                                   â”‚
â”‚                                                                             â”‚
â”‚  7. å‰ç«¯é€‚é…                                                                 â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥ local_frontend/formula-analysis.html ä¸­ typeLabels æ˜¯å¦åŒ…å«æ–°ç±»å‹     â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥ statistics ç»Ÿè®¡æ˜¯å¦æ˜¾ç¤º                                         â”‚
â”‚     â””â”€â”€ æµ‹è¯•å‰ç«¯é¡µé¢å±•ç¤º                                                     â”‚
â”‚                                                                             â”‚
â”‚  8. åç«¯é€‚é…                                                                 â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥ server/api/v1/formula_analysis.py ç±»å‹æ˜ å°„                     â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥ matched_rules åˆå§‹åŒ–                                            â”‚
â”‚     â””â”€â”€ æ£€æŸ¥ statistics è¿”å›å­—æ®µ                                             â”‚
â”‚                                                                             â”‚
â”‚  9. ç«¯åˆ°ç«¯æµ‹è¯•                                                               â”‚
â”‚     â”œâ”€â”€ API æµ‹è¯•ï¼šcurl éªŒè¯è¿”å›æ•°æ®                                          â”‚
â”‚     â”œâ”€â”€ å‰ç«¯æµ‹è¯•ï¼šé¡µé¢å±•ç¤ºæ­£å¸¸                                               â”‚
â”‚     â””â”€â”€ è§„åˆ™åŒ¹é…ï¼šæŠ½æ ·éªŒè¯è§„åˆ™åŒ¹é…å‡†ç¡®æ€§                                      â”‚
â”‚                                                                             â”‚
â”‚  10. æäº¤ä»£ç                                                                 â”‚
â”‚     â”œâ”€â”€ æäº¤è§£æè„šæœ¬                                                         â”‚
â”‚     â”œâ”€â”€ æäº¤å¯¼å…¥è„šæœ¬                                                         â”‚
â”‚     â”œâ”€â”€ æäº¤è§„åˆ™å¼•æ“æ‰©å±•ï¼ˆå¦‚æœ‰ï¼‰                                             â”‚
â”‚     â”œâ”€â”€ æäº¤å‰åç«¯é€‚é…ä»£ç                                                    â”‚
â”‚     â”œâ”€â”€ æäº¤æœªè§£æè§„åˆ™è¯¦ç»†è¯´æ˜JSON                                           â”‚
â”‚     â””â”€â”€ åŒæ­¥ç”Ÿäº§æ•°æ®åº“                                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§„åˆ™è§£æè„šæœ¬æ ‡å‡†æ¨¡æ¿

**æ–‡ä»¶å‘½å**ï¼š`scripts/migration/import_YYYY_MM_DD_rules.py`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. è§£æExcelè§„åˆ™æ–‡ä»¶
2. ä½¿ç”¨ `RuleParser` è§£æè§„åˆ™æ¡ä»¶
3. ç”ŸæˆæˆåŠŸè§£æå’Œå¤±è´¥è§£æçš„ç»Ÿè®¡
4. ä¿å­˜æœªè§£æè§„åˆ™åˆ°JSONæ–‡ä»¶

**æ ‡å‡†è¾“å‡º**ï¼š
- è§£æç‡ç»Ÿè®¡
- å¤±è´¥åŸå› ç»Ÿè®¡
- æœªè§£æè§„åˆ™JSONæ–‡ä»¶ï¼ˆ`docs/æœªè§£æè§„åˆ™_YYYY_MM_DD_æè¿°.json`ï¼‰

### è§„åˆ™å¯¼å…¥è„šæœ¬æ ‡å‡†æ¨¡æ¿

**æ–‡ä»¶å‘½å**ï¼š`scripts/migration/import_YYYY_MM_DD_rules_to_db.py`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. è°ƒç”¨è§£æè„šæœ¬è·å–å·²è§£æè§„åˆ™
2. è¿æ¥æ•°æ®åº“
3. æ’å…¥æˆ–æ›´æ–°è§„åˆ™ï¼ˆæ ¹æ® rule_code åˆ¤æ–­ï¼‰
4. æ”¯æŒ --dry-run é¢„è§ˆæ¨¡å¼

**æ ‡å‡†æµç¨‹**ï¼š
```bash
# 1. é¢„è§ˆæ¨¡å¼
python scripts/migration/import_YYYY_MM_DD_rules_to_db.py --dry-run

# 2. æ­£å¼å¯¼å…¥
python scripts/migration/import_YYYY_MM_DD_rules_to_db.py
```

### æœªè§£æè§„åˆ™è¯¦ç»†è¯´æ˜JSONæ ‡å‡†æ ¼å¼

**æ–‡ä»¶å‘½å**ï¼š`docs/æœªè§£æè§„åˆ™_YYYY_MM_DD_æè¿°_è¯¦ç»†è¯´æ˜.json`

**æ ‡å‡†ç»“æ„**ï¼š
```json
{
  "ç»Ÿè®¡": {
    "æ€»è§„åˆ™æ•°": 60,
    "æˆåŠŸè§£æ": 53,
    "æ— æ³•è§£æ": 7,
    "è§£ææˆåŠŸç‡": "88.3%"
  },
  "æœªè§£æè§„åˆ™è¯¦ç»†è¯´æ˜": [
    {
      "ID": 80102,
      "ç±»å‹": "äº‹ä¸š",
      "ç­›é€‰æ¡ä»¶1": "åç¥",
      "ç­›é€‰æ¡ä»¶2": "...",
      "ç»“æœ": "...",
      "rule_code": "FORMULA_äº‹ä¸š_80102",
      "è§£æå¤±è´¥åŸå› ": "...",
      "ä¸ç†è§£ç‚¹è¯´æ˜": {
        "ä¸ç†è§£çš„ç‚¹": ["é—®é¢˜1", "é—®é¢˜2"],
        "éœ€è¦æ¾„æ¸…çš„æ¦‚å¿µ": {
          "æ¦‚å¿µ1": "è¯´æ˜1",
          "æ¦‚å¿µ2": "è¯´æ˜2"
        },
        "æ­§ä¹‰è¯´æ˜": "ä¸ºä»€ä¹ˆæ— æ³•è§£æ",
        "æ¡ˆä¾‹è¯´æ˜": {
          "ç¤ºä¾‹1": {
            "å…«å­—": "...",
            "éªŒè¯": {
              "æ¡ä»¶1": "...",
              "ç»“æœ": "..."
            }
          }
        },
        "è§£å†³æ–¹æ¡ˆ": "å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜"
      }
    }
  ],
  "æ€»ç»“": {
    "ä¸»è¦é—®é¢˜ç±»å‹": ["ç±»å‹1", "ç±»å‹2"],
    "ä¼˜å…ˆçº§å»ºè®®": ["é«˜ä¼˜å…ˆçº§", "ä¸­ä¼˜å…ˆçº§", "ä½ä¼˜å…ˆçº§"]
  }
}
```

### è§„åˆ™è§£æå¢å¼ºæ ‡å‡†æµç¨‹

**å½“è§£æç‡ < 80% æ—¶ï¼Œéœ€è¦å¢å¼ºè§£æèƒ½åŠ›**ï¼š

1. **åˆ†ææœªè§£æè§„åˆ™**
   - ç»Ÿè®¡å¤±è´¥åŸå› 
   - è¯†åˆ«å¸¸è§æ¨¡å¼
   - ç¡®å®šéœ€è¦æ‰©å±•çš„åŠŸèƒ½

2. **æ‰©å±•è§£æå™¨**
   - åœ¨ `RuleParser._parse_ten_gods` ç­‰æ–¹æ³•ä¸­æ·»åŠ æ–°é€»è¾‘
   - æ”¯æŒæ–°çš„æ¡ä»¶æ¨¡å¼
   - å¤„ç†å¤æ‚ç»„åˆæ¡ä»¶

3. **æ‰©å±•è§„åˆ™å¼•æ“**
   - åœ¨ `server/engines/rule_condition.py` ä¸­æ·»åŠ æ–°æ¡ä»¶ç±»å‹
   - å®ç°æ¡ä»¶åŒ¹é…é€»è¾‘
   - ç¡®ä¿ä¸å½±å“ç°æœ‰åŠŸèƒ½

4. **éªŒè¯å¢å¼ºæ•ˆæœ**
   - é‡æ–°è¿è¡Œè§£æè„šæœ¬
   - æ£€æŸ¥è§£æç‡æå‡
   - ç¡®ä¿æ²¡æœ‰ç ´åç°æœ‰åŠŸèƒ½

5. **è¿­ä»£ä¼˜åŒ–**
   - é‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œç›´åˆ°è§£æç‡ > 80%
   - è®°å½•æ— æ³•è§£æçš„è§„åˆ™åˆ°è¯¦ç»†è¯´æ˜JSON
   - æ ‡è®°éœ€è¦è¿›ä¸€æ­¥å¼€å‘çš„å¤æ‚åŠŸèƒ½

### è§„åˆ™æ•°æ®åº“ç»“æ„

**è¡¨ï¼š`bazi_rules`**
```sql
CREATE TABLE bazi_rules (
    id INT AUTO_INCREMENT PRIMARY KEY,
    rule_code VARCHAR(100) NOT NULL UNIQUE,    -- è§„åˆ™ç¼–ç ï¼šFORMULA_ç±»å‹_ç¼–å·
    rule_name VARCHAR(200),                     -- è§„åˆ™åç§°
    rule_type VARCHAR(50) NOT NULL,             -- è§„åˆ™ç±»å‹ï¼ˆè‹±æ–‡ï¼‰
    conditions JSON,                            -- åŒ¹é…æ¡ä»¶ï¼ˆJSONæ ¼å¼ï¼‰
    content JSON,                               -- è§„åˆ™å†…å®¹/ç»“æœ
    description JSON,                           -- åŸå§‹æè¿°ä¿¡æ¯
    priority INT DEFAULT 100,                   -- ä¼˜å…ˆçº§
    enabled TINYINT DEFAULT 1,                  -- æ˜¯å¦å¯ç”¨
    version INT DEFAULT 1,                      -- ç‰ˆæœ¬å·
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### è§„åˆ™ç¼–ç è§„èŒƒ

| æ ¼å¼ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|
| `FORMULA_ç±»å‹_ç¼–å·` | `FORMULA_äº‹ä¸š_80001` | æ–°ç‰ˆæ ¼å¼ï¼ˆæ¨èï¼‰ |
| `FORMULA_ç¼–å·` | `FORMULA_10901` | æ—§ç‰ˆæ ¼å¼ï¼ˆå…¼å®¹ï¼‰ |

**ç±»å‹æ˜ å°„ï¼ˆä¸­è‹±æ–‡ï¼‰ï¼š**
| ä¸­æ–‡ | è‹±æ–‡ | è¯´æ˜ |
|------|------|------|
| è´¢å¯Œ | wealth | è´¢è¿ç›¸å…³ |
| å©šå§» | marriage | å©šé…ç›¸å…³ |
| äº‹ä¸š | career | äº‹ä¸šç›¸å…³ |
| å­å¥³ | children | å­å¥³ç›¸å…³ |
| æ€§æ ¼ | character | æ€§æ ¼ç‰¹å¾ |
| æ€»è¯„ | summary | ç»¼åˆè¯„ä»· |
| èº«ä½“ | health | å¥åº·ç›¸å…³ |
| æ¡ƒèŠ± | peach_blossom | æ¡ƒèŠ±è¿ |
| åç¥å‘½æ ¼ | shishen | åç¥åˆ†æ |

### è§„åˆ™æ¡ä»¶ç±»å‹æ¸…å•

#### åŸºç¡€æ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `gender` | `"male"` / `"female"` / `"*"` | æ€§åˆ«æ¡ä»¶ |
| `wangshuai` | `["èº«æ—º"]` / `["èº«å¼±"]` | æ—ºè¡°æ¡ä»¶ |

#### å››æŸ±æ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `pillar_in` | `{"pillar": "day", "part": "stem", "values": ["ç”²", "ä¹™"]}` | æŸ±ä½åŒ¹é… |
| `pillar_equals` | `{"pillar": "day", "values": ["åºšè¾°"]}` | å®Œæ•´æŸ±åŒ¹é… |
| `pillar_relation` | `{"pillar_a": "day", "pillar_b": "hour", "relation": "chong"}` | æŸ±é—´å…³ç³» |

#### åç¥æ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `ten_gods_main` | `{"names": ["æ­£å®˜", "ä¸ƒæ€"], "min": 2}` | ä¸»æ˜Ÿæ•°é‡ |
| `ten_gods_sub` | `{"names": ["é£Ÿç¥"], "pillars": ["day"], "min": 1}` | å‰¯æ˜Ÿæ•°é‡ |
| `ten_gods_total` | `{"names": ["æ¯”è‚©", "åŠ«è´¢"], "min": 3}` | æ€»åç¥æ•°é‡ |
| `main_star_in_day` | `"ä¸ƒæ€"` | æ—¥æŸ±ä¸»æ˜Ÿ |
| `main_star_in_any_pillar` | `"é£Ÿç¥"` | ä»»æ„æŸ±ä¸»æ˜Ÿ |
| `ten_gods_main_chong_count` | `{"min": 2}` | ä¸»æ˜Ÿè¢«å†²æ¬¡æ•° |

#### äº”è¡Œæ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `element_total` | `{"element": "æœ¨", "min": 3}` | äº”è¡Œæ•°é‡ |
| `elements_count` | `{"æœ¨": {"min": 2}, "ç«": {"max": 1}}` | å¤šäº”è¡Œæ•°é‡ |

#### ç¥ç…æ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `deities_in_any_pillar` | `"å¤©ä¹™è´µäºº"` | ä»»æ„æŸ±æœ‰ç¥ç… |
| `deities_in_year` | `"åç›–"` | å¹´æŸ±æœ‰ç¥ç… |
| `deities_in_month` | `"ç©ºäº¡"` | æœˆæŸ±æœ‰ç¥ç… |
| `deities_in_day` | `"æ¡ƒèŠ±"` | æ—¥æŸ±æœ‰ç¥ç… |
| `deities_in_hour` | `"é©¿é©¬"` | æ—¶æŸ±æœ‰ç¥ç… |
| `deities_same_pillar` | `["åç›–", "ç©ºäº¡"]` | åŒæŸ±å¤šç¥ç… |

#### åäºŒé•¿ç”Ÿæ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `star_fortune_in_day` | `"å¸æ—º"` / `["æ­»", "ç»"]` | æ—¥æ”¯åäºŒé•¿ç”Ÿ |
| `star_fortune_in_hour` | `"å¢“"` | æ—¶æ”¯åäºŒé•¿ç”Ÿ |
| `liunian_star_fortune` | `"ç»"` | æµå¹´åäºŒé•¿ç”Ÿ |

#### å…³ç³»æ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `branch_sanxing` | `true` | åœ°æ”¯ä¸‰åˆ‘ |
| `stem_wuhe_pairs` | `{"min": 1}` | å¤©å¹²äº”åˆå¯¹æ•° |
| `pillar_branch_xing_chong` | `true` | æŸ±åœ°æ”¯è¢«åˆ‘å†² |
| `multi_chong` | `{"min": 2}` | å¤šé‡å†² |

#### ç‰¹æ®Šæ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `xishen` | `"æ¯”è‚©"` | å–œç”¨ç¥åŒ¹é… |
| `xishen_in` | `["é£Ÿç¥", "ä¼¤å®˜"]` | å–œç”¨ç¥åœ¨åˆ—è¡¨ä¸­ |
| `taiyuan_shengong_minggong` | `{"taiyuan": "ç™¸ä¸‘"}` | èƒå…ƒèº«å®«å‘½å®« |
| `stems_branches_count` | `{"names": ["å£¬", "ç™¸", "å­"], "min": 3}` | å¤©å¹²åœ°æ”¯æ··åˆè®¡æ•° |
| `not` | `{...æ¡ä»¶...}` | å¦å®šæ¡ä»¶ |

#### ç»„åˆæ¡ä»¶
| æ¡ä»¶ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|---------|------|------|
| `all` | `[æ¡ä»¶1, æ¡ä»¶2, ...]` | æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³ï¼ˆANDï¼‰ |
| `any` | `[æ¡ä»¶1, æ¡ä»¶2, ...]` | ä»»ä¸€æ¡ä»¶æ»¡è¶³ï¼ˆORï¼‰ |

### è§„åˆ™å¯¼å…¥è„šæœ¬æ¨¡æ¿

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è§„åˆ™å¯¼å…¥è„šæœ¬ï¼šimport_xxx_rules.py

ä½¿ç”¨æ–¹æ³•ï¼š
  python scripts/migration/import_xxx_rules.py --dry-run  # é¢„è§ˆ
  python scripts/migration/import_xxx_rules.py            # æ­£å¼å¯¼å…¥
"""

import sys
import os
import json
import argparse
from typing import Dict, Any, Tuple, Optional, List

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from server.config.mysql_config import get_mysql_connection, return_mysql_connection


class RuleConverter:
    """è§„åˆ™è½¬æ¢å™¨"""
    
    # ç±»å‹æ˜ å°„
    TYPE_MAPPING = {
        'è´¢å¯Œ': 'wealth',
        'å©šå§»': 'marriage',
        'äº‹ä¸š': 'career',
        'å­å¥³': 'children',
        'æ€§æ ¼': 'character',
        'æ€»è¯„': 'summary',
        'èº«ä½“': 'health',
        'æ¡ƒèŠ±': 'peach_blossom',
    }
    
    def convert(self, raw_rule: Dict) -> Tuple[Optional[Dict], Optional[str]]:
        """
        è½¬æ¢åŸå§‹è§„åˆ™ä¸ºæ•°æ®åº“æ ¼å¼
        
        Returns:
            (rule_dict, ambiguity_reason) - å¦‚æœæœ‰æ­§ä¹‰è¿”å›åŸå› 
        """
        # 1. æå–å­—æ®µ
        rule_id = raw_rule.get('ID')
        rule_type_cn = raw_rule.get('ç±»å‹', '')
        condition1 = raw_rule.get('ç­›é€‰æ¡ä»¶1', '')
        condition2 = raw_rule.get('ç­›é€‰æ¡ä»¶2', '')
        result = raw_rule.get('ç»“æœ', '')
        gender = raw_rule.get('æ€§åˆ«', '')
        
        # 2. è½¬æ¢ç±»å‹
        rule_type = self.TYPE_MAPPING.get(rule_type_cn, rule_type_cn.lower())
        
        # 3. è§£ææ¡ä»¶
        conditions, ambiguity = self._parse_conditions(condition1, condition2, gender)
        if ambiguity:
            return None, f"ID {rule_id}: {ambiguity}"
        
        # 4. æ„å»ºè§„åˆ™
        rule = {
            'rule_code': f'FORMULA_{rule_type_cn}_{rule_id}',
            'rule_name': f'{rule_type_cn}è§„åˆ™-{rule_id}',
            'rule_type': rule_type,
            'conditions': conditions,
            'content': {'text': result},
            'description': {
                'ç­›é€‰æ¡ä»¶1': condition1,
                'ç­›é€‰æ¡ä»¶2': condition2,
                'æ€§åˆ«': gender
            }
        }
        
        return rule, None
    
    def _parse_conditions(self, cond1: str, cond2: str, gender: str) -> Tuple[Dict, Optional[str]]:
        """è§£ææ¡ä»¶æ–‡æœ¬ä¸ºJSONæ ¼å¼"""
        conditions = {}
        
        # è§£ææ€§åˆ«
        if gender == 'ç”·':
            conditions['gender'] = 'male'
        elif gender == 'å¥³':
            conditions['gender'] = 'female'
        
        # è§£æå…·ä½“æ¡ä»¶ï¼ˆæ ¹æ®å®é™…è§„åˆ™æ ¼å¼å®ç°ï¼‰
        # ...
        
        return conditions, None


def import_rules(rules: List[Dict], dry_run: bool = False) -> Tuple[int, int, List[str]]:
    """
    å¯¼å…¥è§„åˆ™åˆ°æ•°æ®åº“
    
    Returns:
        (inserted, updated, ambiguous_rules)
    """
    inserted = 0
    updated = 0
    ambiguous = []
    
    if dry_run:
        print("=== DRY RUN æ¨¡å¼ï¼Œä¸ä¼šä¿®æ”¹æ•°æ®åº“ ===\n")
    
    conn = get_mysql_connection()
    try:
        with conn.cursor() as cursor:
            for rule in rules:
                if dry_run:
                    print(f"å°†å¯¼å…¥: {rule['rule_code']}")
                    continue
                
                # æ£€æŸ¥æ˜¯å¦å­˜åœ¨
                cursor.execute(
                    "SELECT id FROM bazi_rules WHERE rule_code = %s",
                    (rule['rule_code'],)
                )
                existing = cursor.fetchone()
                
                if existing:
                    # æ›´æ–°
                    cursor.execute("""
                        UPDATE bazi_rules SET
                            rule_name = %s,
                            rule_type = %s,
                            conditions = %s,
                            content = %s,
                            description = %s,
                            version = version + 1
                        WHERE rule_code = %s
                    """, (
                        rule['rule_name'],
                        rule['rule_type'],
                        json.dumps(rule['conditions'], ensure_ascii=False),
                        json.dumps(rule['content'], ensure_ascii=False),
                        json.dumps(rule['description'], ensure_ascii=False),
                        rule['rule_code']
                    ))
                    updated += 1
                else:
                    # æ’å…¥
                    cursor.execute("""
                        INSERT INTO bazi_rules 
                        (rule_code, rule_name, rule_type, conditions, content, description)
                        VALUES (%s, %s, %s, %s, %s, %s)
                    """, (
                        rule['rule_code'],
                        rule['rule_name'],
                        rule['rule_type'],
                        json.dumps(rule['conditions'], ensure_ascii=False),
                        json.dumps(rule['content'], ensure_ascii=False),
                        json.dumps(rule['description'], ensure_ascii=False)
                    ))
                    inserted += 1
            
            if not dry_run:
                conn.commit()
    finally:
        return_mysql_connection(conn)
    
    return inserted, updated, ambiguous


def main():
    parser = argparse.ArgumentParser(description='è§„åˆ™å¯¼å…¥è„šæœ¬')
    parser.add_argument('--dry-run', action='store_true', help='é¢„è§ˆæ¨¡å¼ï¼Œä¸ä¿®æ”¹æ•°æ®åº“')
    args = parser.parse_args()
    
    # åŠ è½½è§„åˆ™æ•°æ®
    # ...
    
    # å¯¼å…¥è§„åˆ™
    inserted, updated, ambiguous = import_rules(rules, args.dry_run)
    
    print(f"\n=== å¯¼å…¥ç»“æœ ===")
    print(f"æ–°å¢: {inserted} æ¡")
    print(f"æ›´æ–°: {updated} æ¡")
    print(f"æ­§ä¹‰: {len(ambiguous)} æ¡")


if __name__ == '__main__':
    main()
```

---

## ğŸ”„ é—®é¢˜å¤ç›˜æœºåˆ¶ ã€é‡è¦ã€‘

### å¤ç›˜æµç¨‹

æ¯æ¬¡é‡åˆ°é—®é¢˜åï¼Œå¿…é¡»å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š

1. **é—®é¢˜è®°å½•**
   - è®°å½•é—®é¢˜ç°è±¡ã€é”™è¯¯ä¿¡æ¯ã€å¤ç°æ­¥éª¤
   - è®°å½•é—®é¢˜å‘ç”Ÿæ—¶é—´ã€å½±å“èŒƒå›´

2. **æ ¹å› åˆ†æ**
   - åˆ†æé—®é¢˜æ ¹æœ¬åŸå› ï¼ˆä¸æ˜¯è¡¨é¢ç°è±¡ï¼‰
   - æ£€æŸ¥æ˜¯å¦è¿åå¼€å‘è§„èŒƒ
   - æ£€æŸ¥æ˜¯å¦æœ‰ç±»ä¼¼é—®é¢˜å†å²

3. **è§£å†³æ–¹æ¡ˆ**
   - å®æ–½ä¿®å¤æ–¹æ¡ˆ
   - éªŒè¯ä¿®å¤æ•ˆæœ
   - ç¡®ä¿ä¸ä¼šå†æ¬¡å‡ºç°

4. **è§„èŒƒæ›´æ–°**
   - å°†é—®é¢˜å¤ç›˜è®°å½•åˆ°å¼€å‘è§„èŒƒ
   - æ›´æ–°ç›¸å…³æ£€æŸ¥æ¸…å•
   - æ·»åŠ é¢„é˜²æªæ–½

5. **ä»£ç å®¡æŸ¥**
   - æ£€æŸ¥æ˜¯å¦æœ‰ç±»ä¼¼ä»£ç éœ€è¦ä¿®å¤
   - ç¡®ä¿æ‰€æœ‰ç›¸å…³ä»£ç éƒ½ç¬¦åˆè§„èŒƒ

### å¤ç›˜è®°å½•æ ¼å¼

```markdown
## é—®é¢˜å¤ç›˜ï¼š[é—®é¢˜æ ‡é¢˜] - YYYY-MM-DD

### é—®é¢˜æè¿°
- **ç°è±¡**ï¼šå…·ä½“é—®é¢˜è¡¨ç°
- **å½±å“**ï¼šå½±å“èŒƒå›´å’Œä¸¥é‡ç¨‹åº¦
- **å¤ç°**ï¼šå¤ç°æ­¥éª¤

### æ ¹å› åˆ†æ
- **ç›´æ¥åŸå› **ï¼šè¡¨é¢åŸå› 
- **æ ¹æœ¬åŸå› **ï¼šæ·±å±‚åŸå› 
- **è§„èŒƒè¿å**ï¼šè¿åäº†å“ªäº›å¼€å‘è§„èŒƒ

### è§£å†³æ–¹æ¡ˆ
- **ä¿®å¤å†…å®¹**ï¼šå…·ä½“ä¿®æ”¹
- **éªŒè¯ç»“æœ**ï¼šæµ‹è¯•éªŒè¯æƒ…å†µ

### é¢„é˜²æªæ–½
- **è§„èŒƒæ›´æ–°**ï¼šæ›´æ–°çš„è§„èŒƒå†…å®¹
- **æ£€æŸ¥æ¸…å•**ï¼šæ–°å¢çš„æ£€æŸ¥é¡¹
- **ä»£ç å®¡æŸ¥**ï¼šéœ€è¦æ£€æŸ¥çš„ä»£ç èŒƒå›´
```

---

## ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜å¤ç›˜ï¼šåç¥å‘½æ ¼è§„åˆ™åŒ¹é…å¤±è´¥ - 2025-11-28

#### é—®é¢˜æè¿°
- **ç°è±¡**ï¼šç”Ÿæ—¥ 1987-01-07 09:00 æ— æ³•åŒ¹é…åç¥å‘½æ ¼è§„åˆ™
- **å½±å“**ï¼šæ‰€æœ‰åç¥å‘½æ ¼è§„åˆ™éƒ½æ— æ³•åŒ¹é…ï¼Œå½±å“è§„åˆ™åˆ†æåŠŸèƒ½
- **å¤ç°**ï¼šè°ƒç”¨ `/bazi/formula-analysis` APIï¼Œ`shishen_count` å§‹ç»ˆä¸º 0

#### æ ¹å› åˆ†æ
1. **ç›´æ¥åŸå› **ï¼š
   - `formula_analysis.py` ä¸­åç¥å‘½æ ¼ä½¿ç”¨ `FormulaRuleService` åŒ¹é…
   - `FormulaRuleService` æœŸæœ›æ—§æ ¼å¼ï¼ˆæ–‡æœ¬æ¡ä»¶ï¼‰ï¼Œä½†æ•°æ®åº“è§„åˆ™å·²è¿ç§»ä¸º JSON æ ¼å¼
   - è§„åˆ™æ¡ä»¶æ ¼å¼é—®é¢˜ï¼š`hidden_stars_in_year` åŒ…å«æ–‡æœ¬æè¿°ï¼ˆå¦‚"æ—¥æŸ±å‰¯æ˜Ÿæœ‰æ­£è´¢"ï¼‰

2. **æ ¹æœ¬åŸå› **ï¼š
   - è§„åˆ™è¿ç§»åæœªç»Ÿä¸€åŒ¹é…æœåŠ¡
   - è§„åˆ™å¼•æ“æœªæ”¯æŒæ··åˆæ¡ä»¶æ ¼å¼ï¼ˆæ–‡æœ¬æè¿°+åç¥åç§°ï¼‰
   - ç¼ºå°‘è§„åˆ™åŒ¹é…çš„ç»Ÿä¸€æµ‹è¯•

3. **è§„èŒƒè¿å**ï¼š
   - âŒ æœªä½¿ç”¨ç»Ÿä¸€çš„ `RuleService` åŒ¹é…è§„åˆ™
   - âŒ è§„åˆ™æ¡ä»¶æ ¼å¼ä¸ç»Ÿä¸€
   - âŒ ç¼ºå°‘è§„åˆ™åŒ¹é…çš„éªŒè¯æµ‹è¯•

#### è§£å†³æ–¹æ¡ˆ
1. **ä¿®æ”¹ `formula_analysis.py`**ï¼š
   - ç§»é™¤ `FormulaRuleService` ç‰¹æ®Šå¤„ç†
   - ç»Ÿä¸€ä½¿ç”¨ `RuleService` åŒ¹é…æ‰€æœ‰è§„åˆ™ï¼ˆåŒ…æ‹¬åç¥å‘½æ ¼ï¼‰

2. **å¢å¼º `rule_condition.py`**ï¼š
   - å¢å¼º `hidden_stars_in_*` æ¡ä»¶å¤„ç†
   - æ”¯æŒè§£ææ–‡æœ¬æè¿°ï¼ˆå¦‚"æ—¥æŸ±å‰¯æ˜Ÿæœ‰æ­£è´¢"ï¼‰å¹¶æ£€æŸ¥å¯¹åº”æŸ±

#### é¢„é˜²æªæ–½
1. **è§„èŒƒæ›´æ–°**ï¼š
   - âœ… æ‰€æœ‰è§„åˆ™å¿…é¡»ä½¿ç”¨ `RuleService` åŒ¹é…
   - âœ… è§„åˆ™æ¡ä»¶æ ¼å¼å¿…é¡»ç»Ÿä¸€ä¸º JSON
   - âœ… æ–°å¢è§„åˆ™ç±»å‹å¿…é¡»åŒæ­¥æ›´æ–°å‰åç«¯

2. **æ£€æŸ¥æ¸…å•**ï¼š
   - [ ] æ–°è§„åˆ™ç±»å‹æ˜¯å¦ä½¿ç”¨ `RuleService` åŒ¹é…
   - [ ] è§„åˆ™æ¡ä»¶æ ¼å¼æ˜¯å¦ç¬¦åˆ JSON è§„èŒƒ
   - [ ] å‰åç«¯æ˜¯å¦åŒæ­¥æ”¯æŒæ–°è§„åˆ™ç±»å‹
   - [ ] æ˜¯å¦ç¼–å†™äº†è§„åˆ™åŒ¹é…æµ‹è¯•

3. **ä»£ç å®¡æŸ¥**ï¼š
   - æ£€æŸ¥æ‰€æœ‰ä½¿ç”¨ `FormulaRuleService` çš„ä»£ç 
   - æ£€æŸ¥è§„åˆ™æ¡ä»¶æ ¼å¼æ˜¯å¦ç»Ÿä¸€
   - æ£€æŸ¥è§„åˆ™åŒ¹é…é€»è¾‘æ˜¯å¦å®Œæ•´

---

### é—®é¢˜1ï¼šæ•°æ®åº“åé…ç½®é”™è¯¯

**ç—‡çŠ¶**ï¼š`Unknown database 'bazi_system'`

**åŸå› **ï¼š`server/config/mysql_config.py` ä¸­é»˜è®¤æ•°æ®åº“åä¸æ­£ç¡®

**è§£å†³**ï¼šè§ä¸‹æ–¹"æ•°æ®åº“é…ç½®é»˜è®¤å€¼"è§„èŒƒ

**é¢„é˜²**ï¼šæ£€æŸ¥ `env.template` ä¸­çš„ `MYSQL_DATABASE` å€¼ï¼Œç¡®ä¿é»˜è®¤å€¼ä¸å®é™…æ•°æ®åº“ä¸€è‡´

---

### é—®é¢˜2ï¼šè§„åˆ™IDåŒ…å«ä¸­æ–‡å¯¼è‡´è§£æå¤±è´¥

**ç—‡çŠ¶**ï¼š
```
invalid literal for int() with base 10: 'è´¢å¯Œ_20106'
```

**åŸå› **ï¼šè§„åˆ™IDæ ¼å¼ä¸ç»Ÿä¸€ï¼ˆ`FORMULA_80001` vs `FORMULA_è´¢å¯Œ_20106`ï¼‰

**è§£å†³**ï¼š
```python
# å…¼å®¹ä¸¤ç§æ ¼å¼
try:
    numeric_id = int(original_id)
except ValueError:
    parts = original_id.rsplit('_', 1)
    if len(parts) == 2 and parts[1].isdigit():
        numeric_id = int(parts[1])
    else:
        numeric_id = hash(original_id) % 1000000
```

**é¢„é˜²**ï¼š
- å¯¼å…¥æ—¶ç»Ÿä¸€ä½¿ç”¨ `FORMULA_ç±»å‹_ç¼–å·` æ ¼å¼
- åœ¨æ•°æ®åº“ä¸­ä¿æŒ `rule_type` å­—æ®µä¸ºè‹±æ–‡

---

### é—®é¢˜3ï¼šè§„åˆ™ç±»å‹ä¸ä¸€è‡´

**ç—‡çŠ¶**ï¼šå‰ç«¯æ˜¾ç¤ºä¸å‡ºæ–°å¢çš„è§„åˆ™ç±»å‹ï¼ˆå¦‚äº‹ä¸šã€å­å¥³ï¼‰

**åŸå› **ï¼šæ•°æ®åº“ `rule_type` å­—æ®µå€¼ä¸ç»Ÿä¸€ï¼ˆ`formula_career` vs `career`ï¼‰

**è§£å†³**ï¼šè§ä¸‹æ–¹"è§„åˆ™ç±»å‹å‘½å"è§„èŒƒ

**é¢„é˜²**ï¼šå¯¼å…¥è„šæœ¬ä¸­ä½¿ç”¨ç»Ÿä¸€çš„è‹±æ–‡ç±»å‹åï¼Œä¸è¦ä½¿ç”¨ `formula_` å‰ç¼€

---

### é—®é¢˜4ï¼šå‰ç«¯ç±»å‹æ ‡ç­¾ç¼ºå¤±

**ç—‡çŠ¶**ï¼šå‰ç«¯é¡µé¢æ²¡æœ‰æ˜¾ç¤ºæ–°ç±»å‹çš„æ ‡ç­¾é¡µ

**åŸå› **ï¼š`local_frontend/formula-analysis.html` ä¸­ `typeLabels` æœªå®šä¹‰æ–°ç±»å‹

**è§£å†³**ï¼šåœ¨ `typeLabels` ä¸­æ·»åŠ æ–°ç±»å‹æ˜ å°„ï¼ˆå‚è€ƒä¸Šæ–¹"ç±»å‹æ˜ å°„"è¡¨æ ¼ï¼‰

**é¢„é˜²**ï¼šæ–°å¢è§„åˆ™ç±»å‹æ—¶åŒæ­¥æ›´æ–°å‰ç«¯ `typeLabels` å’Œ `displayStatistics` å‡½æ•°

---

### é—®é¢˜5ï¼šæ–°æ¡ä»¶ç±»å‹ä¸æ”¯æŒ

**ç—‡çŠ¶**ï¼šè§„åˆ™æ— æ³•åŒ¹é…ï¼Œæ—¥å¿—æ˜¾ç¤ºæ¡ä»¶æœªå¤„ç†

**åŸå› **ï¼š`rule_condition.py` ä¸­æœªå®ç°å¯¹åº”æ¡ä»¶ç±»å‹

**è§£å†³**ï¼šåœ¨ `EnhancedRuleCondition.match` ä¸­æ·»åŠ æ¡ä»¶å¤„ç†é€»è¾‘

**é¢„é˜²**ï¼š
- å¯¼å…¥å‰æ£€æŸ¥æ‰€æœ‰æ¡ä»¶ç±»å‹æ˜¯å¦å·²æ”¯æŒ
- ä¸æ”¯æŒçš„æ¡ä»¶å…ˆæ‰©å±•è§„åˆ™å¼•æ“å†å¯¼å…¥

---

### é—®é¢˜6ï¼šgRPC ç«¯ç‚¹æœªæ³¨å†Œ

**ç—‡çŠ¶**ï¼šå‰ç«¯è°ƒç”¨ API è¿”å›é”™è¯¯æˆ–æ— å“åº”

**åŸå› **ï¼š`grpc_gateway.py` ä¸­æœªæ³¨å†Œå¯¹åº”ç«¯ç‚¹

**è§£å†³**ï¼š
```python
# åœ¨ grpc_gateway.py ä¸­æ³¨å†Œ
@_register("/bazi/new-feature")
async def _handle_new_feature(payload: Dict[str, Any]):
    request_model = NewFeatureRequest(**payload)
    return await new_feature(request_model)
```

**é¢„é˜²**ï¼š
- æ–°å¢ API æ—¶å¿…é¡»åŒæ—¶æ³¨å†Œ gRPC ç«¯ç‚¹
- æµ‹è¯•æ—¶éªŒè¯ gRPC-Web è°ƒç”¨æ˜¯å¦æ­£å¸¸

---

## ğŸ“ é¡¹ç›®æ¶æ„

### å‰ç«¯æ¶æ„ `local_frontend/`
```
local_frontend/
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ api.js                  # gRPC-Web å®¢æˆ·ç«¯ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”œâ”€â”€ config.js               # API é…ç½®
â”‚   â”œâ”€â”€ fortune.js              # è¿åŠ¿æ•°æ®é€»è¾‘
â”‚   â”œâ”€â”€ fortune-timeline.js     # è¿åŠ¿ UI æ¸²æŸ“
â”‚   â””â”€â”€ ...
â”œâ”€â”€ css/                        # æ ·å¼æ–‡ä»¶
â””â”€â”€ *.html                      # é¡µé¢æ–‡ä»¶
```

**âš ï¸ é‡è¦è¯´æ˜**ï¼š
- **`local_frontend/`** æ˜¯æœ¬åœ°å‰ç«¯ç›®å½•ï¼Œç”¨äºæœ¬åœ°å¼€å‘ã€æµ‹è¯•ç¯å¢ƒã€åŒæœºéƒ¨ç½²
- **ç”Ÿäº§å‰ç«¯**ç”±å‰ç«¯å›¢é˜Ÿç‹¬ç«‹éƒ¨ç½²ï¼Œä¸åœ¨æ­¤ä»“åº“ä¸­
- æ‰€æœ‰é…ç½®æ–‡ä»¶å’Œè„šæœ¬å¿…é¡»ä½¿ç”¨ `local_frontend` è·¯å¾„

### åç«¯æ¶æ„ `server/`
```
server/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ grpc_gateway.py         # gRPC-Web ç½‘å…³ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â””â”€â”€ v1/                     # REST API
â”‚       â”œâ”€â”€ formula_analysis.py # ç®—æ³•å…¬å¼åˆ†æ
â”‚       â””â”€â”€ ...
â”œâ”€â”€ services/                   # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ rule_service.py         # è§„åˆ™åŒ¹é…æœåŠ¡
â”‚   â””â”€â”€ ...
â”œâ”€â”€ engines/                    # è§„åˆ™å¼•æ“
â”‚   â”œâ”€â”€ rule_engine.py          # æ ¸å¿ƒå¼•æ“
â”‚   â””â”€â”€ rule_condition.py       # æ¡ä»¶åŒ¹é…ï¼ˆæ‰©å±•ç‚¹ï¼‰
â”œâ”€â”€ config/
â”‚   â””â”€â”€ mysql_config.py         # MySQL é…ç½®ï¼ˆæ³¨æ„é»˜è®¤å€¼ï¼‰
â””â”€â”€ db/                         # æ•°æ®åº“è¿æ¥
```

### å¾®æœåŠ¡æ¶æ„ `services/`
```
services/
â”œâ”€â”€ bazi_core/                  # å…«å­—æ ¸å¿ƒæœåŠ¡ (gRPC 9001)
â”œâ”€â”€ bazi_fortune/               # è¿åŠ¿æœåŠ¡ (gRPC 9002)
â”œâ”€â”€ bazi_analyzer/              # å…«å­—åˆ†æ (gRPC 9003)
â”œâ”€â”€ bazi_rule/                  # è§„åˆ™åŒ¹é… (gRPC 9004)
â”œâ”€â”€ fortune_analysis/           # è¿åŠ¿åˆ†æ (gRPC 9005)
â”œâ”€â”€ payment_service/            # æ”¯ä»˜æœåŠ¡ (gRPC 9006)
â”œâ”€â”€ fortune_rule/               # è¿åŠ¿è§„åˆ™ (gRPC 9007)
â”œâ”€â”€ intent_service/             # æ„å›¾è¯†åˆ« (gRPC 9008)
â”œâ”€â”€ prompt_optimizer/           # æç¤ºä¼˜åŒ– (gRPC 9009)
â””â”€â”€ desk_fengshui/              # é£æ°´åˆ†æ (gRPC 9010)
```

**æœåŠ¡ç«¯å£æ¸…å•**ï¼š
| æœåŠ¡ | ç«¯å£ | ç”¨é€” |
|------|------|------|
| Web æœåŠ¡ | 8001 | HTTP + gRPC-Web ç½‘å…³ |
| bazi-core | 9001 | å…«å­—æ ¸å¿ƒè®¡ç®— |
| bazi-fortune | 9002 | è¿åŠ¿è®¡ç®— |
| bazi-analyzer | 9003 | å…«å­—åˆ†æ |
| bazi-rule | 9004 | è§„åˆ™åŒ¹é… |
| fortune-analysis | 9005 | è¿åŠ¿åˆ†æ |
| payment | 9006 | æ”¯ä»˜æœåŠ¡ |
| fortune-rule | 9007 | è¿åŠ¿è§„åˆ™ |
| intent | 9008 | æ„å›¾è¯†åˆ« |
| optimizer | 9009 | æç¤ºä¼˜åŒ– |
| desk-fengshui | 9010 | é£æ°´åˆ†æ |

### è„šæœ¬ç›®å½• `scripts/`
```
scripts/
â”œâ”€â”€ migration/                  # æ•°æ®è¿ç§»è„šæœ¬
â”‚   â”œâ”€â”€ import_2025_1128_rules.py   # è§„åˆ™å¯¼å…¥ç¤ºä¾‹
â”‚   â””â”€â”€ import_confirmed_rules.py   # ç¡®è®¤è§„åˆ™å¯¼å…¥
â”œâ”€â”€ db/                         # æ•°æ®åº“è„šæœ¬
â”‚   â””â”€â”€ sync_db.sh              # æ•°æ®åº“åŒæ­¥
â””â”€â”€ ...
```

---

## ğŸ”’ æ ¸å¿ƒæ–‡ä»¶ï¼ˆä¿®æ”¹å‰å¿…é¡»å’¨è¯¢ï¼‰

| æ–‡ä»¶ | ä½œç”¨ | é£é™© |
|------|------|------|
| `server/api/grpc_gateway.py` | gRPC-Web ç½‘å…³ | æé«˜ |
| `server/engines/rule_condition.py` | è§„åˆ™æ¡ä»¶åŒ¹é… | é«˜ |
| `server/config/mysql_config.py` | MySQL é…ç½® | é«˜ |
| `src/bazi_calculator.py` | æ ¸å¿ƒå…«å­—è®¡ç®— | æé«˜ |
| `local_frontend/js/api.js` | å‰ç«¯ gRPC å®¢æˆ·ç«¯ | é«˜ |
| `proto/*.proto` | gRPC åè®®å®šä¹‰ | é«˜ |

---

## ğŸ” å®‰å…¨è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

### ğŸ”´ å®‰å…¨å¼€å‘åŸåˆ™

> **å®‰å…¨æ˜¯æœ€é«˜ä¼˜å…ˆçº§ï¼Œæ‰€æœ‰ä»£ç å¿…é¡»éµå¾ªå®‰å…¨æœ€ä½³å®è·µã€‚**

| åŸåˆ™ | è¦æ±‚ | è¯´æ˜ |
|------|------|------|
| **æœ€å°æƒé™** | âœ… å¿…é¡» | åªæˆäºˆå¿…è¦çš„æƒé™ï¼Œç¦æ­¢è¿‡åº¦æˆæƒ |
| **è¾“å…¥éªŒè¯** | âœ… å¿…é¡» | æ‰€æœ‰ç”¨æˆ·è¾“å…¥å¿…é¡»éªŒè¯å’Œè¿‡æ»¤ |
| **è¾“å‡ºç¼–ç ** | âœ… å¿…é¡» | æ‰€æœ‰è¾“å‡ºå¿…é¡»æ­£ç¡®ç¼–ç ï¼Œé˜²æ­¢ XSS |
| **æ•æ„Ÿæ•°æ®ä¿æŠ¤** | âœ… å¿…é¡» | å¯†ç ã€å¯†é’¥ã€Token ç­‰å¿…é¡»åŠ å¯†å­˜å‚¨ |
| **é”™è¯¯å¤„ç†** | âœ… å¿…é¡» | ä¸æš´éœ²ç³»ç»Ÿå†…éƒ¨ä¿¡æ¯ç»™ç”¨æˆ· |
| **ä¾èµ–å®‰å…¨** | âœ… å¿…é¡» | å®šæœŸæ›´æ–°ä¾èµ–ï¼Œä¿®å¤å·²çŸ¥æ¼æ´ |

---

### ğŸ›¡ï¸ å¸¸è§å®‰å…¨æ¼æ´é˜²æŠ¤

#### 1. SQL æ³¨å…¥é˜²æŠ¤ ã€é«˜å±ã€‘

**ç¦æ­¢**ï¼š
```python
# âŒ é”™è¯¯ï¼šç›´æ¥æ‹¼æ¥ SQL
query = f"SELECT * FROM users WHERE id = {user_id}"
cursor.execute(query)

# âŒ é”™è¯¯ï¼šä½¿ç”¨ % æ ¼å¼åŒ–
cursor.execute("SELECT * FROM users WHERE name = '%s'" % user_name)
```

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
cursor.execute("SELECT * FROM users WHERE name = %s AND age = %s", (user_name, age))

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ ORMï¼ˆSQLAlchemyï¼‰
from server.config.mysql_config import get_mysql_connection
with get_mysql_connection() as conn:
    result = conn.execute(
        text("SELECT * FROM users WHERE id = :id"),
        {"id": user_id}
    )
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ‰€æœ‰ SQL æŸ¥è¯¢ä½¿ç”¨å‚æ•°åŒ–
- [ ] ç¦æ­¢å­—ç¬¦ä¸²æ‹¼æ¥æ„å»º SQL
- [ ] ä½¿ç”¨ ORM æˆ–å‚æ•°åŒ–æŸ¥è¯¢æ¥å£

---

#### 2. XSSï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰é˜²æŠ¤ ã€é«˜å±ã€‘

**ç¦æ­¢**ï¼š
```python
# âŒ é”™è¯¯ï¼šç›´æ¥è¾“å‡ºç”¨æˆ·è¾“å…¥
return f"<div>{user_input}</div>"

# âŒ é”™è¯¯ï¼šåœ¨ JavaScript ä¸­ç›´æ¥åµŒå…¥
return f"<script>var data = '{user_data}';</script>"
```

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨æ¨¡æ¿å¼•æ“è‡ªåŠ¨è½¬ä¹‰ï¼ˆFastAPI + Jinja2ï¼‰
from fastapi.templating import Jinja2Templates
templates = Jinja2Templates(directory="templates")
return templates.TemplateResponse("page.html", {
    "request": request,
    "user_input": user_input  # è‡ªåŠ¨è½¬ä¹‰
})

# âœ… æ­£ç¡®ï¼šæ‰‹åŠ¨è½¬ä¹‰ï¼ˆå¦‚éœ€è¦ï¼‰
import html
safe_output = html.escape(user_input)

# âœ… æ­£ç¡®ï¼šJSON è¾“å‡ºï¼ˆè‡ªåŠ¨è½¬ä¹‰ï¼‰
from fastapi.responses import JSONResponse
return JSONResponse({"data": user_input})  # è‡ªåŠ¨è½¬ä¹‰
```

**å‰ç«¯é˜²æŠ¤**ï¼š
```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ textContent è€Œä¸æ˜¯ innerHTML
element.textContent = userInput;

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ DOMPurify æ¸…ç† HTML
import DOMPurify from 'dompurify';
element.innerHTML = DOMPurify.sanitize(userInput);
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ‰€æœ‰ç”¨æˆ·è¾“å…¥åœ¨è¾“å‡ºå‰è½¬ä¹‰
- [ ] ä½¿ç”¨æ¨¡æ¿å¼•æ“è‡ªåŠ¨è½¬ä¹‰
- [ ] å‰ç«¯ä½¿ç”¨å®‰å…¨çš„ DOM æ“ä½œæ–¹å¼

---

#### 3. CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰é˜²æŠ¤ ã€é«˜å±ã€‘

**åç«¯é˜²æŠ¤**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ CSRF Tokenï¼ˆFastAPIï¼‰
from fastapi_csrf_protect import CsrfProtect
from fastapi_csrf_protect.exceptions import CsrfProtectError

@router.post("/api/v1/sensitive-action")
async def sensitive_action(
    request: Request,
    csrf_protect: CsrfProtect = Depends()
):
    await csrf_protect.validate_csrf(request)
    # å¤„ç†è¯·æ±‚
    ...

# âœ… æ­£ç¡®ï¼šæ£€æŸ¥ Referer å¤´
referer = request.headers.get("referer")
if not referer or not referer.startswith("https://yourdomain.com"):
    raise HTTPException(status_code=403, detail="Invalid referer")
```

**å‰ç«¯é˜²æŠ¤**ï¼š
```javascript
// âœ… æ­£ç¡®ï¼šä»åç«¯è·å– CSRF Token
const csrfToken = await fetch('/api/csrf-token').then(r => r.json());

// âœ… æ­£ç¡®ï¼šåœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ Token
fetch('/api/v1/sensitive-action', {
    method: 'POST',
    headers: {
        'X-CSRF-Token': csrfToken,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
});
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ‰€æœ‰ä¿®æ”¹æ“ä½œéœ€è¦ CSRF Token
- [ ] éªŒè¯ Referer å¤´ï¼ˆå¯é€‰ï¼Œä½œä¸ºé¢å¤–ä¿æŠ¤ï¼‰
- [ ] ä½¿ç”¨ SameSite Cookie å±æ€§

---

#### 4. æ•æ„Ÿä¿¡æ¯æ³„éœ²é˜²æŠ¤ ã€é«˜å±ã€‘

**ç¦æ­¢**ï¼š
```python
# âŒ é”™è¯¯ï¼šåœ¨é”™è¯¯ä¿¡æ¯ä¸­æš´éœ²ç³»ç»Ÿä¿¡æ¯
except Exception as e:
    return {"error": f"Database error: {str(e)}"}  # æš´éœ²æ•°æ®åº“ç»“æ„

# âŒ é”™è¯¯ï¼šåœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯
logger.info(f"User login: {username}, password: {password}")

# âŒ é”™è¯¯ï¼šåœ¨å“åº”ä¸­è¿”å›æ•æ„Ÿå­—æ®µ
return {"user": {"id": 1, "password": "hashed_password", "api_key": "xxx"}}
```

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… æ­£ç¡®ï¼šé€šç”¨é”™è¯¯ä¿¡æ¯
except Exception as e:
    logger.error(f"Database error: {e}", exc_info=True)  # è®°å½•è¯¦ç»†æ—¥å¿—
    return {"error": "æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"}  # ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯

# âœ… æ­£ç¡®ï¼šä¸è®°å½•æ•æ„Ÿä¿¡æ¯
logger.info(f"User login: {username}")  # ä¸è®°å½•å¯†ç 

# âœ… æ­£ç¡®ï¼šè¿‡æ»¤æ•æ„Ÿå­—æ®µ
def sanitize_user_data(user):
    return {
        "id": user.id,
        "username": user.username,
        # ä¸è¿”å› password, api_key ç­‰æ•æ„Ÿå­—æ®µ
    }
```

**ç¯å¢ƒå˜é‡ä¿æŠ¤**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä¸æäº¤åˆ°ä»£ç åº“
import os
from dotenv import load_dotenv

load_dotenv()
SECRET_KEY = os.getenv("SECRET_KEY")  # ä» .env è¯»å–
DATABASE_PASSWORD = os.getenv("MYSQL_PASSWORD")

# âŒ é”™è¯¯ï¼šç¡¬ç¼–ç å¯†é’¥
SECRET_KEY = "my-secret-key-12345"  # ç¦æ­¢ï¼
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] é”™è¯¯ä¿¡æ¯ä¸æš´éœ²ç³»ç»Ÿå†…éƒ¨ä¿¡æ¯
- [ ] æ—¥å¿—ä¸è®°å½•å¯†ç ã€Token ç­‰æ•æ„Ÿä¿¡æ¯
- [ ] API å“åº”ä¸è¿”å›æ•æ„Ÿå­—æ®µ
- [ ] æ‰€æœ‰å¯†é’¥ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä¸æäº¤åˆ°ä»£ç åº“

---

#### 5. èº«ä»½è®¤è¯ä¸æˆæƒé˜²æŠ¤ ã€é«˜å±ã€‘

**å¯†ç å®‰å…¨**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ bcrypt åŠ å¯†å¯†ç 
import bcrypt

def hash_password(password: str) -> str:
    salt = bcrypt.gensalt()
    hashed = bcrypt.hashpw(password.encode('utf-8'), salt)
    return hashed.decode('utf-8')

def verify_password(password: str, hashed: str) -> bool:
    return bcrypt.checkpw(password.encode('utf-8'), hashed.encode('utf-8'))

# âŒ é”™è¯¯ï¼šæ˜æ–‡å­˜å‚¨å¯†ç 
user.password = password  # ç¦æ­¢ï¼
```

**Token å®‰å…¨**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ JWTï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
import jwt
from datetime import datetime, timedelta

def generate_token(user_id: int) -> str:
    payload = {
        "user_id": user_id,
        "exp": datetime.utcnow() + timedelta(hours=24),  # 24å°æ—¶è¿‡æœŸ
        "iat": datetime.utcnow()
    }
    return jwt.encode(payload, SECRET_KEY, algorithm="HS256")

# âœ… æ­£ç¡®ï¼šéªŒè¯ Token
def verify_token(token: str) -> dict:
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=["HS256"])
        return payload
    except jwt.ExpiredSignatureError:
        raise HTTPException(status_code=401, detail="Token å·²è¿‡æœŸ")
    except jwt.InvalidTokenError:
        raise HTTPException(status_code=401, detail="æ— æ•ˆçš„ Token")
```

**æƒé™æ£€æŸ¥**ï¼š
```python
# âœ… æ­£ç¡®ï¼šæ¯ä¸ªæ“ä½œéƒ½æ£€æŸ¥æƒé™
@router.post("/api/v1/admin/delete-user")
async def delete_user(user_id: int, current_user: User = Depends(get_current_user)):
    # æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
    if not current_user.is_admin:
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    # æ‰§è¡Œåˆ é™¤æ“ä½œ
    ...
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] å¯†ç å¿…é¡»åŠ å¯†å­˜å‚¨ï¼ˆbcrypt/argon2ï¼‰
- [ ] Token è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- [ ] æ‰€æœ‰æ•æ„Ÿæ“ä½œéªŒè¯ç”¨æˆ·èº«ä»½
- [ ] æ‰€æœ‰æ“ä½œæ£€æŸ¥ç”¨æˆ·æƒé™

---

#### 6. æ–‡ä»¶ä¸Šä¼ å®‰å…¨é˜²æŠ¤ ã€é«˜å±ã€‘

**ç¦æ­¢**ï¼š
```python
# âŒ é”™è¯¯ï¼šä¸éªŒè¯æ–‡ä»¶ç±»å‹
@router.post("/upload")
async def upload(file: UploadFile):
    content = await file.read()
    with open(f"uploads/{file.filename}", "wb") as f:
        f.write(content)  # å±é™©ï¼å¯èƒ½ä¸Šä¼ æ¶æ„æ–‡ä»¶
```

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… æ­£ç¡®ï¼šéªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
from fastapi import UploadFile, File
import magic  # æˆ–ä½¿ç”¨ python-magic

ALLOWED_MIME_TYPES = ["image/jpeg", "image/png", "image/webp"]
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10MB

@router.post("/upload")
async def upload(file: UploadFile = File(...)):
    # 1. æ£€æŸ¥æ–‡ä»¶å¤§å°
    content = await file.read()
    if len(content) > MAX_FILE_SIZE:
        raise HTTPException(status_code=400, detail="æ–‡ä»¶è¿‡å¤§")
    
    # 2. éªŒè¯æ–‡ä»¶ç±»å‹ï¼ˆä½¿ç”¨ MIME ç±»å‹ï¼Œä¸ä¾èµ–æ‰©å±•åï¼‰
    mime_type = magic.from_buffer(content, mime=True)
    if mime_type not in ALLOWED_MIME_TYPES:
        raise HTTPException(status_code=400, detail="ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹")
    
    # 3. ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶åï¼ˆé˜²æ­¢è·¯å¾„éå†ï¼‰
    import uuid
    import os
    safe_filename = f"{uuid.uuid4()}.{mime_type.split('/')[1]}"
    safe_path = os.path.join("uploads", safe_filename)
    
    # 4. ä¿å­˜æ–‡ä»¶
    with open(safe_path, "wb") as f:
        f.write(content)
    
    return {"filename": safe_filename}
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] éªŒè¯æ–‡ä»¶ MIME ç±»å‹ï¼ˆä¸ä¾èµ–æ‰©å±•åï¼‰
- [ ] é™åˆ¶æ–‡ä»¶å¤§å°
- [ ] ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶åï¼ˆé˜²æ­¢è·¯å¾„éå†ï¼‰
- [ ] æ–‡ä»¶å­˜å‚¨åœ¨éš”ç¦»ç›®å½•ï¼Œä¸åœ¨ Web æ ¹ç›®å½•

---

#### 7. API é™æµé˜²æŠ¤ ã€ä¸­å±ã€‘

**é˜²æ­¢æš´åŠ›ç ´è§£å’Œ DDoS**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ slowapi é™æµ
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

limiter = Limiter(key_func=get_remote_address)

@router.post("/api/v1/login")
@limiter.limit("5/minute")  # æ¯åˆ†é’Ÿæœ€å¤š 5 æ¬¡
async def login(request: Request):
    # ç™»å½•é€»è¾‘
    ...

@router.post("/api/v1/bazi/calculate")
@limiter.limit("100/hour")  # æ¯å°æ—¶æœ€å¤š 100 æ¬¡
async def calculate_bazi(request: Request):
    # è®¡ç®—é€»è¾‘
    ...
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] ç™»å½•æ¥å£è®¾ç½®ä¸¥æ ¼é™æµï¼ˆå¦‚ 5æ¬¡/åˆ†é’Ÿï¼‰
- [ ] è®¡ç®—æ¥å£è®¾ç½®åˆç†é™æµï¼ˆå¦‚ 100æ¬¡/å°æ—¶ï¼‰
- [ ] ä½¿ç”¨ IP åœ°å€ä½œä¸ºé™æµé”®

---

#### 8. ä¾èµ–å®‰å…¨æ›´æ–° ã€ä¸­å±ã€‘

**å®šæœŸæ£€æŸ¥ä¾èµ–æ¼æ´**ï¼š
```bash
# âœ… ä½¿ç”¨å®‰å…¨æ‰«æå·¥å…·
pip install safety
safety check

# âœ… ä½¿ç”¨ pip-auditï¼ˆPython å®˜æ–¹æ¨èï¼‰
pip install pip-audit
pip-audit

# âœ… å®šæœŸæ›´æ–°ä¾èµ–
pip list --outdated
pip install --upgrade package_name
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ¯æœˆæ£€æŸ¥ä¸€æ¬¡ä¾èµ–æ¼æ´
- [ ] åŠæ—¶æ›´æ–°æœ‰å®‰å…¨æ¼æ´çš„ä¾èµ–
- [ ] ä½¿ç”¨ `requirements.txt` å›ºå®šç‰ˆæœ¬å·
- [ ] è®°å½•ä¾èµ–æ›´æ–°æ—¥å¿—

---

#### 9. æ—¥å¿—å®‰å…¨ ã€ä¸­å±ã€‘

**ç¦æ­¢è®°å½•æ•æ„Ÿä¿¡æ¯**ï¼š
```python
# âŒ é”™è¯¯ï¼šè®°å½•æ•æ„Ÿä¿¡æ¯
logger.info(f"User {username} login with password {password}")
logger.debug(f"API Key: {api_key}")

# âœ… æ­£ç¡®ï¼šä¸è®°å½•æ•æ„Ÿä¿¡æ¯
logger.info(f"User {username} login successful")
logger.debug(f"API Key: {api_key[:10]}...")  # åªè®°å½•éƒ¨åˆ†
```

**æ—¥å¿—è®¿é—®æ§åˆ¶**ï¼š
```python
# âœ… æ­£ç¡®ï¼šæ—¥å¿—æ–‡ä»¶æƒé™æ§åˆ¶
# æ—¥å¿—æ–‡ä»¶åªå…è®¸åº”ç”¨ç”¨æˆ·è®¿é—®
chmod 600 logs/app.log
chown app:app logs/app.log
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ—¥å¿—ä¸åŒ…å«å¯†ç ã€Tokenã€API Key
- [ ] æ—¥å¿—æ–‡ä»¶æƒé™è®¾ç½®ä¸º 600
- [ ] å®šæœŸæ¸…ç†æ—§æ—¥å¿—
- [ ] ç”Ÿäº§ç¯å¢ƒæ—¥å¿—çº§åˆ«è®¾ç½®ä¸º WARNING æˆ– ERROR

---

#### 10. é…ç½®å®‰å…¨ ã€ä¸­å±ã€‘

**ç¯å¢ƒå˜é‡ç®¡ç†**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ .env æ–‡ä»¶ï¼ˆä¸æäº¤åˆ°ä»£ç åº“ï¼‰
# .env æ–‡ä»¶æ·»åŠ åˆ° .gitignore
# .env.example ä½œä¸ºæ¨¡æ¿æäº¤

# .env.example
SECRET_KEY=your-secret-key-here
MYSQL_PASSWORD=your-password-here
REDIS_PASSWORD=your-redis-password

# .envï¼ˆä¸æäº¤ï¼‰
SECRET_KEY=actual-secret-key-12345
MYSQL_PASSWORD=actual-password-12345
```

**é…ç½®æ–‡ä»¶å®‰å…¨**ï¼š
```python
# âœ… æ­£ç¡®ï¼šæ•æ„Ÿé…ç½®ä»ç¯å¢ƒå˜é‡è¯»å–
import os
from dotenv import load_dotenv

load_dotenv()
SECRET_KEY = os.getenv("SECRET_KEY")
if not SECRET_KEY:
    raise ValueError("SECRET_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®")

# âŒ é”™è¯¯ï¼šç¡¬ç¼–ç é…ç½®
SECRET_KEY = "hardcoded-secret-key"  # ç¦æ­¢ï¼
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] `.env` æ–‡ä»¶æ·»åŠ åˆ° `.gitignore`
- [ ] æä¾› `.env.example` ä½œä¸ºæ¨¡æ¿
- [ ] æ‰€æœ‰æ•æ„Ÿé…ç½®ä»ç¯å¢ƒå˜é‡è¯»å–
- [ ] ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¼ºå¯†ç å’Œå¯†é’¥

---

### ğŸ” å®‰å…¨ä»£ç å®¡æŸ¥æ¸…å•

æ¯æ¬¡æäº¤ä»£ç å‰ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

#### è¾“å…¥éªŒè¯
- [ ] æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡éªŒè¯
- [ ] éªŒè¯æ•°æ®ç±»å‹ã€é•¿åº¦ã€æ ¼å¼
- [ ] ç¦æ­¢ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥æ„å»º SQL/å‘½ä»¤

#### è¾“å‡ºç¼–ç 
- [ ] æ‰€æœ‰è¾“å‡ºéƒ½æ­£ç¡®ç¼–ç 
- [ ] é˜²æ­¢ XSS æ”»å‡»
- [ ] JSON è¾“å‡ºä½¿ç”¨ `ensure_ascii=False` æ—¶ç¡®ä¿å®‰å…¨

#### èº«ä»½è®¤è¯
- [ ] å¯†ç åŠ å¯†å­˜å‚¨
- [ ] Token è®¾ç½®è¿‡æœŸæ—¶é—´
- [ ] æ•æ„Ÿæ“ä½œéªŒè¯ç”¨æˆ·èº«ä»½

#### æƒé™æ§åˆ¶
- [ ] æ¯ä¸ªæ“ä½œæ£€æŸ¥ç”¨æˆ·æƒé™
- [ ] é˜²æ­¢è¶Šæƒè®¿é—®
- [ ] ä½¿ç”¨æœ€å°æƒé™åŸåˆ™

#### é”™è¯¯å¤„ç†
- [ ] ä¸æš´éœ²ç³»ç»Ÿå†…éƒ¨ä¿¡æ¯
- [ ] è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰
- [ ] è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯

#### ä¾èµ–å®‰å…¨
- [ ] å®šæœŸæ£€æŸ¥ä¾èµ–æ¼æ´
- [ ] åŠæ—¶æ›´æ–°æœ‰å®‰å…¨é—®é¢˜çš„ä¾èµ–
- [ ] ä½¿ç”¨å›ºå®šç‰ˆæœ¬å·

---

### ğŸš¨ å®‰å…¨äº‹ä»¶å“åº”

#### å‘ç°å®‰å…¨æ¼æ´æ—¶

1. **ç«‹å³å¤„ç†**
   - è¯„ä¼°æ¼æ´ä¸¥é‡ç¨‹åº¦ï¼ˆé«˜å±/ä¸­å±/ä½å±ï¼‰
   - ç«‹å³ä¿®å¤æˆ–ä¸´æ—¶ç¦ç”¨ç›¸å…³åŠŸèƒ½
   - é€šçŸ¥ç›¸å…³äººå‘˜

2. **ä¿®å¤æµç¨‹**
   - åˆ›å»ºä¿®å¤åˆ†æ”¯ï¼š`git checkout -b security/fix-xxx-vulnerability`
   - ä¿®å¤æ¼æ´å¹¶ç¼–å†™æµ‹è¯•
   - ä»£ç å®¡æŸ¥ï¼ˆé‡ç‚¹å…³æ³¨å®‰å…¨æ€§ï¼‰
   - åˆå¹¶åˆ°ä¸»åˆ†æ”¯å¹¶éƒ¨ç½²

3. **è®°å½•ä¸å¤ç›˜**
   - è®°å½•æ¼æ´è¯¦æƒ…å’Œä¿®å¤æ–¹æ¡ˆ
   - æ›´æ–°å®‰å…¨è§„èŒƒï¼Œé˜²æ­¢ç±»ä¼¼é—®é¢˜
   - æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç±»ä¼¼é—®é¢˜

---

### ğŸ“š å®‰å…¨èµ„æº

- **OWASP Top 10**ï¼šhttps://owasp.org/www-project-top-ten/
- **Python å®‰å…¨æœ€ä½³å®è·µ**ï¼šhttps://python.readthedocs.io/en/latest/library/security.html
- **FastAPI å®‰å…¨æ–‡æ¡£**ï¼šhttps://fastapi.tiangolo.com/tutorial/security/

---

**å®‰å…¨å¼€å‘æ ¸å¿ƒåŸåˆ™**ï¼š
- ğŸ”’ **é»˜è®¤æ‹’ç»**ï¼šé»˜è®¤æƒ…å†µä¸‹æ‹’ç»æ‰€æœ‰è®¿é—®ï¼Œåªå…è®¸æ˜ç¡®æˆæƒçš„æ“ä½œ
- ğŸ” **æ·±åº¦é˜²å¾¡**ï¼šå¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œä¸ä¾èµ–å•ä¸€å®‰å…¨æªæ–½
- ğŸ›¡ï¸ **æœ€å°æƒé™**ï¼šåªæˆäºˆå¿…è¦çš„æƒé™ï¼Œç¦æ­¢è¿‡åº¦æˆæƒ
- ğŸ“ **å®‰å…¨å®¡è®¡**ï¼šå®šæœŸå®¡æŸ¥ä»£ç å’Œé…ç½®ï¼ŒåŠæ—¶å‘ç°å®‰å…¨é—®é¢˜
- ğŸš¨ **å¿«é€Ÿå“åº”**ï¼šå‘ç°å®‰å…¨é—®é¢˜ç«‹å³å¤„ç†ï¼Œä¸æ‹–å»¶

## ğŸ  åŠå…¬æ¡Œé£æ°´æ¨¡å—ï¼ˆæ ¸å¿ƒæ¨¡å—ï¼Œç¦æ­¢éšæ„ä¿®æ”¹ï¼‰

### âš ï¸ é‡è¦è¯´æ˜

**åŠå…¬æ¡Œé£æ°´æ¨¡å—ï¼ˆ`services/desk_fengshui/`ï¼‰æ˜¯ç¨³å®šè¿è¡Œçš„æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼Œé™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼Œå¦åˆ™ç¦æ­¢ä¿®æ”¹æ­¤æ¨¡å—çš„ä»»ä½•ä»£ç ã€è§„åˆ™æˆ–é…ç½®ã€‚**

### æ¨¡å—é…ç½®

**æŠ€æœ¯æ ˆ**ï¼š
- **YOLOç‰ˆæœ¬**ï¼šYOLOv8ï¼ˆä¸æ˜¯YOLOv5ï¼‰
- **åº“**ï¼š`ultralytics>=8.0.0`
- **æ¨¡å‹æ–‡ä»¶**ï¼š`yolov8n.pt`ï¼ˆYOLOv8 nanoç‰ˆæœ¬ï¼‰
- **ç½®ä¿¡åº¦é˜ˆå€¼**ï¼š0.15
- **å¤‡ç”¨æ–¹æ¡ˆ**ï¼šOpenCVï¼ˆå½“YOLOæœªå®‰è£…æ—¶ï¼‰

**æ ¸å¿ƒæ–‡ä»¶**ï¼š
- `services/desk_fengshui/item_detector.py` - ç‰©å“æ£€æµ‹å™¨ï¼ˆYOLOv8ï¼‰
- `services/desk_fengshui/rule_engine.py` - é£æ°´è§„åˆ™å¼•æ“
- `services/desk_fengshui/position_calculator.py` - æ–¹ä½è®¡ç®—å™¨
- `services/desk_fengshui/analyzer.py` - ä¸»åˆ†æå™¨
- `services/desk_fengshui/bazi_client.py` - å…«å­—å®¢æˆ·ç«¯
- `services/desk_fengshui/requirements.txt` - ä¾èµ–é…ç½®

**è§„åˆ™ç³»ç»Ÿ**ï¼š
- è§„åˆ™å­˜å‚¨åœ¨MySQLæ•°æ®åº“ï¼ˆ`desk_fengshui_rules`è¡¨ï¼‰
- åŒ…å«é’é¾™ä½ã€ç™½è™ä½ã€æœ±é›€ä½ã€ç„æ­¦ä½ç­‰ä¼ ç»Ÿé£æ°´è§„åˆ™
- ç»“åˆå…«å­—å–œç”¨ç¥ã€å¿Œç¥è¿›è¡Œä¸ªæ€§åŒ–åˆ†æ

**ä¿®æ”¹åŸåˆ™**ï¼š
1. âŒ **ç¦æ­¢ä¿®æ”¹**ï¼šé™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚
2. âœ… **å…è®¸æ“ä½œ**ï¼šæŸ¥çœ‹ã€æµ‹è¯•ã€è°ƒè¯•
3. âš ï¸ **ä¿®æ”¹å‰å¿…é¡»**ï¼šå…ˆå’¨è¯¢ç”¨æˆ·ï¼Œè¯´æ˜å½±å“èŒƒå›´
4. ğŸ”’ **ä¿æŠ¤èŒƒå›´**ï¼šæ‰€æœ‰ `services/desk_fengshui/` ç›®å½•ä¸‹çš„æ–‡ä»¶

---

## ğŸ“ ä»£ç è§„èŒƒ

### æ•°æ®åº“é…ç½®é»˜è®¤å€¼
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨å®é™…çš„æ•°æ®åº“å
'database': os.getenv('MYSQL_DATABASE', 'hifate_bazi'),

# âŒ é”™è¯¯ï¼šä½¿ç”¨è¿‡æ—¶çš„æ•°æ®åº“å
'database': os.getenv('MYSQL_DATABASE', 'bazi_system'),
```
**ç›¸å…³é”™è¯¯**ï¼šè§"é—®é¢˜1ï¼šæ•°æ®åº“åé…ç½®é”™è¯¯"

### JSON åºåˆ—åŒ–
```python
# âœ… æ­£ç¡®ï¼šæ”¯æŒä¸­æ–‡
json.dumps(data, ensure_ascii=False)

# âŒ é”™è¯¯ï¼šä¸­æ–‡è¢«è½¬ä¹‰
json.dumps(data)  # è¾“å‡º \u4e2d\u6587
```

### è§„åˆ™ç±»å‹å‘½å
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨è‹±æ–‡å°å†™ï¼ˆå‚è€ƒä¸Šæ–¹"ç±»å‹æ˜ å°„"è¡¨æ ¼ï¼‰
rule_type = 'career'
rule_type = 'children'

# âŒ é”™è¯¯ï¼šä½¿ç”¨ä¸­æ–‡æˆ–å¸¦å‰ç¼€
rule_type = 'äº‹ä¸š'
rule_type = 'formula_career'  # ä¸è¦ä½¿ç”¨ formula_ å‰ç¼€
```
**ç›¸å…³é”™è¯¯**ï¼šè§"é—®é¢˜3ï¼šè§„åˆ™ç±»å‹ä¸ä¸€è‡´"ã€"é—®é¢˜4ï¼šå‰ç«¯ç±»å‹æ ‡ç­¾ç¼ºå¤±"

---

## ğŸš€ CI/CD æ ‡å‡†æµç¨‹ ã€å¿…é¡»éµå®ˆã€‘

### ğŸ”´ æ ¸å¿ƒåŸåˆ™

> **æ‰€æœ‰éƒ¨ç½²å¿…é¡»éµå¾ªæ ‡å‡† CI/CD æµç¨‹ï¼Œç¦æ­¢åœ¨æœåŠ¡å™¨ä¸Šç›´æ¥æ„å»ºé•œåƒã€‚**

### ğŸ“‹ æ ‡å‡†æµç¨‹

```
æœ¬åœ°å¼€å‘ â†’ æ¨é€åˆ° GitHub â†’ GitHub Actions æ„å»ºé•œåƒ â†’ æ¨é€åˆ° GHCR â†’ æœåŠ¡å™¨æ‹‰å–é•œåƒéƒ¨ç½²
```

| æ­¥éª¤ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| **1. æœ¬åœ°å¼€å‘** | åœ¨æœ¬åœ° Mac å¼€å‘ | ä¿®æ”¹ä»£ç ã€æµ‹è¯• |
| **2. æ¨é€åˆ° GitHub** | `git push origin master` | è§¦å‘ CI/CD |
| **3. è‡ªåŠ¨æ„å»ºé•œåƒ** | GitHub Actions æ‰§è¡Œ | `.github/workflows/build-and-push.yml` |
| **4. æ¨é€åˆ° GHCR** | è‡ªåŠ¨æ¨é€åˆ° GitHub Container Registry | é•œåƒæ ‡ç­¾ï¼š`ghcr.io/owner/repo/hifate-bazi:master` |
| **5. æœåŠ¡å™¨æ‹‰å–éƒ¨ç½²** | æœåŠ¡å™¨ä» GHCR æ‹‰å–é•œåƒ | `.github/workflows/deploy-test.yml` è‡ªåŠ¨éƒ¨ç½² |

### ğŸ”§ å·¥ä½œæµæ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ | è§¦å‘æ¡ä»¶ |
|------|------|---------|
| `.github/workflows/build-and-push.yml` | æ„å»ºé•œåƒå¹¶æ¨é€åˆ° GHCR | æ¨é€åˆ° `master` æˆ– `develop` åˆ†æ”¯ |
| `.github/workflows/deploy-test.yml` | éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ | æ¨é€åˆ° `master` åˆ†æ”¯ |
| `.github/workflows/deploy-production.yml` | éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ | æ¨é€åˆ° `master` åˆ†æ”¯ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰ |

### âœ… æ ‡å‡†æµç¨‹æ£€æŸ¥æ¸…å•

æ¯æ¬¡éƒ¨ç½²å‰å¿…é¡»æ£€æŸ¥ï¼š

- [ ] ä»£ç å·²æ¨é€åˆ° GitHub
- [ ] GitHub Actions æ„å»ºæˆåŠŸ
- [ ] é•œåƒå·²æ¨é€åˆ° GHCR
- [ ] æœåŠ¡å™¨æˆåŠŸæ‹‰å–é•œåƒ
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡

### ğŸš« ç¦æ­¢çš„æ“ä½œ

| æ“ä½œ | åŸå›  | æ­£ç¡®æ–¹å¼ |
|------|------|---------|
| âŒ åœ¨æœåŠ¡å™¨ä¸Šæ„å»ºé•œåƒ | å ç”¨æœåŠ¡å™¨èµ„æºã€æ„å»ºæ…¢ | ä½¿ç”¨ GitHub Actions æ„å»º |
| âŒ æ‰‹åŠ¨ä¸Šä¼ é•œåƒæ–‡ä»¶ | ä¸æ ‡å‡†ã€å®¹æ˜“å‡ºé”™ | ä½¿ç”¨ GHCR è‡ªåŠ¨æ¨é€ |
| âŒ ç›´æ¥ä¿®æ”¹æœåŠ¡å™¨ä»£ç  | æ— æ³•ç‰ˆæœ¬æ§åˆ¶ | æ¨é€åˆ° GitHubï¼Œè‡ªåŠ¨éƒ¨ç½² |

### ğŸ“ éƒ¨ç½²å‘½ä»¤

**æµ‹è¯•ç¯å¢ƒéƒ¨ç½²**ï¼ˆè‡ªåŠ¨ï¼‰ï¼š
```bash
# 1. æœ¬åœ°å¼€å‘å®Œæˆå
git add .
git commit -m "feat: æ–°åŠŸèƒ½"
git push origin master

# 2. GitHub Actions è‡ªåŠ¨æ‰§è¡Œï¼š
#    - build-and-push.yml: æ„å»ºé•œåƒå¹¶æ¨é€åˆ° GHCR
#    - deploy-test.yml: éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨ (123.57.216.15)
```

**ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰ï¼š
```bash
# 1. åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘ deploy-production.yml
# 2. æˆ–æ¨é€åˆ° master åˆ†æ”¯åï¼Œåœ¨ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘
```

### ğŸ” æ•…éšœæ’æŸ¥

**å¦‚æœéƒ¨ç½²å¤±è´¥**ï¼š
1. æŸ¥çœ‹ GitHub Actions æ—¥å¿—
2. æ£€æŸ¥é•œåƒæ˜¯å¦æˆåŠŸæ¨é€åˆ° GHCR
3. æ£€æŸ¥æœåŠ¡å™¨ SSH è¿æ¥
4. æ£€æŸ¥æœåŠ¡å™¨ç£ç›˜ç©ºé—´
5. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š`docker compose logs --tail=100`

---

## ğŸš€ å¢é‡éƒ¨ç½²è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

### ğŸ”´ æ ¸å¿ƒåŸåˆ™

> **å¢é‡éƒ¨ç½²é€šè¿‡çƒ­æ›´æ–°å®ç°é›¶åœæœºå¿«é€Ÿéƒ¨ç½²ï¼Œé€‚ç”¨äºæ—¥å¸¸ä»£ç æ›´æ–°ï¼Œå¿…é¡»ç»è¿‡å®Œæ•´çš„å®‰å…¨æ£€æŸ¥ã€‚**

### ğŸ“‹ å¢é‡éƒ¨ç½² vs å®Œæ•´éƒ¨ç½²å¯¹æ¯”

| å¯¹æ¯”é¡¹ | å®Œæ•´éƒ¨ç½²ï¼ˆCI/CDï¼‰ | å¢é‡éƒ¨ç½²ï¼ˆçƒ­æ›´æ–°ï¼‰ |
|--------|------------------|-------------------|
| **æ„å»ºé•œåƒ** | âœ… éœ€è¦ï¼ˆGitHub Actions æ„å»ºï¼‰ | âŒ ä¸éœ€è¦ï¼ˆç›´æ¥ä½¿ç”¨ä»£ç ï¼‰ |
| **å®¹å™¨é‡å¯** | âœ… éœ€è¦ï¼ˆ`docker-compose up -d`ï¼‰ | âŒ ä¸éœ€è¦ï¼ˆçƒ­æ›´æ–°ï¼‰ |
| **æœåŠ¡ä¸­æ–­** | âš ï¸ å¯èƒ½æœ‰çŸ­æš‚ä¸­æ–­ï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰ | âœ… é›¶ä¸­æ–­ |
| **éƒ¨ç½²é€Ÿåº¦** | æ…¢ï¼ˆ8-15åˆ†é’Ÿï¼‰ | å¿«ï¼ˆ30ç§’-2åˆ†é’Ÿï¼‰ |
| **é€‚ç”¨åœºæ™¯** | é¦–æ¬¡éƒ¨ç½²ã€ä¾èµ–å˜æ›´ã€Dockerfile å˜æ›´ | æ—¥å¸¸ä»£ç æ›´æ–°ã€è§„åˆ™æ›´æ–° |
| **èµ„æºæ¶ˆè€—** | é«˜ï¼ˆæ„å»ºé•œåƒã€ç½‘ç»œä¼ è¾“ï¼‰ | ä½ï¼ˆä»…ä»£ç æ›´æ–°ï¼‰ |
| **å›æ»šé€Ÿåº¦** | æ…¢ï¼ˆæ‹‰å–æ—§é•œåƒ+é‡å¯ï¼‰ | å¿«ï¼ˆçƒ­æ›´æ–°å›æ»šï¼Œç§’çº§ï¼‰ |

### ğŸ¯ é€‚ç”¨åœºæ™¯åˆ¤æ–­

#### âœ… ä½¿ç”¨å¢é‡éƒ¨ç½²çš„åœºæ™¯

1. **Python ä»£ç æ›´æ–°**
   - ä¸šåŠ¡é€»è¾‘ä¿®æ”¹
   - Bug ä¿®å¤
   - æ€§èƒ½ä¼˜åŒ–

2. **è§„åˆ™æ›´æ–°**
   - æ•°æ®åº“è§„åˆ™å˜æ›´
   - é…ç½®æ›´æ–°
   - ç¯å¢ƒå˜é‡æ›´æ–°

3. **å¾®æœåŠ¡ä»£ç ä¿®æ”¹**
   - å¾®æœåŠ¡é€»è¾‘æ›´æ–°
   - æœåŠ¡é—´è°ƒç”¨ä¼˜åŒ–

4. **æ—¥å¸¸è¿­ä»£**
   - å¿«é€Ÿå‘å¸ƒ
   - é¢‘ç¹æ›´æ–°

#### âŒ å¿…é¡»ä½¿ç”¨å®Œæ•´éƒ¨ç½²çš„åœºæ™¯

1. **ä¾èµ–å˜æ›´**
   - ä¿®æ”¹ `requirements.txt`
   - æ–°å¢ Python åŒ…
   - éœ€è¦é‡å»ºé•œåƒ

2. **Dockerfile å˜æ›´**
   - ä¿®æ”¹æ„å»ºæµç¨‹
   - ä¿®æ”¹åŸºç¡€é•œåƒ
   - éœ€è¦é‡æ–°æ„å»º

3. **é¦–æ¬¡éƒ¨ç½²**
   - éœ€è¦æ„å»ºå®Œæ•´é•œåƒ
   - éœ€è¦å®‰è£…æ‰€æœ‰ä¾èµ–

4. **é‡å¤§æ¶æ„å˜æ›´**
   - éœ€è¦å®Œæ•´éªŒè¯
   - éœ€è¦å›æ»šä¿éšœ

### ğŸ“‹ å¢é‡éƒ¨ç½²æ ‡å‡†æµç¨‹

```
1. æœ¬åœ°å¼€å‘ â†’ æäº¤ä»£ç 
   â†“
2. æ¨é€åˆ° GitHub
   â†“
3. è¿è¡Œå¢é‡éƒ¨ç½²è„šæœ¬
   â”œâ”€ éƒ¨ç½²å‰æ£€æŸ¥ï¼ˆè¯­æ³•ã€å¯¼å…¥ã€åˆ†æ”¯ç­‰ï¼‰
   â”œâ”€ æ‹‰å–ä»£ç åˆ°æœåŠ¡å™¨
   â”œâ”€ æœåŠ¡å™¨ç«¯éªŒè¯
   â”œâ”€ è§¦å‘çƒ­æ›´æ–°
   â””â”€ éƒ¨ç½²åéªŒè¯ï¼ˆå¥åº·æ£€æŸ¥ã€åŠŸèƒ½éªŒè¯ï¼‰
   â†“
4. å®Œæˆéƒ¨ç½²ï¼ˆé›¶åœæœºï¼‰
```

### ğŸ”’ å¢é‡éƒ¨ç½²å®‰å…¨æ£€æŸ¥

#### ç¬¬ä¸€å±‚ï¼šéƒ¨ç½²å‰æ£€æŸ¥ï¼ˆæœ¬åœ°ï¼‰

**å¿…é¡»æ£€æŸ¥é¡¹**ï¼š
- [ ] å½“å‰åˆ†æ”¯ä¸º `master`ï¼ˆæˆ–ç¡®è®¤åˆ†æ”¯ï¼‰
- [ ] æ— æœªæäº¤çš„æ›´æ”¹
- [ ] æ— æœªæ¨é€çš„æäº¤ï¼ˆæˆ–å…ˆæ¨é€ï¼‰
- [ ] Python è¯­æ³•éªŒè¯é€šè¿‡
- [ ] å…³é”®æ¨¡å—å¯¼å…¥éªŒè¯é€šè¿‡

**æ£€æŸ¥å‘½ä»¤**ï¼š
```bash
# æ£€æŸ¥åˆ†æ”¯
git rev-parse --abbrev-ref HEAD

# æ£€æŸ¥æœªæäº¤æ›´æ”¹
git status --porcelain

# è¯­æ³•éªŒè¯
python3 -c "import ast; import glob; [ast.parse(open(f).read()) for f in glob.glob('server/**/*.py', recursive=True)]"

# æ¨¡å—å¯¼å…¥éªŒè¯
python3 -c "from server.main import app; from server.services.rule_service import RuleService"
```

#### ç¬¬äºŒå±‚ï¼šæœåŠ¡å™¨ç«¯éªŒè¯

**å¿…é¡»æ£€æŸ¥é¡¹**ï¼š
- [ ] æœåŠ¡å™¨ SSH è¿æ¥æ­£å¸¸
- [ ] ä»£ç æ‹‰å–æˆåŠŸ
- [ ] æœåŠ¡å™¨ç«¯è¯­æ³•éªŒè¯é€šè¿‡
- [ ] çƒ­æ›´æ–°æœåŠ¡å¯ç”¨

**éªŒè¯å‘½ä»¤**ï¼š
```bash
# æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
curl -f http://8.210.52.217:8001/health

# æ£€æŸ¥çƒ­æ›´æ–°çŠ¶æ€
curl http://8.210.52.217:8001/api/v1/hot-reload/status
```

#### ç¬¬ä¸‰å±‚ï¼šéƒ¨ç½²åéªŒè¯

**å¿…é¡»æ£€æŸ¥é¡¹**ï¼š
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆNode1 å’Œ Node2ï¼‰
- [ ] çƒ­æ›´æ–°çŠ¶æ€æ­£å¸¸
- [ ] å…³é”®åŠŸèƒ½éªŒè¯é€šè¿‡ï¼ˆå¯é€‰ï¼‰

**éªŒè¯å‘½ä»¤**ï¼š
```bash
# å¥åº·æ£€æŸ¥
curl -f http://8.210.52.217:8001/health
curl -f http://47.243.160.43:8001/health

# åŠŸèƒ½éªŒè¯
curl -X POST http://8.210.52.217:8001/api/v1/bazi/calculate \
  -H "Content-Type: application/json" \
  -d '{"solar_date":"1990-01-15","solar_time":"12:00","gender":"male"}'
```

### ğŸš€ å¢é‡éƒ¨ç½²æ‰§è¡Œæ­¥éª¤

#### æ–¹å¼ 1ï¼šä½¿ç”¨å¢é‡éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. ç¡®ä¿ä»£ç å·²æäº¤å¹¶æ¨é€
git add .
git commit -m "feat: æ–°åŠŸèƒ½"
git push origin master

# 2. è¿è¡Œå¢é‡éƒ¨ç½²è„šæœ¬
bash deploy/scripts/incremental_deploy_production.sh
```

**è„šæœ¬åŠŸèƒ½**ï¼š
- âœ… è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰å®‰å…¨æ£€æŸ¥
- âœ… è‡ªåŠ¨æ‹‰å–ä»£ç åˆ°åŒæœº
- âœ… è‡ªåŠ¨è§¦å‘çƒ­æ›´æ–°
- âœ… è‡ªåŠ¨éªŒè¯éƒ¨ç½²ç»“æœ
- âœ… è‡ªåŠ¨å›æ»šï¼ˆå¦‚æœå¤±è´¥ï¼‰

#### æ–¹å¼ 2ï¼šæ‰‹åŠ¨å¢é‡éƒ¨ç½²

```bash
# 1. åœ¨ Node1 ä¸Šæ‹‰å–ä»£ç 
ssh root@8.210.52.217 "cd /opt/HiFate-bazi && git pull origin master"

# 2. åœ¨ Node2 ä¸Šæ‹‰å–ä»£ç 
ssh root@47.243.160.43 "cd /opt/HiFate-bazi && git pull origin master"

# 3. åœ¨ Node1 ä¸Šè§¦å‘çƒ­æ›´æ–°ï¼ˆè‡ªåŠ¨åŒæ­¥åˆ° Node2ï¼‰
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/sync

# 4. éªŒè¯éƒ¨ç½²ç»“æœ
curl http://8.210.52.217:8001/health
curl http://47.243.160.43:8001/health
```

### ğŸ”„ å¢é‡éƒ¨ç½²å›æ»šæœºåˆ¶

**è‡ªåŠ¨å›æ»šè§¦å‘æ¡ä»¶**ï¼š
- å¥åº·æ£€æŸ¥å¤±è´¥ï¼ˆ5æ¬¡é‡è¯•åï¼‰
- è¯­æ³•éªŒè¯å¤±è´¥
- æ¨¡å—å¯¼å…¥å¤±è´¥

**æ‰‹åŠ¨å›æ»š**ï¼š
```bash
# åœ¨ Node1 ä¸Šå›æ»š
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/rollback

# åœ¨ Node2 ä¸Šå›æ»š
curl -X POST http://47.243.160.43:8001/api/v1/hot-reload/rollback
```

**å›æ»šæœºåˆ¶**ï¼š
1. ä¼˜å…ˆä½¿ç”¨ä»£ç å¤‡ä»½ï¼ˆ`.hot_reload_backups/`ï¼‰
2. å¦‚æœå¤‡ä»½ä¸å¯ç”¨ï¼Œä½¿ç”¨ Git å›æ»š
3. è‡ªåŠ¨é‡æ–°åŠ è½½æ¨¡å—
4. éªŒè¯å›æ»šç»“æœ

### âœ… å¢é‡éƒ¨ç½²æ£€æŸ¥æ¸…å•

æ¯æ¬¡å¢é‡éƒ¨ç½²å‰å¿…é¡»æ£€æŸ¥ï¼š

#### ä»£ç è´¨é‡æ£€æŸ¥
- [ ] ä»£ç å·²æäº¤åˆ° Git
- [ ] ä»£ç å·²æ¨é€åˆ°è¿œç¨‹
- [ ] å½“å‰åˆ†æ”¯ä¸º `master`ï¼ˆæˆ–ç¡®è®¤åˆ†æ”¯ï¼‰
- [ ] æ— æœªæäº¤çš„æ›´æ”¹

#### è¯­æ³•å’Œå¯¼å…¥æ£€æŸ¥
- [ ] Python è¯­æ³•éªŒè¯é€šè¿‡ï¼ˆæœ¬åœ°ï¼‰
- [ ] Python è¯­æ³•éªŒè¯é€šè¿‡ï¼ˆæœåŠ¡å™¨ï¼‰
- [ ] å…³é”®æ¨¡å—å¯ä»¥å¯¼å…¥
- [ ] æ— å¾ªç¯ä¾èµ–

#### æœåŠ¡å™¨è¿æ¥æ£€æŸ¥
- [ ] Node1 SSH è¿æ¥æ­£å¸¸
- [ ] Node2 SSH è¿æ¥æ­£å¸¸
- [ ] Node1 æœåŠ¡å¯ç”¨ï¼ˆå¥åº·æ£€æŸ¥é€šè¿‡ï¼‰
- [ ] Node2 æœåŠ¡å¯ç”¨ï¼ˆå¥åº·æ£€æŸ¥é€šè¿‡ï¼‰

#### éƒ¨ç½²åéªŒè¯
- [ ] Node1 å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] Node2 å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] çƒ­æ›´æ–°çŠ¶æ€æ­£å¸¸
- [ ] å…³é”®åŠŸèƒ½éªŒè¯é€šè¿‡ï¼ˆå¯é€‰ï¼‰

### ğŸš¨ å¢é‡éƒ¨ç½²æ³¨æ„äº‹é¡¹

1. **ä»£ç å¿…é¡»å·²æ¨é€**
   - å¢é‡éƒ¨ç½²è„šæœ¬ä¼šæ‹‰å–è¿œç¨‹ä»£ç 
   - æœªæ¨é€çš„ä»£ç ä¸ä¼šè¢«éƒ¨ç½²

2. **ä¸é€‚ç”¨ä¾èµ–å˜æ›´**
   - ä¿®æ”¹ `requirements.txt` å¿…é¡»ä½¿ç”¨å®Œæ•´éƒ¨ç½²
   - æ–°å¢ç³»ç»Ÿä¾èµ–å¿…é¡»ä½¿ç”¨å®Œæ•´éƒ¨ç½²

3. **åŒæœºåŒæ­¥**
   - åœ¨ Node1 ä¸Šè§¦å‘çƒ­æ›´æ–°ä¼šè‡ªåŠ¨åŒæ­¥åˆ° Node2
   - ç¡®ä¿ Redis è¿æ¥æ­£å¸¸ï¼ˆç”¨äºåŒæœºåŒæ­¥ï¼‰

4. **ç›‘æ§å’Œå‘Šè­¦**
   - éƒ¨ç½²åæŒç»­ç›‘æ§æœåŠ¡çŠ¶æ€
   - å‘ç°é—®é¢˜ç«‹å³å›æ»š

5. **æµ‹è¯•ä¼˜å…ˆ**
   - é‡è¦å˜æ›´å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
   - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åç«‹å³éªŒè¯

### ğŸ“Š å¢é‡éƒ¨ç½²æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| **éƒ¨ç½²æ—¶é—´** | < 2åˆ†é’Ÿ | ä»æ‹‰å–ä»£ç åˆ°å®ŒæˆéªŒè¯ |
| **æœåŠ¡ä¸­æ–­** | 0ç§’ | é›¶åœæœºéƒ¨ç½² |
| **å›æ»šæ—¶é—´** | < 10ç§’ | çƒ­æ›´æ–°å›æ»šé€Ÿåº¦ |
| **æˆåŠŸç‡** | > 99% | éƒ¨ç½²æˆåŠŸç‡ |

### ğŸ” æ•…éšœæ’æŸ¥

**å¦‚æœå¢é‡éƒ¨ç½²å¤±è´¥**ï¼š

1. **æ£€æŸ¥ä»£ç è¯­æ³•**
   ```bash
   python3 -c "import ast; import glob; [ast.parse(open(f).read()) for f in glob.glob('server/**/*.py', recursive=True)]"
   ```

2. **æ£€æŸ¥çƒ­æ›´æ–°çŠ¶æ€**
   ```bash
   curl http://8.210.52.217:8001/api/v1/hot-reload/status
   ```

3. **æ£€æŸ¥æœåŠ¡æ—¥å¿—**
   ```bash
   ssh root@8.210.52.217 "docker logs hifate-web --tail 100"
   ```

4. **æ‰‹åŠ¨å›æ»š**
   ```bash
   curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/rollback
   ```

5. **æŸ¥çœ‹çƒ­æ›´æ–°é”™è¯¯æ—¥å¿—**
   ```bash
   ssh root@8.210.52.217 "cat /opt/HiFate-bazi/logs/hot_reload_errors/*.log | tail -50"
   ```

### ğŸ“š ç›¸å…³æ–‡æ¡£

- **å¢é‡éƒ¨ç½²è„šæœ¬**ï¼š`deploy/scripts/incremental_deploy_production.sh`
- **çƒ­æ›´æ–°ç³»ç»Ÿ**ï¼šè§"ğŸ”¥ çƒ­æ›´æ–°å¼ºåˆ¶è§„èŒƒ"ç« èŠ‚
- **å®Œæ•´éƒ¨ç½²æµç¨‹**ï¼šè§"ğŸš€ CI/CD æ ‡å‡†æµç¨‹"ç« èŠ‚

---

### ğŸ¯ éƒ¨ç½²æ–¹å¼é€‰æ‹©æŒ‡å—

**å¦‚ä½•é€‰æ‹©éƒ¨ç½²æ–¹å¼**ï¼š

```
ä»£ç å˜æ›´
    â†“
æ˜¯å¦éœ€è¦æ„å»ºé•œåƒï¼Ÿ
    â”œâ”€ æ˜¯ï¼ˆä¾èµ–å˜æ›´ã€Dockerfile å˜æ›´ï¼‰
    â”‚   â†“
    â”‚   ä½¿ç”¨å®Œæ•´éƒ¨ç½²ï¼ˆCI/CDï¼‰
    â”‚
    â””â”€ å¦ï¼ˆä»…ä»£ç æ›´æ–°ï¼‰
        â†“
        ä½¿ç”¨å¢é‡éƒ¨ç½²ï¼ˆçƒ­æ›´æ–°ï¼‰
```

**å†³ç­–æ ‘**ï¼š
- ä¿®æ”¹ `requirements.txt` â†’ å®Œæ•´éƒ¨ç½²
- ä¿®æ”¹ `Dockerfile` â†’ å®Œæ•´éƒ¨ç½²
- é¦–æ¬¡éƒ¨ç½² â†’ å®Œæ•´éƒ¨ç½²
- ä»…ä¿®æ”¹ Python ä»£ç  â†’ å¢é‡éƒ¨ç½²
- ä»…ä¿®æ”¹è§„åˆ™/é…ç½® â†’ å¢é‡éƒ¨ç½²

### ğŸ³ ACR/GHCR é•œåƒæ¨é€è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

> **é—®é¢˜å¤ç›˜ 2025-12-06**ï¼šACR æ¨é€å¤±è´¥å¯¼è‡´éƒ¨ç½²ä½¿ç”¨æ—§é•œåƒï¼Œå¼•å‘ uvicorn ç¼ºå¤±ç­‰é—®é¢˜ã€‚

#### 1. docker/build-push-action å¿…é¡»é…ç½® provenance: false

**åŸå› **ï¼šé˜¿é‡Œäº‘ ACR ä¸æ”¯æŒ Docker BuildKit çš„ provenance ç‰¹æ€§ï¼Œä¼šå¯¼è‡´ `error from registry: unsupported` é”™è¯¯ã€‚

**æ­£ç¡®é…ç½®**ï¼š
```yaml
- name: ğŸ³ Build and push Docker image
  uses: docker/build-push-action@v5
  with:
    context: .
    push: true
    tags: ${{ steps.meta.outputs.tags }}
    platforms: linux/amd64
    provenance: false  # âš ï¸ ACR å¿…éœ€ï¼ä¸è¦åˆ é™¤ï¼
    build-args: |
      ...
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] `deploy-test.yml` ä¸­ build-push-action åŒ…å« `provenance: false`
- [ ] `deploy-production.yml` ä¸­ build-push-action åŒ…å« `provenance: false`
- [ ] `build-and-push.yml` ä¸­ä½¿ç”¨ `--provenance=false` å‚æ•°

#### 2. æœåŠ¡å™¨éƒ¨ç½²å‰å¿…é¡»æ¸…ç†ç£ç›˜ç©ºé—´

**åŸå› **ï¼šæœåŠ¡å™¨ç£ç›˜ç©ºé—´ä¸è¶³ä¼šå¯¼è‡´ `no space left on device` é”™è¯¯ï¼Œæ— æ³•æ‹‰å–æ–°é•œåƒã€‚

**æ­£ç¡®é…ç½®**ï¼šåœ¨éƒ¨ç½²è„šæœ¬å¼€å¤´æ·»åŠ ï¼š
```bash
echo "ğŸ”„ å¼€å§‹éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."

# æ¸…ç†ç£ç›˜ç©ºé—´ï¼ˆå¿…é¡»ï¼é˜²æ­¢ no space left on deviceï¼‰
docker system prune -af 2>/dev/null || true
docker image prune -af 2>/dev/null || true

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/HiFate-bazi
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] `deploy-test.yml` éƒ¨ç½²è„šæœ¬åŒ…å«ç£ç›˜æ¸…ç†
- [ ] `deploy-production.yml` éƒ¨ç½²è„šæœ¬åŒ…å«ç£ç›˜æ¸…ç†

#### 3. å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

| é”™è¯¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|-----|------|---------|
| `error from registry: unsupported` | ACR ä¸æ”¯æŒ provenance | æ·»åŠ  `provenance: false` |
| `no space left on device` | æœåŠ¡å™¨ç£ç›˜æ»¡ | éƒ¨ç½²å‰æ‰§è¡Œ `docker system prune -af` |
| `unauthorized: authentication required` | ACR è®¤è¯å¤±è´¥ | æ£€æŸ¥ secrets é…ç½® |
| `ModuleNotFoundError: No module named 'uvicorn'` | ä½¿ç”¨äº†æ—§é•œåƒ | ç¡®ä¿æ–°é•œåƒæˆåŠŸæ¨é€å¹¶æ‹‰å– |

### ğŸ“š ç›¸å…³æ–‡æ¡£

- `.github/workflows/build-and-push.yml` - æ„å»ºå’Œæ¨é€æµç¨‹
- `.github/workflows/deploy-test.yml` - æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æµç¨‹
- `docs/GitHub-Container-Registryéƒ¨ç½²æ–¹æ¡ˆ.md` - è¯¦ç»†éƒ¨ç½²æ–‡æ¡£

---

## ğŸš€ æœåŠ¡ç®¡ç†

### å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨ä¸»æœåŠ¡
python3 server/start.py

# æˆ–ä½¿ç”¨è„šæœ¬
./start.sh
```

### æµ‹è¯• API
```bash
# æµ‹è¯• gRPC-Web ç½‘å…³
curl -s -X POST 'http://127.0.0.1:8001/api/v1/bazi/formula-analysis' \
  -H 'Content-Type: application/json' \
  -d '{"solar_date": "1990-01-15", "solar_time": "12:00", "gender": "male"}'
```

### æŸ¥çœ‹æ—¥å¿—
```bash
tail -f logs/server_8001.log
```

---

## ğŸ“¦ Git æäº¤è§„èŒƒ

### Commit Message æ ¼å¼
```
[ç±»å‹] ç®€çŸ­æè¿°

- ä¿®æ”¹æ–‡ä»¶ï¼šåˆ—å‡ºæ–‡ä»¶
- åŠŸèƒ½è¯´æ˜ï¼šè¯¦ç»†è¯´æ˜
- æµ‹è¯•æƒ…å†µï¼šæµ‹è¯•ç»“æœ
```

### ç±»å‹æ ‡ç­¾
- `[æ–°å¢]` - æ–°åŠŸèƒ½/æ–°è§„åˆ™
- `[ä¿®å¤]` - Bugä¿®å¤
- `[ä¼˜åŒ–]` - æ€§èƒ½ä¼˜åŒ–
- `[é‡æ„]` - ä»£ç é‡æ„
- `[è§„åˆ™]` - è§„åˆ™ç›¸å…³å˜æ›´
- `[é…ç½®]` - é…ç½®ä¿®æ”¹

---

## ğŸ“– Gitee ä»“åº“

| é¡¹ç›® | å€¼ |
|------|-----|
| **ä»“åº“åœ°å€** | https://gitee.com/zhoudengtang/hifate-prod.git |
| **æœ¬åœ° remote** | gitee |
| **é»˜è®¤åˆ†æ”¯** | master |

### æäº¤æµç¨‹
```bash
git add .
git commit -m "[ç±»å‹] æè¿°"
git push gitee master
```

### éƒ¨ç½²åˆ°ç”Ÿäº§
```bash
./deploy.sh  # é€‰æ‹© 1) å®Œæ•´éƒ¨ç½²
```

**ğŸ“– è¯¦ç»†éƒ¨ç½²æ–‡æ¡£**ï¼š`docs/Dockerç”Ÿäº§éƒ¨ç½²å®Œæ•´æŒ‡å—.md`

---

## ğŸ³ Docker åŸºç¡€é•œåƒä¼˜åŒ–

### ğŸ“‹ åŸç†

ä½¿ç”¨é¢„æ„å»ºçš„åŸºç¡€é•œåƒï¼ˆåŒ…å«æ‰€æœ‰ Python ä¾èµ–åŒ…å’Œæ¡†æ¶ï¼‰ï¼Œå¤§å¹…åŠ é€Ÿéƒ¨ç½²ï¼š

```
ä¼ ç»Ÿæ–¹å¼ï¼šæ¯æ¬¡éƒ¨ç½²éƒ½å®‰è£…ä¾èµ–ï¼ˆ5-10åˆ†é’Ÿï¼‰
ä¼˜åŒ–æ–¹å¼ï¼šåŸºç¡€é•œåƒå·²å«æ‰€æœ‰åŒ…å’Œæ¡†æ¶ï¼Œåªéœ€å¤åˆ¶ä»£ç ï¼ˆ10-20ç§’ï¼‰
```

**æ ¸å¿ƒä¼˜åŒ–**ï¼š
- âœ… æ‰€æœ‰ Python åŒ…å’Œæ¡†æ¶é¢„è£…åœ¨åŸºç¡€é•œåƒä¸­
- âœ… éƒ¨ç½²æ—¶åªéœ€å¤åˆ¶ä»£ç ï¼Œæ— éœ€å®‰è£…ä¾èµ–
- âœ… åŸºç¡€é•œåƒåŒ…å«ï¼šFastAPIã€gRPCã€æ•°æ®åº“é©±åŠ¨ã€å›¾åƒå¤„ç†åº“ç­‰

### ğŸš€ ä½¿ç”¨æµç¨‹

**1. é¦–æ¬¡æ„å»ºåŸºç¡€é•œåƒ**ï¼ˆä»…éœ€ä¸€æ¬¡ï¼Œçº¦ 5-10 åˆ†é’Ÿï¼‰

```bash
./scripts/docker/build_base.sh
```

**2. æ£€æŸ¥åŸºç¡€é•œåƒçŠ¶æ€**

```bash
./scripts/docker/check_base.sh
```

**3. æ­£å¸¸éƒ¨ç½²**ï¼ˆå¿«é€Ÿï¼Œ10-20ç§’ï¼‰

```bash
docker compose up -d --build web
```

### âš ï¸ ä½•æ—¶éœ€è¦é‡å»ºåŸºç¡€é•œåƒ

| åœºæ™¯ | æ˜¯å¦éœ€è¦é‡å»º | è¯´æ˜ |
|------|------------|------|
| ä¿®æ”¹ä»£ç  | âŒ ä¸éœ€è¦ | ç›´æ¥éƒ¨ç½²å³å¯ |
| ä¿®æ”¹ requirements.txt | âœ… **å¿…é¡»é‡å»º** | ä¾èµ–å˜æ›´ |
| ä¿®æ”¹ Dockerfile.base | âœ… éœ€è¦é‡å»º | åŸºç¡€é•œåƒé…ç½®å˜æ›´ |

### ğŸ”’ å®‰å…¨æœºåˆ¶

1. **è·¨å¹³å°å…¼å®¹**ï¼šä½¿ç”¨ `--platform linux/amd64` ç¡®ä¿ Mac M1/Intel éƒ½èƒ½æ„å»º
2. **ä¿é™©å±‚**ï¼šåº”ç”¨ Dockerfile ä¼šå†æ¬¡æ‰§è¡Œ `pip install`ï¼Œç¡®ä¿ä¾èµ–å®Œæ•´
3. **è‡ªåŠ¨æ£€æŸ¥**ï¼š`check_base.sh` ä¼šæ£€æµ‹ requirements.txt æ˜¯å¦å˜æ›´
4. **ä¾èµ–éªŒè¯**ï¼šåŸºç¡€é•œåƒæ„å»ºæ—¶éªŒè¯æ ¸å¿ƒæ¡†æ¶ï¼ˆFastAPIã€gRPCã€æ•°æ®åº“é©±åŠ¨ç­‰ï¼‰
5. **å¥åº·æ£€æŸ¥**ï¼šåŸºç¡€é•œåƒåŒ…å«å¥åº·æ£€æŸ¥ï¼Œç¡®ä¿å¯ç”¨æ€§

### ğŸ“Š æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | ä¼ ç»Ÿæ–¹å¼ | åŸºç¡€é•œåƒ | æå‡ |
|------|---------|---------|------|
| é¦–æ¬¡éƒ¨ç½² | 10-15åˆ†é’Ÿ | 5-10åˆ†é’Ÿï¼ˆæ„å»ºåŸºç¡€é•œåƒï¼‰ | 1æ¬¡æ€§ |
| ä»£ç æ›´æ–° | 1-2åˆ†é’Ÿ | **10-20ç§’** | **6-12å€** |
| ä¾èµ–æ›´æ–° | 10-15åˆ†é’Ÿ | 5-10åˆ†é’Ÿï¼ˆé‡å»ºåŸºç¡€é•œåƒï¼‰ | 1æ¬¡æ€§ |

### ğŸ› ï¸ ç»´æŠ¤å‘½ä»¤

```bash
# æ„å»ºåŸºç¡€é•œåƒ
./scripts/docker/build_base.sh

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
./scripts/docker/check_base.sh

# æŸ¥çœ‹åŸºç¡€é•œåƒä¿¡æ¯
docker images hifate-base

# åˆ é™¤æ—§ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
docker rmi hifate-base:20241128
```

---

## ğŸ’¡ å¼€å‘åŸåˆ™

> **âš ï¸ é‡è¦æç¤º**ï¼šæ‰€æœ‰æ–°åŠŸèƒ½çš„å¢åŠ ã€ä¿®æ”¹ã€æ‰©å±•éƒ½å¿…é¡»ä¸¥æ ¼éµå®ˆæœ¬å¼€å‘è§„èŒƒã€‚å¼€å‘å‰å¿…é¡»é˜…è¯»"æ–°åŠŸèƒ½å¼€å‘å¼ºåˆ¶è§„èŒƒ"ç« èŠ‚ï¼ˆç¬¬ 65-200 è¡Œï¼‰ï¼Œå¹¶å®Œæˆå¼€å‘è§„èŒƒæ£€æŸ¥æ¸…å•ã€‚

1. **ğŸ“‹ è§„èŒƒä¼˜å…ˆ**ï¼š**æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»éµå®ˆå¼€å‘è§„èŒƒ**ï¼Œè¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§ï¼ˆè§"æ–°åŠŸèƒ½å¼€å‘å¼ºåˆ¶è§„èŒƒ"ï¼‰
2. **ğŸ” å®‰å…¨ä¼˜å…ˆ**ï¼šå®‰å…¨æ˜¯æœ€é«˜ä¼˜å…ˆçº§ï¼Œæ‰€æœ‰ä»£ç å¿…é¡»éµå¾ªå®‰å…¨æœ€ä½³å®è·µï¼ˆè§"å®‰å…¨è§„èŒƒ"ï¼‰
3. **ğŸ”´ é›¶åœæœºä¼˜å…ˆ**ï¼šæ‰€æœ‰è®¾è®¡å¿…é¡»æ”¯æŒä¸åœæœºæ›´æ–°ï¼ˆè§"é›¶åœæœºåŸåˆ™"ï¼‰
4. **ğŸ”Œ gRPC ä¼˜å…ˆ**ï¼šæœåŠ¡é—´äº¤äº’å¿…é¡»ä½¿ç”¨ gRPCï¼ˆè§"gRPC äº¤äº’è§„èŒƒ"ï¼‰
5. **ğŸ“œ è§„åˆ™æ•°æ®åº“åŒ–**ï¼šè§„åˆ™å­˜æ•°æ®åº“ï¼Œæ”¯æŒçƒ­æ›´æ–°ï¼Œ**ç¦æ­¢ä»æ–‡ä»¶è¯»å–**ï¼ˆè§"è§„åˆ™å­˜å‚¨è§„èŒƒ"ï¼‰
6. **ğŸ”„ å‘åå…¼å®¹**ï¼šåªåŠ ä¸åˆ ï¼Œä¿æŒå…¼å®¹
7. **âœ… å…ˆæµ‹è¯•åæäº¤**ï¼šä¿®æ”¹åç«‹å³æµ‹è¯•ï¼Œæµ‹è¯•è¦†ç›–ç‡ â‰¥ 50%ï¼ˆè§"æµ‹è¯•å¼€å‘è§„èŒƒ"ï¼‰
8. **ğŸ“ è§„èŒƒå‘½å**ï¼šç±»å‹ç”¨è‹±æ–‡ï¼ŒID ç»Ÿä¸€æ ¼å¼ï¼ˆè§"è§„åˆ™ç¼–ç è§„èŒƒ"å’Œ"è§„åˆ™ç±»å‹å‘½å"ï¼‰
9. **ğŸ”„ é—®é¢˜å¤ç›˜**ï¼šæ¯æ¬¡é—®é¢˜å¿…é¡»å¤ç›˜å¹¶æ›´æ–°è§„èŒƒï¼ˆè§"é—®é¢˜å¤ç›˜æœºåˆ¶"ï¼‰
10. **ğŸ’¾ Token èŠ‚çœ**ï¼šåªè¯»å–ç›¸å…³æ–‡ä»¶ï¼Œä½¿ç”¨ `offset`/`limit` é™åˆ¶èŒƒå›´ï¼ˆè§"Token èŠ‚çœåŸåˆ™"ï¼‰
11. **ğŸ§ª A/B æµ‹è¯•ä¼˜å…ˆ**ï¼šæ–°åŠŸèƒ½å¿…é¡»æ”¯æŒ A/B æµ‹è¯•ï¼ˆè§"A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒè§„èŒƒ"ï¼‰
12. **ğŸš€ ç°åº¦å‘å¸ƒä¼˜å…ˆ**ï¼šé‡è¦å˜æ›´å¿…é¡»é€šè¿‡ç°åº¦å‘å¸ƒï¼ˆè§"A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒè§„èŒƒ"ï¼‰
13. **ğŸ”„ å›æ»šå‡†å¤‡**ï¼šæ‰€æœ‰æ•°æ®åº“å˜æ›´å¿…é¡»å‡†å¤‡å›æ»šè„šæœ¬ï¼ˆè§"A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒè§„èŒƒ"ï¼‰
14. **ğŸ“Š æ€§èƒ½ç›‘æ§**ï¼šæ‰€æœ‰å…³é”®æµç¨‹å¿…é¡»è®°å½•æ€§èƒ½ç›‘æ§ï¼ˆè§"æ™ºèƒ½è¿åŠ¿åˆ†ææ€§èƒ½ç›‘æ§è§„èŒƒ"ï¼‰
15. **ğŸ¯ æ„å›¾è¯†åˆ«æ··åˆæ¶æ„**ï¼šæ„å›¾è¯†åˆ«å¿…é¡»ä½¿ç”¨æ··åˆæ¶æ„ï¼Œå“åº”æ—¶é—´ < 1ç§’ï¼ˆè§"æ„å›¾è¯†åˆ«æ··åˆæ¶æ„è§„èŒƒ"ï¼‰

---

## ğŸ§ª A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒè§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

### ğŸ”´ æ ¸å¿ƒåŸåˆ™

> **æ‰€æœ‰æ–°åŠŸèƒ½ã€é‡è¦å˜æ›´ã€æ•°æ®åº“å˜æ›´éƒ½å¿…é¡»æ”¯æŒ A/B æµ‹è¯•ã€ç°åº¦å‘å¸ƒå’Œå›æ»šæœºåˆ¶ã€‚**

| åœºæ™¯ | è¦æ±‚ | å®ç°æ–¹å¼ |
|------|------|----------|
| **æ–°åŠŸèƒ½å¼€å‘** | âœ… å¿…é¡» | ä½¿ç”¨åŠŸèƒ½å¼€å…³ï¼ˆFeature Flagï¼‰æ§åˆ¶ |
| **ç®—æ³•ä¼˜åŒ–** | âœ… å¿…é¡» | ä½¿ç”¨ A/B æµ‹è¯•å¯¹æ¯”æ•ˆæœ |
| **é‡è¦å˜æ›´** | âœ… å¿…é¡» | é€šè¿‡ç°åº¦å‘å¸ƒé€æ­¥ä¸Šçº¿ |
| **æ•°æ®åº“å˜æ›´** | âœ… å¿…é¡» | å‡†å¤‡å›æ»šè„šæœ¬ï¼Œæ”¯æŒå¿«é€Ÿå›æ»š |
| **æ€§èƒ½ä¼˜åŒ–** | âœ… æ¨è | ä½¿ç”¨ A/B æµ‹è¯•éªŒè¯æ•ˆæœ |

---

### ğŸ“‹ A/B æµ‹è¯•å¼€å‘è§„èŒƒ

#### 1. æ–°åŠŸèƒ½å¿…é¡»æ”¯æŒ A/B æµ‹è¯•

**è¦æ±‚**ï¼š
- æ‰€æœ‰æ–°åŠŸèƒ½ã€ç®—æ³•ä¼˜åŒ–ã€UI å˜æ›´å¿…é¡»æ”¯æŒ A/B æµ‹è¯•
- ä½¿ç”¨ `server/utils/ab_test.py` æ¡†æ¶
- åˆ›å»ºå®éªŒï¼Œåˆ†é…å˜ä½“ï¼Œè®°å½•äº‹ä»¶

**å¼€å‘æµç¨‹**ï¼š

```python
# 1. å¯¼å…¥ A/B æµ‹è¯•æ¡†æ¶
from server.utils.ab_test import get_ab_test_manager, Experiment, ExperimentStatus

# 2. åˆ›å»ºå®éªŒï¼ˆåœ¨æœåŠ¡å¯åŠ¨æ—¶æˆ–é€šè¿‡ APIï¼‰
manager = get_ab_test_manager()
experiment = Experiment(
    name="æ–°ç®—æ³•æµ‹è¯•",
    description="æµ‹è¯•æ–°çš„å…«å­—è®¡ç®—ç®—æ³•",
    status=ExperimentStatus.RUNNING,
    traffic_percent=50.0,  # 50% æµé‡
    variants={"A": 50, "B": 50}  # A/B å„ 50%
)
manager.create_experiment(experiment)

# 3. åœ¨ä»£ç ä¸­ä½¿ç”¨
variant = manager.assign_variant("æ–°ç®—æ³•æµ‹è¯•", user_id=user_id)
if variant == "A":
    result = old_algorithm.calculate()
elif variant == "B":
    result = new_algorithm.calculate()

# 4. è®°å½•ç”¨æˆ·è¡Œä¸ºäº‹ä»¶
manager.record_event("æ–°ç®—æ³•æµ‹è¯•", user_id, "click", {"button": "submit"})
```

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ–°åŠŸèƒ½æ˜¯å¦åˆ›å»ºäº† A/B æµ‹è¯•å®éªŒ
- [ ] æ˜¯å¦åœ¨ä»£ç ä¸­æ­£ç¡®åˆ†é…å˜ä½“
- [ ] æ˜¯å¦è®°å½•äº†å…³é”®äº‹ä»¶ï¼ˆç‚¹å‡»ã€è½¬åŒ–ç­‰ï¼‰
- [ ] æ˜¯å¦å¯ä»¥é€šè¿‡ API æŸ¥çœ‹å®éªŒç»Ÿè®¡

---

### ğŸš© åŠŸèƒ½å¼€å…³å¼€å‘è§„èŒƒ

#### 1. æ–°åŠŸèƒ½å¿…é¡»ä½¿ç”¨åŠŸèƒ½å¼€å…³

**è¦æ±‚**ï¼š
- æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»é€šè¿‡åŠŸèƒ½å¼€å…³æ§åˆ¶
- æ”¯æŒå¿«é€Ÿå¼€å¯/å…³é—­ï¼Œæ— éœ€é‡æ–°éƒ¨ç½²
- æ”¯æŒç™¾åˆ†æ¯”ç°åº¦ã€ç™½åå•ã€é»‘åå•

**å¼€å‘æµç¨‹**ï¼š

```python
# 1. å¯¼å…¥åŠŸèƒ½å¼€å…³æ¡†æ¶
from server.utils.feature_flag import get_feature_flag_manager, FeatureFlag, FlagType

# 2. åˆ›å»ºåŠŸèƒ½å¼€å…³ï¼ˆåœ¨æœåŠ¡å¯åŠ¨æ—¶æˆ–é€šè¿‡ APIï¼‰
manager = get_feature_flag_manager()
flag = FeatureFlag(
    name="æ–°åŠŸèƒ½",
    description="æ–°åŠŸèƒ½å¼€å…³",
    enabled=True,
    flag_type=FlagType.PERCENTAGE,  # ç™¾åˆ†æ¯”å¼€å…³
    value=10.0  # 10% æµé‡
)
manager.create_flag(flag)

# 3. åœ¨ä»£ç ä¸­æ£€æŸ¥å¼€å…³
if manager.is_enabled("æ–°åŠŸèƒ½", user_id=user_id):
    # ä½¿ç”¨æ–°åŠŸèƒ½
    result = new_feature.process()
else:
    # ä½¿ç”¨æ—§åŠŸèƒ½æˆ–è·³è¿‡
    result = old_feature.process()
```

**åŠŸèƒ½å¼€å…³ç±»å‹**ï¼š
- `FlagType.BOOLEAN` - å¸ƒå°”å¼€å…³ï¼ˆå…¨éƒ¨å¼€å¯/å…³é—­ï¼‰
- `FlagType.PERCENTAGE` - ç™¾åˆ†æ¯”å¼€å…³ï¼ˆç°åº¦å‘å¸ƒï¼‰
- `FlagType.WHITELIST` - ç™½åå•ï¼ˆæŒ‡å®šç”¨æˆ·ï¼‰
- `FlagType.BLACKLIST` - é»‘åå•ï¼ˆæ’é™¤ç”¨æˆ·ï¼‰

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ–°åŠŸèƒ½æ˜¯å¦åˆ›å»ºäº†åŠŸèƒ½å¼€å…³
- [ ] æ˜¯å¦åœ¨ä»£ç ä¸­æ­£ç¡®æ£€æŸ¥å¼€å…³çŠ¶æ€
- [ ] æ˜¯å¦æ”¯æŒå¿«é€Ÿå…³é—­ï¼ˆç´§æ€¥æƒ…å†µï¼‰
- [ ] æ˜¯å¦å¯ä»¥é€šè¿‡ API åˆ‡æ¢å¼€å…³çŠ¶æ€

---

### ğŸš€ ç°åº¦å‘å¸ƒè§„èŒƒ

#### 1. é‡è¦å˜æ›´å¿…é¡»é€šè¿‡ç°åº¦å‘å¸ƒ

**è¦æ±‚**ï¼š
- æ‰€æœ‰é‡è¦åŠŸèƒ½å˜æ›´ã€æ€§èƒ½ä¼˜åŒ–ã€æ¶æ„è°ƒæ•´å¿…é¡»é€šè¿‡ç°åº¦å‘å¸ƒ
- ä» 10% æµé‡å¼€å§‹ï¼Œé€æ­¥å¢åŠ åˆ° 100%
- ç›‘æ§å…³é”®æŒ‡æ ‡ï¼Œéšæ—¶å‡†å¤‡å›æ»š

**ç°åº¦å‘å¸ƒæµç¨‹**ï¼š

```bash
# 1. å¼€å‘æ–°åŠŸèƒ½
git checkout -b feature/new-feature
# ... å¼€å‘ä»£ç  ...

# 2. åˆ›å»ºåŠŸèƒ½å¼€å…³ï¼ˆ10% æµé‡ï¼‰
# ä½¿ç”¨ API æˆ–ä»£ç åˆ›å»ºåŠŸèƒ½å¼€å…³

# 3. æ‰§è¡Œç°åº¦å‘å¸ƒ
./deploy.sh
# é€‰æ‹© 8) ç°åº¦å‘å¸ƒ

# 4. ç›‘æ§ç°åº¦ç‰ˆæœ¬
docker logs -f hifate-bazi-web-gray

# 5. é€æ­¥å¢åŠ æµé‡ï¼ˆå¦‚æœæ­£å¸¸ï¼‰
# è°ƒæ•´è´Ÿè½½å‡è¡¡å™¨é…ç½®ï¼š10% â†’ 20% â†’ 50% â†’ 100%

# 6. å¦‚æœå¼‚å¸¸ï¼Œç«‹å³å›æ»š
./deploy.sh
# é€‰æ‹© 10) ç°åº¦å‘å¸ƒå›æ»š
```

**ç°åº¦å‘å¸ƒæ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ˜¯å¦åˆ›å»ºäº†åŠŸèƒ½å¼€å…³ï¼ˆç™¾åˆ†æ¯”å¼€å…³ï¼‰
- [ ] æ˜¯å¦æ‰§è¡Œäº†ç°åº¦å‘å¸ƒè„šæœ¬
- [ ] æ˜¯å¦é…ç½®äº†è´Ÿè½½å‡è¡¡å™¨æµé‡åˆ†é…
- [ ] æ˜¯å¦ç›‘æ§äº†å…³é”®æŒ‡æ ‡ï¼ˆé”™è¯¯ç‡ã€å“åº”æ—¶é—´ã€ä¸šåŠ¡æŒ‡æ ‡ï¼‰
- [ ] æ˜¯å¦å‡†å¤‡äº†å›æ»šæ–¹æ¡ˆ

**ç›‘æ§æŒ‡æ ‡**ï¼š
- é”™è¯¯ç‡ï¼ˆåº” < 1%ï¼‰
- å“åº”æ—¶é—´ï¼ˆä¸åº”æ˜æ˜¾å¢åŠ ï¼‰
- ä¸šåŠ¡æŒ‡æ ‡ï¼ˆè½¬åŒ–ç‡ã€ç”¨æˆ·æ»¡æ„åº¦ç­‰ï¼‰
- ç³»ç»Ÿèµ„æºï¼ˆCPUã€å†…å­˜ã€æ•°æ®åº“è¿æ¥ç­‰ï¼‰

---

### ğŸ”„ æ•°æ®åº“å›æ»šè§„èŒƒ

#### 1. æ‰€æœ‰æ•°æ®åº“å˜æ›´å¿…é¡»å‡†å¤‡å›æ»šè„šæœ¬

**è¦æ±‚**ï¼š
- æ‰€æœ‰æ•°æ®åº“è¿ç§»å¿…é¡»åŒæ—¶å‡†å¤‡å›æ»šè„šæœ¬
- å›æ»šè„šæœ¬å¿…é¡»ç»è¿‡æµ‹è¯•éªŒè¯
- å›æ»šè„šæœ¬å‘½åè§„èŒƒï¼š`rollback_YYYYMMDD_HHMMSS_description.sql`

**å¼€å‘æµç¨‹**ï¼š

```bash
# 1. åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
# scripts/migration/add_user_table.sql
CREATE TABLE `new_user_table` (...);

# 2. åŒæ—¶åˆ›å»ºå›æ»šè„šæœ¬
./scripts/migration/create_rollback.sh
# è¾“å…¥æè¿°ï¼šå›æ»šæ·»åŠ ç”¨æˆ·è¡¨

# 3. ç¼–è¾‘å›æ»šè„šæœ¬
# scripts/migration/rollback/rollback_20250115_143000_add_user_table.sql
START TRANSACTION;
DROP TABLE IF EXISTS `new_user_table`;
COMMIT;

# 4. åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯å›æ»šè„šæœ¬
mysql -h test_host -u root -p test_db < scripts/migration/rollback/rollback_*.sql

# 5. æ‰§è¡Œè¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
# å¦‚æœå¤±è´¥ï¼Œç«‹å³æ‰§è¡Œå›æ»š
./deploy.sh
# é€‰æ‹© 9) æ•°æ®åº“å›æ»š
```

**å›æ»šè„šæœ¬è§„èŒƒ**ï¼š
- å¿…é¡»ä½¿ç”¨äº‹åŠ¡ï¼ˆ`START TRANSACTION` / `COMMIT`ï¼‰
- å¿…é¡»ä½¿ç”¨ `IF EXISTS` é¿å…é”™è¯¯
- å¿…é¡»åŒ…å«éªŒè¯ SQLï¼ˆå¯é€‰ï¼‰
- å¿…é¡»è®°å½•å›æ»šæ—¥å¿—

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ˜¯å¦åˆ›å»ºäº†å›æ»šè„šæœ¬
- [ ] å›æ»šè„šæœ¬æ˜¯å¦ç»è¿‡æµ‹è¯•éªŒè¯
- [ ] å›æ»šè„šæœ¬æ˜¯å¦ä½¿ç”¨äº‹åŠ¡
- [ ] æ˜¯å¦å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒå¿«é€Ÿæ‰§è¡Œå›æ»š

---

### ğŸ“ å¼€å‘æ£€æŸ¥æ¸…å•

æ¯æ¬¡å¼€å‘æ–°åŠŸèƒ½æˆ–é‡è¦å˜æ›´æ—¶ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

#### A/B æµ‹è¯•æ£€æŸ¥
- [ ] æ˜¯å¦åˆ›å»ºäº† A/B æµ‹è¯•å®éªŒ
- [ ] æ˜¯å¦åœ¨ä»£ç ä¸­æ­£ç¡®åˆ†é…å˜ä½“
- [ ] æ˜¯å¦è®°å½•äº†å…³é”®äº‹ä»¶
- [ ] æ˜¯å¦å¯ä»¥é€šè¿‡ API æŸ¥çœ‹ç»Ÿè®¡

#### åŠŸèƒ½å¼€å…³æ£€æŸ¥
- [ ] æ˜¯å¦åˆ›å»ºäº†åŠŸèƒ½å¼€å…³
- [ ] æ˜¯å¦åœ¨ä»£ç ä¸­æ­£ç¡®æ£€æŸ¥å¼€å…³
- [ ] æ˜¯å¦æ”¯æŒå¿«é€Ÿå…³é—­
- [ ] æ˜¯å¦å¯ä»¥é€šè¿‡ API åˆ‡æ¢

#### ç°åº¦å‘å¸ƒæ£€æŸ¥
- [ ] æ˜¯å¦æ‰§è¡Œäº†ç°åº¦å‘å¸ƒ
- [ ] æ˜¯å¦é…ç½®äº†æµé‡åˆ†é…
- [ ] æ˜¯å¦ç›‘æ§äº†å…³é”®æŒ‡æ ‡
- [ ] æ˜¯å¦å‡†å¤‡äº†å›æ»šæ–¹æ¡ˆ

#### æ•°æ®åº“å›æ»šæ£€æŸ¥
- [ ] æ˜¯å¦åˆ›å»ºäº†å›æ»šè„šæœ¬
- [ ] å›æ»šè„šæœ¬æ˜¯å¦ç»è¿‡æµ‹è¯•
- [ ] æ˜¯å¦å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒå¿«é€Ÿæ‰§è¡Œ

---

### ğŸ¯ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

#### åœºæ™¯ 1ï¼šæ–°ç®—æ³•ä¸Šçº¿

```python
# 1. åˆ›å»º A/B æµ‹è¯•å®éªŒ
experiment = Experiment(
    name="æ–°ç®—æ³•æµ‹è¯•",
    status=ExperimentStatus.RUNNING,
    traffic_percent=50.0,
    variants={"A": 50, "B": 50}
)

# 2. åœ¨ä»£ç ä¸­ä½¿ç”¨
variant = manager.assign_variant("æ–°ç®—æ³•æµ‹è¯•", user_id)
if variant == "A":
    result = old_algorithm.calculate()
else:
    result = new_algorithm.calculate()

# 3. è®°å½•äº‹ä»¶
manager.record_event("æ–°ç®—æ³•æµ‹è¯•", user_id, "calculate", {"result": result})

# 4. åˆ†æç»Ÿè®¡ï¼Œå†³å®šæ˜¯å¦å…¨é‡ä¸Šçº¿
stats = manager.get_experiment_stats("æ–°ç®—æ³•æµ‹è¯•")
```

#### åœºæ™¯ 2ï¼šæ–°åŠŸèƒ½ç°åº¦å‘å¸ƒ

```python
# 1. åˆ›å»ºåŠŸèƒ½å¼€å…³ï¼ˆ10% æµé‡ï¼‰
flag = FeatureFlag(
    name="æ–°åŠŸèƒ½",
    enabled=True,
    flag_type=FlagType.PERCENTAGE,
    value=10.0
)

# 2. åœ¨ä»£ç ä¸­æ£€æŸ¥
if manager.is_enabled("æ–°åŠŸèƒ½", user_id):
    result = new_feature.process()
else:
    result = old_feature.process()

# 3. ç›‘æ§æŒ‡æ ‡ï¼Œé€æ­¥å¢åŠ æµé‡
# 10% â†’ 20% â†’ 50% â†’ 100%
```

#### åœºæ™¯ 3ï¼šæ•°æ®åº“å˜æ›´

```sql
-- 1. è¿ç§»è„šæœ¬
-- scripts/migration/add_index.sql
ALTER TABLE `user_table` ADD INDEX `idx_email` (`email`);

-- 2. å›æ»šè„šæœ¬
-- scripts/migration/rollback/rollback_20250115_143000_add_index.sql
START TRANSACTION;
ALTER TABLE `user_table` DROP INDEX IF EXISTS `idx_email`;
COMMIT;
```

---

### ğŸ“š ç›¸å…³æ–‡æ¡£

- [A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒæŒ‡å—](../docs/A_Bæµ‹è¯•å’Œç°åº¦å‘å¸ƒæŒ‡å—.md) - è¯¦ç»†ä½¿ç”¨è¯´æ˜
- [éƒ¨ç½²æ–‡æ¡£](../docs/Dockerç”Ÿäº§éƒ¨ç½²å®Œæ•´æŒ‡å—.md) - éƒ¨ç½²æŒ‡å—

---

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **A/B æµ‹è¯•**ï¼š
   - ç¡®ä¿å˜ä½“æµé‡æ€»å’Œä¸º 100%
   - åŒä¸€ç”¨æˆ·åœ¨åŒä¸€å®éªŒä¸­æ€»æ˜¯åˆ†é…åˆ°ç›¸åŒå˜ä½“
   - å®šæœŸåˆ†æç»Ÿè®¡ï¼ŒåŠæ—¶è°ƒæ•´å®éªŒ

2. **åŠŸèƒ½å¼€å…³**ï¼š
   - ç™¾åˆ†æ¯”å¼€å…³åŸºäºç”¨æˆ·IDå“ˆå¸Œï¼Œç¡®ä¿ä¸€è‡´æ€§
   - ç™½åå•/é»‘åå•éœ€è¦æ˜ç¡®çš„ç”¨æˆ·IDåˆ—è¡¨
   - ç´§æ€¥æƒ…å†µå¯ä»¥å¿«é€Ÿå…³é—­åŠŸèƒ½

3. **ç°åº¦å‘å¸ƒ**ï¼š
   - ä» 10% æµé‡å¼€å§‹ï¼Œé€æ­¥å¢åŠ 
   - ç›‘æ§å…³é”®æŒ‡æ ‡ï¼Œéšæ—¶å‡†å¤‡å›æ»š
   - ä¿ç•™å›æ»šè„šæœ¬å’Œå›æ»šæ–¹æ¡ˆ

4. **æ•°æ®åº“å›æ»š**ï¼š
   - æ‰§è¡Œå›æ»šå‰å¿…é¡»å¤‡ä»½æ•°æ®
   - å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯å›æ»šè„šæœ¬
   - æŸäº›æ“ä½œï¼ˆå¦‚åˆ é™¤æ•°æ®ï¼‰æ— æ³•å®Œå…¨å›æ»š

---

## ğŸ“š æ–‡æ¡£ç»´æŠ¤è§„èŒƒ

### ğŸ”„ æ–‡æ¡£åŒæ­¥åŸåˆ™

**æ ¸å¿ƒåŸåˆ™**ï¼šæ“ä½œæ›´æ–°æ—¶ï¼Œæ–‡æ¡£å¿…é¡»åŒæ­¥æ›´æ–°

### ğŸ“ éœ€è¦åŒæ­¥æ›´æ–°çš„åœºæ™¯

| åœºæ™¯ | éœ€è¦æ›´æ–°çš„æ–‡æ¡£ | æ›´æ–°å†…å®¹ |
|------|--------------|---------|
| æ–°å¢éƒ¨ç½²æ­¥éª¤ | `docs/Dockerç”Ÿäº§éƒ¨ç½²å®Œæ•´æŒ‡å—.md` | æ·»åŠ æ–°æ­¥éª¤ |
| ä¿®æ”¹éƒ¨ç½²å‘½ä»¤ | `docs/Dockerç”Ÿäº§éƒ¨ç½²å®Œæ•´æŒ‡å—.md` | æ›´æ–°å‘½ä»¤ |
| æ–°å¢æ•…éšœæ’æŸ¥ | `docs/Dockerç”Ÿäº§éƒ¨ç½²å®Œæ•´æŒ‡å—.md` | æ·»åŠ é—®é¢˜è§£å†³æ–¹æ¡ˆ |
| ä¿®æ”¹é…ç½®é¡¹ | `docs/Dockerç”Ÿäº§éƒ¨ç½²å®Œæ•´æŒ‡å—.md` | æ›´æ–°é…ç½®è¯´æ˜ |
| æ–°å¢è„šæœ¬ | `docs/Dockerç”Ÿäº§éƒ¨ç½²å®Œæ•´æŒ‡å—.md` | æ·»åŠ è„šæœ¬ä½¿ç”¨è¯´æ˜ |
| ä¿®æ”¹å¼€å‘æµç¨‹ | `.cursorrules` | æ›´æ–°ç›¸å…³ç« èŠ‚ |

### âœ… æ–‡æ¡£æ›´æ–°æ£€æŸ¥æ¸…å•

æ¯æ¬¡ä¿®æ”¹éƒ¨ç½²ç›¸å…³æ“ä½œæ—¶ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

- [ ] æ˜¯å¦æ›´æ–°äº† `docs/Dockerç”Ÿäº§éƒ¨ç½²å®Œæ•´æŒ‡å—.md`
- [ ] æ˜¯å¦æ›´æ–°äº† `.cursorrules` ä¸­çš„ç›¸å…³ç« èŠ‚
- [ ] æ˜¯å¦æ›´æ–°äº†è„šæœ¬ä¸­çš„æ³¨é‡Š
- [ ] æ˜¯å¦æ›´æ–°äº† READMEï¼ˆå¦‚æœ‰ï¼‰

### ğŸ“‹ æ–‡æ¡£ç»´æŠ¤æµç¨‹

1. **ä¿®æ”¹æ“ä½œ** â†’ ç«‹å³æ›´æ–°æ–‡æ¡£
2. **æäº¤ä»£ç ** â†’ åŒæ—¶æäº¤æ–‡æ¡£æ›´æ–°
3. **éªŒè¯éƒ¨ç½²** â†’ éªŒè¯æ–‡æ¡£å‡†ç¡®æ€§
4. **æ ‡è®°æ›´æ–°æ—¥æœŸ** â†’ åœ¨æ–‡æ¡£é¡¶éƒ¨æ›´æ–°æ—¥æœŸ

### ğŸ¯ ä¸»è¦éƒ¨ç½²æ–‡æ¡£

| æ–‡æ¡£ | ç”¨é€” | ç»´æŠ¤é¢‘ç‡ |
|------|------|---------|
| `docs/Dockerç”Ÿäº§éƒ¨ç½²å®Œæ•´æŒ‡å—.md` | **ä¸»è¦éƒ¨ç½²æ–‡æ¡£** | æ¯æ¬¡æ“ä½œå˜æ›´ |
| `docs/DockeråŸºç¡€é•œåƒä¼˜åŒ–.md` | åŸºç¡€é•œåƒè¯¦ç»†è¯´æ˜ | åŸºç¡€é•œåƒå˜æ›´æ—¶ |
| `.cursorrules` | å¼€å‘è§„èŒƒ | è§„èŒƒå˜æ›´æ—¶ |

---

**æ ¸å¿ƒè¦ç‚¹**ï¼š
- **ğŸ”´ æœ€é«˜ä¼˜å…ˆçº§**ï¼š**æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»éµå®ˆå¼€å‘è§„èŒƒ**ï¼ˆè§"æ–°åŠŸèƒ½å¼€å‘å¼ºåˆ¶è§„èŒƒ"ï¼‰
- **ğŸ“‹ å¼€å‘å‰å¿…è¯»**ï¼šå¼€å‘æ–°åŠŸèƒ½å‰å¿…é¡»é˜…è¯»ç›¸å…³è§„èŒƒç« èŠ‚å¹¶å®Œæˆæ£€æŸ¥æ¸…å•
- **âœ… å¼ºåˆ¶æ£€æŸ¥**ï¼šæ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»é€šè¿‡å¼€å‘è§„èŒƒæ£€æŸ¥æ¸…å•éªŒè¯
- æ–°å¢ API å¿…é¡»åŒæ—¶æ³¨å†Œ gRPC ç«¯ç‚¹ï¼ˆè§"åç«¯æ³¨å†Œè§„èŒƒ"ï¼‰
- æ–°å¢è§„åˆ™ç±»å‹å¿…é¡»åŒæ­¥æ›´æ–°å‰åç«¯ï¼ˆè§"ç±»å‹æ˜ å°„"å’Œ"é—®é¢˜4"ï¼‰
- æ•°æ®åº“é…ç½®ä½¿ç”¨ `hifate_bazi` è€Œé `bazi_system`ï¼ˆè§"æ•°æ®åº“é…ç½®é»˜è®¤å€¼"ï¼‰
- è§„åˆ™ `rule_type` ä½¿ç”¨è‹±æ–‡å°å†™ï¼ˆè§"è§„åˆ™ç±»å‹å‘½å"ï¼‰
- **æ‰€æœ‰è§„åˆ™å¿…é¡»ä»æ•°æ®åº“è¯»å–ï¼Œç¦æ­¢ä»æ–‡ä»¶è¯»å–**ï¼ˆè§"è§„åˆ™å­˜å‚¨è§„èŒƒ"ï¼‰
- **æ‰€æœ‰è§„åˆ™åŒ¹é…å¿…é¡»ä½¿ç”¨ `RuleService`ï¼Œç¦æ­¢ä½¿ç”¨ `FormulaRuleService`**ï¼ˆè§"è§„åˆ™å­˜å‚¨è§„èŒƒ"ï¼‰
- **æ¯æ¬¡é—®é¢˜å¿…é¡»å¤ç›˜å¹¶æ›´æ–°å¼€å‘è§„èŒƒ**ï¼ˆè§"é—®é¢˜å¤ç›˜æœºåˆ¶"ï¼‰
- **æ“ä½œæ›´æ–°æ—¶ï¼Œæ–‡æ¡£å¿…é¡»åŒæ­¥æ›´æ–°**ï¼ˆè§"æ–‡æ¡£ç»´æŠ¤è§„èŒƒ"ï¼‰
- **æ–°åŠŸèƒ½å¿…é¡»æ”¯æŒ A/B æµ‹è¯•å’ŒåŠŸèƒ½å¼€å…³**ï¼ˆè§"A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒè§„èŒƒ"ï¼‰
- **é‡è¦å˜æ›´å¿…é¡»é€šè¿‡ç°åº¦å‘å¸ƒ**ï¼ˆè§"A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒè§„èŒƒ"ï¼‰
- **æ•°æ®åº“å˜æ›´å¿…é¡»å‡†å¤‡å›æ»šè„šæœ¬**ï¼ˆè§"A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒè§„èŒƒ"ï¼‰
- **æ„å›¾è¯†åˆ«å¿…é¡»ä½¿ç”¨æ··åˆæ¶æ„ï¼Œå“åº”æ—¶é—´ < 1ç§’**ï¼ˆè§"æ„å›¾è¯†åˆ«æ··åˆæ¶æ„è§„èŒƒ"ï¼‰
- **æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»åŒæ­¥ç¼–å†™æµ‹è¯•æ¡ˆä¾‹ï¼Œæµ‹è¯•è¦†ç›–ç‡ â‰¥ 50%**ï¼ˆè§"æµ‹è¯•å¼€å‘è§„èŒƒ"ï¼‰
- **æ‰€æœ‰å…³é”®æµç¨‹å¿…é¡»è®°å½•æ€§èƒ½ç›‘æ§**ï¼ˆè§"æ™ºèƒ½è¿åŠ¿åˆ†ææ€§èƒ½ç›‘æ§è§„èŒƒ"ï¼‰

---

## ğŸš€ æ„å›¾è¯†åˆ«æ··åˆæ¶æ„è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

### ğŸ”´ æ ¸å¿ƒåŸåˆ™

> **æ„å›¾è¯†åˆ«å“åº”æ—¶é—´å¿…é¡» < 1ç§’ï¼Œä½¿ç”¨æ··åˆæ¶æ„å®ç°é«˜æ€§èƒ½ã€‚**

### ğŸ“‹ æ¶æ„è®¾è®¡

**æ··åˆæ¶æ„æµç¨‹**ï¼š
```
ç”¨æˆ·è¾“å…¥
    â†“
ã€ç¬¬1å±‚ï¼šå…³é”®è¯è¿‡æ»¤ã€‘ï¼ˆ0msï¼Œå¤„ç†60%çš„æ˜ç¡®é—®é¢˜ï¼‰
    â”œâ”€ å¼ºæŒ‡ç¤ºè¯ â†’ ç›´æ¥é€šè¿‡ï¼ˆ99%å‡†ç¡®ï¼‰
    â”œâ”€ é»‘åå• â†’ ç›´æ¥æ‹’ç»ï¼ˆ95%å‡†ç¡®ï¼‰
    â””â”€ ç™½åå• â†’ ç›´æ¥é€šè¿‡ï¼ˆ90%å‡†ç¡®ï¼‰
    â†“
ã€ç¬¬2å±‚ï¼šæœ¬åœ°BERTæ¨¡å‹ã€‘ï¼ˆ50-100msï¼Œå¤„ç†20%çš„ç®€å•é—®é¢˜ï¼‰
    â”œâ”€ æ¨¡å‹åˆ†ç±»ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    â””â”€ å…³é”®è¯å›é€€ï¼ˆå¦‚æœæ¨¡å‹ä¸å¯ç”¨ï¼‰
    â†“
ã€ç¬¬3å±‚ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦LLMå…œåº•ã€‘
    â”œâ”€ ç½®ä¿¡åº¦ < 0.6 â†’ LLM
    â”œâ”€ é—®é¢˜æ¨¡ç³Š â†’ LLM
    â””â”€ å¤æ‚æ—¶é—´è¡¨è¾¾ â†’ LLM
    â†“
ã€ç¬¬4å±‚ï¼šè§„åˆ™åå¤„ç†ã€‘ï¼ˆ10-20msï¼‰
    â”œâ”€ æ—¶é—´æ„å›¾è§£æï¼ˆæ”¯æŒä¸­æ–‡æ•°å­—ï¼‰
    â”œâ”€ å¤šæ„å›¾åˆå¹¶
    â””â”€ JSONæ ¼å¼åŒ–
    â†“
ã€ç¬¬5å±‚ï¼šLLMå…œåº•ã€‘ï¼ˆ500-1000msï¼Œä»…å¤„ç†5%çš„æ¨¡ç³Šé—®é¢˜ï¼‰
    â””â”€ ä»…å¤„ç†å¤æ‚/æ¨¡ç³Šé—®é¢˜
    â†“
æœ€ç»ˆç»“æœ
```

### ğŸ¯ æ€§èƒ½è¦æ±‚

| åœºæ™¯ | å æ¯” | å“åº”æ—¶é—´ | å‡†ç¡®ç‡ | ä½¿ç”¨æŠ€æœ¯ |
|------|------|---------|--------|---------|
| å…³é”®è¯æ˜ç¡® | 60% | <10ms | 95%+ | å…³é”®è¯è¿‡æ»¤ |
| ç®€å•é—®é¢˜ | 20% | 50-100ms | 85-90% | æœ¬åœ°æ¨¡å‹ + è§„åˆ™ |
| å¤æ‚é—®é¢˜ | 15% | 100-200ms | 80-85% | æœ¬åœ°æ¨¡å‹ + è§„åˆ™ |
| æ¨¡ç³Šé—®é¢˜ | 5% | 500-1000ms | 90%+ | LLMå…œåº• |

**å¹³å‡å“åº”æ—¶é—´**ï¼š< 100msï¼ˆæ»¡è¶³ < 1ç§’è¦æ±‚ï¼‰

### ğŸ“ æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ | è¯´æ˜ |
|------|------|------|
| `services/intent_service/local_classifier.py` | æœ¬åœ°BERTæ¨¡å‹åˆ†ç±»å™¨ | å¤„ç†ç®€å•é—®é¢˜ï¼ˆ50-100msï¼‰ |
| `services/intent_service/rule_postprocessor.py` | è§„åˆ™åå¤„ç†å™¨ | æ—¶é—´æ„å›¾è§£æã€JSONæ ¼å¼åŒ–ï¼ˆ10-20msï¼‰ |
| `services/intent_service/classifier.py` | æ··åˆæ¶æ„è·¯ç”± | æ™ºèƒ½è·¯ç”±åˆ°ä¸åŒå¤„ç†å±‚ |
| `services/intent_service/question_filter.py` | å…³é”®è¯è¿‡æ»¤å™¨ | å¿«é€Ÿè¿‡æ»¤æ˜ç¡®é—®é¢˜ï¼ˆ0msï¼‰ |
| `services/intent_service/llm_client.py` | LLMå®¢æˆ·ç«¯ | å…œåº•å¤„ç†å¤æ‚é—®é¢˜ï¼ˆ500-1000msï¼‰ |

### ğŸ”§ å®ç°è¦æ±‚

#### 1. æœ¬åœ°æ¨¡å‹åˆ†ç±»å™¨

**è¦æ±‚**ï¼š
- ä½¿ç”¨BERT/RoBERTaä¸­æ–‡æ¨¡å‹ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä½¿ç”¨å…³é”®è¯å›é€€ï¼‰
- æ”¯æŒå…³é”®è¯å›é€€æ–¹æ¡ˆï¼ˆç¡®ä¿æ¨¡å‹ä¸å¯ç”¨æ—¶ä»èƒ½å·¥ä½œï¼‰
- å“åº”æ—¶é—´ < 100ms

**å®ç°ç¤ºä¾‹**ï¼š
```python
from services.intent_service.local_classifier import LocalIntentClassifier

classifier = LocalIntentClassifier()
result = classifier.classify(question)
# è¿”å›ï¼š{"intents": ["wealth"], "confidence": 0.85, "method": "local_model"}
```

#### 2. è§„åˆ™åå¤„ç†å™¨

**è¦æ±‚**ï¼š
- æ”¯æŒä¸­æ–‡æ•°å­—å’Œé˜¿æ‹‰ä¼¯æ•°å­—çš„æ—¶é—´è¡¨è¾¾
- æ”¯æŒå¤šç§æ—¶é—´ç±»å‹ï¼ˆä»Šå¤©ã€æœ¬æœˆã€ä»Šå¹´ã€æ˜å¹´ã€åNå¹´ã€XXXXå¹´ã€XXXX-YYYYå¹´ç­‰ï¼‰
- å“åº”æ—¶é—´ < 20ms

**æ—¶é—´æ„å›¾ç±»å‹**ï¼š
- `today` - ä»Šå¤©/ä»Šæ—¥
- `this_month` - æœ¬æœˆ/è¿™ä¸ªæœˆ
- `this_year` - ä»Šå¹´/æœ¬å¹´ï¼ˆé»˜è®¤ï¼‰
- `next_year` - æ˜å¹´ï¼ˆåªæœ‰1å¹´ï¼‰
- `future_years` - åNå¹´/æœªæ¥Nå¹´ï¼ˆNå¹´ï¼‰
- `recent_years` - æœ€è¿‘Nå¹´
- `specific_year` - XXXXå¹´ï¼ˆå•ä¸ªå¹´ä»½ï¼‰
- `year_range` - XXXX-YYYYå¹´ï¼ˆå¹´ä»½èŒƒå›´ï¼‰

**å®ç°ç¤ºä¾‹**ï¼š
```python
from services.intent_service.rule_postprocessor import RulePostProcessor

processor = RulePostProcessor()
result = processor.process(question, base_result)
# è¿”å›ï¼šåŒ…å«time_intentçš„å®Œæ•´ç»“æœ
```

#### 3. æ··åˆæ¶æ„è·¯ç”±

**è¦æ±‚**ï¼š
- æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦LLMå…œåº•
- ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼Œä»…åœ¨å¿…è¦æ—¶è°ƒç”¨LLM
- ç¡®ä¿å¹³å‡å“åº”æ—¶é—´ < 100ms

**LLMå…œåº•æ¡ä»¶**ï¼š
- æœ¬åœ°æ¨¡å‹ç½®ä¿¡åº¦ < 0.6
- é—®é¢˜è¿‡äºæ¨¡ç³Šï¼ˆé•¿åº¦ < 5 æˆ–ç¼ºå°‘å…³é”®è¯ï¼‰
- å¤šæ„å›¾å†²çªï¼ˆæ„å›¾æ•°é‡ > 2 ä¸”ç½®ä¿¡åº¦ä½ï¼‰
- å¤æ‚æ—¶é—´è¡¨è¾¾ï¼ˆéœ€è¦ä¸Šä¸‹æ–‡ç†è§£ï¼‰

**å®ç°ç¤ºä¾‹**ï¼š
```python
from services.intent_service.classifier import IntentClassifier

classifier = IntentClassifier()
result = classifier.classify(question)
# è‡ªåŠ¨è·¯ç”±åˆ°åˆé€‚çš„å¤„ç†å±‚
```

### âš™ï¸ é…ç½®é¡¹

åœ¨ `services/intent_service/config.py` ä¸­ï¼š

```python
# æ··åˆæ¶æ„é…ç½®
HYBRID_ARCHITECTURE_ENABLED = os.getenv("HYBRID_ARCHITECTURE_ENABLED", "true").lower() == "true"
LOCAL_MODEL_NAME = os.getenv("LOCAL_MODEL_NAME", "hfl/chinese-roberta-wwm-ext")
LLM_FALLBACK_THRESHOLD = float(os.getenv("LLM_FALLBACK_THRESHOLD", "0.6"))  # ç½®ä¿¡åº¦é˜ˆå€¼
```

### âœ… æ£€æŸ¥æ¸…å•

æ¯æ¬¡ä¿®æ”¹æ„å›¾è¯†åˆ«ç›¸å…³ä»£ç æ—¶ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

- [ ] å¹³å‡å“åº”æ—¶é—´æ˜¯å¦ < 100ms
- [ ] æ˜¯å¦ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹/å…³é”®è¯è¿‡æ»¤
- [ ] LLMå…œåº•æ˜¯å¦ä»…åœ¨å¿…è¦æ—¶è°ƒç”¨ï¼ˆ< 5%çš„æƒ…å†µï¼‰
- [ ] æ—¶é—´æ„å›¾è¯†åˆ«æ˜¯å¦æ”¯æŒä¸­æ–‡æ•°å­—
- [ ] æ˜¯å¦æ”¯æŒæ‰€æœ‰æ—¶é—´ç±»å‹ï¼ˆä»Šå¤©ã€æ˜å¹´ã€åNå¹´ã€XXXXå¹´ç­‰ï¼‰
- [ ] é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„ï¼ˆæ¨¡å‹ä¸å¯ç”¨æ—¶ä½¿ç”¨å›é€€æ–¹æ¡ˆï¼‰

### ğŸš¨ å¸¸è§é—®é¢˜

#### é—®é¢˜1ï¼šæ—¶é—´æ„å›¾è¯†åˆ«å¤±è´¥

**ç—‡çŠ¶**ï¼š"åä¸‰å¹´"æ— æ³•è¯†åˆ«ä¸º`future_years`

**åŸå› **ï¼šæ­£åˆ™è¡¨è¾¾å¼ä¸æ”¯æŒä¸­æ–‡æ•°å­—

**è§£å†³**ï¼šåœ¨`rule_postprocessor.py`ä¸­æ”¯æŒä¸­æ–‡æ•°å­—è½¬æ¢

#### é—®é¢˜2ï¼šå“åº”æ—¶é—´è¿‡é•¿

**ç—‡çŠ¶**ï¼šå¹³å‡å“åº”æ—¶é—´ > 1ç§’

**åŸå› **ï¼šè¿‡å¤šè°ƒç”¨LLM API

**è§£å†³**ï¼š
- é™ä½LLMå…œåº•é˜ˆå€¼ï¼ˆ`LLM_FALLBACK_THRESHOLD`ï¼‰
- ä¼˜åŒ–å…³é”®è¯è¿‡æ»¤è§„åˆ™
- å¢å¼ºæœ¬åœ°æ¨¡å‹èƒ½åŠ›

#### é—®é¢˜3ï¼šæœ¬åœ°æ¨¡å‹ä¸å¯ç”¨

**ç—‡çŠ¶**ï¼š`transformers`æœªå®‰è£…æˆ–æ¨¡å‹åŠ è½½å¤±è´¥

**è§£å†³**ï¼šè‡ªåŠ¨ä½¿ç”¨å…³é”®è¯å›é€€æ–¹æ¡ˆï¼Œç¡®ä¿æœåŠ¡å¯ç”¨

---

**æ ¸å¿ƒè¦ç‚¹**ï¼š
- **æ„å›¾è¯†åˆ«å¿…é¡»ä½¿ç”¨æ··åˆæ¶æ„ï¼Œå“åº”æ—¶é—´ < 1ç§’**
- **ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹/å…³é”®è¯è¿‡æ»¤ï¼ŒLLMä»…ä½œä¸ºå…œåº•**
- **æ—¶é—´æ„å›¾è¯†åˆ«å¿…é¡»æ”¯æŒä¸­æ–‡æ•°å­—å’Œé˜¿æ‹‰ä¼¯æ•°å­—**
- **æ‰€æœ‰æ—¶é—´ç±»å‹å¿…é¡»æ­£ç¡®è¯†åˆ«ï¼ˆä»Šå¤©ã€æ˜å¹´ã€åNå¹´ã€XXXXå¹´ç­‰ï¼‰**

---

## ğŸ“Š æ™ºèƒ½è¿åŠ¿åˆ†ææ€§èƒ½ç›‘æ§è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

### ğŸ”´ æ ¸å¿ƒåŸåˆ™

> **æ‰€æœ‰æ™ºèƒ½è¿åŠ¿åˆ†ææµç¨‹å¿…é¡»è®°å½•ç«¯åˆ°ç«¯æ—¥å¿—å’Œæ€§èƒ½ç›‘æ§ï¼Œç¡®ä¿æ¯ä¸ªé˜¶æ®µçš„å“åº”æ—¶é—´å¯æ§ã€‚**

### ğŸ“‹ æ€§èƒ½ç›‘æ§è¦æ±‚

**å¿…é¡»ç›‘æ§çš„é˜¶æ®µ**ï¼š
1. **æ„å›¾è¯†åˆ«** (`intent_recognition`) - ç›®æ ‡ï¼š< 100ms
2. **å…«å­—è®¡ç®—** (`bazi_calculation`) - ç›®æ ‡ï¼š< 50ms
3. **è§„åˆ™åŒ¹é…** (`rule_matching`) - ç›®æ ‡ï¼š< 200ms
4. **æµå¹´å¤§è¿åˆ†æ** (`fortune_context`) - ç›®æ ‡ï¼š< 1000msï¼ˆå¯é€‰ï¼‰
5. **LLMæ·±åº¦è§£è¯»** (`llm_analysis`) - ç›®æ ‡ï¼š< 2000msï¼ˆå¯é€‰ï¼‰
6. **ç”Ÿæˆå“åº”æ–‡æœ¬** (`response_generation`) - ç›®æ ‡ï¼š< 50ms

### ğŸ”§ å®ç°æ–¹å¼

**ä½¿ç”¨ `PerformanceMonitor` å·¥å…·ç±»**ï¼š

```python
from server.utils.performance_monitor import PerformanceMonitor

# åˆå§‹åŒ–ç›‘æ§å™¨
monitor = PerformanceMonitor()

# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨è®°å½•é˜¶æ®µ
with monitor.stage("intent_recognition", "æ„å›¾è¯†åˆ«", question=question):
    intent_result = intent_client.classify(question=question)
    monitor.add_metric("intent_recognition", "intents_count", len(intent_result.get("intents", [])))

# è¾“å‡ºæ€§èƒ½æ‘˜è¦
monitor.log_summary()

# åœ¨å“åº”ä¸­åŒ…å«æ€§èƒ½æ‘˜è¦
result = {
    "success": True,
    "response": response_text,
    "performance": monitor.get_summary()  # â­ æ·»åŠ æ€§èƒ½æ‘˜è¦
}
```

### ğŸ“Š æ€§èƒ½æ‘˜è¦æ ¼å¼

æ€§èƒ½æ‘˜è¦åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š
- `total_duration_ms`: æ€»è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
- `stages`: å„é˜¶æ®µè¯¦ç»†ä¿¡æ¯ï¼ˆè€—æ—¶ã€æˆåŠŸ/å¤±è´¥ã€æŒ‡æ ‡ç­‰ï¼‰
- `bottlenecks`: æ€§èƒ½ç“¶é¢ˆï¼ˆ>1ç§’çš„é˜¶æ®µï¼‰
- `failed_stages`: å¤±è´¥çš„é˜¶æ®µ

### âœ… æ£€æŸ¥æ¸…å•

æ¯æ¬¡ä¿®æ”¹æ™ºèƒ½è¿åŠ¿åˆ†æç›¸å…³ä»£ç æ—¶ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

- [ ] æ˜¯å¦ä½¿ç”¨ `PerformanceMonitor` è®°å½•æ‰€æœ‰é˜¶æ®µ
- [ ] æ˜¯å¦åœ¨å“åº”ä¸­åŒ…å«æ€§èƒ½æ‘˜è¦
- [ ] æ˜¯å¦è¾“å‡ºæ€§èƒ½æ‘˜è¦åˆ°æ—¥å¿—
- [ ] æ˜¯å¦è¯†åˆ«å¹¶è®°å½•æ€§èƒ½ç“¶é¢ˆï¼ˆ>1ç§’ï¼‰
- [ ] æ˜¯å¦è®°å½•å¤±è´¥çš„é˜¶æ®µå’Œé”™è¯¯ä¿¡æ¯

### ğŸš¨ æ€§èƒ½ä¼˜åŒ–å»ºè®®

**å¸¸è§æ€§èƒ½ç“¶é¢ˆ**ï¼š
1. **LLMæ·±åº¦è§£è¯»**ï¼šé€šå¸¸æ˜¯æœ€æ…¢çš„é˜¶æ®µï¼ˆ500-2000msï¼‰ï¼Œå»ºè®®ï¼š
   - ä½¿ç”¨æµå¼è¾“å‡ºæå‡ç”¨æˆ·ä½“éªŒ
   - è€ƒè™‘ç¼“å­˜å¸¸è§é—®é¢˜çš„ç»“æœ
   - ä¼˜åŒ–æç¤ºè¯å‡å°‘å“åº”æ—¶é—´

2. **æµå¹´å¤§è¿åˆ†æ**ï¼šå¯èƒ½è¾ƒæ…¢ï¼ˆ500-1000msï¼‰ï¼Œå»ºè®®ï¼š
   - ä»…åœ¨éœ€è¦æ—¶å¯ç”¨ï¼ˆ`include_fortune_context=True`ï¼‰
   - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
   - è€ƒè™‘ç¼“å­˜è®¡ç®—ç»“æœ

3. **è§„åˆ™åŒ¹é…**ï¼šå¯èƒ½è¾ƒæ…¢ï¼ˆ100-300msï¼‰ï¼Œå»ºè®®ï¼š
   - ä¼˜åŒ–è§„åˆ™åŒ¹é…ç®—æ³•
   - ä½¿ç”¨ç´¢å¼•åŠ é€Ÿæ•°æ®åº“æŸ¥è¯¢
   - è€ƒè™‘ç¼“å­˜åŒ¹é…ç»“æœ

### ğŸ“ æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
================================================================================
[PerformanceMonitor] [req_1234567890] æ€§èƒ½æ‘˜è¦
================================================================================
æ€»è€—æ—¶: 2249ms (2.249s)
é˜¶æ®µæ•°: 6

å„é˜¶æ®µè€—æ—¶:
  âœ… intent_recognition: 50ms (intents_count: 1, confidence: 0.85, method: local_model)
  âœ… bazi_calculation: 23ms
  âœ… rule_matching: 155ms (matched_rules_count: 25, rule_types_count: 1)
  âœ… fortune_context: 803ms (liunian_count: 3)
  âœ… llm_analysis: 1202ms (analysis_length: 500)
  âœ… response_generation: 12ms (response_length: 2000)

âš ï¸ æ€§èƒ½ç“¶é¢ˆï¼ˆ>1ç§’ï¼‰:
  - llm_analysis: 1202ms - LLMæ·±åº¦è§£è¯»
================================================================================
```

### ğŸ¯ æ€§èƒ½ç›®æ ‡

| é˜¶æ®µ | ç›®æ ‡è€—æ—¶ | è­¦å‘Šé˜ˆå€¼ | è¯´æ˜ |
|------|---------|---------|------|
| æ„å›¾è¯†åˆ« | < 100ms | > 200ms | ä½¿ç”¨æ··åˆæ¶æ„ï¼Œå¤§éƒ¨åˆ†è¯·æ±‚åº” < 100ms |
| å…«å­—è®¡ç®— | < 50ms | > 100ms | æœ¬åœ°è®¡ç®—ï¼Œåº”è¯¥å¾ˆå¿« |
| è§„åˆ™åŒ¹é… | < 200ms | > 500ms | æ•°æ®åº“æŸ¥è¯¢ï¼Œå¯èƒ½è¾ƒæ…¢ |
| æµå¹´å¤§è¿ | < 1000ms | > 2000ms | å¯é€‰åŠŸèƒ½ï¼Œå¯èƒ½è¾ƒæ…¢ |
| LLMæ·±åº¦è§£è¯» | < 2000ms | > 5000ms | å¯é€‰åŠŸèƒ½ï¼Œé€šå¸¸æœ€æ…¢ |
| ç”Ÿæˆå“åº” | < 50ms | > 100ms | æ–‡æœ¬ç”Ÿæˆï¼Œåº”è¯¥å¾ˆå¿« |

**æ€»è€—æ—¶ç›®æ ‡**ï¼š
- ä¸åŒ…å«æµå¹´å¤§è¿å’ŒLLMï¼š< 500ms
- åŒ…å«æµå¹´å¤§è¿ï¼š< 2000ms
- åŒ…å«æµå¹´å¤§è¿å’ŒLLMï¼š< 5000ms

---

**æ ¸å¿ƒè¦ç‚¹**ï¼š
- **æ‰€æœ‰æ™ºèƒ½è¿åŠ¿åˆ†ææµç¨‹å¿…é¡»ä½¿ç”¨ `PerformanceMonitor` è®°å½•æ€§èƒ½**
- **æ€§èƒ½æ‘˜è¦å¿…é¡»åŒ…å«åœ¨APIå“åº”ä¸­**
- **å¿…é¡»è¯†åˆ«å¹¶è®°å½•æ€§èƒ½ç“¶é¢ˆï¼ˆ>1ç§’ï¼‰**
- **å¿…é¡»è®°å½•å¤±è´¥çš„é˜¶æ®µå’Œé”™è¯¯ä¿¡æ¯**

---

## ğŸ§ª æµ‹è¯•å¼€å‘è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

### ğŸ”´ æ ¸å¿ƒåŸåˆ™

> **æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»åŒæ­¥ç¼–å†™æµ‹è¯•æ¡ˆä¾‹ï¼Œæµ‹è¯•è¦†ç›–ç‡å¿…é¡»è¾¾åˆ° 50% ä»¥ä¸Šã€‚**

### ğŸ“‹ æµ‹è¯•è¦æ±‚

#### 1. æ–°å¢åŠŸèƒ½å¿…é¡»åŒæ­¥ç¼–å†™æµ‹è¯•

**è¦æ±‚**ï¼š
- âœ… æ–°å¢ API ç«¯ç‚¹å¿…é¡»ç¼–å†™å¯¹åº”çš„æµ‹è¯•æ¡ˆä¾‹
- âœ… æ–°å¢æœåŠ¡åŠŸèƒ½å¿…é¡»ç¼–å†™å•å…ƒæµ‹è¯•
- âœ… æ–°å¢ä¸šåŠ¡é€»è¾‘å¿…é¡»ç¼–å†™é›†æˆæµ‹è¯•
- âœ… ä¿®æ”¹ç°æœ‰åŠŸèƒ½å¿…é¡»æ›´æ–°ç›¸å…³æµ‹è¯•

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ–°åŠŸèƒ½æ˜¯å¦æœ‰å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶
- [ ] æµ‹è¯•æ˜¯å¦è¦†ç›–æ­£å¸¸æµç¨‹
- [ ] æµ‹è¯•æ˜¯å¦è¦†ç›–å¼‚å¸¸æµç¨‹
- [ ] æµ‹è¯•æ˜¯å¦è¦†ç›–è¾¹ç•Œæƒ…å†µ
- [ ] æµ‹è¯•æ˜¯å¦é€šè¿‡ CI/CD éªŒè¯

#### 2. æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

**è¦†ç›–ç‡ç›®æ ‡**ï¼š
- **å•å…ƒæµ‹è¯•è¦†ç›–ç‡**ï¼šâ‰¥ 50%ï¼ˆæ ¸å¿ƒæ¨¡å— â‰¥ 70%ï¼‰
- **API æµ‹è¯•è¦†ç›–ç‡**ï¼šâ‰¥ 80%ï¼ˆæ‰€æœ‰å…¬å¼€ API å¿…é¡»æœ‰æµ‹è¯•ï¼‰
- **é›†æˆæµ‹è¯•è¦†ç›–ç‡**ï¼šâ‰¥ 60%ï¼ˆå…³é”®ä¸šåŠ¡æµç¨‹å¿…é¡»æœ‰æµ‹è¯•ï¼‰

**æ£€æŸ¥å‘½ä»¤**ï¼š
```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/ --cov=server --cov=src --cov-report=html --cov-report=term-missing

# æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š
open htmlcov/index.html  # macOS
# æˆ–è®¿é—® htmlcov/index.html
```

#### 3. æµ‹è¯•åˆ†ç±»å’Œå‘½åè§„èŒƒ

**æµ‹è¯•æ–‡ä»¶å‘½å**ï¼š
- å•å…ƒæµ‹è¯•ï¼š`tests/unit/test_<module_name>.py`
- é›†æˆæµ‹è¯•ï¼š`tests/integration/test_<feature_name>.py`
- API æµ‹è¯•ï¼š`tests/api/test_<api_name>.py`
- åŠŸèƒ½æµ‹è¯•ï¼š`tests/features/test_<feature_name>.py`
- ç«¯åˆ°ç«¯æµ‹è¯•ï¼š`tests/e2e/test_<scenario_name>.py`

**æµ‹è¯•å‡½æ•°å‘½å**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ test_ å‰ç¼€
def test_calculate_bazi_success():
    """æµ‹è¯•æˆåŠŸè®¡ç®—å…«å­—"""
    ...

def test_calculate_bazi_invalid_date():
    """æµ‹è¯•æ— æ•ˆæ—¥æœŸè¾“å…¥"""
    ...

# âŒ é”™è¯¯ï¼šä¸ä½¿ç”¨ test_ å‰ç¼€
def calculate_bazi_test():
    ...
```

**æµ‹è¯•ç±»å‘½å**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ Test å‰ç¼€
class TestBaziService:
    """å…«å­—æœåŠ¡æµ‹è¯•ç±»"""
    ...

# âŒ é”™è¯¯ï¼šä¸ä½¿ç”¨ Test å‰ç¼€
class BaziServiceTest:
    ...
```

#### 4. æµ‹è¯•æ ‡è®°ï¼ˆMarkersï¼‰

**ä½¿ç”¨ pytest markers åˆ†ç±»æµ‹è¯•**ï¼š
```python
import pytest

@pytest.mark.unit
def test_calculate_bazi():
    """å•å…ƒæµ‹è¯•"""
    ...

@pytest.mark.integration
def test_api_integration():
    """é›†æˆæµ‹è¯•"""
    ...

@pytest.mark.api
def test_bazi_api():
    """API æµ‹è¯•"""
    ...

@pytest.mark.e2e
def test_end_to_end():
    """ç«¯åˆ°ç«¯æµ‹è¯•"""
    ...

@pytest.mark.slow
def test_performance():
    """æ…¢é€Ÿæµ‹è¯•ï¼ˆæ€§èƒ½æµ‹è¯•ï¼‰"""
    ...
```

**è¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•**ï¼š
```bash
# åªè¿è¡Œå•å…ƒæµ‹è¯•
pytest -m unit

# åªè¿è¡Œé›†æˆæµ‹è¯•
pytest -m integration

# åªè¿è¡Œ API æµ‹è¯•
pytest -m api

# æ’é™¤æ…¢é€Ÿæµ‹è¯•
pytest -m "not slow"
```

#### 5. æµ‹è¯•æ•°æ®ç®¡ç†

**ä½¿ç”¨ fixtures ç®¡ç†æµ‹è¯•æ•°æ®**ï¼š
```python
# tests/conftest.py
import pytest
from server.services.bazi_service import BaziService

@pytest.fixture
def sample_bazi_data():
    """ç¤ºä¾‹å…«å­—æ•°æ®"""
    return {
        "solar_date": "1990-01-15",
        "solar_time": "12:00",
        "gender": "male"
    }

@pytest.fixture
def bazi_service():
    """å…«å­—æœåŠ¡å®ä¾‹"""
    return BaziService()
```

**ä½¿ç”¨å‚æ•°åŒ–æµ‹è¯•**ï¼š
```python
import pytest

@pytest.mark.parametrize("solar_date,solar_time,gender,expected", [
    ("1990-01-15", "12:00", "male", "åºšåˆ"),
    ("1995-05-20", "14:30", "female", "ä¹™äº¥"),
])
def test_calculate_bazi(solar_date, solar_time, gender, expected):
    """å‚æ•°åŒ–æµ‹è¯•"""
    result = calculate_bazi(solar_date, solar_time, gender)
    assert result["day_pillar"] == expected
```

#### 6. æµ‹è¯•æ‰§è¡Œè§„èŒƒ

**æœ¬åœ°å¼€å‘æ—¶**ï¼š
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæ–‡ä»¶
pytest tests/unit/test_bazi_service.py

# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°
pytest tests/unit/test_bazi_service.py::test_calculate_bazi

# è¿è¡Œå¹¶æ˜¾ç¤ºè¦†ç›–ç‡
pytest --cov=server --cov=src --cov-report=term-missing
```

**æäº¤ä»£ç å‰**ï¼š
```bash
# å¿…é¡»è¿è¡Œæµ‹è¯•ï¼Œç¡®ä¿é€šè¿‡
pytest tests/

# æ£€æŸ¥è¦†ç›–ç‡
pytest --cov=server --cov=src --cov-report=term-missing --cov-fail-under=50
```

#### 7. CI/CD è‡ªåŠ¨æµ‹è¯•

**è§¦å‘æ¡ä»¶**ï¼š
- âœ… æ¨é€åˆ° `master` æˆ– `develop` åˆ†æ”¯
- âœ… åˆ›å»º Pull Request
- âœ… æ‰‹åŠ¨è§¦å‘ï¼ˆGitHub Actionsï¼‰

**æµ‹è¯•æµç¨‹**ï¼š
1. **ä»£ç è´¨é‡æ£€æŸ¥**ï¼ˆlintï¼‰
   - Black ä»£ç æ ¼å¼æ£€æŸ¥
   - isort å¯¼å…¥æ’åºæ£€æŸ¥
   - pylint ä»£ç è´¨é‡æ£€æŸ¥
   - mypy ç±»å‹æ£€æŸ¥

2. **å•å…ƒæµ‹è¯•**ï¼ˆtestï¼‰
   - è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
   - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
   - ä¸Šä¼ åˆ° Codecov

3. **é›†æˆæµ‹è¯•**ï¼ˆintegration-testï¼‰
   - è¿è¡Œé›†æˆæµ‹è¯•
   - éªŒè¯ API é›†æˆ

**æµ‹è¯•ç»“æœç›‘æ§**ï¼š
- **GitHub Actions**ï¼š`.github/workflows/ci.yml`
- **Codecov**ï¼šè¦†ç›–ç‡æŠ¥å‘Šå’Œè¶‹åŠ¿
- **æµ‹è¯•æŠ¥å‘Š**ï¼š`htmlcov/index.html`ï¼ˆæœ¬åœ°ï¼‰

#### 8. æµ‹è¯•å¤±è´¥å¤„ç†

**æµ‹è¯•å¤±è´¥æ—¶**ï¼š
1. **æŸ¥çœ‹æµ‹è¯•æ—¥å¿—**ï¼šGitHub Actions è¾“å‡º
2. **æœ¬åœ°å¤ç°**ï¼šåœ¨æœ¬åœ°è¿è¡Œå¤±è´¥çš„æµ‹è¯•
3. **ä¿®å¤é—®é¢˜**ï¼šä¿®å¤ä»£ç æˆ–æ›´æ–°æµ‹è¯•
4. **é‡æ–°æäº¤**ï¼šç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡

**ç¦æ­¢æ“ä½œ**ï¼š
- âŒ ç¦æ­¢è·³è¿‡å¤±è´¥çš„æµ‹è¯•ï¼ˆé™¤éæ˜¯å·²çŸ¥é—®é¢˜ï¼‰
- âŒ ç¦æ­¢é™ä½æµ‹è¯•è¦†ç›–ç‡è¦æ±‚
- âŒ ç¦æ­¢åˆ é™¤å¤±è´¥çš„æµ‹è¯•

#### 9. æµ‹è¯•æœ€ä½³å®è·µ

**ç¼–å†™æµ‹è¯•çš„åŸåˆ™**ï¼š
1. **ç‹¬ç«‹æ€§**ï¼šæ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•
2. **å¯é‡å¤æ€§**ï¼šæµ‹è¯•ç»“æœåº”è¯¥ä¸€è‡´ï¼Œä¸ä¾èµ–å¤–éƒ¨çŠ¶æ€
3. **å¿«é€Ÿæ‰§è¡Œ**ï¼šå•å…ƒæµ‹è¯•åº”è¯¥å¿«é€Ÿæ‰§è¡Œï¼ˆ< 1ç§’ï¼‰
4. **æ¸…æ™°å‘½å**ï¼šæµ‹è¯•åç§°åº”è¯¥æ¸…æ™°æè¿°æµ‹è¯•å†…å®¹
5. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæµ‹è¯•åªæµ‹è¯•ä¸€ä¸ªåŠŸèƒ½ç‚¹

**ç¤ºä¾‹**ï¼š
```python
# âœ… å¥½çš„æµ‹è¯•
def test_calculate_bazi_with_valid_date():
    """æµ‹è¯•ï¼šä½¿ç”¨æœ‰æ•ˆæ—¥æœŸè®¡ç®—å…«å­—"""
    result = calculate_bazi("1990-01-15", "12:00", "male")
    assert result["success"] == True
    assert "bazi" in result

# âŒ ä¸å¥½çš„æµ‹è¯•
def test_all():
    """æµ‹è¯•æ‰€æœ‰åŠŸèƒ½"""
    # æµ‹è¯•å¤ªå¤šå†…å®¹ï¼Œéš¾ä»¥å®šä½é—®é¢˜
    ...
```

#### 10. æµ‹è¯•è¦†ç›–ç‡ç›‘æ§

**è¦†ç›–ç‡æŠ¥å‘Šä½ç½®**ï¼š
- **æœ¬åœ°**ï¼š`htmlcov/index.html`
- **CI/CD**ï¼šGitHub Actions è¾“å‡º
- **åœ¨çº¿**ï¼šCodecovï¼ˆå¦‚æœé…ç½®ï¼‰

**è¦†ç›–ç‡è¦æ±‚**ï¼š
- **æ•´ä½“è¦†ç›–ç‡**ï¼šâ‰¥ 50%
- **æ ¸å¿ƒæ¨¡å—**ï¼ˆserver/services/ï¼‰ï¼šâ‰¥ 70%
- **API ç«¯ç‚¹**ï¼ˆserver/api/ï¼‰ï¼šâ‰¥ 80%
- **å·¥å…·å‡½æ•°**ï¼ˆserver/utils/ï¼‰ï¼šâ‰¥ 60%

**æŸ¥çœ‹è¦†ç›–ç‡**ï¼š
```bash
# ç”Ÿæˆ HTML æŠ¥å‘Š
pytest --cov=server --cov=src --cov-report=html

# æŸ¥çœ‹æŠ¥å‘Š
open htmlcov/index.html
```

---

### ğŸ“ æµ‹è¯•å¼€å‘æ£€æŸ¥æ¸…å•

æ¯æ¬¡å¼€å‘æ–°åŠŸèƒ½æ—¶ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

- [ ] æ˜¯å¦åˆ›å»ºäº†å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶
- [ ] æ˜¯å¦ç¼–å†™äº†æ­£å¸¸æµç¨‹æµ‹è¯•
- [ ] æ˜¯å¦ç¼–å†™äº†å¼‚å¸¸æµç¨‹æµ‹è¯•
- [ ] æ˜¯å¦ç¼–å†™äº†è¾¹ç•Œæƒ…å†µæµ‹è¯•
- [ ] æµ‹è¯•æ˜¯å¦é€šè¿‡æœ¬åœ°è¿è¡Œ
- [ ] æµ‹è¯•æ˜¯å¦é€šè¿‡ CI/CD éªŒè¯
- [ ] è¦†ç›–ç‡æ˜¯å¦è¾¾åˆ°è¦æ±‚ï¼ˆâ‰¥ 50%ï¼‰
- [ ] æ˜¯å¦æ›´æ–°äº†æµ‹è¯•æ–‡æ¡£

---

### ğŸš¨ æµ‹è¯•è§„èŒƒè¿åå¤„ç†

**å¦‚æœå‘ç°è¿åæµ‹è¯•è§„èŒƒ**ï¼š
1. **ç«‹å³ä¿®å¤**ï¼šè¡¥å……ç¼ºå¤±çš„æµ‹è¯•
2. **æ›´æ–°è§„èŒƒ**ï¼šå¦‚æœè§„èŒƒä¸åˆç†ï¼Œæ›´æ–°è§„èŒƒ
3. **è®°å½•é—®é¢˜**ï¼šåœ¨å¼€å‘æ—¥å¿—ä¸­è®°å½•é—®é¢˜
4. **é˜²æ­¢å†æ¬¡å‘ç”Ÿ**ï¼šæ›´æ–°æ£€æŸ¥æ¸…å•

---

**æ ¸å¿ƒè¦ç‚¹**ï¼š
- **æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»åŒæ­¥ç¼–å†™æµ‹è¯•æ¡ˆä¾‹**
- **æµ‹è¯•è¦†ç›–ç‡å¿…é¡»è¾¾åˆ° 50% ä»¥ä¸Š**
- **æ‰€æœ‰æµ‹è¯•å¿…é¡»é€šè¿‡ CI/CD éªŒè¯**
- **æµ‹è¯•å¤±è´¥å¿…é¡»ä¿®å¤åæ‰èƒ½åˆå¹¶ä»£ç **

---

## ğŸ—ï¸ ç”Ÿäº§ç¯å¢ƒæ¶æ„è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

### ğŸ”´ æ ¸å¿ƒåŸåˆ™

> **ç”Ÿäº§ç¯å¢ƒæ¶æ„ä¿¡æ¯å¿…é¡»è®°å½•åœ¨å¼€å‘è§„èŒƒä¸­ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç»§æ‰¿æ€§ã€ç¨³å®šæ€§å’Œå¯ç”¨æ€§ã€‚**

### ğŸ“‹ ç”Ÿäº§ç¯å¢ƒæ¶æ„

#### åŒæœºéƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”Ÿäº§ç¯å¢ƒåŒæœºæ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚      Node1 (ä¸»èŠ‚ç‚¹)   â”‚         â”‚      Node2 (ä»èŠ‚ç‚¹)   â”‚    â”‚
â”‚  â”‚  8.210.52.217        â”‚         â”‚  47.243.160.43       â”‚    â”‚
â”‚  â”‚  172.18.121.222      â”‚         â”‚  172.18.121.223      â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  Nginx (80/443)      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Nginx (80/443)      â”‚    â”‚
â”‚  â”‚  Web (8001)          â”‚         â”‚  Web (8001)          â”‚    â”‚
â”‚  â”‚  MySQL ä¸»åº“ (3306)   â”‚â—„â”€â”€å¤åˆ¶â”€â”€â–ºâ”‚  MySQL ä»åº“ (3306)   â”‚    â”‚
â”‚  â”‚  Redis ä¸»åº“ (6379)   â”‚â—„â”€â”€å¤åˆ¶â”€â”€â–ºâ”‚  Redis ä»åº“ (6379)   â”‚    â”‚
â”‚  â”‚  å¾®æœåŠ¡ (9001-9010)  â”‚         â”‚  å¾®æœåŠ¡ (9001-9010)  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æœåŠ¡å™¨ä¿¡æ¯

| èŠ‚ç‚¹ | å…¬ç½‘IP | å†…ç½‘IP | è§’è‰² | çŠ¶æ€ |
|------|--------|--------|------|------|
| Node1 | 8.210.52.217 | 172.18.121.222 | ä¸»èŠ‚ç‚¹ï¼ˆMySQLä¸»/Redisä¸»ï¼‰ | âœ… è¿è¡Œä¸­ |
| Node2 | 47.243.160.43 | 172.18.121.223 | ä»èŠ‚ç‚¹ï¼ˆMySQLä»/Redisä»ï¼‰ | âœ… è¿è¡Œä¸­ |
| æµ‹è¯•ç¯å¢ƒ | 123.57.216.15 | - | æµ‹è¯•ç¯å¢ƒ | âœ… è¿è¡Œä¸­ |

#### æœåŠ¡ç«¯å£æ¸…å•

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| Nginx | 80, 443 | è´Ÿè½½å‡è¡¡å’Œåå‘ä»£ç† |
| Web æœåŠ¡ | 8001 | FastAPI ä¸»æœåŠ¡ |
| bazi-core | 9001 | å…«å­—æ ¸å¿ƒè®¡ç®—æœåŠ¡ |
| bazi-fortune | 9002 | è¿åŠ¿è®¡ç®—æœåŠ¡ |
| bazi-analyzer | 9003 | å…«å­—åˆ†ææœåŠ¡ |
| bazi-rule | 9004 | è§„åˆ™åŒ¹é…æœåŠ¡ |
| fortune-analysis | 9005 | è¿åŠ¿åˆ†ææœåŠ¡ |
| payment-service | 9006 | æ”¯ä»˜æœåŠ¡ |
| fortune-rule | 9007 | è¿åŠ¿è§„åˆ™æœåŠ¡ |
| intent-service | 9008 | æ„å›¾è¯†åˆ«æœåŠ¡ |
| prompt-optimizer | 9009 | æç¤ºä¼˜åŒ–æœåŠ¡ |
| desk-fengshui | 9010 | åŠå…¬æ¡Œé£æ°´åˆ†ææœåŠ¡ |
| MySQL | 3306 | æ•°æ®åº“ |
| Redis | 6379 | ç¼“å­˜ |

#### è´Ÿè½½å‡è¡¡é…ç½®

**Nginx è´Ÿè½½å‡è¡¡**ï¼š
- **ä¸Šæ¸¸æœåŠ¡å™¨**ï¼šä½¿ç”¨å†…ç½‘IPï¼ˆ172.18.121.222/223ï¼‰
- **è´Ÿè½½å‡è¡¡ç®—æ³•**ï¼šè½®è¯¢ï¼ˆweight=1ï¼‰
- **æ•…éšœè½¬ç§»**ï¼š`max_fails=3 fail_timeout=30s`
- **å¥åº·æ£€æŸ¥**ï¼šè‡ªåŠ¨æ£€æµ‹æœåŠ¡çŠ¶æ€ï¼Œæ•…éšœæ—¶åˆ‡æ¢åˆ°å¤‡ç”¨èŠ‚ç‚¹

**è¶…æ—¶é…ç½®**ï¼ˆå·²ä¼˜åŒ–ï¼‰ï¼š
```nginx
proxy_connect_timeout 10s;   # è¿æ¥è¶…æ—¶ï¼š10ç§’ï¼ˆå¿«é€Ÿæ£€æµ‹æœåŠ¡ä¸å¯ç”¨ï¼‰
proxy_send_timeout 30s;      # å‘é€è¶…æ—¶ï¼š30ç§’ï¼ˆé€‚åˆå¤§å¤šæ•°APIï¼‰
proxy_read_timeout 30s;      # è¯»å–è¶…æ—¶ï¼š30ç§’ï¼ˆé€‚åˆå¤§å¤šæ•°APIï¼‰
proxy_next_upstream_timeout 5s;  # æ•…éšœè½¬ç§»è¶…æ—¶ï¼š5ç§’ï¼ˆå¿«é€Ÿåˆ‡æ¢ï¼‰
```

#### æ•°æ®åº“ä¸»ä»å¤åˆ¶

**MySQL ä¸»ä»å¤åˆ¶**ï¼š
- **ä¸»åº“**ï¼šNode1 (172.18.121.222:3306)
- **ä»åº“**ï¼šNode2 (172.18.121.223:3306)
- **å¤åˆ¶ç”¨æˆ·**ï¼š`repl@%`
- **å¤åˆ¶æ–¹å¼**ï¼šGTID è‡ªåŠ¨å®šä½
- **çŠ¶æ€æ£€æŸ¥**ï¼š
  ```sql
  SHOW SLAVE STATUS\G
  -- Slave_IO_Running: Yes
  -- Slave_SQL_Running: Yes
  -- Seconds_Behind_Master: 0
  ```

**Redis ä¸»ä»å¤åˆ¶**ï¼š
- **ä¸»åº“**ï¼šNode1 (172.18.121.222:6379)
- **ä»åº“**ï¼šNode2 (172.18.121.223:6379)
- **å¤åˆ¶æ–¹å¼**ï¼šè‡ªåŠ¨åŒæ­¥

#### éƒ¨ç½²é…ç½®ä¿¡æ¯

**ç¯å¢ƒå˜é‡**ï¼š
- **MySQL å¯†ç **ï¼š`Yuanqizhan@163`
- **MySQL å¤åˆ¶å¯†ç **ï¼š`Yuanqizhan@163`
- **SECRET_KEY**ï¼š`kx9078L34ZoROnneJu8fMmJ70JImvVan88JYvxiewbE`
- **ACR ç”¨æˆ·å**ï¼šä»ç¯å¢ƒå˜é‡ `ACR_USERNAME` æˆ– `ACR_ACCESS_KEY_ID` è¯»å–
- **ACR å¯†ç **ï¼šä»ç¯å¢ƒå˜é‡ `ACR_PASSWORD` æˆ– `ACR_ACCESS_KEY_SECRET` è¯»å–
- **Git ä»“åº“**ï¼š`https://github.com/zhoudengt/HiFate-bazi`

**é¡¹ç›®ç›®å½•**ï¼š
- **ä»£ç ç›®å½•**ï¼š`/opt/HiFate-bazi`
- **éƒ¨ç½²é…ç½®**ï¼š`/opt/HiFate-bazi/deploy/docker`
- **ç¯å¢ƒå˜é‡**ï¼š`/opt/HiFate-bazi/.env`
- **æ—¥å¿—ç›®å½•**ï¼š`/opt/HiFate-bazi/logs`

---

### ğŸ”§ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è§„èŒƒ

#### éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

- [ ] ç¡®è®¤æœåŠ¡å™¨å·²åˆå§‹åŒ–ï¼ˆDocker å·²å®‰è£…ï¼‰
- [ ] ç¡®è®¤ä»£ç å·²å…‹éš†åˆ° `/opt/HiFate-bazi`
- [ ] ç¡®è®¤ç¯å¢ƒå˜é‡å·²é…ç½®ï¼ˆ`.env` æ–‡ä»¶ï¼‰
- [ ] ç¡®è®¤ Nginx é…ç½®ä¸­çš„ IP å·²æ›¿æ¢ä¸ºå†…ç½‘ IP
- [ ] ç¡®è®¤ gRPC ä»£ç å·²ä¿®å¤ï¼ˆè¿è¡Œ `scripts/grpc/fix_version_check.py`ï¼‰
- [ ] ç¡®è®¤ MySQL ä¸»ä»å¤åˆ¶ç”¨æˆ·å·²åˆ›å»º
- [ ] ç¡®è®¤ Redis ä¸»ä»å¤åˆ¶å·²é…ç½®

#### éƒ¨ç½²æ­¥éª¤

1. **åˆå§‹åŒ–æœåŠ¡å™¨**ï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰ï¼š
   ```bash
   bash deploy/scripts/init-ecs.sh
   ```

2. **å…‹éš†ä»£ç **ï¼š
   ```bash
   cd /opt/HiFate-bazi
   git clone https://github.com/zhoudengt/HiFate-bazi .
   ```

3. **é…ç½®ç¯å¢ƒå˜é‡**ï¼š
   ```bash
   cp deploy/env/env.template .env
   vim .env  # ç¼–è¾‘é…ç½®
   ```

4. **ä¿®å¤ gRPC ä»£ç **ï¼ˆå¿…é¡»ï¼‰ï¼š
   ```bash
   python3 scripts/grpc/fix_version_check.py
   ```

5. **é…ç½® Nginx**ï¼ˆå¿…é¡»ï¼‰ï¼š
   ```bash
   # æ›¿æ¢ IP å ä½ç¬¦
   sed -i 's/NODE1_IP/172.18.121.222/g' deploy/nginx/conf.d/hifate.conf
   sed -i 's/NODE2_IP/172.18.121.223/g' deploy/nginx/conf.d/hifate.conf
   ```

6. **éƒ¨ç½²æœåŠ¡**ï¼š
   ```bash
   # Node1
   bash deploy/scripts/deploy.sh node1
   
   # Node2ï¼ˆåœ¨ Node1 éƒ¨ç½²å®Œæˆåï¼‰
   bash deploy/scripts/deploy.sh node2
   ```

7. **é…ç½® MySQL ä¸»ä»å¤åˆ¶**ï¼ˆNode2ï¼‰ï¼š
   ```sql
   -- åœ¨ Node1 åˆ›å»ºå¤åˆ¶ç”¨æˆ·
   CREATE USER 'repl'@'%' IDENTIFIED BY 'Yuanqizhan@163';
   GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
   FLUSH PRIVILEGES;
   
   -- åœ¨ Node2 é…ç½®ä»åº“
   CHANGE MASTER TO
       MASTER_HOST='172.18.121.222',
       MASTER_USER='repl',
       MASTER_PASSWORD='Yuanqizhan@163',
       MASTER_AUTO_POSITION=1;
   START SLAVE;
   ```

8. **éªŒè¯éƒ¨ç½²**ï¼š
   ```bash
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   docker ps | grep hifate
   
   # æ£€æŸ¥å¥åº·çŠ¶æ€
   curl http://8.210.52.217/health
   curl http://47.243.160.43/health
   
   # æ£€æŸ¥ MySQL ä¸»ä»å¤åˆ¶
   docker exec -it hifate-mysql-slave mysql -uroot -pYuanqizhan@163 -e "SHOW SLAVE STATUS\G"
   ```

#### æ—¥å¸¸è¿ç»´å‘½ä»¤

**æŸ¥çœ‹æœåŠ¡çŠ¶æ€**ï¼š
```bash
# Node1
ssh root@8.210.52.217 "docker ps | grep hifate"

# Node2
ssh root@47.243.160.43 "docker ps | grep hifate"
```

**æŸ¥çœ‹æ—¥å¿—**ï¼š
```bash
# Web æœåŠ¡æ—¥å¿—
docker logs hifate-web --tail 100

# å¾®æœåŠ¡æ—¥å¿—
docker logs hifate-bazi-core --tail 100

# Nginx æ—¥å¿—
docker logs hifate-nginx --tail 100
```

**é‡å¯æœåŠ¡**ï¼š
```bash
# é‡å¯å•ä¸ªæœåŠ¡
docker restart hifate-web

# é‡å¯æ‰€æœ‰æœåŠ¡
cd /opt/HiFate-bazi/deploy/docker
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml --env-file /opt/HiFate-bazi/.env restart
```

**æ›´æ–°ä»£ç **ï¼š
```bash
cd /opt/HiFate-bazi
git pull origin master
# å¦‚æœéœ€è¦é‡å¯æœåŠ¡
bash deploy/scripts/deploy.sh node1  # æˆ– node2
```

---

### âš ï¸ ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹

#### 1. è´Ÿè½½å‡è¡¡é…ç½®

**å¿…é¡»ä½¿ç”¨å†…ç½‘ IP**ï¼š
- âœ… æ­£ç¡®ï¼š`server 172.18.121.222:8001`
- âŒ é”™è¯¯ï¼š`server 8.210.52.217:8001`ï¼ˆå…¬ç½‘IPï¼Œå»¶è¿Ÿé«˜ï¼‰
- âŒ é”™è¯¯ï¼š`server NODE1_IP:8001`ï¼ˆå ä½ç¬¦æœªæ›¿æ¢ï¼‰

**æ£€æŸ¥æ–¹æ³•**ï¼š
```bash
docker exec hifate-nginx cat /etc/nginx/conf.d/hifate.conf | grep upstream
```

#### 2. gRPC ç‰ˆæœ¬å…¼å®¹æ€§

**éƒ¨ç½²å‰å¿…é¡»ä¿®å¤**ï¼š
```bash
python3 scripts/grpc/fix_version_check.py
```

**é—®é¢˜ç°è±¡**ï¼š
- å¾®æœåŠ¡æŒç»­é‡å¯
- é”™è¯¯ï¼š`AttributeError: '_Server' object has no attribute 'add_registered_method_handlers'`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è¿è¡Œä¿®å¤è„šæœ¬
- é‡å¯å¾®æœåŠ¡

#### 3. Nginx è¶…æ—¶ä¼˜åŒ–

**å·²ä¼˜åŒ–é…ç½®**ï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰ï¼š
- è¿æ¥è¶…æ—¶ï¼š10ç§’ï¼ˆå¿«é€Ÿæ£€æµ‹æœåŠ¡ä¸å¯ç”¨ï¼‰
- å‘é€/è¯»å–è¶…æ—¶ï¼š30ç§’ï¼ˆé€‚åˆå¤§å¤šæ•°APIï¼‰
- æ•…éšœè½¬ç§»è¶…æ—¶ï¼š5ç§’ï¼ˆå¿«é€Ÿåˆ‡æ¢ï¼‰

#### 4. æœåŠ¡å¥åº·æ£€æŸ¥

**å®šæœŸæ£€æŸ¥**ï¼š
- æœåŠ¡çŠ¶æ€ï¼š`docker ps | grep hifate`
- å¥åº·æ£€æŸ¥ï¼š`curl http://8.210.52.217/health`
- MySQL ä¸»ä»å¤åˆ¶ï¼š`SHOW SLAVE STATUS\G`
- Nginx çŠ¶æ€ï¼š`curl http://8.210.52.217/nginx_status`

#### 5. æ€§èƒ½ç›‘æ§

**å…³é”®æŒ‡æ ‡**ï¼š
- API å“åº”æ—¶é—´ï¼š< 2ç§’ï¼ˆæ­£å¸¸ï¼‰
- æœåŠ¡é‡å¯æ¬¡æ•°ï¼š0ï¼ˆæ­£å¸¸ï¼‰
- MySQL ä¸»ä»å»¶è¿Ÿï¼š0ç§’ï¼ˆæ­£å¸¸ï¼‰
- è´Ÿè½½å‡è¡¡çŠ¶æ€ï¼šä¸¤ä¸ªèŠ‚ç‚¹éƒ½æ­£å¸¸

---

### ğŸ“š ç›¸å…³æ–‡æ¡£

- **éƒ¨ç½²æ–‡æ¡£**ï¼š`docs/root_docs/ç”Ÿäº§ç¯å¢ƒåŒæœºéƒ¨ç½²æŒ‡å—.md`
- **éƒ¨ç½²æŠ¥å‘Š**ï¼š`docs/root_docs/ç”Ÿäº§ç¯å¢ƒåŒæœºéƒ¨ç½²æœ€ç»ˆæŠ¥å‘Š.md`
- **é—®é¢˜è¯Šæ–­**ï¼š`docs/root_docs/åŒæœºéƒ¨ç½²é—®é¢˜è¯Šæ–­æŠ¥å‘Š.md`

---

---

## ğŸ“ å‰ç«¯ç›®å½•è§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

### ğŸ”´ æ ¸å¿ƒåŸåˆ™

> **æœ¬åœ°å‰ç«¯ç›®å½•å‘½åä¸º `local_frontend`ï¼Œä¸ç”Ÿäº§å‰ç«¯éƒ¨ç½²åˆ†ç¦»ã€‚**

### ğŸ“‹ ç›®å½•å‘½åè§„èŒƒ

| ç›®å½• | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| **`local_frontend/`** | âœ… **æœ¬åœ°å‰ç«¯ç›®å½•** | ç”¨äºæœ¬åœ°å¼€å‘ã€æµ‹è¯•ã€åŒæœºéƒ¨ç½² |
| **ç”Ÿäº§å‰ç«¯** | âœ… **ç‹¬ç«‹éƒ¨ç½²** | ç”±å‰ç«¯å›¢é˜Ÿç‹¬ç«‹éƒ¨ç½²ï¼Œä¸åœ¨æ­¤ä»“åº“ |

### ğŸ”§ é…ç½®è¦æ±‚

#### 1. Docker Compose é…ç½®

**ç”Ÿäº§ç¯å¢ƒé…ç½®** (`deploy/docker/docker-compose.prod.yml`)ï¼š
```yaml
volumes:
  - ../../local_frontend:/usr/share/nginx/html/local_frontend:ro
```

**æœ¬åœ°å‰ç«¯é…ç½®** (`docker-compose.frontend.yml`)ï¼š
```yaml
volumes:
  - ./local_frontend:/usr/share/nginx/html:ro
```

#### 2. Nginx é…ç½®

**æ‰€æœ‰ Nginx é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„**ï¼š
```nginx
root /usr/share/nginx/html/local_frontend;
```

#### 3. åç«¯ä»£ç é…ç½®

**`server/main.py`** ä¸­çš„é™æ€æ–‡ä»¶æŒ‚è½½ï¼š
```python
local_frontend_dir = os.path.join(project_root, "local_frontend")
if os.path.exists(local_frontend_dir):
    app.mount("/local_frontend", StaticFiles(directory=local_frontend_dir, html=True), name="local_frontend")
```

### âš ï¸ é‡è¦è¯´æ˜

1. **ç¦æ­¢ä¿®æ”¹ç”Ÿäº§å‰ç«¯**ï¼šç”Ÿäº§ç¯å¢ƒçš„å‰ç«¯ç”±å‰ç«¯å›¢é˜Ÿç‹¬ç«‹éƒ¨ç½²ï¼Œåç«¯å¼€å‘äººå‘˜ä¸å¾—ä¿®æ”¹
2. **æœ¬åœ°å‰ç«¯ä»…ç”¨äºå¼€å‘æµ‹è¯•**ï¼š`local_frontend` ç›®å½•ä»…ç”¨äºæœ¬åœ°å¼€å‘ã€æµ‹è¯•ç¯å¢ƒã€åŒæœºéƒ¨ç½²
3. **è·¯å¾„ä¸€è‡´æ€§**ï¼šæ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„å¿…é¡»ç»Ÿä¸€ä½¿ç”¨ `local_frontend`
4. **éƒ¨ç½²è„šæœ¬æ›´æ–°**ï¼šæ‰€æœ‰éƒ¨ç½²è„šæœ¬å¿…é¡»å¼•ç”¨ `local_frontend` ç›®å½•

### âœ… æ£€æŸ¥æ¸…å•

æ¯æ¬¡ä¿®æ”¹å‰ç«¯ç›¸å…³é…ç½®æ—¶ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

- [ ] Docker Compose é…ç½®ä¸­çš„è·¯å¾„æ˜¯å¦ä¸º `local_frontend`
- [ ] Nginx é…ç½®ä¸­çš„è·¯å¾„æ˜¯å¦ä¸º `local_frontend`
- [ ] åç«¯ä»£ç ä¸­çš„è·¯å¾„æ˜¯å¦ä¸º `local_frontend`
- [ ] éƒ¨ç½²è„šæœ¬ä¸­çš„è·¯å¾„æ˜¯å¦ä¸º `local_frontend`
- [ ] æ–‡æ¡£ä¸­çš„è·¯å¾„æ˜¯å¦ä¸º `local_frontend`

---

**æ ¸å¿ƒè¦ç‚¹**ï¼š
- **ç”Ÿäº§ç¯å¢ƒæ¶æ„ä¿¡æ¯å¿…é¡»è®°å½•åœ¨å¼€å‘è§„èŒƒä¸­**
- **éƒ¨ç½²å‰å¿…é¡»æ£€æŸ¥æ‰€æœ‰é…ç½®é¡¹**
- **å¿…é¡»ä½¿ç”¨å†…ç½‘ IP è¿›è¡Œè´Ÿè½½å‡è¡¡**
- **éƒ¨ç½²å‰å¿…é¡»ä¿®å¤ gRPC ä»£ç **
- **å®šæœŸæ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€**
- **æœ¬åœ°å‰ç«¯ç›®å½•å¿…é¡»ä½¿ç”¨ `local_frontend`ï¼Œä¸ç”Ÿäº§å‰ç«¯åˆ†ç¦»**
