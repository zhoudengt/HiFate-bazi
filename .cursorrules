# HiFate-bazi å…«å­—ç³»ç»Ÿ - AI å¼€å‘è§„èŒƒ

## âš ï¸ æ ¸å¿ƒåŸåˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰

### 1. æœ€å°å½±å“åŸåˆ™ ã€æœ€é‡è¦ã€‘
- **åšå†³ä¸å¯æ”¹åŠ¨ä¸ä¹‹æ— å…³çš„ä»£ç **
- ä¿®æ”¹ä¼šå¼•èµ·å…¶ä»–åŠŸèƒ½å˜åŒ–æ—¶ï¼Œ**å¿…é¡»å…ˆå’¨è¯¢ç”¨æˆ·**
- æ¯æ¬¡ä¿®æ”¹å‰æ˜ç¡®å½±å“èŒƒå›´ï¼ˆä½/ä¸­/é«˜ï¼‰
- é«˜å½±å“ä¿®æ”¹å¿…é¡»ç”¨æˆ·ç¡®è®¤

### 2. ä¿®æ”¹å‰æ£€æŸ¥æ¸…å•
```
ã€ä¿®æ”¹åˆ†æã€‘
âœ“ ä¿®æ”¹æ–‡ä»¶ï¼š[æœ€å°é›†åˆ]
âœ“ å½±å“èŒƒå›´ï¼š[ä½/ä¸­/é«˜]
âœ“ å½±å“åŠŸèƒ½ï¼š[åˆ—è¡¨]
âœ“ éœ€è¦ç¡®è®¤ï¼š[æ˜¯/å¦]
```

### 3. é«˜å½±å“å˜æ›´æ¨¡æ¿
```
âš ï¸ é«˜å½±å“å˜æ›´ï¼Œéœ€è¦æ‚¨ç¡®è®¤ï¼š
- ä¿®æ”¹å†…å®¹ï¼š...
- å½±å“èŒƒå›´ï¼š...
- é£é™©è¯„ä¼°ï¼š...
æ˜¯å¦ç»§ç»­ï¼Ÿ
```

---

## ğŸ“ é¡¹ç›®æ¶æ„

### å‰ç«¯æ¶æ„ `frontend/`
```
frontend/
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ fortune.js              # æ•°æ®é€»è¾‘å’ŒAPIè°ƒç”¨ï¼ˆä¸å¯æ”¹UIï¼‰
â”‚   â”œâ”€â”€ fortune-timeline.js     # æ¸²æŸ“å’ŒUIå±•ç¤ºï¼ˆä¸å¯æ”¹é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ bazi-monthly.js         # æœˆè¿å±•ç¤º
â”‚   â”œâ”€â”€ bazi-daily.js           # æ—¥è¿å±•ç¤º
â”‚   â””â”€â”€ config.js               # APIåœ°å€é…ç½®
â”œâ”€â”€ css/                        # æ ·å¼æ–‡ä»¶
â””â”€â”€ *.html                      # æµ‹è¯•é¡µé¢
```

**èŒè´£åˆ†æ˜**ï¼š
- `fortune.js` â†’ æ•°æ®è·å–ã€çŠ¶æ€ç®¡ç†
- `fortune-timeline.js` â†’ DOMæ¸²æŸ“ã€ç”¨æˆ·äº¤äº’
- ä¸å¯è·¨ç•Œä¿®æ”¹

### åç«¯æ¶æ„ `server/`
```
server/
â”œâ”€â”€ api/                # APIå±‚ï¼šè¯·æ±‚å¤„ç†ã€å‚æ•°éªŒè¯
â”‚   â”œâ”€â”€ bazi_api.py    # å…«å­—æ¥å£
â”‚   â”œâ”€â”€ fortune_api.py # è¿åŠ¿æ¥å£
â”‚   â””â”€â”€ ...
â”œâ”€â”€ services/           # Serviceå±‚ï¼šä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ rule_service.py         # è§„åˆ™åŒ¹é…
â”‚   â”œâ”€â”€ formula_rule_service.py # ç®—æ³•å…¬å¼
â”‚   â””â”€â”€ ...
â”œâ”€â”€ engines/            # è§„åˆ™å¼•æ“
â”‚   â”œâ”€â”€ rule_engine.py          # æ ¸å¿ƒå¼•æ“
â”‚   â””â”€â”€ rule_condition.py       # æ¡ä»¶åŒ¹é…
â”œâ”€â”€ db/                 # æ•°æ®åº“è¿æ¥
â””â”€â”€ main.py             # è·¯ç”±æ³¨å†Œ
```

**æ ¸å¿ƒå±‚ `src/`**ï¼š
```
src/
â”œâ”€â”€ bazi_calculator.py  # æ ¸å¿ƒå…«å­—è®¡ç®—
â”œâ”€â”€ bazi_*.py          # å„ç§å…«å­—ç›¸å…³è®¡ç®—
â””â”€â”€ ...
```

**å¾®æœåŠ¡ `services/`**ï¼š
```
services/
â”œâ”€â”€ bazi_analyzer_service.py    # å…«å­—åˆ†ææœåŠ¡
â”œâ”€â”€ fortune_analysis_service.py # è¿åŠ¿åˆ†ææœåŠ¡
â”œâ”€â”€ rule_service_grpc.py        # è§„åˆ™æœåŠ¡
â””â”€â”€ payment_service.py          # æ”¯ä»˜æœåŠ¡
```

**åˆ†å±‚åŸåˆ™**ï¼š
- åªä¿®æ”¹å¿…è¦çš„å±‚
- ä¸è·¨å±‚ä¿®æ”¹
- API â†’ Service â†’ Core å•å‘ä¾èµ–

---

## ğŸ”’ æ ¸å¿ƒæ–‡ä»¶ï¼ˆä¿®æ”¹å‰å¿…é¡»å’¨è¯¢ï¼‰

| æ–‡ä»¶ | ä½œç”¨ | é£é™© |
|------|------|------|
| `server/main.py` | è·¯ç”±æ³¨å†Œ | é«˜ |
| `src/bazi_calculator.py` | æ ¸å¿ƒè®¡ç®—é€»è¾‘ | æé«˜ |
| `frontend/js/fortune.js` | å‰ç«¯ä¸»é€»è¾‘ | é«˜ |
| `server/db/mysql_connector.py` | æ•°æ®åº“è¿æ¥ | é«˜ |
| `server/engines/*.py` | è§„åˆ™å¼•æ“ | é«˜ |
| `server/config/mysql_config.py` | MySQLé…ç½® | é«˜ |
| `proto/*.proto` | gRPCåè®®å®šä¹‰ | é«˜ |

---

## ğŸ”§ å¼€å‘è§„èŒƒ

### å­—ç¬¦ç¼–ç ï¼ˆé‡è¦ï¼‰
- **æ•°æ®åº“**ï¼š`utf8mb4`ï¼ˆæ”¯æŒä¸­æ–‡ã€emojiï¼‰
- **Python**ï¼šUTF-8ï¼ˆæ–‡ä»¶å¤´ `# -*- coding: utf-8 -*-`ï¼‰
- **JSON**ï¼š`json.dumps(..., ensure_ascii=False)`
- **MySQLè¿æ¥**ï¼š
  ```python
  'charset': 'utf8mb4',
  'use_unicode': True
  ```

### è§„åˆ™ç³»ç»Ÿ
**å­˜å‚¨**ï¼š
- è¡¨ï¼š`bazi_rules`
- å­—æ®µï¼š
  - `rule_code`ï¼šè§„åˆ™ç¼–ç ï¼ˆå¦‚ `FORMULA_HEALTH_70012`ï¼‰
  - `rule_type`ï¼šè§„åˆ™ç±»å‹ï¼ˆå¦‚ `FORMULA_HEALTH`ï¼‰
  - `conditions`ï¼šJSONæ ¼å¼æ¡ä»¶
  - `description`ï¼šJSONæ ¼å¼æè¿°

**æ¡ä»¶æ ¼å¼**ï¼š
```json
{
  "pillar_in": {"pillar": "day", "part": "stem", "values": ["ç”²", "ä¹™"]},
  "element_count": {"element": "æœ¨", "operator": ">=", "value": 3},
  "gender": "male"
}
```

**ç¼“å­˜æœºåˆ¶**ï¼š
- Redisç¼“å­˜è§„åˆ™
- ä¿®æ”¹è§„åˆ™å**å¿…é¡»æ¸…ç†ç¼“å­˜**ï¼š
  ```bash
  redis-cli DEL "rules:FORMULA_HEALTH"
  ```

### æ•°æ®åº“æ“ä½œ
**å­—ç¬¦ç¼–ç å¤„ç†**ï¼š
```python
# è¯»å–æ—¶ï¼ˆä¿®å¤ pymysql çš„ latin1 é—®é¢˜ï¼‰
conditions = rule['conditions']
if isinstance(conditions, str):
    try:
        conditions = conditions.encode('latin1').decode('utf-8')
    except:
        pass
    conditions = json.loads(conditions)

# å†™å…¥æ—¶
sql = f"UPDATE bazi_rules SET conditions = '{json.dumps(data, ensure_ascii=False)}' WHERE ..."
```

**æ‰§è¡ŒSQL**ï¼š
```bash
# ä½¿ç”¨ utf8mb4 å­—ç¬¦é›†
mysql -h 127.0.0.1 -P 13306 -u root -p --default-character-set=utf8mb4 bazi_system < script.sql
```

### APIè®¾è®¡
**è¯·æ±‚å‚æ•°**ï¼š
```python
# å¿…éœ€å‚æ•°éªŒè¯
if not year or not month:
    return jsonify({'error': 'ç¼ºå°‘å‚æ•°'}), 400

# ç±»å‹è½¬æ¢
year = int(year)
hour = int(hour) if hour else 12
```

**å“åº”æ ¼å¼**ï¼š
```python
{
    'success': True,
    'data': {...},
    'error': None
}
```

**é”™è¯¯å¤„ç†**ï¼š
```python
try:
    result = service.analyze(...)
    return jsonify({'success': True, 'data': result})
except Exception as e:
    logger.error(f"Error: {e}")
    return jsonify({'success': False, 'error': str(e)}), 500
```

### æ•°æ®ç»“æ„å…¼å®¹
- **åªæ·»åŠ æ–°å­—æ®µ**ï¼Œä¸ä¿®æ”¹/åˆ é™¤ç°æœ‰å­—æ®µ
- **ä¿æŒå‘åå…¼å®¹**
- APIæ¥å£å˜æ›´ â†’ **å¿…é¡»å’¨è¯¢ç”¨æˆ·**
- æ•°æ®åº“ schema å˜æ›´ â†’ **å¿…é¡»å’¨è¯¢ç”¨æˆ·**

---

## ğŸ› è°ƒè¯•å’Œæµ‹è¯•

### æ—¥å¿—æŸ¥çœ‹
```bash
# ä¸»æœåŠ¡æ—¥å¿—
tail -f logs/server.log

# å¾®æœåŠ¡æ—¥å¿—
tail -f logs/bazi_analyzer.log
tail -f logs/fortune_analysis.log

# é”™è¯¯æ—¥å¿—
grep "ERROR" logs/*.log
```

### æµ‹è¯•æµç¨‹
1. **åç«¯æµ‹è¯•**ï¼š
   ```bash
   # APIæµ‹è¯•
   curl http://localhost:8000/api/bazi/analyze?year=1990&month=1&day=1&hour=12&gender=male
   ```

2. **å‰ç«¯æµ‹è¯•**ï¼š
   - æ‰“å¼€ `frontend/formula-analysis.html`
   - è¾“å…¥æµ‹è¯•æ•°æ®
   - æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
   - æ£€æŸ¥ Network å’Œ Console

3. **è§„åˆ™åŒ¹é…æµ‹è¯•**ï¼š
   - æ£€æŸ¥è§„åˆ™æ¡ä»¶æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥æ—¥å¿—ä¸­çš„è§„åˆ™åŒ¹é…è¿‡ç¨‹
   - ä½¿ç”¨ `frontend/shishen-debug.html` è°ƒè¯•

### å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜1ï¼šè§„åˆ™ä¸åŒ¹é…**
```bash
# 1. æ£€æŸ¥æ•°æ®åº“è§„åˆ™æ¡ä»¶
SELECT rule_code, conditions FROM bazi_rules WHERE rule_code='FORMULA_HEALTH_70012';

# 2. æ£€æŸ¥å­—ç¬¦ç¼–ç 
# çœ‹åˆ° 'Ã§"Â²' â†’ ç¼–ç é”™è¯¯ï¼Œåº”è¯¥æ˜¯ 'ç”²'

# 3. æ¸…ç†ç¼“å­˜
redis-cli DEL "rules:FORMULA_HEALTH"

# 4. é‡å¯æœåŠ¡
./restart_server.sh
```

**é—®é¢˜2ï¼šå‰ç«¯ä¸æ˜¾ç¤º**
```
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
2. æ£€æŸ¥ Network è¯·æ±‚æ˜¯å¦æˆåŠŸ
3. æ£€æŸ¥ API è¿”å›çš„æ•°æ®ç»“æ„
4. æ£€æŸ¥å‰ç«¯ JS æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
```

**é—®é¢˜3ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8000

# æ£€æŸ¥æ—¥å¿—
tail -f logs/server.log

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat config/services.env
```

---

## ğŸš€ æœåŠ¡ç®¡ç†

### åŸºæœ¬å‘½ä»¤
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./start_all_services.sh

# åœæ­¢æ‰€æœ‰æœåŠ¡
./stop_all_services.sh

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
./check_services.sh

# é‡å¯ä¸»æœåŠ¡
./restart_server.sh

# æ¸…ç†æ—¥å¿—
rm logs/*.log
```

### æœåŠ¡åˆ—è¡¨
| æœåŠ¡ | ç«¯å£ | æ—¥å¿— |
|------|------|------|
| ä¸»æœåŠ¡ | 8000 | `logs/server.log` |
| å…«å­—åˆ†æ | 50051 | `logs/bazi_analyzer.log` |
| è¿åŠ¿åˆ†æ | 50052 | `logs/fortune_analysis.log` |
| è§„åˆ™æœåŠ¡ | 50053 | `logs/rule_service.log` |
| æ”¯ä»˜æœåŠ¡ | 50055 | `logs/payment_service.log` |
| MySQL | 13306 | - |
| Redis | 16379 | - |

---

## ğŸ“ ä»£ç è§„èŒƒ

### å‘½åè§„èŒƒ
```python
# ç±»åï¼šå¤§é©¼å³°
class BaziCalculator:
    pass

# å‡½æ•°åï¼šå°å†™ä¸‹åˆ’çº¿
def calculate_bazi(year, month, day):
    pass

# å¸¸é‡ï¼šå¤§å†™ä¸‹åˆ’çº¿
MAX_RETRY_COUNT = 3

# ç§æœ‰æ–¹æ³•ï¼šå•ä¸‹åˆ’çº¿å‰ç¼€
def _internal_method(self):
    pass
```

### æ³¨é‡Šè§„èŒƒ
```python
def analyze_fortune(bazi_info: dict) -> dict:
    """
    åˆ†æè¿åŠ¿
    
    Args:
        bazi_info: å…«å­—ä¿¡æ¯ï¼ŒåŒ…å«å››æŸ±ã€åç¥ç­‰
    
    Returns:
        è¿åŠ¿åˆ†æç»“æœ
    
    Raises:
        ValueError: å‚æ•°é”™è¯¯
    """
    pass
```

### é”™è¯¯å¤„ç†
```python
# ä½¿ç”¨ try-except åŒ…è£¹
try:
    result = risky_operation()
except SpecificException as e:
    logger.error(f"Operation failed: {e}")
    raise
finally:
    cleanup()
```

---

## ğŸ“¦ Git æäº¤è§„èŒƒ

### Commit Message æ ¼å¼
```
[ç±»å‹] ç®€çŸ­æè¿°ï¼ˆä¸è¶…è¿‡50å­—ï¼‰

è¯¦ç»†è¯´æ˜ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
- ä¿®æ”¹çš„æ–‡ä»¶å’ŒåŸå› 
- å½±å“èŒƒå›´
- æµ‹è¯•æƒ…å†µ
```

**ç±»å‹**ï¼š
- `[ä¿®å¤]` - Bugä¿®å¤
- `[æ–°å¢]` - æ–°åŠŸèƒ½
- `[ä¼˜åŒ–]` - æ€§èƒ½ä¼˜åŒ–
- `[é‡æ„]` - ä»£ç é‡æ„
- `[æ–‡æ¡£]` - æ–‡æ¡£æ›´æ–°
- `[æµ‹è¯•]` - æµ‹è¯•ç›¸å…³

**ç¤ºä¾‹**ï¼š
```
[ä¿®å¤] èº«ä½“ç±»è§„åˆ™å­—ç¬¦ç¼–ç é—®é¢˜

- ä¿®æ”¹æ–‡ä»¶ï¼šserver/db/mysql_connector.py
- é—®é¢˜ï¼špymysqlè¯»å–UTF-8æ•°æ®æ—¶ä½¿ç”¨latin1ç¼–ç 
- è§£å†³ï¼šæ·»åŠ charset='utf8mb4'å’Œuse_unicode=True
- å½±å“èŒƒå›´ï¼šä½ï¼ˆä»…å½±å“æ•°æ®åº“è¿æ¥é…ç½®ï¼‰
- æµ‹è¯•ï¼šèº«ä½“è§„åˆ™åŒ¹é…æ­£å¸¸
```

### æäº¤å‰æ£€æŸ¥
```bash
# 1. æŸ¥çœ‹ä¿®æ”¹
git status
git diff

# 2. åªæäº¤å¿…è¦æ–‡ä»¶
git add [specific files]

# 3. ä¸æäº¤
- logs/*.log
- *.pyc, __pycache__/
- config/*.envï¼ˆæ•æ„Ÿé…ç½®ï¼‰
- .DS_Store
```

---

## ğŸ“š å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨æ–‡æ¡£
- å¼€å‘è§„èŒƒï¼š`docs/DEVELOPMENT_GUIDELINES.md`
- å¿«é€Ÿå¯åŠ¨ï¼š`docs/quick_start.md`
- APIæ–‡æ¡£ï¼š`docs/bazi_api_structure.json`
- è§„åˆ™ç³»ç»Ÿï¼š`docs/rule_system_architecture.md`

### å¸¸ç”¨è„šæœ¬
```bash
# æ•°æ®åº“è¿ç§»
scripts/migrate_formula_rules_to_db.py

# è§„åˆ™æ‰¹é‡æ›´æ–°
scripts/batch_update_rules.py

# æœåŠ¡å¥åº·æ£€æŸ¥
tests/scripts/check_services.sh
```

### æµ‹è¯•é¡µé¢
- ç®—æ³•å…¬å¼ï¼š`frontend/formula-analysis.html`
- åç¥è°ƒè¯•ï¼š`frontend/shishen-debug.html`
- è¿åŠ¿åˆ†æï¼š`frontend/fortune.html`
- æœˆè¿ï¼š`frontend/bazi-monthly-fortune.html`
- æ—¥è¿ï¼š`frontend/bazi-daily-fortune.html`

---

## ğŸ’¡ å¼€å‘åŸåˆ™

1. **å…ˆå’¨è¯¢ï¼Œåä¿®æ”¹**ï¼šä¸ç¡®å®šæ—¶è¯¢é—®ç”¨æˆ·
2. **å°æ­¥å¿«è·‘**ï¼šæ¯æ¬¡ä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½ç‚¹
3. **åŠæ—¶æµ‹è¯•**ï¼šä¿®æ”¹åç«‹å³æµ‹è¯•
4. **æ¸…æ™°è®°å½•**ï¼šä¿®æ”¹è¿‡ç¨‹è®°å½•åˆ°æ–‡æ¡£
5. **ä¿æŒç®€æ´**ï¼šé¿å…è¿‡åº¦è®¾è®¡
6. **æ³¨é‡æ€§èƒ½**ï¼šè€ƒè™‘ç¼“å­˜å’Œä¼˜åŒ–
7. **ç”¨æˆ·ä½“éªŒ**ï¼šå‰ç«¯äº¤äº’æµç•…ã€é”™è¯¯æç¤ºæ¸…æ™°

---

## âš™ï¸ Cursor é…ç½®ä¼˜åŒ–

å½“å‰é…ç½®ä½äºï¼š`~/Library/Application Support/Cursor/User/settings.json`

**æ¨èé…ç½®**ï¼š
```json
{
  "cursor.aiProvider": "anthropic",
  "cursor.model": "claude-sonnet-4-20250514",
  "cursor.anthropicApiKey": "your-key",
  "cursor.anthropicApiBaseUrl": "https://cc.zhihuiapi.top",
  "cursor.useCustomApi": true,
  "cursor.bypassRegionCheck": true,
  "cursor.disableRegionCheck": true
}
```

**ä¸è¦ä½¿ç”¨**ï¼š
- `http.proxy`ï¼ˆåŒé‡ä»£ç†ä¼šå¾ˆæ…¢ï¼‰
- `http.version: "1.1"`ï¼ˆå¼ºåˆ¶HTTP/1.1ä¼šæ›´æ…¢ï¼‰
- `cursor.general.disableHttp2`ï¼ˆç¦ç”¨HTTP/2ä¼šæ›´æ…¢ï¼‰

---

## ğŸ¯ å“åº”æµç¨‹

æ¯æ¬¡æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼š

1. **ç†è§£éœ€æ±‚** â†’ æ˜ç¡®è¦åšä»€ä¹ˆ
2. **è¯„ä¼°å½±å“** â†’ åˆ—å‡ºå½±å“æ–‡ä»¶å’ŒèŒƒå›´
3. **é«˜å½±å“å’¨è¯¢** â†’ é£é™©é«˜æ—¶å…ˆç¡®è®¤
4. **æ‰§è¡Œä¿®æ”¹** â†’ åªæ”¹å¿…è¦çš„ä»£ç 
5. **æµ‹è¯•éªŒè¯** â†’ ç¡®ä¿åŠŸèƒ½æ­£å¸¸
6. **è®°å½•æ–‡æ¡£** â†’ é‡è¦ä¿®æ”¹è®°å½•åˆ° `docs/`

---

**è®°ä½**ï¼š
- å®å¯å¤šé—®ï¼Œä¸è¦æ“…è‡ªå†³å®š
- æœ€å°å½±å“åŸåˆ™æ°¸è¿œç¬¬ä¸€
- ä¿æŒä»£ç æ•´æ´å’Œå¯ç»´æŠ¤æ€§
