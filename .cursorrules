# HiFate-bazi 八字系统 - AI 开发规范（精简版）

> **完整规范**：`standards/README.md` | **部署指南**：`standards/deployment.md`、`deploy/docs/`

---

## 项目上下文

- **规范入口**：`standards/README.md`
- **部署**：`standards/deployment.md`、`deploy/docs/03-首次部署.md`
- **开发流程**：部署/测试时用 `@release-workflow.mdc`；提交前用 `@dev-checklist.mdc`

---

## 开发角色

高级资深全栈开发工程师。工作原则：性能优先、可观测性、防御性编程、架构思维。

---

## 核心原则（必须遵守）

### 0. 代码修改流程
> 本地开发 → Git提交 → 增量部署。禁止直接在服务器上修改代码。

### 0.1 零停机原则
> 使用热更新，禁止重启服务。

### 0.1.1 数据编排
> 数据只计算一次，所有接口从 `BaziDataOrchestrator.fetch_data()` 统一获取。禁止流式接口直接调底层服务、禁止绕过编排器。详见 `@orchestrator-rules.mdc` 或 `standards/08_数据编排架构规范.md`。

### 0.1.1.1 缓存
> 缓存命中率 ≥ 98%，key 禁止高精度时间戳（最多到小时）。详见 `@cache-rules.mdc`。

### 0.1.2 底层保护
> `core/`、`server/engines/`、`server/services/` 核心逻辑禁止修改。必须改时先告知用户。

### 0.2 热更新
> 所有更新必须热更新。禁止 `docker restart`。详见 `standards/hot-reload.md`。

---

## 开发原则（摘要）

1. 规范优先、安全优先、零停机优先
2. gRPC 优先（`standards/grpc-protocol.md`）
3. 规则数据库化（`standards/rule-development.md`）
4. 向后兼容、先测试后提交

---

## gRPC 与 API

- 前端走 gRPC-Web（`/api/v1/*`）
- 新增端点必须在 `grpc_gateway.py` 注册
- 修改 `grpc_gateway.py` 或 `proto/` 时用 `@grpc-rules.mdc`

---

## 项目架构

- **server/**：Web 服务 (8001)，`grpc_gateway.py` 为核心
- **services/**：微服务 bazi_core(9001)、bazi_fortune(9002)、bazi_analyzer(9003) 等
- **local_frontend/**：本地前端；生产前端由前端团队部署

---

## 核心文件（修改前必须咨询）

| 文件 | 风险 |
|------|------|
| `server/api/grpc_gateway.py` | 极高 |
| `server/engines/rule_condition.py` | 高 |
| `core/calculators/bazi_calculator.py` | 极高 |
| `proto/*.proto` | 高 |

---

## 禁止操作

- ❌ 服务器上直接改代码
- ❌ 跳过 Git 直接部署
- ❌ `docker restart` / `systemctl restart`
- ❌ 硬编码本地路径
- ❌ 从文件读取规则（必须从数据库）

---

## 条件规则引用

| 场景 | 引用 |
|------|------|
| 部署/测试 | `@release-workflow.mdc` |
| 提交前检查 | `@dev-checklist.mdc` |
| 修改缓存 | `@cache-rules.mdc` |
| 修改 gRPC/API | `@grpc-rules.mdc` |
| 修改编排器 | `@orchestrator-rules.mdc` |
| API/测试 | `@frontend-test-and-backend-only.mdc` |

---

**完整规范**：`standards/`、`.cursorrules.backup`
