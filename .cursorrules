# HiFate-bazi å…«å­—ç³»ç»Ÿ - AI å¼€å‘è§„èŒƒ

## âš ï¸ æ ¸å¿ƒåŸåˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰

### ğŸ”´ 0. é›¶åœæœºåŸåˆ™ ã€è®¾è®¡å‰æã€‘

> **æ‰€æœ‰è®¾è®¡å¿…é¡»ä¿è¯æœåŠ¡ä¸ä¸­æ–­ï¼Œè¿™æ˜¯ä¸€åˆ‡è®¾è®¡çš„åŸºç¡€ã€‚**

| åœºæ™¯ | è¦æ±‚ | å®ç°æ–¹å¼ |
|------|------|----------|
| **çƒ­æ›´æ–°** | âœ… é›¶åœæœº | ä»£ç ä¿®æ”¹è‡ªåŠ¨é‡è½½ï¼Œæ— éœ€é‡å¯ |
| **ç‰ˆæœ¬å‘å¸ƒ** | âœ… é›¶åœæœº | æ»šåŠ¨æ›´æ–°ï¼Œæ–°æ—§å®¹å™¨å¹³æ»‘åˆ‡æ¢ |
| **åŠŸèƒ½å¢åŠ ** | âœ… é›¶åœæœº | å‘åå…¼å®¹ï¼Œå¢é‡éƒ¨ç½² |
| **æ•°æ®åº“å˜æ›´** | âœ… é›¶åœæœº | åªåŠ å­—æ®µä¸åˆ å­—æ®µï¼Œè¿ç§»è„šæœ¬ |
| **é…ç½®æ›´æ–°** | âœ… é›¶åœæœº | ç¯å¢ƒå˜é‡/Redis çƒ­åŠ è½½ |
| **è§„åˆ™æ›´æ–°** | âœ… é›¶åœæœº | æ•°æ®åº“+æ¸…ç¼“å­˜ï¼Œæ— éœ€é‡å¯ |

**å®ç°è¦ç‚¹**ï¼š
```
1. ä»£ç å±‚é¢
   - Python ä½¿ç”¨ --reload æ¨¡å¼
   - å‰ç«¯èµ„æºç›´æ¥åˆ·æ–°ç”Ÿæ•ˆ
   - é…ç½®æ”¯æŒçƒ­åŠ è½½

2. éƒ¨ç½²å±‚é¢
   - Docker æ»šåŠ¨æ›´æ–°ï¼ˆå…ˆå¯æ–°å®¹å™¨ï¼Œå†åœæ—§å®¹å™¨ï¼‰
   - rsync å¢é‡åŒæ­¥ï¼ˆæœåŠ¡è¿è¡Œæ—¶æ›´æ–°æ–‡ä»¶ï¼‰
   - å¥åº·æ£€æŸ¥ç¡®ä¿æ–°æœåŠ¡å°±ç»ª

3. æ•°æ®å±‚é¢
   - æ•°æ®åº“åªå¢ä¸åˆ ï¼ˆå‘åå…¼å®¹ï¼‰
   - Redis ç¼“å­˜å¯éšæ—¶æ¸…ç†åˆ·æ–°
   - è§„åˆ™å­˜æ•°æ®åº“ï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°

4. ç¦æ­¢æ“ä½œ
   âŒ å…ˆåœæœåŠ¡å†éƒ¨ç½²
   âŒ åˆ é™¤/ä¿®æ”¹ç°æœ‰æ•°æ®åº“å­—æ®µ
   âŒ ç ´å API å‘åå…¼å®¹æ€§
   âŒ éœ€è¦åœæœºçš„æ¶æ„è®¾è®¡
```

**éƒ¨ç½²å‘½ä»¤**ï¼š
```bash
./deploy.sh  # é€‰æ‹© 2: æ‰“åŒ…ä¸Šä¼  - é›¶åœæœº
```

---

### 1. æœ€å°å½±å“åŸåˆ™ ã€æœ€é‡è¦ã€‘
- **åšå†³ä¸å¯æ”¹åŠ¨ä¸ä¹‹æ— å…³çš„ä»£ç **
- ä¿®æ”¹ä¼šå¼•èµ·å…¶ä»–åŠŸèƒ½å˜åŒ–æ—¶ï¼Œ**å¿…é¡»å…ˆå’¨è¯¢ç”¨æˆ·**
- æ¯æ¬¡ä¿®æ”¹å‰æ˜ç¡®å½±å“èŒƒå›´ï¼ˆä½/ä¸­/é«˜ï¼‰
- é«˜å½±å“ä¿®æ”¹å¿…é¡»ç”¨æˆ·ç¡®è®¤

### 2. ä¿®æ”¹å‰æ£€æŸ¥æ¸…å•
```
ã€ä¿®æ”¹åˆ†æã€‘
âœ“ ä¿®æ”¹æ–‡ä»¶ï¼š[æœ€å°é›†åˆ]
âœ“ å½±å“èŒƒå›´ï¼š[ä½/ä¸­/é«˜]
âœ“ å½±å“åŠŸèƒ½ï¼š[åˆ—è¡¨]
âœ“ éœ€è¦ç¡®è®¤ï¼š[æ˜¯/å¦]
```

### 3. é«˜å½±å“å˜æ›´æ¨¡æ¿
```
âš ï¸ é«˜å½±å“å˜æ›´ï¼Œéœ€è¦æ‚¨ç¡®è®¤ï¼š
- ä¿®æ”¹å†…å®¹ï¼š...
- å½±å“èŒƒå›´ï¼š...
- é£é™©è¯„ä¼°ï¼š...
æ˜¯å¦ç»§ç»­ï¼Ÿ
```

---

## ğŸ“ é¡¹ç›®æ¶æ„

### å‰ç«¯æ¶æ„ `frontend/`
```
frontend/
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ fortune.js              # æ•°æ®é€»è¾‘å’ŒAPIè°ƒç”¨ï¼ˆä¸å¯æ”¹UIï¼‰
â”‚   â”œâ”€â”€ fortune-timeline.js     # æ¸²æŸ“å’ŒUIå±•ç¤ºï¼ˆä¸å¯æ”¹é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ bazi-monthly.js         # æœˆè¿å±•ç¤º
â”‚   â”œâ”€â”€ bazi-daily.js           # æ—¥è¿å±•ç¤º
â”‚   â””â”€â”€ config.js               # APIåœ°å€é…ç½®
â”œâ”€â”€ css/                        # æ ·å¼æ–‡ä»¶
â””â”€â”€ *.html                      # æµ‹è¯•é¡µé¢
```

**èŒè´£åˆ†æ˜**ï¼š
- `fortune.js` â†’ æ•°æ®è·å–ã€çŠ¶æ€ç®¡ç†
- `fortune-timeline.js` â†’ DOMæ¸²æŸ“ã€ç”¨æˆ·äº¤äº’
- ä¸å¯è·¨ç•Œä¿®æ”¹

### åç«¯æ¶æ„ `server/`
```
server/
â”œâ”€â”€ api/                # APIå±‚ï¼šè¯·æ±‚å¤„ç†ã€å‚æ•°éªŒè¯
â”‚   â”œâ”€â”€ bazi_api.py    # å…«å­—æ¥å£
â”‚   â”œâ”€â”€ fortune_api.py # è¿åŠ¿æ¥å£
â”‚   â””â”€â”€ ...
â”œâ”€â”€ services/           # Serviceå±‚ï¼šä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ rule_service.py         # è§„åˆ™åŒ¹é…
â”‚   â”œâ”€â”€ formula_rule_service.py # ç®—æ³•å…¬å¼
â”‚   â””â”€â”€ ...
â”œâ”€â”€ engines/            # è§„åˆ™å¼•æ“
â”‚   â”œâ”€â”€ rule_engine.py          # æ ¸å¿ƒå¼•æ“
â”‚   â””â”€â”€ rule_condition.py       # æ¡ä»¶åŒ¹é…
â”œâ”€â”€ db/                 # æ•°æ®åº“è¿æ¥
â””â”€â”€ main.py             # è·¯ç”±æ³¨å†Œ
```

**æ ¸å¿ƒå±‚ `src/`**ï¼š
```
src/
â”œâ”€â”€ bazi_calculator.py  # æ ¸å¿ƒå…«å­—è®¡ç®—
â”œâ”€â”€ bazi_*.py          # å„ç§å…«å­—ç›¸å…³è®¡ç®—
â””â”€â”€ ...
```

**å¾®æœåŠ¡ `services/`**ï¼š
```
services/
â”œâ”€â”€ bazi_analyzer_service.py    # å…«å­—åˆ†ææœåŠ¡
â”œâ”€â”€ fortune_analysis_service.py # è¿åŠ¿åˆ†ææœåŠ¡
â”œâ”€â”€ rule_service_grpc.py        # è§„åˆ™æœåŠ¡
â””â”€â”€ payment_service.py          # æ”¯ä»˜æœåŠ¡
```

**åˆ†å±‚åŸåˆ™**ï¼š
- åªä¿®æ”¹å¿…è¦çš„å±‚
- ä¸è·¨å±‚ä¿®æ”¹
- API â†’ Service â†’ Core å•å‘ä¾èµ–

---

## ğŸ”’ æ ¸å¿ƒæ–‡ä»¶ï¼ˆä¿®æ”¹å‰å¿…é¡»å’¨è¯¢ï¼‰

| æ–‡ä»¶ | ä½œç”¨ | é£é™© |
|------|------|------|
| `server/main.py` | è·¯ç”±æ³¨å†Œ | é«˜ |
| `src/bazi_calculator.py` | æ ¸å¿ƒè®¡ç®—é€»è¾‘ | æé«˜ |
| `frontend/js/fortune.js` | å‰ç«¯ä¸»é€»è¾‘ | é«˜ |
| `server/db/mysql_connector.py` | æ•°æ®åº“è¿æ¥ | é«˜ |
| `server/engines/*.py` | è§„åˆ™å¼•æ“ | é«˜ |
| `server/config/mysql_config.py` | MySQLé…ç½® | é«˜ |
| `proto/*.proto` | gRPCåè®®å®šä¹‰ | é«˜ |

---

## ğŸ”§ å¼€å‘è§„èŒƒ

### å­—ç¬¦ç¼–ç ï¼ˆé‡è¦ï¼‰
- **æ•°æ®åº“**ï¼š`utf8mb4`ï¼ˆæ”¯æŒä¸­æ–‡ã€emojiï¼‰
- **Python**ï¼šUTF-8ï¼ˆæ–‡ä»¶å¤´ `# -*- coding: utf-8 -*-`ï¼‰
- **JSON**ï¼š`json.dumps(..., ensure_ascii=False)`
- **MySQLè¿æ¥**ï¼š
  ```python
  'charset': 'utf8mb4',
  'use_unicode': True
  ```

### è§„åˆ™ç³»ç»Ÿ
**å­˜å‚¨**ï¼š
- è¡¨ï¼š`bazi_rules`
- å­—æ®µï¼š
  - `rule_code`ï¼šè§„åˆ™ç¼–ç ï¼ˆå¦‚ `FORMULA_HEALTH_70012`ï¼‰
  - `rule_type`ï¼šè§„åˆ™ç±»å‹ï¼ˆå¦‚ `FORMULA_HEALTH`ï¼‰
  - `conditions`ï¼šJSONæ ¼å¼æ¡ä»¶
  - `description`ï¼šJSONæ ¼å¼æè¿°

**æ¡ä»¶æ ¼å¼**ï¼š
```json
{
  "pillar_in": {"pillar": "day", "part": "stem", "values": ["ç”²", "ä¹™"]},
  "element_count": {"element": "æœ¨", "operator": ">=", "value": 3},
  "gender": "male"
}
```

**ç¼“å­˜æœºåˆ¶**ï¼š
- Redisç¼“å­˜è§„åˆ™
- ä¿®æ”¹è§„åˆ™å**å¿…é¡»æ¸…ç†ç¼“å­˜**ï¼š
  ```bash
  redis-cli DEL "rules:FORMULA_HEALTH"
  ```

### æ•°æ®åº“æ“ä½œ
**å­—ç¬¦ç¼–ç å¤„ç†**ï¼š
```python
# è¯»å–æ—¶ï¼ˆä¿®å¤ pymysql çš„ latin1 é—®é¢˜ï¼‰
conditions = rule['conditions']
if isinstance(conditions, str):
    try:
        conditions = conditions.encode('latin1').decode('utf-8')
    except:
        pass
    conditions = json.loads(conditions)

# å†™å…¥æ—¶
sql = f"UPDATE bazi_rules SET conditions = '{json.dumps(data, ensure_ascii=False)}' WHERE ..."
```

**æ‰§è¡ŒSQL**ï¼š
```bash
# ä½¿ç”¨ utf8mb4 å­—ç¬¦é›†
mysql -h 127.0.0.1 -P 13306 -u root -p --default-character-set=utf8mb4 bazi_system < script.sql
```

### APIè®¾è®¡
**è¯·æ±‚å‚æ•°**ï¼š
```python
# å¿…éœ€å‚æ•°éªŒè¯
if not year or not month:
    return jsonify({'error': 'ç¼ºå°‘å‚æ•°'}), 400

# ç±»å‹è½¬æ¢
year = int(year)
hour = int(hour) if hour else 12
```

**å“åº”æ ¼å¼**ï¼š
```python
{
    'success': True,
    'data': {...},
    'error': None
}
```

**é”™è¯¯å¤„ç†**ï¼š
```python
try:
    result = service.analyze(...)
    return jsonify({'success': True, 'data': result})
except Exception as e:
    logger.error(f"Error: {e}")
    return jsonify({'success': False, 'error': str(e)}), 500
```

### æ•°æ®ç»“æ„å…¼å®¹
- **åªæ·»åŠ æ–°å­—æ®µ**ï¼Œä¸ä¿®æ”¹/åˆ é™¤ç°æœ‰å­—æ®µ
- **ä¿æŒå‘åå…¼å®¹**
- APIæ¥å£å˜æ›´ â†’ **å¿…é¡»å’¨è¯¢ç”¨æˆ·**
- æ•°æ®åº“ schema å˜æ›´ â†’ **å¿…é¡»å’¨è¯¢ç”¨æˆ·**

---

## ğŸ› è°ƒè¯•å’Œæµ‹è¯•

### æ—¥å¿—æŸ¥çœ‹
```bash
# ä¸»æœåŠ¡æ—¥å¿—
tail -f logs/server.log

# å¾®æœåŠ¡æ—¥å¿—
tail -f logs/bazi_analyzer.log
tail -f logs/fortune_analysis.log

# é”™è¯¯æ—¥å¿—
grep "ERROR" logs/*.log
```

### æµ‹è¯•æµç¨‹
1. **åç«¯æµ‹è¯•**ï¼š
   ```bash
   # APIæµ‹è¯•
   curl http://localhost:8000/api/bazi/analyze?year=1990&month=1&day=1&hour=12&gender=male
   ```

2. **å‰ç«¯æµ‹è¯•**ï¼š
   - æ‰“å¼€ `frontend/formula-analysis.html`
   - è¾“å…¥æµ‹è¯•æ•°æ®
   - æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
   - æ£€æŸ¥ Network å’Œ Console

3. **è§„åˆ™åŒ¹é…æµ‹è¯•**ï¼š
   - æ£€æŸ¥è§„åˆ™æ¡ä»¶æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥æ—¥å¿—ä¸­çš„è§„åˆ™åŒ¹é…è¿‡ç¨‹
   - ä½¿ç”¨ `frontend/shishen-debug.html` è°ƒè¯•

### å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜1ï¼šè§„åˆ™ä¸åŒ¹é…**
```bash
# 1. æ£€æŸ¥æ•°æ®åº“è§„åˆ™æ¡ä»¶
SELECT rule_code, conditions FROM bazi_rules WHERE rule_code='FORMULA_HEALTH_70012';

# 2. æ£€æŸ¥å­—ç¬¦ç¼–ç 
# çœ‹åˆ° 'Ã§"Â²' â†’ ç¼–ç é”™è¯¯ï¼Œåº”è¯¥æ˜¯ 'ç”²'

# 3. æ¸…ç†ç¼“å­˜
redis-cli DEL "rules:FORMULA_HEALTH"

# 4. é‡å¯æœåŠ¡
./restart_server.sh
```

**é—®é¢˜2ï¼šå‰ç«¯ä¸æ˜¾ç¤º**
```
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
2. æ£€æŸ¥ Network è¯·æ±‚æ˜¯å¦æˆåŠŸ
3. æ£€æŸ¥ API è¿”å›çš„æ•°æ®ç»“æ„
4. æ£€æŸ¥å‰ç«¯ JS æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
```

**é—®é¢˜3ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8000

# æ£€æŸ¥æ—¥å¿—
tail -f logs/server.log

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat config/services.env
```

---

## ğŸš€ æœåŠ¡ç®¡ç†

### åŸºæœ¬å‘½ä»¤
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./start_all_services.sh

# åœæ­¢æ‰€æœ‰æœåŠ¡
./stop_all_services.sh

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
./check_services.sh

# é‡å¯ä¸»æœåŠ¡
./restart_server.sh

# æ¸…ç†æ—¥å¿—
rm logs/*.log
```

### æœåŠ¡åˆ—è¡¨
| æœåŠ¡ | ç«¯å£ | æ—¥å¿— |
|------|------|------|
| ä¸»æœåŠ¡ | 8000 | `logs/server.log` |
| å…«å­—åˆ†æ | 50051 | `logs/bazi_analyzer.log` |
| è¿åŠ¿åˆ†æ | 50052 | `logs/fortune_analysis.log` |
| è§„åˆ™æœåŠ¡ | 50053 | `logs/rule_service.log` |
| æ”¯ä»˜æœåŠ¡ | 50055 | `logs/payment_service.log` |
| MySQL | 13306 | - |
| Redis | 16379 | - |

---

## ğŸ“ ä»£ç è§„èŒƒ

### å‘½åè§„èŒƒ
```python
# ç±»åï¼šå¤§é©¼å³°
class BaziCalculator:
    pass

# å‡½æ•°åï¼šå°å†™ä¸‹åˆ’çº¿
def calculate_bazi(year, month, day):
    pass

# å¸¸é‡ï¼šå¤§å†™ä¸‹åˆ’çº¿
MAX_RETRY_COUNT = 3

# ç§æœ‰æ–¹æ³•ï¼šå•ä¸‹åˆ’çº¿å‰ç¼€
def _internal_method(self):
    pass
```

### æ³¨é‡Šè§„èŒƒ
```python
def analyze_fortune(bazi_info: dict) -> dict:
    """
    åˆ†æè¿åŠ¿
    
    Args:
        bazi_info: å…«å­—ä¿¡æ¯ï¼ŒåŒ…å«å››æŸ±ã€åç¥ç­‰
    
    Returns:
        è¿åŠ¿åˆ†æç»“æœ
    
    Raises:
        ValueError: å‚æ•°é”™è¯¯
    """
    pass
```

### é”™è¯¯å¤„ç†
```python
# ä½¿ç”¨ try-except åŒ…è£¹
try:
    result = risky_operation()
except SpecificException as e:
    logger.error(f"Operation failed: {e}")
    raise
finally:
    cleanup()
```

---

## ğŸ“¦ Git Flow å·¥ä½œæµï¼ˆé‡è¦ï¼‰

### ğŸŒ³ åˆ†æ”¯ç®¡ç†ç­–ç•¥

**ä¸‰ç¯å¢ƒåˆ†æ”¯æ¨¡å‹**ï¼š
```
master (ç”Ÿäº§ç¯å¢ƒ)     â† çº¿ä¸Šç”¨æˆ·è®¿é—®
  â†‘ merge
develop (å¼€å‘ç¯å¢ƒ)    â† å¼€å‘äººå‘˜ä¸»åˆ†æ”¯
  â†‘ merge  
feature/* (åŠŸèƒ½åˆ†æ”¯)  â† å…·ä½“åŠŸèƒ½å¼€å‘
```

**åˆ†æ”¯è¯´æ˜**ï¼š
- `master`ï¼šç”Ÿäº§ç¯å¢ƒï¼Œåªæ¥å—æ¥è‡ª develop çš„åˆå¹¶ï¼Œè‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
- `develop`ï¼šå¼€å‘ç¯å¢ƒï¼Œå¼€å‘äººå‘˜çš„ä¸»è¦å·¥ä½œåˆ†æ”¯
- `feature/*`ï¼šåŠŸèƒ½åˆ†æ”¯ï¼Œä» develop åˆ›å»ºï¼Œå®Œæˆååˆå¹¶å› develop

### ğŸ”„ å®Œæ•´å¼€å‘æµç¨‹

#### æ­¥éª¤ 1ï¼šåˆ›å»ºåŠŸèƒ½åˆ†æ”¯
```bash
# ä» develop åˆ›å»ºæ–°åŠŸèƒ½åˆ†æ”¯
git checkout develop
git pull origin develop
git checkout -b feature/æ–°åŠŸèƒ½åç§°
```

#### æ­¥éª¤ 2ï¼šæœ¬åœ°å¼€å‘å’Œæµ‹è¯•
```bash
# å¼€å‘è¿‡ç¨‹ä¸­
vim some_file.py

# æœ¬åœ°æµ‹è¯•ï¼ˆå¿…é¡»ï¼‰
./start_all_services.sh
# è®¿é—® http://localhost:8001 æµ‹è¯•åŠŸèƒ½

# ç¡®ä¿æµ‹è¯•é€šè¿‡åæ‰èƒ½æäº¤
```

#### æ­¥éª¤ 3ï¼šæäº¤åˆ°åŠŸèƒ½åˆ†æ”¯
```bash
# æŸ¥çœ‹ä¿®æ”¹
git status
git diff

# æ·»åŠ æ–‡ä»¶
git add .

# æäº¤ï¼ˆä½¿ç”¨è§„èŒƒæ ¼å¼ï¼‰
git commit -m "[æ–°å¢] åŠŸèƒ½æè¿°

- ä¿®æ”¹æ–‡ä»¶ï¼šåˆ—å‡ºä¸»è¦æ–‡ä»¶
- åŠŸèƒ½è¯´æ˜ï¼šè¯¦ç»†è¯´æ˜
- æµ‹è¯•æƒ…å†µï¼šæµ‹è¯•é€šè¿‡"

# æ¨é€åŠŸèƒ½åˆ†æ”¯
git push origin feature/æ–°åŠŸèƒ½åç§°
```

#### æ­¥éª¤ 4ï¼šåˆå¹¶åˆ° developï¼ˆå¼€å‘ç¯å¢ƒï¼‰
```bash
# åˆ‡æ¢åˆ° develop
git checkout develop
git pull origin develop

# åˆå¹¶åŠŸèƒ½åˆ†æ”¯
git merge feature/æ–°åŠŸèƒ½åç§°

# æ¨é€åˆ° developï¼ˆè§¦å‘å¼€å‘ç¯å¢ƒéƒ¨ç½²ï¼‰
git push origin develop
```

#### æ­¥éª¤ 5ï¼šå‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ
```bash
# åœ¨ develop æµ‹è¯•é€šè¿‡åï¼Œåˆå¹¶åˆ° master
git checkout master
git pull origin master

# åˆå¹¶ develop
git merge develop

# æ¨é€åˆ° masterï¼ˆè§¦å‘ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼‰
git push origin master
```

---

## âš ï¸ ä»£ç æäº¤æé†’æœºåˆ¶

### ğŸ”” ä½•æ—¶æé†’ç”¨æˆ·æäº¤ä»£ç 

AI åŠ©æ‰‹ä¼šåœ¨ä»¥ä¸‹æƒ…å†µ**ä¸»åŠ¨æé†’**ç”¨æˆ·æäº¤ä»£ç ï¼š

1. **åŠŸèƒ½å¼€å‘å®Œæˆå**
   ```
   âœ… åŠŸèƒ½å·²å®Œæˆï¼è¯·æäº¤ä»£ç ï¼š
   - ä¿®æ”¹æ–‡ä»¶ï¼š[åˆ—å‡ºæ–‡ä»¶]
   - æäº¤å‘½ä»¤ï¼š[ç»™å‡ºå…·ä½“å‘½ä»¤]
   - æµ‹è¯•éªŒè¯ï¼š[æé†’æµ‹è¯•]
   ```

2. **Bug ä¿®å¤å®Œæˆå**
   ```
   âœ… Bug å·²ä¿®å¤ï¼è¯·æäº¤ä»£ç ï¼š
   - é—®é¢˜ï¼š[æè¿°é—®é¢˜]
   - è§£å†³æ–¹æ¡ˆï¼š[è¯´æ˜ä¿®å¤]
   - æäº¤å‘½ä»¤ï¼š[ç»™å‡ºå‘½ä»¤]
   ```

3. **æ–‡æ¡£æ›´æ–°å®Œæˆå**
   ```
   âœ… æ–‡æ¡£å·²æ›´æ–°ï¼è¯·æäº¤ï¼š
   - æ›´æ–°å†…å®¹ï¼š[åˆ—å‡ºå˜æ›´]
   - æäº¤å‘½ä»¤ï¼š[ç»™å‡ºå‘½ä»¤]
   ```

4. **é…ç½®ä¿®æ”¹å®Œæˆå**
   ```
   âœ… é…ç½®å·²ä¿®æ”¹ï¼è¯·æäº¤ï¼š
   - é…ç½®é¡¹ï¼š[åˆ—å‡ºä¿®æ”¹]
   - å½±å“èŒƒå›´ï¼š[è¯´æ˜å½±å“]
   - æäº¤å‘½ä»¤ï¼š[ç»™å‡ºå‘½ä»¤]
   ```

### ğŸ“‹ æäº¤æ£€æŸ¥æ¸…å•ï¼ˆAI å¿…é¡»ç¡®è®¤ï¼‰

æ¯æ¬¡æé†’æäº¤å‰ï¼ŒAI å¿…é¡»ç¡®è®¤ï¼š
```
âœ“ æœ¬åœ°æµ‹è¯•é€šè¿‡
âœ“ ä»£ç ç¬¦åˆè§„èŒƒ
âœ“ æ— è°ƒè¯•ä»£ç æ®‹ç•™
âœ“ æ•æ„Ÿä¿¡æ¯å·²ç§»é™¤
âœ“ æäº¤ä¿¡æ¯æ¸…æ™°
```

---

## ğŸ“¦ Git æäº¤è§„èŒƒ

### Commit Message æ ¼å¼
```
[ç±»å‹] ç®€çŸ­æè¿°ï¼ˆä¸è¶…è¿‡50å­—ï¼‰

è¯¦ç»†è¯´æ˜ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
- ä¿®æ”¹çš„æ–‡ä»¶å’ŒåŸå› 
- å½±å“èŒƒå›´
- æµ‹è¯•æƒ…å†µ
```

**ç±»å‹**ï¼š
- `[ä¿®å¤]` - Bugä¿®å¤
- `[æ–°å¢]` - æ–°åŠŸèƒ½
- `[ä¼˜åŒ–]` - æ€§èƒ½ä¼˜åŒ–
- `[é‡æ„]` - ä»£ç é‡æ„
- `[æ–‡æ¡£]` - æ–‡æ¡£æ›´æ–°
- `[æµ‹è¯•]` - æµ‹è¯•ç›¸å…³
- `[é…ç½®]` - é…ç½®ä¿®æ”¹

**ç¤ºä¾‹**ï¼š
```
[ä¿®å¤] èº«ä½“ç±»è§„åˆ™å­—ç¬¦ç¼–ç é—®é¢˜

- ä¿®æ”¹æ–‡ä»¶ï¼šserver/db/mysql_connector.py
- é—®é¢˜ï¼špymysqlè¯»å–UTF-8æ•°æ®æ—¶ä½¿ç”¨latin1ç¼–ç 
- è§£å†³ï¼šæ·»åŠ charset='utf8mb4'å’Œuse_unicode=True
- å½±å“èŒƒå›´ï¼šä½ï¼ˆä»…å½±å“æ•°æ®åº“è¿æ¥é…ç½®ï¼‰
- æµ‹è¯•ï¼šèº«ä½“è§„åˆ™åŒ¹é…æ­£å¸¸
```

### æäº¤å‰æ£€æŸ¥
```bash
# 1. æŸ¥çœ‹ä¿®æ”¹
git status
git diff

# 2. æœ¬åœ°æµ‹è¯•ï¼ˆå¿…é¡»ï¼‰
./start_all_services.sh
# è®¿é—®æµ‹è¯•é¡µé¢éªŒè¯åŠŸèƒ½

# 3. åªæäº¤å¿…è¦æ–‡ä»¶
git add [specific files]

# 4. ä¸æäº¤
- logs/*.log
- *.pyc, __pycache__/
- config/*.envï¼ˆæ•æ„Ÿé…ç½®ï¼‰
- .DS_Store
- node_modules/
```

---

## ğŸ³ Docker ç”Ÿäº§éƒ¨ç½²

### ğŸ“‹ ç”Ÿäº§ç¯å¢ƒä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **æœåŠ¡å™¨** | 123.57.216.15ï¼ˆé˜¿é‡Œäº‘ ECSï¼‰ |
| **ä»£ç ä»“åº“** | https://gitee.com/zhoudengtang/hifate-prod.git |
| **éƒ¨ç½²ç›®å½•** | /opt/HiFate-bazi |
| **è®¿é—®åœ°å€** | http://123.57.216.15/ |
| **SSH ç”¨æˆ·** | root |
| **SSH ç«¯å£** | 22 |

### ğŸš€ ä¸€é”®éƒ¨ç½²æµç¨‹

```bash
# æœ¬åœ°æ‰§è¡Œï¼ˆæ¨èï¼‰
./deploy.sh

# é€‰æ‹©æ“ä½œï¼š
# 1) å®Œæ•´éƒ¨ç½²ï¼ˆæ¨é€ Gitee â†’ æœåŠ¡å™¨ pull â†’ Docker é‡å¯ï¼‰
# 2) ä»…æ¨é€åˆ° Gitee
# 3) ä»…æ›´æ–°æœåŠ¡å™¨
# 7) é¦–æ¬¡éƒ¨ç½²ï¼šåˆå§‹åŒ–æœåŠ¡å™¨
```

### ğŸ“¦ éƒ¨ç½²æ¶æ„

```
æœ¬åœ°å¼€å‘ â†’ git push gitee master â†’ æœåŠ¡å™¨ git pull â†’ docker compose up
                                                    â†“
                                              Nginx åå‘ä»£ç† (80)
                                                    â†“
                                              Docker Web æœåŠ¡ (8001)
                                                    â†“
                                           MySQL + Redis å®¹å™¨
```

### ğŸ”§ Docker é•œåƒä¼˜åŒ–ï¼ˆé‡è¦ï¼‰

**1. ç²¾ç®€ requirements.txt**
```
# âŒ ç¦æ­¢æ·»åŠ çš„å¤§å‹ä¾èµ–ï¼ˆä¼šå¯¼è‡´æ„å»ºè¶…æ…¢ï¼‰
torch, torchvision     # 2GB+
dlib, face-recognition # ç¼–è¯‘éœ€30åˆ†é’Ÿ
mediapipe, opencv      # ä¾èµ–å¤æ‚

# âœ… ä¿æŒè½»é‡ä¾èµ–
fastapi, uvicorn, pymysql, redis, lunar-python
```

**2. Dockerfile ä¼˜åŒ–**
```dockerfile
# ä½¿ç”¨å›½å†…é•œåƒæº
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple

# åˆ©ç”¨ Docker å±‚ç¼“å­˜
COPY requirements.txt .
RUN pip install -r requirements.txt  # ä¾èµ–å±‚ï¼ˆä¸å¸¸å˜ï¼‰
COPY . /app                          # ä»£ç å±‚ï¼ˆå¸¸å˜ï¼‰
```

**3. .dockerignore é…ç½®**
```
.git/
logs/
docs/
node_modules/
*.pyc
__pycache__/
*.pt
*.pth
```

### âš™ï¸ æœåŠ¡å™¨ç¯å¢ƒå˜é‡

æ–‡ä»¶ï¼š`/opt/HiFate-bazi/.env`

```bash
APP_ENV=production
DEBUG=False
MYSQL_HOST=mysql          # Docker å®¹å™¨åï¼Œä¸æ˜¯ localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=hifate_bazi
REDIS_HOST=redis
REDIS_PORT=6379
WEB_PORT=8001
```

**âš ï¸ å…³é”®ç‚¹**ï¼š`MYSQL_HOST=mysql`ï¼ˆå®¹å™¨é—´é€šä¿¡ç”¨æœåŠ¡åï¼‰

### ğŸŒ Nginx åå‘ä»£ç†

é…ç½®æ–‡ä»¶ï¼š`/etc/nginx/conf.d/hifate.conf`

```nginx
server {
    listen 80 default_server;
    server_name _;

    location / {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout 60s;
        proxy_read_timeout 120s;
    }
}
```

### ğŸ”’ é˜¿é‡Œäº‘å®‰å…¨ç»„ç«¯å£

| ç«¯å£ | ç”¨é€” | å¿…é¡» |
|------|------|------|
| 22 | SSH | âœ… |
| 80 | HTTPï¼ˆNginxï¼‰ | âœ… |
| 8001 | Docker Web | å¯é€‰ |
| 13306 | MySQLï¼ˆå¤–éƒ¨è®¿é—®ï¼‰ | å¯é€‰ |

### ğŸ› ï¸ å¸¸ç”¨è¿ç»´å‘½ä»¤

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh root@123.57.216.15

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
cd /opt/HiFate-bazi && docker compose ps

# æŸ¥çœ‹æ—¥å¿—
docker compose logs web --tail=50
docker compose logs mysql --tail=20

# é‡å¯æœåŠ¡ï¼ˆé›¶åœæœºï¼‰
docker compose up -d --build web

# å®Œå…¨é‡å¯
docker compose down && docker compose up -d

# æ¸…ç†æ— ç”¨é•œåƒ
docker system prune -af
```

### âŒ å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜1ï¼šModuleNotFoundError**
```bash
# ç¼ºå°‘ä¾èµ–ï¼Œæ·»åŠ åˆ° requirements.txt åé‡æ–°æ„å»º
docker compose up -d --build web
```

**é—®é¢˜2ï¼šMySQL è¿æ¥å¤±è´¥**
```bash
# æ£€æŸ¥ .env ä¸­ MYSQL_HOST=mysqlï¼ˆä¸æ˜¯ localhostï¼‰
# æ£€æŸ¥å®¹å™¨ç½‘ç»œï¼šdocker network ls
```

**é—®é¢˜3ï¼šæ„å»ºå¤ªæ…¢**
```bash
# 1. æ£€æŸ¥ .dockerignore æ’é™¤å¤§æ–‡ä»¶
# 2. ä¸è¦åŠ  --no-cacheï¼ˆåˆ©ç”¨ç¼“å­˜ï¼‰
# 3. ç²¾ç®€ requirements.txt
```

**é—®é¢˜4ï¼šç«¯å£æ— æ³•è®¿é—®**
```bash
# 1. æ£€æŸ¥é˜¿é‡Œäº‘å®‰å…¨ç»„
# 2. æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™ï¼šfirewall-cmd --list-ports
# 3. æ£€æŸ¥æœåŠ¡ç›‘å¬ï¼šnetstat -tlnp | grep 80
```

### ğŸ“‹ é…ç½®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `docker-compose.yml` | åŸºç¡€é…ç½® |
| `docker-compose.prod.yml` | ç”Ÿäº§ç¯å¢ƒè¦†ç›– |
| `Dockerfile` | ç”Ÿäº§é•œåƒæ„å»º |
| `.dockerignore` | æ’é™¤æ–‡ä»¶ |
| `deploy.sh` | ä¸€é”®éƒ¨ç½²è„šæœ¬ |
| `.env`ï¼ˆæœåŠ¡å™¨ï¼‰ | ç¯å¢ƒå˜é‡ |

---

## ğŸ“š å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨æ–‡æ¡£
- å¼€å‘è§„èŒƒï¼š`docs/DEVELOPMENT_GUIDELINES.md`
- å¿«é€Ÿå¯åŠ¨ï¼š`docs/quick_start.md`
- APIæ–‡æ¡£ï¼š`docs/bazi_api_structure.json`
- è§„åˆ™ç³»ç»Ÿï¼š`docs/rule_system_architecture.md`

### å¸¸ç”¨è„šæœ¬
```bash
# æ•°æ®åº“è¿ç§»
scripts/migrate_formula_rules_to_db.py

# è§„åˆ™æ‰¹é‡æ›´æ–°
scripts/batch_update_rules.py

# æœåŠ¡å¥åº·æ£€æŸ¥
tests/scripts/check_services.sh
```

### æµ‹è¯•é¡µé¢
- ç®—æ³•å…¬å¼ï¼š`frontend/formula-analysis.html`
- åç¥è°ƒè¯•ï¼š`frontend/shishen-debug.html`
- è¿åŠ¿åˆ†æï¼š`frontend/fortune.html`
- æœˆè¿ï¼š`frontend/bazi-monthly-fortune.html`
- æ—¥è¿ï¼š`frontend/bazi-daily-fortune.html`

---

## ğŸ’¡ å¼€å‘åŸåˆ™

1. **ğŸ”´ é›¶åœæœºä¼˜å…ˆ**ï¼šæ‰€æœ‰è®¾è®¡å¿…é¡»æ”¯æŒä¸åœæœºæ›´æ–°
2. **å…ˆå’¨è¯¢ï¼Œåä¿®æ”¹**ï¼šä¸ç¡®å®šæ—¶è¯¢é—®ç”¨æˆ·
3. **å°æ­¥å¿«è·‘**ï¼šæ¯æ¬¡ä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½ç‚¹
4. **å‘åå…¼å®¹**ï¼šåªåŠ ä¸åˆ ï¼Œä¿æŒå…¼å®¹
5. **åŠæ—¶æµ‹è¯•**ï¼šä¿®æ”¹åç«‹å³æµ‹è¯•
6. **æ¸…æ™°è®°å½•**ï¼šä¿®æ”¹è¿‡ç¨‹è®°å½•åˆ°æ–‡æ¡£
7. **ä¿æŒç®€æ´**ï¼šé¿å…è¿‡åº¦è®¾è®¡
8. **æ³¨é‡æ€§èƒ½**ï¼šè€ƒè™‘ç¼“å­˜å’Œä¼˜åŒ–

---

## âš™ï¸ Cursor é…ç½®ä¼˜åŒ–

å½“å‰é…ç½®ä½äºï¼š`~/Library/Application Support/Cursor/User/settings.json`

**æ¨èé…ç½®**ï¼š
```json
{
  "cursor.aiProvider": "anthropic",
  "cursor.model": "claude-sonnet-4-20250514",
  "cursor.anthropicApiKey": "your-key",
  "cursor.anthropicApiBaseUrl": "https://cc.zhihuiapi.top",
  "cursor.useCustomApi": true,
  "cursor.bypassRegionCheck": true,
  "cursor.disableRegionCheck": true
}
```

**ä¸è¦ä½¿ç”¨**ï¼š
- `http.proxy`ï¼ˆåŒé‡ä»£ç†ä¼šå¾ˆæ…¢ï¼‰
- `http.version: "1.1"`ï¼ˆå¼ºåˆ¶HTTP/1.1ä¼šæ›´æ…¢ï¼‰
- `cursor.general.disableHttp2`ï¼ˆç¦ç”¨HTTP/2ä¼šæ›´æ…¢ï¼‰

---

## ğŸ¯ AI åŠ©æ‰‹å“åº”æµç¨‹

æ¯æ¬¡æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼š

1. **ç†è§£éœ€æ±‚** â†’ æ˜ç¡®è¦åšä»€ä¹ˆ
2. **è¯„ä¼°å½±å“** â†’ åˆ—å‡ºå½±å“æ–‡ä»¶å’ŒèŒƒå›´
3. **é«˜å½±å“å’¨è¯¢** â†’ é£é™©é«˜æ—¶å…ˆç¡®è®¤
4. **æ‰§è¡Œä¿®æ”¹** â†’ åªæ”¹å¿…è¦çš„ä»£ç 
5. **æœ¬åœ°æµ‹è¯•** â†’ éªŒè¯åŠŸèƒ½æ­£å¸¸
6. **æé†’æäº¤** â†’ ä¸»åŠ¨æé†’ç”¨æˆ·æäº¤ä»£ç  â­
7. **è®°å½•æ–‡æ¡£** â†’ é‡è¦ä¿®æ”¹è®°å½•åˆ° `docs/`

### âœ… å®Œæˆä»»åŠ¡åçš„æ ‡å‡†è¾“å‡º

```
âœ… åŠŸèƒ½å¼€å‘å®Œæˆï¼

ã€ä¿®æ”¹æ€»ç»“ã€‘
- ä¿®æ”¹æ–‡ä»¶ï¼š[åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶]
- æ–°å¢æ–‡ä»¶ï¼š[å¦‚æœ‰]
- åŠŸèƒ½è¯´æ˜ï¼š[ç®€è¦è¯´æ˜]

ã€æœ¬åœ°æµ‹è¯•ã€‘
âœ“ æœåŠ¡å¯åŠ¨æ­£å¸¸
âœ“ åŠŸèƒ½æµ‹è¯•é€šè¿‡
âœ“ æ— æŠ¥é”™æ—¥å¿—

ã€æäº¤ä»£ç ã€‘
å»ºè®®æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

# 1. æŸ¥çœ‹ä¿®æ”¹
git status

# 2. æ·»åŠ æ–‡ä»¶
git add [å…·ä½“æ–‡ä»¶åˆ—è¡¨]

# 3. æäº¤ä»£ç 
git commit -m "[ç±»å‹] åŠŸèƒ½æè¿°

- ä¿®æ”¹æ–‡ä»¶ï¼š...
- åŠŸèƒ½è¯´æ˜ï¼š...
- æµ‹è¯•æƒ…å†µï¼šå·²é€šè¿‡æœ¬åœ°æµ‹è¯•"

# 4. æ¨é€åˆ°è¿œç¨‹
git push origin [å½“å‰åˆ†æ”¯]

ã€ä¸‹ä¸€æ­¥ã€‘
- æœ¬åœ°æµ‹è¯•ï¼šè®¿é—® http://localhost:8001 éªŒè¯
- åˆå¹¶åˆ° developï¼šæµ‹è¯•é€šè¿‡ååˆå¹¶
- ç”Ÿäº§å‘å¸ƒï¼šdevelop æµ‹è¯•ååˆå¹¶åˆ° master
```

---

## ğŸ“– Giteeï¼ˆç äº‘ï¼‰ä»£ç ä»“åº“

### ğŸ”‘ ä»“åº“ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **ä»“åº“åœ°å€** | https://gitee.com/zhoudengtang/hifate-prod.git |
| **æœ¬åœ° remote** | gitee |
| **é»˜è®¤åˆ†æ”¯** | master |

### ğŸš€ ä»£ç æäº¤æµç¨‹

```bash
# 1. æŸ¥çœ‹ä¿®æ”¹
git status

# 2. æ·»åŠ æ–‡ä»¶
git add .

# 3. æäº¤
git commit -m "[ç±»å‹] æè¿°"

# 4. æ¨é€åˆ° Gitee
git push gitee master
```

### ğŸ“¦ éƒ¨ç½²åˆ°ç”Ÿäº§

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰
./deploy.sh
# é€‰æ‹© 1) å®Œæ•´éƒ¨ç½²

# æ–¹æ³•2ï¼šæ‰‹åŠ¨éƒ¨ç½²
git push gitee master
ssh root@123.57.216.15 'cd /opt/HiFate-bazi && git pull && docker compose up -d --build web'
```

### ğŸŒ å¸¸ç”¨æ“ä½œ

**æŸ¥çœ‹ä»“åº“**ï¼š
```
https://gitee.com/zhoudengtang/hifate-prod
```

**æŸ¥çœ‹æäº¤å†å²**ï¼š
```bash
git log --oneline -10
```

**åŒæ­¥è¿œç¨‹æ›´æ–°**ï¼š
```bash
git pull gitee master
```

---

## ğŸš¨ ç‰¹åˆ«æé†’

### å½“ç”¨æˆ·è¯´è¿™äº›å…³é”®è¯æ—¶ï¼Œç«‹å³æé†’æäº¤ï¼š

- "å®Œæˆäº†" / "å¥½äº†" / "æå®šäº†"
- "æ²¡é—®é¢˜äº†" / "å¯ä»¥äº†" / "è¿è¡Œæ­£å¸¸"
- "æµ‹è¯•é€šè¿‡" / "æ²¡æœ‰bugäº†"
- "åŠŸèƒ½åšå¥½äº†"

### æé†’æ ¼å¼ï¼š

```
âœ… å¤ªå¥½äº†ï¼åŠŸèƒ½å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡ã€‚

ç°åœ¨éœ€è¦æäº¤ä»£ç å—ï¼Ÿæˆ‘å·²ç»ä¸ºä½ å‡†å¤‡å¥½äº†æäº¤å‘½ä»¤ï¼š

git add [æ–‡ä»¶åˆ—è¡¨]
git commit -m "[ç±»å‹] æè¿°"
git push origin [åˆ†æ”¯å]

æ˜¯å¦ç°åœ¨æäº¤ï¼Ÿ
```

---

**è®°ä½**ï¼š
- å®å¯å¤šé—®ï¼Œä¸è¦æ“…è‡ªå†³å®š
- æœ€å°å½±å“åŸåˆ™æ°¸è¿œç¬¬ä¸€
- åŠŸèƒ½å®Œæˆå¿…é¡»æé†’æäº¤ä»£ç  â­
- ä¿æŒä»£ç æ•´æ´å’Œå¯ç»´æŠ¤æ€§
