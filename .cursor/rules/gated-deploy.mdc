---
description: 门控发布规范（Node2 前哨验证 → Node1 生产部署）
alwaysApply: false
globs:
  - deploy/**
  - scripts/deploy/**
---

# 门控发布规范

> **完整文档**：`docs/deploy/门控发布详细说明.md`

## 核心原则

**任何代码变更必须先在 Node2（前哨节点）部署并通过全量测试，才允许部署到 Node1（生产节点）。**

```
Node2 是发布的"物理隔离闸门"：
- Node2 没有用户流量，部署失败不影响任何用户
- Node1 承载全部生产流量，只有 Node2 测试通过后才会触碰
```

---

## 快捷触发（用户说以下关键词即执行）

| 用户说 | 执行命令 |
|--------|---------|
| **芝麻开门** | `bash deploy/scripts/gated_deploy.sh` |
| 芝麻开门 dry-run | `bash deploy/scripts/gated_deploy.sh --dry-run` |
| 芝麻开门 紧急 | `bash deploy/scripts/gated_deploy.sh --skip-node2` |
| 芝麻开门 回滚 | `bash deploy/scripts/gated_deploy.sh --rollback` |

---

## 发布命令

### 标准门控发布（推荐）
```bash
bash deploy/scripts/gated_deploy.sh
```
流程：本地检查 → Node2 部署+测试 → **门控判断** → Node1 部署+验证 → 记录历史

### 其他模式
```bash
# 只在 Node2 验证，不动 Node1
bash deploy/scripts/gated_deploy.sh --dry-run

# 紧急修复（跳过 Node2，慎用）
bash deploy/scripts/gated_deploy.sh --skip-node2

# 只跑 Node2 测试
bash deploy/scripts/gated_deploy.sh --test-only

# 回滚到上一次成功版本
bash deploy/scripts/gated_deploy.sh --rollback
```

---

## AI 模型使用指南

### 用户说"部署"/"发布"
1. 确保代码已提交并推送到 master
2. 执行：`bash deploy/scripts/gated_deploy.sh`
3. 检查输出中的 `GATE PASS` / `GATE FAIL`
4. 如果失败：查看原因，修复后重新发布

### 用户说"测试发布"/"试一下"
使用 dry-run 模式：`bash deploy/scripts/gated_deploy.sh --dry-run`

### 用户说"紧急修复"/"直接部署"
提醒风险，确认后使用：`bash deploy/scripts/gated_deploy.sh --skip-node2`

### 用户说"回滚"
执行：`bash deploy/scripts/gated_deploy.sh --rollback`

---

## 绝对禁止

- ❌ 跳过 Node2 验证直接部署 Node1（除非紧急模式且用户确认）
- ❌ Node2 测试失败时仍然部署 Node1
- ❌ 手动 SSH 到服务器修改代码
- ❌ `docker restart`
