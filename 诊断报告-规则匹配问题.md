# 诊断报告：规则匹配问题

## 执行时间
2025-01-XX

## 按照方案执行的检查结果

### ✅ 步骤 1: 检查生产数据库中是否存在规则

**本地数据库情况：**
- 本地数据库中有 **1299 条**启用的 FORMULA_ 规则
- 按类型统计：
  - career: 61 条
  - character: 92 条
  - children: 22 条
  - health: 119 条
  - marriage: 143 条
  - summary: 555 条
  - wealth: 140 条
  - 其他类型: 167 条

**生产环境情况：**
- 生产环境 API 只返回 **20 条**规则
- 按类型统计：
  - 财富: 12 条
  - 身体: 5 条
  - 婚姻: 1 条
  - 性格: 1 条
  - 总评: 1 条

**对比结果：**
- ❌ **生产环境缺少 1299 条规则**
- 本地规则总数: 1299
- 生产匹配规则数: 20
- 缺失规则数: 1299

### ✅ 步骤 2: 对比代码逻辑

**检查的关键文件：**
1. `server/api/v1/formula_analysis.py`
   - ✅ 使用 RuleService.match_rules
   - ✅ 筛选 FORMULA_ 前缀规则

2. `server/services/rule_service.py`
   - ✅ 筛选 FORMULA_ 前缀规则
   - ✅ 过滤 enabled 规则

3. `server/engines/rule_engine.py`
   - ✅ 使用 RuleService.match_rules

**结论：** ✅ 代码逻辑一致，没有问题

### ✅ 步骤 3: 检查前端展示

**前端文件：** `local_frontend/formula-analysis.html`
- ✅ 前端文件存在
- ✅ 包含所有统计字段（total_matched, wealth_count, career_count, health_count, summary_count）
- ✅ API 路径正确（/bazi/formula-analysis）

**结论：** ✅ 前端展示逻辑正常

## 🔴 根本原因

**生产环境数据库中缺少大量规则数据**

- 本地数据库：1299 条 FORMULA_ 规则
- 生产数据库：可能只有少量规则（导致只匹配到 20 条）

## 💡 解决方案

### 已生成 SQL 文件
- 文件位置：`scripts/temp_rules_export.sql`
- 包含：1299 条规则的 INSERT 语句（使用 ON DUPLICATE KEY UPDATE 确保幂等性）

### 执行修复步骤

**1. 上传 SQL 文件到生产环境：**
```bash
scp scripts/temp_rules_export.sql root@8.210.52.217:/tmp/rules_import.sql
```

**2. 执行 SQL 并清理缓存：**
```bash
ssh root@8.210.52.217 'cd /opt/HiFate-bazi && docker exec -i hifate-mysql-master mysql -uroot -pYuanqizhan@163 hifate_bazi < /tmp/rules_import.sql && curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check'
```

**3. 验证修复结果：**
```bash
python3 scripts/check_status.py
```

## 📊 预期结果

执行修复后：
- 生产环境应该能匹配到接近 63 条规则（与本地测试环境一致）
- 各类型规则数量应该与本地环境接近

## ⚠️ 注意事项

1. **SQL 文件较大**：包含 1299 条规则，执行可能需要几分钟
2. **使用 ON DUPLICATE KEY UPDATE**：确保幂等性，可以重复执行
3. **清理缓存**：执行 SQL 后必须清理缓存，否则规则不会生效
4. **双机同步**：如果 Node2 也需要同步，需要分别在两个节点执行

## 🔄 后续验证

执行修复后，运行以下命令验证：
```bash
python3 scripts/check_status.py
```

如果问题解决，应该看到：
```
✅ 问题已解决
   生产环境: 63 条（或接近）
   目标最低: 56 条
   差异: 0 条（或很小）
```

