# HiFate 生产环境 Docker Compose 主配置
# 使用方式：
#   Node1: docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml up -d
#   Node2: docker-compose -f docker-compose.prod.yml -f docker-compose.node2.yml up -d

version: '3.8'

services:
  # ============================================
  # Nginx 负载均衡
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: hifate-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../nginx/conf.d:/etc/nginx/conf.d:ro
      - /opt/HiFate-bazi/local_frontend:/usr/share/nginx/html/local_frontend:ro
      - nginx_logs:/var/log/nginx
    environment:
      TZ: Asia/Shanghai
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          memory: 80M
        reservations:
          memory: 50M
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      web:
        condition: service_healthy

  # ============================================
  # 主 Web 服务
  # ============================================
  web:
    image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-web
    ports:
      - "8001:8001"
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
      NODE_ID: ${NODE_ID:-node1}
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      SECRET_KEY: ${SECRET_KEY}
      COZE_ACCESS_TOKEN: ${COZE_ACCESS_TOKEN:-}
      COZE_BOT_ID: ${COZE_BOT_ID:-}
      INTENT_BOT_ID: ${INTENT_BOT_ID:-}
      FORTUNE_ANALYSIS_BOT_ID: ${FORTUNE_ANALYSIS_BOT_ID:-}
      DAILY_FORTUNE_ACTION_BOT_ID: ${DAILY_FORTUNE_ACTION_BOT_ID:-}
      TZ: Asia/Shanghai
    volumes:
      - web_logs:/app/logs
      - /opt/HiFate-bazi/server:/app/server:ro  # 挂载 server 目录，支持热更新
      - /opt/HiFate-bazi/src:/app/src:ro  # 挂载 src 目录，支持热更新
      - /opt/HiFate-bazi/services:/app/services:ro  # 挂载 services 目录，支持热更新
      - /opt/HiFate-bazi/proto:/app/proto:ro  # 挂载 proto 目录，支持热更新（修复 gRPC 代码）
    restart: always
    networks:
      - hifate-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    mem_limit: 3g
    memswap_limit: 3g

  # ============================================
  # 微服务
  # ============================================
  bazi-core:
    image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-bazi-core
    ports:
      - "9001:9001"
    environment:
      APP_ENV: production
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      SERVICE_PORT: 9001
      TZ: Asia/Shanghai
    volumes:
      - /opt/HiFate-bazi/proto:/app/proto:ro  # 挂载 proto 目录，支持热更新（修复 gRPC 代码）
      - /opt/HiFate-bazi/services:/app/services:ro  # 挂载 services 目录，支持热更新
      - /opt/HiFate-bazi/src:/app/src:ro  # 挂载 src 目录，支持热更新
    command: python services/bazi_core/grpc_server.py --port 9001
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          memory: 240M
        reservations:
          memory: 150M
    depends_on:
      mysql:
        condition: service_healthy

  bazi-fortune:
    image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-bazi-fortune
    ports:
      - "9002:9002"
    environment:
      APP_ENV: production
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      SERVICE_PORT: 9002
      TZ: Asia/Shanghai
    volumes:
      - /opt/HiFate-bazi/proto:/app/proto:ro  # 挂载 proto 目录，支持热更新
      - /opt/HiFate-bazi/services:/app/services:ro
      - /opt/HiFate-bazi/src:/app/src:ro
    command: python services/bazi_fortune/grpc_server.py --port 9002
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          memory: 240M
        reservations:
          memory: 150M
    depends_on:
      mysql:
        condition: service_healthy

  bazi-analyzer:
    image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-bazi-analyzer
    ports:
      - "9003:9003"
    environment:
      APP_ENV: production
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      SERVICE_PORT: 9003
      TZ: Asia/Shanghai
    volumes:
      - /opt/HiFate-bazi/proto:/app/proto:ro
      - /opt/HiFate-bazi/services:/app/services:ro
      - /opt/HiFate-bazi/src:/app/src:ro
    command: python services/bazi_analyzer/grpc_server.py --port 9003
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          memory: 240M
        reservations:
          memory: 150M
    depends_on:
      mysql:
        condition: service_healthy

  rule-service:
    image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-rule-service
    ports:
      - "9004:9004"
    environment:
      APP_ENV: production
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      SERVICE_PORT: 9004
      TZ: Asia/Shanghai
    volumes:
      - /opt/HiFate-bazi/proto:/app/proto:ro
      - /opt/HiFate-bazi/services:/app/services:ro
      - /opt/HiFate-bazi/src:/app/src:ro
    command: python services/bazi_rule/grpc_server.py --port 9004
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          memory: 240M
        reservations:
          memory: 150M
    depends_on:
      mysql:
        condition: service_healthy

  fortune-analyzer:
    image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-fortune-analyzer
    ports:
      - "9005:9005"
    environment:
      APP_ENV: production
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      SERVICE_PORT: 9005
      TZ: Asia/Shanghai
    volumes:
      - /opt/HiFate-bazi/proto:/app/proto:ro
      - /opt/HiFate-bazi/services:/app/services:ro
      - /opt/HiFate-bazi/src:/app/src:ro
    command: python services/fortune_analysis/grpc_server.py --port 9005
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          memory: 240M
        reservations:
          memory: 150M
    depends_on:
      mysql:
        condition: service_healthy

  payment-service:
    image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-payment-service
    ports:
      - "9006:9006"
    environment:
      APP_ENV: production
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      SERVICE_PORT: 9006
      TZ: Asia/Shanghai
    volumes:
      - /opt/HiFate-bazi/proto:/app/proto:ro
      - /opt/HiFate-bazi/services:/app/services:ro
      - /opt/HiFate-bazi/src:/app/src:ro
    command: python services/payment_service/grpc_server.py --port 9006
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          memory: 240M
        reservations:
          memory: 150M
    depends_on:
      mysql:
        condition: service_healthy

  fortune-rule:
    image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-fortune-rule
    ports:
      - "9007:9007"
    environment:
      APP_ENV: production
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      SERVICE_PORT: 9007
      TZ: Asia/Shanghai
    volumes:
      - /opt/HiFate-bazi/proto:/app/proto:ro
      - /opt/HiFate-bazi/services:/app/services:ro
      - /opt/HiFate-bazi/src:/app/src:ro
    command: python services/fortune_rule/grpc_server.py --port 9007
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          memory: 240M
        reservations:
          memory: 150M
    depends_on:
      mysql:
        condition: service_healthy

  intent-service:
    image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-intent-service
    ports:
      - "9008:9008"
    environment:
      APP_ENV: production
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      SERVICE_PORT: 9008
      SERVICE_HOST: 0.0.0.0
      COZE_ACCESS_TOKEN: ${COZE_ACCESS_TOKEN:-}
      INTENT_BOT_ID: ${INTENT_BOT_ID:-}
      TZ: Asia/Shanghai
    volumes:
      - /opt/HiFate-bazi/proto:/app/proto:ro
      - /opt/HiFate-bazi/services:/app/services:ro
      - /opt/HiFate-bazi/src:/app/src:ro
    command: python services/intent_service/grpc_server.py --port 9008
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          memory: 240M
        reservations:
          memory: 150M
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ============================================
  # auth-service - 已停用（2025-12-29）
  # 原因：暂时停用以节省资源，等待本地修改后重新启用
  # 恢复方式：取消注释下方配置并重新部署
  # ============================================
  # auth-service:
  #   image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
  #   container_name: hifate-auth-service
  #   ports:
  #     - "9011:9011"
  #   environment:
  #     APP_ENV: production
  #     # ⚠️ 重要：auth-service 必须连接 Redis 主库（可写），不能连接从库（只读）
  #     # Node1: 使用本地 redis (主库)
  #     # Node2: 使用 Node1 的 redis 主库（通过内网IP或服务名）
  #     REDIS_HOST: ${REDIS_MASTER_HOST:-redis}
  #     REDIS_PORT: 6379
  #     REDIS_PASSWORD: ${REDIS_PASSWORD:-}
  #     REDIS_DB: ${REDIS_DB:-0}
  #     AUTH_SERVICE_PORT: 9011
  #     OAUTH_CLIENT_ID: ${OAUTH_CLIENT_ID:-hifate_client}
  #     OAUTH_CLIENT_SECRET: ${OAUTH_CLIENT_SECRET:-hifate_secret_change_me}
  #     OAUTH_AUTHORIZATION_CODE_EXPIRE_MINUTES: ${OAUTH_AUTHORIZATION_CODE_EXPIRE_MINUTES:-10}
  #     OAUTH_ACCESS_TOKEN_EXPIRE_MINUTES: ${OAUTH_ACCESS_TOKEN_EXPIRE_MINUTES:-60}
  #     OAUTH_REFRESH_TOKEN_EXPIRE_DAYS: ${OAUTH_REFRESH_TOKEN_EXPIRE_DAYS:-30}
  #     TZ: Asia/Shanghai
  #   volumes:
  #     - /opt/HiFate-bazi/proto:/app/proto:ro  # 挂载 proto 目录，支持热更新
  #     - /opt/HiFate-bazi/services:/app/services:ro  # 挂载 services 目录，支持热更新
  #     - /opt/HiFate-bazi/src:/app/src:ro  # 挂载 src 目录，支持热更新
  #   command: python services/auth_service/main.py --port 9011
  #   restart: always
  #   networks:
  #     - hifate-network
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 240M
  #       reservations:
  #         memory: 150M
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "python", "-c", "import grpc; import sys; sys.path.insert(0, '/app/proto/generated'); import auth_pb2, auth_pb2_grpc; channel = grpc.insecure_channel('localhost:9011'); stub = auth_pb2_grpc.AuthServiceStub(channel); response = stub.HealthCheck(auth_pb2.HealthCheckRequest(), timeout=5.0); exit(0 if response.status == 'ok' else 1)"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 30s

  prompt-optimizer:
    image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-prompt-optimizer
    ports:
      - "9009:9009"
    environment:
      APP_ENV: production
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      SERVICE_PORT: 9009
      SERVICE_HOST: 0.0.0.0
      COZE_ACCESS_TOKEN: ${COZE_ACCESS_TOKEN:-}
      COZE_BOT_ID: ${COZE_BOT_ID:-}
      TZ: Asia/Shanghai
    volumes:
      - /opt/HiFate-bazi/proto:/app/proto:ro
      - /opt/HiFate-bazi/services:/app/services:ro
      - /opt/HiFate-bazi/src:/app/src:ro
    command: python services/prompt_optimizer/grpc_server.py
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          memory: 240M
        reservations:
          memory: 150M
    depends_on:
      mysql:
        condition: service_healthy

  # ============================================
  # desk-fengshui - 已停用（2025-12-29）
  # 原因：暂时停用以节省资源，等待本地修改后重新启用
  # 恢复方式：取消注释下方配置并重新部署
  # ============================================
  # desk-fengshui:
  #   image: ${ACR_REGISTRY:-registry.cn-hangzhou.aliyuncs.com}/${ACR_NAMESPACE:-hifate}/hifate-bazi:${IMAGE_TAG:-latest}
  #   container_name: hifate-desk-fengshui
  #   ports:
  #     - "9010:9010"
  #   environment:
  #     APP_ENV: production
  #     MYSQL_HOST: mysql
  #     MYSQL_PORT: 3306
  #     MYSQL_USER: ${MYSQL_USER:-root}
  #     MYSQL_PASSWORD: ${MYSQL_PASSWORD}
  #     MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
  #     REDIS_HOST: redis
  #     REDIS_PORT: 6379
  #     REDIS_PASSWORD: ${REDIS_PASSWORD:-}
  #     SERVICE_PORT: 9010
  #     TZ: Asia/Shanghai
  #   volumes:
  #     - web_logs:/app/logs  # 挂载日志目录，解决日志文件创建问题
  #     - /opt/HiFate-bazi/proto:/app/proto:ro
  #     - /opt/HiFate-bazi/services:/app/services:ro
  #     - /opt/HiFate-bazi/src:/app/src:ro
  #   command: python services/desk_fengshui/grpc_server.py --port 9010
  #   restart: always
  #   networks:
  #     - hifate-network
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 240M
  #       reservations:
  #         memory: 150M
  #   depends_on:
  #     mysql:
  #       condition: service_healthy

volumes:
  nginx_logs:
  web_logs:
  mysql_data:
  redis_data:

networks:
  hifate-network:
    driver: bridge
