# 04 - 日常运维

## 常用命令

### 服务管理

```bash
cd /opt/HiFate-bazi/deploy/docker

# 查看服务状态
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml logs -f
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml logs -f web

# 重启服务
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml restart web

# 停止服务
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml stop

# 启动服务
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml up -d
```

### 更新部署

```bash
cd /opt/HiFate-bazi

# 拉取最新代码
git pull

# 拉取最新镜像
docker pull registry.cn-hangzhou.aliyuncs.com/hifate/hifate-bazi:latest

# 重新部署（零停机）
cd deploy/docker
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml up -d --no-deps web
```

### 健康检查

```bash
# 手动检查
bash /opt/HiFate-bazi/deploy/scripts/health-check.sh

# 添加定时任务
crontab -e
# 添加：*/5 * * * * /opt/HiFate-bazi/deploy/scripts/health-check.sh >> /var/log/hifate-health.log 2>&1
```

## 数据库运维

### 备份数据库

```bash
# 在 Node1 上备份
docker exec hifate-mysql-master mysqldump -uroot -p${MYSQL_PASSWORD} hifate_bazi > backup_$(date +%Y%m%d).sql

# 定时备份
0 2 * * * docker exec hifate-mysql-master mysqldump -uroot -p${MYSQL_PASSWORD} hifate_bazi > /opt/backup/mysql_$(date +\%Y\%m\%d).sql
```

### 查看复制状态

```bash
# 在 Node2 从库
docker exec -it hifate-mysql-slave mysql -uroot -p -e "SHOW SLAVE STATUS\G"

# 关键指标：
# Slave_IO_Running: Yes
# Slave_SQL_Running: Yes
# Seconds_Behind_Master: 0
```

### 恢复数据库

```bash
# 停止从库复制
docker exec -it hifate-mysql-slave mysql -uroot -p -e "STOP SLAVE;"

# 导入数据
docker exec -i hifate-mysql-master mysql -uroot -p${MYSQL_PASSWORD} hifate_bazi < backup.sql

# 重新同步从库
docker exec -it hifate-mysql-slave mysql -uroot -p -e "START SLAVE;"
```

## Redis 运维

### 查看复制状态

```bash
# 在 Node1 主库
docker exec -it hifate-redis-master redis-cli INFO replication

# 在 Node2 从库
docker exec -it hifate-redis-slave redis-cli INFO replication
```

### 清理缓存

```bash
# 清理所有缓存（谨慎！）
docker exec -it hifate-redis-master redis-cli FLUSHALL

# 清理单个 key
docker exec -it hifate-redis-master redis-cli DEL key_name

# 清理匹配的 key
docker exec -it hifate-redis-master redis-cli --scan --pattern "prefix:*" | xargs -r docker exec -i hifate-redis-master redis-cli DEL
```

## 日志管理

### 查看日志

```bash
# Nginx 日志
docker logs -f hifate-nginx
# 或
docker exec -it hifate-nginx tail -f /var/log/nginx/hifate-access.log

# 应用日志
docker logs -f hifate-web

# MySQL 慢查询日志
docker exec -it hifate-mysql-master cat /var/lib/mysql/slow.log
```

### 清理日志

```bash
# Docker 日志清理（由 daemon.json 自动限制大小）

# 清理旧日志文件
find /var/log -name "*.log" -mtime +30 -delete
```

## 磁盘管理

### 查看磁盘使用

```bash
df -h
docker system df
```

### 清理 Docker 资源

```bash
# 清理未使用的镜像
docker image prune -a

# 清理未使用的容器
docker container prune

# 清理所有未使用资源
docker system prune -a

# 查看各容器占用空间
docker ps -s
```

## 性能监控

### 系统监控

```bash
# CPU 和内存
htop

# 网络连接
netstat -an | grep ESTABLISHED | wc -l

# 磁盘 IO
iostat -x 1
```

### 容器监控

```bash
# 实时资源使用
docker stats

# 单个容器
docker stats hifate-web
```
