# 05 - 故障处理

## 故障判断

### 快速检查

```bash
# 运行健康检查脚本
bash /opt/HiFate-bazi/deploy/scripts/health-check.sh
```

### 检查清单

1. Nginx 是否正常：`curl http://localhost/nginx_status`
2. Web 服务是否正常：`curl http://localhost:8001/health`
3. MySQL 是否正常：`docker exec hifate-mysql-master mysqladmin ping -uroot -p`
4. Redis 是否正常：`docker exec hifate-redis-master redis-cli ping`
5. 容器是否运行：`docker ps | grep hifate`

## 常见故障处理

### 故障 1：单个服务挂了

**现象**：某个微服务容器停止运行

**处理**：
```bash
cd /opt/HiFate-bazi/deploy/docker

# 重启单个服务
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml restart web

# 或重新创建
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml up -d --force-recreate web
```

### 故障 2：Node1 整机挂了

**现象**：Node1 所有服务不可用，用户访问失败

**处理**：

1. **DNS 切换到 Node2**（如果使用 DNS 轮询）
   - 修改 DNS 记录，只指向 Node2 IP
   - 或告知用户访问 Node2 IP

2. **Node2 MySQL 提升为主库**
   ```bash
   # 在 Node2 上
   docker exec -it hifate-mysql-slave mysql -uroot -p
   
   # 停止从库
   STOP SLAVE;
   RESET SLAVE ALL;
   
   # 关闭只读
   SET GLOBAL read_only = OFF;
   SET GLOBAL super_read_only = OFF;
   ```

3. **修改 Node2 应用配置**
   ```bash
   # 编辑 .env，确保 MySQL 指向本机
   vim /opt/HiFate-bazi/.env
   # 确保 MYSQL_HOST=mysql
   
   # 重启服务
   cd /opt/HiFate-bazi/deploy/docker
   docker-compose -f docker-compose.prod.yml -f docker-compose.node2.yml up -d
   ```

4. **等 Node1 恢复后重新配置主从**

### 故障 3：Node2 整机挂了

**现象**：Node2 不可用，但 Node1 正常

**处理**：
- 无需处理，Node1 继续提供服务
- 等 Node2 恢复后重启服务即可

### 故障 4：MySQL 主从同步中断

**现象**：`SHOW SLAVE STATUS` 显示 Slave_SQL_Running: No

**处理**：
```bash
# 在从库
docker exec -it hifate-mysql-slave mysql -uroot -p

# 查看错误
SHOW SLAVE STATUS\G

# 跳过错误（谨慎使用）
STOP SLAVE;
SET GLOBAL SQL_SLAVE_SKIP_COUNTER = 1;
START SLAVE;

# 或重新同步
STOP SLAVE;
RESET SLAVE;
CHANGE MASTER TO
    MASTER_HOST='NODE1_IP',
    MASTER_USER='repl',
    MASTER_PASSWORD='your_repl_password',
    MASTER_AUTO_POSITION=1;
START SLAVE;
```

### 故障 5：磁盘满

**现象**：服务异常，`df -h` 显示磁盘使用 100%

**处理**：
```bash
# 查看大文件
du -sh /* | sort -rh | head -20

# 清理 Docker
docker system prune -a

# 清理日志
truncate -s 0 /var/log/*.log
docker exec -it hifate-mysql-master sh -c "truncate -s 0 /var/lib/mysql/slow.log"

# 清理旧备份
find /opt/backup -name "*.sql" -mtime +7 -delete
```

### 故障 6：OOM（内存不足）

**现象**：容器被 kill，dmesg 显示 OOM

**处理**：
```bash
# 查看内存使用
docker stats --no-stream

# 限制容器内存（编辑 docker-compose）
# deploy:
#   resources:
#     limits:
#       memory: 512M

# 或增加 swap
fallocate -l 4G /swapfile
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
echo '/swapfile none swap sw 0 0' >> /etc/fstab
```

## 回滚操作

### 回滚应用版本

```bash
# 查看可用镜像
docker images | grep hifate-bazi

# 执行回滚
bash /opt/HiFate-bazi/deploy/scripts/rollback.sh <old_tag> node1
```

### 恢复数据库

```bash
# 从备份恢复
docker exec -i hifate-mysql-master mysql -uroot -p${MYSQL_PASSWORD} hifate_bazi < backup_YYYYMMDD.sql
```

## 紧急联系

### 阿里云支持

- 工单：https://workorder.console.aliyun.com/
- 电话：95187

### 监控告警

配置钉钉/企业微信告警后，故障会自动通知。
