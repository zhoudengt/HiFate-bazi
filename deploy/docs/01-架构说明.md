# 01 - 架构说明

## 整体架构

```
                       用户请求
                           │
                      DNS 轮询
                           │
         ┌─────────────────┴─────────────────┐
         │                                   │
    ┌────▼────┐                         ┌────▼────┐
    │  Node1  │  (2C8G, Alinux3)        │  Node2  │  (2C8G, Alinux3)
    │         │                         │         │
    ├─────────┤                         ├─────────┤
    │ Nginx   │◄──────负载均衡──────────►│ Nginx   │
    │ :80     │                         │ :80     │
    ├─────────┤                         ├─────────┤
    │ Web     │                         │ Web     │
    │ :8001   │                         │ :8001   │
    ├─────────┤                         ├─────────┤
    │ 微服务  │                         │ 微服务  │
    │ :9001   │                         │ :9001   │
    │ :9002   │                         │ :9002   │
    │ ...     │                         │ ...     │
    │ :9010   │                         │ :9010   │
    ├─────────┤                         ├─────────┤
    │ MySQL主 │────────复制────────────►│ MySQL从 │
    │ :3306   │                         │ :3306   │
    ├─────────┤                         ├─────────┤
    │ Redis主 │────────复制────────────►│ Redis从 │
    │ :6379   │                         │ :6379   │
    └─────────┘                         └─────────┘
```

## 高可用原理

**核心思想**：任何一个节点挂了，另一个节点能独立提供完整服务。

### 场景 1：Node1 挂了

- DNS 或用户手动切换到 Node2
- Node2 的 Nginx 接收请求
- Node2 的应用服务处理请求
- Node2 的 MySQL 从库提升为主库（手动执行）
- Node2 的 Redis 从库自动提升为主库

### 场景 2：Node2 挂了

- Node1 继续正常服务
- 所有请求由 Node1 处理
- 数据库和缓存无影响

## 服务端口清单

| 服务 | 端口 | 说明 |
|------|------|------|
| Nginx | 80 | HTTP 入口 |
| Web 服务 | 8001 | 主 API 服务 |
| bazi-core | 9001 | 八字核心计算 |
| bazi-fortune | 9002 | 运势计算 |
| bazi-analyzer | 9003 | 八字分析 |
| rule-service | 9004 | 规则匹配 |
| fortune-analyzer | 9005 | 运势分析 |
| payment-service | 9006 | 支付服务 |
| fortune-rule | 9007 | 运势规则 |
| intent-service | 9008 | 意图识别 |
| prompt-optimizer | 9009 | 提示优化 |
| desk-fengshui | 9010 | 风水分析 |
| MySQL | 3306 | 数据库 |
| Redis | 6379 | 缓存 |

## 数据流向

1. **用户请求** → DNS 解析到 Node1 或 Node2 的公网 IP
2. **Nginx** → 接收请求，负载均衡到两台机器的 Web 服务
3. **Web 服务** → 处理请求，调用微服务
4. **微服务** → 读写 MySQL/Redis
5. **MySQL 主从** → Node1 写入，自动复制到 Node2
6. **Redis 主从** → 同上

## Nginx 负载均衡策略

```nginx
upstream web_backend {
    server NODE1_IP:8001 weight=1 max_fails=3 fail_timeout=30s;
    server NODE2_IP:8001 weight=1 max_fails=3 fail_timeout=30s;
    keepalive 32;
}
```

- **weight=1**：两台机器权重相同
- **max_fails=3**：连续失败 3 次后暂时剔除
- **fail_timeout=30s**：30 秒后重新尝试
- **keepalive=32**：保持 32 个长连接

## 数据库主从复制

### MySQL 主从

- 使用 GTID 模式，自动同步
- 主库（Node1）负责写入
- 从库（Node2）只读，实时同步
- 故障切换时，从库可提升为主库

### Redis 主从

- 异步复制，实时同步
- 主库（Node1）负责写入
- 从库（Node2）只读
- 主库挂了，从库自动可写（需配置）
