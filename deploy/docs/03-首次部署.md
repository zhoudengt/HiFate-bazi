# 03 - 首次部署

## 前置条件

- 两台 ECS 已完成初始化
- 代码已克隆到 /opt/HiFate-bazi
- 记录好两台机器的内网 IP

## 部署流程

### 1. 配置环境变量

**两台机器都要执行：**

```bash
cd /opt/HiFate-bazi

# 复制模板
cp deploy/env/env.template .env

# 编辑配置
vim .env
```

**必须修改的配置：**

```bash
# 两台机器的内网 IP（必填）
NODE1_IP=172.16.0.10    # 替换为实际 IP
NODE2_IP=172.16.0.11    # 替换为实际 IP

# MySQL 密码（必填）
MYSQL_PASSWORD=your_strong_password

# 应用密钥（必填）
SECRET_KEY=your_random_secret_key
```

### 2. 部署 Node1（主节点）

```bash
# 进入 Node1
ssh root@NODE1_PUBLIC_IP

cd /opt/HiFate-bazi

# 执行部署
bash deploy/scripts/deploy.sh node1
```

**部署过程：**
1. 检查环境变量
2. 替换 Nginx 配置中的 IP
3. 拉取 Docker 镜像
4. 启动 MySQL 主库、Redis 主库
5. 启动 Web 服务和微服务
6. 启动 Nginx
7. 健康检查

### 3. 配置 MySQL 主从复制

**在 Node1 上创建复制用户：**

```bash
# 进入 MySQL 容器
docker exec -it hifate-mysql-master mysql -uroot -p

# 创建复制用户
CREATE USER 'repl'@'%' IDENTIFIED BY 'your_repl_password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;

# 查看主库状态
SHOW MASTER STATUS;
# 记录 File 和 Position（GTID 模式可忽略）
```

### 4. 部署 Node2（从节点）

```bash
# 进入 Node2
ssh root@NODE2_PUBLIC_IP

cd /opt/HiFate-bazi

# 执行部署
bash deploy/scripts/deploy.sh node2
```

**在 Node2 上配置从库：**

```bash
# 进入 MySQL 容器
docker exec -it hifate-mysql-slave mysql -uroot -p

# 配置主从复制（GTID 模式）
CHANGE MASTER TO
    MASTER_HOST='NODE1_IP',
    MASTER_USER='repl',
    MASTER_PASSWORD='your_repl_password',
    MASTER_AUTO_POSITION=1;

# 启动从库
START SLAVE;

# 查看从库状态
SHOW SLAVE STATUS\G
# 确认 Slave_IO_Running 和 Slave_SQL_Running 都是 Yes
```

### 5. 验证部署

**检查服务状态：**

```bash
# Node1
docker ps | grep hifate

# 应该看到所有服务都在运行
# hifate-nginx
# hifate-web
# hifate-bazi-core
# hifate-bazi-fortune
# ...
# hifate-mysql-master
# hifate-redis-master
```

**检查健康状态：**

```bash
# Node1
curl http://localhost/health
curl http://localhost:8001/health

# Node2
curl http://localhost/health
curl http://localhost:8001/health
```

**检查负载均衡：**

```bash
# 从外部多次访问，查看是否分发到不同节点
for i in {1..10}; do curl -s http://NODE1_PUBLIC_IP/health; done
```

### 6. 导入数据库（如果有）

```bash
# 在 Node1 上导入数据
docker exec -i hifate-mysql-master mysql -uroot -p${MYSQL_PASSWORD} hifate_bazi < backup.sql
```

## 常见问题

### 镜像拉取失败

```bash
# 手动登录 ACR
docker login registry.cn-hangzhou.aliyuncs.com -u your_username

# 或使用本地构建
cd /opt/HiFate-bazi
docker build -t hifate-bazi:latest .
```

### MySQL 连接失败

```bash
# 检查容器日志
docker logs hifate-mysql-master

# 检查网络
docker network ls
docker network inspect deploy_hifate-network
```

### 主从复制不工作

```bash
# 在从库检查状态
SHOW SLAVE STATUS\G

# 常见问题：
# - 网络不通（检查安全组）
# - 密码错误
# - GTID 冲突（重置从库）
```

## 下一步

部署完成后，参考 [04-日常运维](04-日常运维.md) 进行日常管理。
