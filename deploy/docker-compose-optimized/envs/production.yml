# HiFate-bazi Docker Compose 生产环境覆盖
# 使用方式：docker-compose -f deploy/docker-compose-optimized/base.yml \
#           -f deploy/docker-compose-optimized/envs/production.yml up -d

# ============================================================
# 生产环境资源限制模板
# ============================================================

x-deploy-production: &deploy-production
  resources:
    limits:
      cpus: '2.0'
      memory: 2G
    reservations:
      cpus: '1.0'
      memory: 1G
  restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3

x-deploy-microservice: &deploy-microservice
  resources:
    limits:
      cpus: '1.0'
      memory: 1G
    reservations:
      cpus: '0.5'
      memory: 512M
  restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3

# ============================================================
# 服务覆盖
# ============================================================

services:
  # 主 Web 服务 - 生产模式
  web:
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
    deploy:
      <<: *deploy-production
    restart: always
    # 不挂载源代码（使用镜像内代码）
    volumes: []

  # MySQL - 生产模式
  mysql:
    # 不暴露到宿主机（安全）
    ports: []
    expose:
      - "3306"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
        reservations:
          cpus: '1.0'
          memory: 1G

  # Redis - 生产模式
  redis:
    ports: []
    expose:
      - "6379"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # 八字核心服务 - 生产模式
  bazi-core:
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
    deploy:
      <<: *deploy-microservice
    restart: always
    volumes: []

  # 八字分析服务 - 生产模式
  bazi-analyzer:
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
    deploy:
      <<: *deploy-microservice
    restart: always
    volumes: []

  # 规则服务 - 生产模式
  bazi-rule:
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
    deploy:
      <<: *deploy-microservice
    restart: always
    volumes: []

  # 运势分析服务 - 生产模式
  fortune-analysis:
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
    deploy:
      <<: *deploy-microservice
    restart: always
    volumes: []

  # 支付服务 - 生产模式
  payment-service:
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
    deploy:
      <<: *deploy-microservice
    restart: always
    volumes: []
