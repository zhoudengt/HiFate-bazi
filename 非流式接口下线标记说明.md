# 非流式接口下线标记说明

## 标记时间
2026-02-06

## 标记的接口（6个）

以下6个非流式接口已标记为下线（deprecated），但功能保留，待服务稳定后删除：

### 1. `/bazi/wuxing-proportion` (五行占比)
- **文件**: `server/api/v1/wuxing_proportion.py:129`
- **标记方式**: `deprecated=True` + 警告日志 + 文档说明
- **替代接口**: `POST /api/v1/bazi/wuxing-proportion/stream`

### 2. `/bazi/xishen-jishen` (喜神忌神)
- **文件**: `server/api/v1/xishen_jishen.py:146`
- **标记方式**: `deprecated=True` + 警告日志 + 文档说明
- **替代接口**: `POST /api/v1/bazi/xishen-jishen/stream`

### 3. `/daily-fortune-calendar/query` (每日运势日历)
- **文件**: `server/api/v1/daily_fortune_calendar.py:144`
- **标记方式**: `deprecated=True` + 警告日志 + 文档说明
- **替代接口**: `POST /api/v1/daily-fortune-calendar/stream`

### 4. `/smart-fortune/smart-analyze` (智能运势分析)
- **文件**: `server/api/v1/smart_fortune.py:76`
- **标记方式**: `deprecated=True` + 警告日志 + 文档说明
- **替代接口**: `GET /api/v1/smart-fortune/smart-analyze-stream`

### 5. `/api/v2/face/analyze` (面相综合分析)
- **文件**: `server/api/v2/face_analysis.py:45`
- **标记方式**: `deprecated=True` + 警告日志 + 文档说明
- **替代接口**: `POST /api/v2/face/analyze/stream`

### 6. `/api/v2/desk-fengshui/analyze` (办公桌风水分析)
- **文件**: `server/api/v2/desk_fengshui_api.py:41`
- **标记方式**: `deprecated=True` + 警告日志 + 文档说明
- **替代接口**: `POST /api/v2/desk-fengshui/analyze/stream`

---

## 标记内容

### 1. FastAPI 路由装饰器
在 `@router.post()` 或 `@router.get()` 中添加 `deprecated=True` 参数：
```python
@router.post("/bazi/wuxing-proportion", ..., deprecated=True)
```

### 2. 警告日志
在函数开头添加警告日志：
```python
logger.warning("⚠️ [DEPRECATED] 非流式接口 /bazi/wuxing-proportion 已标记为下线，建议使用流式接口 /bazi/wuxing-proportion/stream")
```

### 3. 文档说明
在 docstring 开头添加下线说明：
```python
"""
⚠️ **接口已标记为下线（deprecated）**

此接口已标记为下线，建议使用流式接口：`POST /api/v1/bazi/wuxing-proportion/stream`
流式接口返回相同的基础数据（type: 'data'），并额外提供流式LLM分析。

...
"""
```

---

## 效果

1. **API 文档中显示为已废弃**：FastAPI 的 Swagger UI (`/docs`) 中会显示这些接口为已废弃
2. **警告日志**：每次调用这些接口时会在日志中输出警告信息
3. **功能保留**：接口功能完全保留，不影响现有调用

---

## 删除计划

待服务稳定后，用户会提醒删除这些接口。删除时需要：

1. **删除接口函数**：删除整个函数定义
2. **删除 gRPC 网关注册**：在 `server/api/grpc_gateway.py` 中删除对应的 `@_register()` 装饰器和处理函数
3. **更新文档**：更新相关文档，移除这些接口的说明
4. **验证**：确认前端和其他服务不再调用这些接口

---

## 注意事项

- ⚠️ **前端代码仍在使用这些接口**：根据分析，前端代码（`local_frontend/`）仍在使用这些非流式接口
- ⚠️ **删除前需确认**：删除前需要确认前端团队已迁移到流式接口，或前端代码已更新
- ✅ **当前状态**：接口已标记为下线，但功能保留，可以继续使用
