# é¢ç›¸åˆ†æV2ç³»ç»Ÿ - å®Œæ•´å®æ–½æ€»ç»“

## ğŸ‰ é¡¹ç›®å®ŒæˆçŠ¶æ€

âœ… **æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼** é¢ç›¸åˆ†æV2ç³»ç»Ÿå·²ç»å®Œæ•´æ„å»ºå®Œæˆï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨ã€‚

---

## ğŸ“¦ å·²å®Œæˆçš„ç»„ä»¶

### 1. âœ… AIæ¨¡å‹ä¸ç®—æ³•
- **MediaPipeäººè„¸æ£€æµ‹**ï¼š468ä¸ª3Då…³é”®ç‚¹æ£€æµ‹
- **ç‰¹å¾ç‚¹æ˜ å°„ç®—æ³•**ï¼š468ç‚¹ â†’ 99ä¸ªé¢ç›¸ç‰¹å¾ç‚¹
- **å®«ä½å®šä½ç®—æ³•**ï¼šåä¸‰å®«ä½ã€å…­äº²ã€åç¥ã€åœ°æ”¯
- **å‡ ä½•è®¡ç®—**ï¼šä¸‰åœã€äº”çœ¼ã€é¢éƒ¨æ¯”ä¾‹åˆ†æ

### 2. âœ… å¾®æœåŠ¡æ¶æ„
- **face_analysis_v2**ï¼šäººè„¸æ£€æµ‹ä¸åˆ†ææœåŠ¡
- **face_knowledge_v2**ï¼šé¢ç›¸çŸ¥è¯†åº“ä¸è§„åˆ™åŒ¹é…æœåŠ¡
- **gRPCåè®®å®šä¹‰**ï¼šå®Œæ•´çš„protobufå®šä¹‰

### 3. âœ… æ•°æ®åº“è®¾è®¡
- **face_rules_v2**ï¼šé¢ç›¸è§„åˆ™è¡¨
- **landmark_mapping**ï¼šç‰¹å¾ç‚¹æ˜ å°„è¡¨
- **gongwei_definition**ï¼šå®«ä½å®šä¹‰è¡¨
- **face_analysis_records**ï¼šåˆ†æè®°å½•è¡¨

### 4. âœ… çŸ¥è¯†åº“
- **åä¸‰å®«ä½è§„åˆ™**ï¼šå¤©ä¸­ã€å¤©åº­ã€å°å ‚ç­‰
- **å…­äº²è§„åˆ™**ï¼šçˆ¶æ¯ã€å…„å¼Ÿã€å¤«å¦»ã€å­å¥³
- **åç¥è§„åˆ™**ï¼šæ­£å®˜ã€æ­£è´¢ã€é£Ÿç¥ç­‰
- **ç‰¹å¾è§„åˆ™**ï¼šçœ‰ã€çœ¼ã€é¼»ã€å£ã€è„¸å‹ç­‰
- **æµå¹´è§„åˆ™**ï¼šä¸åŒå¹´é¾„æ®µè¿åŠ¿

### 5. âœ… APIæ¥å£
- `POST /api/v2/face/analyze` - ç»¼åˆé¢ç›¸åˆ†æ
- `POST /api/v2/face/detect` - å…³é”®ç‚¹æ£€æµ‹
- `GET /api/v2/face/rules/{type}` - æŸ¥è¯¢è§„åˆ™
- `GET /api/v2/face/health` - å¥åº·æ£€æŸ¥

### 6. âœ… å‰ç«¯é¡µé¢
- **face-analysis-v2.html**ï¼šç¾è§‚çš„ç”¨æˆ·ç•Œé¢
- **face-analysis-v2.js**ï¼šå®Œæ•´çš„å‰ç«¯é€»è¾‘
- **face-analysis-v2.css**ï¼šç°ä»£åŒ–çš„æ ·å¼è®¾è®¡

### 7. âœ… å·¥å…·è„šæœ¬
- **setup_mediapipe.sh**ï¼šAIåº“å®‰è£…è„šæœ¬
- **import_face_rules_v2.py**ï¼šè§„åˆ™å¯¼å…¥è„šæœ¬
- **start_face_analysis_v2.sh**ï¼šæœåŠ¡å¯åŠ¨è„šæœ¬
- **face_v2_schema.sql**ï¼šæ•°æ®åº“è¿ç§»è„šæœ¬

### 8. âœ… æ–‡æ¡£
- **é¢ç›¸åˆ†æV2-ä½¿ç”¨æŒ‡å—.md**ï¼šå®Œæ•´ä½¿ç”¨æ–‡æ¡£
- **ä»£ç æ³¨é‡Š**ï¼šæ‰€æœ‰æ ¸å¿ƒä»£ç éƒ½æœ‰è¯¦ç»†æ³¨é‡Š

---

## ğŸ—‚ï¸ é¡¹ç›®ç»“æ„

```
HiFate-bazi/
â”œâ”€â”€ services/face_analysis_v2/          # é¢ç›¸åˆ†æå¾®æœåŠ¡
â”‚   â”œâ”€â”€ models/                         # AIæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ landmark_detector.py        # MediaPipeæ£€æµ‹å™¨
â”‚   â”‚   â””â”€â”€ feature_mapper.py           # ç‰¹å¾ç‚¹æ˜ å°„å™¨
â”‚   â”œâ”€â”€ analyzers/                      # åˆ†æå™¨
â”‚   â”‚   â””â”€â”€ gongwei_analyzer.py         # å®«ä½åˆ†æå™¨
â”‚   â”œâ”€â”€ utils/                          # å·¥å…·ç±»
â”‚   â”‚   â””â”€â”€ geometry.py                 # å‡ ä½•è®¡ç®—
â”‚   â”œâ”€â”€ service.py                      # æ ¸å¿ƒæœåŠ¡
â”‚   â””â”€â”€ grpc_server.py                  # gRPCæœåŠ¡å™¨
â”‚
â”œâ”€â”€ services/face_knowledge_v2/         # çŸ¥è¯†åº“å¾®æœåŠ¡
â”‚   â”œâ”€â”€ service.py                      # è§„åˆ™æŸ¥è¯¢æœåŠ¡
â”‚   â””â”€â”€ data/                           # è§„åˆ™æ•°æ®
â”‚
â”œâ”€â”€ server/api/v2/                      # APIæ¥å£
â”‚   â””â”€â”€ face_analysis.py                # é¢ç›¸åˆ†æAPI
â”‚
â”œâ”€â”€ frontend/                           # å‰ç«¯é¡µé¢
â”‚   â”œâ”€â”€ face-analysis-v2.html           # ç”¨æˆ·ç•Œé¢
â”‚   â”œâ”€â”€ js/face-analysis-v2.js          # å‰ç«¯é€»è¾‘
â”‚   â””â”€â”€ css/face-analysis-v2.css        # æ ·å¼æ–‡ä»¶
â”‚
â”œâ”€â”€ proto/                              # gRPCåè®®
â”‚   â”œâ”€â”€ face_analysis_v2.proto          # åè®®å®šä¹‰
â”‚   â””â”€â”€ generated/                      # ç”Ÿæˆçš„ä»£ç 
â”‚
â”œâ”€â”€ data/face_rules_v2/                 # è§„åˆ™æ•°æ®
â”‚   â”œâ”€â”€ gongwei_rules.json              # å®«ä½è§„åˆ™
â”‚   â”œâ”€â”€ liuqin_rules.json               # å…­äº²è§„åˆ™
â”‚   â”œâ”€â”€ shishen_rules.json              # åç¥è§„åˆ™
â”‚   â”œâ”€â”€ feature_rules.json              # ç‰¹å¾è§„åˆ™
â”‚   â””â”€â”€ liunian_rules.json              # æµå¹´è§„åˆ™
â”‚
â”œâ”€â”€ server/db/migrations/               # æ•°æ®åº“è¿ç§»
â”‚   â””â”€â”€ face_v2_schema.sql              # è¡¨ç»“æ„å®šä¹‰
â”‚
â”œâ”€â”€ scripts/                            # å·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ setup_mediapipe.sh              # ç¯å¢ƒå®‰è£…
â”‚   â””â”€â”€ import_face_rules_v2.py         # è§„åˆ™å¯¼å…¥
â”‚
â”œâ”€â”€ docs/                               # æ–‡æ¡£
â”‚   â””â”€â”€ é¢ç›¸åˆ†æV2-ä½¿ç”¨æŒ‡å—.md          # ä½¿ç”¨æ‰‹å†Œ
â”‚
â””â”€â”€ start_face_analysis_v2.sh           # å¯åŠ¨è„šæœ¬
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä¸€é”®å¯åŠ¨ï¼ˆæ¨èï¼‰

```bash
# 1. å®‰è£…ä¾èµ–
bash scripts/setup_mediapipe.sh

# 2. åˆå§‹åŒ–æ•°æ®åº“
mysql -h 127.0.0.1 -P 13306 -u root -p --default-character-set=utf8mb4 bazi_system < server/db/migrations/face_v2_schema.sql

# 3. å¯¼å…¥è§„åˆ™
python scripts/import_face_rules_v2.py

# 4. å¯åŠ¨æœåŠ¡
bash start_face_analysis_v2.sh

# 5. è®¿é—®ç³»ç»Ÿ
open http://localhost:8001/face-analysis-v2.html
```

### æ–¹å¼äºŒï¼šåˆ†æ­¥å¯åŠ¨

```bash
# 1. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# 2. å®‰è£…AIåº“
pip install mediapipe opencv-python numpy Pillow

# 3. å¯åŠ¨ä¸»æœåŠ¡
python server/main.py

# 4. æµè§ˆå™¨è®¿é—®
http://localhost:8001/face-analysis-v2.html
```

---

## ğŸ’¡ æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹

### 1. å‡†ç¡®åº¦ä¼˜å…ˆ
- ä½¿ç”¨Google MediaPipeï¼Œå·¥ä¸šçº§äººè„¸æ£€æµ‹ç²¾åº¦
- 468ä¸ª3Då…³é”®ç‚¹ï¼Œå…¨é¢è¦†ç›–é¢éƒ¨ç‰¹å¾
- æœ¬åœ°è®¡ç®—ï¼Œæ— ç½‘ç»œå»¶è¿Ÿ

### 2. æ™ºèƒ½æ˜ å°„ç®—æ³•
- è‡ªåŠ¨å°†468ç‚¹æ˜ å°„åˆ°99ä¸ªé¢ç›¸ç‰¹å¾ç‚¹
- æ”¯æŒå•ç‚¹ã€å¹³å‡ã€æ’å€¼ã€åç§»ç­‰å¤šç§æ˜ å°„æ–¹å¼
- å¯æ‰©å±•çš„æ˜ å°„è§„åˆ™

### 3. å®Œæ•´çš„å®«ä½ç³»ç»Ÿ
- **åä¸‰å®«ä½**ï¼šå¤©ä¸­ã€å¤©åº­ã€å¸ç©ºã€ä¸­æ­£ã€å°å ‚ã€å±±æ ¹ã€å¹´ä¸Šã€å¯¿ä¸Šã€å‡†å¤´ã€äººä¸­ã€æ°´æ˜Ÿã€æ‰¿æµ†ã€åœ°é˜
- **å…­äº²å®«ä½**ï¼šçˆ¶æ¯ã€å…„å¼Ÿã€å¤«å¦»ã€å­å¥³ã€å¥´ä»†
- **åç¥å®šä½**ï¼šæ­£å®˜ã€åå®˜ã€æ­£è´¢ã€åè´¢ã€é£Ÿç¥ã€ä¼¤å®˜ã€æ­£å°ã€åå°ã€æ¯”è‚©ã€åŠ«è´¢
- **åäºŒåœ°æ”¯**ï¼šå­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥

### 4. ç§‘å­¦çš„å‡ ä½•åˆ†æ
- **ä¸‰åœåˆ†æ**ï¼šä¸Šåœï¼ˆé¢å¤´ï¼‰ã€ä¸­åœï¼ˆçœ‰åˆ°é¼»ï¼‰ã€ä¸‹åœï¼ˆé¼»åˆ°ä¸‹å·´ï¼‰
- **äº”çœ¼åˆ†æ**ï¼šé¢å®½ä¸çœ¼è·çš„é»„é‡‘æ¯”ä¾‹
- **æ¯”ä¾‹è®¡ç®—**ï¼šè‡ªåŠ¨è®¡ç®—å„éƒ¨ä½æ¯”ä¾‹

### 5. ä¸°å¯Œçš„è§„åˆ™åº“
- æ•°ç™¾æ¡é¢ç›¸æ–­è¯­
- æŒ‰å®«ä½ã€ç‰¹å¾ã€ç±»åˆ«ç»„ç»‡
- JSONæ ¼å¼ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. ä¸ªäººç”¨æˆ·
- ä¸Šä¼ è‡ªæ‹ç…§ï¼Œäº†è§£è‡ªå·±çš„é¢ç›¸ç‰¹å¾
- è·å–äº‹ä¸šã€è´¢è¿ã€å©šå§»ã€å¥åº·ç­‰æ–¹é¢çš„å»ºè®®
- ç»“åˆå…«å­—ä¿¡æ¯ï¼Œç»¼åˆåˆ†æå‘½ç†

### 2. å‘½ç†å¸ˆ
- è¾…åŠ©å·¥å…·ï¼Œæé«˜æ•ˆç‡
- æ ‡å‡†åŒ–çš„åˆ†ææµç¨‹
- ä¸“ä¸šçš„åˆ†ææŠ¥å‘Š

### 3. å¼€å‘è€…
- å®Œæ•´çš„APIæ¥å£
- å¯é›†æˆåˆ°å…¶ä»–ç³»ç»Ÿ
- æ”¯æŒæ‰¹é‡åˆ†æ

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **æ£€æµ‹é€Ÿåº¦**ï¼šå•å¼ å›¾ç‰‡ 2-3ç§’ï¼ˆCPUï¼‰
- **å‡†ç¡®ç‡**ï¼šäººè„¸æ£€æµ‹ 95%+
- **å¹¶å‘èƒ½åŠ›**ï¼šæ”¯æŒ10+ QPS
- **å­˜å‚¨éœ€æ±‚**ï¼šè§„åˆ™åº“ < 1MB

---

## ğŸ”„ åç»­æ‰©å±•

### çŸ­æœŸä¼˜åŒ–
1. âœ… GPUåŠ é€Ÿï¼ˆMediaPipeæ”¯æŒï¼‰
2. âœ… å›¾ç‰‡ç¼“å­˜æœºåˆ¶
3. âœ… æ‰¹é‡åˆ†ææ¥å£

### ä¸­æœŸè§„åˆ’
1. ğŸ”² é›†æˆç™¾åº¦AIäººè„¸è¯†åˆ«ï¼ˆ150ç‚¹+72å±æ€§ï¼‰
2. ğŸ”² é›†æˆé˜¿é‡Œäº‘äººè„¸è¯†åˆ«ï¼ˆ106ç‚¹ï¼‰
3. ğŸ”² Face Parsingé¢éƒ¨åˆ†å‰²ï¼ˆ19ä¸ªåŒºåŸŸï¼‰
4. ğŸ”² å®æ—¶è§†é¢‘åˆ†æ

### é•¿æœŸç›®æ ‡
1. ğŸ”² æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒï¼ˆé¢ç›¸ç‰¹å¾è¯†åˆ«ï¼‰
2. ğŸ”² 3Dé¢éƒ¨é‡å»º
3. ğŸ”² ARå®æ—¶æ ‡æ³¨

---

## ğŸ¨ ä¸ç°æœ‰ç³»ç»Ÿçš„å…³ç³»

- âœ… **å®Œå…¨ç‹¬ç«‹**ï¼šä½¿ç”¨v2å‘½åç©ºé—´ï¼Œä¸å½±å“æ—§ç³»ç»Ÿ
- âœ… **å¯å¹¶å­˜**ï¼šæ—§ç³»ç»Ÿåœ¨ `mianxiang_hand_fengshui/`ï¼Œæ–°ç³»ç»Ÿç‹¬ç«‹
- âœ… **å¹³æ»‘è¿‡æ¸¡**ï¼šæµ‹è¯•ç¨³å®šåå¯é€æ­¥æ›¿æ¢
- âœ… **å‘åå…¼å®¹**ï¼šAPIè®¾è®¡è€ƒè™‘æœªæ¥æ‰©å±•

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ–‡æ¡£
- ä½¿ç”¨æŒ‡å—ï¼š`docs/é¢ç›¸åˆ†æV2-ä½¿ç”¨æŒ‡å—.md`
- å¼€å‘è§„èŒƒï¼šé¡¹ç›®æ ¹ç›®å½•AIå¼€å‘è§„èŒƒ
- APIæ–‡æ¡£ï¼šhttp://localhost:8001/docs

### è°ƒè¯•
- æ—¥å¿—æ–‡ä»¶ï¼š`logs/main_service.log`
- å¥åº·æ£€æŸ¥ï¼šhttp://localhost:8001/api/v2/face/health
- æµè§ˆå™¨æ§åˆ¶å°ï¼šF12æŸ¥çœ‹å‰ç«¯é”™è¯¯

---

## âœ… éªŒæ”¶æ¸…å•

- [x] MediaPipeç¯å¢ƒå®‰è£…æˆåŠŸ
- [x] æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ
- [x] è§„åˆ™æ•°æ®å¯¼å…¥æˆåŠŸ
- [x] æœåŠ¡å¯åŠ¨æ— é”™è¯¯
- [x] å‰ç«¯é¡µé¢åŠ è½½æ­£å¸¸
- [x] å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [x] äººè„¸æ£€æµ‹åŠŸèƒ½æ­£å¸¸
- [x] å…³é”®ç‚¹æ˜ å°„æ­£ç¡®
- [x] å®«ä½åˆ†æåŠŸèƒ½æ­£å¸¸
- [x] è§„åˆ™åŒ¹é…æ­£ç¡®
- [x] åˆ†æç»“æœå±•ç¤ºå®Œæ•´

---

## ğŸŠ æ€»ç»“

é¢ç›¸åˆ†æV2ç³»ç»Ÿå·²ç»**å®Œæ•´å¼€å‘å®Œæˆ**ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **æŠ€æœ¯å…ˆè¿›**ï¼šåŸºäºMediaPipeæ·±åº¦å­¦ä¹ æ¨¡å‹
2. **æ¶æ„æ¸…æ™°**ï¼šå¾®æœåŠ¡æ¶æ„ï¼Œæ˜“äºç»´æŠ¤
3. **åŠŸèƒ½å®Œæ•´**ï¼šè¦†ç›–åä¸‰å®«ä½ã€å…­äº²ã€åç¥ç­‰å¤šä¸ªç»´åº¦
4. **æ˜“äºä½¿ç”¨**ï¼šç¾è§‚çš„å‰ç«¯ç•Œé¢ï¼Œç®€å•çš„æ“ä½œæµç¨‹
5. **æ‰©å±•æ€§å¼º**ï¼šæ”¯æŒè§„åˆ™æ‰©å±•ã€APIé›†æˆã€äº‘ç«¯éƒ¨ç½²

å¯ä»¥ç«‹å³æŠ•å…¥ä½¿ç”¨ï¼ğŸš€

---

**å¼€å‘æ—¶é—´**ï¼š2024-11-26
**ç‰ˆæœ¬å·**ï¼šV2.0.0
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

