# 修复数据库规则 - 快速指南

## 🎯 目标

修复数据库中816条FORMULA规则的`description`字段，确保前端能正确显示规则的筛选条件。

## ⚡ 快速修复（一键执行）

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
./scripts/fix_formula_rules_description.sh
```

这个脚本会：
1. ✅ 试运行：查看需要更新的规则（不实际更新）
2. 🔍 确认提示：询问是否继续
3. 📝 实际更新：更新数据库中的description字段
4. ✔️ 验证：检查修复结果

## 📋 手动执行（分步骤）

如果需要手动控制每个步骤：

### 步骤1：查看需要更新的规则

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
python3 scripts/update_formula_rules_conditions.py --dry-run
```

**输出示例**：
```
需要更新 816 条规则

需要更新的规则（前20条）:
1. FORMULA_70001
   筛选条件1: '地支'
   筛选条件2: '子午冲'
   性别: '无论男女'
...
```

### 步骤2：实际更新数据库

```bash
python3 scripts/update_formula_rules_conditions.py
```

**预期结果**：
```
更新成功: 816/816
✅ 所有规则已更新
```

### 步骤3：验证修复结果

```bash
python3 scripts/verify_migrated_rules.py
```

**检查项目**：
- 数据库规则数量
- description字段内容
- 规则匹配功能

### 步骤4：重启服务

```bash
./restart_server.sh
```

## 🧪 测试验证

### 方法1：前端测试

1. 访问：`http://localhost:8001/frontend/formula-analysis.html`
2. 输入测试数据：
   - 出生日期：2025/11/23
   - 出生时间：12:00
   - 性别：男
3. 点击"开始分析"
4. 检查结果：
   - ✅ 身体类规则显示具体条件（不是"无"）
   - ✅ 十神命格显示1条：偏印格

### 方法2：API测试

```bash
curl -X POST http://localhost:8003/api/v1/bazi/formula-analysis \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "2025-11-23",
    "solar_time": "12:00",
    "gender": "male"
  }' | python3 -m json.tool | grep -A 5 "condition"
```

**期望输出**：应该看到`condition1`和`condition2`字段有值

### 方法3：数据库直接查询

```sql
-- 检查description字段
SELECT rule_code, description
FROM bazi_rules
WHERE rule_code LIKE 'FORMULA_7001%'
LIMIT 5;
```

**期望结果**：`description`字段应该是包含"筛选条件1"和"筛选条件2"的JSON

## ❗ 常见问题

### Q: 脚本报错"No module named 'pymysql'"

```bash
pip install pymysql
```

### Q: 数据库连接失败

检查MySQL服务是否运行：
```bash
# macOS
brew services list | grep mysql

# Linux
systemctl status mysql
```

### Q: 某些规则仍显示"条件：无"

1. 检查原始JSON文件：
   ```bash
   grep -A 5 '"ID": 70011' docs/2025.11.20算法公式.json
   ```

2. 重新运行更新脚本
3. 重启服务清除缓存

## 📊 修复前后对比

### 修复前

**数据库**：
```json
{
  "rule_code": "FORMULA_70011",
  "description": null  // 或 "" 或 "{}"
}
```

**前端显示**：
```
ID: 70011
身体 · 无论男女
条件：无  ❌
易患肾脏炎, 脑溢血...
```

### 修复后

**数据库**：
```json
{
  "rule_code": "FORMULA_70011",
  "description": "{\"筛选条件1\":\"天干地支\",\"筛选条件2\":\"对应五行属性水低于1个（包含1个）\",\"性别\":\"无论男女\"}"
}
```

**前端显示**：
```
ID: 70011
身体 · 无论男女
条件：对应五行属性水低于1个（包含1个）  ✅
易患肾脏炎, 脑溢血...
```

## 📁 相关文件

- **修复脚本**：`scripts/fix_formula_rules_description.sh`（一键修复）
- **更新脚本**：`scripts/update_formula_rules_conditions.py`（核心逻辑）
- **验证脚本**：`scripts/verify_migrated_rules.py`（验证结果）
- **详细文档**：`docs/数据库规则修复指南.md`（完整技术文档）
- **原始数据**：`docs/2025.11.20算法公式.json`（816条规则）

## ✅ 检查清单

- [ ] 运行更新脚本（试运行模式）
- [ ] 确认需要更新的规则数量
- [ ] 运行更新脚本（实际更新）
- [ ] 验证更新结果
- [ ] 重启服务
- [ ] 前端测试验证
- [ ] API测试验证

## 🎉 完成

修复完成后，所有FORMULA规则的`description`字段都会包含正确的筛选条件信息，前端将能正确显示规则的条件，不再出现"条件：无"的问题。

---

**需要帮助？**
- 查看详细文档：`docs/数据库规则修复指南.md`
- 查看API修复报告：`docs/算法公式前端显示问题修复报告.md`
- 查看规则冲突分析：`docs/身体规则冲突问题分析.md`

