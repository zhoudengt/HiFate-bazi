# æ•°æ®ç¼–æ’æ¶æ„è§„èŒƒï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

## ğŸ”´ æ ¸å¿ƒåŸåˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰

> **æ•°æ®åªè®¡ç®—ä¸€æ¬¡ï¼Œæ‰€æœ‰æ¥å£ä»ç»Ÿä¸€å…¥å£è·å–è®¡ç®—å¥½çš„æ•°æ®**

### 1. ç»Ÿä¸€æ•°æ®å…¥å£åŸåˆ™

**å”¯ä¸€çš„æ•°æ®è·å–å…¥å£**ï¼š`server/orchestrators/bazi_data_orchestrator.py` â†’ `BaziDataOrchestrator.fetch_data()`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ‰€æœ‰æµå¼æ¥å£ / API æ¥å£                          â”‚
â”‚  annual_report_analysis.py, general_review_analysis.py, ...        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ è°ƒç”¨
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BaziDataOrchestrator.fetch_data()                     â”‚
â”‚              ï¼ˆç»Ÿä¸€æ•°æ®ç¼–æ’å±‚ - å”¯ä¸€å…¥å£ï¼‰                           â”‚
â”‚                                                                    â”‚
â”‚  èŒè´£ï¼š                                                             â”‚
â”‚  1. å¤„ç†è¾“å…¥å‚æ•°ï¼ˆå†œå†è½¬æ¢ã€æ—¶åŒºè½¬æ¢ï¼‰                               â”‚
â”‚  2. å¹¶è¡Œè·å–å„æ¨¡å—æ•°æ®ï¼ˆbazi, wangshuai, detail, rules ç­‰ï¼‰          â”‚
â”‚  3. ç»„è£…è¿”å›æ•°æ®                                                    â”‚
â”‚  4. ç¼“å­˜ç®¡ç†ï¼ˆè¯»/å†™ï¼‰                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ å†…éƒ¨è°ƒç”¨
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº•å±‚æœåŠ¡å±‚ï¼ˆåªè¢«ç¼–æ’å±‚è°ƒç”¨ï¼‰                       â”‚
â”‚  BaziService, BaziDetailService, WangShuaiService, RuleService...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ç¦æ­¢é‡å¤è®¡ç®—åŸåˆ™

**âŒ ç»å¯¹ç¦æ­¢**ï¼š
- æµå¼æ¥å£/APIæ¥å£ä¸­ç›´æ¥è°ƒç”¨åº•å±‚æœåŠ¡ï¼ˆå¦‚ `BaziDetailService.calculate_detail_full()`ï¼‰
- ä¸‹æ¸¸æœåŠ¡ä¸­é‡å¤è°ƒç”¨ä¸Šæ¸¸æœåŠ¡ï¼ˆå¦‚ `SpecialLiunianService` å†…éƒ¨å†è°ƒç”¨ `BaziDetailService`ï¼‰
- ç»•è¿‡ `BaziDataOrchestrator` ç›´æ¥è·å–æ•°æ®

**âœ… å¿…é¡»éµå®ˆ**ï¼š
- æ‰€æœ‰æ¥å£é€šè¿‡ `BaziDataOrchestrator.fetch_data()` è·å–æ•°æ®
- ä¸‹æ¸¸æœåŠ¡å¿…é¡»æ¥æ”¶ä¸Šæ¸¸å·²è®¡ç®—å¥½çš„æ•°æ®ä½œä¸ºå‚æ•°
- å¦‚æœæ•°æ®å·²åœ¨ `fetch_data()` ä¸­è®¡ç®—ï¼Œä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡ï¼Œä¸è¦è®©ä¸‹æ¸¸é‡æ–°è®¡ç®—

### 3. æ•°æ®ä¼ é€’åŸåˆ™

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… æ­£ç¡®ï¼šé€šè¿‡ fetch_data ç»Ÿä¸€è·å–ï¼Œä¼ é€’å·²è®¡ç®—çš„æ•°æ®
orchestrator_data = await BaziDataOrchestrator.fetch_data(
    solar_date, solar_time, gender,
    modules={
        'detail': True,  # è®¡ç®— detailï¼ˆåŒ…å« liunian_sequenceï¼‰
        'special_liunians': {...}  # åŸºäºå·²è®¡ç®—çš„ detail è·å–ç‰¹æ®Šæµå¹´
    }
)
# fetch_data å†…éƒ¨ä¼šæŠŠ liunian_sequence ä¼ ç»™ SpecialLiunianServiceï¼Œé¿å…é‡å¤è®¡ç®—
```

**é”™è¯¯åšæ³•**ï¼š
```python
# âŒ é”™è¯¯ï¼šç»•è¿‡ç¼–æ’å±‚ç›´æ¥è°ƒç”¨åº•å±‚æœåŠ¡
detail_data = BaziDetailService.calculate_detail_full(solar_date, solar_time, gender)
special_liunians = await SpecialLiunianService.get_special_liunians_batch(...)
# SpecialLiunianService å†…éƒ¨åˆè°ƒç”¨äº† BaziDetailService.calculate_detail_full()ï¼Œå¯¼è‡´é‡å¤è®¡ç®—
```

---

## æ•°æ®æ¨¡å—æ¸…å•

### åŸºç¡€æ¨¡å—ï¼ˆåªè®¡ç®—ä¸€æ¬¡ï¼‰

| æ¨¡å— | æœåŠ¡ | æ•°æ®å†…å®¹ | ä¾èµ– |
|------|------|----------|------|
| `bazi` | `BaziService.calculate_bazi_full()` | å…«å­—å››æŸ±ã€åç¥ã€äº”è¡Œ | æ—  |
| `wangshuai` | `WangShuaiService.calculate_wangshuai()` | æ—ºè¡°ã€å–œå¿Œç¥ | æ—  |
| `detail` | `BaziDetailService.calculate_detail_full()` | å¤§è¿ã€æµå¹´ã€æµæœˆåºåˆ— | æ—  |

### è¡ç”Ÿæ¨¡å—ï¼ˆå¤ç”¨åŸºç¡€æ•°æ®ï¼‰

| æ¨¡å— | æœåŠ¡ | æ•°æ®å†…å®¹ | å¤ç”¨çš„åŸºç¡€æ•°æ® |
|------|------|----------|----------------|
| `special_liunians` | `SpecialLiunianService` | ç‰¹æ®Šæµå¹´ | `detail.liunian_sequence` |
| `rules` | `RuleService` | è§„åˆ™åŒ¹é… | `bazi.bazi_pillars`, `wangshuai` |
| `xishen_jishen` | ç»„è£… | å–œç¥å¿Œç¥ | `bazi`, `wangshuai`, `rules` |
| `wuxing_proportion` | ç»„è£… | äº”è¡Œå æ¯” | `bazi`, `wangshuai` |

---

## æµå¼æ¥å£å¼€å‘è§„èŒƒ

### æ ‡å‡†æµç¨‹

```python
async def _stream_generator(request: XxxRequest):
    """æµå¼æ¥å£æ ‡å‡†å®ç°"""
    try:
        # 1. å¤„ç†è¾“å…¥ï¼ˆç»Ÿä¸€ä½¿ç”¨ BaziInputProcessorï¼‰
        final_solar_date, final_solar_time, conversion_info = BaziInputProcessor.process_input(
            request.solar_date, request.solar_time,
            request.calendar_type or "solar",
            request.location, request.latitude, request.longitude
        )
        
        # 2. é€šè¿‡ç¼–æ’å±‚ç»Ÿä¸€è·å–æ•°æ®ï¼ˆåªè®¡ç®—ä¸€æ¬¡ï¼‰
        orchestrator_data = await BaziDataOrchestrator.fetch_data(
            final_solar_date, final_solar_time, request.gender,
            modules={
                'bazi': True,
                'wangshuai': True,
                'detail': True,
                'special_liunians': {'dayun_config': {'mode': 'count', 'count': 8}},
                'rules': {'types': ['shishen']}
            },
            preprocessed=True  # æ ‡è®°å·²å¤„ç†è¾“å…¥ï¼Œé¿å…é‡å¤å¤„ç†
        )
        
        # 3. ä» orchestrator_data ä¸­æå–æ‰€éœ€æ•°æ®ï¼ˆä¸å†è°ƒç”¨åº•å±‚æœåŠ¡ï¼‰
        bazi_data = orchestrator_data.get('bazi')
        detail_data = orchestrator_data.get('detail')
        special_liunians = orchestrator_data.get('special_liunians')
        
        # 4. å‡†å¤‡ LLM æç¤ºè¯ï¼ˆä½¿ç”¨å·²è·å–çš„æ•°æ®ï¼‰
        prompt = build_prompt(bazi_data, detail_data, special_liunians)
        
        # 5. è°ƒç”¨ LLM æµå¼è¾“å‡º
        async for chunk in llm_service.stream(prompt):
            yield chunk
            
    except Exception as e:
        logger.error(f"æµå¼æ¥å£é”™è¯¯: {e}")
        yield f"data: {json.dumps({'type': 'error', 'content': str(e)})}\n\n"
```

### âŒ ç¦æ­¢çš„åšæ³•

```python
# âŒ ç¦æ­¢ï¼šåœ¨æµå¼æ¥å£ä¸­ç›´æ¥è°ƒç”¨åº•å±‚æœåŠ¡
bazi_data = BaziService.calculate_bazi_full(solar_date, solar_time, gender)
detail_data = BaziDetailService.calculate_detail_full(solar_date, solar_time, gender)

# âŒ ç¦æ­¢ï¼šé‡å¤è®¡ç®—ï¼ˆè¿™ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼‰
# å¦‚æœ SpecialLiunianService å†…éƒ¨åˆè°ƒç”¨ BaziDetailServiceï¼Œå°±æ˜¯é‡å¤è®¡ç®—
special_liunians = await SpecialLiunianService.get_special_liunians_batch(
    solar_date, solar_time, gender, target_dayuns, count, current_time
    # å¦‚æœä¸ä¼  liunian_sequenceï¼Œå†…éƒ¨ä¼šé‡æ–°è®¡ç®— detail
)
```

---

## ä¸‹æ¸¸æœåŠ¡å¼€å‘è§„èŒƒ

### åŸåˆ™ï¼šæ¥æ”¶æ•°æ®ï¼Œä¸è¦é‡å¤è®¡ç®—

**æ­£ç¡®è®¾è®¡**ï¼š
```python
class SpecialLiunianService:
    @staticmethod
    async def get_special_liunians_batch(
        solar_date: str,
        solar_time: str,
        gender: str,
        target_dayuns: List[Dict],
        count: int,
        current_time: datetime,
        liunian_sequence: List[Dict] = None  # âœ… æ¥æ”¶å·²è®¡ç®—çš„æ•°æ®
    ):
        """
        è·å–ç‰¹æ®Šæµå¹´
        
        Args:
            liunian_sequence: å·²è®¡ç®—çš„æµå¹´åºåˆ—ï¼ˆç”± BaziDataOrchestrator ä¼ å…¥ï¼‰
                             å¦‚æœä¼ å…¥ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦‚æœä¸ä¼ ï¼Œæ‰è®¡ç®—
        """
        if liunian_sequence is None:
            # âš ï¸ é™çº§ï¼šåªæœ‰åœ¨æ²¡æœ‰ä¼ å…¥æ•°æ®æ—¶æ‰è®¡ç®—ï¼ˆåº”è¯¥é¿å…è¿™ç§æƒ…å†µï¼‰
            logger.warning("[SpecialLiunianService] liunian_sequence æœªä¼ å…¥ï¼Œé™çº§è®¡ç®—")
            detail_data = BaziDetailService.calculate_detail_full(...)
            liunian_sequence = detail_data.get('liunian_sequence', [])
        
        # ä½¿ç”¨ liunian_sequence å¤„ç†...
```

**é”™è¯¯è®¾è®¡**ï¼š
```python
class SpecialLiunianService:
    @staticmethod
    async def get_special_liunians_batch(...):
        # âŒ é”™è¯¯ï¼šæ— æ¡ä»¶é‡æ–°è®¡ç®—
        detail_data = BaziDetailService.calculate_detail_full(...)  # é‡å¤è®¡ç®—ï¼
        liunian_sequence = detail_data.get('liunian_sequence', [])
        # ...
```

---

## ç¼“å­˜ç­–ç•¥

### ç¼–æ’å±‚ç¼“å­˜ï¼ˆæ¨èï¼‰

`BaziDataOrchestrator.fetch_data()` å†…ç½®ç¼“å­˜æ”¯æŒï¼š

```python
# ç¼“å­˜é”®ç”Ÿæˆï¼ˆåŒ…å«æ‰€æœ‰å‚æ•°å’Œæ¨¡å—é…ç½®ï¼‰
cache_key = CacheKeyGenerator.generate_orchestrator_key(
    solar_date, solar_time, gender, modules,
    calendar_type, location, latitude, longitude
)

# ç¼“å­˜æŸ¥è¯¢
cached_result = cache.get(cache_key)
if cached_result:
    return cached_result  # ç›´æ¥è¿”å›ç¼“å­˜

# ... è®¡ç®— ...

# ç¼“å­˜å†™å…¥ï¼ˆTTL 24å°æ—¶ï¼‰
cache.set(cache_key, result)
```

### æœåŠ¡å±‚ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

åº•å±‚æœåŠ¡å¯ä»¥æœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œä½†ä¼˜å…ˆä½¿ç”¨ç¼–æ’å±‚ç¼“å­˜ï¼š

```python
# WangShuaiService æœ‰ Redis ç¼“å­˜
# ä½†å¦‚æœé€šè¿‡ BaziDataOrchestrator è°ƒç”¨ï¼Œç¼–æ’å±‚ç¼“å­˜ä¼šå‘½ä¸­ï¼Œä¸ä¼šèµ°åˆ°æœåŠ¡å±‚
```

---

## æ£€æŸ¥æ¸…å•

### æ–°å¢æµå¼æ¥å£æ£€æŸ¥æ¸…å•

- [ ] æ˜¯å¦é€šè¿‡ `BaziDataOrchestrator.fetch_data()` è·å–æ•°æ®ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ç›´æ¥è°ƒç”¨åº•å±‚æœåŠ¡çš„ä»£ç ï¼Ÿï¼ˆç¦æ­¢ï¼‰
- [ ] ä¸‹æ¸¸æœåŠ¡æ˜¯å¦æ¥æ”¶å·²è®¡ç®—æ•°æ®ä½œä¸ºå‚æ•°ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é‡å¤è®¡ç®—çš„æƒ…å†µï¼Ÿ

### ä¿®æ”¹ä¸‹æ¸¸æœåŠ¡æ£€æŸ¥æ¸…å•

- [ ] æ˜¯å¦æ·»åŠ äº†æ¥æ”¶ä¸Šæ¸¸æ•°æ®çš„å‚æ•°ï¼Ÿ
- [ ] æ˜¯å¦åœ¨æ²¡æœ‰æ•°æ®æ—¶æ‰é™çº§è®¡ç®—ï¼Ÿ
- [ ] æ˜¯å¦æœ‰æ—¥å¿—è®°å½•é™çº§æƒ…å†µï¼Ÿ

---

## è¿è§„ç¤ºä¾‹ä¸ä¿®å¤

### ç¤ºä¾‹ 1ï¼šSpecialLiunianService é‡å¤è®¡ç®—é—®é¢˜

**é—®é¢˜ä»£ç **ï¼š
```python
# server/services/special_liunian_service.py
async def get_special_liunians_batch(...):
    # âŒ æ— æ¡ä»¶è°ƒç”¨ calculate_detail_fullï¼Œå¯¼è‡´é‡å¤è®¡ç®—
    detail_data = BaziDetailService.calculate_detail_full(
        final_solar_date, final_solar_time, gender, current_time
    )
    liunian_sequence = detail_data.get('liunian_sequence', [])
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```python
async def get_special_liunians_batch(
    ...,
    liunian_sequence: List[Dict] = None  # âœ… æ–°å¢å‚æ•°
):
    if liunian_sequence is None:
        logger.warning("[SpecialLiunianService] liunian_sequence æœªä¼ å…¥ï¼Œé™çº§è®¡ç®—")
        detail_data = BaziDetailService.calculate_detail_full(...)
        liunian_sequence = detail_data.get('liunian_sequence', [])
    
    # ä½¿ç”¨ liunian_sequence...
```

**ç¼–æ’å±‚é…åˆä¿®æ”¹**ï¼š
```python
# server/orchestrators/bazi_data_orchestrator.py
# åœ¨è°ƒç”¨ SpecialLiunianService æ—¶ä¼ å…¥å·²è®¡ç®—çš„ liunian_sequence
special_liunians = await SpecialLiunianService.get_special_liunians_batch(
    final_solar_date, final_solar_time, gender,
    target_dayuns, special_count, current_time,
    liunian_sequence=liunian_sequence  # âœ… ä¼ å…¥å·²è®¡ç®—çš„æ•°æ®
)
```

---

## æµå¼æ¥å£è¿ç§»è®°å½•

### 2026-01-31 è¿ç§»å®Œæˆ

ä»¥ä¸‹æµå¼æ¥å£å·²è¿ç§»è‡³ BaziDataOrchestratorï¼š

| æ¥å£ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| health_analysis_stream_generator | server/api/v1/health_analysis.py | å·²æ”¹ä¸º BaziDataOrchestrator.fetch_data |
| smart_analyze_stream | server/api/v1/smart_fortune.py | å·²æ”¹ä¸º async _fetch_bazi_data_via_orchestrator è°ƒç”¨ç¼–æ’å±‚ |
| marriage_analysis_stream_generator | server/api/v1/marriage_analysis.py | å·²æ”¹ä¸º BaziDataOrchestrator.fetch_data |
| children_study_analysis_stream_generator | server/api/v1/children_study_analysis.py | å·²æ”¹ä¸º BaziDataOrchestrator.fetch_data |
| career_wealth_stream_generator | server/api/v1/career_wealth_analysis.py | å·²æ”¹ä¸º BaziDataOrchestrator.fetch_data |

**ä¸»è·¯å¾„ç»Ÿä¸€**ï¼šmarriage/health/children/career_wealth å››ä¸ªåˆ†æåœºæ™¯çš„æµå¼æ¥å£å‡é€šè¿‡ `server/utils/analysis_stream_helpers.get_modules_config(scene)` è·å– modules é…ç½®ï¼Œå†è°ƒç”¨ `BaziDataOrchestrator.fetch_data`ï¼Œå®ç°ä¸»è·¯å¾„ç»Ÿä¸€ã€‚

### FortuneContextService ç¼–æ’å±‚æ¥å…¥

**FortuneContextService**ï¼ˆæµå¹´å¤§è¿ä¸Šä¸‹æ–‡ï¼‰å·²æ¥å…¥ç¼–æ’å±‚ï¼š

- æ–°å¢ `fortune_context` æ¨¡å—ï¼š`modules={'fortune_context': {'intent_types': ['ALL'], 'target_years': [2025,2026,...]}}`
- ç¼–æ’å±‚ä¼ å…¥ `detail_result`ã€`wangshuai_result` ç»™ FortuneContextServiceï¼Œé¿å…é‡å¤è°ƒç”¨ `BaziDetailService.calculate_detail_full` å’Œ `WangShuaiAnalyzer.analyze`
- smart_fortune çš„ `_fetch_bazi_data_via_orchestrator` ä» `unified_data['fortune_context']` è·å–æ•°æ®ï¼Œä¸å†å•ç‹¬è°ƒç”¨ FortuneContextService

---

## æ–‡æ¡£ç‰ˆæœ¬

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|------|------|------|
| 1.0 | 2026-01-30 | åˆå§‹ç‰ˆæœ¬ï¼Œå®šä¹‰æ•°æ®ç¼–æ’æ¶æ„è§„èŒƒ |
| 1.1 | 2026-01-31 | è¡¥å……æµå¼æ¥å£è¿ç§»è®°å½•ï¼ˆhealth_analysisã€smart_analyze_streamï¼‰ |

---

## ç›¸å…³æ–‡æ¡£

- [æœåŠ¡æ²»ç†è§„èŒƒ](./06_æœåŠ¡æ²»ç†è§„èŒƒ.md)
