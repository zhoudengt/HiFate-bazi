# ğŸš€ HiFate-bazi å¼€å‘è€…æ‰‹å†Œ

## ä¸€ã€å¿«é€Ÿå¼€å§‹ï¼ˆ5åˆ†é’Ÿä¸Šæ‰‹ï¼‰

### 1.1 ç¯å¢ƒå‡†å¤‡

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/xxx/HiFate-bazi.git
cd HiFate-bazi

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv .venv
source .venv/bin/activate  # Mac/Linux
# .venv\Scripts\activate   # Windows

# 3. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 4. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¤åˆ¶æ¨¡æ¿ï¼‰
cp env.template .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å†™å¿…è¦é…ç½®
```

### 1.2 å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ä¸»æœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
python server/start.py
# æˆ–
./start.sh

# æœåŠ¡åœ°å€
# - Web æœåŠ¡: http://localhost:8001
# - API æ–‡æ¡£: http://localhost:8001/docs
```

### 1.3 éªŒè¯æœåŠ¡

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8001/api/v1/health

# æµ‹è¯• API
curl -X POST http://localhost:8001/api/v1/calendar/query \
  -H "Content-Type: application/json" \
  -d '{"date": "2025-12-11"}'
```

---

## äºŒã€å¼€å‘æ–°åŠŸèƒ½ï¼ˆ30åˆ†é’Ÿå®Œæˆï¼‰

### 2.1 å¼€å‘æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ–°åŠŸèƒ½å¼€å‘æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. åˆ›å»º API æ–‡ä»¶                                               â”‚
â”‚     â””â”€ server/api/v1/{name}_api.py                             â”‚
â”‚                                                                 â”‚
â”‚  2. åˆ›å»º Service æ–‡ä»¶                                           â”‚
â”‚     â””â”€ server/services/{name}_service.py                       â”‚
â”‚                                                                 â”‚
â”‚  3. æ³¨å†Œ gRPC ç«¯ç‚¹                                              â”‚
â”‚     â””â”€ server/api/grpc_gateway.py                              â”‚
â”‚                                                                 â”‚
â”‚  4. æ³¨å†Œè·¯ç”±                                                    â”‚
â”‚     â””â”€ server/main.py                                          â”‚
â”‚                                                                 â”‚
â”‚  5. ç¼–å†™æµ‹è¯•                                                    â”‚
â”‚     â””â”€ tests/unit/test_{name}.py                               â”‚
â”‚                                                                 â”‚
â”‚  6. æµ‹è¯•éªŒè¯                                                    â”‚
â”‚     â””â”€ pytest tests/unit/test_{name}.py                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ­¥éª¤è¯¦è§£

#### æ­¥éª¤ 1ï¼šåˆ›å»º API æ–‡ä»¶

**æ–‡ä»¶ä½ç½®ï¼š** `server/api/v1/{åŠŸèƒ½å}_api.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
{åŠŸèƒ½å} API
"""

from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import Optional, Dict, Any
import logging

from server.services.{åŠŸèƒ½å}_service import {ClassName}Service

logger = logging.getLogger(__name__)
router = APIRouter()

# ==================== æ•°æ®æ¨¡å‹ ====================

class {ClassName}Request(BaseModel):
    """è¯·æ±‚æ¨¡å‹"""
    param1: str = Field(..., description="å‚æ•°1è¯´æ˜")
    param2: Optional[str] = Field(None, description="å‚æ•°2è¯´æ˜")

class {ClassName}Response(BaseModel):
    """å“åº”æ¨¡å‹"""
    success: bool = Field(..., description="æ˜¯å¦æˆåŠŸ")
    data: Optional[Dict[str, Any]] = Field(None, description="è¿”å›æ•°æ®")
    error: Optional[str] = Field(None, description="é”™è¯¯ä¿¡æ¯")

# ==================== API è·¯ç”± ====================

@router.post("/{åŠŸèƒ½è·¯å¾„}/query", response_model={ClassName}Response, summary="åŠŸèƒ½æè¿°")
async def query_{åŠŸèƒ½å}(request: {ClassName}Request):
    """
    åŠŸèƒ½è¯¦ç»†è¯´æ˜
    
    Args:
        request: è¯·æ±‚å‚æ•°
        
    Returns:
        {ClassName}Response: å“åº”ç»“æœ
    """
    try:
        service = {ClassName}Service()
        result = service.process(request.param1, request.param2)
        return {ClassName}Response(success=True, data=result)
    except Exception as e:
        logger.error(f"å¤„ç†å¤±è´¥: {e}", exc_info=True)
        return {ClassName}Response(success=False, error=str(e))
```

#### æ­¥éª¤ 2ï¼šåˆ›å»º Service æ–‡ä»¶

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/{åŠŸèƒ½å}_service.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
{åŠŸèƒ½å} æœåŠ¡
"""

import logging
from typing import Optional, Dict, Any

logger = logging.getLogger(__name__)

class {ClassName}Service:
    """{åŠŸèƒ½å}æœåŠ¡ç±»"""
    
    def __init__(self):
        """åˆå§‹åŒ–æœåŠ¡"""
        pass
    
    def process(self, param1: str, param2: Optional[str] = None) -> Dict[str, Any]:
        """
        å¤„ç†ä¸šåŠ¡é€»è¾‘
        
        Args:
            param1: å‚æ•°1
            param2: å‚æ•°2ï¼ˆå¯é€‰ï¼‰
            
        Returns:
            å¤„ç†ç»“æœå­—å…¸
        """
        try:
            # TODO: å®ç°ä¸šåŠ¡é€»è¾‘
            result = {
                "param1": param1,
                "param2": param2
            }
            return result
        except Exception as e:
            logger.error(f"å¤„ç†å¤±è´¥: {e}", exc_info=True)
            raise
```

#### æ­¥éª¤ 3ï¼šæ³¨å†Œ gRPC ç«¯ç‚¹

**æ–‡ä»¶ä½ç½®ï¼š** `server/api/grpc_gateway.py`

åœ¨æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```python
# åœ¨ import éƒ¨åˆ†æ·»åŠ 
from server.api.v1.{åŠŸèƒ½å}_api import {ClassName}Request, query_{åŠŸèƒ½å}

# åœ¨ SUPPORTED_ENDPOINTS æ³¨å†Œä¹‹åæ·»åŠ 
@_register("/{åŠŸèƒ½è·¯å¾„}/query")
async def _handle_{åŠŸèƒ½å}_query(payload: Dict[str, Any]):
    request_model = {ClassName}Request(**payload)
    return await query_{åŠŸèƒ½å}(request_model)
```

#### æ­¥éª¤ 4ï¼šæ³¨å†Œè·¯ç”±

**æ–‡ä»¶ä½ç½®ï¼š** `server/main.py`

åœ¨æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```python
# åœ¨ import éƒ¨åˆ†æ·»åŠ 
from server.api.v1.{åŠŸèƒ½å}_api import router as {åŠŸèƒ½å}_router

# åœ¨è·¯ç”±æ³¨å†Œéƒ¨åˆ†æ·»åŠ 
app.include_router({åŠŸèƒ½å}_router, prefix="/api/v1", tags=["{åŠŸèƒ½å}"])
logger.info("âœ“ {åŠŸèƒ½å}è·¯ç”±å·²æ³¨å†Œ")
```

#### æ­¥éª¤ 5ï¼šç¼–å†™æµ‹è¯•

**æ–‡ä»¶ä½ç½®ï¼š** `tests/unit/test_{åŠŸèƒ½å}.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
{åŠŸèƒ½å} å•å…ƒæµ‹è¯•
"""

import pytest
from server.services.{åŠŸèƒ½å}_service import {ClassName}Service

class Test{ClassName}Service:
    """{ClassName}Service æµ‹è¯•ç±»"""
    
    def setup_method(self):
        """æµ‹è¯•å‰ç½®"""
        self.service = {ClassName}Service()
    
    def test_process_success(self):
        """æµ‹è¯•æ­£å¸¸å¤„ç†"""
        # Given
        param1 = "test_value"
        
        # When
        result = self.service.process(param1)
        
        # Then
        assert result is not None
        assert result["param1"] == param1
    
    def test_process_with_optional_param(self):
        """æµ‹è¯•å¸¦å¯é€‰å‚æ•°"""
        # Given
        param1 = "test_value"
        param2 = "optional_value"
        
        # When
        result = self.service.process(param1, param2)
        
        # Then
        assert result["param2"] == param2
```

#### æ­¥éª¤ 6ï¼šè¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œå•ä¸ªæµ‹è¯•
pytest tests/unit/test_{åŠŸèƒ½å}.py -v

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/ -v

# æŸ¥çœ‹è¦†ç›–ç‡
pytest tests/ --cov=server --cov-report=html
```

---

## ä¸‰ã€ä»£ç ç”Ÿæˆå™¨ï¼ˆæ¨èï¼‰

ä½¿ç”¨ä»£ç ç”Ÿæˆå™¨å¿«é€Ÿåˆ›å»ºæ–°åŠŸèƒ½ï¼š

```bash
# ç”Ÿæˆæ–°åŠŸèƒ½ï¼ˆAPI + Service + Testï¼‰
python scripts/generate.py api --name=feature_name --desc="åŠŸèƒ½æè¿°"

# ç¤ºä¾‹
python scripts/generate.py api --name=calendar --desc="ä¸‡å¹´å†æŸ¥è¯¢"
```

ç”Ÿæˆçš„æ–‡ä»¶ï¼š
```
âœ… server/api/v1/calendar_api.py
âœ… server/services/calendar_service.py
âœ… tests/unit/test_calendar.py
ğŸ“ è¯·æ‰‹åŠ¨åœ¨ grpc_gateway.py å’Œ main.py ä¸­æ³¨å†Œè·¯ç”±
```

---

## å››ã€å¼€å‘è§„èŒƒé€ŸæŸ¥

### 4.1 æ–‡ä»¶å‘½å

| ç±»å‹ | æ ¼å¼ | ç¤ºä¾‹ |
|------|------|------|
| API | `{name}_api.py` | `calendar_api.py` |
| Service | `{name}_service.py` | `calendar_service.py` |
| æµ‹è¯• | `test_{name}.py` | `test_calendar.py` |

### 4.2 ç±»å‘½å

| ç±»å‹ | æ ¼å¼ | ç¤ºä¾‹ |
|------|------|------|
| è¯·æ±‚æ¨¡å‹ | `{Name}Request` | `CalendarRequest` |
| å“åº”æ¨¡å‹ | `{Name}Response` | `CalendarResponse` |
| æœåŠ¡ç±» | `{Name}Service` | `CalendarService` |

### 4.3 API è·¯å¾„

| è§„èŒƒ | ç¤ºä¾‹ |
|------|------|
| å°å†™+æ–œæ  | `/calendar/query` |
| åŠ¨ä½œ+åè¯ | `/bazi/calculate` |

---

## äº”ã€å¸¸ç”¨å‘½ä»¤

### 5.1 å¼€å‘å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
./start.sh

# åœæ­¢æœåŠ¡
./stop.sh

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/server_8001.log

# è¿è¡Œæµ‹è¯•
pytest tests/ -v

# æ£€æŸ¥ä»£ç é£æ ¼
flake8 server/ --max-line-length=120
```

### 5.2 Git å‘½ä»¤

```bash
# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/calendar-api

# æäº¤ä»£ç 
git add .
git commit -m "[æ–°å¢] ä¸‡å¹´å†æŸ¥è¯¢åŠŸèƒ½"

# æ¨é€åˆ†æ”¯
git push origin feature/calendar-api
```

### 5.3 æ•°æ®åº“å‘½ä»¤

```bash
# è¿æ¥æ•°æ®åº“
mysql -h localhost -u root -p hifate_bazi

# è¿è¡Œè¿ç§»
python scripts/migration/run_migration.py
```

---

## å…­ã€è°ƒè¯•æŠ€å·§

### 6.1 æŸ¥çœ‹è¯·æ±‚æ—¥å¿—

```bash
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
tail -f logs/server_8001.log

# æœç´¢ç‰¹å®šå…³é”®è¯
grep "calendar" logs/server_8001.log
```

### 6.2 API è°ƒè¯•

```bash
# ä½¿ç”¨ curl æµ‹è¯•
curl -X POST http://localhost:8001/api/v1/calendar/query \
  -H "Content-Type: application/json" \
  -d '{"date": "2025-12-11"}'

# ä½¿ç”¨ Swagger UI
# è®¿é—® http://localhost:8001/docs
```

### 6.3 æ–­ç‚¹è°ƒè¯•

```python
# åœ¨ä»£ç ä¸­æ·»åŠ æ–­ç‚¹
import pdb; pdb.set_trace()

# æˆ–ä½¿ç”¨ IDE çš„è°ƒè¯•åŠŸèƒ½
```

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### Q1: æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8001

# æ€æ­»å ç”¨è¿›ç¨‹
kill -9 <PID>
```

### Q2: æ¨¡å—å¯¼å…¥å¤±è´¥

```bash
# ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
cd /path/to/HiFate-bazi

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# é‡æ–°å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### Q3: æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ .env é…ç½®
cat .env | grep MYSQL

# æµ‹è¯•è¿æ¥
mysql -h localhost -u root -p
```

---

## å…«ã€å¼€å‘æ£€æŸ¥æ¸…å•

æ–°åŠŸèƒ½å¼€å‘å®Œæˆå‰ï¼Œæ£€æŸ¥ä»¥ä¸‹äº‹é¡¹ï¼š

- [ ] API æ–‡ä»¶å·²åˆ›å»ºï¼ˆ`server/api/v1/`ï¼‰
- [ ] Service æ–‡ä»¶å·²åˆ›å»ºï¼ˆ`server/services/`ï¼‰
- [ ] gRPC ç«¯ç‚¹å·²æ³¨å†Œï¼ˆ`grpc_gateway.py`ï¼‰
- [ ] è·¯ç”±å·²æ³¨å†Œï¼ˆ`main.py`ï¼‰
- [ ] å•å…ƒæµ‹è¯•å·²ç¼–å†™ï¼ˆ`tests/unit/`ï¼‰
- [ ] æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] ä»£ç é£æ ¼æ£€æŸ¥é€šè¿‡
- [ ] æ–‡æ¡£å·²æ›´æ–°ï¼ˆå¦‚éœ€è¦ï¼‰

---

## ä¹ã€è·å–å¸®åŠ©

- ğŸ“– è§„èŒƒæ–‡æ¡£ï¼š`standards/` ç›®å½•
- ğŸ“‹ å¼€å‘è§„èŒƒï¼š`standards/` ç›®å½•
- ğŸ’¬ æŠ€æœ¯æ”¯æŒï¼šè”ç³»é¡¹ç›®è´Ÿè´£äºº
