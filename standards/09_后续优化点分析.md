# 后续优化点分析

本文档基于安全渐进式重构完成后的代码扫描，列出仍可优化的点。按优先级与风险分类。

---

## 一、数据编排层尚未覆盖的入口

### 1.1 API 层：仍直接调底层（未走编排层）

| 位置 | 说明 | 建议 |
|------|------|------|
| `server/api/v1/marriage_analysis.py` 第 891–945 行 | 函数 `extract_marriage_analysis_data` 内直接并行调用 `BaziService.calculate_bazi_full`、`WangShuaiService.calculate_wangshuai`、`BaziDetailService.calculate_detail_full` | 改为通过 `BaziDataOrchestrator.fetch_data(..., modules=get_modules_config('marriage'))` 获取数据，与流式主路径一致 |
| `server/api/v1/rizhu_liujiazi.py` 第 88–94 行 | 直接调用 `BaziService.calculate_bazi_full` | 增加双轨：环境变量 `USE_ORCHESTRATOR_RIZHU_LIUJIAZI=true` 时走 `fetch_data(modules={'bazi': True})`，从结果中取 bazi 再算日柱 |

**影响**：上述路径在编排开关为 true 时仍会重复计算，无法享受编排层缓存与统一入口。

---

### 1.2 服务层：仍直接调底层（被多处调用）

以下服务在内部直接调用 `BaziService` / `BaziDetailService` / `WangShuaiService`，未接收“已编排数据”入参：

| 文件 | 直接调用位置 | 说明 |
|------|--------------|------|
| `server/services/daily_fortune_service.py` | 约 103、119 行 | 今日运势：内部算 bazi + detail |
| `server/services/monthly_fortune_service.py` | 约 64、80 行 | 本月运势：内部算 bazi + detail |
| `server/services/bazi_display_service.py` | 约 192、778、824 行 | 八字展示：内部算 bazi + detail |
| `server/services/daily_fortune_calendar_service.py` | 约 430、956 行 | 运势日历：内部算 bazi + wangshuai |
| `server/services/bazi_ai_service.py` | 约 51 行 | AI 分析：内部算 bazi |
| `server/services/llm_generate_service.py` | 约 191 行 | LLM 生成：内部算 bazi |
| `server/services/chat_service.py` | 约 139 行 | 对话：内部算 bazi |
| `server/services/wuxing_proportion_service.py` | 约 42 行 | 五行占比：内部算 bazi |
| `server/services/unified_bazi_data_provider.py` | 约 137、144 行 | 统一数据提供：内部算 wangshuai + detail |

**建议（需按调用链逐步做）**：

- 若调用方已通过编排层拿到 `bazi`/`detail`/`wangshuai`，则改为“入参传入已算好的数据”，服务内仅做业务逻辑。
- 若调用方尚未走编排（如独立 API、定时任务），可保留“无入参时内部计算”的降级路径，并打日志，便于后续统一改为编排层调用。

---

## 二、错误处理仍未统一

### 2.1 现状

- 已使用 `@api_error_handler` 的接口：仅 `server/api/v1/wangshuai.py`。
- 其余约 25 个 API 文件仍为手写 `try/except ValueError`、`except Exception` + `HTTPException`，约 50+ 处重复模式。

### 2.2 建议

- 在**不改变对外状态码与错误信息**的前提下，逐步给接口加上 `@api_error_handler`，并删除对应的手写 try/except。
- 优先改：与已改文件类似的分析类、八字类接口（如 `bazi.py`、`rizhu_liujiazi.py`、`formula_analysis.py` 等）。

---

## 三、配置与工具函数略重复（低优先级）

### 3.1 两套“场景 → modules”配置

- `server/utils/analysis_stream_helpers.py`：`STREAM_ANALYSIS_MODULES` + `get_modules_config(scene)`，用于流式分析（marriage/health/children/career_wealth），含 special_liunians、rules 等细配置。
- `server/utils/analysis_api_helper.py`：`SCENE_MODULES_CONFIG` + `get_modules_config(scene)`，结构更简。

当前流式分析均使用 `analysis_stream_helpers`，`analysis_api_helper` 为后续扩展预留。建议：

- 在文档或注释中说明两处职责差异（流式详细配置 vs 简单场景配置），避免误用。
- 若未来不再需要简单版，可考虑让 `analysis_api_helper` 直接复用或包装 `analysis_stream_helpers`，减少重复。

---

## 四、编排层内部与降级（已符合规范）

以下为编排内部或明确降级，无需改为“禁止直接调用”：

- `server/orchestrators/bazi_data_orchestrator.py`：编排层内部调用 BaziService / WangShuaiService / BaziDetailService，符合规范。
- `server/orchestrators/bazi_data_service.py`：同上，编排内部。
- `server/orchestrators/fortune_context_service.py` 约 433 行：降级时调用 `BaziDetailService.calculate_detail_full`，可保留，建议日志中标注为降级。
- `server/services/special_liunian_service.py` 约 113 行：在未传入 `liunian_sequence` 时降级计算，符合“接收已计算数据优先”的设计。

---

## 五、优化项汇总（按优先级）

| 优先级 | 项 | 位置/范围 | 风险 | 说明 |
|--------|----|-----------|------|------|
| 高 | 婚姻分析数据提取走编排 | `marriage_analysis.py` 的 `extract_marriage_analysis_data` | 低 | 与流式主路径一致，仅改数据来源，对外接口不变 |
| 高 | 日柱六十甲子双轨编排 | `rizhu_liujiazi.py` | 低 | 与现有 bazi/wangshuai 双轨方式一致，默认关闭 |
| 中 | 统一错误处理装饰器 | 约 25 个 API 文件 | 低 | 逐文件替换 try/except，保证状态码与 detail 不变 |
| 中 | 运势/展示等服务接收编排结果 | daily_fortune、monthly_fortune、bazi_display、daily_fortune_calendar 等 | 中 | 需梳理调用链，先改“调用方已用编排”的入口 |
| 低 | 场景配置文档与去重 | analysis_stream_helpers vs analysis_api_helper | 低 | 文档说明 + 可选合并或委托 |

---

## 六、不建议或暂缓的改动

- **gRPC 网关注册**：按当前规划不做大范围变更，仅在有新接口时按规范注册。
- **合并 server/engines/rule_engine 与 services/fortune_rule/rule_engine**：职责不同（八字规则 vs 手相面相），保持分离。
- **一次性替换所有服务的内部计算为“只接收编排结果”**：易影响未走编排的入口，建议按调用链逐步改为“入参优先 + 降级计算”。

---

**文档版本**：1.0  
**更新日期**：2026-01-31  
**关联**：`standards/08_数据编排架构规范.md`、安全渐进式重构计划
