# ğŸ§ª HiFate-bazi æµ‹è¯•è§„èŒƒ

## ä¸€ã€æµ‹è¯•é‡‘å­—å¡”

```
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   E2E æµ‹è¯•     â”‚  10%  - ç«¯åˆ°ç«¯ç”¨æˆ·åœºæ™¯
            â”‚  (Selenium)    â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚   é›†æˆæµ‹è¯•     â”‚  20%  - æœåŠ¡é—´äº¤äº’
            â”‚  (pytest)      â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚   å•å…ƒæµ‹è¯•     â”‚  70%  - å‡½æ•°/ç±»æµ‹è¯•
            â”‚  (pytest)      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›®æ ‡è¦†ç›–ç‡ï¼š> 80%
```

---

## äºŒã€æµ‹è¯•ç›®å½•ç»“æ„

```
tests/
â”œâ”€â”€ conftest.py              # pytest å…¨å±€é…ç½®
â”œâ”€â”€ fixtures/                # æµ‹è¯•å¤¹å…·
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ sample_data.py       # æµ‹è¯•æ•°æ®
â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_bazi_service.py
â”‚   â””â”€â”€ test_calendar_service.py
â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_api_bazi.py
â”œâ”€â”€ api/                     # API æµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_calendar_api.py
â”œâ”€â”€ features/                # åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_payment.py
â””â”€â”€ scripts/                 # æµ‹è¯•è„šæœ¬
    â””â”€â”€ test_payment_complete.sh
```

---

## ä¸‰ã€æµ‹è¯•æ–‡ä»¶å‘½åè§„èŒƒ

| ç±»å‹ | å‘½åæ ¼å¼ | ç¤ºä¾‹ |
|------|----------|------|
| å•å…ƒæµ‹è¯• | `test_{module}.py` | `test_calendar_service.py` |
| é›†æˆæµ‹è¯• | `test_{feature}_integration.py` | `test_api_bazi.py` |
| API æµ‹è¯• | `test_{api_name}_api.py` | `test_calendar_api.py` |
| åŠŸèƒ½æµ‹è¯• | `test_{feature}.py` | `test_payment.py` |

---

## å››ã€æµ‹è¯•ä»£ç è§„èŒƒ

### 4.1 æµ‹è¯•ç±»ç»“æ„

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
{æ¨¡å—å} æµ‹è¯•

æµ‹è¯•èŒƒå›´ï¼š
- åŠŸèƒ½ç‚¹1
- åŠŸèƒ½ç‚¹2
"""

import pytest
from unittest.mock import Mock, patch, MagicMock
from server.services.calendar_api_service import CalendarAPIService


class TestCalendarAPIService:
    """CalendarAPIService æµ‹è¯•ç±»"""
    
    # ==================== æµ‹è¯•å‰ç½®/åç½® ====================
    
    def setup_method(self):
        """æ¯ä¸ªæµ‹è¯•æ–¹æ³•å‰æ‰§è¡Œ"""
        self.service = CalendarAPIService()
    
    def teardown_method(self):
        """æ¯ä¸ªæµ‹è¯•æ–¹æ³•åæ‰§è¡Œ"""
        pass
    
    @pytest.fixture(autouse=True)
    def setup_fixtures(self):
        """è‡ªåŠ¨ä½¿ç”¨çš„ fixture"""
        pass
    
    # ==================== å•å…ƒæµ‹è¯• ====================
    
    def test_get_calendar_with_valid_date(self):
        """æµ‹è¯•ï¼šæœ‰æ•ˆæ—¥æœŸæŸ¥è¯¢"""
        # Given: å‡†å¤‡æµ‹è¯•æ•°æ®
        date = "2025-12-11"
        
        # When: æ‰§è¡Œè¢«æµ‹æ–¹æ³•
        result = self.service.get_calendar(date)
        
        # Then: éªŒè¯ç»“æœ
        assert result["success"] == True
        assert result["lunar_date"] is not None
        assert "ganzhi" in result
    
    def test_get_calendar_with_invalid_date(self):
        """æµ‹è¯•ï¼šæ— æ•ˆæ—¥æœŸæ ¼å¼"""
        # Given
        invalid_date = "invalid-date"
        
        # When
        result = self.service.get_calendar(invalid_date)
        
        # Then
        assert result["success"] == False
        assert "error" in result
    
    # ==================== è¾¹ç•Œæµ‹è¯• ====================
    
    def test_get_calendar_with_none_date(self):
        """æµ‹è¯•ï¼šæ—¥æœŸä¸ºç©ºï¼ˆä½¿ç”¨ä»Šå¤©ï¼‰"""
        # When
        result = self.service.get_calendar(None)
        
        # Then
        assert result["success"] == True
    
    def test_get_calendar_with_empty_string(self):
        """æµ‹è¯•ï¼šç©ºå­—ç¬¦ä¸²"""
        # When
        result = self.service.get_calendar("")
        
        # Then
        # æ ¹æ®ä¸šåŠ¡é€»è¾‘ï¼Œç©ºå­—ç¬¦ä¸²å¯èƒ½ä½¿ç”¨ä»Šå¤©æˆ–æŠ¥é”™
        assert result is not None
    
    # ==================== Mock æµ‹è¯• ====================
    
    @patch('server.services.calendar_api_service.requests.get')
    def test_api_call_failure(self, mock_get):
        """æµ‹è¯•ï¼šç¬¬ä¸‰æ–¹ API è°ƒç”¨å¤±è´¥"""
        # Given: Mock API è¿”å›é”™è¯¯
        mock_get.side_effect = Exception("API Error")
        
        # When: è°ƒç”¨æœåŠ¡
        result = self.service.get_calendar("2025-12-11")
        
        # Then: åº”è¯¥ä½¿ç”¨æœ¬åœ°è®¡ç®—
        assert result["success"] == True
        assert result["provider"] == "local"
```

### 4.2 æµ‹è¯•æ–¹æ³•å‘½å

```python
# å‘½åæ ¼å¼ï¼štest_{è¢«æµ‹æ–¹æ³•}_{åœºæ™¯}_{é¢„æœŸç»“æœ}

# âœ… æ­£ç¡®ç¤ºä¾‹
def test_get_calendar_with_valid_date_returns_success(self):
    pass

def test_get_calendar_with_invalid_date_returns_error(self):
    pass

def test_calculate_bazi_with_leap_month_handles_correctly(self):
    pass

# âŒ é”™è¯¯ç¤ºä¾‹
def test1(self):  # ä¸æ˜ç¡®
    pass

def testGetCalendar(self):  # åº”è¯¥ç”¨ä¸‹åˆ’çº¿
    pass
```

### 4.3 Given-When-Then æ¨¡å¼

```python
def test_get_calendar_with_valid_date(self):
    """æµ‹è¯•ï¼šæœ‰æ•ˆæ—¥æœŸæŸ¥è¯¢è¿”å›å®Œæ•´æ•°æ®"""
    
    # Given: å‡†å¤‡æµ‹è¯•æ•°æ®å’Œä¾èµ–
    date = "2025-12-11"
    expected_lunar = "å†œå†åæœˆå»¿äºŒ"
    
    # When: æ‰§è¡Œè¢«æµ‹ä»£ç 
    result = self.service.get_calendar(date)
    
    # Then: éªŒè¯ç»“æœ
    assert result["success"] == True
    assert result["lunar_date"] == expected_lunar
    assert result["ganzhi"]["year"] == "ä¹™å·³"
```

---

## äº”ã€Pytest é…ç½®

### 5.1 pytest.ini é…ç½®

**æ–‡ä»¶ä½ç½®ï¼š** é¡¹ç›®æ ¹ç›®å½• `pytest.ini`

```ini
[pytest]
# æµ‹è¯•ç›®å½•
testpaths = tests

# æµ‹è¯•æ–‡ä»¶åŒ¹é…
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# é»˜è®¤å‚æ•°
addopts = -v --tb=short --strict-markers

# æ ‡è®°å®šä¹‰
markers =
    slow: æ ‡è®°ä¸ºæ…¢é€Ÿæµ‹è¯•
    integration: é›†æˆæµ‹è¯•
    api: API æµ‹è¯•
    unit: å•å…ƒæµ‹è¯•

# å¿½ç•¥è­¦å‘Š
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning

# å¼‚æ­¥æµ‹è¯•æ”¯æŒ
asyncio_mode = auto
```

### 5.2 conftest.py é…ç½®

**æ–‡ä»¶ä½ç½®ï¼š** `tests/conftest.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Pytest å…¨å±€é…ç½®
"""

import pytest
import sys
import os
from typing import Generator

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, project_root)


# ==================== Fixtures ====================

@pytest.fixture(scope="session")
def app():
    """åˆ›å»º FastAPI åº”ç”¨å®ä¾‹"""
    from server.main import app
    return app


@pytest.fixture(scope="session")
def client(app):
    """åˆ›å»ºæµ‹è¯•å®¢æˆ·ç«¯"""
    from fastapi.testclient import TestClient
    return TestClient(app)


@pytest.fixture(scope="function")
def sample_date():
    """ç¤ºä¾‹æ—¥æœŸ"""
    return "2025-12-11"


@pytest.fixture(scope="function")
def sample_bazi_request():
    """ç¤ºä¾‹å…«å­—è¯·æ±‚"""
    return {
        "solar_date": "1990-01-15",
        "solar_time": "12:00",
        "gender": "male"
    }


@pytest.fixture(scope="function")
def mock_db_connection():
    """Mock æ•°æ®åº“è¿æ¥"""
    from unittest.mock import MagicMock
    mock_conn = MagicMock()
    yield mock_conn
    mock_conn.close()


# ==================== Hooks ====================

def pytest_configure(config):
    """pytest é…ç½®é’©å­"""
    # æ·»åŠ è‡ªå®šä¹‰æ ‡è®°
    config.addinivalue_line("markers", "slow: æ…¢é€Ÿæµ‹è¯•")
    config.addinivalue_line("markers", "integration: é›†æˆæµ‹è¯•")


def pytest_collection_modifyitems(config, items):
    """ä¿®æ”¹æµ‹è¯•æ”¶é›†"""
    # ä¸ºé›†æˆæµ‹è¯•æ·»åŠ æ ‡è®°
    for item in items:
        if "integration" in item.nodeid:
            item.add_marker(pytest.mark.integration)
```

---

## å…­ã€æµ‹è¯•æ•°æ®ç®¡ç†

### 6.1 æµ‹è¯•æ•°æ®æ–‡ä»¶

**æ–‡ä»¶ä½ç½®ï¼š** `tests/fixtures/sample_data.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ‹è¯•æ•°æ®
"""

# æœ‰æ•ˆæ—¥æœŸæ•°æ®
VALID_DATES = [
    "2025-12-11",
    "2024-01-01",
    "2000-06-15",
]

# æ— æ•ˆæ—¥æœŸæ•°æ®
INVALID_DATES = [
    "invalid",
    "2025-13-01",  # æœˆä»½æ— æ•ˆ
    "2025-02-30",  # æ—¥æœŸæ— æ•ˆ
]

# å…«å­—è¯·æ±‚æ•°æ®
BAZI_REQUESTS = [
    {
        "solar_date": "1990-01-15",
        "solar_time": "12:00",
        "gender": "male",
        "expected": {
            "year_ganzhi": "å·±å·³",
            "month_ganzhi": "ä¸ä¸‘"
        }
    },
    {
        "solar_date": "2000-06-15",
        "solar_time": "08:30",
        "gender": "female",
        "expected": {
            "year_ganzhi": "åºšè¾°"
        }
    }
]

# ä¸‡å¹´å†æœŸæœ›æ•°æ®
CALENDAR_EXPECTED = {
    "2025-12-11": {
        "lunar_date": "å†œå†åæœˆå»¿äºŒ",
        "ganzhi": {
            "year": "ä¹™å·³",
            "month": "æˆŠå­",
            "day": "ç”²å¯…"
        },
        "shengxiao": "è›‡",
        "xingzuo": "å°„æ‰‹"
    }
}
```

### 6.2 å‚æ•°åŒ–æµ‹è¯•

```python
import pytest
from tests.fixtures.sample_data import VALID_DATES, INVALID_DATES, CALENDAR_EXPECTED

class TestCalendarService:
    
    @pytest.mark.parametrize("date", VALID_DATES)
    def test_get_calendar_with_valid_dates(self, date):
        """æµ‹è¯•å¤šä¸ªæœ‰æ•ˆæ—¥æœŸ"""
        result = self.service.get_calendar(date)
        assert result["success"] == True
    
    @pytest.mark.parametrize("date", INVALID_DATES)
    def test_get_calendar_with_invalid_dates(self, date):
        """æµ‹è¯•å¤šä¸ªæ— æ•ˆæ—¥æœŸ"""
        result = self.service.get_calendar(date)
        assert result["success"] == False
    
    @pytest.mark.parametrize("date,expected", [
        ("2025-12-11", CALENDAR_EXPECTED["2025-12-11"]),
    ])
    def test_get_calendar_with_expected_data(self, date, expected):
        """æµ‹è¯•é¢„æœŸæ•°æ®åŒ¹é…"""
        result = self.service.get_calendar(date)
        assert result["lunar_date"] == expected["lunar_date"]
        assert result["shengxiao"] == expected["shengxiao"]
```

---

## ä¸ƒã€è¿è¡Œæµ‹è¯•

### 7.1 å¸¸ç”¨å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/unit/ -v

# è¿è¡Œç‰¹å®šæ–‡ä»¶
pytest tests/unit/test_calendar_service.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
pytest tests/unit/test_calendar_service.py::TestCalendarService::test_get_calendar_with_valid_date -v

# è¿è¡Œå¸¦æ ‡è®°çš„æµ‹è¯•
pytest -m "unit" -v
pytest -m "not slow" -v

# æŸ¥çœ‹è¦†ç›–ç‡
pytest --cov=server --cov-report=html

# å¹¶è¡Œè¿è¡Œ
pytest -n auto

# å¤±è´¥åé‡è¯•
pytest --lf  # åªè¿è¡Œä¸Šæ¬¡å¤±è´¥çš„æµ‹è¯•
pytest --ff  # å…ˆè¿è¡Œå¤±è´¥çš„æµ‹è¯•
```

### 7.2 CI/CD é›†æˆ

```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: Run tests
        run: |
          pytest tests/ -v --cov=server --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

---

## å…«ã€æµ‹è¯•æ£€æŸ¥æ¸…å•

æ¯ä¸ªåŠŸèƒ½å¿…é¡»åŒ…å«ä»¥ä¸‹æµ‹è¯•ï¼š

### 8.1 å•å…ƒæµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] æ­£å¸¸æµç¨‹æµ‹è¯•ï¼ˆhappy pathï¼‰
- [ ] è¾¹ç•Œæ¡ä»¶æµ‹è¯•ï¼ˆç©ºå€¼ã€æç«¯å€¼ï¼‰
- [ ] å¼‚å¸¸å¤„ç†æµ‹è¯•ï¼ˆé”™è¯¯è¾“å…¥ã€å¼‚å¸¸æƒ…å†µï¼‰
- [ ] Mock å¤–éƒ¨ä¾èµ–

### 8.2 API æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] æˆåŠŸå“åº”æµ‹è¯•ï¼ˆ200ï¼‰
- [ ] å‚æ•°éªŒè¯æµ‹è¯•ï¼ˆ400ï¼‰
- [ ] æœªæˆæƒæµ‹è¯•ï¼ˆ401ï¼Œå¦‚é€‚ç”¨ï¼‰
- [ ] èµ„æºä¸å­˜åœ¨æµ‹è¯•ï¼ˆ404ï¼Œå¦‚é€‚ç”¨ï¼‰
- [ ] æœåŠ¡å™¨é”™è¯¯æµ‹è¯•ï¼ˆ500ï¼‰

### 8.3 é›†æˆæµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] æœåŠ¡é—´è°ƒç”¨æµ‹è¯•
- [ ] æ•°æ®åº“äº¤äº’æµ‹è¯•
- [ ] ç¼“å­˜äº¤äº’æµ‹è¯•

---

## ä¹ã€Mock ä½¿ç”¨æŒ‡å—

### 9.1 Mock å¤–éƒ¨ API

```python
from unittest.mock import patch, Mock

@patch('requests.get')
def test_external_api_call(self, mock_get):
    """Mock å¤–éƒ¨ API è°ƒç”¨"""
    # è®¾ç½® Mock è¿”å›å€¼
    mock_response = Mock()
    mock_response.status_code = 200
    mock_response.json.return_value = {"data": "test"}
    mock_get.return_value = mock_response
    
    # æ‰§è¡Œæµ‹è¯•
    result = self.service.call_external_api()
    
    # éªŒè¯
    assert result["data"] == "test"
    mock_get.assert_called_once()
```

### 9.2 Mock æ•°æ®åº“

```python
@patch('server.config.mysql_config.get_mysql_connection')
def test_database_query(self, mock_conn):
    """Mock æ•°æ®åº“æŸ¥è¯¢"""
    # è®¾ç½® Mock
    mock_cursor = Mock()
    mock_cursor.fetchall.return_value = [{"id": 1, "name": "test"}]
    mock_conn.return_value.__enter__.return_value.cursor.return_value.__enter__.return_value = mock_cursor
    
    # æ‰§è¡Œæµ‹è¯•
    result = self.service.query_data()
    
    # éªŒè¯
    assert len(result) == 1
```

---

## åã€è¦†ç›–ç‡è¦æ±‚

| æ¨¡å— | æœ€ä½è¦†ç›–ç‡ | è¯´æ˜ |
|------|-----------|------|
| `server/services/` | 80% | ä¸šåŠ¡é€»è¾‘æ ¸å¿ƒ |
| `server/api/` | 70% | API è·¯ç”± |
| `src/analyzers/` | 80% | åˆ†æå™¨ |
| `src/bazi_core/` | 90% | æ ¸å¿ƒè®¡ç®— |
| æ•´ä½“é¡¹ç›® | 70% | å…¨å±€ç›®æ ‡ |

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=server --cov=src --cov-report=html

# æŸ¥çœ‹æŠ¥å‘Š
open htmlcov/index.html
```
