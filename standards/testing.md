# æµ‹è¯•å¼€å‘è¯¦ç»†è§„èŒƒ

> æœ¬æ–‡æ¡£ä» `.cursorrules` æå–ï¼ŒåŒ…å«æµ‹è¯•å¼€å‘çš„å®Œæ•´è§„èŒƒã€‚è¯¦è§ `.cursorrules` æ ¸å¿ƒè§„èŒƒç« èŠ‚ã€‚

## æ ¸å¿ƒåŸåˆ™

> **æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»åŒæ­¥ç¼–å†™æµ‹è¯•æ¡ˆä¾‹ï¼Œæµ‹è¯•è¦†ç›–ç‡å¿…é¡»è¾¾åˆ° 50% ä»¥ä¸Šã€‚**

### ğŸ“‹ æµ‹è¯•è¦æ±‚

## 1. æ–°å¢åŠŸèƒ½å¿…é¡»åŒæ­¥ç¼–å†™æµ‹è¯•

**è¦æ±‚**ï¼š
- âœ… æ–°å¢ API ç«¯ç‚¹å¿…é¡»ç¼–å†™å¯¹åº”çš„æµ‹è¯•æ¡ˆä¾‹
- âœ… æ–°å¢æœåŠ¡åŠŸèƒ½å¿…é¡»ç¼–å†™å•å…ƒæµ‹è¯•
- âœ… æ–°å¢ä¸šåŠ¡é€»è¾‘å¿…é¡»ç¼–å†™é›†æˆæµ‹è¯•
- âœ… ä¿®æ”¹ç°æœ‰åŠŸèƒ½å¿…é¡»æ›´æ–°ç›¸å…³æµ‹è¯•

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ–°åŠŸèƒ½æ˜¯å¦æœ‰å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶
- [ ] æµ‹è¯•æ˜¯å¦è¦†ç›–æ­£å¸¸æµç¨‹
- [ ] æµ‹è¯•æ˜¯å¦è¦†ç›–å¼‚å¸¸æµç¨‹
- [ ] æµ‹è¯•æ˜¯å¦è¦†ç›–è¾¹ç•Œæƒ…å†µ
- [ ] æµ‹è¯•æ˜¯å¦é€šè¿‡ CI/CD éªŒè¯

## 2. æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

**è¦†ç›–ç‡ç›®æ ‡**ï¼š
- **å•å…ƒæµ‹è¯•è¦†ç›–ç‡**ï¼šâ‰¥ 50%ï¼ˆæ ¸å¿ƒæ¨¡å— â‰¥ 70%ï¼‰
- **API æµ‹è¯•è¦†ç›–ç‡**ï¼šâ‰¥ 80%ï¼ˆæ‰€æœ‰å…¬å¼€ API å¿…é¡»æœ‰æµ‹è¯•ï¼‰
- **é›†æˆæµ‹è¯•è¦†ç›–ç‡**ï¼šâ‰¥ 60%ï¼ˆå…³é”®ä¸šåŠ¡æµç¨‹å¿…é¡»æœ‰æµ‹è¯•ï¼‰

**æ£€æŸ¥å‘½ä»¤**ï¼š
```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/ --cov=server --cov=src --cov-report=html --cov-report=term-missing

# æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š
open htmlcov/index.html  # macOS
# æˆ–è®¿é—® htmlcov/index.html
```

## 3. æµ‹è¯•åˆ†ç±»å’Œå‘½åè§„èŒƒ

**æµ‹è¯•æ–‡ä»¶å‘½å**ï¼š
- å•å…ƒæµ‹è¯•ï¼š`tests/unit/test_<module_name>.py`
- é›†æˆæµ‹è¯•ï¼š`tests/integration/test_<feature_name>.py`
- API æµ‹è¯•ï¼š`tests/api/test_<api_name>.py`
- åŠŸèƒ½æµ‹è¯•ï¼š`tests/features/test_<feature_name>.py`
- ç«¯åˆ°ç«¯æµ‹è¯•ï¼š`tests/e2e/test_<scenario_name>.py`

**æµ‹è¯•å‡½æ•°å‘½å**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ test_ å‰ç¼€
def test_calculate_bazi_success():
    """æµ‹è¯•æˆåŠŸè®¡ç®—å…«å­—"""
    ...

def test_calculate_bazi_invalid_date():
    """æµ‹è¯•æ— æ•ˆæ—¥æœŸè¾“å…¥"""
    ...

# âŒ é”™è¯¯ï¼šä¸ä½¿ç”¨ test_ å‰ç¼€
def calculate_bazi_test():
    ...
```

**æµ‹è¯•ç±»å‘½å**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ Test å‰ç¼€
class TestBaziService:
    """å…«å­—æœåŠ¡æµ‹è¯•ç±»"""
    ...

# âŒ é”™è¯¯ï¼šä¸ä½¿ç”¨ Test å‰ç¼€
class BaziServiceTest:
    ...
```

## 4. æµ‹è¯•æ ‡è®°ï¼ˆMarkersï¼‰

**ä½¿ç”¨ pytest markers åˆ†ç±»æµ‹è¯•**ï¼š
```python
import pytest

@pytest.mark.unit
def test_calculate_bazi():
    """å•å…ƒæµ‹è¯•"""
    ...

@pytest.mark.integration
def test_api_integration():
    """é›†æˆæµ‹è¯•"""
    ...

@pytest.mark.api
def test_bazi_api():
    """API æµ‹è¯•"""
    ...

@pytest.mark.e2e
def test_end_to_end():
    """ç«¯åˆ°ç«¯æµ‹è¯•"""
    ...

@pytest.mark.slow
def test_performance():
    """æ…¢é€Ÿæµ‹è¯•ï¼ˆæ€§èƒ½æµ‹è¯•ï¼‰"""
    ...
```

**è¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•**ï¼š
```bash
# åªè¿è¡Œå•å…ƒæµ‹è¯•
pytest -m unit

# åªè¿è¡Œé›†æˆæµ‹è¯•
pytest -m integration

# åªè¿è¡Œ API æµ‹è¯•
pytest -m api

# æ’é™¤æ…¢é€Ÿæµ‹è¯•
pytest -m "not slow"
```

## 5. æµ‹è¯•æ•°æ®ç®¡ç†

**ä½¿ç”¨ fixtures ç®¡ç†æµ‹è¯•æ•°æ®**ï¼š
```python
# tests/conftest.py
import pytest
from server.services.bazi_service import BaziService

@pytest.fixture
def sample_bazi_data():
    """ç¤ºä¾‹å…«å­—æ•°æ®"""
    return {
        "solar_date": "1990-01-15",
        "solar_time": "12:00",
        "gender": "male"
    }

@pytest.fixture
def bazi_service():
    """å…«å­—æœåŠ¡å®ä¾‹"""
    return BaziService()
```

**ä½¿ç”¨å‚æ•°åŒ–æµ‹è¯•**ï¼š
```python
import pytest

@pytest.mark.parametrize("solar_date,solar_time,gender,expected", [
    ("1990-01-15", "12:00", "male", "åºšåˆ"),
    ("1995-05-20", "14:30", "female", "ä¹™äº¥"),
])
def test_calculate_bazi(solar_date, solar_time, gender, expected):
    """å‚æ•°åŒ–æµ‹è¯•"""
    result = calculate_bazi(solar_date, solar_time, gender)
    assert result["day_pillar"] == expected
```

## 6. æµ‹è¯•æ‰§è¡Œè§„èŒƒ

**æœ¬åœ°å¼€å‘æ—¶**ï¼š
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæ–‡ä»¶
pytest tests/unit/test_bazi_service.py

# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°
pytest tests/unit/test_bazi_service.py::test_calculate_bazi

# è¿è¡Œå¹¶æ˜¾ç¤ºè¦†ç›–ç‡
pytest --cov=server --cov=src --cov-report=term-missing
```

**æäº¤ä»£ç å‰**ï¼š
```bash
# å¿…é¡»è¿è¡Œæµ‹è¯•ï¼Œç¡®ä¿é€šè¿‡
pytest tests/

# æ£€æŸ¥è¦†ç›–ç‡
pytest --cov=server --cov=src --cov-report=term-missing --cov-fail-under=50
```

## 7. CI/CD è‡ªåŠ¨æµ‹è¯•

**è§¦å‘æ¡ä»¶**ï¼š
- âœ… æ¨é€åˆ° `master` æˆ– `develop` åˆ†æ”¯
- âœ… åˆ›å»º Pull Request
- âœ… æ‰‹åŠ¨è§¦å‘ï¼ˆGitHub Actionsï¼‰

**æµ‹è¯•æµç¨‹**ï¼š
1. **ä»£ç è´¨é‡æ£€æŸ¥**ï¼ˆlintï¼‰
   - Black ä»£ç æ ¼å¼æ£€æŸ¥
   - isort å¯¼å…¥æ’åºæ£€æŸ¥
   - pylint ä»£ç è´¨é‡æ£€æŸ¥
   - mypy ç±»å‹æ£€æŸ¥

2. **å•å…ƒæµ‹è¯•**ï¼ˆtestï¼‰
   - è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
   - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
   - ä¸Šä¼ åˆ° Codecov

3. **é›†æˆæµ‹è¯•**ï¼ˆintegration-testï¼‰
   - è¿è¡Œé›†æˆæµ‹è¯•
   - éªŒè¯ API é›†æˆ

**æµ‹è¯•ç»“æœç›‘æ§**ï¼š
- **GitHub Actions**ï¼š`.github/workflows/ci.yml`
- **Codecov**ï¼šè¦†ç›–ç‡æŠ¥å‘Šå’Œè¶‹åŠ¿
- **æµ‹è¯•æŠ¥å‘Š**ï¼š`htmlcov/index.html`ï¼ˆæœ¬åœ°ï¼‰

## 8. æµ‹è¯•å¤±è´¥å¤„ç†

**æµ‹è¯•å¤±è´¥æ—¶**ï¼š
1. **æŸ¥çœ‹æµ‹è¯•æ—¥å¿—**ï¼šGitHub Actions è¾“å‡º
2. **æœ¬åœ°å¤ç°**ï¼šåœ¨æœ¬åœ°è¿è¡Œå¤±è´¥çš„æµ‹è¯•
3. **ä¿®å¤é—®é¢˜**ï¼šä¿®å¤ä»£ç æˆ–æ›´æ–°æµ‹è¯•
4. **é‡æ–°æäº¤**ï¼šç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡

**ç¦æ­¢æ“ä½œ**ï¼š
- âŒ ç¦æ­¢è·³è¿‡å¤±è´¥çš„æµ‹è¯•ï¼ˆé™¤éæ˜¯å·²çŸ¥é—®é¢˜ï¼‰
- âŒ ç¦æ­¢é™ä½æµ‹è¯•è¦†ç›–ç‡è¦æ±‚
- âŒ ç¦æ­¢åˆ é™¤å¤±è´¥çš„æµ‹è¯•

## 9. æµ‹è¯•æœ€ä½³å®è·µ

**ç¼–å†™æµ‹è¯•çš„åŸåˆ™**ï¼š
1. **ç‹¬ç«‹æ€§**ï¼šæ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•
2. **å¯é‡å¤æ€§**ï¼šæµ‹è¯•ç»“æœåº”è¯¥ä¸€è‡´ï¼Œä¸ä¾èµ–å¤–éƒ¨çŠ¶æ€
3. **å¿«é€Ÿæ‰§è¡Œ**ï¼šå•å…ƒæµ‹è¯•åº”è¯¥å¿«é€Ÿæ‰§è¡Œï¼ˆ< 1ç§’ï¼‰
4. **æ¸…æ™°å‘½å**ï¼šæµ‹è¯•åç§°åº”è¯¥æ¸…æ™°æè¿°æµ‹è¯•å†…å®¹
5. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæµ‹è¯•åªæµ‹è¯•ä¸€ä¸ªåŠŸèƒ½ç‚¹

**ç¤ºä¾‹**ï¼š
```python
# âœ… å¥½çš„æµ‹è¯•
def test_calculate_bazi_with_valid_date():
    """æµ‹è¯•ï¼šä½¿ç”¨æœ‰æ•ˆæ—¥æœŸè®¡ç®—å…«å­—"""
    result = calculate_bazi("1990-01-15", "12:00", "male")
    assert result["success"] == True
    assert "bazi" in result

# âŒ ä¸å¥½çš„æµ‹è¯•
def test_all():
    """æµ‹è¯•æ‰€æœ‰åŠŸèƒ½"""
    # æµ‹è¯•å¤ªå¤šå†…å®¹ï¼Œéš¾ä»¥å®šä½é—®é¢˜
    ...
```

## 10. æµ‹è¯•è¦†ç›–ç‡ç›‘æ§

**è¦†ç›–ç‡æŠ¥å‘Šä½ç½®**ï¼š
- **æœ¬åœ°**ï¼š`htmlcov/index.html`
- **CI/CD**ï¼šGitHub Actions è¾“å‡º
- **åœ¨çº¿**ï¼šCodecovï¼ˆå¦‚æœé…ç½®ï¼‰

**è¦†ç›–ç‡è¦æ±‚**ï¼š
- **æ•´ä½“è¦†ç›–ç‡**ï¼šâ‰¥ 50%
- **æ ¸å¿ƒæ¨¡å—**ï¼ˆserver/services/ï¼‰ï¼šâ‰¥ 70%
- **API ç«¯ç‚¹**ï¼ˆserver/api/ï¼‰ï¼šâ‰¥ 80%
- **å·¥å…·å‡½æ•°**ï¼ˆserver/utils/ï¼‰ï¼šâ‰¥ 60%

**æŸ¥çœ‹è¦†ç›–ç‡**ï¼š
```bash
# ç”Ÿæˆ HTML æŠ¥å‘Š
pytest --cov=server --cov=src --cov-report=html

# æŸ¥çœ‹æŠ¥å‘Š
open htmlcov/index.html
```

---

### ğŸ“ æµ‹è¯•å¼€å‘æ£€æŸ¥æ¸…å•

æ¯æ¬¡å¼€å‘æ–°åŠŸèƒ½æ—¶ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

- [ ] æ˜¯å¦åˆ›å»ºäº†å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶
- [ ] æ˜¯å¦ç¼–å†™äº†æ­£å¸¸æµç¨‹æµ‹è¯•
- [ ] æ˜¯å¦ç¼–å†™äº†å¼‚å¸¸æµç¨‹æµ‹è¯•
- [ ] æ˜¯å¦ç¼–å†™äº†è¾¹ç•Œæƒ…å†µæµ‹è¯•
- [ ] æµ‹è¯•æ˜¯å¦é€šè¿‡æœ¬åœ°è¿è¡Œ
- [ ] æµ‹è¯•æ˜¯å¦é€šè¿‡ CI/CD éªŒè¯
- [ ] è¦†ç›–ç‡æ˜¯å¦è¾¾åˆ°è¦æ±‚ï¼ˆâ‰¥ 50%ï¼‰
- [ ] æ˜¯å¦æ›´æ–°äº†æµ‹è¯•æ–‡æ¡£

---

### ğŸš¨ æµ‹è¯•è§„èŒƒè¿åå¤„ç†

**å¦‚æœå‘ç°è¿åæµ‹è¯•è§„èŒƒ**ï¼š
1. **ç«‹å³ä¿®å¤**ï¼šè¡¥å……ç¼ºå¤±çš„æµ‹è¯•
2. **æ›´æ–°è§„èŒƒ**ï¼šå¦‚æœè§„èŒƒä¸åˆç†ï¼Œæ›´æ–°è§„èŒƒ
3. **è®°å½•é—®é¢˜**ï¼šåœ¨å¼€å‘æ—¥å¿—ä¸­è®°å½•é—®é¢˜
4. **é˜²æ­¢å†æ¬¡å‘ç”Ÿ**ï¼šæ›´æ–°æ£€æŸ¥æ¸…å•

---

**æ ¸å¿ƒè¦ç‚¹**ï¼š
- **æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»åŒæ­¥ç¼–å†™æµ‹è¯•æ¡ˆä¾‹**
- **æµ‹è¯•è¦†ç›–ç‡å¿…é¡»è¾¾åˆ° 50% ä»¥ä¸Š**
- **æ‰€æœ‰æµ‹è¯•å¿…é¡»é€šè¿‡ CI/CD éªŒè¯**
- **æµ‹è¯•å¤±è´¥å¿…é¡»ä¿®å¤åæ‰èƒ½åˆå¹¶ä»£ç **

---

