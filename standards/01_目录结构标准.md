# ğŸ“ HiFate-bazi ç›®å½•ç»“æ„æ ‡å‡†

## ä¸€ã€ç›®å½•ç»“æ„æ¦‚è§ˆ

```
HiFate-bazi/
â”œâ”€â”€ server/                    # ğŸŒ Web æœåŠ¡ï¼ˆFastAPI ä¸»å…¥å£ï¼‰
â”‚   â”œâ”€â”€ api/                   # API è·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ v1/               # V1 ç‰ˆæœ¬ API
â”‚   â”‚   â”œâ”€â”€ v2/               # V2 ç‰ˆæœ¬ API
â”‚   â”‚   â””â”€â”€ grpc_gateway.py   # gRPC-Web ç½‘å…³
â”‚   â”œâ”€â”€ services/             # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”œâ”€â”€ engines/              # è§„åˆ™å¼•æ“
â”‚   â”œâ”€â”€ config/               # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ db/                   # æ•°æ®åº“è¿æ¥å’Œè¿ç§»
â”‚   â”œâ”€â”€ utils/                # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ main.py               # åº”ç”¨å…¥å£
â”‚
â”œâ”€â”€ services/                  # ğŸ”§ å¾®æœåŠ¡é›†ç¾¤
â”‚   â”œâ”€â”€ bazi_core/            # å…«å­—æ ¸å¿ƒè®¡ç®—æœåŠ¡ (9001)
â”‚   â”œâ”€â”€ bazi_fortune/         # è¿åŠ¿è®¡ç®—æœåŠ¡ (9002)
â”‚   â”œâ”€â”€ bazi_analyzer/        # å…«å­—åˆ†ææœåŠ¡ (9003)
â”‚   â”œâ”€â”€ bazi_rule/            # è§„åˆ™åŒ¹é…æœåŠ¡ (9004)
â”‚   â”œâ”€â”€ fortune_analysis/     # è¿åŠ¿åˆ†ææœåŠ¡ (9005)
â”‚   â”œâ”€â”€ payment_service/      # æ”¯ä»˜æœåŠ¡ (9006)
â”‚   â”œâ”€â”€ fortune_rule/         # è¿åŠ¿è§„åˆ™æœåŠ¡ (9007)
â”‚   â”œâ”€â”€ intent_service/       # æ„å›¾è¯†åˆ«æœåŠ¡ (9008)
â”‚   â”œâ”€â”€ prompt_optimizer/     # æç¤ºä¼˜åŒ–æœåŠ¡ (9009)
â”‚   â””â”€â”€ desk_fengshui/        # åŠå…¬æ¡Œé£æ°´æœåŠ¡ (9010)
â”‚
â”œâ”€â”€ src/                       # ğŸ“š æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆå…±äº«åº“ï¼‰
â”‚   â”œâ”€â”€ analyzers/            # åˆ†æå™¨
â”‚   â”œâ”€â”€ bazi_config/          # å…«å­—é…ç½®
â”‚   â”œâ”€â”€ bazi_core/            # å…«å­—æ ¸å¿ƒç®—æ³•
â”‚   â”œâ”€â”€ bazi_fortune/         # è¿åŠ¿è®¡ç®—é€»è¾‘
â”‚   â”œâ”€â”€ clients/              # gRPC å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ data/                 # æ•°æ®å¸¸é‡
â”‚   â””â”€â”€ tool/                 # å·¥å…·ç±»
â”‚
â”œâ”€â”€ frontend/                  # ğŸ¨ å‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ css/                  # æ ·å¼æ–‡ä»¶
â”‚   â”œâ”€â”€ js/                   # JavaScript æ–‡ä»¶
â”‚   â””â”€â”€ *.html                # HTML é¡µé¢
â”‚
â”œâ”€â”€ tests/                     # ğŸ§ª æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ unit/                 # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ integration/          # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ api/                  # API æµ‹è¯•
â”‚   â”œâ”€â”€ features/             # åŠŸèƒ½æµ‹è¯•
â”‚   â””â”€â”€ scripts/              # æµ‹è¯•è„šæœ¬
â”‚
â”œâ”€â”€ scripts/                   # ğŸ“œ è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ migration/            # æ•°æ®è¿ç§»è„šæœ¬
â”‚   â”œâ”€â”€ docker/               # Docker ç›¸å…³è„šæœ¬
â”‚   â”œâ”€â”€ aliyun/               # é˜¿é‡Œäº‘éƒ¨ç½²è„šæœ¬
â”‚   â””â”€â”€ tests/                # æµ‹è¯•è„šæœ¬
â”‚
â”œâ”€â”€ docs/                      # ğŸ“– æ–‡æ¡£
â”‚   â””â”€â”€ *.md                  # å„ç±»æ–‡æ¡£
â”‚
â”œâ”€â”€ standards/                 # ğŸ“‹ å¼€å‘æ ‡å‡†ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ 01_ç›®å½•ç»“æ„æ ‡å‡†.md
â”‚   â”œâ”€â”€ 02_å‘½åè§„èŒƒ.md
â”‚   â”œâ”€â”€ 03_å¼€å‘è€…æ‰‹å†Œ.md
â”‚   â”œâ”€â”€ 04_æµ‹è¯•è§„èŒƒ.md
â”‚   â””â”€â”€ templates/            # ä»£ç æ¨¡æ¿
â”‚
â”œâ”€â”€ proto/                     # ğŸ“¡ gRPC åè®®å®šä¹‰
â”‚   â””â”€â”€ *.proto               # Protocol Buffers æ–‡ä»¶
â”‚
â”œâ”€â”€ deploy/                    # ğŸš€ éƒ¨ç½²é…ç½®
â”‚   â”œâ”€â”€ aliyun/               # é˜¿é‡Œäº‘é…ç½®
â”‚   â””â”€â”€ *.sh                  # éƒ¨ç½²è„šæœ¬
â”‚
â””â”€â”€ docker-compose*.yml        # ğŸ³ Docker ç¼–æ’æ–‡ä»¶
```

---

## äºŒã€ç›®å½•èŒè´£è¯´æ˜

### 2.1 server/ - Web æœåŠ¡å±‚

**èŒè´£ï¼š** å¤„ç† HTTP/gRPC è¯·æ±‚ï¼Œåè°ƒä¸šåŠ¡é€»è¾‘

| å­ç›®å½• | èŒè´£ | ç¤ºä¾‹æ–‡ä»¶ |
|--------|------|----------|
| `api/v1/` | V1 ç‰ˆæœ¬ REST API | `bazi.py`, `calendar_api.py` |
| `api/v2/` | V2 ç‰ˆæœ¬ REST API | `face_analysis.py` |
| `services/` | ä¸šåŠ¡æœåŠ¡é€»è¾‘ | `calendar_api_service.py` |
| `engines/` | è§„åˆ™å¼•æ“ | `rule_engine.py` |
| `config/` | é…ç½®ç®¡ç† | `mysql_config.py` |
| `db/` | æ•°æ®åº“è®¿é—® | `mysql_connector.py` |
| `utils/` | å·¥å…·å‡½æ•° | `cache.py`, `auth.py` |

**å‘½åè§„èŒƒï¼š**
```python
# API æ–‡ä»¶å‘½åï¼š{åŠŸèƒ½å}_api.py æˆ– {åŠŸèƒ½å}.py
server/api/v1/calendar_api.py
server/api/v1/bazi.py

# æœåŠ¡æ–‡ä»¶å‘½åï¼š{åŠŸèƒ½å}_service.py
server/services/calendar_api_service.py
```

---

### 2.2 services/ - å¾®æœåŠ¡å±‚

**èŒè´£ï¼š** ç‹¬ç«‹è¿è¡Œçš„ gRPC å¾®æœåŠ¡

| æœåŠ¡ | ç«¯å£ | èŒè´£ |
|------|------|------|
| `bazi_core` | 9001 | å…«å­—æ ¸å¿ƒè®¡ç®— |
| `bazi_fortune` | 9002 | è¿åŠ¿è®¡ç®— |
| `bazi_analyzer` | 9003 | å…«å­—åˆ†æ |
| `bazi_rule` | 9004 | è§„åˆ™åŒ¹é… |
| `fortune_analysis` | 9005 | è¿åŠ¿åˆ†æ |
| `payment_service` | 9006 | æ”¯ä»˜æœåŠ¡ |
| `fortune_rule` | 9007 | è¿åŠ¿è§„åˆ™ |
| `intent_service` | 9008 | æ„å›¾è¯†åˆ« |
| `prompt_optimizer` | 9009 | æç¤ºä¼˜åŒ– |
| `desk_fengshui` | 9010 | åŠå…¬æ¡Œé£æ°´ |

**æ ‡å‡†å¾®æœåŠ¡ç»“æ„ï¼š**
```
services/{service_name}/
â”œâ”€â”€ __init__.py          # æ¨¡å—åˆå§‹åŒ–
â”œâ”€â”€ grpc_server.py       # gRPC æœåŠ¡ç«¯
â”œâ”€â”€ main.py              # æœåŠ¡å…¥å£
â”œâ”€â”€ schemas.py           # æ•°æ®æ¨¡å‹
â”œâ”€â”€ service.py           # ä¸šåŠ¡é€»è¾‘ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ requirements.txt     # ç‹¬ç«‹ä¾èµ–ï¼ˆå¯é€‰ï¼‰
```

---

### 2.3 src/ - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

**èŒè´£ï¼š** å…±äº«çš„æ ¸å¿ƒç®—æ³•å’Œä¸šåŠ¡é€»è¾‘ï¼Œè¢« `server/` å’Œ `services/` å…±åŒä½¿ç”¨

| å­ç›®å½• | èŒè´£ | ç¤ºä¾‹ |
|--------|------|------|
| `analyzers/` | å„ç±»åˆ†æå™¨ | `wangshuai_analyzer.py` |
| `bazi_config/` | å…«å­—é…ç½®æ•°æ® | `ten_gods_config.py` |
| `bazi_core/` | æ ¸å¿ƒè®¡ç®—ç®—æ³• | `calculator.py` |
| `clients/` | gRPC å®¢æˆ·ç«¯ | `bazi_core_client_grpc.py` |
| `data/` | æ•°æ®å¸¸é‡ | `stems_branches.py` |
| `tool/` | å·¥å…·ç±» | `LunarConverter.py` |

**ä½¿ç”¨åŸåˆ™ï¼š**
- âœ… çº¯ä¸šåŠ¡é€»è¾‘ï¼Œæ—  HTTP/gRPC ä¾èµ–
- âœ… å¯è¢«å¤šä¸ªæœåŠ¡å¤ç”¨
- âŒ ä¸åŒ…å« API è·¯ç”±
- âŒ ä¸åŒ…å«æ•°æ®åº“è¿æ¥

---

### 2.4 tests/ - æµ‹è¯•ä»£ç 

**èŒè´£ï¼š** æ‰€æœ‰æµ‹è¯•ä»£ç 

| å­ç›®å½• | èŒè´£ | è¦†ç›–ç‡ç›®æ ‡ |
|--------|------|------------|
| `unit/` | å•å…ƒæµ‹è¯• | 70% |
| `integration/` | é›†æˆæµ‹è¯• | 20% |
| `api/` | API æµ‹è¯• | æ‰€æœ‰ API |
| `features/` | åŠŸèƒ½æµ‹è¯• | æ ¸å¿ƒåŠŸèƒ½ |

**å‘½åè§„èŒƒï¼š**
```python
# æµ‹è¯•æ–‡ä»¶å‘½åï¼štest_{æ¨¡å—å}.py
tests/unit/test_bazi_service.py
tests/api/test_calendar_api.py
tests/integration/test_api_bazi.py
```

---

## ä¸‰ã€æ–°å¢ç›®å½•ï¼šstandards/

**èŒè´£ï¼š** å­˜æ”¾å¼€å‘æ ‡å‡†å’Œè§„èŒƒæ–‡æ¡£

```
standards/
â”œâ”€â”€ 01_ç›®å½•ç»“æ„æ ‡å‡†.md        # æœ¬æ–‡æ¡£
â”œâ”€â”€ 02_å‘½åè§„èŒƒ.md            # å‘½åè§„èŒƒ
â”œâ”€â”€ 03_å¼€å‘è€…æ‰‹å†Œ.md          # å¿«é€Ÿå¼€å§‹æŒ‡å—
â”œâ”€â”€ 04_æµ‹è¯•è§„èŒƒ.md            # æµ‹è¯•è§„èŒƒ
â”œâ”€â”€ 05_åŠŸèƒ½å¼€å‘æ£€æŸ¥æ¸…å•.md    # å¼€å‘æ£€æŸ¥æ¸…å•
â””â”€â”€ templates/                 # ä»£ç æ¨¡æ¿
    â”œâ”€â”€ api_template.py       # API æ¨¡æ¿
    â”œâ”€â”€ service_template.py   # Service æ¨¡æ¿
    â””â”€â”€ test_template.py      # æµ‹è¯•æ¨¡æ¿
```

---

## å››ã€æ–‡ä»¶æ”¾ç½®è§„åˆ™

### 4.1 æ–°åŠŸèƒ½å¼€å‘

| ç±»å‹ | æ”¾ç½®ä½ç½® | ç¤ºä¾‹ |
|------|----------|------|
| æ–° API | `server/api/v1/` | `calendar_api.py` |
| ä¸šåŠ¡æœåŠ¡ | `server/services/` | `calendar_api_service.py` |
| æ ¸å¿ƒç®—æ³• | `src/` | å¤ç”¨çš„è®¡ç®—é€»è¾‘ |
| æ–°å¾®æœåŠ¡ | `services/` | ç‹¬ç«‹è¿è¡Œçš„æœåŠ¡ |
| æµ‹è¯•ä»£ç  | `tests/` | å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶ |

### 4.2 å†³ç­–æ ‘

```
æ–°å¢ä»£ç ï¼Ÿ
    â”‚
    â”œâ”€â”€ æ˜¯ HTTP APIï¼Ÿ
    â”‚   â””â”€â”€ â†’ server/api/v1/
    â”‚
    â”œâ”€â”€ æ˜¯ä¸šåŠ¡é€»è¾‘ï¼Ÿ
    â”‚   â”œâ”€â”€ è¢«å¤šä¸ªæœåŠ¡ä½¿ç”¨ï¼Ÿ
    â”‚   â”‚   â””â”€â”€ â†’ src/
    â”‚   â””â”€â”€ ä»… Web æœåŠ¡ä½¿ç”¨ï¼Ÿ
    â”‚       â””â”€â”€ â†’ server/services/
    â”‚
    â”œâ”€â”€ æ˜¯ç‹¬ç«‹å¾®æœåŠ¡ï¼Ÿ
    â”‚   â””â”€â”€ â†’ services/{service_name}/
    â”‚
    â”œâ”€â”€ æ˜¯å‰ç«¯ä»£ç ï¼Ÿ
    â”‚   â””â”€â”€ â†’ frontend/
    â”‚
    â””â”€â”€ æ˜¯æµ‹è¯•ä»£ç ï¼Ÿ
        â””â”€â”€ â†’ tests/
```

---

## äº”ã€æ£€æŸ¥æ¸…å•

åˆ›å»ºæ–°åŠŸèƒ½æ—¶ï¼Œç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

- [ ] API æ–‡ä»¶æ”¾åœ¨ `server/api/v1/` æˆ– `server/api/v2/`
- [ ] Service æ–‡ä»¶æ”¾åœ¨ `server/services/`
- [ ] å…±äº«é€»è¾‘æ”¾åœ¨ `src/`
- [ ] æµ‹è¯•æ–‡ä»¶æ”¾åœ¨ `tests/` å¯¹åº”ç›®å½•
- [ ] gRPC ç«¯ç‚¹å·²æ³¨å†Œåˆ° `grpc_gateway.py`
- [ ] æ–‡æ¡£å·²æ›´æ–°

---

## å…­ã€è¿ç§»æŒ‡å—ï¼ˆå¯é€‰ï¼‰

å¦‚æœå‘ç°ä»£ç æ”¾é”™ä½ç½®ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤è¿ç§»ï¼š

1. ç¡®è®¤ä»£ç çš„èŒè´£ï¼ˆAPI/Service/Coreï¼‰
2. ç§»åŠ¨æ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
3. æ›´æ–°æ‰€æœ‰ import è¯­å¥
4. è¿è¡Œæµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
5. æ›´æ–°ç›¸å…³æ–‡æ¡£

**æ³¨æ„ï¼š** è¿ç§»éœ€è°¨æ…ï¼Œå»ºè®®é€æ­¥è¿›è¡Œï¼Œæ¯æ¬¡åªè¿ç§»ä¸€ä¸ªæ¨¡å—ã€‚
