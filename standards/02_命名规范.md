# ğŸ“ HiFate-bazi å‘½åè§„èŒƒ

## ä¸€ã€æ€»ä½“åŸåˆ™

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **æ¸…æ™°æ˜ç¡®** | åç§°èƒ½ç›´æ¥è¡¨è¾¾ç”¨é€” | âœ… `calendar_api_service.py` |
| **ä¸€è‡´æ€§** | ç›¸åŒç±»å‹ä½¿ç”¨ç›¸åŒé£æ ¼ | âœ… `xxx_service.py`, `xxx_api.py` |
| **å¯æœç´¢** | ä¾¿äºå…¨å±€æœç´¢å®šä½ | âœ… `CalendarAPIService` |
| **é¿å…ç¼©å†™** | é™¤éæ˜¯é€šç”¨ç¼©å†™ | âœ… `api`, `grpc` âŒ `cal_svc` |

---

## äºŒã€Python å‘½åè§„èŒƒ

### 2.1 æ–‡ä»¶å‘½å

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| æ™®é€šæ¨¡å— | å°å†™+ä¸‹åˆ’çº¿ | `calendar_api_service.py` |
| æµ‹è¯•æ–‡ä»¶ | `test_` å‰ç¼€ | `test_calendar_api.py` |
| é…ç½®æ–‡ä»¶ | `_config` åç¼€ | `mysql_config.py` |

**æ–‡ä»¶ç±»å‹åç¼€è§„èŒƒï¼š**

| åç¼€ | ç±»å‹ | ç¤ºä¾‹ |
|------|------|------|
| `_api.py` | API è·¯ç”± | `calendar_api.py` |
| `_service.py` | ä¸šåŠ¡æœåŠ¡ | `calendar_api_service.py` |
| `_config.py` | é…ç½®æ–‡ä»¶ | `mysql_config.py` |
| `_client.py` | å®¢æˆ·ç«¯ | `bazi_core_client.py` |
| `_engine.py` | å¼•æ“ | `rule_engine.py` |
| `_analyzer.py` | åˆ†æå™¨ | `wangshuai_analyzer.py` |
| `_dao.py` | æ•°æ®è®¿é—® | `rule_content_dao.py` |

---

### 2.2 ç±»å‘½å

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| æ™®é€šç±» | PascalCase | `CalendarAPIService` |
| å¼‚å¸¸ç±» | `Error` æˆ– `Exception` åç¼€ | `ValidationError` |
| Mixin | `Mixin` åç¼€ | `LoggingMixin` |
| æŠ½è±¡ç±» | `Base` æˆ– `Abstract` å‰ç¼€ | `BaseService` |

**ç±»å‘½åç¤ºä¾‹ï¼š**
```python
# âœ… æ­£ç¡®
class CalendarAPIService:
    pass

class BaziCalculator:
    pass

class ValidationError(Exception):
    pass

# âŒ é”™è¯¯
class calendarAPIService:  # åº”è¯¥ PascalCase
    pass

class calendar_api_service:  # åº”è¯¥ PascalCase
    pass
```

---

### 2.3 å‡½æ•°å‘½å

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| æ™®é€šå‡½æ•° | å°å†™+ä¸‹åˆ’çº¿ | `get_calendar_data()` |
| ç§æœ‰å‡½æ•° | å•ä¸‹åˆ’çº¿å‰ç¼€ | `_calculate_local()` |
| å¼‚æ­¥å‡½æ•° | åŒä¸Š | `async def query_calendar()` |
| å¸ƒå°”å‡½æ•° | `is_`/`has_`/`can_` å‰ç¼€ | `is_valid_date()` |

**å‡½æ•°å‘½åç¤ºä¾‹ï¼š**
```python
# âœ… æ­£ç¡®
def get_calendar_data(date: str) -> dict:
    pass

async def query_calendar(request: CalendarRequest):
    pass

def is_valid_date(date_str: str) -> bool:
    pass

def _calculate_local(self, date: str):  # ç§æœ‰æ–¹æ³•
    pass

# âŒ é”™è¯¯
def GetCalendarData():  # åº”è¯¥å°å†™+ä¸‹åˆ’çº¿
    pass

def getCalendarData():  # åº”è¯¥å°å†™+ä¸‹åˆ’çº¿
    pass
```

---

### 2.4 å˜é‡å‘½å

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| æ™®é€šå˜é‡ | å°å†™+ä¸‹åˆ’çº¿ | `lunar_date`, `bazi_result` |
| å¸¸é‡ | å¤§å†™+ä¸‹åˆ’çº¿ | `MAX_RETRY_COUNT` |
| ç§æœ‰å˜é‡ | å•ä¸‹åˆ’çº¿å‰ç¼€ | `_cache_data` |
| ç±»å±æ€§ | å°å†™+ä¸‹åˆ’çº¿ | `self.api_key` |

**å˜é‡å‘½åç¤ºä¾‹ï¼š**
```python
# âœ… æ­£ç¡®
lunar_date = "å†œå†åæœˆå»¿äºŒ"
bazi_result = {"year": "ä¹™å·³", "month": "æˆŠå­"}
MAX_RETRY_COUNT = 3
API_TIMEOUT = 30

# âŒ é”™è¯¯
lunarDate = "å†œå†åæœˆå»¿äºŒ"  # åº”è¯¥å°å†™+ä¸‹åˆ’çº¿
BAZI_Result = {}  # å¸¸é‡åº”å…¨å¤§å†™æˆ–å˜é‡åº”å…¨å°å†™
```

---

### 2.5 Pydantic æ¨¡å‹å‘½å

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| è¯·æ±‚æ¨¡å‹ | `{Name}Request` | `CalendarRequest` |
| å“åº”æ¨¡å‹ | `{Name}Response` | `CalendarResponse` |
| å†…éƒ¨æ¨¡å‹ | `{Name}Model` æˆ–çº¯åç§° | `GanzhiModel` |

**ç¤ºä¾‹ï¼š**
```python
from pydantic import BaseModel, Field

class CalendarRequest(BaseModel):
    """æ—¥å†æŸ¥è¯¢è¯·æ±‚"""
    date: Optional[str] = Field(None, description="æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD")

class CalendarResponse(BaseModel):
    """æ—¥å†æŸ¥è¯¢å“åº”"""
    success: bool = Field(..., description="æ˜¯å¦æˆåŠŸ")
    data: Optional[dict] = Field(None, description="è¿”å›æ•°æ®")
    error: Optional[str] = Field(None, description="é”™è¯¯ä¿¡æ¯")
```

---

## ä¸‰ã€API å‘½åè§„èŒƒ

### 3.1 è·¯ç”±è·¯å¾„

| è§„èŒƒ | ç¤ºä¾‹ |
|------|------|
| å°å†™+è¿å­—ç¬¦ | `/api/v1/calendar/query` |
| èµ„æºåè¯å¤æ•° | `/api/v1/rules`, `/api/v1/users` |
| åŠ¨ä½œç”¨åŠ¨è¯ | `/api/v1/bazi/calculate` |

**è·¯ç”±å‘½åç¤ºä¾‹ï¼š**
```python
# âœ… æ­£ç¡®
@router.post("/calendar/query")
@router.get("/rules")
@router.post("/bazi/calculate")

# âŒ é”™è¯¯
@router.post("/Calendar/Query")  # åº”è¯¥å°å†™
@router.post("/getCalendar")     # åº”è¯¥ç”¨åè¯+åŠ¨è¯
```

### 3.2 gRPC ç«¯ç‚¹

| è§„èŒƒ | ç¤ºä¾‹ |
|------|------|
| ä¸ REST è·¯å¾„ä¸€è‡´ | `/calendar/query` |
| åœ¨ grpc_gateway.py æ³¨å†Œ | `@_register("/calendar/query")` |

---

## å››ã€æ•°æ®åº“å‘½åè§„èŒƒ

### 4.1 è¡¨å‘½å

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| è¡¨å | å°å†™+ä¸‹åˆ’çº¿ | `bazi_rules`, `user_feedback` |
| å…³è”è¡¨ | `{è¡¨1}_{è¡¨2}` | `user_roles` |

### 4.2 å­—æ®µå‘½å

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| æ™®é€šå­—æ®µ | å°å†™+ä¸‹åˆ’çº¿ | `rule_code`, `created_at` |
| ä¸»é”® | `id` | `id` |
| å¤–é”® | `{è¡¨å}_id` | `user_id`, `rule_id` |
| å¸ƒå°”å­—æ®µ | `is_`/`has_` å‰ç¼€ | `is_enabled`, `has_paid` |
| æ—¶é—´å­—æ®µ | `_at` åç¼€ | `created_at`, `updated_at` |

**ç¤ºä¾‹ï¼š**
```sql
CREATE TABLE bazi_rules (
    id INT AUTO_INCREMENT PRIMARY KEY,
    rule_code VARCHAR(100) NOT NULL,
    rule_name VARCHAR(200),
    rule_type VARCHAR(50),
    conditions JSON,
    content JSON,
    is_enabled TINYINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

## äº”ã€å‰ç«¯å‘½åè§„èŒƒ

### 5.1 JavaScript å‘½å

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| å‡½æ•° | camelCase | `loadCalendar()`, `renderData()` |
| å˜é‡ | camelCase | `calendarData`, `isLoading` |
| å¸¸é‡ | UPPER_SNAKE_CASE | `API_BASE_URL` |
| CSS ç±» | kebab-case | `.calendar-card`, `.btn-primary` |

**ç¤ºä¾‹ï¼š**
```javascript
// âœ… æ­£ç¡®
const calendarData = {};
const API_BASE_URL = '/api/v1';

async function loadCalendar(date) {
    const response = await api.post('/calendar/query', { date });
}

// CSS ç±»
<div class="calendar-card">
    <div class="calendar-header">
```

### 5.2 æ–‡ä»¶å‘½å

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| JS æ–‡ä»¶ | å°å†™+è¿å­—ç¬¦æˆ–ä¸‹åˆ’çº¿ | `calendar.js`, `fortune-timeline.js` |
| CSS æ–‡ä»¶ | å°å†™+è¿å­—ç¬¦ | `style.css`, `calendar-card.css` |
| HTML æ–‡ä»¶ | å°å†™+è¿å­—ç¬¦ | `index.html`, `formula-analysis.html` |

---

## å…­ã€Git æäº¤ä¿¡æ¯è§„èŒƒ

### 6.1 æ ¼å¼

```
[ç±»å‹] ç®€çŸ­æè¿°ï¼ˆ50å­—ä»¥å†…ï¼‰

è¯¦ç»†æè¿°ï¼ˆå¯é€‰ï¼‰
```

### 6.2 ç±»å‹æ ‡ç­¾

| æ ‡ç­¾ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `[æ–°å¢]` | æ–°åŠŸèƒ½ | `[æ–°å¢] ä¸‡å¹´å†æŸ¥è¯¢åŠŸèƒ½` |
| `[ä¿®å¤]` | Bug ä¿®å¤ | `[ä¿®å¤] å†œå†æ—¥æœŸè®¡ç®—é”™è¯¯` |
| `[ä¼˜åŒ–]` | æ€§èƒ½ä¼˜åŒ– | `[ä¼˜åŒ–] ç¼“å­˜ç­–ç•¥` |
| `[é‡æ„]` | ä»£ç é‡æ„ | `[é‡æ„] è§„åˆ™å¼•æ“` |
| `[æ–‡æ¡£]` | æ–‡æ¡£æ›´æ–° | `[æ–‡æ¡£] æ›´æ–° API è¯´æ˜` |
| `[æµ‹è¯•]` | æµ‹è¯•ç›¸å…³ | `[æµ‹è¯•] æ·»åŠ å•å…ƒæµ‹è¯•` |
| `[é…ç½®]` | é…ç½®ä¿®æ”¹ | `[é…ç½®] æ›´æ–°æ•°æ®åº“é…ç½®` |

---

## ä¸ƒã€å‘½åæ£€æŸ¥æ¸…å•

å¼€å‘æ—¶æ£€æŸ¥ï¼š

- [ ] æ–‡ä»¶åä½¿ç”¨å°å†™+ä¸‹åˆ’çº¿
- [ ] ç±»åä½¿ç”¨ PascalCase
- [ ] å‡½æ•°åä½¿ç”¨å°å†™+ä¸‹åˆ’çº¿
- [ ] å˜é‡åä½¿ç”¨å°å†™+ä¸‹åˆ’çº¿
- [ ] å¸¸é‡ä½¿ç”¨ UPPER_SNAKE_CASE
- [ ] API è·¯å¾„ä½¿ç”¨å°å†™+è¿å­—ç¬¦
- [ ] æ•°æ®åº“è¡¨å/å­—æ®µåä½¿ç”¨å°å†™+ä¸‹åˆ’çº¿
- [ ] è¯·æ±‚æ¨¡å‹ä»¥ `Request` ç»“å°¾
- [ ] å“åº”æ¨¡å‹ä»¥ `Response` ç»“å°¾

---

## å…«ã€å¸¸è§å‘½åæ˜ å°„

### 8.1 ä¸­è‹±æ–‡å¯¹ç…§

| ä¸­æ–‡ | è‹±æ–‡ | ç”¨é€” |
|------|------|------|
| å…«å­— | bazi | æ–‡ä»¶åã€å˜é‡å |
| ä¸‡å¹´å† | calendar | æ–‡ä»¶åã€å˜é‡å |
| è¿åŠ¿ | fortune | æ–‡ä»¶åã€å˜é‡å |
| è§„åˆ™ | rule | æ–‡ä»¶åã€å˜é‡å |
| åˆ†æ | analysis/analyzer | æ–‡ä»¶åã€å˜é‡å |
| è®¡ç®— | calculate/calculator | å‡½æ•°åã€ç±»å |
| æŸ¥è¯¢ | query | API è·¯å¾„ã€å‡½æ•°å |
| å®œ | yi | å˜é‡å |
| å¿Œ | ji | å˜é‡å |
| å‰å‡¶ | luck_level | å˜é‡å |
| å¹²æ”¯ | ganzhi | å˜é‡å |
| å†œå† | lunar | å˜é‡å |
| å…¬å† | solar | å˜é‡å |

### 8.2 è§„åˆ™ç±»å‹æ˜ å°„

| ä¸­æ–‡ | è‹±æ–‡ | æ•°æ®åº“å€¼ |
|------|------|----------|
| è´¢å¯Œ | wealth | `wealth` |
| å©šå§» | marriage | `marriage` |
| äº‹ä¸š | career | `career` |
| å­å¥³ | children | `children` |
| æ€§æ ¼ | character | `character` |
| æ€»è¯„ | summary | `summary` |
| èº«ä½“ | health | `health` |
| æ¡ƒèŠ± | peach_blossom | `peach_blossom` |
| åç¥å‘½æ ¼ | shishen | `shishen` |
