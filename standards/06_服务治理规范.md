# ğŸ”§ HiFate-bazi æœåŠ¡æ²»ç†è§„èŒƒ

## ä¸€ã€æ¦‚è¿°

æœåŠ¡æ²»ç†æ˜¯å¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œæœ¬æ–‡æ¡£å®šä¹‰äº† HiFate-bazi é¡¹ç›®çš„æœåŠ¡æ²»ç†è§„èŒƒã€‚

### 1.1 æœåŠ¡æ²»ç†ç»„ä»¶

| ç»„ä»¶ | åŠŸèƒ½ | ä½ç½® |
|------|------|------|
| **æœåŠ¡æ³¨å†Œä¸­å¿ƒ** | æœåŠ¡æ³¨å†Œä¸å‘ç° | `server/core/service_registry.py` |
| **ç†”æ–­å™¨** | é˜²æ­¢çº§è”æ•…éšœ | `server/core/circuit_breaker.py` |
| **é™æµå™¨** | ä¿æŠ¤æœåŠ¡ä¸è¢«è¿‡è½½ | `server/core/rate_limiter.py` |
| **å¥åº·æ£€æŸ¥** | ç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€ | `server/core/health_checker.py` |
| **æ²»ç† API** | ç®¡ç†å’Œç›‘æ§æ¥å£ | `server/api/v1/service_governance.py` |

---

## äºŒã€æœåŠ¡æ¶æ„

### 2.1 å¾®æœåŠ¡åˆ—è¡¨

| æœåŠ¡å | ç«¯å£ | èŒè´£ | ä¾èµ– |
|--------|------|------|------|
| bazi-core | 9001 | å…«å­—æ ¸å¿ƒè®¡ç®— | æ—  |
| bazi-fortune | 9002 | è¿åŠ¿è®¡ç®— | bazi-core |
| bazi-analyzer | 9003 | å…«å­—åˆ†æ | bazi-core |
| bazi-rule | 9004 | è§„åˆ™åŒ¹é… | MySQL |
| fortune-analysis | 9005 | è¿åŠ¿åˆ†æ | bazi-fortune, fortune-rule |
| payment | 9006 | æ”¯ä»˜æœåŠ¡ | å¤–éƒ¨æ”¯ä»˜ API |
| fortune-rule | 9007 | è¿åŠ¿è§„åˆ™ | MySQL |
| intent | 9008 | æ„å›¾è¯†åˆ« | LLM API |
| prompt-optimizer | 9009 | æç¤ºä¼˜åŒ– | LLM API |
| desk-fengshui | 9010 | åŠå…¬æ¡Œé£æ°´ | YOLO, bazi-core |

### 2.2 æ¶æ„å›¾

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚              å‰ç«¯ (Browser)                      â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚           Web æœåŠ¡ (FastAPI :8001)               â”‚
                     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                     â”‚  â”‚           gRPC-Web Gateway                   â”‚â”‚
                     â”‚  â”‚  â€¢ æœåŠ¡æ³¨å†Œä¸­å¿ƒ                              â”‚â”‚
                     â”‚  â”‚  â€¢ ç†”æ–­å™¨                                    â”‚â”‚
                     â”‚  â”‚  â€¢ é™æµå™¨                                    â”‚â”‚
                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              â”‚              â”‚              â”‚              â”‚
          â–¼              â–¼              â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚bazi-core â”‚  â”‚bazi-fort â”‚  â”‚bazi-rule â”‚  â”‚ intent   â”‚  â”‚ payment  â”‚
    â”‚  :9001   â”‚  â”‚  :9002   â”‚  â”‚  :9004   â”‚  â”‚  :9008   â”‚  â”‚  :9006   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æœåŠ¡æ³¨å†Œä¸­å¿ƒ

### 3.1 åŸºæœ¬ç”¨æ³•

```python
from server.core.service_registry import get_registry, get_service_address

# è·å–æ³¨å†Œä¸­å¿ƒå®ä¾‹
registry = get_registry()
registry.initialize()  # ä»ç¯å¢ƒå˜é‡åŠ è½½æœåŠ¡é…ç½®

# æ³¨å†ŒæœåŠ¡
registry.register(
    name="my-service",
    host="localhost",
    port=9011,
    metadata={"description": "æˆ‘çš„æœåŠ¡"}
)

# å‘ç°æœåŠ¡
service = registry.discover("bazi-core")
if service:
    print(f"æœåŠ¡åœ°å€: {service.address}")

# ä¾¿æ·æ–¹å¼è·å–åœ°å€
address = get_service_address("bazi-core")
```

### 3.2 æœåŠ¡é…ç½®

æœåŠ¡é…ç½®é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†ï¼š

```bash
# .env æ–‡ä»¶
BAZI_CORE_SERVICE_URL=localhost:9001
BAZI_FORTUNE_SERVICE_URL=localhost:9002
BAZI_RULE_SERVICE_URL=localhost:9004
INTENT_SERVICE_URL=localhost:9008
```

### 3.3 æœåŠ¡çŠ¶æ€

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| UNKNOWN | æœªçŸ¥ï¼ˆåˆšæ³¨å†Œï¼‰ |
| HEALTHY | å¥åº· |
| UNHEALTHY | ä¸å¥åº· |
| STARTING | å¯åŠ¨ä¸­ |
| STOPPING | åœæ­¢ä¸­ |

---

## å››ã€ç†”æ–­å™¨

### 4.1 å·¥ä½œåŸç†

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    CLOSED     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   (æ­£å¸¸çŠ¶æ€)   â”‚                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
                â”‚                                  â”‚
     å¤±è´¥æ¬¡æ•° >= é˜ˆå€¼                        æˆåŠŸæ¬¡æ•° >= é˜ˆå€¼
                â”‚                                  â”‚
                â–¼                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
        â”‚     OPEN      â”‚                          â”‚
        â”‚   (ç†”æ–­çŠ¶æ€)   â”‚                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
                â”‚                                  â”‚
          è¶…æ—¶åå°è¯•æ¢å¤                           â”‚
                â”‚                                  â”‚
                â–¼                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
        â”‚   HALF_OPEN   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚  (åŠå¼€çŠ¶æ€)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ä½¿ç”¨æ–¹æ³•

```python
from server.core.circuit_breaker import CircuitBreaker, circuit_breaker, CircuitBreakerOpen

# æ–¹å¼1ï¼šä½œä¸ºè£…é¥°å™¨
@circuit_breaker("bazi-core", failure_threshold=5)
def call_bazi_service():
    # è°ƒç”¨æœåŠ¡
    pass

# æ–¹å¼2ï¼šæ‰‹åŠ¨ä½¿ç”¨
breaker = CircuitBreaker.get("bazi-core")

if breaker.allow_request():
    try:
        result = call_service()
        breaker.record_success()
    except Exception as e:
        breaker.record_failure()
        raise
else:
    # ç†”æ–­å™¨å·²æ‰“å¼€
    raise CircuitBreakerOpen("bazi-core")
```

### 4.3 é…ç½®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| failure_threshold | 5 | è§¦å‘ç†”æ–­çš„å¤±è´¥æ¬¡æ•° |
| success_threshold | 3 | æ¢å¤æ‰€éœ€çš„æˆåŠŸæ¬¡æ•° |
| timeout | 30ç§’ | ç†”æ–­è¶…æ—¶æ—¶é—´ |
| half_open_max_calls | 3 | åŠå¼€çŠ¶æ€æœ€å¤§è°ƒç”¨æ•° |

---

## äº”ã€é™æµå™¨

### 5.1 é™æµç®—æ³•

| ç®—æ³• | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| ä»¤ç‰Œæ¡¶ | å…è®¸çªå‘æµé‡ï¼Œå¹³æ»‘é™æµ | é»˜è®¤æ¨è |
| æ»‘åŠ¨çª—å£ | æ›´ç²¾ç¡®ï¼Œå†…å­˜å ç”¨å¤§ | ç²¾ç¡®é™æµ |
| å›ºå®šçª—å£ | ç®€å•é«˜æ•ˆï¼Œæœ‰è¾¹ç•Œé—®é¢˜ | ç®€å•åœºæ™¯ |

### 5.2 ä½¿ç”¨æ–¹æ³•

```python
from server.core.rate_limiter import RateLimiter, rate_limit, RateLimitExceeded

# æ–¹å¼1ï¼šä½œä¸ºè£…é¥°å™¨
@rate_limit("api", rate=100)  # æ¯ç§’100æ¬¡
def handle_request():
    pass

# æ–¹å¼2ï¼šæ‰‹åŠ¨ä½¿ç”¨
limiter = RateLimiter.get("api", rate=100)

if limiter.allow(user_id):
    # å¤„ç†è¯·æ±‚
    pass
else:
    wait_time = limiter.get_wait_time(user_id)
    raise RateLimitExceeded("api", wait_time)
```

### 5.3 é…ç½®å‚æ•°

| å‚æ•° | è¯´æ˜ |
|------|------|
| rate | é€Ÿç‡ï¼ˆè¯·æ±‚/ç§’ï¼‰ |
| capacity | ä»¤ç‰Œæ¡¶å®¹é‡ |
| algorithm | ç®—æ³•ç±»å‹ |

---

## å…­ã€å¥åº·æ£€æŸ¥

### 6.1 æ£€æŸ¥ç±»å‹

| ç±»å‹ | è¯´æ˜ | é€‚ç”¨æœåŠ¡ |
|------|------|----------|
| TCP | TCP è¿æ¥æ£€æŸ¥ | æ‰€æœ‰ gRPC æœåŠ¡ |
| HTTP | HTTP ç«¯ç‚¹æ£€æŸ¥ | REST API æœåŠ¡ |
| gRPC | gRPC å¥åº·æ£€æŸ¥ | gRPC æœåŠ¡ï¼ˆéœ€æ”¯æŒï¼‰ |
| CUSTOM | è‡ªå®šä¹‰æ£€æŸ¥ | ç‰¹æ®Šåœºæ™¯ |

### 6.2 ä½¿ç”¨æ–¹æ³•

```python
from server.core.health_checker import get_health_checker, CheckType

# è·å–å¥åº·æ£€æŸ¥å™¨
checker = get_health_checker()

# æ³¨å†ŒæœåŠ¡æ£€æŸ¥
checker.register("bazi-core", "localhost", 9001, CheckType.TCP)
checker.register("web-api", "localhost", 8001, CheckType.HTTP, "/health")

# å¯åŠ¨å®šæœŸæ£€æŸ¥
checker.start()

# è·å–æœåŠ¡çŠ¶æ€
result = checker.get_status("bazi-core")
print(f"çŠ¶æ€: {result.status.value}, å»¶è¿Ÿ: {result.latency}ms")

# ç«‹å³æ£€æŸ¥
result = checker.check_service("bazi-core")
```

### 6.3 é…ç½®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| interval | 30ç§’ | æ£€æŸ¥é—´éš” |
| timeout | 5ç§’ | è¶…æ—¶æ—¶é—´ |
| healthy_threshold | 2 | å¥åº·é˜ˆå€¼ |
| unhealthy_threshold | 3 | ä¸å¥åº·é˜ˆå€¼ |

---

## ä¸ƒã€æ²»ç† API

### 7.1 API åˆ—è¡¨

| è·¯å¾„ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/v1/governance/registry` | GET | è·å–æ³¨å†Œä¸­å¿ƒçŠ¶æ€ |
| `/api/v1/governance/registry/{name}` | GET | è·å–å•ä¸ªæœåŠ¡çŠ¶æ€ |
| `/api/v1/governance/circuit-breakers` | GET | è·å–ç†”æ–­å™¨çŠ¶æ€ |
| `/api/v1/governance/circuit-breakers/{name}/reset` | POST | é‡ç½®ç†”æ–­å™¨ |
| `/api/v1/governance/rate-limiters` | GET | è·å–é™æµå™¨çŠ¶æ€ |
| `/api/v1/governance/health` | GET | è·å–å¥åº·çŠ¶æ€ |
| `/api/v1/governance/health/{name}` | GET | è·å–å•ä¸ªæœåŠ¡å¥åº· |
| `/api/v1/governance/health/{name}/check` | POST | ç«‹å³æ£€æŸ¥æœåŠ¡ |
| `/api/v1/governance/dashboard` | GET | è·å–ä»ªè¡¨æ¿æ•°æ® |

### 7.2 ä½¿ç”¨ç¤ºä¾‹

```bash
# è·å–æœåŠ¡æ³¨å†Œä¸­å¿ƒçŠ¶æ€
curl http://localhost:8001/api/v1/governance/registry

# è·å–ç†”æ–­å™¨çŠ¶æ€
curl http://localhost:8001/api/v1/governance/circuit-breakers

# é‡ç½®ç†”æ–­å™¨
curl -X POST http://localhost:8001/api/v1/governance/circuit-breakers/bazi-core/reset

# è·å–å¥åº·çŠ¶æ€
curl http://localhost:8001/api/v1/governance/health

# è·å–ä»ªè¡¨æ¿æ•°æ®
curl http://localhost:8001/api/v1/governance/dashboard
```

---

## å…«ã€æœ€ä½³å®è·µ

### 8.1 ç†”æ–­å™¨é…ç½®å»ºè®®

| æœåŠ¡ç±»å‹ | failure_threshold | timeout | è¯´æ˜ |
|----------|-------------------|---------|------|
| æ ¸å¿ƒæœåŠ¡ | 3-5 | 10-30ç§’ | å¿«é€Ÿç†”æ–­ï¼Œå¿«é€Ÿæ¢å¤ |
| éæ ¸å¿ƒæœåŠ¡ | 5-10 | 30-60ç§’ | å®¹å¿æ›´å¤šå¤±è´¥ |
| å¤–éƒ¨ API | 3 | 5-10ç§’ | å¤–éƒ¨æœåŠ¡ä¸å¯æ§ï¼Œå¿«é€Ÿç†”æ–­ |

### 8.2 é™æµé…ç½®å»ºè®®

| API ç±»å‹ | rate | è¯´æ˜ |
|----------|------|------|
| ç™»å½•æ¥å£ | 5/åˆ†é’Ÿ | é˜²æ­¢æš´åŠ›ç ´è§£ |
| è®¡ç®—æ¥å£ | 100/å°æ—¶ | é˜²æ­¢èµ„æºæ»¥ç”¨ |
| æŸ¥è¯¢æ¥å£ | 1000/å°æ—¶ | ç›¸å¯¹å®½æ¾ |

### 8.3 å¥åº·æ£€æŸ¥å»ºè®®

- æ ¸å¿ƒæœåŠ¡ï¼šTCP æ£€æŸ¥ï¼Œé—´éš” 10-30 ç§’
- Web æœåŠ¡ï¼šHTTP æ£€æŸ¥ï¼Œæ£€æŸ¥ `/health` ç«¯ç‚¹
- å¤–éƒ¨ä¾èµ–ï¼šé€‚å½“å¢åŠ è¶…æ—¶æ—¶é—´

---

## ä¹ã€æ•…éšœå¤„ç†

### 9.1 æœåŠ¡ä¸å¯ç”¨

1. æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨
2. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
3. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
4. æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€

### 9.2 ç†”æ–­å™¨è§¦å‘

1. æŸ¥çœ‹ç†”æ–­å™¨ç»Ÿè®¡ä¿¡æ¯
2. æ£€æŸ¥ç›®æ ‡æœåŠ¡å¥åº·çŠ¶æ€
3. å¿…è¦æ—¶æ‰‹åŠ¨é‡ç½®ç†”æ–­å™¨
4. åˆ†æå¤±è´¥åŸå› 

### 9.3 é™æµè§¦å‘

1. æŸ¥çœ‹é™æµå™¨ç»Ÿè®¡ä¿¡æ¯
2. åˆ†æè¯·æ±‚æ¥æº
3. è°ƒæ•´é™æµé…ç½®
4. è€ƒè™‘æ‰©å®¹

---

## åã€ç›‘æ§å’Œå‘Šè­¦

### 10.1 å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | é˜ˆå€¼ | è¯´æ˜ |
|------|------|------|
| æœåŠ¡å¥åº·ç‡ | < 80% | å‘Šè­¦ |
| ç†”æ–­å™¨æ‰“å¼€æ•° | > 0 | å‘Šè­¦ |
| é™æµæ‹’ç»ç‡ | > 10% | å‘Šè­¦ |
| æœåŠ¡å“åº”æ—¶é—´ | > 1ç§’ | å‘Šè­¦ |

### 10.2 æ—¥å¿—ç›‘æ§

```bash
# æŸ¥çœ‹æœåŠ¡æ²»ç†æ—¥å¿—
grep "ç†”æ–­å™¨" logs/server_8001.log
grep "é™æµ" logs/server_8001.log
grep "å¥åº·æ£€æŸ¥" logs/server_8001.log
```

---

## åä¸€ã€ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|------|------|------|
| 1.0.0 | 2025-12-11 | åˆå§‹ç‰ˆæœ¬ |
