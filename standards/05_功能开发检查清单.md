# ✅ HiFate-bazi 功能开发检查清单

## 一、开发前检查

### 1.1 需求确认

- [ ] 需求文档已确认
- [ ] 验收标准已明确
- [ ] 影响范围已评估
- [ ] 技术方案已确定

### 1.2 环境准备

- [ ] 开发环境正常
- [ ] 数据库连接正常
- [ ] 依赖包已安装
- [ ] 测试环境可用

---

## 二、开发中检查

### 2.1 代码规范

- [ ] 文件命名符合规范（`{name}_api.py`, `{name}_service.py`）
- [ ] 类命名使用 PascalCase（`CalendarAPIService`）
- [ ] 函数命名使用 snake_case（`get_calendar_data`）
- [ ] 变量命名使用 snake_case（`lunar_date`）
- [ ] 常量命名使用 UPPER_SNAKE_CASE（`MAX_RETRY_COUNT`）

### 2.2 文件创建

| 文件类型 | 位置 | 是否创建 |
|---------|------|----------|
| API 路由 | `server/api/v1/{name}_api.py` | [ ] |
| 业务服务 | `server/services/{name}_service.py` | [ ] |
| 单元测试 | `tests/unit/test_{name}.py` | [ ] |
| API 测试 | `tests/api/test_{name}_api.py` | [ ] |

### 2.3 注册配置

- [ ] gRPC 端点已注册（`server/api/grpc_gateway.py`）
- [ ] 路由已注册（`server/main.py`）
- [ ] 配置项已添加（如需要）

### 2.4 流式接口（若为流式分析接口）

- [ ] 继承 `BaseAnalysisStreamHandler`（`server.api.base.stream_handler`）
- [ ] 使用 `StreamChunk` / `BaseResponse` 统一格式（`server.api.v1.models.base_response`）
- [ ] 场景配置已注册至 `server.orchestrators.modules_config.get_modules_config()`
- [ ] 无重复的数据获取/组装逻辑，统一通过 `BaziDataOrchestrator.fetch_data()`

### 2.5 数据模型

- [ ] 请求模型命名：`{Name}Request`
- [ ] 响应模型命名：`{Name}Response`
- [ ] 字段 description 已填写
- [ ] 字段验证规则已添加

---

## 三、测试检查

### 3.1 单元测试

- [ ] 正常流程测试（happy path）
- [ ] 边界条件测试（空值、极端值）
- [ ] 异常处理测试（错误输入）
- [ ] Mock 外部依赖

### 3.2 API 测试

- [ ] 200 成功响应测试
- [ ] 400 参数错误测试
- [ ] 500 服务器错误测试

### 3.3 测试运行

```bash
# 运行单元测试
pytest tests/unit/test_{name}.py -v

# 查看覆盖率
pytest tests/unit/test_{name}.py --cov=server/services/{name}_service.py
```

- [ ] 所有测试通过
- [ ] 覆盖率 > 80%

---

## 四、代码审查检查

### 4.1 代码质量

- [ ] 无明显 Bug
- [ ] 无重复代码
- [ ] 逻辑清晰
- [ ] 异常处理完善

### 4.2 性能

- [ ] 无明显性能问题
- [ ] 数据库查询已优化
- [ ] 缓存已考虑（如需要）

### 4.2.1 缓存有效性（必检）

- [ ] 缓存 key 中**无高精度时间戳**（禁止 `isoformat()`、`time.time()`，最多精确到小时 `strftime('%Y-%m-%dT%H')`）
- [ ] 缓存 key 的 get/set 使用**相同的生成逻辑**（读写一致）
- [ ] TTL 设置合理（匹配数据变化频率：日级数据用 24h，小时级数据用 1h）
- [ ] 修改涉及缓存时，已搜索 `cache_key`、`_generate_cache_key`、`CacheKeyGenerator` 确认无遗漏
- [ ] 缓存命中率目标 ≥ 98%，新增缓存需通过日志验证实际命中率

### 4.3 安全

- [ ] 输入验证完善
- [ ] SQL 注入防护（使用参数化查询）
- [ ] 敏感信息不在日志中输出

### 4.4 日志

- [ ] 关键操作有日志
- [ ] 错误有详细日志
- [ ] 日志级别正确

---

## 五、提交前检查

### 5.1 代码检查

```bash
# 代码风格检查
flake8 server/api/v1/{name}_api.py server/services/{name}_service.py --max-line-length=120

# 运行所有测试
pytest tests/ -v
```

- [ ] flake8 检查通过
- [ ] 所有测试通过

### 5.2 文档更新

- [ ] API 文档已更新（如需要）
- [ ] README 已更新（如需要）
- [ ] 配置说明已更新（如需要）

### 5.3 Git 提交

```bash
# 提交格式
git commit -m "[新增] {功能描述}"
```

- [ ] 提交信息符合规范
- [ ] 只提交相关文件

---

## 六、部署后检查

### 6.1 功能验证

- [ ] 功能正常工作
- [ ] 日志输出正常
- [ ] 无报错

### 6.2 监控

- [ ] 接口可访问
- [ ] 响应时间正常
- [ ] 无异常错误

---

## 七、快速检查清单（简化版）

开发完成后，快速确认以下事项：

```
□ API 文件已创建 (server/api/v1/)
□ Service 文件已创建 (server/services/)
□ gRPC 端点已注册 (grpc_gateway.py)
□ 路由已注册 (main.py)
□ 单元测试已编写 (tests/unit/)
□ 测试全部通过
□ 代码风格检查通过
□ 缓存 key 无高精度时间戳（命中率 ≥ 98%）
```

---

## 八、检查清单模板

### 新功能：________________

**日期**：________________
**开发者**：________________

#### 开发检查

- [ ] API 文件创建
- [ ] Service 文件创建
- [ ] gRPC 注册
- [ ] 路由注册
- [ ] 单元测试

#### 测试检查

- [ ] 正常流程测试
- [ ] 边界测试
- [ ] 异常测试
- [ ] 测试通过

#### 审查检查

- [ ] 代码风格
- [ ] 无 Bug
- [ ] 性能正常
- [ ] 安全检查

#### 部署检查

- [ ] 功能正常
- [ ] 日志正常
- [ ] 无报错

**备注**：
________________
