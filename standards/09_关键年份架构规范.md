# 09 关键年份架构规范

> 统一所有流式接口的关键年份数据来源和业务筛选策略

---

## 核心原则

1. **数据层统一**：所有接口的关键年份数据必须来自同一个源头，与 `/api/v1/bazi/fortune/display`（专业排盘）完全一致
2. **业务层差异化**：每个接口根据业务视角选择关键大运，采用策略模式可扩展
3. **禁止自行计算**：任何流式接口不得绕过 `BaziDataOrchestrator` 自行计算特殊流年

---

## 架构总览

```
                ┌─────────────────────────────────────────┐
                │       BaziDetailService                  │
                │  .calculate_detail_full()                │
                │  → liunian_sequence (每个流年含 relations)│
                │  ← 与 fortune/display 完全一致           │
                └──────────────┬──────────────────────────┘
                               │
                ┌──────────────▼──────────────────────────┐
                │   BaziDataOrchestrator (Phase 2)         │
                │   → SpecialLiunianService                │
                │   → 过滤 relations 非空的流年             │
                │   → 返回 special_liunians.list            │
                └──────────────┬──────────────────────────┘
                               │
                ┌──────────────▼──────────────────────────┐
                │   KeyYearsProvider（统一入口）             │
                │                                          │
                │   数据层（统一）：                         │
                │   ├─ classify_liunians()    按类型分类     │
                │   ├─ organize_by_dayun()    按大运分组     │
                │   └─ get_current_dayun()    确定当前大运   │
                │                                          │
                │   业务层（差异化）：                       │
                │   ├─ health     → 五行病理冲突            │
                │   ├─ marriage   → 感情星透出              │
                │   ├─ career     → 官星/财星透出           │
                │   ├─ children   → 食伤星透出              │
                │   └─ default    → 距离优先级              │
                └──────────────┬──────────────────────────┘
                               │
        ┌──────────┬───────────┼───────────┬──────────┐
        ▼          ▼           ▼           ▼          ▼
    健康分析    婚姻分析    事业财富    子女学习    总评/年报
```

---

## 数据层规范

### 数据源头

| 组件 | 说明 |
|------|------|
| `BaziDetailService.calculate_detail_full()` | 最终数据源头，计算所有大运流年及 relations |
| `core/calculators/bazi_calculator_docs.py._calculate_liunian_relations()` | 计算岁运并临、天克地冲、天合地合 |
| `SpecialLiunianService.get_special_liunians_batch()` | 过滤 relations 非空的流年，不做任何计算 |

### 数据流转路径（唯一合法路径）

```
BaziDataOrchestrator.fetch_data(modules={'special_liunians': {...}})
  → Phase 1: detail_task → BaziDetailService.calculate_detail_full()
  → Phase 2: _fetch_special_liunians(dayun_sequence, liunian_sequence)
    → SpecialLiunianService.get_special_liunians_batch()
    → 返回 {'list': [...], 'by_dayun': {...}, 'formatted': '...'}
```

### 禁止的数据获取方式

- ❌ 接口内部直接调用 `BaziDetailService.calculate_detail_full()`
- ❌ 接口内部直接调用 `BaziDisplayService.get_fortune_display()`
- ❌ 接口内部自行过滤 `liunian_sequence.relations`
- ❌ 使用 `FortuneContextService` 的 `key_liunians`（该字段已废弃，现通过 special_liunians 注入）

---

## 业务层规范

### 策略注册表

所有业务策略在 `server/utils/key_years_provider.py` 的 `BUSINESS_SELECTORS` 中注册：

| 业务类型 | 策略 | 选择依据 | 适用接口 |
|----------|------|----------|----------|
| `default` | 距离优先级 | 当前大运最近的 10 个大运 | 总评、年报 |
| `health` | 五行病理 | 水土混战、水火交战、金木相战等 | 健康分析 |
| `marriage` | 感情星 | 正财/偏财(男)、正官/七杀(女)、桃花 | 婚姻分析 |
| `career` / `career_wealth` | 官财星 | 正官/七杀/正财/偏财/正印/偏印 | 事业财富 |
| `children` / `children_study` | 食伤星 | 食神/伤官(女)/正官/七杀(男) | 子女学习 |
| `general_review` | 距离优先级 | 同 default | 总评分析 |
| `annual_report` | 距离优先级 | 同 default | 年运报告 |
| `smart_fortune` | 距离优先级 | 同 default | 智能运势 |

### 调用方式

```python
# 方式一：通过 build_enhanced_dayun_structure（推荐，保持与现有 prompt_builders 兼容）
from server.utils.dayun_liunian_helper import build_enhanced_dayun_structure

enhanced = build_enhanced_dayun_structure(
    dayun_sequence=dayun_sequence,
    special_liunians=special_liunians,  # 必须来自 orchestrator
    current_age=current_age,
    business_type='marriage',           # 业务类型
    bazi_data=bazi_data,                # 十神计算需要日主天干
    gender=gender                       # 婚姻分析需要
)

current_dayun = enhanced['current_dayun']
key_dayuns = enhanced['key_dayuns']


# 方式二：直接使用 KeyYearsProvider（健康分析使用此方式，返回 dict 格式 liunians）
from server.utils.key_years_provider import KeyYearsProvider

result = KeyYearsProvider.build_key_years_structure(
    dayun_sequence=dayun_sequence,
    special_liunians=special_liunians,  # 必须来自 orchestrator
    current_age=current_age,
    business_type='health',
    bazi_data=bazi_data,
    gender=gender,
)

current_dayun = result['current_dayun']
key_dayuns = result['key_dayuns']
```

---

## 新增业务类型指南（快速开发）

### 步骤

1. **在 `key_years_provider.py` 中添加筛选函数**：

```python
def _select_xxx_key_dayuns(
    dayun_sequence, current_dayun, current_age,
    bazi_data=None, gender='male', **kwargs
) -> List[Dict]:
    """xxx 分析关键大运选择"""
    day_stem = bazi_data.get('bazi_pillars', {}).get('day', {}).get('stem', '')
    
    key_dayuns = []
    for dayun in dayun_sequence:
        # 你的业务逻辑...
        if should_select:
            dayun_copy = dayun.copy()
            dayun_copy['relation_type'] = '...'
            dayun_copy['business_reason'] = '...'
            key_dayuns.append(dayun_copy)
    
    return key_dayuns
```

2. **在 `BUSINESS_SELECTORS` 中注册**：

```python
BUSINESS_SELECTORS['xxx'] = _select_xxx_key_dayuns
```

3. **在 `modules_config.py` 中添加配置**：

```python
'xxx': {
    'bazi': True,
    'wangshuai': True,
    'detail': True,
    'special_liunians': {
        'dayun_config': {'mode': 'current_with_neighbors'},
        'target_years': [2025, 2026, 2027]
    },
    'rules': {'types': ['xxx']}
},
```

4. **在流式接口中调用**：

```python
enhanced = build_enhanced_dayun_structure(
    ...,
    business_type='xxx',
    bazi_data=bazi_data,
    gender=gender
)
```

### 总耗时：约 30 分钟即可完成新业务类型接入

---

## 模块配置（modules_config.py）

所有需要关键年份的流式接口必须在 modules 中包含 `special_liunians`：

```python
'special_liunians': {
    'dayun_config': {'mode': 'current_with_neighbors'},  # 或 {'mode': 'count', 'count': 13}
    'target_years': [2025, 2026, 2027]                   # 关注的目标年份
}
```

---

## 关键文件索引

| 文件 | 作用 |
|------|------|
| `server/utils/key_years_provider.py` | **统一入口**：数据层 + 业务层策略 |
| `server/utils/dayun_liunian_helper.py` | 增强结构构建（含元数据、优先级） |
| `server/services/special_liunian_service.py` | 特殊流年过滤服务 |
| `server/orchestrators/modules_config.py` | 模块配置（含 special_liunians 参数） |
| `server/orchestrators/bazi_data_orchestrator.py` | 数据编排（Phase 2 获取 special_liunians） |
| `core/calculators/bazi_calculator_docs.py` | 底层关系计算（_calculate_liunian_relations） |
| `server/utils/prompt_builders.py` | LLM 提示词构建（使用关键年份数据） |

---

## 各接口关键年份使用现状

| 接口 | business_type | 数据来源 | 关键大运选择 |
|------|---------------|----------|-------------|
| 健康分析 | `health` | orchestrator.special_liunians | 五行病理冲突 |
| 婚姻分析 | `marriage` | orchestrator.special_liunians | 感情星透出 |
| 事业财富 | `career_wealth` | orchestrator.special_liunians | 官星/财星透出 |
| 子女学习 | `children_study` | orchestrator.special_liunians | 食伤星透出 |
| 总评分析 | `general_review` | orchestrator.special_liunians | 距离优先级 |
| 年运报告 | `annual_report` | orchestrator.special_liunians | 全量大运 |
| 智能运势 | `smart_fortune` | orchestrator.special_liunians → fortune_context.key_liunians | 距离优先级 |
| 五行占比 | - | 不需要 | - |
| 喜神忌神 | - | 不需要 | - |
| 每日运势 | - | 不需要 | - |

---

## 变更历史

| 日期 | 变更 |
|------|------|
| 2026-02-10 | 初始版本：统一关键年份架构，数据层 + 业务层分离 |
