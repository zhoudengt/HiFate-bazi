# 流式接口开发规范

## 一、概述

本规范适用于所有基于八字数据的流式分析接口（SSE），确保代码复用、行为一致、易于维护。

## 二、核心原则

### 2.1 必须继承 BaseAnalysisStreamHandler

**新流式接口必须**继承 `server.api.base.stream_handler.BaseAnalysisStreamHandler`，不得复制粘贴 SSE 格式化、LLM 缓存、服务创建等通用逻辑。

### 2.2 子类仅实现场景特有逻辑

子类需覆盖以下方法/属性：

| 成员 | 必须 | 说明 |
|------|------|------|
| `scene` | 是 | 场景名，如 `wuxing_proportion`、`marriage` |
| `function_type` | 是 | 交互日志类型，如 `wuxing` |
| `function_name` | 是 | 交互日志名称，如 `八字命理-五行占比分析` |
| `frontend_api` | 是 | 前端 API 路径，如 `/api/v1/bazi/wuxing-proportion/stream` |
| `get_modules()` | 是 | 返回 BaziDataOrchestrator.fetch_data 的 modules 配置 |
| `extract_and_validate()` | 是 | 从 unified_data 提取并验证数据，失败时 raise ValueError |
| `format_for_llm()` | 是 | 将提取的数据格式化为 LLM 输入文本 |
| `get_llm_cache_key()` | 是 | 生成 LLM 缓存 key |
| `get_initial_data_chunk()` | 否 | 可选的首个 data 块（如五行占比完整数据），默认 None |
| `validate_request()` | 否 | 前置校验（如 bot_id 配置），默认 None |
| `get_cache_namespace()` | 否 | 缓存命名空间，默认 `llm-{scene}` |
| `get_cached_llm()` / `set_cached_llm()` | 否 | 可覆盖以使用 stream_cache_helper 等不同缓存实现 |

### 2.3 禁止行为

- 禁止在新接口中复制粘贴 SSE 格式化逻辑
- 禁止在新接口中重复实现 LLM 缓存读写
- 禁止在新接口中重复实现 LLM 服务创建
- 禁止绕过 `BaziDataOrchestrator.fetch_data()` 获取数据

## 三、标准 8 步流程（由基类实现）

```
1. 输入处理 → BaziInputProcessor.process_input()
2. 数据获取 → BaziDataOrchestrator.fetch_data()
3. 数据提取与验证 → 子类 extract_and_validate()
4. 可选：发送初始 data 块 → 子类 get_initial_data_chunk()
5. LLM 缓存检查 → 子类 get_cached_llm()
6. LLM 服务创建与流式生成 → LLMServiceFactory.get_service()
7. SSE 格式化输出
8. 交互日志
```

## 四、参考实现

五行占比分析（`server.api.v1.wuxing_proportion.WuxingStreamHandler`）为参考实现，包含：

- 有初始 data 块（完整五行占比数据）
- 使用 api_cache_helper 进行 LLM 缓存
- 自定义 get_cache_namespace 保持与旧实现兼容

## 五、场景配置唯一权威源

流式分析场景的 modules 配置**唯一权威源**为 `server.orchestrators.modules_config.get_modules_config()`。

禁止使用 `server.utils.analysis_api_helper.get_modules_config`（已废弃）。

## 六、迁移现有接口

对 marriage、health、career_wealth、children_study、general_review 等现有流式接口，迁移步骤：

1. 创建对应 Handler 子类
2. 实现 `get_modules`、`extract_and_validate`、`format_for_llm`、`get_llm_cache_key`
3. 如需 stream_cache_helper，覆盖 `get_cached_llm`、`set_cached_llm`
4. 将 stream 端点改为调用 `handler.stream_generator(request, bot_id=..., trace_id=...)`
5. 运行回归测试验证
