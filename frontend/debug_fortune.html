<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§è¿æµå¹´è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-panel h2 {
            margin-top: 0;
            color: #333;
        }
        .debug-panel button {
            padding: 10px 20px;
            margin: 5px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .debug-panel button:hover {
            background: #357abd;
        }
        .log-area {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-error {
            color: #f48771;
        }
        .log-success {
            color: #4ec9b0;
        }
        .log-info {
            color: #569cd6;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” å¤§è¿æµå¹´è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-panel">
        <h2>1. æµ‹è¯•å‚æ•°</h2>
        <div>
            <label>å‡ºç”Ÿæ—¥æœŸ: <input type="date" id="solar_date" value="1990-01-01"></label>
            <label>å‡ºç”Ÿæ—¶é—´: <input type="time" id="solar_time" value="12:00"></label>
            <label>æ€§åˆ«: 
                <select id="gender">
                    <option value="male">ç”·</option>
                    <option value="female">å¥³</option>
                </select>
            </label>
        </div>
        <button onclick="testInitialLoad()">æµ‹è¯•åˆå§‹åŠ è½½</button>
        <button onclick="testDayunClick()">æµ‹è¯•ç‚¹å‡»å¤§è¿</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="debug-panel">
        <h2>2. è°ƒè¯•æ—¥å¿—</h2>
        <div id="log" class="log-area">ç­‰å¾…æ“ä½œ...</div>
    </div>
    
    <script>
        const API_BASE = 'http://127.0.0.1:8001/api/v1';
        const logArea = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = `log-${type}`;
            logArea.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            logArea.innerHTML = '';
        }
        
        async function testInitialLoad() {
            log('å¼€å§‹æµ‹è¯•åˆå§‹åŠ è½½...', 'info');
            const solar_date = document.getElementById('solar_date').value;
            const solar_time = document.getElementById('solar_time').value;
            const gender = document.getElementById('gender').value;
            
            try {
                const response = await fetch(`${API_BASE}/bazi/fortune/display`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        solar_date,
                        solar_time,
                        gender,
                        current_time: new Date().toISOString().slice(0, 16).replace('T', ' ')
                    })
                });
                
                const data = await response.json();
                log(`å“åº”çŠ¶æ€: ${response.status}`, response.status === 200 ? 'success' : 'error');
                log(`å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.success) {
                    const dayunList = data.dayun?.list || [];
                    const liunianList = data.liunian?.list || [];
                    log(`å¤§è¿æ•°é‡: ${dayunList.length}`, 'success');
                    log(`æµå¹´æ•°é‡: ${liunianList.length}`, 'success');
                    
                    if (dayunList.length > 0) {
                        log(`ç¬¬ä¸€ä¸ªå¤§è¿: ${JSON.stringify(dayunList[0], null, 2)}`, 'info');
                    }
                    if (liunianList.length > 0) {
                        const years = liunianList.map(item => item.year).filter(Boolean);
                        log(`æµå¹´å¹´ä»½èŒƒå›´: ${Math.min(...years)} - ${Math.max(...years)}`, 'info');
                        log(`æµå¹´åˆ—è¡¨: ${JSON.stringify(liunianList.map(item => ({year: item.year, ganzhi: item.ganzhi})), null, 2)}`, 'info');
                    }
                }
            } catch (error) {
                log(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testDayunClick() {
            log('å¼€å§‹æµ‹è¯•ç‚¹å‡»å¤§è¿...', 'info');
            const solar_date = document.getElementById('solar_date').value;
            const solar_time = document.getElementById('solar_time').value;
            const gender = document.getElementById('gender').value;
            
            // å…ˆè·å–å¤§è¿åˆ—è¡¨
            try {
                const initResponse = await fetch(`${API_BASE}/bazi/fortune/display`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        solar_date,
                        solar_time,
                        gender,
                        current_time: new Date().toISOString().slice(0, 16).replace('T', ' ')
                    })
                });
                
                const initData = await initResponse.json();
                if (!initData.success || !initData.dayun?.list || initData.dayun.list.length === 0) {
                    log('æ— æ³•è·å–å¤§è¿åˆ—è¡¨', 'error');
                    return;
                }
                
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªéå°è¿çš„å¤§è¿
                const targetDayun = initData.dayun.list.find(item => 
                    item.ganzhi && item.ganzhi !== 'å°è¿' && item.year_range
                ) || initData.dayun.list[1]; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œä½¿ç”¨ç¬¬äºŒä¸ªï¼ˆé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªå¤§è¿ï¼‰
                
                if (!targetDayun) {
                    log('æ‰¾ä¸åˆ°ç›®æ ‡å¤§è¿', 'error');
                    return;
                }
                
                log(`é€‰æ‹©çš„å¤§è¿: ${JSON.stringify(targetDayun, null, 2)}`, 'info');
                
                const yearStart = targetDayun.year_range?.start;
                const yearEnd = targetDayun.year_range?.end;
                
                log(`ä¼ é€’å‚æ•°: dayun_year_start=${yearStart}, dayun_year_end=${yearEnd}`, 'info');
                
                // æµ‹è¯•ç‚¹å‡»å¤§è¿
                const clickResponse = await fetch(`${API_BASE}/bazi/fortune/display`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        solar_date,
                        solar_time,
                        gender,
                        current_time: new Date().toISOString().slice(0, 16).replace('T', ' '),
                        dayun_year_start: yearStart,
                        dayun_year_end: yearEnd
                    })
                });
                
                const clickData = await clickResponse.json();
                log(`ç‚¹å‡»åå“åº”çŠ¶æ€: ${clickResponse.status}`, clickResponse.status === 200 ? 'success' : 'error');
                
                if (clickData.success) {
                    const liunianList = clickData.liunian?.list || [];
                    log(`ç‚¹å‡»åæµå¹´æ•°é‡: ${liunianList.length}`, 'success');
                    
                    if (liunianList.length > 0) {
                        const years = liunianList.map(item => item.year).filter(Boolean);
                        const minYear = Math.min(...years);
                        const maxYear = Math.max(...years);
                        log(`ç‚¹å‡»åæµå¹´å¹´ä»½èŒƒå›´: ${minYear} - ${maxYear}`, 'info');
                        log(`æœŸæœ›å¹´ä»½èŒƒå›´: ${yearStart} - ${yearEnd}`, 'info');
                        
                        if (minYear === yearStart && maxYear === yearEnd) {
                            log('âœ… æµå¹´èŒƒå›´åŒ¹é…ï¼', 'success');
                        } else {
                            log('âŒ æµå¹´èŒƒå›´ä¸åŒ¹é…ï¼', 'error');
                            log(`å®é™…å¹´ä»½: ${years.join(', ')}`, 'error');
                            log(`æœŸæœ›å¹´ä»½: ${Array.from({length: yearEnd - yearStart + 1}, (_, i) => yearStart + i).join(', ')}`, 'error');
                        }
                    }
                } else {
                    log(`ç‚¹å‡»åå“åº”é”™è¯¯: ${clickData.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                log(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            log('è°ƒè¯•å·¥å…·å·²åŠ è½½ï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>

