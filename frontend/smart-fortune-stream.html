<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¿åŠ¿åˆ†æ - æµå¼ç‰ˆï¼ˆä½“éªŒä¼˜åŒ–ï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .analyze-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            display: none;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .progress-container.active {
            display: block;
        }

        .progress-stage {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .progress-stage.current {
            border-left: 4px solid #667eea;
            background: #f0f4ff;
        }

        .progress-stage.completed {
            opacity: 0.6;
        }

        .progress-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2em;
        }

        .progress-icon.loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            animation: spin 1s linear infinite;
        }

        .progress-icon.completed {
            background: #4caf50;
            color: white;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ç»“æœå±•ç¤ºæ ·å¼ */
        .result-container {
            display: none;
        }

        .result-container.active {
            display: block;
        }

        .result-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .result-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .bazi-pillars {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .pillar {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .pillar-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .pillar-chars {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }

        /* LLMæ·±åº¦åˆ†ææ ·å¼ */
        .llm-analysis {
            background: white;
            padding: 20px;
            border-radius: 10px;
            min-height: 100px;
            line-height: 1.8;
            font-size: 1.05em;
            color: #333;
        }

        .llm-analysis.streaming {
            border-left: 4px solid #4caf50;
        }

        .llm-analysis .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #4caf50;
            animation: blink 1s infinite;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .llm-loading {
            text-align: center;
            color: #999;
            padding: 40px;
            font-style: italic;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-dots {
            display: inline-block;
        }

        .loading-dots span {
            animation: blink 1.4s infinite;
            animation-fill-mode: both;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* é”™è¯¯æç¤º */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #c62828;
        }

        /* ç¤ºä¾‹é—®é¢˜ */
        .example-questions {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .example-tag {
            display: inline-block;
            background: white;
            padding: 6px 12px;
            border-radius: 15px;
            margin: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            border: 1px solid #e0e0e0;
        }

        .example-tag:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”® æ™ºèƒ½è¿åŠ¿åˆ†æ</h1>
            <div class="badge">âš¡ æµå¼è¾“å‡ºç‰ˆ - ç§’çº§å“åº”</div>
            <p>åŸºäºAIæ„å›¾è¯†åˆ« + LLMæ·±åº¦è§£è¯»</p>
        </div>

        <!-- è¾“å…¥è¡¨å• -->
        <div class="card">
            <div class="form-group">
                <label>â“ æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ</label>
                <textarea id="question" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ˜å¹´çš„è´¢è¿æ€ä¹ˆæ ·ï¼Ÿ"></textarea>
            </div>

            <div class="example-questions">
                <strong>ğŸ’¡ ç¤ºä¾‹é—®é¢˜ï¼š</strong>
                <span class="example-tag" onclick="fillExample('æˆ‘æ˜å¹´çš„è´¢è¿æ€ä¹ˆæ ·ï¼Ÿ')">æ˜å¹´è´¢è¿</span>
                <span class="example-tag" onclick="fillExample('åå¹´çš„äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ')">åå¹´äº‹ä¸š</span>
                <span class="example-tag" onclick="fillExample('ä»Šå¹´é€‚åˆæŠ•èµ„å—ï¼Ÿ')">ä»Šå¹´æŠ•èµ„</span>
                <span class="example-tag" onclick="fillExample('æœ€è¿‘çš„å¥åº·çŠ¶å†µ')">æœ€è¿‘å¥åº·</span>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ“… å‡ºç”Ÿå¹´ä»½</label>
                    <input type="number" id="year" value="1990" min="1900" max="2100">
                </div>
                <div class="form-group">
                    <label>ğŸ“… å‡ºç”Ÿæœˆä»½</label>
                    <input type="number" id="month" value="5" min="1" max="12">
                </div>
                <div class="form-group">
                    <label>ğŸ“… å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="number" id="day" value="15" min="1" max="31">
                </div>
                <div class="form-group">
                    <label>â° å‡ºç”Ÿæ—¶è¾°</label>
                    <input type="number" id="hour" value="14" min="0" max="23">
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ‘¤ æ€§åˆ«</label>
                <select id="gender">
                    <option value="male">ç”·</option>
                    <option value="female">å¥³</option>
                </select>
            </div>

            <button class="analyze-btn" onclick="startAnalysis()">
                ğŸš€ å¼€å§‹åˆ†æ
            </button>
        </div>

        <!-- è¿›åº¦æ˜¾ç¤º -->
        <div class="card progress-container" id="progressContainer">
            <h3 style="margin-bottom: 20px;">ğŸ“Š åˆ†æè¿›åº¦</h3>
            <div id="progressStages"></div>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="card result-container" id="resultContainer">
            <!-- åŸºç¡€åˆ†æ -->
            <div class="result-section" id="basicAnalysisSection" style="display:none;">
                <h3>ğŸ“‹ åŸºç¡€åˆ†æ</h3>
                <div id="basicAnalysisContent"></div>
            </div>

            <!-- LLMæ·±åº¦è§£è¯» -->
            <div class="result-section" id="llmAnalysisSection" style="display:none;">
                <h3>ğŸ¤– AIæ·±åº¦è§£è¯»</h3>
                <div class="llm-analysis streaming" id="llmAnalysisContent">
                    <div class="llm-loading">
                        æ­£åœ¨ç”Ÿæˆæ·±åº¦åˆ†æ<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;

        function fillExample(question) {
            document.getElementById('question').value = question;
        }

        function startAnalysis() {
            // å…³é—­ä¹‹å‰çš„è¿æ¥
            if (eventSource) {
                eventSource.close();
            }

            // è·å–è¾“å…¥
            const question = document.getElementById('question').value.trim();
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;
            const day = document.getElementById('day').value;
            const hour = document.getElementById('hour').value;
            const gender = document.getElementById('gender').value;

            if (!question) {
                alert('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜');
                return;
            }

            // ç¦ç”¨æŒ‰é’®
            const btn = document.querySelector('.analyze-btn');
            btn.disabled = true;
            btn.textContent = 'â³ åˆ†æä¸­...';

            // æ˜¾ç¤ºè¿›åº¦å®¹å™¨
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.classList.add('active');

            // éšè—ç»“æœå®¹å™¨
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.classList.remove('active');
            document.getElementById('basicAnalysisSection').style.display = 'none';
            document.getElementById('llmAnalysisSection').style.display = 'none';

            // æ„å»ºAPI URL
            const apiUrl = `http://localhost:8000/api/v1/smart-fortune/smart-analyze-stream?` +
                `question=${encodeURIComponent(question)}` +
                `&year=${year}&month=${month}&day=${day}&hour=${hour}&gender=${gender}`;

            // åˆ›å»ºEventSourceè¿æ¥
            eventSource = new EventSource(apiUrl);

            // ç›‘å¬ä¸åŒç±»å‹çš„äº‹ä»¶
            eventSource.addEventListener('status', function(e) {
                const data = JSON.parse(e.data);
                updateProgress(data.stage, data.message);
            });

            eventSource.addEventListener('basic_analysis', function(e) {
                const data = JSON.parse(e.data);
                displayBasicAnalysis(data);
                resultContainer.classList.add('active');
            });

            eventSource.addEventListener('llm_start', function(e) {
                displayLLMStart();
            });

            eventSource.addEventListener('llm_chunk', function(e) {
                const data = JSON.parse(e.data);
                appendLLMChunk(data.content);
            });

            eventSource.addEventListener('llm_end', function(e) {
                finishLLMAnalysis();
            });

            eventSource.addEventListener('llm_error', function(e) {
                const data = JSON.parse(e.data);
                displayLLMError(data.message);
            });

            eventSource.addEventListener('error', function(e) {
                const data = JSON.parse(e.data);
                displayError(data.message);
                eventSource.close();
                enableButton();
            });

            eventSource.addEventListener('end', function(e) {
                eventSource.close();
                enableButton();
            });

            // é”™è¯¯å¤„ç†
            eventSource.onerror = function() {
                console.error('EventSource connection error');
                eventSource.close();
                displayError('è¿æ¥æ–­å¼€ï¼Œè¯·é‡è¯•');
                enableButton();
            };
        }

        function updateProgress(stage, message) {
            const stages = {
                'intent': {icon: 'ğŸ¯', text: 'æ„å›¾è¯†åˆ«'},
                'bazi': {icon: 'ğŸ“…', text: 'å…«å­—è®¡ç®—'},
                'rules': {icon: 'ğŸ“š', text: 'è§„åˆ™åŒ¹é…'},
                'fortune': {icon: 'ğŸŒŸ', text: 'æµå¹´å¤§è¿'},
                'llm': {icon: 'ğŸ¤–', text: 'AIæ·±åº¦è§£è¯»'}
            };

            let html = '';
            for (const [key, info] of Object.entries(stages)) {
                const isCurrent = key === stage;
                const isCompleted = Object.keys(stages).indexOf(key) < Object.keys(stages).indexOf(stage);
                
                html += `
                    <div class="progress-stage ${isCurrent ? 'current' : ''} ${isCompleted ? 'completed' : ''}">
                        <div class="progress-icon ${isCurrent ? 'loading' : ''} ${isCompleted ? 'completed' : ''}">
                            ${isCompleted ? 'âœ“' : info.icon}
                        </div>
                        <div>
                            <strong>${info.text}</strong>
                            ${isCurrent ? `<div style="font-size:0.9em;color:#666;">${message}</div>` : ''}
                        </div>
                    </div>
                `;
            }

            document.getElementById('progressStages').innerHTML = html;
        }

        function displayBasicAnalysis(data) {
            const section = document.getElementById('basicAnalysisSection');
            const content = document.getElementById('basicAnalysisContent');

            let html = '';

            // æ˜¾ç¤ºå…«å­—ä¿¡æ¯
            if (data.bazi_info && data.bazi_info['å››æŸ±']) {
                html += '<h4>ğŸ´ å››æŸ±å…«å­—</h4>';
                html += '<div class="bazi-pillars">';
                for (const [pillarName, pillarData] of Object.entries(data.bazi_info['å››æŸ±'])) {
                    html += `
                        <div class="pillar">
                            <div class="pillar-label">${pillarName}</div>
                            <div class="pillar-chars">${pillarData['å¤©å¹²']}<br>${pillarData['åœ°æ”¯']}</div>
                        </div>
                    `;
                }
                html += '</div>';
            }

            // æ˜¾ç¤ºæ„å›¾è¯†åˆ«ç»“æœ
            if (data.intent) {
                html += '<p style="margin-top:15px;"><strong>ğŸ¯ è¯†åˆ«æ„å›¾ï¼š</strong>' +
                    data.intent.intents.join(', ') +
                    ` (ç½®ä¿¡åº¦: ${(data.intent.confidence * 100).toFixed(1)}%)</p>`;
            }

            content.innerHTML = html;
            section.style.display = 'block';
        }

        function displayLLMStart() {
            const section = document.getElementById('llmAnalysisSection');
            const content = document.getElementById('llmAnalysisContent');
            
            content.innerHTML = '<span class="streaming-cursor"></span>';
            content.classList.add('streaming');
            section.style.display = 'block';

            // å¹³æ»‘æ»šåŠ¨åˆ°LLMåˆ†æåŒºåŸŸ
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function appendLLMChunk(text) {
            const content = document.getElementById('llmAnalysisContent');
            
            // ç§»é™¤å…‰æ ‡
            const cursor = content.querySelector('.streaming-cursor');
            if (cursor) {
                cursor.remove();
            }

            // è¿½åŠ æ–‡æœ¬
            content.innerHTML += text;

            // é‡æ–°æ·»åŠ å…‰æ ‡
            content.innerHTML += '<span class="streaming-cursor"></span>';

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            content.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function finishLLMAnalysis() {
            const content = document.getElementById('llmAnalysisContent');
            
            // ç§»é™¤å…‰æ ‡
            const cursor = content.querySelector('.streaming-cursor');
            if (cursor) {
                cursor.remove();
            }

            content.classList.remove('streaming');
        }

        function displayLLMError(message) {
            const content = document.getElementById('llmAnalysisContent');
            content.innerHTML = `
                <div class="error-message">
                    âš ï¸ LLMåˆ†æå¤±è´¥ï¼š${message}
                </div>
            `;
            content.classList.remove('streaming');
        }

        function displayError(message) {
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.classList.add('active');
            resultContainer.innerHTML = `
                <div class="error-message">
                    âŒ é”™è¯¯ï¼š${message}
                </div>
            `;
        }

        function enableButton() {
            const btn = document.querySelector('.analyze-btn');
            btn.disabled = false;
            btn.textContent = 'ğŸš€ å¼€å§‹åˆ†æ';
        }
    </script>
</body>
</html>

