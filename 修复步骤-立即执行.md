# 🔧 修复生产环境规则问题 - 立即执行步骤

## 📊 当前状态
- **本地规则数**: 1142 条
- **生产环境匹配**: 20 条
- **差异**: 1007 条
- **SQL 文件**: `scripts/temp_rules_export.sql` (1.1MB)

## 🚀 执行步骤（按顺序执行）

### 步骤 1: 上传 SQL 文件到生产环境

```bash
scp scripts/temp_rules_export.sql root@8.210.52.217:/tmp/rules_import.sql
```

**提示**: 需要输入 SSH 密码

---

### 步骤 2: SSH 到生产环境

```bash
ssh root@8.210.52.217
```

**提示**: 需要输入 SSH 密码

---

### 步骤 3: 执行 SQL（在生产环境服务器上）

```bash
# 进入项目目录
cd /opt/HiFate-bazi

# 执行 SQL（导入规则）
docker exec -i hifate-mysql-master mysql -uroot -pYuanqizhan@163 hifate_bazi < /tmp/rules_import.sql
```

**预期输出**: 应该看到 MySQL 执行成功，没有错误信息

---

### 步骤 4: 清除缓存（在生产环境服务器上）

```bash
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check
```

**预期输出**: 返回 JSON 响应，表示热更新已触发

---

### 步骤 5: 等待规则重新加载

```bash
# 等待 5 秒
sleep 5
```

---

### 步骤 6: 退出 SSH

```bash
exit
```

---

### 步骤 7: 验证修复结果（在本地执行）

```bash
# 方式 1: 使用验证脚本
bash scripts/verify_fix.sh

# 方式 2: 使用 Python 测试脚本
python3 scripts/quick_test_production.py

# 方式 3: 使用完整对比测试
python3 scripts/test_compare_api_results.py
```

---

## ✅ 预期结果

修复成功后，应该看到：

- **总匹配数**: 1000+ 条（接近 1142 条）
- **事业规则**: 9+ 条（当前 0 条）
- **身体规则**: 20+ 条（当前 5 条）
- **总评规则**: 8+ 条（当前 1 条）

---

## 🚨 如果修复失败

### 检查 SQL 是否执行成功

```bash
# SSH 到生产环境
ssh root@8.210.52.217

# 检查规则数量
docker exec hifate-mysql-master mysql -uroot -pYuanqizhan@163 hifate_bazi -e "
SELECT 
    rule_type,
    COUNT(*) as total,
    SUM(CASE WHEN enabled = 1 THEN 1 ELSE 0 END) as enabled_count
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%' 
  AND rule_type IN ('wealth', 'marriage', 'career', 'children', 'character', 'summary', 'health', 'peach_blossom', 'shishen', 'parents')
GROUP BY rule_type
ORDER BY rule_type;
"
```

### 检查缓存状态

```bash
curl http://8.210.52.217:8001/api/v1/hot-reload/status
```

### 手动清除缓存

```bash
# 如果热更新 API 不可用，可以重启服务（不推荐，会中断服务）
# 或等待缓存自动过期（24小时）
```

---

## 📝 快速执行命令（复制粘贴）

```bash
# 1. 上传文件
scp scripts/temp_rules_export.sql root@8.210.52.217:/tmp/rules_import.sql

# 2. SSH 并执行（一行命令）
ssh root@8.210.52.217 "cd /opt/HiFate-bazi && docker exec -i hifate-mysql-master mysql -uroot -pYuanqizhan@163 hifate_bazi < /tmp/rules_import.sql && curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check"

# 3. 等待 5 秒后验证
sleep 5 && bash scripts/verify_fix.sh
```

---

## 💡 提示

- SQL 文件使用 `ON DUPLICATE KEY UPDATE`，不会重复插入，可以安全执行多次
- 如果执行过程中遇到错误，可以查看错误信息并重试
- 修复后建议运行完整测试验证所有功能正常

