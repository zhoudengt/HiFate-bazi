# 十神命格规则开发总结

## 📅 开发时间
**2025-11-21**

---

## 📊 需求概述

将 `docs/十神命格9.xlsx` 文件解析为JSON规则，并开发相应的匹配逻辑和验证功能。

---

## ✅ 已完成工作

### 1️⃣ 数据处理

#### Excel → JSON 转换
- **输入文件**: `docs/十神命格9.xlsx`
- **输出文件**: `docs/十神命格9_rules.json`
- **规则数量**: 8条
- **ID范围**: 99001 - 99008

#### 规则结构示例
```json
{
  "ID": 99001,
  "类型": "十神命格",
  "性别": "无论男女",
  "筛选条件1": "月柱",
  "筛选条件2": "
    优先级11：月柱主星是正官，且月柱副星有正官
    优先级21：月柱副星有正官，且年柱主星有正官或时柱主星有正官
    优先级31：月柱主星是正官，且年柱副星有正官或日柱副星有正官或时柱副星有正官
  ",
  "结果": "正官格\n核心特征：品行端正、自律负责..."
}
```

#### 主规则文件更新
- **文件**: `docs/2025.11.20算法公式.json`
- **操作**: 删除旧的"十神命格"数据（ID: 40001-40060），插入新规则
- **备份**: `docs/2025.11.20算法公式.json.backup_before_shishen`

---

### 2️⃣ 后端开发

#### 匹配逻辑实现
- **文件**: `server/services/formula_rule_service.py`
- **方法**: `_match_shishen_rule()`
  
#### 匹配逻辑说明

**核心概念**：
- **主星** = 天干的十神
- **副星** = 地支藏干的十神
- **十神** = 主星 + 副星

**三个优先级规则**：

1. **优先级1**（最高）：
   ```
   月柱主星是XX，且月柱副星有XX
   ```

2. **优先级2**：
   ```
   月柱副星有XX，且（年柱主星有XX 或 时柱主星有XX）
   ```

3. **优先级3**：
   ```
   月柱主星是XX，且（年柱副星有XX 或 日柱副星有XX 或 时柱副星有XX）
   ```

**8种十神命格**：
- 99001: 正官格
- 99002: 七杀格
- 99003: 正印格
- 99004: 偏印格
- 99005: 正财格
- 99006: 偏财格
- 99007: 食神格
- 99008: 伤官格

---

### 3️⃣ 匹配条件查询展示功能（验证工具）

#### 新增API端点
- **文件**: `server/api/v1/shishen_debug.py`
- **路由**: `/api/v1/shishen/debug`
- **方法**: POST
- **功能**: 详细展示每条规则的匹配过程和中间状态

#### 请求示例
```json
{
  "solar_date": "1990-01-01",
  "solar_time": "12:00",
  "gender": "male"
}
```

#### 响应数据结构
```json
{
  "success": true,
  "data": {
    "bazi_info": {
      "year": "己巳",
      "month": "丙子",
      "day": "丙寅",
      "hour": "甲午"
    },
    "shishen_info": {
      "year_stem_shishen": "正印",
      "month_stem_shishen": "比肩",
      "day_stem_shishen": "日主",
      "hour_stem_shishen": "食神",
      "year_branch_hidden": {...},
      "month_branch_hidden": {...},
      "day_branch_hidden": {...},
      "hour_branch_hidden": {...}
    },
    "matching_results": [
      {
        "rule_id": 99001,
        "shishen_name": "正官",
        "is_matched": false,
        "conditions_checked": [
          {
            "priority": 1,
            "description": "月柱主星是正官，且月柱副星有正官",
            "matched": false
          },
          {
            "priority": 2,
            "description": "月柱副星有正官，且年柱主星有正官或时柱主星有正官",
            "matched": false
          },
          {
            "priority": 3,
            "description": "月柱主星是正官，且年柱副星有正官或日柱副星有正官或时柱副星有正官",
            "matched": false
          }
        ]
      }
      // ... 其他7条规则
    ]
  }
}
```

---

### 4️⃣ 前端展示

#### 调试页面
- **文件**: `frontend/shishen-debug.html`
- **访问**: http://127.0.0.1:8001/frontend/shishen-debug.html
- **功能**:
  - 输入出生信息
  - 展示八字四柱
  - 展示十神信息（主星+副星）
  - 详细展示每条规则的3个优先级检查结果
  - 高亮显示匹配成功的规则

#### 主分析页面
- **文件**: `frontend/formula-analysis.html`
- **功能**: 已支持"🔮 十神命格"标签页
- **显示**: 与其他规则类型（财富、婚配等）一致

---

## 📂 文件清单

### 新增文件
1. ✅ `docs/十神命格9_rules.json` - 规则JSON数据
2. ✅ `server/api/v1/shishen_debug.py` - 调试API
3. ✅ `frontend/shishen-debug.html` - 调试页面
4. ✅ `docs/十神命格规则开发总结.md` - 本文档

### 修改文件
1. ✅ `docs/2025.11.20算法公式.json` - 更新十神命格规则
2. ✅ `server/services/formula_rule_service.py` - 添加匹配逻辑
3. ✅ `server/main.py` - 注册调试路由

### 备份文件
1. ✅ `docs/2025.11.20算法公式.json.backup_before_shishen`

---

## 🎯 核心设计原则

### 1. 最小影响原则 ✅
- 只修改必要的文件
- 不改动已有的正常功能
- 新增功能独立封装

### 2. 可验证性 ✅
- 提供专门的调试接口和页面
- 详细展示匹配过程
- 便于规则验证和调试

### 3. 数据完整性 ✅
- 使用Excel中的原始ID（99001-99008）
- 保留完整的规则结构
- 备份原始数据

### 4. 代码可维护性 ✅
- 清晰的注释
- 统一的代码风格
- 完整的文档

---

## 🧪 测试验证

### 测试步骤

1. **访问调试页面**
   ```
   http://127.0.0.1:8001/frontend/shishen-debug.html
   ```

2. **输入测试数据**
   - 出生日期: 1990-01-01
   - 出生时间: 12:00
   - 性别: 男

3. **查看结果**
   - 八字信息是否正确
   - 十神信息是否完整（主星+副星）
   - 匹配规则是否符合优先级逻辑
   - 条件检查详情是否清晰

4. **API测试**
   ```bash
   curl -X POST "http://127.0.0.1:8001/api/v1/bazi/formula-analysis" \
     -H "Content-Type: application/json" \
     -d '{
       "solar_date": "1990-01-01",
       "solar_time": "12:00",
       "gender": "male"
     }'
   ```

5. **前端主页面测试**
   ```
   http://127.0.0.1:8001/frontend/formula-analysis.html
   ```
   - 查看"🔮 十神命格"标签页
   - 验证数据展示

---

## 📋 匹配逻辑详解

### 数据流程

```
用户输入
  ↓
计算八字四柱
  ↓
提取十神信息
  ├─ 主星：年/月/日/时 天干十神
  └─ 副星：年/月/日/时 地支藏干十神
  ↓
遍历8条十神命格规则
  ├─ 提取规则中的十神名称
  ├─ 按优先级1→2→3检查
  └─ 任一优先级匹配即返回True
  ↓
返回匹配结果
```

### 关键代码片段

```python
# 优先级1：月柱主星是XX，且月柱副星有XX
if month_stem_shishen == shishen_name:
    if isinstance(month_hidden, dict):
        if shishen_name in month_hidden.values():
            return True

# 优先级2：月柱副星有XX，且（年柱主星有XX 或 时柱主星有XX）
if isinstance(month_hidden, dict):
    if shishen_name in month_hidden.values():
        if year_stem_shishen == shishen_name or hour_stem_shishen == shishen_name:
            return True

# 优先级3：月柱主星是XX，且（年/日/时柱副星有XX）
if month_stem_shishen == shishen_name:
    if (isinstance(year_hidden, dict) and shishen_name in year_hidden.values()) or \
       (isinstance(day_hidden, dict) and shishen_name in day_hidden.values()) or \
       (isinstance(hour_hidden, dict) and shishen_name in hour_hidden.values()):
        return True
```

---

## ⚠️ 注意事项

### 1. 十神数据依赖
- 匹配逻辑依赖八字服务返回的十神信息
- 需要确保 `details` 中包含以下字段：
  - `year_stem_shishen`, `month_stem_shishen`, `day_stem_shishen`, `hour_stem_shishen`
  - `year_branch_hidden`, `month_branch_hidden`, `day_branch_hidden`, `hour_branch_hidden`

### 2. 数据类型检查
- 地支藏干（hidden）字段必须是字典类型
- 已添加 `isinstance()` 检查防止类型错误

### 3. 优先级顺序
- 按优先级1→2→3顺序检查
- 任一优先级匹配即停止，返回True
- 高优先级规则更严格

---

## 📈 后续优化建议

1. **性能优化**
   - 规则缓存
   - 批量匹配优化

2. **功能增强**
   - 支持更多命格类型
   - 支持自定义优先级权重
   - 支持命格组合分析

3. **用户体验**
   - 添加命格详细解读
   - 提供命格关系图谱
   - 支持命格对比功能

---

## 🔧 故障排查

### 问题1：没有匹配到十神命格
**原因**: 八字数据中缺少十神信息
**解决**: 
- 检查 BaziService 是否返回十神字段
- 使用调试接口查看 shishen_info 是否为空

### 问题2：匹配结果不符合预期
**原因**: 规则理解错误或数据解析错误
**解决**:
- 使用调试页面查看详细匹配过程
- 对比 conditions_checked 的各个优先级结果
- 验证主星和副星的值是否正确

### 问题3：服务启动失败
**原因**: 路由注册错误或依赖缺失
**解决**:
- 查看 `/tmp/bazi_server_shishen.log`
- 确认所有文件已保存
- 重启服务

---

## 📞 联系方式

如有问题，请参考：
- 开发规范：`docs/DEVELOPMENT_GUIDELINES.md`
- API文档：http://127.0.0.1:8001/docs
- 调试工具：http://127.0.0.1:8001/frontend/shishen-debug.html

---

**文档更新日期**: 2025-11-21  
**开发状态**: ✅ 已完成  
**测试状态**: ⏳ 待用户验证

