# é˜¿é‡Œäº‘åŒæœºéƒ¨ç½²æƒé™éš”ç¦»æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

- [ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°](#ä¸€æ–¹æ¡ˆæ¦‚è¿°)
- [äºŒã€æ¶æ„è®¾è®¡](#äºŒæ¶æ„è®¾è®¡)
- [ä¸‰ã€ç›®å½•ç»“æ„è®¾è®¡](#ä¸‰ç›®å½•ç»“æ„è®¾è®¡)
- [å››ã€ç”¨æˆ·æƒé™è®¾è®¡](#å››ç”¨æˆ·æƒé™è®¾è®¡)
- [äº”ã€Docker é…ç½®åˆ†ç¦»](#äº”docker-é…ç½®åˆ†ç¦»)
- [å…­ã€éƒ¨ç½²è„šæœ¬](#å…­éƒ¨ç½²è„šæœ¬)
- [ä¸ƒã€éƒ¨ç½²æ­¥éª¤](#ä¸ƒéƒ¨ç½²æ­¥éª¤)
- [å…«ã€æƒé™éªŒè¯](#å…«æƒé™éªŒè¯)
- [ä¹ã€æ—¥å¸¸è¿ç»´](#ä¹æ—¥å¸¸è¿ç»´)
- [åã€æ•…éšœæ’æŸ¥](#åæ•…éšœæ’æŸ¥)
- [åä¸€ã€å®‰å…¨æ£€æŸ¥æ¸…å•](#åä¸€å®‰å…¨æ£€æŸ¥æ¸…å•)

---

## ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

### 1.1 éœ€æ±‚è¯´æ˜

åœ¨é˜¿é‡Œäº‘ä¸¤å°æœåŠ¡å™¨ä¸Šéƒ¨ç½²å‰åç«¯æœåŠ¡ï¼Œå®ç°æƒé™éš”ç¦»ï¼š

- **åç«¯ç”¨æˆ·**ï¼šæ‹¥æœ‰å®Œæ•´æƒé™ï¼Œå¯ä»¥è®¿é—®æ‰€æœ‰æœåŠ¡ã€ç›®å½•å’Œé…ç½®
- **å‰ç«¯ç”¨æˆ·**ï¼šåªèƒ½è®¿é—®å‰ç«¯ç›¸å…³ç›®å½•å’ŒæœåŠ¡ï¼Œæ— æ³•è®¿é—®åç«¯ä»£ç å’Œæ•°æ®åº“é…ç½®

### 1.2 æ ¸å¿ƒåŸåˆ™

1. **ä¸¤å°æœåŠ¡å™¨éƒ½éƒ¨ç½²å®Œæ•´çš„å‰åç«¯æœåŠ¡**
2. **é€šè¿‡ Linux ç”¨æˆ·æƒé™å®ç°è®¿é—®éš”ç¦»**
3. **é€šè¿‡ Docker Compose é…ç½®åˆ†ç¦»å®ç°æœåŠ¡éš”ç¦»**
4. **é€šè¿‡ SSH é…ç½®é™åˆ¶å‰ç«¯ç”¨æˆ·çš„è®¿é—®èŒƒå›´**

### 1.3 æœåŠ¡å™¨ä¿¡æ¯

| é¡¹ç›® | æœåŠ¡å™¨1 | æœåŠ¡å™¨2 |
|------|---------|---------|
| **IP åœ°å€** | 123.57.216.15 | 123.57.216.16 |
| **éƒ¨ç½²å†…å®¹** | å‰åç«¯å®Œæ•´æœåŠ¡ | å‰åç«¯å®Œæ•´æœåŠ¡ |
| **ç”¨æˆ·æƒé™** | backend-user / frontend-user | backend-user / frontend-user |

---

## äºŒã€æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é˜¿é‡Œäº‘ VPC ç½‘ç»œ                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   æœåŠ¡å™¨1       â”‚         â”‚   æœåŠ¡å™¨2         â”‚     â”‚
â”‚  â”‚  123.57.216.15 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  123.57.216.16   â”‚     â”‚
â”‚  â”‚                 â”‚  å†…ç½‘   â”‚                  â”‚     â”‚
â”‚  â”‚  âœ… å‰åç«¯å®Œæ•´   â”‚         â”‚  âœ… å‰åç«¯å®Œæ•´   â”‚     â”‚
â”‚  â”‚                 â”‚         â”‚                  â”‚     â”‚
â”‚  â”‚  ç”¨æˆ·æƒé™ï¼š      â”‚         â”‚  ç”¨æˆ·æƒé™ï¼š      â”‚     â”‚
â”‚  â”‚  - backend-user â”‚         â”‚  - backend-user  â”‚     â”‚
â”‚  â”‚    (å®Œæ•´æƒé™)    â”‚         â”‚    (å®Œæ•´æƒé™)     â”‚     â”‚
â”‚  â”‚  - frontend-userâ”‚         â”‚  - frontend-user â”‚     â”‚
â”‚  â”‚    (ä»…å‰ç«¯)      â”‚         â”‚    (ä»…å‰ç«¯)       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æœåŠ¡éƒ¨ç½²æ¶æ„

ä¸¤å°æœåŠ¡å™¨éƒ¨ç½²ç›¸åŒçš„æœåŠ¡ï¼š

```
æœåŠ¡å™¨1 / æœåŠ¡å™¨2
â”œâ”€â”€ Web API æœåŠ¡ (8001)
â”œâ”€â”€ å¾®æœåŠ¡å±‚
â”‚   â”œâ”€â”€ bazi_core (9001)
â”‚   â”œâ”€â”€ bazi_fortune (9002)
â”‚   â”œâ”€â”€ bazi_analyzer (9003)
â”‚   â”œâ”€â”€ bazi_rule (9004)
â”‚   â”œâ”€â”€ fortune_analysis (9005)
â”‚   â”œâ”€â”€ payment_service (9006)
â”‚   â”œâ”€â”€ fortune_rule (9007)
â”‚   â”œâ”€â”€ intent_service (9008)
â”‚   â”œâ”€â”€ prompt_optimizer (9009)
â”‚   â””â”€â”€ desk_fengshui (9010)
â”œâ”€â”€ æ•°æ®å­˜å‚¨å±‚
â”‚   â”œâ”€â”€ MySQL (3306)
â”‚   â””â”€â”€ Redis (6379)
â””â”€â”€ å‰ç«¯æœåŠ¡
    â””â”€â”€ Nginx (80/443)
```

### 2.3 æƒé™éš”ç¦»æ¶æ„

```
/opt/HiFate-bazi/
â”œâ”€â”€ server/              [åç«¯ç”¨æˆ·: rwx] [å‰ç«¯ç”¨æˆ·: ---]
â”œâ”€â”€ services/            [åç«¯ç”¨æˆ·: rwx] [å‰ç«¯ç”¨æˆ·: ---]
â”œâ”€â”€ src/                 [åç«¯ç”¨æˆ·: rwx] [å‰ç«¯ç”¨æˆ·: ---]
â”œâ”€â”€ frontend/            [åç«¯ç”¨æˆ·: rwx] [å‰ç«¯ç”¨æˆ·: rwx]
â”œâ”€â”€ docker-compose.yml   [åç«¯ç”¨æˆ·: rw-] [å‰ç«¯ç”¨æˆ·: r--]
â””â”€â”€ .env                 [åç«¯ç”¨æˆ·: rw-] [å‰ç«¯ç”¨æˆ·: r--]
```

---

## ä¸‰ã€ç›®å½•ç»“æ„è®¾è®¡

### 3.1 å®Œæ•´ç›®å½•ç»“æ„

```
/opt/HiFate-bazi/
â”œâ”€â”€ server/                    # åç«¯æœåŠ¡ä»£ç 
â”‚   â”œâ”€â”€ api/                   # API è·¯ç”±
â”‚   â”œâ”€â”€ services/              # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ engines/               # è§„åˆ™å¼•æ“
â”‚   â””â”€â”€ ...
â”œâ”€â”€ services/                  # å¾®æœåŠ¡ä»£ç 
â”‚   â”œâ”€â”€ bazi_core/
â”‚   â”œâ”€â”€ bazi_fortune/
â”‚   â”œâ”€â”€ bazi_analyzer/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ src/                       # æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ bazi_calculator.py
â”‚   â””â”€â”€ ...
â”œâ”€â”€ frontend/                  # å‰ç«¯ä»£ç ï¼ˆå‰ç«¯ç”¨æˆ·å¯è®¿é—®ï¼‰
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ css/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ frontend-config/           # å‰ç«¯é…ç½®ç›®å½•ï¼ˆå‰ç«¯ç”¨æˆ·å¯è®¿é—®ï¼‰
â”‚   â””â”€â”€ nginx.conf
â”œâ”€â”€ docker-compose.yml         # å®Œæ•´é…ç½®ï¼ˆåç«¯ç”¨æˆ·ï¼‰
â”œâ”€â”€ docker-compose.prod.yml    # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”œâ”€â”€ docker-compose.frontend.yml # å‰ç«¯é…ç½®ï¼ˆå‰ç«¯ç”¨æˆ·ï¼‰
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ setup-permissions.sh   # æƒé™åˆå§‹åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ deploy-backend.sh      # åç«¯éƒ¨ç½²è„šæœ¬
â”‚   â””â”€â”€ deploy-frontend.sh     # å‰ç«¯éƒ¨ç½²è„šæœ¬
â””â”€â”€ .env                       # å®Œæ•´ç¯å¢ƒå˜é‡ï¼ˆåç«¯ç”¨æˆ·ï¼‰
```

### 3.2 æƒé™è¯´æ˜

| ç›®å½•/æ–‡ä»¶ | åç«¯ç”¨æˆ·æƒé™ | å‰ç«¯ç”¨æˆ·æƒé™ | è¯´æ˜ |
|----------|------------|------------|------|
| `server/` | rwx (750) | --- (000) | åç«¯ä»£ç ï¼Œå‰ç«¯ç”¨æˆ·ç¦æ­¢è®¿é—® |
| `services/` | rwx (750) | --- (000) | å¾®æœåŠ¡ä»£ç ï¼Œå‰ç«¯ç”¨æˆ·ç¦æ­¢è®¿é—® |
| `src/` | rwx (750) | --- (000) | æ ¸å¿ƒä»£ç ï¼Œå‰ç«¯ç”¨æˆ·ç¦æ­¢è®¿é—® |
| `frontend/` | rwx (755) | rwx (755) | å‰ç«¯ä»£ç ï¼Œå‰åç«¯ç”¨æˆ·éƒ½å¯è®¿é—® |
| `frontend-config/` | rwx (755) | rwx (755) | å‰ç«¯é…ç½®ï¼Œå‰åç«¯ç”¨æˆ·éƒ½å¯è®¿é—® |
| `docker-compose.yml` | rw- (640) | r-- (400) | å®Œæ•´é…ç½®ï¼Œå‰ç«¯ç”¨æˆ·åªè¯» |
| `.env` | rw- (600) | r-- (400) | ç¯å¢ƒå˜é‡ï¼Œå‰ç«¯ç”¨æˆ·åªè¯» |
| `scripts/deploy-backend.sh` | rwx (750) | --- (000) | åç«¯éƒ¨ç½²è„šæœ¬ï¼Œå‰ç«¯ç”¨æˆ·ç¦æ­¢æ‰§è¡Œ |
| `scripts/deploy-frontend.sh` | rwx (755) | rwx (755) | å‰ç«¯éƒ¨ç½²è„šæœ¬ï¼Œå‰åç«¯ç”¨æˆ·éƒ½å¯æ‰§è¡Œ |

---

## å››ã€ç”¨æˆ·æƒé™è®¾è®¡

### 4.1 åˆ›å»ºç”¨æˆ·å’Œç»„

åœ¨ä¸¤å°æœåŠ¡å™¨ä¸Šéƒ½æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# 1. åˆ›å»ºåç«¯ç”¨æˆ·ç»„å’Œç”¨æˆ·
sudo groupadd backend-group
sudo useradd -m -g backend-group -s /bin/bash backend-user
sudo passwd backend-user  # è®¾ç½®å¯†ç 

# 2. åˆ›å»ºå‰ç«¯ç”¨æˆ·ç»„å’Œç”¨æˆ·
sudo groupadd frontend-group
sudo useradd -m -g frontend-group -s /bin/bash frontend-user
sudo passwd frontend-user  # è®¾ç½®å¯†ç 

# 3. å°†ç”¨æˆ·æ·»åŠ åˆ° docker ç»„ï¼ˆå¯ä»¥ç®¡ç† Docker å®¹å™¨ï¼‰
sudo usermod -aG docker backend-user
sudo usermod -aG docker frontend-user

# 4. éªŒè¯ç”¨æˆ·åˆ›å»º
id backend-user
id frontend-user
```

### 4.2 è®¾ç½®ç›®å½•æƒé™

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/HiFate-bazi

# 1. è®¾ç½®é¡¹ç›®æ ¹ç›®å½•æƒé™ï¼ˆåç«¯ç”¨æˆ·å¯è¯»å†™ï¼‰
sudo chown -R backend-user:backend-group /opt/HiFate-bazi
sudo chmod 750 /opt/HiFate-bazi

# 2. å‰ç«¯ç›®å½•ï¼šå‰ç«¯ç”¨æˆ·å¯è¯»å†™
sudo chown -R frontend-user:frontend-group frontend/
sudo chmod 755 frontend/

# 3. åˆ›å»ºå‰ç«¯é…ç½®ç›®å½•
sudo mkdir -p /opt/HiFate-bazi/frontend-config
sudo chown -R frontend-user:frontend-group /opt/HiFate-bazi/frontend-config
sudo chmod 755 /opt/HiFate-bazi/frontend-config

# 4. åç«¯ç›®å½•ï¼šä»…åç«¯ç”¨æˆ·å¯è®¿é—®
sudo chmod 750 server/ services/ src/
sudo setfacl -m u:frontend-user:--- server/
sudo setfacl -m u:frontend-user:--- services/
sudo setfacl -m u:frontend-user:--- src/

# 5. é…ç½®æ–‡ä»¶ï¼šåç«¯ç”¨æˆ·å¯è¯»å†™ï¼Œå‰ç«¯ç”¨æˆ·åªè¯»
sudo chmod 640 docker-compose.yml .env
sudo setfacl -m u:frontend-user:r-- docker-compose.yml
sudo setfacl -m u:frontend-user:r-- .env

# 6. è®¾ç½®è„šæœ¬æƒé™
sudo chmod 755 scripts/deploy-backend.sh
sudo chmod 755 scripts/deploy-frontend.sh
sudo chown backend-user:backend-group scripts/deploy-backend.sh
sudo chown frontend-user:frontend-group scripts/deploy-frontend.sh
```

### 4.3 SSH æƒé™é™åˆ¶

ç¼–è¾‘ SSH é…ç½®æ–‡ä»¶ï¼Œé™åˆ¶å‰ç«¯ç”¨æˆ·çš„è®¿é—®èŒƒå›´ï¼š

```bash
# ç¼–è¾‘ SSH é…ç½®
sudo vim /etc/ssh/sshd_config

# åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹é…ç½®
Match User frontend-user
    # é™åˆ¶åªèƒ½è®¿é—®æŒ‡å®šç›®å½•
    ChrootDirectory /opt/HiFate-bazi
    # å…è®¸æ‰§è¡Œå‘½ä»¤ï¼ˆä½†å—ç›®å½•æƒé™é™åˆ¶ï¼‰
    ForceCommand cd /opt/HiFate-bazi && exec $SHELL
    # ç¦æ­¢ç«¯å£è½¬å‘
    AllowTcpForwarding no
    X11Forwarding no

# é‡å¯ SSH æœåŠ¡
sudo systemctl restart sshd
```

### 4.4 éªŒè¯æƒé™è®¾ç½®

```bash
# éªŒè¯ç›®å½•æƒé™
ls -la /opt/HiFate-bazi/
getfacl /opt/HiFate-bazi/server/
getfacl /opt/HiFate-bazi/frontend/

# éªŒè¯ç”¨æˆ·ç»„
groups backend-user
groups frontend-user
```

---

## äº”ã€Docker é…ç½®åˆ†ç¦»

### 5.1 å®Œæ•´é…ç½®ï¼ˆåç«¯ç”¨æˆ·ä½¿ç”¨ï¼‰

ä½¿ç”¨ç°æœ‰çš„ `docker-compose.yml` å’Œ `docker-compose.prod.yml`ï¼ŒåŒ…å«æ‰€æœ‰æœåŠ¡ã€‚

### 5.2 å‰ç«¯é…ç½®ï¼ˆå‰ç«¯ç”¨æˆ·ä½¿ç”¨ï¼‰

åˆ›å»º `docker-compose.frontend.yml`ï¼š

```yaml
# docker-compose.frontend.yml - å‰ç«¯ç”¨æˆ·ä¸“ç”¨é…ç½®
version: '3.8'

services:
  # å‰ç«¯ Nginx æœåŠ¡
  nginx-frontend:
    image: nginx:alpine
    container_name: hifate-frontend-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./frontend-config/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - frontend-network
    user: "1000:1000"
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  frontend-network:
    driver: bridge
```

### 5.3 Nginx é…ç½®ï¼ˆå‰ç«¯æœåŠ¡å™¨ï¼‰

åˆ›å»º `frontend-config/nginx.conf`ï¼š

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;

    # å‰ç«¯é™æ€æ–‡ä»¶æœåŠ¡
    server {
        listen 80;
        server_name _;

        root /usr/share/nginx/html;
        index index.html;

        # é™æ€æ–‡ä»¶
        location / {
            try_files $uri $uri/ /index.html;
        }

        # API ä»£ç†åˆ°åç«¯æœåŠ¡å™¨ï¼ˆå†…ç½‘ï¼‰
        location /api/ {
            proxy_pass http://123.57.216.15:8001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # å¥åº·æ£€æŸ¥
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
    }
}
```

---

## å…­ã€éƒ¨ç½²è„šæœ¬

### 6.1 æƒé™åˆå§‹åŒ–è„šæœ¬

åˆ›å»º `scripts/setup-permissions.sh`ï¼š

```bash
#!/bin/bash
# scripts/setup-permissions.sh - åˆå§‹åŒ–æƒé™é…ç½®

set -e

echo "ğŸ”§ åˆå§‹åŒ–ç”¨æˆ·æƒé™é…ç½®..."
echo ""

# 1. åˆ›å»ºç”¨æˆ·å’Œç»„
echo "ğŸ“ [1/6] åˆ›å»ºç”¨æˆ·å’Œç»„..."
sudo groupadd -f backend-group
sudo groupadd -f frontend-group
sudo useradd -m -g backend-group -s /bin/bash backend-user 2>/dev/null || echo "   backend-user å·²å­˜åœ¨"
sudo useradd -m -g frontend-group -s /bin/bash frontend-user 2>/dev/null || echo "   frontend-user å·²å­˜åœ¨"
echo "   âœ… ç”¨æˆ·å’Œç»„åˆ›å»ºå®Œæˆ"

# 2. è®¾ç½®ç›®å½•æƒé™
echo ""
echo "ğŸ“ [2/6] è®¾ç½®ç›®å½•æƒé™..."
cd /opt/HiFate-bazi

# é¡¹ç›®æ ¹ç›®å½•ï¼šåç«¯ç”¨æˆ·å¯è¯»å†™
sudo chown -R backend-user:backend-group /opt/HiFate-bazi
sudo chmod 750 /opt/HiFate-bazi
echo "   âœ… é¡¹ç›®æ ¹ç›®å½•æƒé™è®¾ç½®å®Œæˆ"

# å‰ç«¯ç›®å½•ï¼šå‰ç«¯ç”¨æˆ·å¯è¯»å†™
sudo chown -R frontend-user:frontend-group frontend/ 2>/dev/null || echo "   âš ï¸  frontend ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
sudo chmod 755 frontend/ 2>/dev/null || true
echo "   âœ… å‰ç«¯ç›®å½•æƒé™è®¾ç½®å®Œæˆ"

# åç«¯ç›®å½•ï¼šä»…åç«¯ç”¨æˆ·å¯è®¿é—®
sudo chmod 750 server/ services/ src/ 2>/dev/null || echo "   âš ï¸  éƒ¨åˆ†åç«¯ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
sudo setfacl -m u:frontend-user:--- server/ 2>/dev/null || true
sudo setfacl -m u:frontend-user:--- services/ 2>/dev/null || true
sudo setfacl -m u:frontend-user:--- src/ 2>/dev/null || true
echo "   âœ… åç«¯ç›®å½•æƒé™è®¾ç½®å®Œæˆ"

# 3. åˆ›å»ºå‰ç«¯é…ç½®ç›®å½•
echo ""
echo "ğŸ“ [3/6] åˆ›å»ºå‰ç«¯é…ç½®ç›®å½•..."
sudo mkdir -p /opt/HiFate-bazi/frontend-config
sudo chown -R frontend-user:frontend-group /opt/HiFate-bazi/frontend-config
sudo chmod 755 /opt/HiFate-bazi/frontend-config
echo "   âœ… å‰ç«¯é…ç½®ç›®å½•åˆ›å»ºå®Œæˆ"

# 4. é…ç½®æ–‡ä»¶æƒé™
echo ""
echo "ğŸ“„ [4/6] è®¾ç½®é…ç½®æ–‡ä»¶æƒé™..."
sudo chmod 640 docker-compose.yml .env 2>/dev/null || echo "   âš ï¸  éƒ¨åˆ†é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡"
sudo setfacl -m u:frontend-user:r-- docker-compose.yml 2>/dev/null || true
sudo setfacl -m u:frontend-user:r-- .env 2>/dev/null || true
echo "   âœ… é…ç½®æ–‡ä»¶æƒé™è®¾ç½®å®Œæˆ"

# 5. è®¾ç½®è„šæœ¬æƒé™
echo ""
echo "ğŸ“œ [5/6] è®¾ç½®è„šæœ¬æƒé™..."
sudo chmod 755 scripts/deploy-backend.sh 2>/dev/null || echo "   âš ï¸  deploy-backend.sh ä¸å­˜åœ¨ï¼Œè·³è¿‡"
sudo chmod 755 scripts/deploy-frontend.sh 2>/dev/null || echo "   âš ï¸  deploy-frontend.sh ä¸å­˜åœ¨ï¼Œè·³è¿‡"
sudo chown backend-user:backend-group scripts/deploy-backend.sh 2>/dev/null || true
sudo chown frontend-user:frontend-group scripts/deploy-frontend.sh 2>/dev/null || true
echo "   âœ… è„šæœ¬æƒé™è®¾ç½®å®Œæˆ"

# 6. æ·»åŠ  Docker ç»„
echo ""
echo "ğŸ³ [6/6] æ·»åŠ  Docker ç»„æƒé™..."
sudo usermod -aG docker backend-user
sudo usermod -aG docker frontend-user
echo "   âœ… Docker ç»„æƒé™è®¾ç½®å®Œæˆ"

echo ""
echo "=========================================="
echo "âœ… æƒé™é…ç½®å®Œæˆ"
echo "=========================================="
echo ""
echo "ğŸ“‹ ç”¨æˆ·ä¿¡æ¯ï¼š"
echo "  åç«¯ç”¨æˆ·: backend-user (å®Œæ•´æƒé™)"
echo "  å‰ç«¯ç”¨æˆ·: frontend-user (ä»…å‰ç«¯æƒé™)"
echo ""
echo "ğŸ” è¯·ä¸ºä¸¤ä¸ªç”¨æˆ·è®¾ç½®å¯†ç ï¼š"
echo "  sudo passwd backend-user"
echo "  sudo passwd frontend-user"
echo ""
```

### 6.2 åç«¯éƒ¨ç½²è„šæœ¬

åˆ›å»º `scripts/deploy-backend.sh`ï¼š

```bash
#!/bin/bash
# scripts/deploy-backend.sh - åç«¯ç”¨æˆ·éƒ¨ç½²è„šæœ¬ï¼ˆå®Œæ•´æƒé™ï¼‰

set -e

echo "ğŸš€ åç«¯éƒ¨ç½²è„šæœ¬ï¼ˆå®Œæ•´æƒé™ï¼‰"
echo ""

# æ£€æŸ¥ç”¨æˆ·
if [ "$USER" != "backend-user" ]; then
    echo "âŒ æ­¤è„šæœ¬ä»…é™ backend-user ç”¨æˆ·ä½¿ç”¨"
    echo "   å½“å‰ç”¨æˆ·: $USER"
    exit 1
fi

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/HiFate-bazi

# 1. æ‹‰å–æœ€æ–°ä»£ç 
echo "ğŸ“¥ [1/4] æ›´æ–°ä»£ç ..."
git pull origin master || {
    echo "âŒ ä»£ç æ›´æ–°å¤±è´¥"
    exit 1
}
echo "   âœ… ä»£ç æ›´æ–°å®Œæˆ"

# 2. æ£€æŸ¥å¹¶æ„å»ºåŸºç¡€é•œåƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
echo ""
echo "ğŸ³ [2/4] æ£€æŸ¥åŸºç¡€é•œåƒ..."
if ! docker images hifate-base:latest --format "{{.Repository}}" | grep -q hifate-base; then
    echo "   âš ï¸  åŸºç¡€é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»ºï¼ˆçº¦5-10åˆ†é’Ÿï¼‰..."
    docker build \
        --platform linux/amd64 \
        -f Dockerfile.base \
        -t hifate-base:latest \
        -t hifate-base:$(date +%Y%m%d) \
        . || {
        echo "   âŒ åŸºç¡€é•œåƒæ„å»ºå¤±è´¥"
        exit 1
    }
    echo "   âœ… åŸºç¡€é•œåƒæ„å»ºå®Œæˆ"
else
    echo "   âœ… åŸºç¡€é•œåƒå·²å­˜åœ¨"
fi

# 3. æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
echo ""
echo "ğŸ”„ [3/4] é‡å¯æ‰€æœ‰æœåŠ¡..."
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build || {
    echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
    exit 1
}
echo "   âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"

# 4. å¥åº·æ£€æŸ¥
echo ""
echo "ğŸ¥ [4/4] å¥åº·æ£€æŸ¥..."
sleep 10
MAX_RETRIES=5
RETRY_COUNT=0

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    if curl -f -s http://localhost:8001/api/v1/health > /dev/null 2>&1; then
        echo "   âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
        break
    fi
    RETRY_COUNT=$((RETRY_COUNT + 1))
    if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
        echo "   â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $RETRY_COUNT/$MAX_RETRIES..."
        sleep 5
    else
        echo "   âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
        echo "   ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼š"
        docker compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=50
        exit 1
    fi
done

echo ""
echo "=========================================="
echo "âœ… åç«¯éƒ¨ç½²å®Œæˆ"
echo "=========================================="
echo ""
echo "ğŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
echo ""
```

### 6.3 å‰ç«¯éƒ¨ç½²è„šæœ¬

åˆ›å»º `scripts/deploy-frontend.sh`ï¼š

```bash
#!/bin/bash
# scripts/deploy-frontend.sh - å‰ç«¯ç”¨æˆ·éƒ¨ç½²è„šæœ¬ï¼ˆä»…å‰ç«¯æƒé™ï¼‰

set -e

echo "ğŸš€ å‰ç«¯éƒ¨ç½²è„šæœ¬ï¼ˆä»…é™å‰ç«¯ç”¨æˆ·ä½¿ç”¨ï¼‰"
echo ""

# æ£€æŸ¥ç”¨æˆ·
if [ "$USER" != "frontend-user" ]; then
    echo "âŒ æ­¤è„šæœ¬ä»…é™ frontend-user ç”¨æˆ·ä½¿ç”¨"
    echo "   å½“å‰ç”¨æˆ·: $USER"
    exit 1
fi

# æ£€æŸ¥ç›®å½•æƒé™
if [ ! -w "/opt/HiFate-bazi/frontend" ]; then
    echo "âŒ æ²¡æœ‰ frontend ç›®å½•çš„å†™æƒé™"
    exit 1
fi

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/HiFate-bazi

# 1. æ‹‰å–æœ€æ–°ä»£ç ï¼ˆä»…å‰ç«¯ç›®å½•ï¼‰
echo "ğŸ“¥ [1/3] æ›´æ–°å‰ç«¯ä»£ç ..."
cd frontend/
git pull origin master -- frontend/ 2>/dev/null || {
    echo "   âš ï¸  ä½¿ç”¨ git pull æ›´æ–°æ•´ä¸ªä»“åº“ï¼ˆå‰ç«¯ç”¨æˆ·æƒé™å—é™ï¼‰"
    cd ..
    git pull origin master
}
echo "   âœ… å‰ç«¯ä»£ç æ›´æ–°å®Œæˆ"

# 2. æ„å»ºå‰ç«¯ï¼ˆå¦‚æœæœ‰æ„å»ºæ­¥éª¤ï¼‰
echo ""
echo "ğŸ”¨ [2/3] æ„å»ºå‰ç«¯..."
# å¦‚æœæœ‰ npm æ„å»ºæ­¥éª¤ï¼Œåœ¨è¿™é‡Œæ‰§è¡Œ
# cd /opt/HiFate-bazi/frontend
# npm install
# npm run build
echo "   âœ… å‰ç«¯æ„å»ºå®Œæˆï¼ˆè·³è¿‡ï¼Œå¦‚éœ€æ„å»ºè¯·å–æ¶ˆæ³¨é‡Šï¼‰"

# 3. é‡å¯å‰ç«¯æœåŠ¡
echo ""
echo "ğŸ”„ [3/3] é‡å¯å‰ç«¯æœåŠ¡..."
cd /opt/HiFate-bazi
docker compose -f docker-compose.frontend.yml up -d --build nginx-frontend || {
    echo "âŒ å‰ç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"
    exit 1
}
echo "   âœ… å‰ç«¯æœåŠ¡å¯åŠ¨å®Œæˆ"

# 4. å¥åº·æ£€æŸ¥
echo ""
echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
sleep 5
if curl -f -s http://localhost/health > /dev/null 2>&1; then
    echo "   âœ… å‰ç«¯æœåŠ¡å¥åº·"
else
    echo "   âš ï¸  å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼ˆå¯èƒ½ Nginx æœªé…ç½® /health ç«¯ç‚¹ï¼‰"
fi

echo ""
echo "=========================================="
echo "âœ… å‰ç«¯éƒ¨ç½²å®Œæˆ"
echo "=========================================="
echo ""
echo "ğŸ“Š å‰ç«¯æœåŠ¡çŠ¶æ€ï¼š"
docker compose -f docker-compose.frontend.yml ps
echo ""
```

---

## ä¸ƒã€éƒ¨ç½²æ­¥éª¤

### 7.1 é¦–æ¬¡éƒ¨ç½²ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰

#### æ­¥éª¤ 1ï¼šåˆå§‹åŒ–æœåŠ¡å™¨1

```bash
# 1. ç™»å½•æœåŠ¡å™¨1
ssh root@123.57.216.15

# 2. å…‹éš†ä»£ç ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
cd /opt
git clone https://gitee.com/zhoudengtang/hifate-prod.git HiFate-bazi
cd HiFate-bazi

# 3. æ‰§è¡Œæƒé™åˆå§‹åŒ–
bash scripts/setup-permissions.sh

# 4. è®¾ç½®ç”¨æˆ·å¯†ç 
sudo passwd backend-user
sudo passwd frontend-user

# 5. é…ç½®ç¯å¢ƒå˜é‡
cp env.template .env
vim .env  # ç¼–è¾‘ç¯å¢ƒå˜é‡

# 6. ä½¿ç”¨åç«¯ç”¨æˆ·éƒ¨ç½²
su - backend-user
cd /opt/HiFate-bazi
bash scripts/deploy-backend.sh
```

#### æ­¥éª¤ 2ï¼šåˆå§‹åŒ–æœåŠ¡å™¨2

```bash
# 1. ç™»å½•æœåŠ¡å™¨2
ssh root@123.57.216.16

# 2. å…‹éš†ä»£ç ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
cd /opt
git clone https://gitee.com/zhoudengtang/hifate-prod.git HiFate-bazi
cd HiFate-bazi

# 3. æ‰§è¡Œæƒé™åˆå§‹åŒ–
bash scripts/setup-permissions.sh

# 4. è®¾ç½®ç”¨æˆ·å¯†ç ï¼ˆä¸æœåŠ¡å™¨1ç›¸åŒæˆ–ä¸åŒï¼Œæ ¹æ®éœ€æ±‚ï¼‰
sudo passwd backend-user
sudo passwd frontend-user

# 5. é…ç½®ç¯å¢ƒå˜é‡
cp env.template .env
vim .env  # ç¼–è¾‘ç¯å¢ƒå˜é‡ï¼ˆæ³¨æ„ä¿®æ”¹æ•°æ®åº“è¿æ¥ç­‰ï¼‰

# 6. ä½¿ç”¨åç«¯ç”¨æˆ·éƒ¨ç½²
su - backend-user
cd /opt/HiFate-bazi
bash scripts/deploy-backend.sh
```

### 7.2 æ—¥å¸¸éƒ¨ç½²

#### åç«¯ç”¨æˆ·éƒ¨ç½²ï¼ˆå®Œæ•´æœåŠ¡ï¼‰

```bash
# ä½¿ç”¨åç«¯ç”¨æˆ·ç™»å½•
ssh backend-user@123.57.216.15  # æˆ– 123.57.216.16

# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
cd /opt/HiFate-bazi
bash scripts/deploy-backend.sh
```

#### å‰ç«¯ç”¨æˆ·éƒ¨ç½²ï¼ˆä»…å‰ç«¯æœåŠ¡ï¼‰

```bash
# ä½¿ç”¨å‰ç«¯ç”¨æˆ·ç™»å½•
ssh frontend-user@123.57.216.15  # æˆ– 123.57.216.16

# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
cd /opt/HiFate-bazi
bash scripts/deploy-frontend.sh
```

### 7.3 ä»æœ¬åœ°éƒ¨ç½²

#### åç«¯éƒ¨ç½²

```bash
# åœ¨æœ¬åœ°æ‰§è¡Œ
./deploy.sh  # é€‰æ‹© 1) å®Œæ•´éƒ¨ç½²

# æˆ–æ‰‹åŠ¨æ‰§è¡Œ
git push gitee master
ssh backend-user@123.57.216.15 "cd /opt/HiFate-bazi && bash scripts/deploy-backend.sh"
```

#### å‰ç«¯éƒ¨ç½²

```bash
# åœ¨æœ¬åœ°æ‰§è¡Œ
# 1. æ¨é€ä»£ç 
git push gitee master

# 2. åŒæ­¥å‰ç«¯æ–‡ä»¶åˆ°æœåŠ¡å™¨
rsync -avz --delete \
    --exclude='.git' \
    --exclude='node_modules' \
    ./frontend/ frontend-user@123.57.216.15:/opt/HiFate-bazi/frontend/

# 3. æ‰§è¡Œå‰ç«¯éƒ¨ç½²
ssh frontend-user@123.57.216.15 "cd /opt/HiFate-bazi && bash scripts/deploy-frontend.sh"
```

---

## å…«ã€æƒé™éªŒè¯

### 8.1 éªŒè¯å‰ç«¯ç”¨æˆ·æƒé™

```bash
# ä½¿ç”¨å‰ç«¯ç”¨æˆ·ç™»å½•
ssh frontend-user@123.57.216.15

# 1. æµ‹è¯•æ˜¯å¦å¯ä»¥è®¿é—®å‰ç«¯ç›®å½•
cd /opt/HiFate-bazi/frontend
ls -la  # âœ… åº”è¯¥å¯ä»¥

# 2. æµ‹è¯•æ˜¯å¦å¯ä»¥è®¿é—®åç«¯ç›®å½•
cd /opt/HiFate-bazi/server
ls -la  # âŒ åº”è¯¥è¢«æ‹’ç»ï¼ˆPermission deniedï¼‰

# 3. æµ‹è¯•æ˜¯å¦å¯ä»¥è¯»å–é…ç½®æ–‡ä»¶
cat /opt/HiFate-bazi/.env  # âœ… å¯ä»¥è¯»å–ï¼ˆåªè¯»ï¼‰
vim /opt/HiFate-bazi/.env  # âŒ æ— æ³•ä¿å­˜ï¼ˆåªè¯»ï¼‰

# 4. æµ‹è¯•æ˜¯å¦å¯ä»¥ç®¡ç†å‰ç«¯å®¹å™¨
docker compose -f docker-compose.frontend.yml ps  # âœ… å¯ä»¥
docker compose -f docker-compose.frontend.yml up -d  # âœ… å¯ä»¥

# 5. æµ‹è¯•æ˜¯å¦å¯ä»¥ç®¡ç†æ‰€æœ‰å®¹å™¨
docker ps -a  # âœ… å¯ä»¥çœ‹åˆ°æ‰€æœ‰å®¹å™¨ï¼ˆDocker ç»„æƒé™ï¼‰
docker compose -f docker-compose.yml ps  # âŒ å¯èƒ½è¢«æ‹’ç»ï¼ˆæ–‡ä»¶æƒé™ï¼‰

# 6. æµ‹è¯•æ˜¯å¦å¯ä»¥æ‰§è¡Œåç«¯éƒ¨ç½²è„šæœ¬
bash /opt/HiFate-bazi/scripts/deploy-backend.sh  # âŒ åº”è¯¥è¢«æ‹’ç»ï¼ˆç”¨æˆ·æ£€æŸ¥ï¼‰
```

### 8.2 éªŒè¯åç«¯ç”¨æˆ·æƒé™

```bash
# ä½¿ç”¨åç«¯ç”¨æˆ·ç™»å½•
ssh backend-user@123.57.216.15

# 1. æµ‹è¯•æ˜¯å¦å¯ä»¥è®¿é—®æ‰€æœ‰ç›®å½•
cd /opt/HiFate-bazi
ls -la  # âœ… å¯ä»¥
cd server && ls -la  # âœ… å¯ä»¥
cd ../frontend && ls -la  # âœ… å¯ä»¥

# 2. æµ‹è¯•æ˜¯å¦å¯ä»¥ç®¡ç†æ‰€æœ‰å®¹å™¨
docker compose -f docker-compose.yml ps  # âœ… å¯ä»¥
docker compose -f docker-compose.frontend.yml ps  # âœ… å¯ä»¥

# 3. æµ‹è¯•æ˜¯å¦å¯ä»¥æ‰§è¡Œæ‰€æœ‰éƒ¨ç½²è„šæœ¬
bash scripts/deploy-backend.sh  # âœ… å¯ä»¥
bash scripts/deploy-frontend.sh  # âœ… å¯ä»¥

# 4. æµ‹è¯•æ˜¯å¦å¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶
vim .env  # âœ… å¯ä»¥ç¼–è¾‘å’Œä¿å­˜
```

### 8.3 æƒé™éªŒè¯è„šæœ¬

åˆ›å»º `scripts/verify-permissions.sh`ï¼š

```bash
#!/bin/bash
# scripts/verify-permissions.sh - æƒé™éªŒè¯è„šæœ¬

echo "ğŸ” æƒé™éªŒè¯è„šæœ¬"
echo ""

CURRENT_USER=$(whoami)
echo "å½“å‰ç”¨æˆ·: $CURRENT_USER"
echo ""

# æ£€æŸ¥ç›®å½•æƒé™
echo "ğŸ“ ç›®å½•æƒé™æ£€æŸ¥ï¼š"
echo "  frontend/: $(ls -ld /opt/HiFate-bazi/frontend | awk '{print $1, $3, $4}')"
echo "  server/: $(ls -ld /opt/HiFate-bazi/server | awk '{print $1, $3, $4}')"
echo ""

# æ£€æŸ¥æ–‡ä»¶æƒé™
echo "ğŸ“„ æ–‡ä»¶æƒé™æ£€æŸ¥ï¼š"
echo "  docker-compose.yml: $(ls -l /opt/HiFate-bazi/docker-compose.yml | awk '{print $1}')"
echo "  .env: $(ls -l /opt/HiFate-bazi/.env | awk '{print $1}')"
echo ""

# æ£€æŸ¥ ACL
echo "ğŸ” ACL æ£€æŸ¥ï¼š"
getfacl /opt/HiFate-bazi/server/ | grep frontend-user || echo "  âœ… frontend-user æ—  server ç›®å½•æƒé™"
getfacl /opt/HiFate-bazi/frontend/ | grep frontend-user || echo "  âš ï¸  frontend-user æ—  frontend ç›®å½•æƒé™"
echo ""

# æ£€æŸ¥ Docker ç»„
echo "ğŸ³ Docker ç»„æ£€æŸ¥ï¼š"
groups | grep docker && echo "  âœ… å½“å‰ç”¨æˆ·åœ¨ docker ç»„" || echo "  âŒ å½“å‰ç”¨æˆ·ä¸åœ¨ docker ç»„"
echo ""

# æ£€æŸ¥è„šæœ¬æƒé™
echo "ğŸ“œ è„šæœ¬æƒé™æ£€æŸ¥ï¼š"
ls -l /opt/HiFate-bazi/scripts/deploy-*.sh
echo ""

echo "âœ… æƒé™éªŒè¯å®Œæˆ"
```

---

## ä¹ã€æ—¥å¸¸è¿ç»´

### 9.1 æŸ¥çœ‹æœåŠ¡çŠ¶æ€

#### åç«¯ç”¨æˆ·

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker compose -f docker-compose.yml -f docker-compose.prod.yml ps

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f --tail=100
```

#### å‰ç«¯ç”¨æˆ·

```bash
# æŸ¥çœ‹å‰ç«¯æœåŠ¡çŠ¶æ€
docker compose -f docker-compose.frontend.yml ps

# æŸ¥çœ‹å‰ç«¯æœåŠ¡æ—¥å¿—
docker compose -f docker-compose.frontend.yml logs -f --tail=100
```

### 9.2 é‡å¯æœåŠ¡

#### åç«¯ç”¨æˆ·

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker compose -f docker-compose.yml -f docker-compose.prod.yml restart

# é‡å¯å•ä¸ªæœåŠ¡
docker compose -f docker-compose.yml -f docker-compose.prod.yml restart web
```

#### å‰ç«¯ç”¨æˆ·

```bash
# é‡å¯å‰ç«¯æœåŠ¡
docker compose -f docker-compose.frontend.yml restart nginx-frontend
```

### 9.3 æ›´æ–°ä»£ç 

#### åç«¯ç”¨æˆ·æ›´æ–°

```bash
cd /opt/HiFate-bazi
git pull origin master
bash scripts/deploy-backend.sh
```

#### å‰ç«¯ç”¨æˆ·æ›´æ–°

```bash
cd /opt/HiFate-bazi
git pull origin master
bash scripts/deploy-frontend.sh
```

### 9.4 æŸ¥çœ‹èµ„æºä½¿ç”¨

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats --no-stream

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h
```

---

## åã€æ•…éšœæ’æŸ¥

### 10.1 æƒé™é—®é¢˜

#### é—®é¢˜ï¼šå‰ç«¯ç”¨æˆ·æ— æ³•è®¿é—® frontend ç›®å½•

```bash
# æ£€æŸ¥ç›®å½•æƒé™
ls -ld /opt/HiFate-bazi/frontend

# ä¿®å¤æƒé™
sudo chown -R frontend-user:frontend-group /opt/HiFate-bazi/frontend
sudo chmod 755 /opt/HiFate-bazi/frontend
```

#### é—®é¢˜ï¼šå‰ç«¯ç”¨æˆ·æ— æ³•æ‰§è¡Œéƒ¨ç½²è„šæœ¬

```bash
# æ£€æŸ¥è„šæœ¬æƒé™
ls -l /opt/HiFate-bazi/scripts/deploy-frontend.sh

# ä¿®å¤æƒé™
sudo chmod 755 /opt/HiFate-bazi/scripts/deploy-frontend.sh
sudo chown frontend-user:frontend-group /opt/HiFate-bazi/scripts/deploy-frontend.sh
```

#### é—®é¢˜ï¼šå‰ç«¯ç”¨æˆ·æ— æ³•ç®¡ç† Docker å®¹å™¨

```bash
# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨ docker ç»„
groups frontend-user

# æ·»åŠ ç”¨æˆ·åˆ° docker ç»„
sudo usermod -aG docker frontend-user

# é‡æ–°ç™»å½•åç”Ÿæ•ˆ
```

### 10.2 æœåŠ¡é—®é¢˜

#### é—®é¢˜ï¼šæœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker compose -f docker-compose.yml -f docker-compose.prod.yml logs web

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 8001
```

#### é—®é¢˜ï¼šå‰ç«¯æœåŠ¡æ— æ³•è®¿é—®åç«¯ API

```bash
# æ£€æŸ¥ Nginx é…ç½®
cat /opt/HiFate-bazi/frontend-config/nginx.conf

# æµ‹è¯•åç«¯ API
curl http://123.57.216.15:8001/api/v1/health

# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping 123.57.216.15
```

### 10.3 SSH é—®é¢˜

#### é—®é¢˜ï¼šå‰ç«¯ç”¨æˆ· SSH ç™»å½•åæ— æ³•æ‰§è¡Œå‘½ä»¤

```bash
# æ£€æŸ¥ SSH é…ç½®
sudo cat /etc/ssh/sshd_config | grep -A 10 "Match User frontend-user"

# æ£€æŸ¥ ChrootDirectory é…ç½®
# å¦‚æœé…ç½®äº† ChrootDirectoryï¼Œéœ€è¦ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®
sudo chown root:root /opt/HiFate-bazi
sudo chmod 755 /opt/HiFate-bazi
```

---

## åä¸€ã€å®‰å…¨æ£€æŸ¥æ¸…å•

éƒ¨ç½²å®Œæˆåï¼Œå¿…é¡»æ£€æŸ¥ä»¥ä¸‹å®‰å…¨é¡¹ï¼š

### 11.1 ç›®å½•æƒé™æ£€æŸ¥

- [ ] `server/` ç›®å½•ï¼šå‰ç«¯ç”¨æˆ·æ— æ³•è®¿é—®ï¼ˆ`---`ï¼‰
- [ ] `services/` ç›®å½•ï¼šå‰ç«¯ç”¨æˆ·æ— æ³•è®¿é—®ï¼ˆ`---`ï¼‰
- [ ] `src/` ç›®å½•ï¼šå‰ç«¯ç”¨æˆ·æ— æ³•è®¿é—®ï¼ˆ`---`ï¼‰
- [ ] `frontend/` ç›®å½•ï¼šå‰ç«¯ç”¨æˆ·å¯ä»¥è®¿é—®ï¼ˆ`rwx`ï¼‰
- [ ] `frontend-config/` ç›®å½•ï¼šå‰ç«¯ç”¨æˆ·å¯ä»¥è®¿é—®ï¼ˆ`rwx`ï¼‰

### 11.2 æ–‡ä»¶æƒé™æ£€æŸ¥

- [ ] `docker-compose.yml`ï¼šå‰ç«¯ç”¨æˆ·åªè¯»ï¼ˆ`r--`ï¼‰
- [ ] `.env`ï¼šå‰ç«¯ç”¨æˆ·åªè¯»ï¼ˆ`r--`ï¼‰
- [ ] `scripts/deploy-backend.sh`ï¼šå‰ç«¯ç”¨æˆ·æ— æ³•æ‰§è¡Œï¼ˆ`---`ï¼‰
- [ ] `scripts/deploy-frontend.sh`ï¼šå‰ç«¯ç”¨æˆ·å¯ä»¥æ‰§è¡Œï¼ˆ`rwx`ï¼‰

### 11.3 ç”¨æˆ·æƒé™æ£€æŸ¥

- [ ] åç«¯ç”¨æˆ·åœ¨ `docker` ç»„
- [ ] å‰ç«¯ç”¨æˆ·åœ¨ `docker` ç»„
- [ ] å‰ç«¯ç”¨æˆ·æ— æ³•åˆ‡æ¢åˆ° root
- [ ] å‰ç«¯ç”¨æˆ·æ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·ç›®å½•

### 11.4 SSH é…ç½®æ£€æŸ¥

- [ ] å‰ç«¯ç”¨æˆ· SSH é…ç½®æ­£ç¡®ï¼ˆChrootDirectoryï¼‰
- [ ] å‰ç«¯ç”¨æˆ·æ— æ³•ç«¯å£è½¬å‘
- [ ] å‰ç«¯ç”¨æˆ·æ— æ³•æ‰§è¡Œç³»ç»Ÿå‘½ä»¤

### 11.5 Docker æƒé™æ£€æŸ¥

- [ ] å‰ç«¯ç”¨æˆ·åªèƒ½ç®¡ç†å‰ç«¯ç›¸å…³å®¹å™¨
- [ ] å‰ç«¯ç”¨æˆ·æ— æ³•è®¿é—®åç«¯å®¹å™¨æ—¥å¿—ï¼ˆé€šè¿‡æ–‡ä»¶æƒé™é™åˆ¶ï¼‰
- [ ] å®¹å™¨ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œ

### 11.6 ç½‘ç»œè®¿é—®æ£€æŸ¥

- [ ] å‰ç«¯æœåŠ¡åªèƒ½é€šè¿‡å†…ç½‘è®¿é—®åç«¯ API
- [ ] æ•°æ®åº“ç«¯å£ä¸å¯¹å¤–æš´éœ²
- [ ] Redis ç«¯å£ä¸å¯¹å¤–æš´éœ²
- [ ] å¾®æœåŠ¡ç«¯å£ä¸å¯¹å¤–æš´éœ²

---

## åäºŒã€é™„å½•

### 12.1 å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# åˆ‡æ¢ç”¨æˆ·
su - backend-user
su - frontend-user

# æŸ¥çœ‹å½“å‰ç”¨æˆ·
whoami
id

# æŸ¥çœ‹ç›®å½•æƒé™
ls -ld /opt/HiFate-bazi/server/
getfacl /opt/HiFate-bazi/server/

# æŸ¥çœ‹ Docker å®¹å™¨
docker ps -a
docker compose -f docker-compose.yml ps

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker compose -f docker-compose.yml logs -f web

# é‡å¯æœåŠ¡
docker compose -f docker-compose.yml restart web
```

### 12.2 ç›¸å…³æ–‡æ¡£

- [é˜¿é‡Œäº‘éƒ¨ç½²æŒ‡å—](./é˜¿é‡Œäº‘éƒ¨ç½²æŒ‡å—.md)
- [Dockerç”Ÿäº§éƒ¨ç½²å®Œæ•´æŒ‡å—](./Dockerç”Ÿäº§éƒ¨ç½²å®Œæ•´æŒ‡å—.md)
- [éƒ¨ç½²æ–¹æ¡ˆ](./éƒ¨ç½²æ–¹æ¡ˆ.md)

### 12.3 è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-15  
**ç»´æŠ¤è€…**ï¼šç³»ç»Ÿç®¡ç†å‘˜

