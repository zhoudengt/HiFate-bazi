# 年运报告功能配置说明

## 一、数据库配置

### 1. 执行SQL脚本

执行以下SQL脚本配置平台、Bot ID/App ID和年份：

```bash
mysql -u用户名 -p数据库名 < scripts/db/setup_annual_report_config.sql
```

或者直接在MySQL客户端执行：

```sql
-- 1. 配置平台选择（bailian 或 coze）
INSERT INTO service_configs (config_key, config_value, description, config_type, category, is_active, created_at, updated_at)
VALUES ('ANNUAL_REPORT_LLM_PLATFORM', 'bailian', '年运报告使用的 LLM 平台: coze 或 bailian', 'string', 'llm', 1, NOW(), NOW())
ON DUPLICATE KEY UPDATE 
    config_value = 'bailian',
    description = '年运报告使用的 LLM 平台: coze 或 bailian',
    updated_at = NOW();

-- 2. 配置百炼 App ID（使用百炼平台时必填）
INSERT INTO service_configs (config_key, config_value, description, config_type, category, is_active, created_at, updated_at)
VALUES ('BAILIAN_ANNUAL_REPORT_APP_ID', 'a2a45b93d4c04ee1b363bdaa8cd26d35', '年运报告百炼 App ID', 'string', 'bailian', 1, NOW(), NOW())
ON DUPLICATE KEY UPDATE 
    config_value = 'a2a45b93d4c04ee1b363bdaa8cd26d35',
    description = '年运报告百炼 App ID',
    updated_at = NOW();

-- 3. 配置Coze Bot ID（使用 Coze 平台时必填）
INSERT INTO service_configs (config_key, config_value, description, is_active, created_at, updated_at)
VALUES ('ANNUAL_REPORT_BOT_ID', '7593296393016508450', '年运报告Coze Bot ID', 1, NOW(), NOW())
ON DUPLICATE KEY UPDATE 
    config_value = '7593296393016508450',
    description = '年运报告Coze Bot ID',
    updated_at = NOW();

-- 4. 配置年份
INSERT INTO service_configs (config_key, config_value, description, is_active, created_at, updated_at)
VALUES ('ANNUAL_REPORT_YEAR', '2026', '年运报告年份', 1, NOW(), NOW())
ON DUPLICATE KEY UPDATE 
    config_value = '2026',
    description = '年运报告年份',
    updated_at = NOW();

-- 5. 验证配置
SELECT config_key, config_value, description, is_active 
FROM service_configs 
WHERE config_key IN ('ANNUAL_REPORT_LLM_PLATFORM', 'BAILIAN_ANNUAL_REPORT_APP_ID', 'ANNUAL_REPORT_BOT_ID', 'ANNUAL_REPORT_YEAR')
ORDER BY config_key;
```

### 2. 配置说明

年运报告支持 **Coze** 和 **百炼** 双平台切换，通过数据库配置选择：

| 配置项 | 说明 | 必填条件 |
|--------|------|----------|
| `ANNUAL_REPORT_LLM_PLATFORM` | 平台选择：`coze` 或 `bailian`，默认 `coze` | 可选（不配置时使用全局 `LLM_PLATFORM` 或默认 `coze`） |
| `BAILIAN_ANNUAL_REPORT_APP_ID` | 百炼 App ID：`a2a45b93d4c04ee1b363bdaa8cd26d35` | 使用百炼平台时必填 |
| `ANNUAL_REPORT_BOT_ID` | Coze Bot ID：`7593296393016508450` | 使用 Coze 平台时必填 |
| `ANNUAL_REPORT_YEAR` | 年运报告目标年份，默认 `2026` | 可选 |

**平台选择优先级**：
1. `ANNUAL_REPORT_LLM_PLATFORM`（场景级配置）
2. `LLM_PLATFORM`（全局配置）
3. 默认 `coze`

### 3. 验证配置

执行验证SQL后，应该看到配置记录：
- `ANNUAL_REPORT_LLM_PLATFORM`: `bailian`（当前使用百炼）
- `BAILIAN_ANNUAL_REPORT_APP_ID`: `a2a45b93d4c04ee1b363bdaa8cd26d35`
- `ANNUAL_REPORT_BOT_ID`: `7593296393016508450`（Coze 备用）
- `ANNUAL_REPORT_YEAR`: `2026`

## 二、平台配置

### 1. 使用百炼平台（当前默认）

年运报告当前配置为使用**百炼平台**，需要确保以下配置：

- ✅ `ANNUAL_REPORT_LLM_PLATFORM` = `bailian`
- ✅ `BAILIAN_API_KEY`（全局配置，百炼 API Key）
- ✅ `BAILIAN_ANNUAL_REPORT_APP_ID` = `a2a45b93d4c04ee1b363bdaa8cd26d35`

**百炼智能体配置**：
1. 登录阿里云百炼平台
2. 找到 App ID 为 `a2a45b93d4c04ee1b363bdaa8cd26d35` 的智能体
3. 配置智能体的 System Prompt（参考 `docs/需求/Coze_Bot_System_Prompt_年运报告.md`）
4. 确保智能体支持流式输出

### 2. 切换到 Coze 平台

如需切换到 Coze 平台，修改配置：

```sql
UPDATE service_configs 
SET config_value = 'coze' 
WHERE config_key = 'ANNUAL_REPORT_LLM_PLATFORM';
```

并确保配置了：
- ✅ `COZE_ACCESS_TOKEN`（全局配置）
- ✅ `ANNUAL_REPORT_BOT_ID` = `7593296393016508450`

## 三、Coze Bot配置（使用 Coze 平台时）

### 1. 配置System Prompt

1. 登录Coze平台：https://www.coze.cn/
2. 找到Bot ID为 `7593296393016508450` 的Bot
3. 进入Bot设置 → System Prompt
4. 打开文档：`docs/需求/Coze_Bot_System_Prompt_年运报告.md`
5. 复制文档中的完整提示词（从"## 完整提示词（直接复制粘贴）"开始）
6. 粘贴到System Prompt中
7. 保存设置

### 2. 验证Bot配置

确保Bot的System Prompt中包含：
- `{{input}}` 占位符
- 5个模块的输出格式要求：
  1. 命盘分析
  2. 人生大事
  3. 流月解读
  4. 流年太岁
  5. 九宫飞星避煞

## 三、功能测试

### 1. 测试接口

#### 1.1 测试接口（返回格式化数据）

```bash
curl -X POST "http://localhost:8001/api/v1/annual-report/test" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male"
  }'
```

预期结果：
- `success: true`
- `target_year: 2026`
- `formatted_data`: 包含完整的JSON格式数据
- `data_summary`: 数据摘要

#### 1.2 流式接口测试

```bash
curl -X POST "http://localhost:8001/api/v1/annual-report/stream" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male"
  }' \
  --no-buffer
```

预期结果：
- SSE格式流式响应
- 包含5个模块的完整分析内容

### 2. 前端页面测试

1. 访问前端页面：
   ```
   http://localhost:8001/local_frontend/annual-report-analysis.html
   ```

2. 填写测试数据：
   - 公历日期：1990-05-15
   - 出生时间：14:30
   - 性别：男

3. 点击"开始分析"按钮

4. 验证结果：
   - 显示加载状态
   - 流式显示分析内容
   - 包含5个模块：
     - 命盘分析
     - 人生大事
     - 流月解读（1-12月）
     - 流年太岁
     - 九宫飞星避煞

### 3. 侧边栏菜单验证

1. 访问前端页面：`http://localhost:8001/local_frontend/`
2. 点击左侧菜单"命书"
3. 验证子菜单中包含"八字命理-年月报告"
4. 点击该菜单项，应该跳转到年运报告页面

## 四、常见问题排查

### 1. Bot ID配置错误

**症状**：接口返回错误 "数据库配置缺失: ANNUAL_REPORT_BOT_ID"

**解决方法**：
1. 检查数据库 `service_configs` 表中是否有 `ANNUAL_REPORT_BOT_ID` 配置
2. 验证配置值是否正确：`7593296393016508450`
3. 检查配置是否启用：`is_active = 1`

### 2. 年份配置错误

**症状**：接口返回错误或使用默认年份

**解决方法**：
1. 检查数据库 `service_configs` 表中是否有 `ANNUAL_REPORT_YEAR` 配置
2. 验证配置值是否正确：`2026`
3. 检查配置是否启用：`is_active = 1`

### 3. Coze Bot响应异常

**症状**：流式接口返回错误或内容不符合预期

**解决方法**：
1. 检查Coze Bot的System Prompt是否正确配置
2. 验证 `{{input}}` 占位符是否存在
3. 检查Bot是否已发布（如果使用生产环境）
4. 查看服务日志：`logs/debug.log`

### 4. 前端页面无法访问

**症状**：404错误或页面空白

**解决方法**：
1. 检查文件是否存在：`local_frontend/annual-report-analysis.html`
2. 检查文件路径是否正确
3. 检查静态文件服务是否正常：访问 `http://localhost:8001/local_frontend/`

## 五、性能优化建议

### 1. 数据缓存

年运报告的数据计算可以缓存，建议：
- 相同生辰八字 + 相同年份的结果可以缓存
- 缓存时间：24小时

### 2. 流式响应优化

- 确保SSE响应不被压缩（已配置）
- 监控流式响应的延迟
- 优化数据获取的并行化

## 六、后续维护

### 1. 更新年份

如果需要更新年份配置，执行：

```sql
UPDATE service_configs 
SET config_value = '2027', updated_at = NOW()
WHERE config_key = 'ANNUAL_REPORT_YEAR';
```

### 2. 更新Bot ID

如果需要更换Bot，执行：

```sql
UPDATE service_configs 
SET config_value = '新的Bot ID', updated_at = NOW()
WHERE config_key = 'ANNUAL_REPORT_BOT_ID';
```

### 3. 更新System Prompt

在Coze平台更新Bot的System Prompt后，无需修改代码，直接生效。

## 七、联系支持

如果遇到问题，请：
1. 查看服务日志：`logs/debug.log`
2. 检查数据库配置是否正确
3. 验证Coze Bot配置是否正确
4. 提供错误信息和日志片段
