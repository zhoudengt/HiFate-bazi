# 日志查看指南 - 完整数据流追踪

## 📊 **完整数据流**

```
用户输入："2029年适合投资吗？"
          ↓
【步骤1】Intent LLM识别（logs/intent_service.log）
          ↓ 
      输出JSON
          ↓
【步骤2】计算八字（logs/server_8001.log）
          ↓
    八字、十神等
          ↓
【步骤3】获取流年大运（logs/server_8001.log）
          ↓
   流年、大运、喜忌神等
          ↓
【步骤4】传递给最终LLM（logs/server_8001.log）
          ↓
   完整JSON数据
          ↓
【步骤5】LLM生成分析（logs/server_8001.log）
          ↓
    最终输出文本
```

---

## 📂 **日志文件位置**

| 日志文件 | 内容 | 位置 |
|---------|------|------|
| **Intent Service** | LLM识别输入输出 | `/Users/zhoudt/Downloads/project/HiFate-bazi/logs/intent_service.log` |
| **主服务** | 八字、流年、大运、最终LLM | `/Users/zhoudt/Downloads/project/HiFate-bazi/logs/server_8001.log` |

---

## 🔍 **查看日志命令**

### **实时监控所有日志**

```bash
# 同时监控两个日志文件
tail -f /Users/zhoudt/Downloads/project/HiFate-bazi/logs/intent_service.log \
        /Users/zhoudt/Downloads/project/HiFate-bazi/logs/server_8001.log
```

### **查看Intent识别结果**

```bash
# 查看最近的Intent识别（包含输入和JSON输出）
grep -A 30 "Intent LLM" /Users/zhoudt/Downloads/project/HiFate-bazi/logs/intent_service.log | tail -100
```

### **查看八字计算结果**

```bash
# 查看最近的八字计算结果
grep -A 15 "STEP2.*八字计算完成" /Users/zhoudt/Downloads/project/HiFate-bazi/logs/server_8001.log | tail -50
```

### **查看流年大运数据**

```bash
# 查看流年大运的详细信息
grep -A 20 "STEP4.*Fortune Context完成" /Users/zhoudt/Downloads/project/HiFate-bazi/logs/server_8001.log | tail -100
```

### **查看传递给最终LLM的完整数据**

```bash
# 查看完整的传递给LLM的JSON数据
grep -A 50 "STEP5.*传递给最终LLM" /Users/zhoudt/Downloads/project/HiFate-bazi/logs/server_8001.log | tail -200
```

---

## 🎯 **针对"2029年适合投资吗？"的日志查看**

### **1. 查看Intent识别**

```bash
tail -f /Users/zhoudt/Downloads/project/HiFate-bazi/logs/intent_service.log
```

**期望看到：**
```
🔍🔍🔍...
[Intent LLM] 输入识别
🔍🔍🔍...
用户问题: 2029年适合投资吗？
使用缓存: True
Prompt版本: v1.0
🔍🔍🔍...

✅✅✅...
[Intent LLM] 识别结果
✅✅✅...
完整JSON:
{
  "is_fortune_related": true,
  "intents": ["wealth"],
  "time_intent": {
    "type": "specific_year",
    "target_years": [2029],  ← ✅ 关键：应该是[2029]，不是[2025]或[2026,2027,2028,2029]
    "description": "2029年",
    "is_explicit": true
  },
  "confidence": 0.95,
  "keywords": ["2029年", "投资"],
  "reasoning": "用户询问2029年的投资运势"
}

⏰ 时间意图:
  - 类型: specific_year
  - 目标年份: [2029]  ← ✅ 再次确认
  - 描述: 2029年
✅✅✅...
```

---

### **2. 查看八字计算**

```bash
tail -f /Users/zhoudt/Downloads/project/HiFate-bazi/logs/server_8001.log
```

**期望看到：**
```
================================================================================
[STEP2] 八字计算完成
================================================================================
出生日期: 1990-05-15 14:00
性别: male
八字四柱:
  year: 庚 午 (金火)
  month: 辛 巳 (金火)
  day: 壬 午 (水火)
  hour: 丁 未 (火土)
日主: 壬
十神: {"年干": "偏印", "年支": "正财", "月干": "劫财", ...}
================================================================================
```

---

### **3. 查看流年大运数据**

```bash
# 继续查看同一个日志文件
tail -f /Users/zhoudt/Downloads/project/HiFate-bazi/logs/server_8001.log
```

**期望看到：**
```
================================================================================
[STEP4] Fortune Context完成
================================================================================
返回流年数量: 1
流年列表: ['2029年己酉']
  - 2029年: 己酉 | 十神=偏印 | 五行=土金
大运: 甲申 (18-27岁)
喜忌神: xi=['水', '木'] | ji=['火', '土']
五行平衡: {"木": 0, "火": 4, "土": 1, "金": 3, "水": 1}
旺衰: 偏弱
================================================================================
```

---

### **4. 查看传递给最终LLM的完整数据**

**期望看到：**
```
🎯🎯🎯...
[STEP5] 传递给最终LLM的完整数据
🎯🎯🎯...
用户问题: 2029年适合投资吗？
意图: wealth
流年年份: 2029  ← ✅ 关键：确认是2029
流年干支: 己酉
流年十神: 偏印
大运干支: 甲申 (18-27岁)
喜神: ['水', '木']
忌神: ['火', '土']
旺衰: 偏弱

📦 完整JSON数据:
{
  "intent": "wealth",
  "question": "2029年适合投资吗？",
  "bazi": {
    "pillars": {
      "year": {"stem": "庚", "branch": "午", ...},
      ...
    },
    "day_stem": "壬",
    "shishen": {...},
    "wuxing": {...}
  },
  "liunian": {
    "year": 2029,  ← ✅ 再次确认
    "label": "2029年己酉",
    "stem": "己",
    "branch": "酉",
    "stem_element": "土",
    "branch_element": "金",
    "stem_shishen": "偏印",
    ...
  },
  "dayun": {
    "stem": "甲",
    "branch": "申",
    "age_start": 18,
    "age_end": 27,
    ...
  },
  "metadata": {
    "has_liunian": true,
    "has_dayun": true,
    "target_year_from_question": 2029  ← ✅ 从问题中提取的年份
  },
  "xi_ji": {
    "xi_shen": ["水", "木"],
    "ji_shen": ["火", "土"]
  },
  "wangshuai": "偏弱",
  ...
}
🎯🎯🎯...
```

---

## 🚨 **如何判断问题在哪一步**

### **问题1：年份识别错误**

**症状**：看到 `target_years: [2025]` 或 `[2026, 2027, 2028, 2029]` 而不是 `[2029]`

**位置**：Intent Service日志的 `[Intent LLM] 识别结果` 部分

**日志命令**：
```bash
grep -A 20 "Intent LLM.*识别结果" logs/intent_service.log | tail -50
```

**如何判断**：
- ✅ **正确**：`"target_years": [2029]`
- ❌ **错误1**：`"target_years": [2025]` → Token失败，使用了兜底值
- ❌ **错误2**：`"target_years": [2026, 2027, 2028, 2029]` → LLM误识别为"未来多年"

---

### **问题2：流年数据不对**

**症状**：年份对了，但是流年干支或十神错误

**位置**：主服务日志的 `[STEP4] Fortune Context完成` 部分

**日志命令**：
```bash
grep -A 25 "STEP4.*Fortune Context完成" logs/server_8001.log | tail -100
```

**如何判断**：
- ✅ **正确**：`流年列表: ['2029年己酉']`
- ❌ **错误**：`流年列表: ['2025年乙巳']` → 使用了错误的年份数据

---

### **问题3：传递给LLM的数据不对**

**症状**：前面都对，但最终LLM分析的是错误年份

**位置**：主服务日志的 `[STEP5] 传递给最终LLM` 部分

**日志命令**：
```bash
grep -A 60 "STEP5.*传递给最终LLM" logs/server_8001.log | tail -200
```

**如何判断**：
- ✅ **正确**：`流年年份: 2029` 和 `"year": 2029`
- ❌ **错误**：`流年年份: 2025` → 数据传递出错

---

## 📝 **测试步骤**

### **1. 清空日志（可选）**

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
> logs/intent_service.log
> logs/server_8001.log
```

### **2. 启动实时监控**

```bash
# 在终端1中
tail -f logs/intent_service.log

# 在终端2中
tail -f logs/server_8001.log
```

### **3. 在浏览器中测试**

访问：`http://localhost:8001/frontend/smart-fortune-stream.html`

输入：
- 出生日期：1990-05-15 14:00
- 性别：男
- 问题：**2029年适合投资吗？**

点击"开始分析"

### **4. 观察日志输出**

在两个终端中会实时显示所有步骤的详细数据。

---

## 💡 **常见问题排查**

### **Q1：为什么日志文件不存在？**

**A**：服务可能没有启动或日志路径配置错误。

**解决**：
```bash
# 检查服务是否运行
ps aux | grep "intent_service\|uvicorn.*8001"

# 手动创建日志目录
mkdir -p /Users/zhoudt/Downloads/project/HiFate-bazi/logs

# 重启服务
cd /Users/zhoudt/Downloads/project/HiFate-bazi
./restart_all_services.sh
```

---

### **Q2：日志输出乱码？**

**A**：UTF-8编码问题。

**解决**：
```bash
# 使用正确的编码查看
cat logs/intent_service.log | iconv -f UTF-8 -t UTF-8
```

---

### **Q3：如何只看最新的一次请求？**

**A**：使用`tail`和`grep`组合。

```bash
# 查看最新的Intent识别
tail -200 logs/intent_service.log | grep -A 30 "Intent LLM.*识别结果" | tail -50

# 查看最新的完整数据流
tail -500 logs/server_8001.log | grep -A 50 "STEP5.*传递给最终LLM" | tail -100
```

---

## 🎯 **总结**

现在您可以看到完整的数据流：

1. ✅ **Intent LLM** → 用户输入 + JSON输出（包含时间意图）
2. ✅ **八字计算** → 四柱、日主、十神
3. ✅ **流年大运** → 流年干支、大运、喜忌神、旺衰
4. ✅ **传递给LLM** → 完整JSON数据（包含所有上述信息）
5. ✅ **LLM生成** → 最终分析文本

**老子就是要看数据！现在全都有了！** 🚀

