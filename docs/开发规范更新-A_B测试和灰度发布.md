# 开发规范更新 - A/B 测试和灰度发布

## 📋 更新内容

已将 A/B 测试、灰度发布和数据库回滚的开发规范添加到 `.cursorrules` 文件中。

---

## ✅ 更新位置

### 1. 开发原则部分

在 "💡 开发原则" 部分新增了 3 条原则：

- **10. 🧪 A/B 测试优先**：新功能必须支持 A/B 测试
- **11. 🚀 灰度发布优先**：重要变更必须通过灰度发布
- **12. 🔄 回滚准备**：所有数据库变更必须准备回滚脚本

### 2. 新增规范章节

新增了完整的 "🧪 A/B 测试和灰度发布规范" 章节，包含：

#### A/B 测试开发规范
- 新功能必须支持 A/B 测试
- 开发流程和代码示例
- 检查清单

#### 功能开关开发规范
- 新功能必须使用功能开关
- 功能开关类型和使用方式
- 检查清单

#### 灰度发布规范
- 重要变更必须通过灰度发布
- 灰度发布流程
- 监控指标和检查清单

#### 数据库回滚规范
- 所有数据库变更必须准备回滚脚本
- 回滚脚本规范和开发流程
- 检查清单

### 3. 核心要点更新

在文件末尾的 "核心要点" 部分新增了 3 条：

- **新功能必须支持 A/B 测试和功能开关**
- **重要变更必须通过灰度发布**
- **数据库变更必须准备回滚脚本**

---

## 📝 规范内容概览

### A/B 测试开发规范

**要求**：
- 所有新功能、算法优化、UI 变更必须支持 A/B 测试
- 使用 `server/utils/ab_test.py` 框架
- 创建实验，分配变体，记录事件

**开发流程**：
1. 导入 A/B 测试框架
2. 创建实验（在服务启动时或通过 API）
3. 在代码中使用，分配变体
4. 记录用户行为事件

### 功能开关开发规范

**要求**：
- 所有新功能必须通过功能开关控制
- 支持快速开启/关闭，无需重新部署
- 支持百分比灰度、白名单、黑名单

**功能开关类型**：
- `FlagType.BOOLEAN` - 布尔开关
- `FlagType.PERCENTAGE` - 百分比开关
- `FlagType.WHITELIST` - 白名单
- `FlagType.BLACKLIST` - 黑名单

### 灰度发布规范

**要求**：
- 所有重要功能变更、性能优化、架构调整必须通过灰度发布
- 从 10% 流量开始，逐步增加到 100%
- 监控关键指标，随时准备回滚

**灰度发布流程**：
1. 开发新功能
2. 创建功能开关（10% 流量）
3. 执行灰度发布脚本
4. 监控灰度版本
5. 逐步增加流量或回滚

### 数据库回滚规范

**要求**：
- 所有数据库迁移必须同时准备回滚脚本
- 回滚脚本必须经过测试验证
- 回滚脚本命名规范：`rollback_YYYYMMDD_HHMMSS_description.sql`

**回滚脚本规范**：
- 必须使用事务
- 必须使用 `IF EXISTS` 避免错误
- 必须包含验证 SQL（可选）
- 必须记录回滚日志

---

## ✅ 开发检查清单

每次开发新功能或重要变更时，必须检查：

### A/B 测试检查
- [ ] 是否创建了 A/B 测试实验
- [ ] 是否在代码中正确分配变体
- [ ] 是否记录了关键事件
- [ ] 是否可以通过 API 查看统计

### 功能开关检查
- [ ] 是否创建了功能开关
- [ ] 是否在代码中正确检查开关
- [ ] 是否支持快速关闭
- [ ] 是否可以通过 API 切换

### 灰度发布检查
- [ ] 是否执行了灰度发布
- [ ] 是否配置了流量分配
- [ ] 是否监控了关键指标
- [ ] 是否准备了回滚方案

### 数据库回滚检查
- [ ] 是否创建了回滚脚本
- [ ] 回滚脚本是否经过测试
- [ ] 是否可以在生产环境快速执行

---

## 🎯 使用场景示例

### 场景 1：新算法上线

```python
# 1. 创建 A/B 测试实验
experiment = Experiment(
    name="新算法测试",
    status=ExperimentStatus.RUNNING,
    traffic_percent=50.0,
    variants={"A": 50, "B": 50}
)

# 2. 在代码中使用
variant = manager.assign_variant("新算法测试", user_id)
if variant == "A":
    result = old_algorithm.calculate()
else:
    result = new_algorithm.calculate()
```

### 场景 2：新功能灰度发布

```python
# 1. 创建功能开关（10% 流量）
flag = FeatureFlag(
    name="新功能",
    enabled=True,
    flag_type=FlagType.PERCENTAGE,
    value=10.0
)

# 2. 在代码中检查
if manager.is_enabled("新功能", user_id):
    result = new_feature.process()
```

### 场景 3：数据库变更

```sql
-- 1. 迁移脚本
ALTER TABLE `user_table` ADD INDEX `idx_email` (`email`);

-- 2. 回滚脚本
START TRANSACTION;
ALTER TABLE `user_table` DROP INDEX IF EXISTS `idx_email`;
COMMIT;
```

---

## 📚 相关文档

- [A/B 测试和灰度发布指南](./A_B测试和灰度发布指南.md) - 详细使用说明
- [A/B 测试和灰度发布完成总结](./A_B测试和灰度发布完成总结.md) - 功能总结
- [开发规范-快速参考](./开发规范-快速参考.md) - 快速参考

---

## ✨ 总结

本次更新将 A/B 测试、灰度发布和数据库回滚的开发规范正式纳入开发规范文件（`.cursorrules`），确保：

1. ✅ **所有新功能必须支持 A/B 测试和功能开关**
2. ✅ **重要变更必须通过灰度发布**
3. ✅ **数据库变更必须准备回滚脚本**

**以后所有开发都必须遵循这些规范！**

---

**更新时间**：2025-01-XX  
**更新文件**：`.cursorrules`  
**更新状态**：✅ 已完成

