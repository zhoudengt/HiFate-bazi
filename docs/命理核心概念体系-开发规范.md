# 命理核心概念体系 - 开发规范

**版本**: v2.0  
**更新日期**: 2025-11-25  
**适用范围**: HiFate-bazi 八字系统全部模块

---

## 📋 目录

1. [概述](#概述)
2. [喜忌神体系](#喜忌神体系)
3. [调候体系](#调候体系)
4. [刑冲合害破体系](#刑冲合害破体系)
5. [综合应用](#综合应用)
6. [代码实现规范](#代码实现规范)
7. [开发注意事项](#开发注意事项)

---

## 概述

### 核心原则

命理分析是一个**多维度综合判断**的过程，核心要素包括：

1. **旺衰** - 日主强弱（得令、得地、得势）
2. **喜忌神** - 基于旺衰的喜忌（生扶 vs 克泄）
3. **调候** - 基于季节的气候平衡
4. **刑冲合害破** - 地支间的作用关系
5. **十神** - 社会角色和六亲关系
6. **五行** - 元素平衡和生克制化

### 分析流程

```
八字计算 → 旺衰判断 → 喜忌神 ← 调候判断
                ↓              ↓
           地支关系分析 → 综合判断
                ↓
         五行平衡 + 十神 + AI解读
```

---

## 喜忌神体系

### 1. 定义

**喜神**：对命局有利的十神和五行，能够平衡命局、带来吉祥  
**忌神**：对命局不利的十神和五行，会破坏平衡、带来凶险

### 2. 判断依据

#### 2.1 旺衰喜忌（基础）

| 旺衰状态 | 喜神（用神） | 忌神 | 原理 |
|---------|------------|------|------|
| 极旺 (80-100分) | 食神、伤官、偏财、正财、七杀、正官 | 比肩、劫财、偏印、正印 | 身旺需要克泄 |
| 身旺 (50-79分) | 食神、伤官、偏财、正财、七杀、正官 | 比肩、劫财、偏印、正印 | 身旺需要克泄 |
| 平衡 (40-49分) | 比肩、劫财、食神、伤官 | 偏财、正财、七杀、正官 | 平衡宜助身 |
| 身弱 (20-39分) | 比肩、劫财、偏印、正印 | 食神、伤官、偏财、正财、七杀、正官 | 身弱需要生扶 |
| 极弱 (0-19分) | 比肩、劫财、偏印、正印 | 食神、伤官、偏财、正财、七杀、正官 | 身弱需要生扶 |

#### 2.2 十神 → 五行映射

喜忌神首先是**十神**，然后转换为**五行**（用于实际应用）：

```python
# 以日主甲木为例：
{
    '比肩': '木',  # 甲
    '劫财': '木',  # 乙
    '食神': '火',  # 丙
    '伤官': '火',  # 丁
    '偏财': '土',  # 戊
    '正财': '土',  # 己
    '七杀': '金',  # 庚
    '正官': '金',  # 辛
    '偏印': '水',  # 壬
    '正印': '水',  # 癸
}
```

### 3. 代码实现

**文件**: `src/analyzers/wangshuai_analyzer.py`

```python
class WangShuaiAnalyzer:
    def analyze(self, solar_date, solar_time, gender):
        # 1. 计算旺衰
        wangshuai = self._determine_wangshuai(total_score)
        
        # 2. 判定喜忌（基于旺衰）
        xi_ji = self._determine_xi_ji(wangshuai)
        
        # 3. 计算喜忌五行
        xi_ji_elements = self._calculate_xi_ji_elements(xi_ji, bazi)
        
        # 4. 计算调候
        tiaohou = self.calculate_tiaohou(month_branch)
        
        # 5. 综合判定最终喜忌（调候 + 旺衰）
        from src.analyzers.tiaohou_xiji_analyzer import TiaohouXijiAnalyzer
        final_xi_ji = TiaohouXijiAnalyzer.determine_final_xi_ji(
            wangshuai_result, tiaohou, bazi_elements
        )
        
        return {
            'xi_ji': xi_ji,  # 原始喜忌（仅基于旺衰）
            'final_xi_ji': final_xi_ji,  # 最终喜忌（综合调候）
            'tiaohou': tiaohou
        }
```

### 4. 数据结构

```python
{
    'xi_ji': {
        'xi_shen': ['食神', '伤官', '偏财', '正财'],  # 喜神十神
        'ji_shen': ['比肩', '劫财', '偏印', '正印']   # 忌神十神
    },
    'xi_ji_elements': {
        'xi_shen': ['火', '土', '金'],  # 喜神五行
        'ji_shen': ['木', '水']         # 忌神五行
    },
    'final_xi_ji': {
        'final_xi_shen': ['食神', '伤官', ...],  # 最终喜神（优先级排序）
        'first_xi_shen': ['正财'],               # 第一喜神（调候喜忌一致）
        'xi_shen_elements': ['水', '火', ...],   # 喜神五行（调候优先）
        'analysis': '夏月生，需水调候...',
        'recommendations': ['第一喜神：水（正财）...']
    }
}
```

### 5. 应用场景

| 场景 | 使用喜忌 | 说明 |
|------|---------|------|
| 流年大运分析 | `final_xi_ji` | 综合调候，最准确 |
| 日常建议 | `final_xi_ji` | 方位、颜色、职业等 |
| 评分系统 | `final_xi_ji` | 财运、健康、事业、婚姻 |
| LLM分析 | 同时提供 `xi_ji` 和 `final_xi_ji` | 让LLM了解完整逻辑 |
| 传统命理研究 | `xi_ji` | 纯粹旺衰喜忌 |

---

## 调候体系

### 1. 定义

**调候**：调节气候平衡，使命局不受季节极端气候的不利影响

- **夏季**（巳午未月）炎热 → 需要**水**来调候（降温）
- **冬季**（亥子丑月）寒冷 → 需要**火**来调候（取暖）
- **春秋**（寅卯辰、申酉戌月）→ 气候适中，无需特别调候

### 2. 判断逻辑

#### 2.1 季节划分

| 季节 | 月支 | 调候五行 | 原理 |
|------|------|---------|------|
| 春季 | 寅、卯、辰 | 无 | 气候适中 |
| 夏季 | 巳、午、未 | **水** | 炎热需降温 |
| 秋季 | 申、酉、戌 | 无 | 气候适中 |
| 冬季 | 亥、子、丑 | **火** | 寒冷需取暖 |

#### 2.2 调候优先级

根据命局中调候五行的数量判断优先级：

```python
def _calculate_tiaohou_priority(tiaohou_element, element_counts):
    count = element_counts.get(tiaohou_element, 0)
    
    if count == 0:
        return 'high'    # 严重缺少，急需调候
    elif count == 1:
        return 'medium'  # 略显不足，需要加强
    else:
        return 'low'     # 充足，调候已满足
```

### 3. 调候与喜忌的互动

#### 3.1 情况1：调候五行在喜神中 ✅ 最佳

```
夏月生，身旺喜克泄 → 喜「食伤财官」
调候需水 → 水属于「正官/七杀」（喜神）
结论：水为第一喜神（既克身又调候）
```

#### 3.2 情况2：调候五行在忌神中 ⚠️ 需权衡

- **高优先级**（命局缺调候五行）→ **调候优先**，适当使用
- **中/低优先级**（命局有调候五行）→ **保持原有喜忌**

```
夏月生，身弱喜生扶 → 喜「比劫印」
调候需水 → 水属于「正印/偏印」（喜神）
结论：水为第一喜神（既生身又调候）
```

```
夏月生，身旺喜克泄 → 喜「食伤财官」
调候需水 → 水属于「正印/偏印」（忌神）
命局缺水（0个） → 调候优先级高
结论：适当补水用于调候（但不宜过多）
```

#### 3.3 情况3：调候五行不在喜忌中 ➡️ 补充

调候五行作为补充喜神使用。

### 4. 代码实现

**文件**: `src/analyzers/tiaohou_xiji_analyzer.py`

```python
class TiaohouXijiAnalyzer:
    @staticmethod
    def determine_final_xi_ji(wangshuai_result, tiaohou_result, bazi_elements):
        """综合旺衰喜忌和调候需求，确定最终喜忌神"""
        
        tiaohou_element = tiaohou_result.get('tiaohou_element')
        
        # 无需调候（春秋）
        if not tiaohou_element:
            return wangshuai_result
        
        # 判断调候优先级
        tiaohou_priority = _calculate_tiaohou_priority(...)
        
        # 调候五行在喜神中 → 第一喜神
        if tiaohou_element in xi_elements:
            return {
                'first_xi_shen': [...],
                'final_xi_shen': [调候十神] + [其他喜神],
                'analysis': '调候喜忌一致，XX为第一喜神'
            }
        
        # 调候五行在忌神中 → 根据优先级权衡
        elif tiaohou_element in ji_elements:
            if tiaohou_priority == 'high':
                # 调候优先，适当调整忌神
                return {...}
            else:
                # 保持原有喜忌
                return {...}
```

### 5. 应用场景

| 场景 | 如何使用调候 | 示例 |
|------|------------|------|
| 健康评分 | 缺少调候五行 → 健康分-1.5 | 夏月缺水，易火炎土燥 |
| 五行平衡分析 | 标注调候状态：严重不足/不足/适中/充足 | 流年补水0.5，大运补水1.0 |
| LLM深度解读 | 提供调候信息和分析建议 | "夏月炎热，需水调候，建议..." |
| 日常建议 | 方位、颜色、饮食等 | 夏月多喝水、穿蓝黑色衣服 |

---

## 刑冲合害破体系

### 1. 定义

地支之间的六种作用关系，影响吉凶和运势变化。

### 2. 六种关系

#### 2.1 冲（六冲）

**定义**：方位相对、五行相克、力量最强的对抗关系

**配对**：
```python
BRANCH_CHONG = {
    '子': '午', '午': '子',  # 水火相冲
    '丑': '未', '未': '丑',  # 土土相冲
    '寅': '申', '申': '寅',  # 木金相冲
    '卯': '酉', '酉': '卯',  # 木金相冲
    '辰': '戌', '戌': '辰',  # 土土相冲
    '巳': '亥', '亥': '巳',  # 火水相冲
}
```

**吉凶**：
- ✅ 冲去忌神 → 吉
- ❌ 冲动喜神 → 凶
- ❌ 日支被冲 → 婚姻不稳、健康问题

**影响**：
- 婚姻：日支被冲 → 分-1.5
- 健康：八字内冲 → 分-1，流年冲八字 → 分-1.5
- 事业：年支被冲 → 工作变动

#### 2.2 刑（三刑）

**定义**：相互刑克、惩罚，比冲弱但更阴险

**配对**：
```python
BRANCH_XING = {
    '寅': ['巳', '申'],  # 寅巳申 无恩之刑
    '巳': ['申', '寅'],
    '申': ['寅', '巳'],
    
    '丑': ['戌', '未'],  # 丑戌未 持势之刑
    '戌': ['未', '丑'],
    '未': ['丑', '戌'],
    
    '子': ['卯', '子'],  # 子卯 无礼之刑
    '卯': ['子', '卯'],
    
    '午': ['午'],  # 午午 自刑
    '酉': ['酉'],  # 酉酉 自刑
}
```

**吉凶**：
- ✅ 刑去忌神 → 吉
- ❌ 刑伤喜神 → 凶
- ❌ 日支被刑 → 健康、婚姻问题

**影响**：
- 健康：内部刑 → 分-0.5
- 婚姻：日支被刑 → 分-1
- 性格：子卯刑 → 无礼、冲动

#### 2.3 合（六合）

**定义**：相互吸引、和谐共处

**配对**：
```python
BRANCH_LIUHE = {
    '子': '丑',  # 子丑合土
    '寅': '亥',  # 寅亥合木
    '卯': '戌',  # 卯戌合火
    '辰': '酉',  # 辰酉合金
    '巳': '申',  # 巳申合水
    '午': '未',  # 午未合火土
}
```

**吉凶**：
- ✅ 合住忌神 → 吉
- ✅ 合助喜神 → 吉
- ❌ 合去喜神 → 凶

**影响**：
- 婚姻：地支合 → 分+1
- 财运：合财 → 分+0.5
- 事业：合官 → 贵人相助

#### 2.4 三合局

**定义**：三个地支会合成一种五行

**配对**：
```python
BRANCH_SANHE_GROUPS = [
    ('申', '子', '辰'),  # 三合水局
    ('亥', '卯', '未'),  # 三合木局
    ('寅', '午', '戌'),  # 三合火局
    ('巳', '酉', '丑'),  # 三合金局
]
```

**吉凶**：
- ✅ 合成喜神五行 → 大吉
- ❌ 合成忌神五行 → 大凶

**影响**：
- 事业：合局 → 分+1.5（团队力量强）
- 财运：水局/木局 → 分+1

#### 2.5 害（六害）

**定义**：相互妨害、暗中破坏

**配对**：
```python
BRANCH_HAI = {
    '子': ['未'], '未': ['子'],  # 子未相害
    '丑': ['午'], '午': ['丑'],  # 丑午相害
    '寅': ['巳'], '巳': ['寅'],  # 寅巳相害
    '卯': ['辰'], '辰': ['卯'],  # 卯辰相害
    '申': ['亥'], '亥': ['申'],  # 申亥相害
    '酉': ['戌'], '戌': ['酉'],  # 酉戌相害
}
```

**吉凶**：
- ❌ 一般为凶
- ❌ 日支被害 → 小人是非多

**影响**：
- 人际：害 → 小人多、是非多
- 健康：害 → 慢性疾病

#### 2.6 破（六破）

**定义**：相互破坏、损耗

**配对**：
```python
BRANCH_PO = {
    '子': '酉', '酉': '子',  # 子酉相破
    '丑': '辰', '辰': '丑',  # 丑辰相破
    '寅': '亥', '亥': '寅',  # 寅亥相破
    '卯': '午', '午': '卯',  # 卯午相破
    '申': '巳', '巳': '申',  # 申巳相破
    '未': '戌', '戌': '未',  # 未戌相破
}
```

**吉凶**：
- ❌ 一般为凶
- ❌ 破坏稳定、耗损财物

**影响**：
- 财运：破 → 破财、损耗
- 事业：破 → 计划受阻

### 3. 关系优先级

**作用力强度**：冲 > 刑 > 害 > 破 > 合

### 4. 代码实现

**文件**: `src/analyzers/fortune_relation_analyzer.py`

```python
class FortuneRelationAnalyzer:
    @staticmethod
    def _analyze_internal_relations(bazi_pillars):
        """分析八字内部刑冲合害破关系"""
        
        # 提取四柱地支
        branches = {}
        for pillar in ['year', 'month', 'day', 'hour']:
            branch = bazi_pillars[pillar]['branch']
            branches[pillar] = branch
        
        result = {
            'has_chong': False,
            'has_xing': False,
            'has_he': False,
            'has_hai': False,
            'has_po': False,
            'chong_details': [],
            'xing_details': [],
            # ...
            'day_branch_chong': False,  # 日支是否被冲（重要）
            'day_branch_xing': False,   # 日支是否被刑（重要）
        }
        
        # 逐对检查关系
        for b1, b2 in itertools.combinations(branches.values(), 2):
            if BRANCH_CHONG.get(b1) == b2:
                result['has_chong'] = True
                if b1 == day_branch or b2 == day_branch:
                    result['day_branch_chong'] = True
            # ... 其他关系
        
        return result
```

### 5. 应用场景

| 场景 | 如何使用刑冲合害破 | 示例 |
|------|-----------------|------|
| 健康评分 | 八字内冲/刑 → 分-1/-0.5<br>流年冲/刑八字 → 分-1.5 | 子午冲，注意心血管 |
| 婚姻评分 | 日支冲/刑 → 分-1.5/-1<br>地支合 → 分+1 | 日支逢冲，婚姻不稳 |
| 事业评分 | 合局 → 分+1.5<br>年支冲 → 工作变动 | 三合局，团队力量强 |
| 财运评分 | 合财 → 分+0.5<br>破 → 破财 | 地支合财星，财运顺 |
| LLM解读 | 提供所有关系的详情和影响 | "八字内部子午相冲..." |

---

## 综合应用

### 1. 完整分析流程

```
1. 计算八字 → 四柱、五行、十神
2. 旺衰判断 → 得令、得地、得势
3. 喜忌神（基础） → 基于旺衰
4. 调候判断 → 基于季节
5. 最终喜忌 → 综合旺衰喜忌 + 调候
6. 刑冲合害破 → 八字内部关系 + 流年/大运与八字关系
7. 五行平衡 → 八字 + 流年 + 大运，含调候分析
8. 吉凶评分 → 财运、健康、事业、婚姻，综合以上所有因素
9. LLM深度解读 → 基于所有结构化数据，生成自然语言分析
```

### 2. 权重优先级

在综合判断时，各因素的权重（由高到低）：

1. **旺衰** - 40% （基础）
2. **喜忌神（最终）** - 25% （含调候）
3. **刑冲合害破** - 20% （特殊作用）
4. **五行平衡** - 10% （辅助）
5. **十神** - 5% （细节）

### 3. 矛盾处理原则

当多个因素出现矛盾时：

1. **调候 vs 喜忌**：
   - 调候优先级高 且 缺调候五行 → 调候优先
   - 调候优先级低 或 有调候五行 → 喜忌优先

2. **冲 vs 合**：
   - 同时出现 → 冲的作用力更强
   - 先判断冲的影响，再看合的作用

3. **流年 vs 大运**：
   - 流年是当年具体运势
   - 大运是10年大趋势
   - 流年作用更直接，大运作用更持久

---

## 代码实现规范

### 1. 目录结构

```
src/analyzers/
├── wangshuai_analyzer.py          # 旺衰、喜忌神
├── tiaohou_xiji_analyzer.py       # 调候与喜忌综合判断
├── wuxing_balance_analyzer.py     # 五行平衡（含调候分析）
├── fortune_relation_analyzer.py   # 刑冲合害破分析
└── ...

server/services/
├── fortune_scoring_service.py     # 评分系统（使用以上所有分析）
├── fortune_context_service.py     # 上下文服务（集成所有分析）
└── fortune_llm_client.py          # LLM客户端（传递所有数据）
```

### 2. 命名规范

| 类型 | 命名 | 示例 |
|------|------|------|
| 喜忌神（原始） | `xi_ji` | `{'xi_shen': [...], 'ji_shen': [...]}` |
| 喜忌神（最终） | `final_xi_ji` | 综合调候的最终喜忌 |
| 调候信息 | `tiaohou` | `{'tiaohou_element': '水', ...}` |
| 内部关系 | `internal_relations` | `{'has_chong': True, ...}` |
| 流年大运关系 | `relation_analysis` | `{'liunian_bazi_relation': {...}}` |

### 3. 数据传递规范

所有分析模块必须返回**完整的结构化数据**，包括：

```python
{
    # 基础信息
    'wangshuai': '身旺',
    'total_score': 65,
    
    # 喜忌神（两套）
    'xi_ji': {...},          # 原始喜忌（基于旺衰）
    'final_xi_ji': {...},    # 最终喜忌（综合调候）
    
    # 调候
    'tiaohou': {
        'tiaohou_element': '水',
        'season': '夏季',
        'tiaohou_priority': 'high'
    },
    
    # 关系分析
    'internal_relations': {...},      # 八字内部
    'relation_analysis': {...},       # 流年/大运 vs 八字
    
    # 五行平衡
    'balance_analysis': {
        'analysis': {
            'tiaohou_analysis': {...}  # 调候分析
        }
    },
    
    # 评分
    'scores': {
        'wealth': {...},
        'health': {...},
        'career': {...},
        'marriage': {...}
    }
}
```

### 4. 日志规范

关键步骤必须记录日志：

```python
logger.info("📊 步骤8: 计算调候信息")
logger.info(f"   调候五行: {tiaohou_element}, 季节: {season}")

logger.info("📊 步骤9: 综合判断调候与喜忌")
logger.info(f"   最终喜神: {final_xi_shen}")
logger.info(f"   第一喜神: {first_xi_shen}")
```

---

## 开发注意事项

### 1. 向后兼容

- 必须保留 `xi_ji` 字段（原始喜忌）
- 新增 `final_xi_ji` 字段（最终喜忌）
- 老代码可以继续使用 `xi_ji`，新代码使用 `final_xi_ji`

### 2. 可选参数

调候和内部关系信息作为**可选参数**传递：

```python
def calculate_health_score(
    balance_analysis,
    relation_analysis,
    xi_ji,
    wangshuai,
    tiaohou: Optional[Dict] = None,        # 可选
    element_counts: Optional[Dict] = None  # 可选
):
    # 如果没有tiaohou，跳过调候检查
    if tiaohou and element_counts:
        # 调候相关逻辑
        pass
```

### 3. 测试验证

每次修改必须测试：

```bash
# 1. 单元测试
python -m pytest tests/analyzers/

# 2. 集成测试
python tests/test_fortune_analysis.py

# 3. 端到端测试
./test_performance_optimization.sh
```

### 4. 文档更新

修改代码后必须更新：

1. 方法的docstring
2. 相关的README
3. 本文档（如果涉及核心概念）

---

## 附录

### A. 参考资料

- 《滴天髓》
- 《子平真诠》
- 《穷通宝鉴》（调候理论）
- 《三命通会》（刑冲合害破）

### B. 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 八字 | Bazi | 四柱八字，年月日时 |
| 喜神 | Xi Shen | 喜用神，对命局有利 |
| 忌神 | Ji Shen | 忌讳神，对命局不利 |
| 调候 | Tiaohou | 调节气候平衡 |
| 刑 | Xing | 地支相刑 |
| 冲 | Chong | 地支相冲 |
| 合 | He | 地支相合 |
| 害 | Hai | 地支相害 |
| 破 | Po | 地支相破 |
| 十神 | Shishen / Ten Gods | 比肩、劫财、食神... |
| 五行 | Wuxing / Five Elements | 金木水火土 |
| 旺衰 | Wangshuai | 日主强弱 |

---

**文档维护**：
- 本文档是命理分析系统的**核心规范**
- 所有开发必须遵循本文档
- 如有疑问或需要扩展，请联系项目负责人

**版本历史**：
- v1.0 (2025-11-20): 初始版本
- v2.0 (2025-11-25): 增加调候喜忌综合判断、刑冲合害破完整体系

