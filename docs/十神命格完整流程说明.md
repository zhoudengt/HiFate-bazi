# 十神命格完整流程说明

## 📋 流程概览

十神命格功能从数据加载到最终呈现的完整流程，包含以下阶段：

```
数据加载 → 八字计算 → 规则匹配 → 命格提取 → ID映射 → 前端呈现
```

---

## 🔄 完整流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    十神命格完整流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【阶段1：数据加载】                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 规则数据加载（服务启动时）                                      │   │
│  │    ├─ 从数据库 `bazi_rules` 表加载                               │   │
│  │    ├─ 筛选条件：rule_type='shishen' AND enabled=1                │   │
│  │    ├─ 规则格式：JSON条件（如：{"pillar_equals": {"pillar": "day", │   │
│  │    │                        "values": ["甲子"]}}）                │   │
│  │    └─ 加载位置：RuleService.get_engine()                          │   │
│  │                                                                   │   │
│  │ 2. 配置数据加载（首次访问时）                                      │   │
│  │    ├─ 从数据库 `shishen_patterns` 表加载                          │   │
│  │    ├─ 数据格式：{name: id} 映射（如：{"正官格": 2001}）           │   │
│  │    ├─ 缓存机制：ConfigService._mingge_cache                      │   │
│  │    └─ 加载位置：ConfigService.get_all_mingge()                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【阶段2：用户请求】                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 用户输入：出生日期、时间、性别                                      │   │
│  │                                                                   │   │
│  │ 前端调用：                                                        │   │
│  │   - /api/v1/bazi/formula-analysis (公式分析页面)                  │   │
│  │   - /api/v1/bazi/xishen-jishen (喜神忌神页面)                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【阶段3：八字计算】                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 输入处理                                                       │   │
│  │    ├─ 农历转换（如需要）                                          │   │
│  │    ├─ 时区转换（如需要）                                          │   │
│  │    └─ 夏令时处理（如需要）                                        │   │
│  │                                                                   │   │
│  │ 2. 八字计算                                                       │   │
│  │    ├─ 调用：BaziService.calculate_bazi_full()                    │   │
│  │    ├─ 计算四柱（年、月、日、时）                                   │   │
│  │    ├─ 计算十神（主星、副星）                                       │   │
│  │    ├─ 计算五行（元素统计）                                         │   │
│  │    └─ 返回完整八字数据                                             │   │
│  │                                                                   │   │
│  │ 输出：bazi_data（包含 bazi_pillars, ten_gods_stats 等）           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【阶段4：规则匹配】                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 构建规则匹配数据                                                │   │
│  │    ├─ basic_info: 基础信息                                        │   │
│  │    ├─ bazi_pillars: 四柱信息（年、月、日、时）                     │   │
│  │    ├─ ten_gods_stats: 十神统计                                    │   │
│  │    ├─ elements: 五行信息                                          │   │
│  │    └─ relationships: 关系信息                                      │   │
│  │                                                                   │   │
│  │ 2. 规则匹配                                                       │   │
│  │    ├─ 调用：RuleService.match_rules(rule_data, rule_types=['shishen']) │
│  │    ├─ 规则引擎：EnhancedRuleEngine                                │   │
│  │    ├─ 匹配逻辑：基于日柱匹配（pillar_equals 条件）                 │   │
│  │    ├─ 索引优化：使用日柱索引加速匹配                                │   │
│  │    └─ 返回匹配的规则列表                                           │   │
│  │                                                                   │   │
│  │ 输出：matched_rules（包含匹配的规则ID列表）                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【阶段5：命格提取】                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 获取规则详情                                                    │   │
│  │    ├─ 从数据库查询规则详情（rule_details）                        │   │
│  │    ├─ 提取规则的"结果"字段（content.text 或 content.结果）        │   │
│  │    └─ 规则结果包含命格名称（如："正官格"）                         │   │
│  │                                                                   │   │
│  │ 2. 命格名称提取                                                    │   │
│  │    ├─ 获取所有命格名称列表（ConfigService.get_all_mingge()）      │   │
│  │    ├─ 按长度降序排序（避免部分匹配问题）                           │   │
│  │    ├─ 在规则结果文本中查找命格名称                                 │   │
│  │    └─ 提取匹配的命格名称列表                                       │   │
│  │                                                                   │   │
│  │ 输出：shishen_mingge_names（如：["正官格", "七杀格"]）             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【阶段6：ID映射】                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 命格名称映射                                                    │   │
│  │    ├─ 调用：ConfigService.map_mingge_to_ids(mingge_names)        │   │
│  │    ├─ 查询缓存：ConfigService._mingge_cache                      │   │
│  │    ├─ 映射格式：{"name": "正官格", "id": 2001}                    │   │
│  │    └─ 返回命格列表（包含名称和ID）                                 │   │
│  │                                                                   │   │
│  │ 输出：shishen_mingge（如：[{"name": "正官格", "id": 2001}]）      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【阶段7：前端呈现】                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 公式分析页面（formula-analysis.html）                          │   │
│  │    ├─ 显示统计：shishen_count                                     │   │
│  │    ├─ 显示标签页：🔮 十神命格                                      │   │
│  │    ├─ 显示规则列表：规则ID、类型、结果                             │   │
│  │    └─ 显示规则详情：完整的规则内容                                 │   │
│  │                                                                   │   │
│  │ 2. 喜神忌神页面（xishen-jishen.html）                             │   │
│  │    ├─ 显示十神命格列表：命格名称和ID                               │   │
│  │    ├─ 显示喜神五行：五行名称和ID                                   │   │
│  │    ├─ 显示忌神五行：五行名称和ID                                   │   │
│  │    └─ 流式生成大模型分析（基于命格和五行）                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📁 关键文件说明

### 1. 数据加载相关

| 文件 | 功能 | 说明 |
|------|------|------|
| `server/services/rule_service.py` | 规则服务 | 从数据库加载规则，提供规则匹配接口 |
| `server/services/config_service.py` | 配置服务 | 从数据库加载十神命格配置，提供ID映射 |
| `server/engines/rule_engine.py` | 规则引擎 | 规则匹配核心逻辑，支持索引优化 |

### 2. 数据处理相关

| 文件 | 功能 | 说明 |
|------|------|------|
| `server/api/v1/formula_analysis.py` | 公式分析API | 提供规则匹配接口，返回匹配的规则 |
| `server/api/v1/xishen_jishen.py` | 喜神忌神API | 获取十神命格，并映射ID |
| `server/services/bazi_service.py` | 八字服务 | 计算八字数据（四柱、十神、五行等） |

### 3. 前端呈现相关

| 文件 | 功能 | 说明 |
|------|------|------|
| `local_frontend/formula-analysis.html` | 公式分析页面 | 显示所有规则类型，包括十神命格 |
| `local_frontend/xishen-jishen.html` | 喜神忌神页面 | 显示十神命格、喜神五行、忌神五行 |
| `local_frontend/js/xishen-jishen.js` | 前端逻辑 | 调用API，渲染数据 |

---

## 🔍 详细流程说明

### 阶段1：数据加载

**规则数据加载**：
- **位置**：`server/services/rule_service.py` - `RuleService.get_engine()`
- **时机**：服务启动时（单例模式）
- **数据源**：数据库 `bazi_rules` 表
- **筛选条件**：`rule_type='shishen' AND enabled=1`
- **数据格式**：
  ```json
  {
    "rule_id": "FORMULA_十神命格_40001",
    "rule_type": "shishen",
    "conditions": {
      "pillar_equals": {
        "pillar": "day",
        "values": ["甲子"]
      }
    },
    "content": {
      "text": "甲子日出生的命主，正官格..."
    }
  }
  ```

**配置数据加载**：
- **位置**：`server/services/config_service.py` - `ConfigService.get_all_mingge()`
- **时机**：首次访问时（带缓存）
- **数据源**：数据库 `shishen_patterns` 表
- **数据格式**：
  ```json
  {
    "正官格": 2001,
    "七杀格": 2002,
    "正财格": 2003,
    ...
  }
  ```

### 阶段2：用户请求

**前端调用方式**：

1. **公式分析页面**：
   ```javascript
   // local_frontend/formula-analysis.html
   const result = await api.post('/bazi/formula-analysis', {
       solar_date: birthDate,
       solar_time: birthTime,
       gender: gender
   });
   ```

2. **喜神忌神页面**：
   ```javascript
   // local_frontend/js/xishen-jishen.js
   const response = await api.post('/bazi/xishen-jishen', {
       solar_date: userInfo.solar_date,
       solar_time: userInfo.solar_time,
       gender: userInfo.gender
   });
   ```

### 阶段3：八字计算

**计算流程**：
```python
# server/api/v1/formula_analysis.py
bazi_result = BaziService.calculate_bazi_full(
    solar_date=final_solar_date,
    solar_time=final_solar_time,
    gender=request.gender
)

# 返回数据结构：
{
    'bazi': {
        'bazi_pillars': {
            'year': {'stem': '甲', 'branch': '子'},
            'month': {'stem': '丙', 'branch': '寅'},
            'day': {'stem': '甲', 'branch': '子'},  # 日柱（用于匹配）
            'hour': {'stem': '甲', 'branch': '子'}
        },
        'ten_gods_stats': {...},
        'elements': {...},
        ...
    }
}
```

### 阶段4：规则匹配

**匹配流程**：
```python
# server/api/v1/formula_analysis.py
rule_data = {
    'basic_info': bazi_data.get('basic_info', {}),
    'bazi_pillars': bazi_data.get('bazi_pillars', {}),
    'ten_gods_stats': bazi_data.get('ten_gods_stats', {}),
    ...
}

# 调用规则服务匹配
rule_matched = RuleService.match_rules(
    rule_data, 
    rule_types=['shishen'], 
    use_cache=True
)

# 返回匹配的规则列表
matched_rules = [
    {
        'rule_id': 'FORMULA_十神命格_40001',
        'rule_type': 'shishen',
        'conditions': {...},
        'content': {...}
    },
    ...
]
```

**匹配逻辑**：
- **规则引擎**：`EnhancedRuleEngine`
- **匹配条件**：基于日柱匹配（`pillar_equals` 条件）
- **索引优化**：使用日柱索引（`by_day_pillar`）加速匹配
- **匹配示例**：日柱为"甲子"时，匹配规则ID为 `FORMULA_十神命格_40001` 的规则

### 阶段5：命格提取

**提取流程**：
```python
# server/api/v1/xishen_jishen.py
# 1. 获取匹配的规则ID列表
shishen_rule_ids = matched_rules.get('shishen', [])

# 2. 获取所有命格名称列表
all_mingge_names = list(ConfigService.get_all_mingge().keys())
all_mingge_names_sorted = sorted(all_mingge_names, key=len, reverse=True)

# 3. 从规则结果中提取命格名称
shishen_mingge_names = []
for rule_id in shishen_rule_ids:
    rule_detail = rule_details.get(rule_id, {})
    rule_result = rule_detail.get('结果') or rule_detail.get('result') or ''
    
    # 在结果文本中查找命格名称
    for mingge_name in all_mingge_names_sorted:
        if mingge_name in rule_result:
            if mingge_name not in shishen_mingge_names:
                shishen_mingge_names.append(mingge_name)
                break
```

**提取示例**：
- 规则结果：`"甲子日出生的命主，正官格，性格温和..."`
- 提取结果：`["正官格"]`

### 阶段6：ID映射

**映射流程**：
```python
# server/services/config_service.py
def map_mingge_to_ids(mingge_names: List[str]) -> List[Dict[str, any]]:
    """批量映射十神命格名称到ID"""
    mapping = cls._get_mingge_mapping()  # 从缓存获取
    result = []
    for name in mingge_names:
        mingge_id = mapping.get(name)
        if mingge_id:
            result.append({'name': name, 'id': mingge_id})
    return result
```

**映射示例**：
- 输入：`["正官格", "七杀格"]`
- 输出：`[{"name": "正官格", "id": 2001}, {"name": "七杀格", "id": 2002}]`

### 阶段7：前端呈现

**公式分析页面**：
```javascript
// local_frontend/formula-analysis.html
// 1. 显示统计
displayStatistics(data.statistics);
// 显示：shishen_count: 1

// 2. 显示标签页
displayTabs(data.matched_rules, data.rule_details);
// 显示：🔮 十神命格 标签页

// 3. 显示规则列表
// 显示匹配的规则ID、类型、结果
```

**喜神忌神页面**：
```javascript
// local_frontend/js/xishen-jishen.js
// 1. 显示十神命格
displayMingge('shishenMingge', data.shishen_mingge || []);
// 显示：正官格 (ID: 2001)

// 2. 流式生成大模型分析
await generateLLMAnalysis(userInfo);
// 基于命格和五行生成详细分析
```

---

## 🗄️ 数据库表结构

### 1. bazi_rules 表（规则表）

```sql
CREATE TABLE `bazi_rules` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `rule_code` VARCHAR(100) NOT NULL UNIQUE,  -- 规则编码：FORMULA_十神命格_40001
    `rule_name` VARCHAR(200),                   -- 规则名称
    `rule_type` VARCHAR(50) NOT NULL,           -- 规则类型：shishen
    `conditions` JSON,                          -- 匹配条件（JSON格式）
    `content` JSON,                             -- 规则内容/结果（JSON格式）
    `priority` INT DEFAULT 100,                 -- 优先级
    `enabled` TINYINT DEFAULT 1,                -- 是否启用
    ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**示例数据**：
```json
{
    "rule_code": "FORMULA_十神命格_40001",
    "rule_type": "shishen",
    "conditions": {
        "pillar_equals": {
            "pillar": "day",
            "values": ["甲子"]
        }
    },
    "content": {
        "text": "甲子日出生的命主，正官格，性格温和..."
    }
}
```

### 2. shishen_patterns 表（十神命格配置表）

```sql
CREATE TABLE `shishen_patterns` (
    `id` INT PRIMARY KEY,
    `name` VARCHAR(50) NOT NULL UNIQUE  -- 命格名称：正官格、七杀格等
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**示例数据**：
```sql
INSERT INTO `shishen_patterns` (`id`, `name`) VALUES
(2001, '正官格'),
(2002, '七杀格'),
(2003, '正财格'),
...
```

---

## 🔧 API 接口说明

### 1. 公式分析接口

**接口**：`POST /api/v1/bazi/formula-analysis`

**请求参数**：
```json
{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "rule_types": ["shishen"]  // 可选，不传则查询所有类型
}
```

**响应数据**：
```json
{
    "success": true,
    "data": {
        "matched_rules": {
            "shishen": ["FORMULA_十神命格_40001"]
        },
        "rule_details": {
            "FORMULA_十神命格_40001": {
                "type": "十神命格",
                "result": "甲子日出生的命主，正官格..."
            }
        },
        "statistics": {
            "shishen_count": 1
        }
    }
}
```

### 2. 喜神忌神接口

**接口**：`POST /api/v1/bazi/xishen-jishen`

**请求参数**：
```json
{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male"
}
```

**响应数据**：
```json
{
    "success": true,
    "data": {
        "shishen_mingge": [
            {"name": "正官格", "id": 2001}
        ],
        "xi_shen_elements": [
            {"name": "金", "id": 4},
            {"name": "土", "id": 3}
        ],
        "ji_shen_elements": [
            {"name": "水", "id": 5}
        ]
    }
}
```

---

## 📊 性能优化

### 1. 规则加载优化

- **单例模式**：规则引擎只初始化一次
- **索引优化**：使用日柱索引加速匹配
- **缓存机制**：规则数据缓存，减少数据库查询

### 2. 配置加载优化

- **缓存机制**：`ConfigService._mingge_cache` 缓存命格映射
- **首次加载**：首次访问时加载，后续使用缓存

### 3. 规则匹配优化

- **索引加速**：使用日柱索引（`by_day_pillar`）快速定位候选规则
- **条件过滤**：只匹配 `rule_type='shishen'` 的规则
- **缓存使用**：`use_cache=True` 启用缓存

---

## ✅ 检查清单

每次修改十神命格相关功能时，必须检查：

- [ ] 规则数据是否正确加载（数据库查询）
- [ ] 配置数据是否正确加载（ID映射）
- [ ] 八字计算是否正确（日柱数据）
- [ ] 规则匹配是否正确（匹配逻辑）
- [ ] 命格提取是否正确（名称提取）
- [ ] ID映射是否正确（配置映射）
- [ ] 前端展示是否正确（页面渲染）

---

## 📚 相关文档

- **规则开发规范**：`.cursorrules` - "📜 规则开发规范"章节
- **规则存储规范**：`.cursorrules` - "🔴 规则存储规范"章节
- **十神命格规则开发完成**：`docs/root_docs/十神命格规则开发完成.md`

---

**核心要点**：
- **数据加载**：从数据库加载规则和配置（服务启动时）
- **数据处理**：八字计算 → 规则匹配 → 命格提取 → ID映射
- **数据呈现**：前端页面展示命格名称和ID
- **性能优化**：使用索引和缓存加速匹配

