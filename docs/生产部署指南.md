# HiFate-bazi ç”Ÿäº§éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æœåŠ¡å™¨ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| æœåŠ¡å™¨ IP | 123.57.216.15 |
| SSH ç”¨æˆ· | root |
| SSH ç«¯å£ | 22 |
| ä»£ç ä»“åº“ | https://gitee.com/zhoudengtang/hifate-prod.git |
| éƒ¨ç½²ç›®å½• | /opt/HiFate-bazi |

---

## ğŸš€ ä¸€ã€é¦–æ¬¡éƒ¨ç½²ï¼ˆæœåŠ¡å™¨åˆå§‹åŒ–ï¼‰

### 1.1 ç™»å½•æœåŠ¡å™¨

```bash
ssh root@123.57.216.15
```

### 1.2 å®‰è£…åŸºç¡€ç¯å¢ƒ

```bash
# æ›´æ–°ç³»ç»Ÿ
apt update && apt upgrade -y

# å®‰è£… Docker
curl -fsSL https://get.docker.com | sh

# å®‰è£… Docker Compose
apt install -y docker-compose-plugin

# å¯åŠ¨ Docker
systemctl enable docker
systemctl start docker

# éªŒè¯å®‰è£…
docker --version
docker compose version

# å®‰è£… Git
apt install -y git
```

### 1.3 é…ç½® Gitee è®¿é—®

```bash
# åˆ›å»ºéƒ¨ç½²ç›®å½•
mkdir -p /opt/HiFate-bazi
cd /opt

# å…‹éš†ä»£ç ï¼ˆé¦–æ¬¡ï¼‰
git clone https://gitee.com/zhoudengtang/hifate-prod.git HiFate-bazi
cd HiFate-bazi

# é…ç½® Git ä¿å­˜å¯†ç ï¼ˆé¿å…æ¯æ¬¡è¾“å…¥ï¼‰
git config --global credential.helper store
```

### 1.4 åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®

```bash
# åˆ›å»º .env æ–‡ä»¶
cat > /opt/HiFate-bazi/.env << 'EOF'
# === ç”Ÿäº§ç¯å¢ƒé…ç½® ===
APP_ENV=production
DEBUG=False

# MySQL é…ç½®ï¼ˆä½¿ç”¨å¼ºå¯†ç ï¼ï¼‰
MYSQL_ROOT_PASSWORD=HiFate_Prod_2024!
MYSQL_USER=root
MYSQL_DATABASE=bazi_system

# Redis é…ç½®
REDIS_PASSWORD=HiFate_Redis_2024!

# Web ç«¯å£
WEB_PORT=8001

# å¯†é’¥ï¼ˆåŠ¡å¿…ä¿®æ”¹ï¼ï¼‰
SECRET_KEY=your-super-secret-key-change-me

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=WARNING
EOF

# è®¾ç½®æƒé™ï¼ˆä¿æŠ¤å¯†ç ï¼‰
chmod 600 /opt/HiFate-bazi/.env
```

### 1.5 é¦–æ¬¡å¯åŠ¨

```bash
cd /opt/HiFate-bazi

# æ„å»ºå¹¶å¯åŠ¨ï¼ˆé¦–æ¬¡ä¼šæ¯”è¾ƒæ…¢ï¼Œåç»­ä¼šä½¿ç”¨ç¼“å­˜ï¼‰
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f
```

---

## ğŸ”„ äºŒã€æ—¥å¸¸æ›´æ–°éƒ¨ç½²ï¼ˆé›¶åœæœºï¼‰

### æ–¹å¼ Aï¼šæœåŠ¡å™¨ç›´æ¥æ‹‰å–ï¼ˆæ¨èï¼‰

```bash
# ç™»å½•æœåŠ¡å™¨
ssh root@123.57.216.15

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/HiFate-bazi

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# é›¶åœæœºæ›´æ–°
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

# æŸ¥çœ‹çŠ¶æ€
docker compose ps
```

### æ–¹å¼ Bï¼šæœ¬åœ°ä¸€é”®éƒ¨ç½²

åœ¨æœ¬åœ°æ‰§è¡Œï¼š
```bash
./deploy.sh
# é€‰æ‹© 6: éƒ¨ç½²åˆ°æœåŠ¡å™¨ (Gitee)
```

---

## ğŸŒ ä¸‰ã€å¼€å‘/ç”Ÿäº§åœ°å€åˆ‡æ¢

### 3.1 å‰ç«¯é…ç½®ï¼ˆè‡ªåŠ¨åˆ‡æ¢ï¼‰

ä¿®æ”¹ `frontend/config.js`ï¼š

```javascript
// API é…ç½® - è‡ªåŠ¨è¯†åˆ«ç¯å¢ƒ
const API_CONFIG = (function() {
    const hostname = window.location.hostname;
    
    // ç”Ÿäº§ç¯å¢ƒåˆ¤æ–­
    const isProduction = hostname === '123.57.216.15' || 
                         hostname === 'your-domain.com';
    
    // æ ¹æ®ç¯å¢ƒè¿”å›é…ç½®
    if (isProduction) {
        return {
            baseURL: 'http://123.57.216.15:8001/api/v1',
            timeout: 60000,
            fortuneApiKey: 'fortune_analysis_default_key_2024'
        };
    } else {
        return {
            baseURL: 'http://127.0.0.1:8001/api/v1',
            timeout: 60000,
            fortuneApiKey: 'fortune_analysis_default_key_2024'
        };
    }
})();

// gRPC-Web é…ç½®
const GRPC_CONFIG = (function() {
    const hostname = window.location.hostname;
    const isProduction = hostname === '123.57.216.15' || 
                         hostname === 'your-domain.com';
    
    const baseHost = isProduction ? 'http://123.57.216.15:8001' : 'http://127.0.0.1:8001';
    
    return {
        enabled: true,
        baseURL: baseHost + '/api/grpc-web',
        timeout: 60000,
        endpoints: []
    };
})();

// å­˜å‚¨ Token çš„ key
const TOKEN_KEY = 'bazi_token';

// è°ƒè¯•ä¿¡æ¯ï¼ˆå¯åˆ é™¤ï¼‰
console.log('å½“å‰ç¯å¢ƒ:', window.location.hostname);
console.log('API åœ°å€:', API_CONFIG.baseURL);
```

### 3.2 åç«¯é…ç½®

åç«¯é€šè¿‡ç¯å¢ƒå˜é‡è‡ªåŠ¨é€‚é…ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ï¼š

| ç¯å¢ƒ | APP_ENV | DEBUG |
|------|---------|-------|
| å¼€å‘ | development | True |
| ç”Ÿäº§ | production | False |

---

## âš¡ å››ã€Docker æ„å»ºåŠ é€Ÿ

### 4.1 å·²ä¼˜åŒ–é¡¹

1. **å›½å†…é•œåƒæº**ï¼šDockerfile ä½¿ç”¨é˜¿é‡Œäº‘ apt æº + æ¸…å pip æº
2. **å±‚ç¼“å­˜**ï¼šrequirements.txt å•ç‹¬å¤åˆ¶ï¼Œä¾èµ–ä¸å˜ä¸é‡æ–°å®‰è£…
3. **å¤šé˜¶æ®µæ„å»º**ï¼šå‡å°æœ€ç»ˆé•œåƒä½“ç§¯

### 4.2 åŠ é€ŸæŠ€å·§

```bash
# åªé‡å»ºæœ‰å˜åŒ–çš„æœåŠ¡
docker compose up -d --build web

# å¼ºåˆ¶ä½¿ç”¨ç¼“å­˜ï¼ˆå³ä½¿æœ‰æ–°ä»£ç ï¼‰
docker compose build --no-cache=false

# å¹¶è¡Œæ„å»º
docker compose build --parallel
```

### 4.3 é…ç½® Docker é•œåƒåŠ é€Ÿï¼ˆæœåŠ¡å™¨ç«¯ï¼‰

```bash
# åˆ›å»º Docker é…ç½®
cat > /etc/docker/daemon.json << 'EOF'
{
    "registry-mirrors": [
        "https://docker.mirrors.ustc.edu.cn",
        "https://hub-mirror.c.163.com",
        "https://mirror.baidubce.com"
    ]
}
EOF

# é‡å¯ Docker
systemctl daemon-reload
systemctl restart docker
```

---

## ğŸ“Š äº”ã€è¿ç»´å‘½ä»¤

### 5.1 æŸ¥çœ‹çŠ¶æ€

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker compose ps

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f web
docker compose logs -f --tail=100 web

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats
```

### 5.2 é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker compose restart

# åªé‡å¯ web æœåŠ¡
docker compose restart web

# å®Œå…¨é‡å»º
docker compose down
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

### 5.3 æ¸…ç†

```bash
# æ¸…ç†æ— ç”¨é•œåƒ
docker image prune -f

# æ¸…ç†æ„å»ºç¼“å­˜
docker builder prune -f

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
docker system df
```

### 5.4 æ•°æ®å¤‡ä»½

```bash
# å¤‡ä»½ MySQL æ•°æ®
docker exec hifate-mysql mysqldump -u root -p'HiFate_Prod_2024!' bazi_system > backup_$(date +%Y%m%d).sql

# å¤‡ä»½ Redis æ•°æ®
docker exec hifate-redis redis-cli BGSAVE
docker cp hifate-redis:/data/dump.rdb ./redis_backup_$(date +%Y%m%d).rdb
```

---

## ğŸ”§ å…­ã€æ•…éšœæ’æŸ¥

### 6.1 æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker compose logs --tail=50 web

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 8001

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a
```

### 6.2 æ„å»ºå¤±è´¥

```bash
# æ¸…ç†ç¼“å­˜åé‡å»º
docker compose down
docker system prune -f
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

### 6.3 æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ MySQL å®¹å™¨
docker exec -it hifate-mysql mysql -u root -p

# æ£€æŸ¥ç½‘ç»œ
docker network inspect hifate-bazi_hifate-network
```

---

## ğŸ“ ä¸ƒã€å®Œæ•´éƒ¨ç½²æµç¨‹ç¤ºä¾‹

```bash
# === æœ¬åœ°å¼€å‘å®Œæˆå ===

# 1. æäº¤ä»£ç 
git add .
git commit -m "[åŠŸèƒ½] xxx"
git push gitee master

# === æœåŠ¡å™¨éƒ¨ç½² ===

# 2. ç™»å½•æœåŠ¡å™¨
ssh root@123.57.216.15

# 3. æ‹‰å–å¹¶éƒ¨ç½²
cd /opt/HiFate-bazi
git pull origin master
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

# 4. éªŒè¯
docker compose ps
curl http://localhost:8001/api/v1/health
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡éƒ¨ç½²è¾ƒæ…¢**ï¼šéœ€è¦ä¸‹è½½åŸºç¡€é•œåƒå’Œå®‰è£…ä¾èµ–ï¼Œçº¦ 10-15 åˆ†é’Ÿ
2. **åç»­æ›´æ–°å¾ˆå¿«**ï¼šåˆ©ç”¨ Docker ç¼“å­˜ï¼Œé€šå¸¸ 1-3 åˆ†é’Ÿ
3. **é›¶åœæœº**ï¼šä½¿ç”¨ `up -d --build`ï¼ŒDocker ä¼šå…ˆå¯åŠ¨æ–°å®¹å™¨å†åœæ­¢æ—§å®¹å™¨
4. **å¯†ç å®‰å…¨**ï¼š`.env` æ–‡ä»¶ä¸­çš„å¯†ç åŠ¡å¿…ä¿®æ”¹ï¼Œä¸è¦ä½¿ç”¨ç¤ºä¾‹å¯†ç 
5. **é˜²ç«å¢™**ï¼šç¡®ä¿ 8001 ç«¯å£å·²å¼€æ”¾

```bash
# å¼€æ”¾ç«¯å£ï¼ˆå¦‚æœä½¿ç”¨ ufwï¼‰
ufw allow 8001/tcp
```

