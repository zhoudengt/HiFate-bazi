# æ¶æ„æ”¹è¿›è¯´æ˜

## ğŸ“‹ æ”¹è¿›å†…å®¹

æœ¬æ¬¡æ”¹è¿›è§£å†³äº†ä¸‰ä¸ªæ¶æ„é—®é¢˜ï¼š
1. **æœåŠ¡è€¦åˆåº¦è¾ƒé«˜** - ä½¿ç”¨ä¾èµ–æ³¨å…¥é™ä½è€¦åˆ
2. **ç¼ºå°‘æ¥å£æŠ½è±¡å±‚** - åˆ›å»ºæ¥å£æŠ½è±¡å±‚
3. **é…ç½®ç®¡ç†åˆ†æ•£** - ç»Ÿä¸€é…ç½®ç®¡ç†

---

## ğŸ¯ æ”¹è¿›æ–¹æ¡ˆ

### 1. ç»Ÿä¸€é…ç½®ç®¡ç†

**æ–‡ä»¶**ï¼š`server/config/app_config.py`

**æ”¹è¿›å‰**ï¼š
```python
# é…ç½®åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹
mysql_config = {'host': os.getenv('MYSQL_HOST', 'localhost'), ...}  # mysql_config.py
REDIS_CONFIG = {'host': 'localhost', ...}  # redis_config.py
core_service_url = os.getenv("BAZI_CORE_SERVICE_URL")  # bazi_service.py
```

**æ”¹è¿›å**ï¼š
```python
# ç»Ÿä¸€é…ç½®ç®¡ç†
from server.config.app_config import get_config

config = get_config()
db_host = config.database.host
redis_host = config.redis.host
core_url = config.services.bazi_core_url
```

**ä¼˜åŠ¿**ï¼š
- âœ… é…ç½®é›†ä¸­ç®¡ç†
- âœ… ç±»å‹å®‰å…¨ï¼ˆä½¿ç”¨ dataclassï¼‰
- âœ… æ˜“äºæµ‹è¯•ï¼ˆå¯ä»¥ Mockï¼‰
- âœ… æ”¯æŒçƒ­é‡è½½

---

### 2. æ¥å£æŠ½è±¡å±‚

**æ–‡ä»¶**ï¼š`server/interfaces/`

**åˆ›å»ºçš„æ¥å£**ï¼š
- `IBaziCoreClient` - å…«å­—æ ¸å¿ƒå®¢æˆ·ç«¯æ¥å£
- `IBaziRuleClient` - è§„åˆ™å®¢æˆ·ç«¯æ¥å£
- `IBaziFortuneClient` - è¿åŠ¿å®¢æˆ·ç«¯æ¥å£
- `IBaziCalculator` - å…«å­—è®¡ç®—å™¨æ¥å£

**æ”¹è¿›å‰**ï¼š
```python
# ç›´æ¥ä¾èµ–å…·ä½“å®ç°
from src.clients.bazi_core_client_grpc import BaziCoreClient
client = BaziCoreClient(...)
```

**æ”¹è¿›å**ï¼š
```python
# ä¾èµ–æ¥å£
from server.interfaces.bazi_core_client_interface import IBaziCoreClient
from server.adapters.bazi_core_client_adapter import BaziCoreClientAdapter

client: IBaziCoreClient = BaziCoreClientAdapter(...)
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯ä»¥è½»æ¾æ›¿æ¢å®ç°
- âœ… æ˜“äº Mock æµ‹è¯•
- âœ… ç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™

---

### 3. ä¾èµ–æ³¨å…¥

**æ–‡ä»¶**ï¼š`server/services/bazi_service_v2.py`

**æ”¹è¿›å‰**ï¼š
```python
class BaziService:
    @staticmethod
    def calculate_bazi_full(...):
        # åœ¨æ–¹æ³•å†…éƒ¨ç›´æ¥åˆ›å»ºå®¢æˆ·ç«¯
        client = BaziCoreClient(...)
        calculator = BaziCalculator(...)
```

**æ”¹è¿›å**ï¼š
```python
class BaziServiceV2:
    def __init__(self, core_client: Optional[IBaziCoreClient] = None):
        # é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
        self._core_client = core_client
    
    def calculate_bazi_full(self, ...):
        # ä½¿ç”¨æ³¨å…¥çš„ä¾èµ–
        if self._core_client:
            result = self._core_client.calculate_bazi(...)
```

**ä¼˜åŠ¿**ï¼š
- âœ… é™ä½è€¦åˆåº¦
- âœ… æ˜“äºæµ‹è¯•ï¼ˆå¯ä»¥æ³¨å…¥ Mockï¼‰
- âœ… çµæ´»æ›¿æ¢å®ç°

---

## ğŸ“ æ–°å¢æ–‡ä»¶ç»“æ„

```
server/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ app_config.py          # ç»Ÿä¸€é…ç½®ç®¡ç†ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ interfaces/                 # æ¥å£æŠ½è±¡å±‚ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ bazi_core_client_interface.py
â”‚   â”œâ”€â”€ bazi_rule_client_interface.py
â”‚   â”œâ”€â”€ bazi_fortune_client_interface.py
â”‚   â””â”€â”€ bazi_calculator_interface.py
â”œâ”€â”€ adapters/                   # é€‚é…å™¨ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ bazi_core_client_adapter.py
â”‚   â”œâ”€â”€ bazi_rule_client_adapter.py
â”‚   â””â”€â”€ bazi_calculator_adapter.py
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ bazi_service.py        # åŸæœ‰æœåŠ¡ï¼ˆä¿æŒä¸å˜ï¼Œå‘åå…¼å®¹ï¼‰
â”‚   â””â”€â”€ bazi_service_v2.py      # æ”¹è¿›ç‰ˆæœåŠ¡ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ factories/                  # æœåŠ¡å·¥å‚ï¼ˆæ–°å¢ï¼‰
    â””â”€â”€ service_factory.py
```

---

## ğŸ”„ ä½¿ç”¨æ–¹å¼

### æ–¹å¼ 1ï¼šä½¿ç”¨æ”¹è¿›ç‰ˆæœåŠ¡ï¼ˆæ¨èï¼‰

```python
from server.services.bazi_service_v2 import BaziServiceV2

# ä½¿ç”¨é»˜è®¤é…ç½®åˆ›å»º
service = BaziServiceV2.create_default()
result = service.calculate_bazi_full("1990-01-15", "12:00", "male")
```

### æ–¹å¼ 2ï¼šä½¿ç”¨æœåŠ¡å·¥å‚

```python
from server.factories.service_factory import ServiceFactory

service = ServiceFactory.create_bazi_service()
result = service.calculate_bazi_full("1990-01-15", "12:00", "male")
```

### æ–¹å¼ 3ï¼šè‡ªå®šä¹‰ä¾èµ–æ³¨å…¥

```python
from server.services.bazi_service_v2 import BaziServiceV2
from server.interfaces.bazi_core_client_interface import IBaziCoreClient
from unittest.mock import Mock

# åˆ›å»º Mock å®¢æˆ·ç«¯
mock_client = Mock(spec=IBaziCoreClient)
mock_client.calculate_bazi.return_value = {...}

# æ³¨å…¥ Mock å®¢æˆ·ç«¯
service = BaziServiceV2(core_client=mock_client)
result = service.calculate_bazi_full("1990-01-15", "12:00", "male")
```

---

## âœ… å‘åå…¼å®¹

**é‡è¦**ï¼šåŸæœ‰ä»£ç å®Œå…¨ä¸å—å½±å“ï¼

- âœ… `BaziService.calculate_bazi_full()` ä»ç„¶å¯ç”¨ï¼ˆé™æ€æ–¹æ³•ï¼‰
- âœ… åŸæœ‰å¯¼å…¥è·¯å¾„ä¸å˜
- âœ… åŸæœ‰åŠŸèƒ½ä¸å—å½±å“

**è¿ç§»å»ºè®®**ï¼š
- æ–°ä»£ç ä½¿ç”¨ `BaziServiceV2`
- æ—§ä»£ç å¯ä»¥é€æ­¥è¿ç§»
- ä¸¤è€…å¯ä»¥å…±å­˜

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•

```bash
# æµ‹è¯•é…ç½®ç®¡ç†
pytest tests/unit/test_config.py -v

# æµ‹è¯•æ”¹è¿›ç‰ˆæœåŠ¡
pytest tests/unit/test_bazi_service_v2.py -v

# æµ‹è¯•æœåŠ¡å·¥å‚
pytest tests/unit/test_service_factory.py -v

# æµ‹è¯•æ¶æ„æ”¹è¿›
pytest tests/integration/test_architecture_improvements.py -v
```

### æµ‹è¯•è¦†ç›–

- âœ… ç»Ÿä¸€é…ç½®ç®¡ç†æµ‹è¯•
- âœ… æ¥å£æŠ½è±¡å±‚æµ‹è¯•
- âœ… ä¾èµ–æ³¨å…¥æµ‹è¯•
- âœ… Mock æµ‹è¯•éªŒè¯
- âœ… æœåŠ¡å·¥å‚æµ‹è¯•

---

## ğŸ“Š æ”¹è¿›æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å |
|------|--------|--------|
| **é…ç½®ç®¡ç†** | åˆ†æ•£åœ¨ 5+ ä¸ªæ–‡ä»¶ | ç»Ÿä¸€åœ¨ 1 ä¸ªæ–‡ä»¶ |
| **æœåŠ¡è€¦åˆåº¦** | é«˜ï¼ˆç›´æ¥ä¾èµ–å…·ä½“ç±»ï¼‰ | ä½ï¼ˆä¾èµ–æ¥å£ï¼‰ |
| **å¯æµ‹è¯•æ€§** | éš¾ä»¥ Mock | æ˜“äº Mock |
| **å¯æ‰©å±•æ€§** | éš¾ä»¥æ›¿æ¢å®ç° | è½»æ¾æ›¿æ¢å®ç° |
| **ä»£ç å¤ç”¨** | ä½ | é«˜ |

---

## ğŸ“ è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰

```python
# é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
class BaziServiceV2:
    def __init__(self, core_client: IBaziCoreClient):
        self._core_client = core_client
```

### 2. å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰

```python
# ä½¿ç”¨å·¥å‚åˆ›å»ºæœåŠ¡å®ä¾‹
service = ServiceFactory.create_bazi_service()
```

### 3. é€‚é…å™¨æ¨¡å¼ï¼ˆAdapter Patternï¼‰

```python
# é€‚é…å™¨å°†ç°æœ‰ç±»é€‚é…ä¸ºæ¥å£
class BaziCoreClientAdapter(IBaziCoreClient):
    def __init__(self, base_url: str):
        self._client = GrpcBaziCoreClient(base_url=base_url)
```

### 4. å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰

```python
# é…ç½®å•ä¾‹
config = get_config()  # æ€»æ˜¯è¿”å›åŒä¸€ä¸ªå®ä¾‹
```

---

## ğŸš€ ä¸‹ä¸€æ­¥æ”¹è¿›å»ºè®®

1. **é€æ­¥è¿ç§»ç°æœ‰æœåŠ¡**
   - å°†å…¶ä»–æœåŠ¡ä¹Ÿæ”¹ä¸ºä½¿ç”¨ä¾èµ–æ³¨å…¥
   - ç»Ÿä¸€ä½¿ç”¨é…ç½®ç®¡ç†

2. **æ·»åŠ æ›´å¤šæ¥å£**
   - ä¸ºå…¶ä»–å®¢æˆ·ç«¯å®šä¹‰æ¥å£
   - ä¸ºå…¶ä»–æœåŠ¡å®šä¹‰æ¥å£

3. **å®Œå–„æµ‹è¯•**
   - å¢åŠ é›†æˆæµ‹è¯•
   - å¢åŠ æ€§èƒ½æµ‹è¯•

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

