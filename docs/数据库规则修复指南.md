# 数据库FORMULA规则修复指南

## 概述

昨天将算法公式规则从JSON文件迁移到数据库时，总计迁移了**816条规则**（FORMULA_前缀）。
现在需要检查并修复这些规则的数据完整性，特别是`description`字段。

## 规则统计

根据`docs/2025.11.20算法公式.json`：

| 规则类型 | 规则数量 | 英文类型 |
|---------|---------|----------|
| 财富 | 97条 | wealth |
| 婚配 | 60条 | marriage |
| 性格 | 60条 | character |
| 总评 | 533条 | summary |
| 身体 | 58条 | health |
| 十神命格 | 8条 | shishen |
| **总计** | **816条** | - |

## 已知问题

### 问题1：`description`字段可能为空

**影响**：前端显示"条件：无"，无法看到规则的筛选条件

**原因**：迁移时可能没有正确设置`description`字段

**解决方案**：使用`scripts/update_formula_rules_conditions.py`更新

### 问题2：十神命格匹配逻辑特殊

**影响**：数据库规则无法正确匹配十神命格

**原因**：十神命格需要特殊的优先级匹配逻辑

**解决方案**：API已修复，使用`FormulaRuleService`处理十神命格

## 修复步骤

### 步骤1：检查数据库规则

连接数据库，检查FORMULA规则的数据：

```sql
-- 统计FORMULA规则总数
SELECT COUNT(*) as total_count 
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%';

-- 按类型统计
SELECT rule_type, COUNT(*) as count 
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%'
GROUP BY rule_type
ORDER BY count DESC;

-- 检查description为空的规则
SELECT rule_type, COUNT(*) as count
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%'
AND (description IS NULL OR description = '' OR description = '{}')
GROUP BY rule_type;

-- 查看身体类规则样本
SELECT rule_code, description, conditions
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%'
AND rule_type = 'health'
ORDER BY rule_code
LIMIT 5;
```

### 步骤2：更新description字段

使用专用脚本更新description字段：

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi

# 1. 试运行模式（查看需要更新的规则，不实际更新）
python3 scripts/update_formula_rules_conditions.py --dry-run

# 2. 正式更新（实际写入数据库）
python3 scripts/update_formula_rules_conditions.py
```

**脚本功能**：
- 从`docs/2025.11.20算法公式.json`读取原始规则数据
- 提取每条规则的"筛选条件1"、"筛选条件2"、"性别"
- 构建JSON格式的`description`字段
- 更新数据库中的`bazi_rules`表

**description字段格式**：
```json
{
  "筛选条件1": "日干",
  "筛选条件2": "甲",
  "性别": "无论男女",
  "原始描述": "从FormulaRuleService迁移的身体规则"
}
```

### 步骤3：验证修复结果

**方法1：使用验证脚本**

```bash
python3 scripts/verify_migrated_rules.py
```

这个脚本会：
1. 检查数据库中的规则数据
2. 测试规则匹配功能
3. 对比FormulaRuleService和RuleService的匹配结果

**方法2：通过API测试**

使用您的测试数据（2025/11/23 12:00 男）测试：

```bash
curl -X POST http://localhost:8003/api/v1/bazi/formula-analysis \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "2025-11-23",
    "solar_time": "12:00",
    "gender": "male"
  }' | python3 -m json.tool | less
```

检查返回的`rule_details`是否包含：
- ✅ `condition1` 和 `condition2` 字段不为空
- ✅ 身体类规则显示具体条件
- ✅ 十神命格匹配到"偏印格"

**方法3：前端测试**

访问：`http://localhost:8001/frontend/formula-analysis.html`

输入测试数据，检查：
- 身体类规则不再显示"条件：无"
- 十神命格显示1条规则（偏印格）

### 步骤4：修复后的数据库状态

修复后，每条规则应该包含：

1. **rule_code**: `FORMULA_70001`（示例）
2. **rule_type**: `health`
3. **conditions**: JSON格式的匹配条件
   ```json
   {
     "day_stem": "甲"
   }
   ```
4. **description**: JSON格式的原始条件信息（新增/更新）
   ```json
   {
     "筛选条件1": "日干",
     "筛选条件2": "甲",
     "性别": "无论男女"
   }
   ```
5. **content**: JSON格式的规则内容
   ```json
   {
     "text": "个高、直挺。"
   }
   ```

## 常见问题

### Q1: 更新脚本报错"No module named 'pymysql'"

**解决方案**：
```bash
# 激活虚拟环境
cd /Users/zhoudt/Downloads/project/HiFate-bazi
source .venv/bin/activate

# 安装依赖（如果缺失）
pip install pymysql

# 重新运行脚本
python3 scripts/update_formula_rules_conditions.py
```

### Q2: 数据库连接失败

**检查点**：
1. MySQL服务是否运行
2. 数据库配置文件：`server/config/mysql_config.py`
3. 数据库名称：`bazi`（或配置的数据库名）

### Q3: 某些规则仍然显示"条件：无"

**可能原因**：
1. 原始JSON文件中该规则的"筛选条件2"为空
2. 数据库更新未成功
3. API缓存未清除

**解决方案**：
1. 检查原始JSON文件：`docs/2025.11.20算法公式.json`
2. 重新运行更新脚本
3. 重启服务清除缓存：`./restart_server.sh`

### Q4: 十神命格仍然没有匹配结果

**检查点**：
1. API代码是否已更新（使用FormulaRuleService处理十神命格）
2. 服务是否已重启
3. FormulaRuleService是否可用

**验证**：
```bash
# 检查API文件是否包含十神命格特殊处理
grep -A 20 "十神命格特殊处理" server/api/v1/formula_analysis.py
```

## 技术细节

### description vs conditions

| 字段 | 用途 | 格式 | 示例 |
|------|------|------|------|
| `conditions` | 规则匹配逻辑 | JSON（标准化） | `{"day_stem": "甲"}` |
| `description` | 原始条件信息（用于前端显示） | JSON | `{"筛选条件1": "日干", "筛选条件2": "甲"}` |

**为什么需要两个字段？**
1. `conditions`：用于RuleService的匹配逻辑，格式标准化
2. `description`：保留原始信息，用于前端显示，便于理解

**API如何处理？**
1. 尝试从`description` JSON中读取"筛选条件1"和"筛选条件2"
2. 如果失败，从`conditions` JSON转换为可读文本
3. 同时返回中英文字段名，确保前端兼容

### 数据库表结构

```sql
CREATE TABLE `bazi_rules` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `rule_code` VARCHAR(50) UNIQUE NOT NULL,      -- 规则代码（如FORMULA_70001）
    `rule_name` VARCHAR(200) NOT NULL,            -- 规则名称
    `rule_type` VARCHAR(50) NOT NULL,             -- 规则类型（health/wealth等）
    `priority` INT DEFAULT 100,                   -- 优先级
    `conditions` JSON NOT NULL,                   -- 匹配条件（JSON格式）
    `content` JSON NOT NULL,                      -- 规则内容（JSON格式）
    `enabled` BOOLEAN DEFAULT TRUE,               -- 是否启用
    `description` TEXT,                           -- 规则描述（JSON格式，包含原始条件）
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_rule_type` (`rule_type`),
    INDEX `idx_rule_code` (`rule_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 相关文件

### 迁移脚本
- `scripts/migrate_formula_rules_to_db.py` - 主迁移脚本
- `scripts/update_formula_rules_conditions.py` - 更新description字段

### 验证脚本
- `scripts/verify_migrated_rules.py` - 验证迁移结果
- `scripts/test_formula_api_compatibility.py` - 测试API兼容性

### API文件
- `server/api/v1/formula_analysis.py` - 算法公式API（已修复）
- `server/services/formula_rule_service.py` - FormulaRuleService（保留用于十神命格）
- `server/services/rule_service.py` - RuleService（主要匹配服务）

### 数据文件
- `docs/2025.11.20算法公式.json` - 原始规则数据（816条）
- `server/config/rules.json` - 旧规则配置（已废弃）

## 总结

1. ✅ API已修复：添加了英文字段名映射和十神命格特殊处理
2. ⏳ 数据库需更新：运行`update_formula_rules_conditions.py`更新description字段
3. ✅ 验证方法：通过API测试或前端页面验证修复结果
4. 📋 文档齐全：本指南提供完整的修复流程和故障排查方法

**建议执行顺序**：
1. 运行`update_formula_rules_conditions.py --dry-run`查看需要更新的规则
2. 运行`update_formula_rules_conditions.py`正式更新数据库
3. 重启服务：`./restart_server.sh`
4. 通过前端或API测试验证修复结果
5. 运行`verify_migrated_rules.py`进行全面验证

如有问题，请参考本文档的"常见问题"部分或查看相关日志文件。

