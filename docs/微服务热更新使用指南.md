# 微服务热更新使用指南

## 📋 概述

所有 10 个 gRPC 微服务现在都支持热更新，修改代码后**无需重启服务**，系统会自动检测并重新加载。

## ✅ 已支持热更新的服务

| 服务名称 | 端口 | 热更新状态 | 检查间隔 |
|---------|------|-----------|---------|
| bazi_core | 9001 | ✅ 已支持 | 30秒 |
| bazi_fortune | 9002 | ✅ 已支持 | 30秒 |
| bazi_analyzer | 9003 | ✅ 已支持 | 30秒 |
| bazi_rule | 9004 | ✅ 已支持 | 30秒 |
| fortune_analysis | 9005 | ✅ 已支持 | 30秒 |
| payment_service | 9006 | ✅ 已支持 | 30秒 |
| fortune_rule | 9007 | ✅ 已支持 | 30秒 |
| intent_service | 9008 | ✅ 已支持 | 30秒 |
| prompt_optimizer | 9009 | ✅ 已支持 | 30秒 |
| desk_fengshui | 9010 | ✅ 已支持 | 30秒 |

## 🔄 工作原理

### 1. 自动检测机制

每个微服务启动时会：
1. 创建 `MicroserviceReloader` 实例
2. 启动文件监控线程（每 30 秒检查一次）
3. 监控服务目录和 `src/` 目录下的所有 `.py` 文件
4. 检测到文件变化后自动重新加载 Servicer 类

### 2. 热替换机制

- 使用 `DynamicServicer` 包装实际的 Servicer
- 所有 gRPC 调用都通过 `DynamicServicer` 转发到当前 Servicer 实例
- 当代码更新时，创建新的 Servicer 实例并替换旧的
- **不中断正在处理的请求**，新请求使用新代码

### 3. 版本管理

- 每次热更新都会记录版本号
- 保留最近 10 个版本的历史记录
- 支持回滚到上一版本

## 📝 使用方法

### 方法 1：自动热更新（推荐）

**修改代码后，系统会在 30 秒内自动检测并更新：**

```bash
# 1. 修改微服务代码
vim services/bazi_core/grpc_server.py

# 2. 保存文件
# 系统会在 30 秒内自动检测并重新加载

# 3. 查看日志确认更新
docker logs -f hifate-bazi-core
# 应该看到：✅ [bazi_core] Servicer 热更新成功 (版本: X)
```

### 方法 2：手动触发热更新

**通过主服务的 API 手动触发：**

```bash
# 触发所有微服务热更新
curl -X POST http://localhost:8001/api/v1/hot-reload/reload/microservice

# 查看微服务热更新状态
curl http://localhost:8001/api/v1/hot-reload/microservices
```

### 方法 3：全量热更新

**更新所有模块（包括微服务）：**

```bash
curl -X POST http://localhost:8001/api/v1/hot-reload/reload-all
```

## 🔍 监控和验证

### 查看热更新状态

```bash
# 查看所有微服务热更新状态
curl http://localhost:8001/api/v1/hot-reload/microservices

# 返回示例：
{
  "success": true,
  "count": 10,
  "services": {
    "bazi_core": {
      "service_name": "bazi_core",
      "running": true,
      "current_version": 3,
      "check_interval": 30,
      "watched_files": 45,
      "version_history_count": 3
    },
    ...
  }
}
```

### 查看服务日志

```bash
# 查看特定微服务的日志
docker logs -f hifate-bazi-core

# 应该看到类似输出：
# ✓ [bazi_core] 微服务热更新监控已启动（检查间隔: 30秒）
# 🔄 [bazi_core] 检测到 2 个文件变化:
#    modified: services/bazi_core/grpc_server.py
# ✅ [bazi_core] Servicer 热更新成功 (版本: 2)
```

### 验证功能

```bash
# 修改代码后，调用服务验证功能是否正常
# 例如：测试 bazi_core
curl -X POST http://localhost:8001/api/v1/bazi/calculate \
  -H "Content-Type: application/json" \
  -d '{"solar_date": "1990-01-15", "solar_time": "12:00", "gender": "male"}'
```

## ⚠️ 注意事项

### 1. 语法错误处理

- 如果修改后的代码有语法错误，**不会自动更新**
- 文件监控器会检测语法错误并拒绝更新
- 服务会继续使用旧版本运行，不会中断

### 2. 导入错误处理

- 如果新代码有导入错误，热更新会失败
- 系统会尝试回滚到上一版本
- 如果回滚失败，服务会继续使用旧版本

### 3. 全局状态问题

- 模块级别的全局变量在热更新后**不会重置**
- 建议使用类实例变量而不是模块级变量
- 单例实例在热更新后可能需要手动重置

### 4. 依赖关系

- 如果修改了被多个服务依赖的模块（如 `src/` 下的代码）
- 所有依赖该模块的服务都会自动重新加载
- 更新顺序由依赖关系决定

## 🚨 故障处理

### 热更新失败

如果热更新失败，可以：

1. **查看日志**：
   ```bash
   docker logs hifate-bazi-core | grep -i "热更新\|reload"
   ```

2. **手动回滚**：
   ```bash
   # 通过 Git 回滚代码
   cd /opt/HiFate-bazi
   git checkout HEAD -- services/bazi_core/grpc_server.py
   
   # 手动触发热更新
   curl -X POST http://localhost:8001/api/v1/hot-reload/reload/microservice
   ```

3. **重启服务**（最后手段）：
   ```bash
   # 仅在热更新完全失败时使用
   docker restart hifate-bazi-core
   ```

### 服务无响应

如果服务无响应：

1. **检查服务状态**：
   ```bash
   docker ps | grep hifate-bazi-core
   ```

2. **检查日志**：
   ```bash
   docker logs --tail 100 hifate-bazi-core
   ```

3. **重启服务**（如果必要）：
   ```bash
   docker restart hifate-bazi-core
   ```

## 📊 性能影响

- **文件监控**：每 30 秒检查一次，CPU 占用 < 1%
- **热更新执行**：仅在检测到变化时执行，通常 < 100ms
- **服务中断**：**零中断**，正在处理的请求不受影响

## 🔄 与主服务热更新的关系

微服务热更新与主服务热更新**独立运行**：

- **主服务热更新**：管理 `server/` 和 `src/` 目录的代码
- **微服务热更新**：管理各个微服务目录的代码
- **全量热更新**：`/api/v1/hot-reload/reload-all` 会同时更新主服务和所有微服务

## 📚 相关文档

- [热更新系统架构](../.cursorrules#热更新强制规范)
- [热更新 API 文档](../server/hot_reload/api.py)
- [微服务热更新器源码](../server/hot_reload/microservice_reloader.py)

## ✅ 检查清单

每次修改微服务代码后：

- [ ] 代码语法正确（无语法错误）
- [ ] 导入路径正确（无导入错误）
- [ ] 等待 30 秒自动更新，或手动触发
- [ ] 查看日志确认更新成功
- [ ] 测试功能是否正常
- [ ] 验证版本号已更新

---

**重要提示**：所有微服务代码修改现在都支持热更新，**无需重启服务**！

