# é¢ç›¸åˆ†æV2 - ä½¿ç”¨æŒ‡å—

## ğŸ“– ç³»ç»Ÿç®€ä»‹

é¢ç›¸åˆ†æV2æ˜¯åŸºäº**MediaPipeæ·±åº¦å­¦ä¹ æ¨¡å‹**çš„AIæ™ºèƒ½é¢ç›¸åˆ†æç³»ç»Ÿï¼Œèƒ½å¤Ÿè¯†åˆ«äººè„¸468ä¸ªå…³é”®ç‚¹ï¼Œæ˜ å°„åˆ°é¢ç›¸å­¦çš„99ä¸ªç‰¹å¾ç‚¹ï¼Œç»“åˆä¼ ç»Ÿé¢ç›¸å‘½ç†çŸ¥è¯†ï¼Œæä¾›ä¸“ä¸šçš„é¢ç›¸åˆ†ææŠ¥å‘Šã€‚

### æ ¸å¿ƒåŠŸèƒ½

- âœ… **äººè„¸å…³é”®ç‚¹æ£€æµ‹**ï¼šMediaPipe 468ä¸ª3Då…³é”®ç‚¹
- âœ… **ç‰¹å¾ç‚¹æ˜ å°„**ï¼šæ™ºèƒ½æ˜ å°„åˆ°99ä¸ªé¢ç›¸ç‰¹å¾ç‚¹
- âœ… **åä¸‰å®«ä½åˆ†æ**ï¼šå¤©ä¸­ã€å¤©åº­ã€å°å ‚ç­‰13ä¸ªå®«ä½
- âœ… **å…­äº²å®«ä½åˆ†æ**ï¼šçˆ¶æ¯ã€å…„å¼Ÿã€å¤«å¦»ã€å­å¥³ç­‰
- âœ… **åç¥å®šä½åˆ†æ**ï¼šæ­£å®˜ã€æ­£è´¢ã€é£Ÿç¥ç­‰åç¥
- âœ… **ä¸‰åœäº”çœ¼åˆ†æ**ï¼šé¢éƒ¨æ¯”ä¾‹å’Œå¯¹ç§°æ€§
- âœ… **ç»¼åˆå‘½ç†æŠ¥å‘Š**ï¼šç»“æ„åŒ–çš„é¢ç›¸æ–­è¯­

### æŠ€æœ¯ç‰¹ç‚¹

- ğŸ”¥ **å‡†ç¡®åº¦ä¼˜å…ˆ**ï¼šMediaPipeæ¨¡å‹ç²¾åº¦é«˜ï¼Œæœ¬åœ°å¤„ç†æ— å»¶è¿Ÿ
- ğŸ—ï¸ **å¾®æœåŠ¡æ¶æ„**ï¼šå®Œå…¨ç‹¬ç«‹äºç°æœ‰ç³»ç»Ÿ
- ğŸ”„ **æ˜“äºæ‰©å±•**ï¼šæ”¯æŒäº‘ç«¯APIï¼ˆç™¾åº¦/é˜¿é‡Œäº‘ï¼‰å¤‡é€‰æ–¹æ¡ˆ
- ğŸ“Š **è§„åˆ™é©±åŠ¨**ï¼šåŸºäºJSONè§„åˆ™åº“ï¼Œæ–¹ä¾¿æ›´æ–°ç»´æŠ¤

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# è¿è¡Œå®‰è£…è„šæœ¬
bash scripts/setup_mediapipe.sh

# æˆ–æ‰‹åŠ¨å®‰è£…
pip install mediapipe>=0.10.0
pip install opencv-python>=4.8.0
pip install Pillow>=10.0.0
pip install numpy>=1.26.0
```

### 2. åˆå§‹åŒ–æ•°æ®åº“

```bash
# æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
mysql -h 127.0.0.1 -P 13306 -u root -p --default-character-set=utf8mb4 bazi_system < server/db/migrations/face_v2_schema.sql

# å¯¼å…¥é¢ç›¸è§„åˆ™æ•°æ®
python scripts/import_face_rules_v2.py
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# æ–¹å¼1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰
bash start_face_analysis_v2.sh

# æ–¹å¼2ï¼šæ‰‹åŠ¨å¯åŠ¨
source .venv/bin/activate
python server/main.py
```

### 4. è®¿é—®ç³»ç»Ÿ

- **å‰ç«¯é¡µé¢**ï¼šhttp://localhost:8001/face-analysis-v2.html
- **APIæ–‡æ¡£**ï¼šhttp://localhost:8001/docs
- **å¥åº·æ£€æŸ¥**ï¼šhttp://localhost:8001/api/v2/face/health

---

## ğŸ“¸ ä½¿ç”¨æ–¹æ³•

### å‰ç«¯ç•Œé¢ä½¿ç”¨

1. **ä¸Šä¼ ç…§ç‰‡**
   - ç‚¹å‡»ä¸Šä¼ æ¡†ï¼Œé€‰æ‹©æ­£é¢æ¸…æ™°ç…§ç‰‡
   - æ”¯æŒJPGã€PNGæ ¼å¼
   - å»ºè®®ï¼šäº”å®˜æ¸…æ™°ã€å…‰çº¿å……è¶³ã€æ­£é¢æ‹æ‘„

2. **é€‰æ‹©åˆ†æç±»å‹**
   - â˜‘ï¸ åä¸‰å®«ä½ï¼šåˆ†æå¤©ä¸­ã€å¤©åº­ã€å°å ‚ç­‰
   - â˜‘ï¸ å…­äº²å®«ä½ï¼šåˆ†æçˆ¶æ¯ã€å…„å¼Ÿã€å¤«å¦»ç­‰
   - â˜‘ï¸ åç¥å®šä½ï¼šåˆ†ææ­£å®˜ã€æ­£è´¢ã€é£Ÿç¥ç­‰
   - â˜ è¯¦ç»†ç‰¹å¾ï¼š99ä¸ªç²¾ç»†ç‰¹å¾ç‚¹ï¼ˆå¯é€‰ï¼‰

3. **å¡«å†™ç”Ÿè¾°ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰**
   - å¹´ä»½ã€æœˆä»½ã€æ—¥æœŸã€æ€§åˆ«
   - ç”¨äºç»“åˆå…«å­—è¿›è¡Œç»¼åˆåˆ†æ

4. **å¼€å§‹åˆ†æ**
   - ç‚¹å‡»"å¼€å§‹åˆ†æ"æŒ‰é’®
   - ç­‰å¾…3-5ç§’
   - æŸ¥çœ‹åˆ†æç»“æœ

### APIè°ƒç”¨ç¤ºä¾‹

#### 1. ç»¼åˆé¢ç›¸åˆ†æ

```bash
curl -X POST "http://localhost:8001/api/v2/face/analyze" \
  -H "Content-Type: multipart/form-data" \
  -F "image=@test_face.jpg" \
  -F "analysis_types=gongwei,liuqin,shishen" \
  -F "birth_year=1990" \
  -F "birth_month=5" \
  -F "birth_day=15" \
  -F "gender=male"
```

#### 2. ä»…æ£€æµ‹å…³é”®ç‚¹

```bash
curl -X POST "http://localhost:8001/api/v2/face/detect" \
  -H "Content-Type: multipart/form-data" \
  -F "image=@test_face.jpg"
```

#### 3. æŸ¥è¯¢è§„åˆ™

```bash
# æŸ¥è¯¢åä¸‰å®«ä½è§„åˆ™
curl "http://localhost:8001/api/v2/face/rules/gongwei"

# æŸ¥è¯¢ç‰¹å®šä½ç½®è§„åˆ™
curl "http://localhost:8001/api/v2/face/rules/gongwei?position=å°å ‚"
```

---

## ğŸ“Š æ•°æ®ç»“æ„

### APIå“åº”æ ¼å¼

```json
{
  "success": true,
  "data": {
    "face_detected": true,
    "landmarks": {
      "mediapipe_points": 468,
      "mapped_features": 99
    },
    "santing_analysis": {
      "upper_ratio": 0.33,
      "middle_ratio": 0.34,
      "lower_ratio": 0.33,
      "evaluation": "ä¸‰åœåŒ€ç§°ï¼Œäº”å®˜åè°ƒï¼Œè¿åŠ¿å¹³ç¨³"
    },
    "wuyan_analysis": {
      "evaluation": "äº”çœ¼åŒ€ç§°ï¼Œé¢éƒ¨åè°ƒï¼Œç¾è§‚å¤§æ–¹"
    },
    "gongwei_analysis": [
      {
        "name": "å°å ‚",
        "position": "å°å ‚",
        "features": ["ä½ç½®å±…ä¸­"],
        "interpretations": [
          "å°å ‚å¼€é˜”æ˜æ¶¦ï¼Œå‘½å®«å¼€é˜”ï¼Œè¿åŠ¿äº¨é€š",
          "å¿ƒèƒ¸å®½å¹¿ï¼Œä¸ºäººæ­£ç›´"
        ]
      }
    ],
    "liuqin_analysis": [...],
    "shishen_analysis": [...],
    "overall_summary": "ç»¼åˆé¢ç›¸åˆ†æå®Œæˆ"
  }
}
```

---

## ğŸ”§ é«˜çº§é…ç½®

### æ‰©å±•è§„åˆ™åº“

1. ç¼–è¾‘JSONè§„åˆ™æ–‡ä»¶ï¼š
   ```
   data/face_rules_v2/gongwei_rules.json
   data/face_rules_v2/liuqin_rules.json
   data/face_rules_v2/shishen_rules.json
   ```

2. é‡æ–°å¯¼å…¥è§„åˆ™ï¼š
   ```bash
   python scripts/import_face_rules_v2.py
   ```

### è°ƒæ•´æ˜ å°„ç®—æ³•

ç¼–è¾‘ `services/face_analysis_v2/models/feature_mapper.py` ä¸­çš„ `feature_mapping` å­—å…¸ï¼Œå¯ä»¥ä¿®æ”¹99ä¸ªç‰¹å¾ç‚¹çš„å®šä¹‰ã€‚

### é›†æˆäº‘ç«¯API

ç¼–è¾‘ `services/face_analysis_v2/models/landmark_detector.py`ï¼Œæ·»åŠ ç™¾åº¦AIæˆ–é˜¿é‡Œäº‘APIçš„è°ƒç”¨é€»è¾‘ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆã€‚

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1ï¼šæœªæ£€æµ‹åˆ°äººè„¸

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿ç…§ç‰‡ä¸ºæ­£é¢ç…§
- æ£€æŸ¥å…‰çº¿æ˜¯å¦å……è¶³
- äº”å®˜æ˜¯å¦æ¸…æ™°å¯è§
- å°è¯•æ›´æ¢ç…§ç‰‡

### Q2ï¼šä¾èµ–å®‰è£…å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å‡çº§pip
pip install --upgrade pip

# å•ç‹¬å®‰è£…
pip install mediapipe
pip install opencv-python

# å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œä½¿ç”¨å›½å†…é•œåƒ
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple mediapipe
```

### Q3ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8001

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/main_service.log

# æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ
which python
```

### Q4ï¼šè§„åˆ™æ²¡æœ‰ç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. ç¡®è®¤è§„åˆ™å·²å¯¼å…¥
mysql -h 127.0.0.1 -P 13306 -u root -p -e "SELECT COUNT(*) FROM bazi_system.face_rules_v2"

# 2. é‡å¯æœåŠ¡
bash start_face_analysis_v2.sh
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æœ¬åœ°éƒ¨ç½²ä¼˜åŒ–

- **GPUåŠ é€Ÿ**ï¼šMediaPipeæ”¯æŒGPUï¼Œå¯æ˜¾è‘—æå‡é€Ÿåº¦
- **å›¾ç‰‡å‹ç¼©**ï¼šå‰ç«¯è‡ªåŠ¨å‹ç¼©å¤§å›¾ç‰‡
- **ç¼“å­˜æœºåˆ¶**ï¼šç›¸åŒå›¾ç‰‡ä¸é‡å¤åˆ†æ

### ç”Ÿäº§éƒ¨ç½²å»ºè®®

- **è´Ÿè½½å‡è¡¡**ï¼šéƒ¨ç½²å¤šä¸ªæœåŠ¡å®ä¾‹
- **CDNåŠ é€Ÿ**ï¼šé™æ€èµ„æºä½¿ç”¨CDN
- **æ•°æ®åº“ä¼˜åŒ–**ï¼šè§„åˆ™è¡¨æ·»åŠ ç´¢å¼•
- **äº‘ç«¯APIå¤‡ä»½**ï¼šé«˜å³°æœŸåˆ‡æ¢åˆ°äº‘ç«¯API

---

## ğŸ”„ æ›´æ–°æ—¥å¿—

### V2.0.0 (2024-11-26)

- âœ¨ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… MediaPipe 468å…³é”®ç‚¹æ£€æµ‹
- âœ… 99ä¸ªé¢ç›¸ç‰¹å¾ç‚¹æ˜ å°„
- âœ… åä¸‰å®«ä½ã€å…­äº²ã€åç¥åˆ†æ
- âœ… ä¸‰åœäº”çœ¼è®¡ç®—
- âœ… å®Œæ•´çš„å‰åç«¯ç³»ç»Ÿ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š

1. **é¡¹ç›®æ–‡æ¡£**ï¼š`docs/`ç›®å½•ä¸‹çš„å…¶ä»–æ–‡æ¡£
2. **å¼€å‘è§„èŒƒ**ï¼šå‚è€ƒé¡¹ç›®æ ¹ç›®å½•çš„AIå¼€å‘è§„èŒƒ
3. **æ—¥å¿—æ–‡ä»¶**ï¼š`logs/main_service.log`

---

## ğŸ“ å¼€å‘å¤‡æ³¨

- å®Œå…¨ç‹¬ç«‹äº `mianxiang_hand_fengshui/` æ—§ç³»ç»Ÿ
- ä½¿ç”¨v2å‘½åç©ºé—´é¿å…å†²çª
- éµå¾ªé¡¹ç›®ç»Ÿä¸€çš„å¼€å‘è§„èŒƒ
- å‡†ç¡®åº¦ä¼˜å…ˆï¼Œåç»­å¯åˆ‡æ¢äº‘ç«¯API

