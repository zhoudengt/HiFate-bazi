# 功能启用和测试指南

> **生成日期**: 2026-01-13  
> **版本**: v1.0

---

## 目录

1. [快速开始](#快速开始)
2. [环境变量说明](#环境变量说明)
3. [启用所有功能](#启用所有功能)
4. [运行测试](#运行测试)
5. [测试结果说明](#测试结果说明)
6. [故障排查](#故障排查)

---

## 快速开始

### 一键启用和测试

```bash
# 运行测试脚本（自动启用所有功能并运行测试）
bash scripts/test/run_optimization_tests.sh
```

### 手动启用和测试

```bash
# 1. 启用所有功能
source scripts/test/enable_all_features.sh

# 2. 运行测试
python3 scripts/test/test_optimizations.py
```

---

## 环境变量说明

### 熔断器配置

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `ENABLE_CIRCUIT_BREAKER` | `false` | 启用熔断器保护 |
| `CIRCUIT_BREAKER_FAILURE_THRESHOLD` | `5` | 失败阈值（触发熔断的失败次数） |
| `CIRCUIT_BREAKER_TIMEOUT` | `30.0` | 熔断超时时间（秒） |
| `CIRCUIT_BREAKER_SUCCESS_THRESHOLD` | `3` | 恢复成功阈值（半开状态下的成功次数） |

### 重试配置

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `GRPC_MAX_RETRIES` | `3` | 最大重试次数 |
| `GRPC_RETRY_DELAY` | `1.0` | 重试延迟（秒） |

### 缓存版本控制

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `ENABLE_CACHE_VERSION` | `false` | 启用缓存版本控制 |
| `CACHE_VERSION` | `v1` | 缓存版本号 |

### 监控指标收集

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `ENABLE_METRICS_COLLECTION` | `true` | 启用监控指标收集 |

---

## 启用所有功能

### 方法 1: 使用脚本（推荐）

```bash
# 启用所有功能
source scripts/test/enable_all_features.sh
```

### 方法 2: 手动设置环境变量

```bash
# 熔断器配置
export ENABLE_CIRCUIT_BREAKER=true
export CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
export CIRCUIT_BREAKER_TIMEOUT=30.0

# 重试配置
export GRPC_MAX_RETRIES=3
export GRPC_RETRY_DELAY=1.0

# 缓存版本控制
export ENABLE_CACHE_VERSION=true
export CACHE_VERSION=v1

# 监控指标收集
export ENABLE_METRICS_COLLECTION=true
```

### 方法 3: 在 `.env` 文件中配置

```bash
# 在 .env 文件中添加以下配置
ENABLE_CIRCUIT_BREAKER=true
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
CIRCUIT_BREAKER_TIMEOUT=30.0
GRPC_MAX_RETRIES=3
GRPC_RETRY_DELAY=1.0
ENABLE_CACHE_VERSION=true
CACHE_VERSION=v1
ENABLE_METRICS_COLLECTION=true
```

---

## 运行测试

### 测试脚本说明

测试脚本 `scripts/test/test_optimizations.py` 会自动测试以下功能：

1. **监控指标收集器**
   - MetricsCollector 实例创建
   - gRPC 调用指标记录
   - 缓存命中率记录
   - 统计信息获取

2. **熔断器功能**
   - 熔断器实例创建
   - 状态转换测试
   - 失败触发熔断
   - 熔断后请求拒绝

3. **自动重试机制**
   - 重试逻辑测试
   - 重试次数验证

4. **缓存版本管理器**
   - 版本前缀添加
   - 版本获取
   - 缓存失效功能

5. **适配器集成测试**
   - 接口兼容性验证
   - 增强功能启用检查

6. **向后兼容性测试**
   - 接口未改变验证
   - 默认行为验证

### 运行测试

```bash
# 方法 1: 使用运行脚本（推荐）
bash scripts/test/run_optimization_tests.sh

# 方法 2: 直接运行测试脚本
python3 scripts/test/test_optimizations.py

# 方法 3: 先启用功能，再运行测试
source scripts/test/enable_all_features.sh
python3 scripts/test/test_optimizations.py
```

### 测试输出说明

测试脚本会输出：

- ✓ **通过**: 测试通过
- ✗ **失败**: 测试失败
- ⊘ **跳过**: 测试跳过（功能未启用或条件不满足）

---

## 测试结果说明

### 测试报告

测试完成后，会生成测试报告文件：

```
scripts/test/optimization_test_report.json
```

报告内容包括：

- **时间戳**: 测试执行时间
- **总结**: 
  - 总计测试数
  - 通过数量
  - 失败数量
  - 跳过数量
- **详细结果**: 每个测试的详细结果

### 查看测试报告

```bash
# 查看测试报告
cat scripts/test/optimization_test_report.json | python3 -m json.tool

# 或直接查看
cat scripts/test/optimization_test_report.json
```

---

## 故障排查

### 问题 1: 测试脚本找不到模块

**错误**:
```
ModuleNotFoundError: No module named 'server.utils.metrics_collector'
```

**解决方案**:
```bash
# 确保在项目根目录运行
cd /path/to/HiFate-bazi
python3 scripts/test/test_optimizations.py
```

### 问题 2: 熔断器测试失败

**错误**:
```
熔断器未启用 (ENABLE_CIRCUIT_BREAKER=false)
```

**解决方案**:
```bash
# 启用熔断器
export ENABLE_CIRCUIT_BREAKER=true
# 重新运行测试
python3 scripts/test/test_optimizations.py
```

### 问题 3: 缓存版本管理器测试失败

**错误**:
```
缓存版本控制未启用 (ENABLE_CACHE_VERSION=false)
```

**解决方案**:
```bash
# 启用缓存版本控制
export ENABLE_CACHE_VERSION=true
# 重新运行测试
python3 scripts/test/test_optimizations.py
```

### 问题 4: 适配器创建失败

**错误**:
```
适配器创建需要服务运行
```

**说明**: 这是正常的，如果服务未运行，适配器创建测试会被跳过。

**解决方案**: 
- 如果测试服务适配器功能，需要先启动相关服务
- 如果仅测试接口兼容性，可以忽略此警告

### 问题 5: Redis 连接失败

**错误**:
```
缓存失效功能需要 Redis
```

**说明**: 如果 Redis 未运行或不可用，缓存失效功能测试会被跳过。

**解决方案**:
- 确保 Redis 服务运行
- 检查 Redis 连接配置

---

## 常见问题

### Q1: 如何只启用部分功能？

**A**: 可以只设置需要的环境变量：

```bash
# 只启用监控指标收集
export ENABLE_METRICS_COLLECTION=true

# 只启用熔断器
export ENABLE_CIRCUIT_BREAKER=true

# 只启用缓存版本控制
export ENABLE_CACHE_VERSION=true
```

### Q2: 测试失败是否会影响生产环境？

**A**: 不会。测试脚本只在本地运行，不会影响生产环境。

### Q3: 如何验证功能是否启用？

**A**: 运行测试脚本，检查输出：

```bash
python3 scripts/test/test_optimizations.py
```

如果功能已启用，相关测试会执行；如果未启用，测试会被跳过。

### Q4: 如何回滚功能？

**A**: 设置环境变量为 `false`：

```bash
export ENABLE_CIRCUIT_BREAKER=false
export ENABLE_CACHE_VERSION=false
```

或使用热更新：

```bash
python3 scripts/ai/auto_hot_reload.py --trigger
```

---

## 下一步

测试通过后，您可以：

1. **在生产环境启用功能**（建议先观察监控数据）
2. **调整配置参数**（如熔断阈值、重试次数等）
3. **监控功能效果**（查看监控指标收集的数据）

---

**最后更新**: 2026-01-13  
**维护者**: HiFate Team
