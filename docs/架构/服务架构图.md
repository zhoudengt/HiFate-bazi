# HiFate-bazi 服务架构图

> **生成日期**: 2026-01-13  
> **版本**: v1.0

---

## 系统整体架构

```mermaid
graph TB
    subgraph Frontend["前端层"]
        Browser[浏览器]
    end
    
    subgraph Gateway["网关层"]
        WebAPI[Web API<br/>FastAPI<br/>Port 8001]
        GrpcGateway[gRPC-Web 网关]
    end
    
    subgraph Microservices["微服务层 (gRPC)"]
        BaziCore[bazi-core<br/>Port 9001<br/>八字核心计算]
        BaziFortune[bazi-fortune<br/>Port 9002<br/>运势计算]
        BaziAnalyzer[bazi-analyzer<br/>Port 9003<br/>八字分析]
        BaziRule[bazi-rule<br/>Port 9004<br/>规则匹配]
        FortuneAnalysis[fortune-analysis<br/>Port 9005<br/>运势分析]
        Payment[payment<br/>Port 9006<br/>支付服务]
        FortuneRule[fortune-rule<br/>Port 9007<br/>运势规则]
        Intent[intent<br/>Port 9008<br/>意图识别]
        PromptOptimizer[prompt-optimizer<br/>Port 9009<br/>提示优化]
        DeskFengshui[desk-fengshui<br/>Port 9010<br/>办公桌风水]
    end
    
    subgraph Storage["数据存储层"]
        MySQL[(MySQL<br/>Port 13306)]
        Redis[(Redis<br/>Port 16379)]
    end
    
    subgraph External["外部服务"]
        LLMAPI[LLM API]
        PaymentAPI[支付 API<br/>Stripe/PayPal/Alipay/WeChat]
    end
    
    Browser -->|HTTP/gRPC-Web| WebAPI
    WebAPI --> GrpcGateway
    GrpcGateway -->|gRPC| BaziCore
    GrpcGateway -->|gRPC| BaziFortune
    GrpcGateway -->|gRPC| BaziAnalyzer
    GrpcGateway -->|gRPC| BaziRule
    GrpcGateway -->|gRPC| FortuneAnalysis
    GrpcGateway -->|gRPC| Payment
    GrpcGateway -->|gRPC| Intent
    
    BaziFortune -->|依赖| BaziCore
    FortuneAnalysis -->|依赖| BaziFortune
    FortuneAnalysis -->|依赖| FortuneRule
    BaziAnalyzer -->|依赖| BaziCore
    Intent -->|调用| LLMAPI
    PromptOptimizer -->|调用| LLMAPI
    Payment -->|调用| PaymentAPI
    DeskFengshui -->|依赖| BaziCore
    
    BaziRule -->|查询| MySQL
    FortuneRule -->|查询| MySQL
    WebAPI -->|查询| MySQL
    WebAPI -->|缓存| Redis
    BaziRule -->|缓存| Redis
```

---

## 服务依赖关系

```mermaid
graph LR
    subgraph Core["核心服务"]
        BaziCore[bazi-core<br/>9001]
    end
    
    subgraph Business["业务服务"]
        BaziFortune[bazi-fortune<br/>9002]
        BaziAnalyzer[bazi-analyzer<br/>9003]
        BaziRule[bazi-rule<br/>9004]
        FortuneRule[fortune-rule<br/>9007]
    end
    
    subgraph Analysis["分析服务"]
        FortuneAnalysis[fortune-analysis<br/>9005]
        Intent[intent<br/>9008]
        PromptOptimizer[prompt-optimizer<br/>9009]
    end
    
    subgraph External["外部服务"]
        Payment[payment<br/>9006]
        DeskFengshui[desk-fengshui<br/>9010]
    end
    
    BaziCore --> BaziFortune
    BaziCore --> BaziAnalyzer
    BaziCore --> DeskFengshui
    BaziFortune --> FortuneAnalysis
    FortuneRule --> FortuneAnalysis
    BaziRule -.->|可合并| FortuneRule
    PromptOptimizer -.->|可集成| Intent
```

---

## 服务调用链路示例

### 八字计算流程

```mermaid
sequenceDiagram
    participant Browser
    participant WebAPI
    participant Adapter as 适配器层
    participant BaziCore
    participant MySQL
    participant Redis
    
    Browser->>WebAPI: POST /api/v1/bazi
    WebAPI->>Adapter: calculate_bazi()
    Note over Adapter: 可选：熔断器保护
    Adapter->>BaziCore: gRPC CalculateBazi
    BaziCore->>MySQL: 查询规则数据
    MySQL-->>BaziCore: 返回数据
    BaziCore-->>Adapter: 返回计算结果
    Note over Adapter: 可选：缓存结果
    Adapter->>Redis: 缓存结果
    Adapter-->>WebAPI: 返回结果
    WebAPI-->>Browser: JSON 响应
```

### 规则匹配流程

```mermaid
sequenceDiagram
    participant WebAPI
    participant RuleService
    participant Adapter as 适配器层
    participant BaziRule
    participant MySQL
    participant Redis
    
    WebAPI->>RuleService: match_rules()
    RuleService->>Redis: 检查缓存
    alt 缓存命中
        Redis-->>RuleService: 返回缓存结果
    else 缓存未命中
        RuleService->>Adapter: match_rules()
        Note over Adapter: 可选：重试机制
        Adapter->>BaziRule: gRPC MatchRules
        BaziRule->>MySQL: 查询规则
        MySQL-->>BaziRule: 返回规则
        BaziRule-->>Adapter: 返回匹配结果
        Adapter->>Redis: 缓存结果
        Adapter-->>RuleService: 返回结果
    end
    RuleService-->>WebAPI: 返回匹配结果
```

---

## 接口-适配器架构

```mermaid
graph TB
    subgraph Service["服务层"]
        BaziService[bazi_service.py]
        RuleService[rule_service.py]
    end
    
    subgraph Interface["接口层"]
        IBaziCore[IBaziCoreClient]
        IBaziRule[IBaziRuleClient]
    end
    
    subgraph Adapter["适配器层"]
        BaziAdapter[BaziCoreClientAdapter]
        RuleAdapter[BaziRuleClientAdapter]
    end
    
    subgraph Client["客户端层"]
        BaziClient[BaziCoreClient<br/>原有实现]
        BaziClientV2[BaziCoreClientV2<br/>增强版]
        RuleClient[BaziRuleClient]
    end
    
    subgraph Microservice["微服务"]
        BaziCoreService[bazi-core:9001]
        RuleService[bazi-rule:9004]
    end
    
    BaziService --> IBaziCore
    RuleService --> IBaziRule
    IBaziCore --> BaziAdapter
    IBaziRule --> RuleAdapter
    BaziAdapter -->|默认| BaziClient
    BaziAdapter -->|可选| BaziClientV2
    RuleAdapter --> RuleClient
    BaziClient --> BaziCoreService
    BaziClientV2 --> BaziCoreService
    RuleClient --> RuleService
```

**关键优势**：
- 适配器层可以安全地添加熔断、重试、监控等功能
- 对上层服务完全透明
- 可以逐步迁移到新客户端

---

## 优化建议可视化

### 服务合并建议

```mermaid
graph LR
    subgraph Before["合并前"]
        BaziRule1[bazi-rule<br/>9004]
        FortuneRule1[fortune-rule<br/>9007]
        PromptOpt1[prompt-optimizer<br/>9009]
        Intent1[intent<br/>9008]
    end
    
    subgraph After["合并后"]
        RuleService[rule-service<br/>9004]
        IntentService[intent-service<br/>9008]
    end
    
    BaziRule1 -.->|合并| RuleService
    FortuneRule1 -.->|合并| RuleService
    PromptOpt1 -.->|集成| IntentService
    Intent1 -.->|保留| IntentService
```

**注意**：服务合并属于高风险操作，建议在有测试环境后再实施。

---

## 数据流图

### 缓存数据流

```mermaid
graph LR
    A[API 请求] --> B{检查缓存}
    B -->|命中| C[返回缓存]
    B -->|未命中| D[调用服务]
    D --> E[查询数据库]
    E --> F[写入缓存]
    F --> G[返回结果]
    
    H[规则更新] --> I[失效缓存]
    I --> J[更新数据库]
```

---

## 端口清单

| 服务 | 端口 | 协议 | 说明 |
|------|------|------|------|
| **Web API** | 8001 | HTTP/gRPC-Web | 主服务，对外提供 API |
| **bazi-core** | 9001 | gRPC | 八字核心计算服务 |
| **bazi-fortune** | 9002 | gRPC | 大运流年计算服务 |
| **bazi-analyzer** | 9003 | gRPC | 八字分析服务 |
| **bazi-rule** | 9004 | gRPC | 规则匹配服务 |
| **fortune-analysis** | 9005 | gRPC | 运势分析服务 |
| **payment** | 9006 | gRPC | 支付服务 |
| **fortune-rule** | 9007 | gRPC | 运势规则服务 |
| **intent** | 9008 | gRPC | 意图识别服务 |
| **prompt-optimizer** | 9009 | gRPC | 提示优化服务 |
| **desk-fengshui** | 9010 | gRPC | 办公桌风水服务 |
| **MySQL** | 13306 | TCP | 数据库 |
| **Redis** | 16379 | TCP | 缓存 |

---

**最后更新**: 2026-01-13  
**维护者**: HiFate Team
