# æ—¥å¿—å’Œå®‰å…¨ç³»ç»Ÿ - å¿«é€Ÿå‚è€ƒ

> **å¿«é€Ÿä¸Šæ‰‹æŒ‡å—** - 5åˆ†é’Ÿäº†è§£å¦‚ä½•ä½¿ç”¨æ–°ç³»ç»Ÿ

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯¼å…¥æ¨¡å—

```python
# ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
from server.utils.unified_logger import (
    log_request, log_response, log_error, trace_function
)

# æ•æ„Ÿä¿¡æ¯ç®¡ç†
from server.utils.secret_manager import (
    get_coze_token, get_coze_bot_id, get_mysql_password
)

# SQL å®‰å…¨é˜²æŠ¤
from server.utils.sql_security import (
    secure_execute_query, secure_execute_update
)
```

### 2. ä½¿ç”¨æ¨¡æ¿

```python
import uuid

def my_function(param1, param2):
    request_id = str(uuid.uuid4())
    
    # ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨è‡ªåŠ¨è¿½è¸ª
    with trace_function(
        service='MyService',
        function='my_function',
        request_id=request_id,
        input_data={'param1': param1, 'param2': param2}
    ):
        # è·å–æ•æ„Ÿä¿¡æ¯
        token = get_coze_token()
        
        # å®‰å…¨æŸ¥è¯¢æ•°æ®åº“
        results = secure_execute_query(
            connection=conn,
            sql="SELECT * FROM table WHERE id = %s",
            params=(param1,),
            request_id=request_id,
            service='MyService',
            function='query_data'
        )
        
        # ä¸šåŠ¡é€»è¾‘
        result = process(results)
        
        # è®°å½•å“åº”
        log_response(
            service='MyService',
            function='my_function',
            request_id=request_id,
            output_data=result
        )
        
        return result
```

---

## ğŸ“ å¸¸ç”¨æ“ä½œ

### è®°å½•è¯·æ±‚æ—¥å¿—

```python
log_request(
    service='ServiceName',
    function='function_name',
    request_id=request_id,
    input_data={'key': 'value'}
)
```

### è®°å½•å“åº”æ—¥å¿—

```python
log_response(
    service='ServiceName',
    function='function_name',
    request_id=request_id,
    output_data={'result': 'data'},
    duration_ms=123.45
)
```

### è®°å½•é”™è¯¯æ—¥å¿—

```python
try:
    # ä¸šåŠ¡é€»è¾‘
    pass
except Exception as e:
    log_error(
        service='ServiceName',
        function='function_name',
        error=e,
        request_id=request_id,
        input_data={'key': 'value'}
    )
    raise
```

### è·å–æ•æ„Ÿä¿¡æ¯

```python
# Coze API
token = get_coze_token()
bot_id = get_coze_bot_id()

# æ•°æ®åº“
password = get_mysql_password()

# JWT
secret = get_jwt_secret()
```

### å®‰å…¨æ‰§è¡Œ SQL

```python
# æŸ¥è¯¢
results = secure_execute_query(
    connection=conn,
    sql="SELECT * FROM users WHERE id = %s",
    params=(user_id,),
    request_id=request_id,
    service='ServiceName',
    function='function_name'
)

# æ›´æ–°
affected = secure_execute_update(
    connection=conn,
    sql="UPDATE users SET name = %s WHERE id = %s",
    params=(name, user_id),
    request_id=request_id,
    service='ServiceName',
    function='function_name'
)
```

---

## ğŸ” æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
tail -f logs/unified.log

# æŒ‰æœåŠ¡è¿‡æ»¤
grep '"service": "BaziService"' logs/unified.log

# æŒ‰è¯·æ±‚IDè¿½è¸ª
grep '"request_id": "your-request-id"' logs/unified.log

# æŸ¥çœ‹é”™è¯¯
grep '"level": "ERROR"' logs/unified.log
```

---

## âš ï¸ ç¦æ­¢çš„æ“ä½œ

### âŒ ç¦æ­¢ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯

```python
# âŒ é”™è¯¯
token = "pat_PtzrONUsEpMKhUb9mDc5nhyYwBWylvDgpgaFPd8TzM1gWRJZauIxtuUf147OnIde"

# âœ… æ­£ç¡®
from server.utils.secret_manager import get_coze_token
token = get_coze_token()
```

### âŒ ç¦æ­¢ç›´æ¥æ‹¼æ¥ SQL

```python
# âŒ é”™è¯¯
sql = f"SELECT * FROM users WHERE id = {user_id}"
cursor.execute(sql)

# âœ… æ­£ç¡®
from server.utils.sql_security import secure_execute_query
results = secure_execute_query(
    connection=conn,
    sql="SELECT * FROM users WHERE id = %s",
    params=(user_id,),
    request_id=request_id,
    service='ServiceName',
    function='function_name'
)
```

### âŒ ç¦æ­¢ä¸ä½¿ç”¨æ—¥å¿—

```python
# âŒ é”™è¯¯ - æ²¡æœ‰æ—¥å¿—
def my_function(param):
    result = process(param)
    return result

# âœ… æ­£ç¡® - æœ‰æ—¥å¿—
def my_function(param):
    request_id = str(uuid.uuid4())
    with trace_function('Service', 'my_function', request_id, {'param': param}):
        result = process(param)
        log_response('Service', 'my_function', request_id, {'result': result})
        return result
```

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- [ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿå’Œå®‰å…¨ç®¡ç†ä½¿ç”¨æŒ‡å—](./ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿå’Œå®‰å…¨ç®¡ç†ä½¿ç”¨æŒ‡å—.md)
- [P0å®‰å…¨ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š](./P0å®‰å…¨ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md)

---

**å¿«é€Ÿå‚è€ƒç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-15

