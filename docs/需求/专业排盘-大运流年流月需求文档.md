# 专业排盘-大运流年流月接口需求文档

> **接口路径**：`/bazi/fortune/display`  
> **接口类型**：POST  
> **文档版本**：v1.0  
> **创建日期**：2025-01-17  
> **状态**：已实现

---

## 1. 功能概述

### 1.1 接口定位

`/bazi/fortune/display` 是八字系统中**专业排盘-大运流年流月**的统一接口，用于一次性获取用户的大运、流年、流月完整数据。

### 1.2 核心功能

1. **大运数据**：获取用户的大运序列，包括当前大运、大运列表、起运交运信息
2. **流年数据**：获取指定大运范围内的流年序列，包括当前流年、流年列表
3. **流月数据**：获取指定年份的流月序列，包括当前流月、流月列表
4. **性能优化**：支持快速模式、异步预热、多级缓存（L1内存 + L2 Redis）

### 1.3 应用场景

- **专业排盘页面**：展示完整的大运流年流月时间线
- **运势分析**：为AI分析提供大运流年流月上下文数据
- **前端联动**：支持大运选择后动态加载对应流年，流年选择后动态加载对应流月

---

## 2. 接口规范

### 2.1 请求规范

#### 2.1.1 接口地址

```
POST /api/v1/bazi/fortune/display
```

#### 2.1.2 请求头

```
Content-Type: application/json
```

#### 2.1.3 请求参数

**基础参数**（继承自 `BaziBaseRequest`）：

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `solar_date` | string | 是 | 阳历日期（YYYY-MM-DD）或农历日期（当calendar_type=lunar时） | `"1985-05-15"` |
| `solar_time` | string | 是 | 出生时间（HH:MM） | `"14:30"` |
| `gender` | string | 是 | 性别（male/female） | `"male"` |
| `calendar_type` | string | 否 | 历法类型（solar/lunar），默认solar | `"solar"` |
| `location` | string | 否 | 出生地点（用于时区转换） | `"北京市"` |
| `latitude` | float | 否 | 纬度（用于时区转换） | `39.9042` |
| `longitude` | float | 否 | 经度（用于时区转换和真太阳时计算） | `116.4074` |

**特定参数**：

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `current_time` | string | 否 | 当前时间（YYYY-MM-DD HH:MM），用于确定当前大运和流年，默认为系统当前时间 | `"2025-01-17 14:30"` |
| `dayun_index` | integer | 否 | 大运索引（已废弃，优先使用dayun_year_start和dayun_year_end） | `4` |
| `dayun_year_start` | integer | 否 | 大运起始年份，指定要显示的大运的起始年份（性能优化：只返回该大运范围内的流年） | `2025` |
| `dayun_year_end` | integer | 否 | 大运结束年份，指定要显示的大运的结束年份（性能优化：只返回该大运范围内的流年） | `2034` |
| `target_year` | integer | 否 | 目标年份，用于计算该年份的流月，默认为当前流年 | `2025` |
| `quick_mode` | boolean | 否 | 快速模式，只计算当前大运，其他大运异步预热（默认True） | `true` |
| `async_warmup` | boolean | 否 | 是否触发异步预热（默认True） | `true` |

#### 2.1.4 请求示例

**基础请求**（获取所有大运流年流月）：

```json
{
  "solar_date": "1985-05-15",
  "solar_time": "14:30",
  "gender": "male",
  "calendar_type": "solar"
}
```

**指定大运范围**（性能优化，只返回指定大运范围内的流年）：

```json
{
  "solar_date": "1985-05-15",
  "solar_time": "14:30",
  "gender": "male",
  "dayun_year_start": 2025,
  "dayun_year_end": 2034,
  "target_year": 2025
}
```

**农历输入**：

```json
{
  "solar_date": "1985年四月初六",
  "solar_time": "14:30",
  "gender": "male",
  "calendar_type": "lunar"
}
```

**时区转换**：

```json
{
  "solar_date": "1985-05-15",
  "solar_time": "14:30",
  "gender": "male",
  "location": "纽约",
  "latitude": 40.7128,
  "longitude": -74.0060
}
```

### 2.2 响应规范

#### 2.2.1 响应结构

```json
{
  "success": true,
  "dayun": {
    "current": { /* 当前大运对象 */ },
    "list": [ /* 大运列表 */ ],
    "qiyun": { /* 起运信息 */ },
    "jiaoyun": { /* 交运信息 */ }
  },
  "liunian": {
    "current": { /* 当前流年对象 */ },
    "list": [ /* 流年列表 */ ]
  },
  "liuyue": {
    "current": { /* 当前流月对象 */ },
    "list": [ /* 流月列表 */ ],
    "target_year": 2025
  },
  "conversion_info": { /* 转换信息（如果进行了农历转换或时区转换） */ }
}
```

#### 2.2.2 大运数据结构

**当前大运对象**：

```json
{
  "step": 4,
  "stem": {
    "char": "戊",
    "wuxing": "土",
    "yinyang": "阳"
  },
  "branch": {
    "char": "辰",
    "wuxing": "土",
    "yinyang": "阳"
  },
  "ganzhi": "戊辰",
  "year_range": {
    "start": 2025,
    "end": 2034
  },
  "age_range": {
    "start": 40,
    "end": 49
  },
  "age_display": "40-49岁",
  "year_display": "2025-2034年",
  "is_current": true,
  "is_xiaoyun": false,
  "display_name": "戊辰",
  "main_star": "正官",
  "hidden_stars": ["正财", "比肩"],
  "nayin": "大林木",
  "deities": ["天乙贵人"]
}
```

**大运列表项**：格式同当前大运对象，`is_current` 标识当前大运。

**起运信息**：

```json
{
  "date": "2025-03-15",
  "age_display": "40岁",
  "description": "起运于2025年3月15日，40岁"
}
```

**交运信息**：

```json
{
  "date": "2025-03-15",
  "age_display": "40岁",
  "description": "交运于2025年3月15日，40岁"
}
```

#### 2.2.3 流年数据结构

**当前流年对象**：

```json
{
  "year": 2025,
  "stem": {
    "char": "乙",
    "wuxing": "木",
    "yinyang": "阴"
  },
  "branch": {
    "char": "巳",
    "wuxing": "火",
    "yinyang": "阴"
  },
  "ganzhi": "乙巳",
  "age": 40,
  "age_display": "40岁",
  "is_current": true,
  "nayin": "覆灯火",
  "main_star": "正财",
  "hidden_stems": ["戊", "庚", "丙"],
  "hidden_stars": ["正财", "正官", "偏财"],
  "star_fortune": "胎",
  "self_sitting": "沐浴",
  "kongwang": "",
  "deities": ["天乙贵人"],
  "relations": [
    {
      "type": "冲",
      "target": "日柱"
    }
  ],
  "stem_shishen": "正财",
  "branch_shishen": "正财",
  "shishen_combined": "正财/正财",
  "xiaoyun_ganzhi": "丙午",
  "xiaoyun_stem": "丙",
  "xiaoyun_branch": "午"
}
```

**流年列表项**：格式同当前流年对象，`is_current` 标识当前流年。

#### 2.2.4 流月数据结构

**当前流月对象**：

```json
{
  "month": 1,
  "solar_term": "立春",
  "term_date": "2/4",
  "ganzhi": "丙寅",
  "stem": {
    "char": "丙",
    "wuxing": "火"
  },
  "branch": {
    "char": "寅",
    "wuxing": "木"
  },
  "nayin": "炉中火",
  "stem_shishen": "正财",
  "branch_shishen": "正财",
  "shishen_combined": "正财/正财",
  "is_current": true
}
```

**流月列表项**：格式同当前流月对象，`is_current` 标识当前流月。

#### 2.2.5 转换信息

如果进行了农历转换或时区转换，会返回 `conversion_info`：

```json
{
  "converted": true,
  "original_date": "1985年四月初六",
  "original_time": "14:30",
  "final_solar_date": "1985-05-15",
  "final_solar_time": "14:30",
  "timezone_info": {
    "location": "纽约",
    "timezone_offset": -5,
    "adjusted_time": "09:30"
  }
}
```

#### 2.2.6 错误响应

```json
{
  "success": false,
  "error": "错误信息"
}
```

**HTTP状态码**：
- `400`：请求参数错误
- `500`：服务器内部错误

---

## 3. 功能特性

### 3.1 性能优化

#### 3.1.1 多级缓存

- **L1缓存**：内存缓存（进程内）
- **L2缓存**：Redis缓存（30天TTL）
- **缓存键格式**：`fortune_display:{solar_date}:{solar_time}:{gender}:{current_time}:{dayun_index}:{dayun_year_start}:{dayun_year_end}:{target_year}`

#### 3.1.2 快速模式

- **quick_mode=true**：只计算当前大运，其他大运异步预热
- **quick_mode=false**：计算所有大运（完整模式）

#### 3.1.3 大运范围过滤

- 通过 `dayun_year_start` 和 `dayun_year_end` 指定大运范围
- 只返回该大运范围内的流年（约10年），减少数据量
- 适用于前端大运联动场景

#### 3.1.4 异步预热

- `async_warmup=true`：触发异步预热，提前计算其他大运数据
- 提升后续请求的响应速度

### 3.2 数据联动

#### 3.2.1 大运-流年联动

- 选择大运后，只返回该大运范围内的流年
- 通过 `dayun_year_start` 和 `dayun_year_end` 参数实现

#### 3.2.2 流年-流月联动

- 选择流年后，通过 `target_year` 参数获取该年份的流月
- 前端可以动态切换流年，实时加载对应流月

### 3.3 输入处理

#### 3.3.1 农历转换

- 支持农历日期输入（`calendar_type=lunar`）
- 自动转换为阳历日期进行计算
- 返回转换信息（`conversion_info`）

#### 3.3.2 时区转换

- 支持通过 `location`、`latitude`、`longitude` 进行时区转换
- 自动计算真太阳时
- 返回时区转换信息（`conversion_info`）

### 3.4 当前状态判断

#### 3.4.1 当前大运判断

- **优先方式**：根据交运日期判断（年份+节气后N天）
- **降级方式**：根据虚岁判断（年龄范围）
- 标记 `is_current=true`

#### 3.4.2 当前流年判断

- 根据当前年份判断
- 标记 `is_current=true`

#### 3.4.3 当前流月判断

- 根据当前月份判断
- 标记 `is_current=true`

---

## 4. 业务规则

### 4.1 大运计算规则

1. **大运序列**：根据性别和出生时间计算，男命顺排，女命逆排
2. **起运年龄**：根据出生日期和节气计算
3. **大运周期**：每个大运10年（特殊情况可能不同）
4. **小运**：特殊情况下可能出现小运（`is_xiaoyun=true`）

### 4.2 流年计算规则

1. **流年序列**：每个大运包含10个流年（对应10个年份）
2. **流年归属**：流年必须归属到对应的大运（通过年份范围判断）
3. **特殊流年**：天克地冲、天合地合、岁运并临等特殊流年会标记关系

### 4.3 流月计算规则

1. **流月序列**：每个流年包含12个流月（对应12个节气）
2. **节气起点**：流月从立春开始计算
3. **流月归属**：流月必须归属到对应的流年

---

## 5. 前端集成

### 5.1 基础使用

```javascript
// 获取所有大运流年流月
const response = await api.post('/bazi/fortune/display', {
  solar_date: '1985-05-15',
  solar_time: '14:30',
  gender: 'male'
});

// 获取指定大运范围内的流年
const response = await api.post('/bazi/fortune/display', {
  solar_date: '1985-05-15',
  solar_time: '14:30',
  gender: 'male',
  dayun_year_start: 2025,
  dayun_year_end: 2034
});

// 获取指定年份的流月
const response = await api.post('/bazi/fortune/display', {
  solar_date: '1985-05-15',
  solar_time: '14:30',
  gender: 'male',
  target_year: 2025
});
```

### 5.2 大运联动

```javascript
// 选择大运后，获取该大运范围内的流年
async function selectDayun(dayun) {
  const response = await api.post('/bazi/fortune/display', {
    solar_date: currentData.solar_date,
    solar_time: currentData.solar_time,
    gender: currentData.gender,
    dayun_year_start: dayun.year_range.start,
    dayun_year_end: dayun.year_range.end
  });
  
  // 更新流年数据
  currentData.liunian = response.liunian;
  renderLiunian();
}
```

### 5.3 流年联动

```javascript
// 选择流年后，获取该年份的流月
async function selectLiunian(year) {
  const response = await api.post('/bazi/fortune/display', {
    solar_date: currentData.solar_date,
    solar_time: currentData.solar_time,
    gender: currentData.gender,
    target_year: year
  });
  
  // 更新流月数据
  currentData.liuyue = response.liuyue;
  renderLiuyue();
}
```

---

## 6. 技术实现

### 6.1 服务层

- **服务类**：`BaziDisplayService`
- **方法**：`get_fortune_display()`
- **依赖服务**：`BaziDetailService.calculate_detail_full()`

### 6.2 接口层

- **路由文件**：`server/api/v1/bazi_display.py`
- **请求模型**：`FortuneDisplayRequest`
- **响应处理**：自动添加 `conversion_info`（如果进行了转换）

### 6.3 缓存策略

- **缓存键生成**：`_generate_fortune_cache_key()`
- **缓存TTL**：30天（大运流年流月数据不随时间变化）
- **缓存失效**：手动清除或TTL过期

### 6.4 gRPC网关注册

- **注册路径**：`/bazi/fortune/display`
- **注册文件**：`server/api/grpc_gateway.py`
- **支持gRPC-Web访问**：通过 `/api/v1/bazi/fortune/display` 路径

---

## 7. 数据格式说明

### 7.1 天干地支

- **天干**：甲、乙、丙、丁、戊、己、庚、辛、壬、癸
- **地支**：子、丑、寅、卯、辰、巳、午、未、申、酉、戌、亥
- **干支组合**：天干+地支，如"甲子"、"乙丑"等

### 7.2 五行属性

- **五行**：木、火、土、金、水
- **天干五行**：甲(木)、乙(木)、丙(火)、丁(火)、戊(土)、己(土)、庚(金)、辛(金)、壬(水)、癸(水)
- **地支五行**：子(水)、丑(土)、寅(木)、卯(木)、辰(土)、巳(火)、午(火)、未(土)、申(金)、酉(金)、戌(土)、亥(水)

### 7.3 十神

- **十神类型**：比肩、劫财、食神、伤官、偏财、正财、七杀、正官、偏印、正印
- **主星**：天干对应的十神
- **副星**：地支藏干对应的十神

### 7.4 神煞

- **常见神煞**：天乙贵人、文昌贵人、桃花、驿马、华盖等
- **返回格式**：数组形式，如 `["天乙贵人", "文昌贵人"]`

### 7.5 纳音

- **纳音五行**：根据干支组合查询纳音
- **示例**：甲子(海中金)、乙丑(海中金)等

---

## 8. 错误处理

### 8.1 参数验证错误

- **错误码**：400
- **错误信息**：参数格式错误、必填参数缺失等
- **处理方式**：前端提示用户修正输入

### 8.2 计算错误

- **错误码**：500
- **错误信息**：八字计算失败、详细计算失败等
- **处理方式**：记录日志，返回错误信息

### 8.3 缓存错误

- **降级策略**：Redis不可用时，降级到直接计算
- **日志记录**：记录警告日志，不影响功能

---

## 9. 性能指标

### 9.1 响应时间

- **缓存命中**：< 50ms
- **缓存未命中（快速模式）**：< 500ms
- **缓存未命中（完整模式）**：< 2000ms

### 9.2 数据量

- **大运列表**：通常8-10个大运
- **流年列表**：每个大运10个流年（约10年）
- **流月列表**：每个流年12个流月（12个节气）

### 9.3 缓存命中率

- **目标**：> 80%（相同用户重复查询）
- **优化**：30天TTL，适合长期缓存

---

## 10. 测试用例

### 10.1 基础功能测试

**测试用例1：基础请求**

```json
请求：
{
  "solar_date": "1985-05-15",
  "solar_time": "14:30",
  "gender": "male"
}

预期结果：
- success: true
- 返回大运、流年、流月数据
- 当前大运、当前流年、当前流月正确标记
```

**测试用例2：指定大运范围**

```json
请求：
{
  "solar_date": "1985-05-15",
  "solar_time": "14:30",
  "gender": "male",
  "dayun_year_start": 2025,
  "dayun_year_end": 2034
}

预期结果：
- success: true
- 流年列表只包含2025-2034年的流年
```

**测试用例3：指定目标年份**

```json
请求：
{
  "solar_date": "1985-05-15",
  "solar_time": "14:30",
  "gender": "male",
  "target_year": 2025
}

预期结果：
- success: true
- 流月列表为2025年的12个流月
```

### 10.2 边界情况测试

**测试用例4：农历输入**

```json
请求：
{
  "solar_date": "1985年四月初六",
  "solar_time": "14:30",
  "gender": "male",
  "calendar_type": "lunar"
}

预期结果：
- success: true
- conversion_info.converted: true
- 正确转换为阳历日期
```

**测试用例5：时区转换**

```json
请求：
{
  "solar_date": "1985-05-15",
  "solar_time": "14:30",
  "gender": "male",
  "location": "纽约",
  "latitude": 40.7128,
  "longitude": -74.0060
}

预期结果：
- success: true
- conversion_info.timezone_info 存在
- 时间正确转换
```

### 10.3 性能测试

**测试用例6：缓存命中**

```json
步骤：
1. 第一次请求（缓存未命中）
2. 立即第二次请求（缓存命中）

预期结果：
- 第二次请求响应时间 < 50ms
- 日志显示"缓存命中"
```

**测试用例7：快速模式**

```json
请求：
{
  "solar_date": "1985-05-15",
  "solar_time": "14:30",
  "gender": "male",
  "quick_mode": true
}

预期结果：
- 响应时间 < 500ms
- 只返回当前大运数据
```

---

## 11. 相关接口

### 11.1 相关接口列表

| 接口路径 | 说明 | 关系 |
|---------|------|------|
| `/bazi/pan/display` | 排盘展示 | 基础数据，不包含大运流年流月 |
| `/bazi/dayun/display` | 大运展示 | 只返回大运数据 |
| `/bazi/liunian/display` | 流年展示 | 只返回流年数据 |
| `/bazi/liuyue/display` | 流月展示 | 只返回流月数据 |
| `/bazi/data` | 统一数据接口 | 包含大运流年流月，但格式不同 |

### 11.2 接口选择建议

- **需要完整大运流年流月**：使用 `/bazi/fortune/display`
- **只需要大运**：使用 `/bazi/dayun/display`
- **只需要流年**：使用 `/bazi/liunian/display`
- **只需要流月**：使用 `/bazi/liuyue/display`
- **需要基础八字数据+大运流年流月**：使用 `/bazi/data`

---

## 12. 更新日志

### v1.0 (2025-01-17)

- ✅ 初始版本
- ✅ 支持大运流年流月统一接口
- ✅ 支持快速模式、异步预热
- ✅ 支持多级缓存（L1内存 + L2 Redis）
- ✅ 支持大运范围过滤（性能优化）
- ✅ 支持农历转换、时区转换
- ✅ 支持gRPC-Web访问

---

## 13. 附录

### 13.1 相关文档

- **开发规范**：`docs/knowledge_base/development_rules.md`
- **gRPC协议规范**：`docs/standards/grpc-protocol.md`
- **热更新规范**：`docs/standards/hot-reload.md`
- **错误记录本**：`docs/knowledge_base/error_records.md`

### 13.2 代码位置

- **接口定义**：`server/api/v1/bazi_display.py`
- **服务实现**：`server/services/bazi_display_service.py`
- **请求模型**：`server/api/v1/models/bazi_base_models.py`
- **gRPC网关注册**：`server/api/grpc_gateway.py`

### 13.3 测试文件

- **单元测试**：`tests/api/test_fortune_display.py`（如果存在）
- **集成测试**：`tests/api/test_bazi_backward_compatibility.py`

---

**文档结束**
