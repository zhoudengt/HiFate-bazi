# 八字命理-AI问答两阶段交互流程需求文档

**创建日期**: 2025-12-31  
**需求状态**: 后端已实现，前端开发中  
**API接口**: `/api/v1/smart-fortune/smart-analyze-stream`

---

## 📋 需求概述

增强现有的"八字命理-AI问答"功能，实现两阶段交互流程，提升用户体验。用户首先点击选择项（如"事业财富"），系统生成简短答复和预设问题列表；然后用户点击预设问题或输入自己的问题，系统生成详细的流式回答和相关问题。

### 前端UI需求

1. **导航栏菜单**：在"命书"导航栏下增加"AI问答"菜单项
2. **AI问答页面**：
   - 进入页面后显示生辰输入表单
   - 输入生辰后，显示提示文字："看了命盘解读，你是最关注哪一方面呢"
   - 同时显示二级预制问题菜单：
     - "事业财富"
     - "婚姻"
     - "健康"
     - "子女"
     - "流年运势"
     - "年运报告"
   - 点击二级菜单后，调用后端API（场景1）
   - 显示简短答复（流式）和预设问题列表
   - 点击预设问题或输入问题后，调用后端API（场景2）
   - 显示详细流式回答和相关问题列表

### 前端UI需求

1. **导航栏菜单**：在"命书"导航栏下增加"AI问答"菜单项
2. **AI问答页面**：
   - 进入页面后显示生辰输入表单
   - 输入生辰后，显示提示文字："看了命盘解读，你是最关注哪一方面呢"
   - 同时显示二级预制问题菜单：
     - "事业财富"
     - "婚姻"
     - "健康"
     - "子女"
     - "流年运势"
     - "年运报告"
   - 点击二级菜单后，调用后端API（场景1）
   - 显示简短答复（流式）和预设问题列表
   - 点击预设问题或输入问题后，调用后端API（场景2）
   - 显示详细流式回答和相关问题列表

---

## 🎯 核心需求

### 1. 两阶段交互流程

#### 阶段1：用户点击选择项
- **触发条件**: 用户点击选择项（如"事业财富"、"婚姻"、"健康"、"子女"、"流年运势"、"年运报告"）
- **输入参数**:
  - `category`: 选择项名称（必填）
  - `user_id`: 用户ID（必填）
  - `year`: 出生年份（必填）
  - `month`: 出生月份（必填）
  - `day`: 出生日期（必填）
  - `hour`: 出生时辰（可选，默认12）
  - `gender`: 性别（必填，male/female）
  - `question`: 可为空或等于选择项名称
- **系统处理**:
  1. 计算完整的八字数据（包括八字、五行、十神、大运流年、数据库规则等）
  2. 将完整八字数据保存到会话缓存（Redis，TTL 24小时）
  3. 调用LLM生成简短答复（100字内，流式输出）
  4. 调用LLM生成预设问题列表（10-15个，JSON格式）
- **返回内容**:
  - 简短答复（流式输出，SSE事件类型：`brief_response_start`、`brief_response_chunk`、`brief_response_end`）
  - 预设问题列表（SSE事件类型：`preset_questions`，包含10-15个问题）

#### 阶段2：用户提问（点击预设问题或输入问题）
- **触发条件**: 用户点击预设问题或输入自己的问题
- **输入参数**:
  - `category`: 之前选择的选择项（必填）
  - `user_id`: 用户ID（必填，与阶段1相同）
  - `question`: 用户问题（必填，预设问题文本或用户输入）
  - `year`、`month`、`day`、`hour`、`gender`: 可选（从会话缓存获取）
- **系统处理**:
  1. 从会话缓存获取完整八字数据（如果不存在，尝试重新计算）
  2. 识别用户意图（复用现有意图识别逻辑）
  3. 匹配数据库规则（复用现有规则匹配逻辑）
  4. 分析流年大运（可选，复用现有逻辑）
  5. 调用LLM生成详细流式回答（结合八字数据、类别、问题）
  6. 调用LLM生成相关问题列表（2个，基于详细回答和用户意图）
- **返回内容**:
  - 详细流式回答（SSE事件类型：`analysis_start`、`analysis_chunk`、`analysis_end`）
  - 相关问题列表（SSE事件类型：`related_questions`，包含2个问题）

---

## 🎨 语言风格要求

### 1. 避免专业术语
- **要求**：答案必须使用通俗易懂的语言，避免命理学术语
- **原因**：用户为普通用户，非专业人士，但问题具有创造性
- **实现方式**：
  - 在Coze Bot的系统提示词中明确要求
  - 在传递给Bot的数据中添加 `language_style` 字段
  - 用日常语言解释命理概念

### 2. 术语转换示例
- "正官" → "稳定的工作机会"
- "七杀" → "挑战和压力"
- "食神" → "才华和创造力"
- "比肩" → "合作伙伴或竞争对手"
- "劫财" → "财务风险"
- "偏财" → "意外收入"
- "正财" → "稳定收入"
- "印星" → "贵人相助或学习能力"
- "伤官" → "创新思维或表达能力"

### 3. 语言风格原则
- 使用日常用语，避免专业术语
- 用具体的生活场景解释抽象概念
- 确保非专业人士也能完全理解
- 保持回答的专业性和准确性，但用通俗语言表达

### 4. 相关问题语言要求
- **要求**：相关问题也必须用通俗易懂的语言，不能包含专业术语
- **禁止术语**：不能在问题中使用"乙巳年"、"巳申六合"、"财星"、"七杀"、"正官"、"食神"、"比肩"、"劫财"、"偏财"、"正财"、"印星"、"伤官"等专业术语
- **正确示例**：
  - ✅ "今年哪些月份适合发展感情？"（而不是"乙巳年哪些月份..."）
  - ✅ "如何应对感情中的压力和计较？"（而不是"如何应对财星、七杀..."）
  - ✅ "哪些月份或场合能更好地利用缘分机会？"（而不是"哪些月份或场合能更好地利用'巳申六合'的缘分机会？"）
- **错误示例**：
  - ❌ "2025年乙巳年中，哪些具体月份或场合能更好地利用'巳申六合'的缘分机会？"
  - ❌ "在感情关系中，如何识别并应对'财星、七杀'带来的压力或计较心态？"
- **实现方式**：
  - 在生成相关问题的prompt中明确禁止使用专业术语
  - 要求用日常语言表达，如"今年"而不是"乙巳年"，"缘分机会"而不是"巳申六合"

---

## ⚡ 性能优化要求

### 1. 相关问题生成速度优化
- **目标**：相关问题生成响应时间 < 3秒
- **优化措施**：
  - 减少传递给LLM的数据量（bazi_response从500字减少到300字）
  - 简化user_intent数据，只传递关键字段（intents和confidence）
  - 优化prompt，减少不必要的说明
  - 明确要求快速生成，减少思考时间
  - 在prompt中强调"快速生成，不要过度思考"

### 2. 性能监控
- 记录相关问题生成的响应时间
- 如果响应时间 > 3秒，记录警告日志
- 持续优化prompt和数据传递，提升响应速度

---

## 🔧 技术实现要求

### 1. API接口设计

**接口路径**: `/api/v1/smart-fortune/smart-analyze-stream`  
**请求方法**: GET  
**参数获取方式**: 使用 `Request` 对象手动获取查询参数（绕过FastAPI参数验证问题）

**查询参数**:
- `category` (可选): 选择项（事业财富、婚姻、健康、子女、流年运势、年运报告）
- `question` (可选): 用户问题（场景2必填，场景1可为空）
- `user_id` (必填): 用户ID
- `year` (可选): 出生年份（场景1必填，场景2可选）
- `month` (可选): 出生月份（场景1必填，场景2可选）
- `day` (可选): 出生日期（场景1必填，场景2可选）
- `hour` (可选): 出生时辰（0-23，默认12）
- `gender` (可选): 性别（male/female，场景1必填，场景2可选）

### 2. 场景判断逻辑

```python
# 场景1：点击选择项（category有值，question为空或为选择项名称）
is_scenario_1 = category and (not question or question == category)

# 场景2：点击预设问题/输入问题（category有值，question有值）
is_scenario_2 = category and question and question != category

# 默认场景：使用原有逻辑（兼容性）
if not category:
    # 原有逻辑：需要生辰信息和问题
```

### 3. 会话管理

**服务**: `BaziSessionService`  
**存储位置**: Redis  
**键格式**: `bazi_session:{user_id}`  
**TTL**: 24小时（86400秒）  
**存储内容**: 完整的八字数据（包括八字、五行、十神、大运流年、数据库规则等）

**方法**:
- `save_bazi_session(user_id, bazi_data, ttl)`: 保存会话数据
- `get_bazi_session(user_id)`: 获取会话数据
- `clear_bazi_session(user_id)`: 清除会话数据

### 4. 八字数据计算

**阶段1必须计算的数据**:
- 基础八字数据：`BaziService.calculate_bazi_full()`
- 详细八字数据：`BaziDetailService.calculate_detail_full()`（包含大运流年）
- 规则匹配：`BaziService._match_rules()`（匹配所有相关规则）

**阶段2数据获取**:
- 完全从会话缓存获取（不进行任何计算）
- 如果缓存不存在，返回错误信息（要求先点击选择项）
- 从session获取所有数据：`bazi_result`、`detail_result`、`matched_rules`、`wangshuai_result`、`fortune_context`

### 5. LLM生成内容

#### 简短答复（阶段1）
- **方法**: `FortuneLLMClient.generate_brief_response(bazi_data, category)`
- **要求**: 100字内，流式输出
- **Prompt**: 基于八字数据和选择项，生成简短说明
- **SSE事件**: `brief_response_start`、`brief_response_chunk`、`brief_response_end`

#### 预设问题列表（阶段1）
- **方法**: `FortuneLLMClient.generate_preset_questions(bazi_data, category)`
- **要求**: 10-15个问题，JSON格式
- **Prompt**: 基于八字数据和选择项，生成相关预设问题
- **SSE事件**: `preset_questions`（一次性返回）

#### 详细回答（阶段2）
- **方法**: `FortuneLLMClient.analyze_fortune(bazi_data, question, category, ...)`
- **要求**: 详细分析，流式输出
- **Prompt**: 基于八字数据、类别、问题，生成详细分析
- **SSE事件**: `analysis_start`、`analysis_chunk`、`analysis_end`

#### 相关问题列表（阶段2）
- **方法**: `FortuneLLMClient.generate_related_questions(bazi_response, user_intent, bazi_data, category)`
- **要求**: 2个问题，JSON格式
- **Prompt**: 基于详细回答内容和用户意图，生成相关问题
- **SSE事件**: `related_questions`（一次性返回）

### 6. SSE事件格式

**事件类型**:
- `brief_response_start`: 简短答复开始
- `brief_response_chunk`: 简短答复增量内容
- `brief_response_end`: 简短答复结束
- `preset_questions`: 预设问题列表
- `analysis_start`: 详细分析开始
- `analysis_chunk`: 详细分析增量内容
- `analysis_end`: 详细分析结束
- `related_questions`: 相关问题列表

---

## ⚡ 场景2性能优化要求

### 1. 场景1必须计算并保存所有信息到session
- **要求**：场景1必须计算所有生辰相关信息，包括：
  - 基础八字数据（`bazi_result`）
  - 详细八字数据（`detail_result`，包含大运流年）
  - 匹配的所有规则（`matched_rules`，所有类型）
  - 旺衰数据（`wangshuai_result`）
  - 流年大运分析（`fortune_context`，如果需要）
- **实现方式**：在场景1中计算所有数据，保存到session（Redis，TTL 24小时）
- **性能影响**：场景1可能稍慢，但场景2会非常快

### 2. 场景2完全从session获取，不进行任何计算
- **要求**：场景2完全从session获取所有数据，不进行任何计算
- **禁止操作**：
  - ❌ 禁止意图识别（用户问题意图很明显）
  - ❌ 禁止规则重新匹配（使用session中的`matched_rules`）
  - ❌ 禁止流年大运重新计算（使用session中的`fortune_context`）
  - ❌ 禁止任何数据库查询或计算操作
- **实现方式**：从session获取所有数据，直接调用LLM生成答案

### 3. 不需要意图识别
- **要求**：场景2不需要进行意图识别，用户问题意图很明显
- **实现方式**：直接根据category确定规则类型，使用`CATEGORY_TO_RULE_TYPE`映射表
- **性能提升**：节省50-100ms

### 4. 直接使用session中的规则数据
- **要求**：场景2直接使用场景1中已匹配的规则数据，不再重新匹配
- **实现方式**：从session中获取`matched_rules`，根据category过滤（如果需要）
- **性能提升**：节省100-200ms（避免不必要的数据库查询）

### 5. 直接使用session中的流年大运数据
- **要求**：场景2直接使用场景1中已计算的流年大运数据，不再重新计算
- **实现方式**：从session中获取`fortune_context`，如果不存在则使用None
- **性能提升**：节省500-1000ms（如果触发流年大运计算）

### 6. 按照命理学的框架生成答案
- **要求**：直接调用LLM，按照命理学的框架与用户信息生成答案
- **实现方式**：将八字数据、规则数据、用户问题直接传递给LLM，按照命理框架生成答案
- **性能提升**：减少不必要的中间处理步骤

### 7. Category到规则类型映射
- **映射表**：
  - "事业财富" → "wealth"（或根据实际数据库规则类型）
  - "婚姻" → "marriage"
  - "健康" → "health"
  - "子女" → "children"
  - "流年运势" → "general"
  - "年运报告" → "general"

### 8. 预期性能提升
- **移除意图识别**：节省50-100ms
- **移除规则重新匹配**：节省100-200ms
- **移除流年大运重新计算**：节省500-1000ms（如果触发）
- **总提升**：节省约650-1300ms（约0.6-1.3秒）

**注意**：LLM调用耗时（64秒）是主要瓶颈，但这是Coze API的响应时间，无法通过代码优化解决。移除不必要的计算可以提升整体响应速度，但LLM调用本身仍然需要等待。
- `error`: 错误信息
- `end`: 流式响应结束

**事件格式**:
```json
{
  "type": "brief_response_chunk",
  "content": "根据您的八字..."
}
```

```json
{
  "type": "preset_questions",
  "questions": [
    "我今年的事业运势如何？",
    "我适合从事什么行业？",
    ...
  ]
}
```

---

## 📊 数据流程

### 阶段1数据流程
```
用户点击选择项
    ↓
接收参数（category, user_id, year, month, day, hour, gender）
    ↓
计算完整八字数据
    ├─ BaziService.calculate_bazi_full()
    ├─ BaziDetailService.calculate_detail_full()
    └─ BaziService._match_rules()
    ↓
保存到会话缓存（Redis）
    ↓
生成简短答复（LLM，流式）
    ↓
生成预设问题列表（LLM，10-15个）
    ↓
返回给前端（SSE流式输出）
```

### 阶段2数据流程（性能优化后）
```
用户点击预设问题/输入问题
    ↓
接收参数（category, user_id, question）
    ↓
从会话缓存获取完整八字数据
    ├─ 如果存在 → 使用缓存数据（包含所有信息）
    └─ 如果不存在 → 返回错误（要求先点击选择项）
    ↓
直接根据category确定规则类型（不需要意图识别）
    ↓
从session中获取matched_rules（不需要重新匹配）
    ↓
从session中获取fortune_context（不需要重新计算）
    ↓
直接调用LLM生成详细回答（流式）
    ↓
生成相关问题列表（LLM，2个）
    ↓
返回给前端（SSE流式输出）
```

---

## ✅ 验收标准

### 功能验收
- [x] 场景1：点击选择项，返回简短答复（100字内，流式）+ 预设问题列表（10-15个）
- [x] 场景2：点击预设问题/输入问题，返回详细流式回答 + 2个相关问题
- [x] 八字数据只计算一次，存储在会话中，后续交互复用
- [x] 所有LLM生成的内容都流式输出
- [x] 会话数据正确保存和获取（Redis）
- [x] 错误处理完善（数据不完整、LLM调用失败等）

### 性能验收
- [x] 场景1响应时间 < 5秒（包括八字计算、LLM生成）
- [x] 场景2响应时间 < 10秒（包括意图识别、规则匹配、LLM生成）
- [x] 流式输出延迟 < 1秒（第一个chunk）

### 兼容性验收
- [x] 原有接口逻辑保持不变（不传category时使用原有逻辑）
- [x] 前端无需修改（使用相同的接口路径）
- [x] 参数验证正确（使用Request对象手动获取参数）

### 前端UI验收
- [ ] 导航栏"命书"下显示"AI问答"菜单项
- [ ] AI问答页面正确显示生辰输入表单
- [ ] 输入生辰后显示提示文字和二级菜单
- [ ] 二级菜单包含6个选项（事业财富、婚姻、健康、子女、流年运势、年运报告）
- [ ] 点击二级菜单后正确调用场景1API
- [ ] 正确显示简短答复（流式）和预设问题列表
- [ ] 点击预设问题或输入问题后正确调用场景2API
- [ ] 正确显示详细流式回答和相关问题列表
- [ ] 浏览器端到端测试通过

---

## 🔄 实现状态

**状态**: ✅ 已实现

**实现文件**:
- `server/api/v1/smart_fortune.py`: API接口实现
- `server/services/fortune_llm_client.py`: LLM客户端（新增方法）
- `server/services/bazi_session_service.py`: 会话管理服务（新建）

**关键修改**:
1. 修改 `smart_analyze_stream` 函数，使用 `Request` 对象手动获取查询参数
2. 实现场景判断逻辑（场景1、场景2、默认场景）
3. 实现 `_scenario_1_generator` 和 `_scenario_2_generator` 辅助函数
4. 在 `FortuneLLMClient` 中新增方法：
   - `generate_brief_response()`: 生成简短答复
   - `generate_preset_questions()`: 生成预设问题列表
   - `generate_related_questions()`: 生成相关问题列表
5. 创建 `BaziSessionService` 服务，管理会话缓存

---

## 📝 注意事项

1. **接口名称不变**: 使用相同的接口路径 `/api/v1/smart-fortune/smart-analyze-stream`，通过参数区分场景
2. **参数获取方式**: 使用 `Request` 对象手动获取查询参数，绕过FastAPI参数验证问题
3. **会话管理**: 使用Redis存储会话数据，TTL 24小时，确保数据一致性
4. **错误处理**: 所有错误都通过SSE事件返回，不中断流式输出
5. **性能优化**: 八字数据只计算一次，后续交互复用，大幅提升性能

---

## 🧪 测试用例

### 测试场景1：点击选择项
```bash
curl -X GET "http://localhost:8001/api/v1/smart-fortune/smart-analyze-stream?category=事业财富&user_id=test_user_001&year=1990&month=5&day=15&hour=14&gender=male" \
  --no-buffer
```

**预期结果**:
- 状态码: 200
- 流式输出: 简短答复（100字内）+ 预设问题列表（10-15个）

### 测试场景2：点击预设问题
```bash
curl -X GET "http://localhost:8001/api/v1/smart-fortune/smart-analyze-stream?category=事业财富&user_id=test_user_001&question=我今年的事业运势如何？" \
  --no-buffer
```

**预期结果**:
- 状态码: 200
- 流式输出: 详细回答 + 相关问题列表（2个）

---

## 📚 相关文档

- API接口文档: `server/api/v1/smart_fortune.py`
- LLM客户端文档: `server/services/fortune_llm_client.py`
- 会话服务文档: `server/services/bazi_session_service.py`
- 开发规范: `.cursorrules`

---

## 🤖 Coze Bot提示词优化

### 重要说明

**⚠️ 提示词必须写在Coze Bot中，不能写在代码中！**

以下提示词需要复制到对应的Coze Bot配置中：
- **命理分析提示词**：用于场景2的答案生成（主分析Bot）
- **问题生成提示词**：用于相关问题生成（相关问题生成Bot）

---

### 1. 命理分析提示词（场景2答案生成）

**使用位置**：主分析Bot的系统提示词

**提示词内容**：

```
你是一个拥有很多年经验的命理师，请用传统八字的理论分析一下以下命局。

【角色定位】
- 你是资深的命理师，精通传统八字命理学
- 你拥有丰富的实战经验，能够准确分析命局
- 你能够结合用户的提问和对话历史，提供个性化的专业分析

【分析要求】
1. 基于用户提供的八字信息进行专业分析
2. 回答要准确、专业，符合传统命理学原理
3. 语言要自然、流畅，避免过于玄学化
4. 要给出具体的建议，而非空泛的描述
5. 避免绝对化的表述，使用"倾向于"、"可能"等相对温和的措辞
6. 结合对话历史，理解用户的真实意图和关注点
7. 如果用户之前问过相关问题，要结合之前的回答，提供更深入的分析

【性能要求】
1. **快速响应**：必须在10秒内开始生成内容，不要过度思考
2. **精简输入**：八字详细信息已在第一次调用时提供，本次只基于用户问题和类别生成答案
3. **直接回答**：直接回答用户的问题，不要重复问题，不要添加冗长的开场白

【输入数据格式】
用户会提供以下结构化数据：
- user_question: 用户当前问题
- bazi_data: 八字数据（四柱、十神、五行等）
- wangshuai: 旺衰分析
- dayun_sequence: 大运序列
- liunian_sequence: 流年序列
- matched_rules: 匹配到的规则
- intent: 意图识别结果
- conversation_context: 对话上下文（包含之前的问题和答案）

【输出要求】
1. 直接回答用户的问题，不要重复问题
2. 结合八字信息、规则匹配结果、大运流年等信息
3. 如果对话历史中有相关信息，要结合之前的分析
4. 回答要专业、准确、有针对性
5. 使用 Markdown 格式，适当使用列表、加粗等格式
6. **语言风格**：通俗易懂，避免专业术语，面向普通用户。用日常语言解释命理概念，如"正官"可以说成"稳定的工作机会"，"七杀"可以说成"挑战和压力"。
```

---

### 2. 问题生成提示词（相关问题生成）

**使用位置**：相关问题生成Bot的系统提示词

**提示词内容**：

```
你是一个专业的命理咨询助手。基于用户的问题、答案内容和八字信息，生成2个相关的后续问题。

【角色定位】
- 你是专业的命理咨询助手
- 你能够理解用户的关注点和意图
- 你能够基于对话内容生成有针对性的后续问题

【生成要求】
1. 问题要具体、有针对性，不能空泛
2. 问题要符合用户的关注点和意图
3. 问题要有助于用户深入了解自己的命理
4. 问题要简洁明了，每个问题不超过20字
5. 如果用户之前问过相关问题，要避免重复
6. 问题要有递进性，从浅入深
7. **只生成2个问题**，用换行分隔，不要编号，不要添加任何说明文字

【性能要求】
1. **快速生成**：必须在2秒内生成问题，不要过度思考
2. **直接输出**：直接输出2个问题，不要添加任何说明文字
3. **简洁明了**：问题要简洁，每个问题不超过20字

【语言风格要求】
1. **避免专业术语**：问题必须用通俗易懂的语言，不能包含任何专业术语
2. **禁止使用以下专业术语**：乙巳年、巳申六合、财星、七杀、正官、食神、比肩、劫财、偏财、正财、印星、伤官等
3. **用日常语言表达**：如"今年"而不是"乙巳年"，"缘分机会"而不是"巳申六合"，"工作压力"而不是"七杀"
4. **问题要有创造性**：问题要具有创造性，能够引导用户深入思考

【输入数据格式】
用户会提供以下数据：
- user_question: 用户当前问题
- answer: 答案内容（如果是在答案生成后生成问题）
- intent: 意图识别结果
- bazi_summary: 八字摘要
- conversation_context: 对话上下文

【输出格式】
直接输出2个问题，每行一个问题，例如：
我适合在哪个城市发展？
我明年会有升职机会吗？

【注意事项】
1. 只输出2个问题，不要多也不要少
2. 每行一个问题，不要编号
3. 不要添加任何说明文字
4. 问题必须用通俗易懂的语言，避免专业术语
5. 快速生成，不要过度思考
```

---

**文档版本**: v1.1  
**最后更新**: 2025-12-31  
**更新内容**: 添加Coze Bot提示词优化章节

