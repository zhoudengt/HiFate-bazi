# 八字系统后端评测功能需求文档

> 文档版本：v2.0  
> 创建日期：2026-01-05  
> 更新日期：2026-01-06  
> 状态：已完成

---

## 1. 功能概述

开发一个后端评测脚本/模块，用于：
1. 读取Excel表格中的测试数据（用户生辰信息）
2. 批量调用各种八字分析API接口
3. 将生成的结果追加到Excel的对应列
4. 支持AI多轮问答评测

**核心原则：**
- 只做查询，不修改现有功能
- 不影响现有功能的效率
- 代码规范、层次化设计

---

## 2. 输入输出规范

### 2.1 输入数据（Excel列）

| 列名 | 说明 | 示例 |
|------|------|------|
| USER_ID | 系统自动生成 | 1, 2, 3... |
| 用户名 | 用户姓名 | 董文强 |
| USER_birth（生辰八字） | 出生日期 | 1985 年 10 月 21 日 |
| 性别（男/女） | 性别 | 男/女 |

**注意：** 出生时间默认使用中午12:00（如Excel无时辰数据）

### 2.2 输出数据（追加列）

#### 2.2.1 基础八字数据列

调用 `/bazi/data` 统一接口获取（8步大运+完整流年）：

| 输出列名 | 数据来源 | 格式说明 |
|----------|----------|----------|
| 日元 | bazi_pillars.day.stem + branch | **完整日柱**：癸巳（日干+日支） |
| 五行 | element_counts | 金0 木1 水1 火3 土3 |
| 十神 | ten_gods_stats.main + branch | **主星+副星分别列出**：主星: 食神(年)、正财(月)、正官(时) \| 副星: ... |
| 喜忌 | wangshuai.xi_shen_elements + ji_shen_elements | 喜：水、金；忌：木、火、土 |
| 旺衰 | wangshuai.wangshuai + element_scores | **详细格式**：日主极弱 \| 喜神：水、金 \| 忌神：木、火、土 \| 五行得分：金:x, 木:x, ... |
| 格局 | xishen_jishen.shishen_mingge | 日贵格、化气格、天乙贵人格 |
| 大运流年 | dayun + liunian_sequence | **8步大运**，每步包含：干支(主星) [起止年龄] 流年:年份:干支(主星), ... |
| 日元-六十甲子 | /bazi/rizhu-liujiazi | rizhu日: analysis内容 |

#### 2.2.2 大模型分析列

调用各流式接口，收集完整的大模型分析内容：

| 输出列名 | 调用接口 | 说明 |
|----------|----------|------|
| 五行占比分析 | `/bazi/wuxing-proportion/stream` | 收集 type=complete 的内容 |
| 八字命理-喜神与忌神 | `/bazi/xishen-jishen/stream` | 收集 type=complete 的内容 |
| 八字命理-事业财富 | `/career-wealth/stream` | 收集 type=complete 的内容 |
| 八字命理-感情婚姻 | `/bazi/marriage-analysis/stream` | 收集 type=complete 的内容 |
| 八字命理-身体健康分析 | `/health/stream` | 收集 type=complete 的内容 |
| 八字命理-子女学习 | `/children-study/stream` | 收集 type=complete 的内容 |
| 八字命理-总评分析 | `/general-review/stream` | 收集 type=complete 的内容 |
| 每日运势 | `/daily-fortune-calendar/stream` | 收集 type=complete 的内容 |

#### 2.2.3 AI问答列

调用 `/smart-analyze-stream` 接口进行多轮问答：

| 输出列名 | 说明 |
|----------|------|
| 业务场景（菜单） | 随机选择：事业财富/婚姻/健康/子女/流年运势/年运报告 |
| output模型回答 | 场景1返回的简短答复（brief_response） |
| CUSMOTER_input2（第二轮问题） | 从场景1返回的预设问题列表中随机选择 |
| output2模型回答 | 场景2返回的详细回答（llm_chunk） |
| CUSMOTER_input3（第三轮问题） | 从场景2返回的相关问题中选择 |
| output3模型回答 | 场景2返回的详细回答（llm_chunk） |

---

## 3. 技术架构设计

### 3.1 架构流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                         评测系统架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────────────┐  │
│  │  Excel   │───▶│  数据解析器   │───▶│     API客户端        │  │
│  │  文件    │    │  (日期/性别)  │    │  (HTTP/SSE)         │  │
│  └──────────┘    └──────────────┘    └──────────┬───────────┘  │
│                                                  │              │
│                                                  ▼              │
│                                        ┌─────────────────┐      │
│                                        │  API服务器      │      │
│                                        │  Node1:8001    │      │
│                                        └────────┬────────┘      │
│                                                  │              │
│                                                  ▼              │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────────────┐  │
│  │  Excel   │◀───│  结果合并器   │◀───│   流式响应收集器     │  │
│  │  输出    │    │              │    │                      │  │
│  └──────────┘    └──────────────┘    └──────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 目录结构

```
scripts/evaluation/
├── __init__.py
├── bazi_evaluator.py      # 主评测脚本（入口）
├── api_client.py          # API客户端封装
├── excel_handler.py       # Excel读写处理
├── data_parser.py         # 数据解析器（日期、性别）
├── config.py              # 配置管理
└── README.md              # 使用说明
```

### 3.3 核心类设计

```python
# config.py - 配置管理
class EvaluationConfig:
    BASE_URL: str = "http://8.210.52.217:8001"
    DEFAULT_HOUR: str = "12:00"
    REQUEST_TIMEOUT: int = 60
    STREAM_TIMEOUT: int = 120
    BATCH_CONCURRENCY: int = 3

# data_parser.py - 数据解析
class DataParser:
    @staticmethod
    def parse_birth_date(text: str) -> Tuple[str, str]
        """解析 '1985 年 10 月 21 日' -> ('1985-10-21', '12:00')"""
    
    @staticmethod
    def parse_gender(text: str) -> str
        """解析 '男/女' -> 'male/female'"""

# api_client.py - API客户端
class BaziApiClient:
    def __init__(self, base_url: str)
    
    async def call_rizhu_liujiazi(self, solar_date, solar_time, gender) -> dict
        """调用日元-六十甲子接口"""
    
    async def call_stream_api(self, endpoint, params) -> str
        """调用流式接口，收集完整响应"""
    
    async def call_smart_analyze_scenario1(self, params) -> dict
        """调用智能问答场景1"""
    
    async def call_smart_analyze_scenario2(self, params) -> dict
        """调用智能问答场景2"""

# excel_handler.py - Excel处理
class ExcelHandler:
    def __init__(self, filepath: str)
    
    def read_test_cases(self) -> List[dict]
        """读取测试数据"""
    
    def write_results(self, row_idx: int, results: dict)
        """写入结果到指定行"""
    
    def save(self)
        """保存Excel文件"""

# bazi_evaluator.py - 主评测类
class BaziEvaluator:
    def __init__(self, config: EvaluationConfig)
    
    async def evaluate_single(self, test_case: dict) -> dict
        """评测单条数据"""
    
    async def evaluate_batch(self, test_cases: List[dict], progress_callback=None)
        """批量评测"""
    
    def run(self, excel_path: str, output_path: str = None)
        """运行评测"""
```

---

## 4. API调用详情

### 4.1 基础八字数据 - /bazi/rizhu-liujiazi

**请求：**
```json
{
    "solar_date": "1985-10-21",
    "solar_time": "12:00",
    "gender": "male"
}
```

**响应：**
```json
{
    "success": true,
    "data": {
        "rizhu": "癸巳",
        "analysis": "...",
        "bazi_pillars": {...},
        "ten_gods_stats": {...},
        "wangshuai": {...}
    }
}
```

### 4.2 流式分析接口格式

所有 `/stream` 接口都遵循SSE格式：

```
data: {"type": "data", "content": {...完整数据...}}

data: {"type": "progress", "content": "分析"}
data: {"type": "progress", "content": "内容"}
...

data: {"type": "complete", "content": "完整的大模型分析内容"}
```

**处理方式：**
1. 先接收 `type: "data"` 获取基础数据
2. 累积 `type: "progress"` 的内容
3. 使用 `type: "complete"` 的完整内容作为最终结果

### 4.3 智能问答接口 - /smart-analyze-stream

#### 场景1：选择业务分类

**请求：**
```
GET /smart-analyze-stream?category=健康&year=1985&month=10&day=21&hour=12&gender=male&user_id=eval_xxx
```

**响应事件流：**
```
event: brief_response_start
event: brief_response_chunk (多次)
event: brief_response_end
event: preset_questions (返回预设问题列表)
event: end
```

#### 场景2：问答

**请求：**
```
GET /smart-analyze-stream?category=健康&question=预设问题内容&user_id=eval_xxx
```

**响应事件流：**
```
event: llm_start
event: llm_chunk (多次)
event: llm_end
event: related_questions (返回相关问题列表)
event: end
```

---

## 5. 配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| BASE_URL | http://8.210.52.217:8001 | API服务地址（生产环境Node1） |
| API_PREFIX | /api/v1 | API路径前缀 |
| DEFAULT_HOUR | 12:00 | 默认出生时辰 |
| REQUEST_TIMEOUT | 60 | 普通请求超时（秒） |
| STREAM_TIMEOUT | 120 | 流式请求超时（秒） |
| BATCH_CONCURRENCY | 3 | 批量处理并发数 |

---

## 6. 性能优化

### 6.1 并行执行策略

为了提高评测效率，所有API接口采用**全部并行**执行策略：

```python
# 阶段1：并行调用所有API（10个接口同时执行）
api_results = await asyncio.gather(
    call_bazi_data(...),           # 统一数据接口
    call_rizhu_liujiazi(...),      # 日元-六十甲子
    call_wuxing_proportion_stream(...),  # 五行占比
    call_xishen_jishen_stream(...),      # 喜神忌神
    call_career_wealth_stream(...),      # 事业财富
    call_marriage_analysis_stream(...),  # 感情婚姻
    call_health_stream(...),             # 身体健康
    call_children_study_stream(...),     # 子女学习
    call_general_review_stream(...),     # 总评
    call_daily_fortune_calendar_stream(...),  # 每日运势
    return_exceptions=True
)

# 阶段2：AI问答（需要串行，因为依赖上一轮结果）
```

### 6.2 性能指标

| 指标 | 优化前 | 优化后 |
|------|-------|-------|
| 单条数据评测时间 | ~15分钟 | 3-5分钟 |
| 并行度 | 串行 | 10个接口并行 |
| API等待时间 | 累加 | 取最慢接口 |

---

## 7. 错误处理

| 错误类型 | 处理方式 |
|----------|----------|
| API调用失败 | 记录错误信息到对应单元格，继续处理下一条 |
| 日期解析失败 | 跳过该条记录，记录错误日志 |
| 流式响应中断 (TransferEncodingError) | **记录已收到的部分内容**，标记为"[传输中断]" |
| 网络超时 | 保存已收集内容，标记为"[超时]" |
| 并行任务异常 | 使用 return_exceptions=True，单个失败不影响其他接口 |

---

## 8. 使用方式

```bash
# 进入项目目录
cd /Users/zhoudt/Downloads/project/HiFate-bazi

# 单条测试（指定行号，从2开始，1是表头）
python scripts/evaluation/bazi_evaluator.py --input /Users/zhoudt/Desktop/10.xlsx --row 2

# 批量测试（所有数据）
python scripts/evaluation/bazi_evaluator.py --input /Users/zhoudt/Desktop/10.xlsx

# 显示详细进度
python scripts/evaluation/bazi_evaluator.py --input /Users/zhoudt/Desktop/10.xlsx --verbose

# 只运行指定模块（可选）
python scripts/evaluation/bazi_evaluator.py --input /Users/zhoudt/Desktop/10.xlsx --modules basic,wuxing,ai_qa
```

**命令行参数：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| --input | Excel文件路径 | 必填 |
| --row | 只处理指定行（从2开始） | 全部 |
| --verbose | 显示详细进度 | False |
| --modules | 只运行指定模块 | 全部 |

---

## 9. 输出示例

执行完成后，Excel文件将追加以下内容（示例）：

| 列名 | 示例值 |
|------|--------|
| 日元 | **癸巳** |
| 五行 | 金0 木1 水1 火3 土3 |
| 十神 | **主星: 食神(年)、正财(月)、正官(时) \| 副星: ...** |
| 喜忌 | 喜：水、金；忌：木、火、土 |
| 旺衰 | **日主极弱 \| 喜神：水、金 \| 忌神：木、火、土 \| 五行得分：金:0, 木:10, ...** |
| 格局 | 日贵格、化气格、天乙贵人格 |
| 大运流年 | **丁巳(偏财) [1-5岁] 流年:1985:乙丑(食神), 1986:丙寅(正财)...<br>乙酉(食神) [5-14岁] 流年:1990:庚午(正印)...<br>...（共8步大运）** |
| 日元-六十甲子 | 癸巳日: 【基础信息】您的日柱：癸巳... |
| 五行占比分析 | 根据您的八字分析，火土较旺... |
| 八字命理-喜神与忌神 | 您的命局喜用水金... |
| 八字命理-事业财富 | 事业方面，官杀旺相... |
| ... | ... |
| 业务场景（菜单） | 健康 |
| output模型回答 | 健康方面，您的命局... |
| CUSMOTER_input2 | 我今年的健康运势如何？ |
| output2模型回答 | 根据您的八字和流年... |
| CUSMOTER_input3 | 有什么养生建议吗？ |
| output3模型回答 | 建议您注意... |

---

## 10. 注意事项

1. **只做查询**：本功能仅调用查询接口，不修改任何现有数据
2. **不影响现有功能**：作为独立模块，不改动现有代码
3. **代码规范**：遵循项目开发规范，层次化设计
4. **网络依赖**：需要能访问生产环境 Node1 (8.210.52.217:8001)
5. **Excel格式**：直接修改原Excel文件，追加输出列

---

## 11. 开发任务清单

- [x] 创建 `scripts/evaluation/` 目录结构
- [x] 实现 `config.py` - 配置管理
- [x] 实现 `data_parser.py` - 日期/性别解析器
- [x] 实现 `excel_handler.py` - Excel读写处理
- [x] 实现 `api_client.py` - API客户端封装（含流式响应处理）
- [x] 实现 `bazi_evaluator.py` - 主评测逻辑（批量处理、进度显示）
- [x] 编写 `README.md` - 使用说明
- [x] 运行测试验证评测功能

### v2.0 优化清单（2026-01-06）

- [x] 修改数据提取格式（日柱完整、十神主副星、旺衰详细、大运8步+流年）
- [x] 实现并行执行（asyncio.gather，10个接口同时调用）
- [x] 调整统一接口请求参数（8步大运+完整流年）
- [x] 更新需求文档

---

## 附录：Excel列映射

| Excel列索引 | 列名 | 类型 |
|-------------|------|------|
| 0 | USER_ID | 输入 |
| 1 | 用户名 | 输入 |
| 2 | USER_birth（生辰八字） | 输入 |
| 3 | 性别（男/女） | 输入 |
| 4 | 日元 | 输出 |
| 5 | 五行 | 输出 |
| 6 | 十神 | 输出 |
| 7 | 喜忌 | 输出 |
| 8 | 旺衰 | 输出 |
| 9 | 格局 | 输出 |
| 10 | 大运流年 | 输出 |
| 11-14 | 豆包/千问列 | 跳过 |
| 15 | 日元-六十甲子 | 输出 |
| 16 | 五行占比分析 | 输出 |
| 17 | 喜神与忌神 | 输出 |
| 18 | 事业财富 | 输出 |
| 19 | 感情婚姻 | 输出 |
| 20 | 身体健康 | 输出 |
| 21 | 子女学习 | 输出 |
| 22 | 总评 | 输出 |
| 23 | 每日运势 | 输出 |
| 24-25 | 年运/大运 | 输出（如需要） |
| 26 | 业务场景（菜单） | 输出 |
| 27 | output模型回答 | 输出 |
| 28 | CUSMOTER_input2 | 输出 |
| 29 | output2模型回答 | 输出 |
| 30 | CUSMOTER_input3 | 输出 |
| 31 | output3模型回答 | 输出 |

