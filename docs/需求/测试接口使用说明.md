# 测试接口使用说明

## 测试接口

### 1. 测试接口（方案2专用）

**接口路径**：`POST /api/v1/children-study/test`

**功能**：返回格式化后的 JSON 数据，可以直接用于 Coze Bot 的 `{{input}}` 占位符

**请求示例**：

```bash
curl -X POST "http://localhost:8001/api/v1/children-study/test" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1987-09-16",
    "solar_time": "05:00",
    "gender": "male",
    "calendar_type": "solar"
  }'
```

**响应示例**：

```json
{
  "success": true,
  "formatted_data": "{\n  \"mingpan_zinv_zonglun\": {...},\n  \"zinvxing_zinvgong\": {...},\n  ...\n}",
  "formatted_data_length": 12345,
  "data_summary": {
    "bazi_pillars": {...},
    "zinv_xing_type": "男命子女星：正官（官杀）",
    "dayun_count": 13,
    "current_dayun_liunians_count": 3,
    "key_dayuns_count": 9,
    "xi_ji": {...}
  },
  "usage": {
    "description": "此接口返回的数据可以直接用于 Coze Bot 的 {{input}} 占位符",
    "coze_bot_setup": "...",
    "test_command": "..."
  }
}
```

**响应字段说明**：

- `formatted_data`: 格式化后的 JSON 字符串，可以直接用于 Coze Bot 的 `{{input}}` 占位符
- `formatted_data_length`: 格式化数据的长度（字符数）
- `data_summary`: 数据摘要，用于快速验证数据完整性
- `usage`: 使用说明

---

### 2. 调试接口（完整数据）

**接口路径**：`POST /api/v1/children-study/debug`

**功能**：返回完整的调试信息，包括原始数据、格式化数据、自然语言 Prompt 等

**请求示例**：

```bash
curl -X POST "http://localhost:8001/api/v1/children-study/debug" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1987-09-16",
    "solar_time": "05:00",
    "gender": "male",
    "calendar_type": "solar"
  }'
```

**响应字段说明**：

- `input_data`: 原始结构化数据（方案1使用）
- `formatted_data`: 格式化后的 JSON 数据（方案2使用）
- `prompt`: 自然语言格式的 Prompt（方案1使用）
- `data_summary`: 数据摘要

---

## 测试步骤

### 步骤1：测试数据格式化

```bash
# 调用测试接口，获取格式化后的数据
curl -X POST "http://localhost:8001/api/v1/children-study/test" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1987-09-16",
    "solar_time": "05:00",
    "gender": "male",
    "calendar_type": "solar"
  }' | python3 -m json.tool > /tmp/test_output.json
```

### 步骤2：验证数据完整性

```bash
# 检查格式化数据
cat /tmp/test_output.json | python3 << 'EOF'
import sys, json
data = json.load(sys.stdin)
formatted_data = json.loads(data['formatted_data'])

print("数据完整性检查:")
print(f"✅ 命盘子女总论: {bool(formatted_data.get('mingpan_zinv_zonglun'))}")
print(f"✅ 子女星与子女宫: {bool(formatted_data.get('zinvxing_zinvgong'))}")
print(f"✅ 生育时机: {bool(formatted_data.get('shengyu_shiji'))}")
print(f"✅ 养育建议: {bool(formatted_data.get('yangyu_jianyi'))}")

mingpan = formatted_data.get('mingpan_zinv_zonglun', {})
print(f"\n旺衰数据: {mingpan.get('wangshuai', '缺失')}")

zinvxing = formatted_data.get('zinvxing_zinvgong', {})
print(f"十神数据: {bool(zinvxing.get('ten_gods'))}")
print(f"子女星类型: {zinvxing.get('zinv_xing_type', '缺失')}")

shengyu = formatted_data.get('shengyu_shiji', {})
print(f"当前大运流年数量: {len(shengyu.get('current_dayun', {}).get('liunians', []))}")
print(f"关键大运数量: {len(shengyu.get('key_dayuns', []))}")
EOF
```

### 步骤3：验证 Token 节省

```bash
# 对比方案1和方案2的数据长度
curl -s -X POST "http://localhost:8001/api/v1/children-study/debug" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1987-09-16",
    "solar_time": "05:00",
    "gender": "male",
    "calendar_type": "solar"
  }' | python3 << 'EOF'
import sys, json
data = json.load(sys.stdin)

prompt_length = data.get('prompt_length', 0)
formatted_length = data.get('formatted_data_length', 0)

print(f"方案1（自然语言 Prompt）长度: {prompt_length} 字符")
print(f"方案2（格式化 JSON）长度: {formatted_length} 字符")
print(f"节省: {prompt_length - formatted_length} 字符 ({((prompt_length - formatted_length) / prompt_length * 100) if prompt_length > 0 else 0:.1f}%)")
EOF
```

---

## 验证数据格式

格式化后的数据应该符合以下结构：

```json
{
  "mingpan_zinv_zonglun": {
    "day_master": {...},
    "bazi_pillars": {...},
    "elements": {...},
    "wangshuai": "极弱",
    "gender": "male"
  },
  "zinvxing_zinvgong": {
    "zinv_xing_type": "男命子女星：正官（官杀）",
    "hour_pillar": {...},
    "ten_gods": {...},
    "deities": {...}
  },
  "shengyu_shiji": {
    "zinv_xing_type": "男命子女星：正官（官杀）",
    "current_dayun": {...},
    "key_dayuns": [...],
    "all_dayuns": [...],
    "ten_gods": {...}  // ⚠️ 直接引用，不重复存储
  },
  "yangyu_jianyi": {
    "ten_gods": {...},  // ⚠️ 直接引用，不重复存储
    "wangshuai": "极弱",  // ⚠️ 直接引用，不重复存储
    "xi_ji": {...}
  },
  "children_rules": {
    "matched_rules": [...],
    "rules_count": 5,
    "rule_judgments": [...]
  }
}
```

---

## 注意事项

1. **数据完整性**：确保所有必需字段都有值，无缺失
2. **引用正确性**：`shengyu_shiji.ten_gods` 和 `yangyu_jianyi.ten_gods` 应该引用 `zinvxing_zinvgong.ten_gods`
3. **数据长度**：格式化后的数据应该比自然语言 Prompt 短（节省 Token）
4. **JSON 格式**：格式化后的数据必须是有效的 JSON 格式

---

## 常见问题

### Q1: 格式化数据为空？

**A**: 检查数据提取是否成功，确保 `input_data` 有值。

### Q2: 数据字段缺失？

**A**: 检查数据完整性验证是否通过，查看 `data_summary` 字段。

### Q3: Token 没有节省？

**A**: 检查数据是否使用了引用，避免重复存储。查看 `formatted_data` 中是否有重复的 `ten_gods` 和 `wangshuai` 数据。

