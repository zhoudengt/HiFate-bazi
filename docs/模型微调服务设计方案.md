# 模型微调服务设计方案

## 📋 方案概述

### 核心目标
1. **记录用户问题**：自动记录智能运势分析模块的所有用户问题
2. **增量微调模型**：基于积累的问题数据，定期微调意图分类模型
3. **扩展规则库**：自动提取高频关键词，扩展意图识别规则库
4. **持续优化**：形成"数据收集 → 标注 → 训练 → 部署"的闭环

### 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    用户问题收集层                                │
├─────────────────────────────────────────────────────────────────┤
│ 智能运势分析API → 记录问题 → intent_user_questions表            │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    问题标注层（人工/半自动）                      │
├─────────────────────────────────────────────────────────────────┤
│ 获取未标注问题 → 人工标注 → 更新correct_intent                  │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    模型训练层                                    │
├─────────────────────────────────────────────────────────────────┤
│ 创建训练批次 → 准备数据 → 增量微调 → 保存模型版本                │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    规则扩展层                                    │
├─────────────────────────────────────────────────────────────────┤
│ 提取高频关键词 → 生成规则 → 保存到intent_keyword_rules表         │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    模型部署层                                    │
├─────────────────────────────────────────────────────────────────┤
│ 激活模型版本 → 更新意图识别服务 → 零停机切换                    │
└─────────────────────────────────────────────────────────────────┘
```

## 🗄️ 数据库设计

### 1. intent_user_questions（用户问题记录表）

**核心表**，记录所有用户问题及意图识别结果。

**关键字段**：
- `question`: 用户问题（原始文本）
- `intents`: 识别到的意图（JSON数组）
- `confidence`: 置信度
- `method`: 识别方法（local_model/keyword_fallback/llm_fallback）
- `is_labeled`: 是否已标注
- `correct_intent`: 正确意图（人工标注）
- `training_status`: 训练状态（pending/used/skipped）

**用途**：
- 训练数据源
- 问题统计分析
- 模型效果评估

### 2. intent_keyword_rules（关键词规则扩展表）

**规则扩展表**，基于用户问题自动提取的关键词规则。

**关键字段**：
- `keyword`: 关键词
- `intent`: 意图类型
- `confidence_boost`: 置信度加成
- `usage_count`: 使用次数
- `success_count`: 成功次数

**用途**：
- 自动扩展关键词规则库
- 提升意图识别准确率
- 减少LLM调用

### 3. intent_model_training_batches（训练批次表）

**训练管理表**，记录每次训练批次的信息。

**关键字段**：
- `batch_id`: 批次编号
- `model_version`: 模型版本
- `training_status`: 训练状态
- `question_count`: 问题数量
- `model_path`: 模型保存路径

**用途**：
- 训练批次管理
- 训练历史追踪
- 模型版本关联

### 4. intent_model_versions（模型版本管理表）

**版本管理表**，管理所有模型版本。

**关键字段**：
- `version`: 版本号
- `model_path`: 模型路径
- `is_active`: 是否激活
- `training_batch_id`: 训练批次ID

**用途**：
- 模型版本管理
- 快速回滚
- 版本对比

## 🔄 工作流程

### 阶段1：问题收集（自动）

**触发时机**：每次智能运势分析API调用

**流程**：
1. 用户调用智能运势分析API
2. 意图识别完成后，自动记录问题
3. 保存到`intent_user_questions`表

**代码位置**：
- `server/api/v1/smart_fortune.py` - 已集成问题记录
- `server/services/intent_question_logger.py` - 问题记录服务

### 阶段2：问题标注（人工/半自动）

**触发时机**：定期（如每周一次）

**流程**：
1. 调用API获取未标注问题（按置信度排序，优先标注低置信度问题）
2. 人工标注正确意图和时间意图
3. 更新`is_labeled`和`correct_intent`字段

**API接口**：
- `GET /api/v1/model-tuning/questions/unlabeled` - 获取未标注问题
- `POST /api/v1/model-tuning/questions/{question_id}/label` - 更新标注

### 阶段3：模型训练（增量微调）

**触发时机**：当标注问题达到一定数量（如100条）

**流程**：
1. 创建训练批次
2. 准备训练数据（从数据库获取已标注问题）
3. 增量微调BERT模型
4. 保存模型版本
5. 更新问题训练状态

**API接口**：
- `POST /api/v1/model-tuning/batches` - 创建训练批次
- `POST /api/v1/model-tuning/batches/{batch_id}/run` - 执行训练

### 阶段4：规则扩展（自动）

**触发时机**：训练完成后自动执行（可选）

**流程**：
1. 从用户问题中提取高频关键词
2. 统计关键词-意图对的出现频率
3. 生成关键词规则（频率>=阈值）
4. 保存到`intent_keyword_rules`表

**API接口**：
- `POST /api/v1/model-tuning/keywords/extract` - 提取关键词规则

### 阶段5：模型部署（零停机）

**触发时机**：训练完成后，验证通过

**流程**：
1. 激活新模型版本
2. 更新意图识别服务配置
3. 热加载新模型（零停机）
4. 监控模型效果

**API接口**：
- `POST /api/v1/model-tuning/models/{version}/activate` - 激活模型版本

## 🎯 方案优势

### 1. 数据驱动
- **自动收集**：所有用户问题自动记录，无需人工干预
- **持续积累**：问题数据持续积累，训练数据越来越多
- **真实场景**：基于真实用户问题，模型更贴近实际需求

### 2. 增量优化
- **增量微调**：基于新数据增量微调，不需要从头训练
- **快速迭代**：可以频繁训练和部署，快速优化模型
- **版本管理**：支持多版本管理，可以快速回滚

### 3. 规则扩展
- **自动提取**：自动从问题中提取高频关键词
- **智能扩展**：基于使用频率和成功率扩展规则
- **持续优化**：规则库持续扩展，准确率不断提升

### 4. 零停机部署
- **热加载**：支持模型热加载，无需重启服务
- **平滑切换**：新旧模型平滑切换，不影响用户体验
- **快速回滚**：如果新模型有问题，可以快速回滚

## 📊 预期效果

### 短期（1-2周）
- ✅ 问题数据开始积累
- ✅ 可以手动标注问题
- ✅ 可以执行首次训练

### 中期（1-2月）
- ✅ 积累1000+条问题数据
- ✅ 完成首次模型微调
- ✅ 关键词规则库扩展50+条
- ✅ 意图识别准确率提升5-10%

### 长期（3-6月）
- ✅ 积累10000+条问题数据
- ✅ 完成多次增量微调
- ✅ 关键词规则库扩展200+条
- ✅ 意图识别准确率提升15-20%
- ✅ LLM调用率从5%降至2%以下

## 🔧 技术实现

### 1. 问题记录服务
- **文件**: `server/services/intent_question_logger.py`
- **功能**: 记录用户问题及意图识别结果
- **集成**: 已在`smart_fortune.py`中集成

### 2. 模型训练器
- **文件**: `services/model_tuning_service/trainer.py`
- **功能**: 增量微调BERT模型
- **技术**: transformers + PyTorch

### 3. 关键词提取器
- **文件**: `services/model_tuning_service/keyword_extractor.py`
- **功能**: 从问题中提取高频关键词
- **算法**: 频率统计 + 成功率评估

### 4. 微调服务
- **文件**: `services/model_tuning_service/service.py`
- **功能**: 整合训练和规则扩展功能
- **API**: REST API接口

## ⚠️ 注意事项

### 1. 数据隐私
- **脱敏处理**：记录问题时，敏感信息需要脱敏
- **用户同意**：确保用户同意数据用于训练
- **数据安全**：数据库访问权限控制

### 2. 训练成本
- **计算资源**：模型训练需要GPU资源（可选，CPU也可）
- **训练时间**：100条数据约需5-10分钟（CPU）
- **存储空间**：每个模型版本约500MB

### 3. 模型质量
- **数据质量**：标注质量直接影响模型效果
- **数据平衡**：确保各类意图的数据量相对平衡
- **验证集**：需要保留验证集，评估模型效果

### 4. 部署风险
- **A/B测试**：新模型部署前建议A/B测试
- **监控指标**：部署后监控准确率、响应时间等指标
- **快速回滚**：准备快速回滚方案

## 🚀 使用指南

### 1. 初始化数据库表

```bash
mysql -h localhost -u root -p hifate_bazi < server/db/migrations/create_intent_training_tables.sql
```

### 2. 查看统计信息

```bash
curl http://localhost:8001/api/v1/model-tuning/stats
```

### 3. 获取未标注问题

```bash
curl http://localhost:8001/api/v1/model-tuning/questions/unlabeled?limit=100
```

### 4. 标注问题

```bash
curl -X POST http://localhost:8001/api/v1/model-tuning/questions/1/label \
  -H "Content-Type: application/json" \
  -d '{
    "correct_intent": ["wealth"],
    "correct_time_intent": {"type": "this_year", "target_years": [2025]},
    "labeler_id": "admin"
  }'
```

### 5. 创建并执行训练批次

```bash
# 创建批次
curl -X POST http://localhost:8001/api/v1/model-tuning/batches \
  -H "Content-Type: application/json" \
  -d '{"description": "首次训练"}'

# 执行训练（使用返回的batch_id）
curl -X POST http://localhost:8001/api/v1/model-tuning/batches/{batch_id}/run \
  -H "Content-Type: application/json" \
  -d '{"auto_extract_keywords": true}'
```

### 6. 提取关键词规则

```bash
curl -X POST http://localhost:8001/api/v1/model-tuning/keywords/extract?min_confidence=0.8&limit=1000
```

## 📈 监控指标

### 数据质量指标
- 总问题数
- 已标注数 / 未标注数
- 标注率
- 各类意图的数据分布

### 训练效果指标
- 训练批次数量
- 训练成功率
- 模型准确率
- 训练耗时

### 规则扩展指标
- 关键词规则总数
- 规则使用频率
- 规则成功率

### 模型效果指标
- 意图识别准确率
- LLM调用率
- 平均响应时间

## 🎉 总结

这个方案**非常靠谱**，具有以下优势：

1. ✅ **数据驱动**：基于真实用户问题，持续优化
2. ✅ **增量优化**：支持增量微调，快速迭代
3. ✅ **规则扩展**：自动提取关键词，扩展规则库
4. ✅ **零停机**：支持热加载，平滑切换
5. ✅ **完整闭环**：从数据收集到模型部署的完整流程

**建议**：
- 立即启用问题记录功能（已实现）
- 每周定期标注问题（建议50-100条）
- 当标注问题达到100条时，执行首次训练
- 持续监控模型效果，不断优化

