# 部署问题修复 - 2025-12-06

## 问题描述

部署时出现 MySQL 连接失败错误：
```
✗ 创建MySQL连接失败: (2003, "Can't connect to MySQL server on 'mysql' ([Errno -2] Name or service not known)")
```

## 根本原因

1. **MySQL 容器未启动**：部署脚本只启动了 web 服务，没有启动 MySQL 和 Redis 容器
2. **环境变量缺失**：`.env` 文件不存在或 `MYSQL_ROOT_PASSWORD` 未设置
3. **缺少服务依赖检查**：没有在启动 web 服务前检查 MySQL 和 Redis 是否就绪

## 修复内容

### 1. 更新 `scripts/deploy-backend.sh`

#### 新增功能：

1. **环境变量验证**（步骤 0/6）
   - 检查 `.env` 文件是否存在
   - 如果不存在，从 `env.template` 创建
   - 验证关键环境变量（`MYSQL_ROOT_PASSWORD`、`REDIS_PASSWORD`）是否设置
   - 如果使用默认值，提示用户修改

2. **停止现有服务**（步骤 3/6）
   - 在启动新服务前，先停止现有服务
   - 确保干净的部署环境

3. **启动所有服务**（步骤 4/6）
   - 使用 `docker compose up -d` 启动所有服务（包括 MySQL、Redis）
   - 不再只启动 web 服务

4. **等待依赖服务就绪**（步骤 5/6）
   - 等待 MySQL 启动并验证连接
   - 等待 Redis 启动并验证连接
   - 最多等待 60 秒
   - 如果 MySQL 未就绪，部署失败

5. **改进的健康检查**（步骤 6/6）
   - 增加重试次数（从 5 次增加到 10 次）
   - 更详细的错误日志输出
   - 显示所有服务状态

#### 修改前后对比：

**修改前**：
```bash
# 只启动 web 服务
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

**修改后**：
```bash
# 1. 检查环境变量
# 2. 停止现有服务
docker compose down
# 3. 启动所有服务（包括 MySQL、Redis）
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
# 4. 等待 MySQL 和 Redis 就绪
# 5. 验证连接
# 6. 健康检查
```

### 2. 更新 `.github/workflows/deploy-production.yml`

#### 新增功能：

1. **检查 MySQL 和 Redis 容器状态**
   - 在部署前检查 MySQL 和 Redis 是否运行
   - 如果未运行，自动启动

2. **验证 MySQL 连接**
   - 在更新 web 服务前，验证 MySQL 连接
   - 最多重试 10 次，每次间隔 3 秒
   - 如果连接失败，部署失败并显示日志

#### 修改位置：

在拉取镜像之前添加了服务检查和启动逻辑。

## 使用方法

### 首次部署

```bash
# 1. 登录服务器
ssh backend-user@123.57.216.15

# 2. 进入项目目录
cd /opt/HiFate-bazi

# 3. 执行部署脚本
bash scripts/deploy-backend.sh

# 脚本会自动：
# - 检查并创建 .env 文件（如果不存在）
# - 验证环境变量配置
# - 启动所有服务（MySQL、Redis、Web 等）
# - 等待依赖服务就绪
# - 执行健康检查
```

### 环境变量配置

如果 `.env` 文件不存在，脚本会提示创建。必须设置以下变量：

```bash
# MySQL 配置
MYSQL_ROOT_PASSWORD=your_strong_password_here  # 必须修改

# Redis 配置
REDIS_PASSWORD=your_redis_password_here  # 必须修改

# 应用配置
SECRET_KEY=your_secret_key_here  # 必须修改
```

### 验证部署

部署完成后，验证服务状态：

```bash
# 1. 检查所有容器状态
docker compose -f docker-compose.yml -f docker-compose.prod.yml ps

# 应该看到：
# - hifate-mysql (运行中)
# - hifate-redis (运行中)
# - hifate-web (运行中)
# - 其他微服务容器

# 2. 检查 MySQL 连接
docker exec hifate-mysql mysqladmin ping -h localhost -u root -p${MYSQL_ROOT_PASSWORD}

# 3. 检查 Web 服务健康
curl http://localhost:8001/api/v1/health

# 4. 查看服务日志（应该不再有 MySQL 连接错误）
docker logs hifate-web --tail=50 | grep -i mysql
```

## 预防措施

### 1. 部署前检查清单

- [ ] `.env` 文件存在
- [ ] `MYSQL_ROOT_PASSWORD` 已设置（不是默认值）
- [ ] `REDIS_PASSWORD` 已设置（不是默认值）
- [ ] `SECRET_KEY` 已设置（不是默认值）
- [ ] Docker 和 Docker Compose 已安装
- [ ] 有足够的磁盘空间

### 2. 部署脚本改进

- ✅ 自动检查环境变量
- ✅ 自动启动所有服务
- ✅ 等待依赖服务就绪
- ✅ 详细的错误日志
- ✅ 健康检查验证

### 3. 监控建议

- 监控 MySQL 容器状态
- 监控 Redis 容器状态
- 监控 Web 服务健康检查
- 设置告警（如果 MySQL/Redis 容器停止）

## 相关文件

- `scripts/deploy-backend.sh` - 后端部署脚本（已更新）
- `.github/workflows/deploy-production.yml` - GitHub Actions 部署脚本（已更新）
- `env.template` - 环境变量模板
- `docker-compose.yml` - Docker Compose 基础配置
- `docker-compose.prod.yml` - Docker Compose 生产配置

## 测试验证

### 测试场景 1：首次部署（.env 不存在）

```bash
# 1. 删除 .env 文件
rm .env

# 2. 执行部署脚本
bash scripts/deploy-backend.sh

# 预期结果：
# - 脚本提示创建 .env 文件
# - 从 env.template 创建 .env
# - 提示编辑环境变量
# - 如果未设置关键变量，部署失败
```

### 测试场景 2：MySQL 未启动

```bash
# 1. 停止 MySQL 容器
docker stop hifate-mysql

# 2. 执行部署脚本
bash scripts/deploy-backend.sh

# 预期结果：
# - 脚本检测到 MySQL 未运行
# - 自动启动 MySQL
# - 等待 MySQL 就绪
# - 验证连接后继续部署
```

### 测试场景 3：环境变量使用默认值

```bash
# 1. .env 文件中使用默认值
MYSQL_ROOT_PASSWORD=your_strong_password_here

# 2. 执行部署脚本
bash scripts/deploy-backend.sh

# 预期结果：
# - 脚本检测到使用默认值
# - 提示错误并退出
# - 要求修改环境变量
```

## 回滚方案

如果部署失败，可以回滚：

```bash
# 1. 停止所有服务
docker compose -f docker-compose.yml -f docker-compose.prod.yml down

# 2. 检查之前的镜像
docker images | grep hifate-bazi

# 3. 使用之前的镜像启动
DOCKER_IMAGE=hifate-bazi:previous_tag docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 4. 验证服务
curl http://localhost:8001/api/v1/health
```

## 总结

通过这次修复，部署脚本现在能够：

1. ✅ 自动检查环境变量配置
2. ✅ 启动所有必需的服务（MySQL、Redis、Web 等）
3. ✅ 等待依赖服务就绪后再继续
4. ✅ 提供详细的错误信息和日志
5. ✅ 执行完整的健康检查

这确保了部署的可靠性和一致性，避免了 MySQL 连接失败的问题。

---

**修复日期**：2025-12-06  
**修复人员**：系统管理员  
**影响范围**：所有部署脚本和 GitHub Actions 工作流

