# 二进制打包部署指南

## 📦 什么是二进制打包？

将 Python 项目打包成独立的可执行文件，无需在服务器上安装 Python 和依赖包，直接运行。

## 🎯 适用场景

- ✅ **测试服务器快速部署**：无需配置 Python 环境
- ✅ **简化部署流程**：一个文件搞定
- ✅ **环境隔离**：不依赖系统 Python 版本

## ⚠️ 限制

- ❌ **文件体积大**：包含所有依赖，通常 100MB+
- ❌ **跨平台限制**：Linux 打包的只能在 Linux 运行
- ❌ **启动稍慢**：首次启动需要解压
- ❌ **调试困难**：错误信息可能不够详细

## 🚀 快速开始

### 方法一：使用打包脚本（推荐）

```bash
# 1. 进入项目目录
cd /Users/zhoudt/Downloads/project/HiFate-bazi

# 2. 确保虚拟环境已激活
source .venv/bin/activate

# 3. 执行打包脚本
chmod +x scripts/build_binary.sh
./scripts/build_binary.sh
```

### 方法二：手动打包

```bash
# 1. 安装 PyInstaller
pip install pyinstaller

# 2. 打包主服务
pyinstaller --onefile \
    --name hifate-bazi \
    --add-data "frontend:frontend" \
    --add-data "config:config" \
    --add-data "data:data" \
    --hidden-import uvicorn \
    --hidden-import fastapi \
    --hidden-import grpc \
    server/start.py
```

## 📋 打包后的文件结构

```
dist/binary/
├── hifate-bazi          # 主可执行文件（Linux）
├── frontend/            # 前端文件
├── config/              # 配置文件
└── data/                # 数据文件
```

## 🖥️ 服务器部署

### 步骤 1：上传文件

```bash
# 在本地打包后，上传到服务器
scp -r dist/binary/* user@server:/opt/hifate-bazi/
```

### 步骤 2：配置环境

```bash
# SSH 连接到服务器
ssh user@server

# 进入部署目录
cd /opt/hifate-bazi

# 配置环境变量（创建 config/services.env）
vim config/services.env
```

### 步骤 3：运行

```bash
# 添加执行权限
chmod +x hifate-bazi

# 运行（前台）
./hifate-bazi

# 或后台运行
nohup ./hifate-bazi > logs/app.log 2>&1 &
```

## 🔧 高级配置

### 自定义打包选项

编辑 `scripts/build_binary.sh` 中的 `hifate_bazi.spec` 配置：

```python
# 添加更多隐藏导入
hiddenimports=[
    'your_module',
    'another_module',
],

# 添加更多数据文件
datas=[
    ('path/to/data', 'data'),
],
```

### 减小文件体积

```bash
# 使用 UPX 压缩（需要安装 UPX）
pyinstaller --upx-dir=/path/to/upx hifate_bazi.spec
```

### 排除不需要的模块

```python
# 在 .spec 文件中
excludes=[
    'matplotlib',
    'pandas',
    'jupyter',
],
```

## 🐛 常见问题

### 问题 1：打包后无法运行

**原因**：缺少系统库或依赖

**解决**：
```bash
# 在服务器上安装必要的系统库
sudo apt-get install libc6 libssl1.1
```

### 问题 2：找不到配置文件

**原因**：打包时未包含配置文件

**解决**：
- 检查 `datas` 配置是否包含 `config` 目录
- 或手动复制配置文件到服务器

### 问题 3：导入错误

**原因**：某些模块未在 `hiddenimports` 中声明

**解决**：
```bash
# 查看详细错误
./hifate-bazi --debug

# 添加缺失的模块到 hiddenimports
```

## 📊 对比：二进制 vs Docker

| 特性 | 二进制打包 | Docker |
|------|-----------|--------|
| **部署速度** | ⭐⭐⭐ 快 | ⭐⭐ 中等 |
| **文件大小** | ⭐⭐ 大（100MB+） | ⭐⭐⭐ 小（镜像层共享） |
| **环境隔离** | ⭐⭐ 部分隔离 | ⭐⭐⭐ 完全隔离 |
| **跨平台** | ⭐ 需要重新打包 | ⭐⭐⭐ 跨平台 |
| **调试难度** | ⭐⭐ 较难 | ⭐⭐⭐ 容易 |
| **适用场景** | 测试/简单部署 | 生产环境 |

## 💡 推荐方案

### 测试服务器
- ✅ **二进制打包**：快速部署，无需配置环境
- ✅ **Docker**：如果需要完整环境隔离

### 生产环境
- ✅ **Docker**：推荐，更好的隔离和可维护性
- ❌ **二进制打包**：不推荐，调试和维护困难

## 🔗 相关文档

- [Docker 部署指南](./Docker远程部署指南.md)
- [快速开始指南](./quick_start.md)
- [服务管理指南](./service-operations.md)

