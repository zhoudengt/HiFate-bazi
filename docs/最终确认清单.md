# 最终确认清单 - 2025.11.20算法公式规则开发

## 📊 规则数据概览

**文件**: `docs/2025.11.20算法公式.xlsx`  
**总规则数**: **808条** ✅ 全部有结果数据

| 工作表 | 规则数 | 状态 | 筛选条件1 |
|-------|-------|------|----------|
| 财富 | 97条 | ✅ 完整 | 十神 |
| 婚配 | 60条 | ✅ 完整 | 日柱 |
| 性格 | 60条 | ✅ 完整 | 日柱 |
| 总评 | 533条 | ✅ 完整 | 年柱 |
| 身体 | 58条 | ✅ 完整 | 地支/日干/日支/五行/天干地支 |

---

## ✅ 已确认的配置

### 1. 五行统计规则 ✓

**您的确认**: `element_counts['火'] <= 1`

**应用场景**: 身体规则（5条）
- "对应五行属性火低于1个（包含1个）" → `element_counts['火'] <= 1`
- "对应五行属性木低于1个（包含1个）" → `element_counts['木'] <= 1`
- "对应五行属性金低于1个（包含1个）" → `element_counts['金'] <= 1`
- "对应五行属性土低于1个（包含1个）" → `element_counts['土'] <= 1`
- "对应五行属性水低于1个（包含1个）" → `element_counts['水'] <= 1`

---

### 2. 季节定义 ✓

**您的确认**: 按照农历节气

**季节定义** (基于节气):
- **春季**: 立春（2月4日左右）→ 立夏（5月5日左右）
- **夏季**: 立夏（5月5日左右）→ 立秋（8月7日左右）
- **秋季**: 立秋（8月7日左右）→ 立冬（11月7日左右）
- **冬季**: 立冬（11月7日左右）→ 立春（2月4日左右）

**应用场景**: 总评规则（533条）
- "甲子，且出生于春季，并且出生于卯时到申时"

**实现方式**:
```python
def get_season_by_jieqi(solar_date):
    month = solar_date.month
    day = solar_date.day
    
    if (month == 2 and day >= 4) or month in [3, 4] or (month == 5 and day < 5):
        return "春季"
    elif (month == 5 and day >= 5) or month in [6, 7] or (month == 8 and day < 7):
        return "夏季"
    elif (month == 8 and day >= 7) or month in [9, 10] or (month == 11 and day < 7):
        return "秋季"
    else:
        return "冬季"
```

---

### 3. 旺衰判断 ✓

**您的确认**: 基于昨天的接口（`/api/v1/bazi/wangshuai`）

**API端点**: `POST /api/v1/bazi/wangshuai`

**返回字段**: `data.wangshuai`

**可能值** (已验证):
- `极旺` (总分 > 40)
- `身旺` (10 <= 总分 <= 40)
- `身弱` (-40 <= 总分 <= -10)
- `极弱` (总分 < -40)

**应用场景**: 财富规则（6条）
- "年柱主星是正财，且年柱副星有正官，并且还是身旺或极旺"
- "月柱主星是正财，月柱副星有食神或伤官，并且还是身旺命或极旺"

**实现方式**:
```python
def check_wangshuai_condition(bazi_data, condition):
    # 调用旺衰API
    ws_result = call_wangshuai_api(bazi_data)
    ws_status = ws_result['data']['wangshuai']
    
    if condition == "身旺或极旺":
        return ws_status in ['身旺', '极旺']
    elif condition == "身弱或极弱":
        return ws_status in ['身弱', '极弱']
    else:
        return ws_status == condition
```

---

## ❓ 需要最终确认的问题

### Q1. 十神匹配规则（财富规则核心）

从新Excel看到，**规则已经明确指定了柱位**！

**示例**:
- ✅ "**年柱**主星是正财" → `details['year']['main_star'] == '正财'`
- ✅ "**年柱**副星有正官" → `'正官' in details['year']['hidden_stars']`
- ✅ "**月柱**主星是正财" → `details['month']['main_star'] == '正财'`
- ✅ "**日柱**副星是正财" → `'正财' in details['day']['hidden_stars']`
- ✅ "**时柱**主星是正财" → `details['hour']['main_star'] == '正财'`

**结论**: 新Excel已经明确指定柱位，无歧义！✅

---

### Q2. 特殊术语定义（需要确认）

从财富规则中发现以下特殊术语，需要您确认判断方式：

#### Q2.1 "禄"临官 （出现1次：ID=20006）

条件: `月柱主星是正财，月柱副星有食神或伤官，并且还是"禄"临官`

**请问**:
- A. 检查时柱地支是否为日干的"禄"（如甲禄在寅）
- B. 检查四柱中是否有十二长生的"临官"位
- C. 其他判断方式（请说明）

```
您的答案: ____________________
```

---

#### Q2.2 长生和库 （出现1次：ID=20009）

条件: `日柱副星有正财，并且日柱有长生和库`

**请问**:
- A. 检查日支是否为日干的"长生"位，且属于四库（辰戌丑未）
- B. 检查日支是否同时具有"长生"和"库"的属性
- C. 其他判断方式（请说明）

**举例**: 
- 甲木长生在亥，库在未 
- 如果日柱是"甲未"，是否满足"长生和库"？

```
您的答案: ____________________
```

---

#### Q2.3 不受刑冲 （出现2次：ID=20010, ID=20026）

条件: `时柱主星是正财，且不受刑冲`

**请问**:
- A. 检查`relationships['branch_relations']['chong']` 和 `['xing']` 中是否包含时柱
- B. 只检查时柱地支是否与其他柱地支相冲或相刑
- C. 其他判断方式（请说明）

```
您的答案: ____________________
```

---

### Q3. 农历月份获取（总评规则）

条件示例: `甲子，且出生于农历六月` (ID=30009)

**请问**:
- A. 当前八字数据中已包含农历月份字段（请告知字段名）
- B. 需要通过`LunarConverter`计算农历月份
- C. 农历六月是指节气中的"午月"（芒种到小暑）

```
您的答案: ____________________
```

---

### Q4. 时辰范围确认（总评规则）

条件示例: 
- `出生于卯时到申时` → 是否 = `['卯','辰','巳','午','未','申']`
- `出生于酉时到寅时` → 是否 = `['酉','戌','亥','子','丑','寅']` （跨日）

```
您的确认: 是 / 否 / 其他说明 ____________________
```

---

### Q5. 复合条件中的"或"逻辑

条件示例: `月柱副星有食神或伤官`

**请问**:
- A. 月柱副星中包含"食神"**或者**包含"伤官"（满足其一即可）
- B. 月柱副星中**同时**包含"食神"和"伤官"
- C. 其他含义

```
您的答案: A / B / C，说明: ____________________
```

---

### Q6. 日柱匹配（婚配、性格规则）

条件示例: `甲子` (婚配、性格规则各60条)

**确认**:
- 匹配方式 = `bazi_pillars['day']['stem']=='甲' and bazi_pillars['day']['branch']=='子'`

```
您的确认: 是 / 否 / 其他说明 ____________________
```

---

### Q7. 年柱匹配（总评规则）

条件示例: `甲子，且出生于春季，并且出生于卯时到申时`

**确认**:
- 年柱匹配 = `bazi_pillars['year']['stem']=='甲' and bazi_pillars['year']['branch']=='子'`

```
您的确认: 是 / 否 / 其他说明 ____________________
```

---

## 🎯 开发计划

### 阶段1: 规则引擎核心 (预计2小时)
- [x] 读取JSON规则
- [ ] 实现条件解析器
- [ ] 实现规则匹配引擎
- [ ] 单元测试

### 阶段2: Service层 (预计1.5小时)
- [ ] FormulaRuleService（规则匹配服务）
- [ ] 集成旺衰API
- [ ] 集成季节计算
- [ ] 集成地支关系判断

### 阶段3: API层 (预计0.5小时)
- [ ] POST /api/v1/bazi/formula-analysis
- [ ] 请求参数验证
- [ ] 响应格式化

### 阶段4: 前端页面 (预计1.5小时)
- [ ] formula-analysis.html
- [ ] 按类别展示匹配规则
- [ ] 支持筛选和搜索

### 阶段5: 测试验证 (预计1小时)
- [ ] 功能测试
- [ ] 边界测试
- [ ] 用户验收测试

**总预计时间**: 6-7小时

---

## 📝 快速回复模板

请直接在下方填写答案：

```
Q2.1 "禄"临官: ____________________
Q2.2 长生和库: ____________________
Q2.3 不受刑冲: ____________________
Q3 农历月份: ____________________
Q4 时辰范围: 是 / 否
Q5 "或"逻辑: A
Q6 日柱匹配: 是
Q7 年柱匹配: 是
```

---

## ✅ 准备就绪

**已确认的配置（3项）**:
- ✅ 五行统计: `element_counts['火'] <= 1`
- ✅ 季节定义: 按农历节气
- ✅ 旺衰判断: 调用 `/api/v1/bazi/wangshuai`

**待确认的问题（7个）**:
- ❓ Q2.1-Q2.3: 特殊术语定义（禄、长生库、刑冲）
- ❓ Q3: 农历月份获取方式
- ❓ Q4-Q7: 匹配规则确认

**一旦确认Q2-Q7，立即开始开发！** 🚀

---

**生成时间**: 2025-11-20  
**数据来源**: docs/2025.11.20算法公式.xlsx (808条规则)  
**状态**: ⏸️ 等待最终确认

