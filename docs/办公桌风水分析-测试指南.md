# 办公桌风水分析系统 - 测试指南

## 📋 测试清单

### 前置准备

- [ ] MySQL服务已启动（端口 13306）
- [ ] Redis服务已启动（端口 16379）
- [ ] 八字核心服务已启动（端口 9001）
- [ ] 旺衰分析服务已启动（端口 9003）
- [ ] 数据库表已创建
- [ ] 风水规则已导入

---

## 🧪 测试步骤

### 测试1：系统初始化

```bash
# 执行初始化脚本
cd /Users/zhoudt/Downloads/project/HiFate-bazi
./scripts/init_desk_fengshui.sh
```

**预期结果：**
- ✅ 数据库表创建成功
- ✅ 规则数据已插入（15条）
- ✅ Python依赖安装完成
- ✅ gRPC代码生成成功

**验证：**
```sql
-- 检查规则数量
SELECT COUNT(*) FROM bazi_system.desk_fengshui_rules;

-- 查看示例规则
SELECT rule_code, item_label, rule_type FROM bazi_system.desk_fengshui_rules LIMIT 5;
```

---

### 测试2：启动微服务

```bash
# 启动办公桌风水微服务
./scripts/start_desk_fengshui_service.sh

# 检查服务状态
ps aux | grep desk_fengshui

# 查看日志
tail -f logs/desk_fengshui_9010.log
```

**预期结果：**
- ✅ 服务成功启动
- ✅ PID文件已创建
- ✅ 日志显示"服务启动在端口 9010"

---

### 测试3：启动主服务

```bash
# 启动主服务（如果未运行）
./restart_server.sh

# 检查API路由是否注册
curl http://localhost:8001/docs
```

**预期结果：**
- ✅ 主服务启动成功
- ✅ Swagger文档包含"办公桌风水"标签
- ✅ 日志显示"办公桌风水分析路由已注册"

---

### 测试4：API健康检查

```bash
# 健康检查
curl http://localhost:8001/api/v2/desk-fengshui/health
```

**预期输出：**
```json
{
  "status": "healthy",
  "service": "desk_fengshui_api",
  "version": "1.0.0"
}
```

---

### 测试5：规则查询接口

```bash
# 查询所有规则
curl http://localhost:8001/api/v2/desk-fengshui/rules

# 查询基础规则
curl "http://localhost:8001/api/v2/desk-fengshui/rules?rule_type=basic"

# 查询特定物品规则
curl "http://localhost:8001/api/v2/desk-fengshui/rules?item_name=kettle"
```

**预期结果：**
- ✅ 返回规则列表
- ✅ 数据格式正确
- ✅ 包含rule_code、item_label、reason等字段

---

### 测试6：前端页面访问

```bash
# 在浏览器中打开
open http://localhost:8001/frontend/desk-fengshui.html
```

**检查项：**
- [ ] 页面正常加载
- [ ] 上传区域显示正常
- [ ] 八字表单显示正常
- [ ] 样式美观，无错位
- [ ] 没有JavaScript错误（F12查看控制台）

---

### 测试7：照片上传功能

**测试用例1：上传有效照片**

1. 准备一张办公桌照片（包含电脑、杯子、绿植等）
2. 在前端页面点击上传
3. 选择照片

**预期结果：**
- ✅ 照片预览正常显示
- ✅ "开始分析"按钮变为可用状态

**测试用例2：上传无效文件**

1. 尝试上传非图片文件（如txt、pdf）

**预期结果：**
- ✅ 提示"请上传图片文件"
- ✅ 上传被拒绝

**测试用例3：上传过大文件**

1. 尝试上传超过10MB的图片

**预期结果：**
- ✅ 提示"图片文件不能超过10MB"

---

### 测试8：基础分析（不使用八字）

**步骤：**
1. 上传办公桌照片
2. 关闭"使用八字分析"开关
3. 点击"开始分析"

**预期结果：**
- ✅ 显示加载动画
- ✅ 2-5秒内返回结果
- ✅ 显示评分圆环
- ✅ 显示检测到的物品列表
- ✅ 显示调整建议（如果有）
- ✅ 不显示八字信息（喜神、忌神）

**检查项：**
- [ ] 评分在0-100之间
- [ ] 总结描述清晰
- [ ] 物品名称和位置正确
- [ ] 建议合理，依据充分

---

### 测试9：完整分析（使用八字）

**步骤：**
1. 上传办公桌照片
2. 开启"使用八字分析"
3. 填写八字信息：
   - 日期：1990-01-01
   - 时间：12:00
   - 性别：男
4. 点击"开始分析"

**预期结果：**
- ✅ 显示评分和物品
- ✅ 显示喜神和忌神
- ✅ 增加建议包含五行相关推荐
- ✅ 建议文案中包含"您的喜神为XXX"

**检查项：**
- [ ] 喜神忌神显示正确
- [ ] 增加建议与喜神相关
- [ ] 五行属性标注正确

---

### 测试10：多种场景测试

**场景1：干净办公桌**
- 照片：只有电脑和鼠标
- 预期：评分中等，建议增加绿植等物品

**场景2：杂乱办公桌**
- 照片：物品很多且摆放混乱
- 预期：评分较低，多条调整建议

**场景3：理想办公桌**
- 照片：物品摆放合理，符合风水规则
- 预期：评分高（80+），少量或无建议

---

### 测试11：错误处理测试

**测试用例1：未填写必需八字信息**

1. 开启"使用八字分析"
2. 不填写日期/时间
3. 点击"开始分析"

**预期结果：**
- ✅ 提示"请填写完整的八字信息"

**测试用例2：服务不可用**

1. 停止微服务：`./scripts/stop_desk_fengshui_service.sh`
2. 尝试分析

**预期结果：**
- ✅ 提示"服务未就绪，请稍后重试"或连接错误

**测试用例3：无效图片数据**

1. 上传一个损坏的图片文件

**预期结果：**
- ✅ 提示"图像解码失败"或类似错误

---

### 测试12：性能测试

**测试内容：**
- 单次分析耗时
- 并发请求处理

**步骤：**

```bash
# 测试单次分析
time curl -X POST http://localhost:8001/api/v2/desk-fengshui/analyze \
  -F "image=@test_desk.jpg" \
  -F "use_bazi=false"
```

**预期结果：**
- ✅ 响应时间 < 5秒
- ✅ 返回数据完整

---

### 测试13：日志检查

```bash
# 查看微服务日志
tail -n 50 logs/desk_fengshui_9010.log

# 查看主服务日志
tail -n 50 logs/server_8001.log
```

**检查项：**
- [ ] 无ERROR级别日志
- [ ] 请求处理流程清晰
- [ ] 性能指标正常（耗时、内存等）

---

## 🐛 常见问题排查

### 问题1：物品检测不准确

**原因分析：**
- YOLO模型未正确加载
- ultralytics 库未安装
- 照片质量问题

**解决方案：**
```bash
# 安装 ultralytics
pip install ultralytics

# 测试YOLO模型
python -c "from ultralytics import YOLO; model = YOLO('yolov8n.pt'); print('✅ YOLO模型加载成功')"
```

### 问题2：八字信息无法获取

**原因分析：**
- 旺衰分析服务未启动
- gRPC连接失败

**解决方案：**
```bash
# 检查旺衰服务
ps aux | grep wangshuai

# 查看服务日志
tail -f logs/bazi_analyzer_9003.log

# 重启相关服务
./start_all_services.sh
```

### 问题3：前端无法连接后端

**原因分析：**
- 端口配置错误
- CORS配置问题

**解决方案：**
```javascript
// 检查 frontend/config.js
console.log(window.API_BASE_URL);

// 应该是：http://localhost:8001
```

---

## ✅ 测试通过标准

### 核心功能
- [x] 照片上传成功
- [x] 物品检测准确率 > 60%
- [x] 方位计算正确
- [x] 规则匹配准确
- [x] 评分计算合理
- [x] 建议生成清晰

### 八字集成
- [x] 喜神忌神获取成功
- [x] 个性化建议生成
- [x] 五行物品推荐正确

### 用户体验
- [x] 界面美观易用
- [x] 响应速度快（< 5秒）
- [x] 错误提示清晰
- [x] 结果展示直观

### 系统稳定性
- [x] 无内存泄漏
- [x] 无未捕获异常
- [x] 日志记录完整
- [x] 服务可重启

---

## 📝 测试报告模板

```markdown
# 办公桌风水分析系统 - 测试报告

## 测试环境
- 操作系统：macOS 13.x
- Python版本：3.9+
- MySQL版本：8.0
- Redis版本：7.0

## 测试结果

### 功能测试
| 测试项 | 结果 | 备注 |
|--------|------|------|
| 系统初始化 | ✅ | 规则导入成功 |
| 服务启动 | ✅ | 微服务正常运行 |
| 照片上传 | ✅ | 支持拖拽和点击 |
| 物品检测 | ✅ | 识别到5个物品 |
| 规则匹配 | ✅ | 匹配了3条规则 |
| 评分计算 | ✅ | 评分75分 |
| 八字集成 | ✅ | 喜神"水"获取成功 |

### 性能测试
- 平均响应时间：3.2秒
- 内存占用：< 500MB
- 并发处理：支持10 QPS

### 问题记录
1. 暂无

## 总结
系统功能完整，性能良好，可以投入使用。
```

---

## 🎯 后续优化建议

1. **模型优化**
   - 训练自定义YOLO模型，支持更多办公桌物品
   - 提高检测准确率

2. **规则扩展**
   - 基于用户文档补充更多规则
   - 支持不同职业的个性化规则

3. **功能增强**
   - 支持多角度照片分析
   - 生成PDF分析报告
   - 提供风水改善方案的3D可视化

4. **性能优化**
   - 使用GPU加速YOLO推理
   - 增加规则缓存
   - 支持异步分析

---

**测试完成后，请将结果记录到测试报告中，并提交到项目文档。**

祝测试顺利！🎉

