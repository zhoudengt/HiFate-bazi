# HiFateç³»ç»Ÿ - å¼€å‘è§„èŒƒ

## ğŸ“‹ ç›®å½•
- [æ ¸å¿ƒåŸåˆ™](#æ ¸å¿ƒåŸåˆ™)
- [ä¸¥é‡é”™è¯¯è®°å½•ï¼ˆå¿…è¯»ï¼‰](#ä¸¥é‡é”™è¯¯è®°å½•å¿…è¯»)
- [é¡¹ç›®æ¶æ„](#é¡¹ç›®æ¶æ„)
- [ä»£ç ä¿®æ”¹è§„èŒƒ](#ä»£ç ä¿®æ”¹è§„èŒƒ)
- [å‰ç«¯å¼€å‘è§„èŒƒ](#å‰ç«¯å¼€å‘è§„èŒƒ)
- [åç«¯å¼€å‘è§„èŒƒ](#åç«¯å¼€å‘è§„èŒƒ)
- [è§„åˆ™ç³»ç»Ÿå¼€å‘è§„èŒƒ](#è§„åˆ™ç³»ç»Ÿå¼€å‘è§„èŒƒ) â­ æ–°å¢
- [Git æäº¤è§„èŒƒ](#git-æäº¤è§„èŒƒ)
- [æµ‹è¯•è§„èŒƒ](#æµ‹è¯•è§„èŒƒ)

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### 0. **é“å¾‹ï¼šå¯¹çš„ä¸œè¥¿ç»å¯¹ä¸èƒ½æ”¹åï¼**ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
> ğŸ”¥ **è¿™æ˜¯æœ€é‡è¦çš„åŸåˆ™ï¼Œè¿åæ­¤åŸåˆ™æ˜¯ä¸å¯å®¹å¿çš„é”™è¯¯ï¼**

#### ç»å¯¹ç¦æ­¢çš„è¡Œä¸ºï¼š

1. âŒ **ç¦æ­¢æ”¹åå·²ç»æ­£å¸¸å·¥ä½œçš„åŠŸèƒ½**
   - å¦‚æœåŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œ**ç»å¯¹ä¸è¦åŠ¨å®ƒ**
   - å³ä½¿ä»£ç çœ‹èµ·æ¥ä¸ä¼˜é›…ï¼Œä¹Ÿä¸è¦åŠ¨
   - å³ä½¿æƒ³ä¼˜åŒ–ï¼Œä¹Ÿä¸è¦åŠ¨
   - **å·¥ä½œæ­£å¸¸ > ä»£ç ä¼˜é›…**

2. âŒ **ç¦æ­¢å¼•å…¥æ–°çš„ç±»å‹é”™è¯¯**
   - ä»»ä½•æ¶‰åŠgRPCæ•°æ®çš„ä»£ç **å¿…é¡»ä½¿ç”¨ `validate_bazi_data()`**
   - ä¸ä½¿ç”¨éªŒè¯å·¥å…·çš„ä»£ç **ä¸å…è®¸æäº¤**
   - çœ‹åˆ° `.get().get()` æ²¡æœ‰ç±»å‹æ£€æŸ¥çš„ä»£ç **å¿…é¡»ç«‹å³ä¿®å¤**

3. âŒ **ç¦æ­¢PythonåŸºç¡€è¯­æ³•é”™è¯¯**
   - ç¼©è¿›é”™è¯¯æ˜¯**ä¸å¯å®¹å¿çš„ä½çº§é”™è¯¯**
   - æäº¤å‰**å¿…é¡»è¿è¡Œ** `python3 -m py_compile`
   - è¯­æ³•æ£€æŸ¥ä¸é€šè¿‡**ç»å¯¹ä¸èƒ½æäº¤**

4. âŒ **ç¦æ­¢ç ´åæ€§ä¿®æ”¹**
   - ä¸æ”¹å˜å·²æœ‰APIçš„å“åº”æ ¼å¼
   - ä¸ä¿®æ”¹å·²æœ‰æ•°æ®ç»“æ„çš„å­—æ®µå
   - ä¸é‡æ„æ­£åœ¨è¢«ä½¿ç”¨çš„æ ¸å¿ƒå‡½æ•°

#### å¦‚æœè¿åï¼š

**åæœï¼š**
- ğŸ”´ ç«‹å³å›æ»šæ‰€æœ‰ä¿®æ”¹
- ğŸ”´ å¿…é¡»æ¢å¤åˆ°ä¸Šä¸€ä¸ªå¯å·¥ä½œçš„ç‰ˆæœ¬
- ğŸ”´ å¿…é¡»è¿è¡Œå®Œæ•´æµ‹è¯•ç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
- ğŸ”´ å¿…é¡»æ›´æ–°å¼€å‘è§„èŒƒé˜²æ­¢å†æ¬¡å‘ç”Ÿ

**åé¢æ•™æï¼š**
```
âŒ "æˆ‘åªæ˜¯ä¼˜åŒ–äº†ä¸€ä¸‹ä»£ç ç»“æ„" â†’ å¯¼è‡´3ä¸ªåŠŸèƒ½ä¸å·¥ä½œ
âŒ "æˆ‘é¡ºä¾¿é‡æ„äº†è¿™ä¸ªå‡½æ•°" â†’ å¯¼è‡´APIè¿”å›é”™è¯¯
âŒ "æˆ‘å¿˜è®°æ£€æŸ¥ç±»å‹äº†" â†’ å¯¼è‡´é¡µé¢æŠ¥é”™
âŒ "æˆ‘æ²¡æ³¨æ„ç¼©è¿›" â†’ å¯¼è‡´æœåŠ¡æ— æ³•å¯åŠ¨
```

**æ­£ç¡®åšæ³•ï¼š**
```
âœ… åªä¿®æ”¹å¿…é¡»ä¿®æ”¹çš„ä»£ç 
âœ… ä¿®æ”¹å‰è¯„ä¼°å½±å“èŒƒå›´
âœ… ä¿®æ”¹åå®Œæ•´æµ‹è¯•
âœ… æäº¤å‰è¿è¡Œè‡ªåŠ¨æ£€æŸ¥
```

---

### 1. **æœ€å°å½±å“åŸåˆ™ï¼ˆMost Importantï¼‰**
> âš ï¸ **å¢åŠ æ–°åŠŸèƒ½æˆ–ä¿®æ”¹å†…å®¹æ—¶ï¼Œåšå†³ä¸å¯æ”¹åŠ¨ä¸ä¹‹æ— å…³çš„ä»£ç ï¼**

#### è§„åˆ™ï¼š
1. âœ… **åªä¿®æ”¹å¿…è¦çš„æ–‡ä»¶**ï¼šä»…ä¿®æ”¹ä¸å½“å‰åŠŸèƒ½ç›´æ¥ç›¸å…³çš„ä»£ç 
2. âŒ **ç¦æ­¢é‡æ„æ— å…³ä»£ç **ï¼šå³ä½¿çœ‹åˆ°å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Œä¹Ÿä¸è¦åŠ¨
3. âš ï¸ **å½±å“è¯„ä¼°**ï¼šå¦‚æœä¿®æ”¹ä¼šå¼•èµ·å…¶ä»–åŠŸèƒ½æˆ–ä»£ç å˜åŒ–ï¼Œ**å¿…é¡»å…ˆå’¨è¯¢ç¡®è®¤åå†ä¿®æ”¹**
4. ğŸ“ **å˜æ›´è®°å½•**ï¼šæ¯æ¬¡ä¿®æ”¹è¦è®°å½•ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨å’ŒåŸå› 

#### ç¤ºä¾‹ï¼š

**âŒ é”™è¯¯åšæ³•ï¼š**
```python
# ä»»åŠ¡ï¼šæ·»åŠ æ–°çš„ API ç«¯ç‚¹ /api/v1/new_feature
# é”™è¯¯ï¼šé¡ºä¾¿é‡æ„äº†å…¶ä»–ä¸ç›¸å…³çš„ä»£ç 

# ä¿®æ”¹äº† server/main.py
app.include_router(new_feature_router)  # âœ… è¿™æ˜¯éœ€è¦çš„

# åŒæ—¶è¿˜ä¿®æ”¹äº†ä¸ç›¸å…³çš„ä»£ç 
app.include_router(bazi_router, prefix="/api/v1", tags=["å…«å­—"])  # âŒ ä¸åº”è¯¥æ”¹
# æ”¹å˜äº†åŸæœ‰è·¯ç”±çš„æ³¨å†Œæ–¹å¼
```

**âœ… æ­£ç¡®åšæ³•ï¼š**
```python
# åªæ·»åŠ æ–°åŠŸèƒ½ç›¸å…³çš„ä»£ç ï¼Œä¸åŠ¨å…¶ä»–éƒ¨åˆ†
app.include_router(new_feature_router, prefix="/api/v1", tags=["æ–°åŠŸèƒ½"])
```

---

## âš ï¸ ä¸¥é‡é”™è¯¯è®°å½•ï¼ˆå¿…è¯»ï¼‰

### ğŸ”¥ 2025-11-21 ä¸¥é‡é”™è¯¯2ï¼šgRPCç±»å‹è½¬æ¢é—®é¢˜ï¼ˆç¬¬Næ¬¡å‡ºç°ï¼‰

#### é”™è¯¯æè¿°

**æ—¶é—´ï¼š** 2025-11-21 ä¸‹åˆ  
**å½±å“èŒƒå›´ï¼š** ç®—æ³•å…¬å¼è§„åˆ™åˆ†æåŠŸèƒ½ï¼ˆformula-analysisé¡µé¢ï¼‰å®Œå…¨ä¸å¯ç”¨  
**ä¸¥é‡ç¨‹åº¦ï¼š** ğŸ”´ **P0çº§åˆ«** - æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨  
**é”™è¯¯æ¬¡æ•°ï¼š** **ç¬¬Næ¬¡**ï¼ˆåå¤å‡ºç°ï¼ï¼‰

#### é”™è¯¯è¡¨ç°

```
{"success":false,"error":"'str' object has no attribute 'get'"}
```

#### æ ¹æœ¬åŸå› 

**gRPCåºåˆ—åŒ–é—®é¢˜**ï¼šæŸäº›å­—å…¸ç±»å‹çš„å­—æ®µåœ¨gRPCä¼ è¾“åå˜æˆäº†JSONå­—ç¬¦ä¸²ï¼Œä»£ç è¯•å›¾å¯¹å­—ç¬¦ä¸²ä½¿ç”¨ `.get()` æ–¹æ³•å¯¼è‡´é”™è¯¯ã€‚

**é—®é¢˜å­—æ®µ**ï¼š
- `ten_gods_stats` ï¼ˆåç¥ç»Ÿè®¡ï¼‰
- `element_counts` ï¼ˆäº”è¡Œç»Ÿè®¡ï¼‰
- `relationships` ï¼ˆå…³ç³»ä¿¡æ¯ï¼‰
- `branch_relations` ï¼ˆåœ°æ”¯å…³ç³»ï¼‰

**é”™è¯¯ä»£ç æ¨¡å¼**ï¼š
```python
# âŒ æ²¡æœ‰ç±»å‹æ£€æŸ¥ï¼Œç›´æ¥ä½¿ç”¨
element_counts = bazi_data.get('element_counts', {})
count = element_counts.get('æœ¨', 0)  # å¦‚æœelement_countsæ˜¯å­—ç¬¦ä¸²ï¼Œè¿™é‡ŒæŠ¥é”™
```

#### ä¸ºä»€ä¹ˆè¿™ä¹ˆæ¶å¿ƒï¼Ÿ

**è¿™ä¸ªé—®é¢˜åå¤å‡ºç°ï¼**

1. **2025-11-20**: ä¿®å¤äº† `daily_fortune` å’Œ `monthly_fortune` çš„ç±»å‹é—®é¢˜
2. **2025-11-21**: åˆåœ¨ `formula_rule_service` ä¸­å‡ºç°åŒæ ·çš„é—®é¢˜
3. **åŸå› **: æ¯ä¸ªServiceéƒ½éœ€è¦å•ç‹¬æ·»åŠ é˜²å¾¡æ€§ä»£ç ï¼Œå®¹æ˜“é—æ¼

**ç”¨æˆ·çš„ç—›è‹¦**ï¼š
> "ä¸ºä»€ä¹ˆå¥½å¥½çš„åŠŸèƒ½çªç„¶å°±ä¸å¥½äº†ï¼Ÿå¤ªæ¶å¿ƒäº†ï¼"

**å¼€å‘çš„ç—›è‹¦**ï¼š
> "æ¯æ¬¡éƒ½æ˜¯åŒæ ·çš„é—®é¢˜ï¼Œä¿®äº†ä¸€ä¸ªåœ°æ–¹ï¼Œå¦ä¸€ä¸ªåœ°æ–¹åˆå‡ºç°ï¼"

#### ç»ˆæè§£å†³æ–¹æ¡ˆ

æˆ‘ä»¬åˆ›å»ºäº† **ç»Ÿä¸€çš„æ•°æ®éªŒè¯å·¥å…·** `server/utils/data_validator.py`

##### ä½¿ç”¨æ–¹æ³•

**æ–¹æ³•1ï¼šå…¨é¢éªŒè¯ï¼ˆæ¨èï¼‰**

```python
from server.utils.data_validator import validate_bazi_data

def my_service_method(solar_date, solar_time, gender):
    # 1. è·å–æ•°æ®
    bazi_data = BaziService.calculate_bazi_full(...)
    
    # 2. ã€å…³é”®ã€‘ä¸€æ¬¡æ€§éªŒè¯å¹¶ä¿®å¤æ‰€æœ‰å­—æ®µ
    bazi_data = validate_bazi_data(bazi_data)
    
    # 3. ç°åœ¨æ‰€æœ‰å­—æ®µéƒ½æ˜¯æ­£ç¡®çš„ç±»å‹ï¼Œå¯ä»¥å®‰å…¨ä½¿ç”¨
    ten_gods_stats = bazi_data.get('ten_gods_stats', {})  # ä¿è¯æ˜¯dict
    element_counts = bazi_data.get('element_counts', {})  # ä¿è¯æ˜¯dict
```

**æ–¹æ³•2ï¼šå•ä¸ªå­—æ®µéªŒè¯**

```python
from server.utils.data_validator import ensure_dict

# ä½¿ç”¨å‰éªŒè¯
element_counts = ensure_dict(bazi_data.get('element_counts', {}))
# ç°åœ¨å¯ä»¥å®‰å…¨ä½¿ç”¨
count = element_counts.get('æœ¨', 0)
```

#### å¼ºåˆ¶è§„èŒƒ

**ä»ç°åœ¨å¼€å§‹ï¼Œæ‰€æœ‰æ¶‰åŠgRPCæ•°æ®çš„Serviceå¿…é¡»ï¼š**

1. âœ… **åœ¨æ–¹æ³•å¼€å¤´è°ƒç”¨ `validate_bazi_data()`**
2. âœ… **æˆ–è€…ä½¿ç”¨ `ensure_dict()` éªŒè¯æ¯ä¸ªå­—æ®µ**
3. âœ… **æäº¤å‰è¿è¡Œæµ‹è¯•ç¡®ä¿æ²¡æœ‰ç±»å‹é”™è¯¯**

#### æ£€æŸ¥æ¸…å•

**ä»£ç å®¡æŸ¥æ—¶å¿…é¡»æ£€æŸ¥ï¼š**

- [ ] æ˜¯å¦ä½¿ç”¨äº† gRPC è¿”å›çš„æ•°æ®ï¼Ÿ
- [ ] æ˜¯å¦è°ƒç”¨äº† `validate_bazi_data()` æˆ– `ensure_dict()`ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ `.get().get()` æ¨¡å¼ä½†æ²¡æœ‰ç±»å‹æ£€æŸ¥ï¼Ÿ
- [ ] æ˜¯å¦æµ‹è¯•é€šè¿‡ï¼Ÿ

#### é—®é¢˜å­—æ®µé€ŸæŸ¥è¡¨

**ä»¥ä¸‹å­—æ®µåœ¨gRPCåå¯èƒ½å˜æˆå­—ç¬¦ä¸²ï¼Œå¿…é¡»éªŒè¯ï¼š**

| å­—æ®µå | ç±»å‹ | å¸¸è§ç”¨é€” |
|--------|------|---------|
| `ten_gods_stats` | dict | åç¥ç»Ÿè®¡ |
| `element_counts` | dict | äº”è¡Œç»Ÿè®¡ |
| `elements` | dict | äº”è¡Œä¿¡æ¯ |
| `relationships` | dict | å…³ç³»ä¿¡æ¯ |
| `branch_relations` | dict | åœ°æ”¯å…³ç³» |
| `details` | dict | è¯¦ç»†ä¿¡æ¯ |
| `hidden_stems` | list/dict | è—å¹² |

#### å·²ä¿®å¤çš„æ–‡ä»¶

1. âœ… `server/services/daily_fortune_service.py`
2. âœ… `server/services/monthly_fortune_service.py`  
3. âœ… `server/services/formula_rule_service.py` ï¼ˆæ–°ä¿®å¤ï¼‰

#### éœ€è¦æ›´æ–°çš„æ–‡ä»¶

**è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥å…¶ä»–å¯èƒ½æœ‰é—®é¢˜çš„æ–‡ä»¶ï¼š**

```bash
# æŸ¥æ‰¾æ‰€æœ‰ä½¿ç”¨é—®é¢˜å­—æ®µçš„æ–‡ä»¶
grep -l "ten_gods_stats\|element_counts\|relationships" server/services/*.py

# æ£€æŸ¥æ˜¯å¦æœ‰ç±»å‹éªŒè¯
grep -L "ensure_dict\|validate_bazi_data" <ä¸Šé¢æ‰¾åˆ°çš„æ–‡ä»¶>
```

#### æ·±åˆ»æ•™è®­

> **"ä¿®ä¸€ä¸ªåœ°æ–¹ï¼Œå¿˜è®°å¦ä¸€ä¸ªåœ°æ–¹ï¼Œå°±åƒæ‰“åœ°é¼ æ¸¸æˆï¼"**

1. **ç¼ºä¹ç³»ç»Ÿæ€§è§£å†³æ–¹æ¡ˆ**
   - ä»¥å‰ï¼šæ¯ä¸ªServiceå•ç‹¬åŠ é˜²å¾¡ä»£ç 
   - ç°åœ¨ï¼šç»Ÿä¸€çš„éªŒè¯å·¥å…·

2. **ç¼ºä¹å¼ºåˆ¶è§„èŒƒ**
   - ä»¥å‰ï¼šä¾èµ–è®°å¿†ï¼Œå®¹æ˜“é—æ¼
   - ç°åœ¨ï¼šå¼ºåˆ¶è¦æ±‚ï¼Œä»£ç å®¡æŸ¥æ£€æŸ¥

3. **ç¼ºä¹æ–‡æ¡£**
   - ä»¥å‰ï¼šçŸ¥é“æœ‰é—®é¢˜ï¼Œä½†ä¸çŸ¥é“æ€ä¹ˆå½»åº•è§£å†³
   - ç°åœ¨ï¼šè¯¦ç»†æ–‡æ¡£ï¼Œç»ˆæè§£å†³æ–¹æ¡ˆ

#### é¢„é˜²æªæ–½

##### 1. ä½¿ç”¨ç»Ÿä¸€å·¥å…·ï¼ˆå¿…é¡»ï¼‰

```python
# åœ¨æ¯ä¸ªServiceæ–‡ä»¶å¼€å¤´
from server.utils.data_validator import validate_bazi_data, ensure_dict

# åœ¨æ¯ä¸ªæ–¹æ³•å¼€å¤´
bazi_data = validate_bazi_data(bazi_data)
```

##### 2. ä»£ç å®¡æŸ¥ï¼ˆå¿…é¡»ï¼‰

æäº¤å‰å¿…é¡»å›ç­”ï¼š
- æ˜¯å¦ä½¿ç”¨äº† gRPC æ•°æ®ï¼Ÿ**æ˜¯** â†’ å¿…é¡»éªŒè¯
- æ˜¯å¦è°ƒç”¨äº†éªŒè¯å·¥å…·ï¼Ÿ**å¦** â†’ ä¸èƒ½æäº¤

##### 3. è‡ªåŠ¨æ£€æŸ¥ï¼ˆæ¨èï¼‰

æ·»åŠ åˆ° `scripts/pre_commit_check.sh`ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†é—®é¢˜å­—æ®µä½†æ²¡æœ‰éªŒè¯
grep -rn "ten_gods_stats\|element_counts" server/services/*.py | \
while read line; do
  file=$(echo "$line" | cut -d: -f1)
  if ! grep -q "validate_bazi_data\|ensure_dict" "$file"; then
    echo "âŒ $file ä½¿ç”¨äº†é—®é¢˜å­—æ®µä½†æ²¡æœ‰ç±»å‹éªŒè¯"
    exit 1
  fi
done
```

#### å‚è€ƒæ–‡æ¡£

- ğŸ“„ [é˜²æ­¢ç±»å‹é”™è¯¯çš„ç»ˆæè§£å†³æ–¹æ¡ˆ](./é˜²æ­¢ç±»å‹é”™è¯¯çš„ç»ˆæè§£å†³æ–¹æ¡ˆ.md) â­ **å¿…è¯»**
- ğŸ”§ å·¥å…·æ–‡ä»¶ï¼š`server/utils/data_validator.py`
- ğŸ“‹ å¼€å‘è§„èŒƒï¼šè§ä¸‹æ–¹"gRPCæ•°æ®éªŒè¯è§„èŒƒ"

#### åæ€

è¿™æ¬¡é”™è¯¯å†æ¬¡è¯æ˜ï¼š

1. **å±€éƒ¨ä¿®å¤ä¸æ˜¯è§£å†³æ–¹æ¡ˆ** - éœ€è¦ç³»ç»Ÿæ€§çš„å·¥å…·å’Œè§„èŒƒ
2. **æ–‡æ¡£å’Œå·¥å…·åŒæ ·é‡è¦** - ä¸èƒ½åªä¾èµ–è®°å¿†
3. **å¼ºåˆ¶æ£€æŸ¥å¿…ä¸å¯å°‘** - ä»£ç å®¡æŸ¥å’Œè‡ªåŠ¨æ£€æŸ¥

**å¿…é¡»ç‰¢è®°ï¼š**
- âœ… gRPCæ•°æ®å¿…é¡»éªŒè¯ç±»å‹
- âœ… ä½¿ç”¨ç»Ÿä¸€çš„éªŒè¯å·¥å…·
- âœ… æäº¤å‰å¿…é¡»é€šè¿‡æ£€æŸ¥
- âœ… çœ‹åˆ°ç›¸åŒé”™è¯¯ï¼Œç«‹å³æ›´æ–°æ‰€æœ‰ç›¸å…³ä»£ç 

---

### ğŸ”¥ 2025-11-21 ä¸¥é‡é”™è¯¯1ï¼šPythonç¼©è¿›é”™è¯¯å¯¼è‡´æœåŠ¡æ— æ³•å¯åŠ¨

#### é”™è¯¯æè¿°

**æ—¶é—´ï¼š** 2025-11-21  
**å½±å“èŒƒå›´ï¼š** æ•´ä¸ªåç«¯æœåŠ¡æ— æ³•å¯åŠ¨ï¼Œæ‰€æœ‰å‰ç«¯åŠŸèƒ½ä¸å¯ç”¨  
**ä¸¥é‡ç¨‹åº¦ï¼š** ğŸ”´ **P0çº§åˆ«** - å¯¼è‡´ç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨

#### é”™è¯¯ç»è¿‡

1. **ä»£ç ä¿®æ”¹æ—¶**ï¼Œåœ¨ä¸¤ä¸ªserviceæ–‡ä»¶ä¸­å¼•å…¥äº†Pythonç¼©è¿›é”™è¯¯
2. **æ²¡æœ‰è¿›è¡Œè¯­æ³•æ£€æŸ¥** - ä¿®æ”¹åç›´æ¥æäº¤ä»£ç 
3. **æœåŠ¡å¯åŠ¨å¤±è´¥** - uvicornè¿›ç¨‹ä¸æ–­é‡å¯ï¼Œæ— æ³•åŠ è½½åº”ç”¨
4. **å‰ç«¯ä¸æ˜¾ç¤ºæ•°æ®** - APIè¯·æ±‚è¶…æ—¶ï¼Œå‰ç«¯é¡µé¢ç©ºç™½

#### æ ¹æœ¬åŸå› 

**Pythonç¼©è¿›é”™è¯¯** - è¿™æ˜¯æœ€åŸºç¡€çš„è¯­æ³•é”™è¯¯ï¼š

```python
# âŒ é”™è¯¯ä»£ç ï¼ˆç¼ºå°‘ç¼©è¿›ï¼‰
if isinstance(pian_guan, dict) and pian_guan.get('count', 0) > 0:
base_text += "åå®˜åœ¨å‘½ï¼Œé€‚åˆå¼€æ‹“åˆ›æ–°ã€‚"  # æ²¡æœ‰ç¼©è¿›ï¼

# âœ… æ­£ç¡®ä»£ç 
if isinstance(pian_guan, dict) and pian_guan.get('count', 0) > 0:
    base_text += "åå®˜åœ¨å‘½ï¼Œé€‚åˆå¼€æ‹“åˆ›æ–°ã€‚"  # éœ€è¦4ä¸ªç©ºæ ¼ç¼©è¿›
```

#### å½±å“çš„æ–‡ä»¶

- `server/services/daily_fortune_service.py` - ç¬¬506è¡Œã€ç¬¬534è¡Œ
- `server/services/monthly_fortune_service.py` - ç¬¬358è¡Œã€ç¬¬386è¡Œ

#### ä¿®å¤æ–¹æ¡ˆ

1. **ç«‹å³ä¿®å¤æ‰€æœ‰ç¼©è¿›é”™è¯¯**
2. **ä½¿ç”¨è¯­æ³•æ£€æŸ¥å·¥å…·éªŒè¯**ï¼š
```bash
python3 -m py_compile server/services/daily_fortune_service.py
python3 -m py_compile server/services/monthly_fortune_service.py
```
3. **é‡å¯æœåŠ¡éªŒè¯**ï¼š
```bash
./restart_server.sh
```

#### æ·±åˆ»æ•™è®­

> **"Pythonç¼©è¿›é”™è¯¯æ˜¯æœ€åŸºç¡€ä½†æœ€è‡´å‘½çš„é”™è¯¯"**

1. **ä»£ç æäº¤å‰å¿…é¡»è¿›è¡Œè¯­æ³•æ£€æŸ¥**
   - ä¸èƒ½ä¾èµ–"çœ‹èµ·æ¥æ²¡é—®é¢˜"
   - å¿…é¡»è¿è¡Œ `python3 -m py_compile` éªŒè¯
   - é…ç½®ç¼–è¾‘å™¨è‡ªåŠ¨æ£€æŸ¥è¯­æ³•

2. **æœåŠ¡æ— æ³•å¯åŠ¨ä¼šå¯¼è‡´ç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨**
   - åç«¯æœåŠ¡æ— æ³•å¯åŠ¨ â†’ APIè¯·æ±‚è¶…æ—¶
   - å‰ç«¯æ— æ³•è·å–æ•°æ® â†’ é¡µé¢ç©ºç™½
   - ç”¨æˆ·å®Œå…¨æ— æ³•ä½¿ç”¨ç³»ç»Ÿ

3. **é”™è¯¯å‘ç°å»¶è¿Ÿä¸¥é‡**
   - æœ¬åœ°æ²¡æœ‰æµ‹è¯•å°±æäº¤ä»£ç 
   - ç”Ÿäº§ç¯å¢ƒæ‰å‘ç°é—®é¢˜
   - å½±å“ç”¨æˆ·ä½“éªŒ

#### é¢„é˜²æªæ–½

##### 1. ä»£ç æäº¤å‰å¼ºåˆ¶æ£€æŸ¥

**åˆ›å»º pre-commit hook**ï¼š

```bash
# .git/hooks/pre-commit
#!/bin/bash

echo "ğŸ” æ£€æŸ¥Pythonè¯­æ³•..."

# æ£€æŸ¥æ‰€æœ‰ä¿®æ”¹çš„Pythonæ–‡ä»¶
for file in $(git diff --cached --name-only --diff-filter=ACM | grep '\.py$'); do
    python3 -m py_compile "$file" 2>&1
    if [ $? -ne 0 ]; then
        echo "âŒ è¯­æ³•é”™è¯¯: $file"
        echo "è¯·ä¿®å¤åå†æäº¤"
        exit 1
    fi
done

echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"
exit 0
```

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# è®¾ç½®hookæƒé™
chmod +x .git/hooks/pre-commit

# ä»¥åæ¯æ¬¡commitéƒ½ä¼šè‡ªåŠ¨æ£€æŸ¥
```

##### 2. ç¼–è¾‘å™¨é…ç½®

**VS Code / Cursor é…ç½®** (`.vscode/settings.json`):
```json
{
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true,
    "python.linting.lintOnSave": true,
    "python.formatting.provider": "black",
    "editor.formatOnSave": true,
    "editor.detectIndentation": false,
    "editor.tabSize": 4,
    "editor.insertSpaces": true,
    "files.autoSave": "afterDelay",
    "files.autoSaveDelay": 1000
}
```

**PyCharm é…ç½®**ï¼š
- Settings â†’ Editor â†’ Code Style â†’ Python
- Tab size: 4
- Indent: 4
- Use tab character: å–æ¶ˆå‹¾é€‰
- Enable inspection: PEP 8 coding style violation

##### 3. æ‰‹åŠ¨æ£€æŸ¥å‘½ä»¤

**æäº¤å‰å¿…é¡»è¿è¡Œ**ï¼š
```bash
# æ£€æŸ¥å•ä¸ªæ–‡ä»¶
python3 -m py_compile path/to/file.py

# æ£€æŸ¥æ‰€æœ‰Pythonæ–‡ä»¶
find server -name "*.py" -exec python3 -m py_compile {} \; 2>&1

# å¦‚æœæœ‰é”™è¯¯ï¼Œä¼šæ˜¾ç¤ºæ–‡ä»¶åå’Œè¡Œå·
```

##### 4. è‡ªåŠ¨åŒ–æµ‹è¯•

**åˆ›å»ºæµ‹è¯•è„šæœ¬** (`scripts/check_syntax.py`):
```python
#!/usr/bin/env python3
"""æ£€æŸ¥æ‰€æœ‰Pythonæ–‡ä»¶çš„è¯­æ³•"""

import py_compile
import glob
import sys

def check_syntax():
    """æ£€æŸ¥è¯­æ³•"""
    errors = []
    files = glob.glob('**/*.py', recursive=True)
    
    for file in files:
        if 'venv' in file or '.venv' in file:
            continue
        try:
            py_compile.compile(file, doraise=True)
            print(f"âœ… {file}")
        except py_compile.PyCompileError as e:
            print(f"âŒ {file}: {e}")
            errors.append(file)
    
    if errors:
        print(f"\nâŒ {len(errors)} ä¸ªæ–‡ä»¶æœ‰è¯­æ³•é”™è¯¯")
        sys.exit(1)
    else:
        print(f"\nâœ… æ‰€æœ‰ {len(files)} ä¸ªæ–‡ä»¶è¯­æ³•æ­£ç¡®")
        sys.exit(0)

if __name__ == '__main__':
    check_syntax()
```

##### 5. è¯Šæ–­å·¥å…·

**åˆ›å»ºäº†è‡ªåŠ¨è¯Šæ–­å·¥å…·** (`test_frontend_display.py`):
- è‡ªåŠ¨æ£€æŸ¥å‰ç«¯æ–‡ä»¶è®¿é—®
- è‡ªåŠ¨æµ‹è¯•åç«¯API
- å¿«é€Ÿå®šä½é—®é¢˜ï¼ˆå‰ç«¯ vs åç«¯ï¼‰

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
python3 test_frontend_display.py
```

**è¯Šæ–­é¡µé¢** (`frontend/diagnostic.html`):
- åœ¨æµè§ˆå™¨ä¸­å®æ—¶æµ‹è¯•
- æ£€æŸ¥JSå‡½æ•°æ˜¯å¦åŠ è½½
- æµ‹è¯•APIè¿æ¥

**è®¿é—®åœ°å€**ï¼š
```
http://127.0.0.1:8080/diagnostic.html
```

#### å¼€å‘æµç¨‹å¼ºåŒ–

**ä¿®æ”¹åå¿…é¡»æ£€æŸ¥**ï¼š

1. **è¯­æ³•æ£€æŸ¥** - `python3 -m py_compile <file>`
2. **æœåŠ¡é‡å¯** - `./restart_server.sh`
3. **å¥åº·æ£€æŸ¥** - `curl http://127.0.0.1:8001/health`
4. **åŠŸèƒ½æµ‹è¯•** - è®¿é—®å‰ç«¯é¡µé¢éªŒè¯
5. **æ—¥å¿—æ£€æŸ¥** - `tail -f logs/web_app_8001.log`

**å®Œæ•´æ£€æŸ¥æ¸…å•**ï¼š
```bash
#!/bin/bash
# æäº¤å‰æ£€æŸ¥è„šæœ¬

echo "1ï¸âƒ£ æ£€æŸ¥Pythonè¯­æ³•..."
find server -name "*.py" -exec python3 -m py_compile {} \; || exit 1

echo "2ï¸âƒ£ é‡å¯æœåŠ¡..."
./restart_server.sh || exit 1

echo "3ï¸âƒ£ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 5

echo "4ï¸âƒ£ å¥åº·æ£€æŸ¥..."
curl -f http://127.0.0.1:8001/health || exit 1

echo "5ï¸âƒ£ æµ‹è¯•API..."
python3 test_frontend_display.py || exit 1

echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥æäº¤ä»£ç "
```

#### åæ€

è¿™æ¬¡é”™è¯¯æš´éœ²äº†æœ€åŸºç¡€çš„å¼€å‘æµç¨‹ç¼ºé™·ï¼š

1. **ç¼ºä¹åŸºæœ¬çš„è´¨é‡ä¿éšœ** - æ²¡æœ‰è¯­æ³•æ£€æŸ¥
2. **ç¼ºä¹æœ¬åœ°æµ‹è¯•** - æ²¡æœ‰éªŒè¯æœåŠ¡èƒ½å¦å¯åŠ¨
3. **ç¼ºä¹ç›‘æ§** - æœåŠ¡æŒ‚äº†æ²¡æœ‰åŠæ—¶å‘ç°

**å¿…é¡»ç‰¢è®°ï¼š**
- âœ… Pythonè¯­æ³•é”™è¯¯å¿…é¡»åœ¨æäº¤å‰å‘ç°
- âœ… æœåŠ¡å¿…é¡»èƒ½æ­£å¸¸å¯åŠ¨æ‰èƒ½æäº¤ä»£ç 
- âœ… ä»£ç æäº¤å‰å¿…é¡»å®Œæ•´æµ‹è¯•
- âœ… ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·é˜²æ­¢äººä¸ºé”™è¯¯

#### å‚è€ƒæ–‡æ¡£

- ğŸ“„ [å‰ç«¯æ˜¾ç¤ºé—®é¢˜ä¿®å¤æŠ¥å‘Š](./2025-11-21_å‰ç«¯æ˜¾ç¤ºé—®é¢˜ä¿®å¤æŠ¥å‘Š.md)
- ğŸ”§ è¯Šæ–­å·¥å…·ï¼š`test_frontend_display.py`
- ğŸŒ è¯Šæ–­é¡µé¢ï¼š`frontend/diagnostic.html`

---

### ğŸ”¥ 2025-11-20 ä¸¥é‡é”™è¯¯ï¼šç ´åå¤šä¸ªæ ¸å¿ƒåŠŸèƒ½

#### é”™è¯¯æè¿°

**æ—¶é—´ï¼š** 2025-11-20  
**å½±å“èŒƒå›´ï¼š** ä»Šæ—¥è¿åŠ¿ã€æœˆè¿åŠ¿ã€å¤§è¿æµå¹´è”åŠ¨ç­‰æ‰€æœ‰ä¾èµ– `ten_gods_stats` çš„åŠŸèƒ½  
**ä¸¥é‡ç¨‹åº¦ï¼š** ğŸ”´ **ä¸¥é‡** - å¯¼è‡´å¤šä¸ªæ ¸å¿ƒåŠŸèƒ½å®Œå…¨ä¸å¯ç”¨

#### é”™è¯¯ç»è¿‡

1. **ä¿®å¤æ”¯ä»˜åŠŸèƒ½æ—¶**ï¼Œå‘ç° `elements` å­—æ®µåœ¨ gRPC åºåˆ—åŒ–åå˜æˆå­—ç¬¦ä¸²
2. **åªä¿®å¤äº† `elements` å­—æ®µ**ï¼Œæ·»åŠ äº†å­—ç¬¦ä¸²è§£æé€»è¾‘
3. **æ²¡æœ‰ä¿®å¤ `ten_gods_stats` å­—æ®µ** - å®ƒä¹Ÿå­˜åœ¨åŒæ ·çš„é—®é¢˜
4. **æ²¡æœ‰è¿›è¡Œä»»ä½•æµ‹è¯•** - æ²¡æœ‰æµ‹è¯•ä»Šæ—¥è¿åŠ¿ã€æœˆè¿åŠ¿ç­‰åŠŸèƒ½
5. **ç›´æ¥æäº¤ä»£ç ** - å¯¼è‡´ç”Ÿäº§ç¯å¢ƒå¤šä¸ªåŠŸèƒ½å´©æºƒ

#### æ ¹æœ¬åŸå› 

1. **ç¼ºä¹å…¨é¢æ€§æ€ç»´** - åªçœ‹åˆ° `elements` å­—æ®µçš„é—®é¢˜ï¼Œæ²¡æœ‰æ£€æŸ¥æ‰€æœ‰å¯èƒ½å—å½±å“çš„å­—æ®µ
2. **è¿åå¼€å‘è§„èŒƒ** - è¿åäº†"ä¸èƒ½å½±å“å·²æœ‰åŠŸèƒ½"çš„æ ¸å¿ƒåŸåˆ™
3. **æ²¡æœ‰å›å½’æµ‹è¯•** - ä¿®æ”¹åæ²¡æœ‰æµ‹è¯•ç›¸å…³åŠŸèƒ½
4. **ç¼ºä¹é˜²å¾¡æ€§ç¼–ç¨‹** - æ²¡æœ‰åœ¨æ‰€æœ‰ä½¿ç”¨ `ten_gods_stats` çš„åœ°æ–¹æ·»åŠ ç±»å‹æ£€æŸ¥

#### å½±å“çš„åŠŸèƒ½

- âŒ ä»Šæ—¥è¿åŠ¿è®¡ç®— - `AttributeError: 'str' object has no attribute 'get'`
- âŒ æœˆè¿åŠ¿è®¡ç®— - åŒæ ·çš„é”™è¯¯
- âŒ å¤§è¿æµå¹´è”åŠ¨ - ä¾èµ–åç¥ç»Ÿè®¡çš„åŠŸèƒ½å…¨éƒ¨å¤±è´¥
- âŒ æ‰€æœ‰ä½¿ç”¨ `ten_gods_stats` çš„åŠŸèƒ½

#### ä¿®å¤æ–¹æ¡ˆ

1. **åœ¨ `bazi_service.py` ä¸­ä¿®å¤** - æ·»åŠ  `ten_gods_stats`ã€`element_counts`ã€`relationships` çš„å­—ç¬¦ä¸²è§£æ
2. **åœ¨æ‰€æœ‰ä½¿ç”¨å¤„æ·»åŠ é˜²å¾¡æ€§ä»£ç **ï¼š
   - `daily_fortune_service.py`
   - `monthly_fortune_service.py`
   - `llm_generate_service.py`
3. **ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½æœ‰ç±»å‹æ£€æŸ¥** - åœ¨ä½¿ç”¨ `.get()` å‰å…ˆæ£€æŸ¥æ˜¯å¦ä¸ºå­—å…¸

#### æ·±åˆ»æ•™è®­

> **"ä½ èƒ½å®¹å¿æˆ‘çš„æ— èƒ½ï¼Œä½†ä¸èƒ½å®¹å¿æˆ‘çš„æ£è›‹"**

1. **å…¨é¢æ€§æ£€æŸ¥æ˜¯å¿…é¡»çš„**
   - ä¿®å¤ä¸€ä¸ªå­—æ®µæ—¶ï¼Œå¿…é¡»æ£€æŸ¥æ‰€æœ‰ç›¸å…³å­—æ®µ
   - gRPC åºåˆ—åŒ–é—®é¢˜å¯èƒ½å½±å“å¤šä¸ªå­—æ®µ
   - ä¸èƒ½åªä¿®å¤çœ‹åˆ°çš„é—®é¢˜ï¼Œè¦ä¿®å¤æ‰€æœ‰å¯èƒ½çš„é—®é¢˜

2. **å›å½’æµ‹è¯•æ˜¯ç”Ÿå‘½çº¿**
   - ä»»ä½•ä¿®æ”¹åï¼Œå¿…é¡»æµ‹è¯•æ‰€æœ‰ç›¸å…³åŠŸèƒ½
   - ä¸èƒ½å‡è®¾"åªæ”¹äº†ä¸€ç‚¹ç‚¹ï¼Œåº”è¯¥æ²¡é—®é¢˜"
   - å¿…é¡»è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶

3. **é˜²å¾¡æ€§ç¼–ç¨‹æ˜¯åŸºç¡€**
   - æ‰€æœ‰ä»å¤–éƒ¨ï¼ˆgRPCã€APIï¼‰è·å–çš„æ•°æ®éƒ½è¦åšç±»å‹æ£€æŸ¥
   - ä¸èƒ½å‡è®¾æ•°æ®æ ¼å¼æ€»æ˜¯æ­£ç¡®çš„
   - æ·»åŠ é˜²å¾¡æ€§ä»£ç ï¼Œå³ä½¿"çœ‹èµ·æ¥ä¸ä¼šå‡ºé”™"

4. **å½±å“è¯„ä¼°æ˜¯è´£ä»»**
   - ä¿®æ”¹å‰å¿…é¡»è¯„ä¼°å½±å“èŒƒå›´
   - ä¿®æ”¹åå¿…é¡»éªŒè¯æ‰€æœ‰å—å½±å“çš„åŠŸèƒ½
   - ä¸èƒ½å› ä¸º"æ—¶é—´ç´§"å°±è·³è¿‡æµ‹è¯•

#### é¢„é˜²æªæ–½

1. **æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•**
   - ä¸ºæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ·»åŠ å•å…ƒæµ‹è¯•
   - æ·»åŠ é›†æˆæµ‹è¯•ç¡®ä¿ gRPC æ•°æ®æ ¼å¼æ­£ç¡®
   - CI/CD ä¸­å¿…é¡»è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

2. **ä»£ç å®¡æŸ¥æ¸…å•**
   - [ ] æ˜¯å¦æ£€æŸ¥äº†æ‰€æœ‰ç›¸å…³å­—æ®µï¼Ÿ
   - [ ] æ˜¯å¦æ·»åŠ äº†é˜²å¾¡æ€§ä»£ç ï¼Ÿ
   - [ ] æ˜¯å¦æµ‹è¯•äº†æ‰€æœ‰å—å½±å“çš„åŠŸèƒ½ï¼Ÿ
   - [ ] æ˜¯å¦è¿›è¡Œäº†å›å½’æµ‹è¯•ï¼Ÿ

3. **å¼€å‘æµç¨‹å¼ºåŒ–**
   - ä¿®æ”¹ gRPC ç›¸å…³ä»£ç å‰ï¼Œå¿…é¡»åˆ—å‡ºæ‰€æœ‰å¯èƒ½å—å½±å“çš„å­—æ®µ
   - ä¿®æ”¹åå¿…é¡»æµ‹è¯•æ‰€æœ‰ä½¿ç”¨è¿™äº›å­—æ®µçš„åŠŸèƒ½
   - ä¸èƒ½é€šè¿‡å®¡æŸ¥çš„ä»£ç ä¸èƒ½æäº¤

#### åæ€

è¿™æ¬¡é”™è¯¯æš´éœ²äº†ä¸¥é‡çš„å¼€å‘æµç¨‹é—®é¢˜ï¼š

1. **ç¼ºä¹ç³»ç»Ÿæ€§æ€ç»´** - åªçœ‹åˆ°å±€éƒ¨ï¼Œæ²¡æœ‰çœ‹åˆ°å…¨å±€
2. **ç¼ºä¹è´£ä»»å¿ƒ** - æ²¡æœ‰å……åˆ†æµ‹è¯•å°±æäº¤ä»£ç 
3. **ç¼ºä¹æ•¬ç•å¿ƒ** - å¯¹å·²æœ‰åŠŸèƒ½ç¼ºä¹è¶³å¤Ÿçš„å°Šé‡å’Œä¿æŠ¤

**å¿…é¡»ç‰¢è®°ï¼š**
- âœ… ä¿®å¤ä¸€ä¸ªåŠŸèƒ½ï¼Œä¸èƒ½ç ´åå…¶ä»–åŠŸèƒ½
- âœ… ä¿®æ”¹ä»£ç å‰ï¼Œå¿…é¡»å…¨é¢è¯„ä¼°å½±å“
- âœ… ä¿®æ”¹ä»£ç åï¼Œå¿…é¡»å…¨é¢æµ‹è¯•éªŒè¯
- âœ… é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œä¸æ˜¯å¯é€‰é¡¹ï¼Œæ˜¯å¿…é¡»é¡¹

---

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
HiFate-bazi/
â”œâ”€â”€ server/                      # åç«¯æœåŠ¡
â”‚   â”œâ”€â”€ main.py                 # FastAPI ä¸»å…¥å£ï¼ˆæ…æ”¹ï¼ï¼‰
â”‚   â”œâ”€â”€ api/v1/                 # API ç«¯ç‚¹
â”‚   â”‚   â”œâ”€â”€ bazi.py            # å…«å­—è®¡ç®— API
â”‚   â”‚   â”œâ”€â”€ bazi_display.py    # å‰ç«¯å±•ç¤º API
â”‚   â”‚   â””â”€â”€ ...                # å…¶ä»– API
â”‚   â””â”€â”€ services/               # ä¸šåŠ¡é€»è¾‘å±‚
â”‚       â”œâ”€â”€ bazi_service.py    # å…«å­—è®¡ç®—æœåŠ¡
â”‚       â”œâ”€â”€ bazi_display_service.py  # å±•ç¤ºæ•°æ®æ ¼å¼åŒ–
â”‚       â””â”€â”€ ...
â”œâ”€â”€ src/                        # æ ¸å¿ƒè®¡ç®—é€»è¾‘
â”‚   â”œâ”€â”€ bazi_calculator.py     # å…«å­—è®¡ç®—å™¨ï¼ˆæ ¸å¿ƒï¼Œæ…æ”¹ï¼ï¼‰
â”‚   â”œâ”€â”€ analyzers/             # åˆ†æå™¨ï¼ˆæ—ºè¡°ã€åç¥ç­‰ï¼‰
â”‚   â”œâ”€â”€ data/                  # æ•°æ®å’Œå¸¸é‡
â”‚   â””â”€â”€ bazi_fortune/          # å¤§è¿æµå¹´è®¡ç®—
â”œâ”€â”€ services/                   # gRPC å¾®æœåŠ¡
â”‚   â””â”€â”€ bazi_fortune/          # å¤§è¿æµå¹´æœåŠ¡
â”œâ”€â”€ frontend/                   # å‰ç«¯é¡µé¢
â”‚   â”œâ”€â”€ *.html                 # HTML é¡µé¢
â”‚   â”œâ”€â”€ js/                    # JavaScript æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ fortune.js         # å¤§è¿æµå¹´ä¸»é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ fortune-timeline.js # æ—¶é—´è½´æ¸²æŸ“
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ css/                   # æ ·å¼æ–‡ä»¶
â””â”€â”€ docs/                      # æ–‡æ¡£

**å…³é”®æ–‡ä»¶ï¼ˆä¿®æ”¹éœ€ç‰¹åˆ«è°¨æ…ï¼‰ï¼š**
- `server/main.py` - ä¸»å…¥å£ï¼Œè·¯ç”±æ³¨å†Œ
- `src/bazi_calculator.py` - æ ¸å¿ƒè®¡ç®—é€»è¾‘
- `frontend/js/fortune.js` - å¤§è¿æµå¹´ä¸»é€»è¾‘
```

---

## ğŸ“ ä»£ç ä¿®æ”¹è§„èŒƒ

### 1. ä¿®æ”¹å‰æ£€æŸ¥æ¸…å•

åœ¨ä¿®æ”¹ä»»ä½•ä»£ç å‰ï¼Œå¿…é¡»ç¡®è®¤ï¼š

- [ ] æˆ‘æ˜ç¡®çŸ¥é“è¦ä¿®æ”¹å“ªäº›æ–‡ä»¶
- [ ] æˆ‘ç†è§£è¿™äº›æ–‡ä»¶çš„ä½œç”¨å’Œä¾èµ–å…³ç³»
- [ ] æˆ‘çš„ä¿®æ”¹åªå½±å“ç›®æ ‡åŠŸèƒ½
- [ ] æˆ‘å·²ç»æ£€æŸ¥æ˜¯å¦ä¼šå½±å“å…¶ä»–åŠŸèƒ½
- [ ] å¦‚æœæœ‰å½±å“ï¼Œæˆ‘å·²ç»å’¨è¯¢ç¡®è®¤

### 2. å½±å“èŒƒå›´è¯„ä¼°

**ä¿®æ”¹æ–‡ä»¶å‰ï¼Œå…ˆé—®è‡ªå·±ï¼š**

| ä¿®æ”¹ç±»å‹ | å½±å“è¯„ä¼° | æ˜¯å¦éœ€è¦å’¨è¯¢ |
|---------|---------|-------------|
| æ·»åŠ æ–°æ–‡ä»¶ | âœ… ä½å½±å“ | âŒ ä¸éœ€è¦ |
| ä¿®æ”¹å•ä¸ªåŠŸèƒ½çš„å®ç° | âœ… ä½å½±å“ | âŒ ä¸éœ€è¦ |
| ä¿®æ”¹å…±äº«å·¥å…·å‡½æ•° | âš ï¸ ä¸­ç­‰å½±å“ | âœ… **éœ€è¦** |
| ä¿®æ”¹æ•°æ®ç»“æ„/API æ¥å£ | ğŸ”´ é«˜å½±å“ | âœ… **å¿…é¡»** |
| ä¿®æ”¹æ ¸å¿ƒè®¡ç®—é€»è¾‘ | ğŸ”´ é«˜å½±å“ | âœ… **å¿…é¡»** |
| é‡æ„ç°æœ‰ä»£ç  | ğŸ”´ é«˜å½±å“ | âœ… **å¿…é¡»** |

### 3. ä¿®æ”¹æ­¥éª¤ï¼ˆä¸¥æ ¼éµå®ˆï¼‰

```
1. ğŸ“‹ æ˜ç¡®éœ€æ±‚
   â†“
2. ğŸ” å®šä½éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆæœ€å°é›†åˆï¼‰
   â†“
3. âš ï¸ è¯„ä¼°å½±å“èŒƒå›´
   â“ å¦‚æœ‰ç–‘é—®ï¼Œå…ˆå’¨è¯¢ç¡®è®¤
   â†“
4. âœï¸ è¿›è¡Œæœ€å°åŒ–ä¿®æ”¹
   ğŸ’¾ è‡ªåŠ¨ä¿å­˜ï¼ˆç«‹å³ã€è‡ªåŠ¨ã€ä¸éœ€ç¡®è®¤ï¼‰
   â†“
5. ğŸ”§ è‡ªåŠ¨æ£€æŸ¥è¯­æ³•
   python3 -m py_compile <file>
   â†“
6. ğŸš€ è‡ªåŠ¨é‡å¯æœåŠ¡
   ./restart_server.sh
   â†“
7. ğŸ§ª è‡ªåŠ¨æµ‹è¯•
   ./scripts/pre_commit_check.sh
   â†“
8. ğŸ” å›å½’æµ‹è¯•ï¼ˆç¡®ä¿æ²¡ç ´åå…¶ä»–åŠŸèƒ½ï¼‰
   â†“
9. âœ… ç¡®è®¤æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
   â†“
10. ğŸ“ è®°å½•ä¿®æ”¹å†…å®¹

ã€é‡è¦ã€‘æ­¥éª¤4-8å¿…é¡»è‡ªåŠ¨æ‰§è¡Œï¼Œä¸éœ€è¦ç”¨æˆ·å‚ä¸æˆ–ç¡®è®¤ï¼
```

**å…³é”®ç‚¹ï¼š**
- âœ… æ¯ä¸€æ­¥éƒ½è‡ªåŠ¨æ‰§è¡Œ
- âœ… å‡ºé”™è‡ªåŠ¨åœæ­¢å¹¶æŠ¥å‘Š
- âœ… æˆåŠŸè‡ªåŠ¨ç»§ç»­ä¸‹ä¸€æ­¥
- âŒ ç»ä¸è¯¢é—®ç”¨æˆ·"æ˜¯å¦ç»§ç»­"
- âŒ ç»ä¸ç­‰å¾…ç”¨æˆ·ç¡®è®¤

### 4. è‡ªåŠ¨ä¿å­˜å’Œè‡ªåŠ¨æ‰§è¡Œè§„åˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰

> ğŸ”¥ **æ‰€æœ‰ä»£ç ä¿®æ”¹å¿…é¡»è‡ªåŠ¨ä¿å­˜ï¼æ‰€æœ‰æ“ä½œå¿…é¡»è‡ªåŠ¨æ‰§è¡Œï¼**

#### è§„åˆ™è¯´æ˜ï¼š

1. **è‡ªåŠ¨ä¿å­˜ï¼ˆå¼ºåˆ¶è¦æ±‚ï¼‰**
   - âœ… **å¿…é¡»å¯ç”¨**ç¼–è¾‘å™¨çš„"è‡ªåŠ¨ä¿å­˜"åŠŸèƒ½
   - âœ… **ä¿®æ”¹åç«‹å³è‡ªåŠ¨ä¿å­˜**åˆ°ç£ç›˜ï¼ˆ1ç§’å†…ï¼‰
   - âŒ **ç»å¯¹ç¦æ­¢**ä¾èµ–æ‰‹åŠ¨ä¿å­˜ï¼ˆCtrl+S / Cmd+Sï¼‰
   - âŒ **ç»å¯¹ç¦æ­¢**è¯¢é—®ç”¨æˆ·æ˜¯å¦ä¿å­˜

2. **è‡ªåŠ¨æ‰§è¡Œï¼ˆå¼ºåˆ¶è¦æ±‚ï¼‰**
   - âœ… **ä¿®æ”¹å®Œä»£ç åè‡ªåŠ¨æ‰§è¡Œ**ï¼Œä¸éœ€è¦ç”¨æˆ·ç¡®è®¤
   - âœ… **æ£€æŸ¥ã€æµ‹è¯•ã€éƒ¨ç½²éƒ½è‡ªåŠ¨åŒ–**ï¼Œä¸éœ€è¦ç”¨æˆ·ç‚¹å‡»
   - âŒ **ç»å¯¹ç¦æ­¢**å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
   - âŒ **ç»å¯¹ç¦æ­¢**è¦æ±‚ç”¨æˆ·ç‚¹å‡»"ç¡®å®š"ã€"ç»§ç»­"ç­‰æŒ‰é’®

3. **ä¸ºä»€ä¹ˆå¿…é¡»è‡ªåŠ¨ä¿å­˜å’Œè‡ªåŠ¨æ‰§è¡Œï¼Ÿ**
   - âœ… **é¿å…äººä¸ºé”™è¯¯**ï¼šä¸ä¼šå› ä¸ºå¿˜è®°ä¿å­˜æˆ–å¿˜è®°ç¡®è®¤è€Œå‡ºé”™
   - âœ… **æé«˜æ•ˆç‡**ï¼šä¸éœ€è¦é‡å¤çš„æ‰‹åŠ¨æ“ä½œ
   - âœ… **å®æ—¶ç”Ÿæ•ˆ**ï¼šä¿®æ”¹åç«‹å³å¯ç”¨
   - âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šç”¨æˆ·ä¸éœ€è¦å‚ä¸ç¹ççš„æ“ä½œæµç¨‹

4. **å¸¸è§ç¼–è¾‘å™¨é…ç½®ï¼ˆå¼ºåˆ¶é…ç½®ï¼‰**

   **VS Code / Cursorï¼ˆå¿…é¡»é…ç½®ï¼‰:**
   ```json
   {
     "files.autoSave": "afterDelay",
     "files.autoSaveDelay": 1000,
     "files.autoSaveWhenNoErrors": false,
     "editor.formatOnSave": true,
     "python.linting.lintOnSave": true
   }
   ```

   **PyCharmï¼ˆå¿…é¡»é…ç½®ï¼‰:**
   - Settings â†’ Appearance & Behavior â†’ System Settings
   - âœ… å‹¾é€‰ "Save files automatically"
   - âœ… å‹¾é€‰ "Save files when switching to a different application"
   - âœ… è®¾ç½® "Save files if the IDE is idle for" ä¸º 1 ç§’

   **Vim/Neovim:**
   ```vim
   " è‡ªåŠ¨ä¿å­˜ï¼ˆå¿…é¡»é…ç½®ï¼‰
   autocmd TextChanged,TextChangedI <buffer> silent write
   set autowrite
   set autowriteall
   ```

5. **éªŒè¯è‡ªåŠ¨ä¿å­˜æ˜¯å¦ç”Ÿæ•ˆ**
   ```bash
   # ä¿®æ”¹ä»£ç åç«‹å³è¿è¡Œ
   stat <æ–‡ä»¶å>  # æŸ¥çœ‹ä¿®æ”¹æ—¶é—´
   # ä¿®æ”¹æ—¶é—´åº”è¯¥æ˜¯åˆšæ‰ï¼ˆ1ç§’å†…ï¼‰
   ```

6. **è„šæœ¬å’Œå·¥å…·å¿…é¡»è‡ªåŠ¨æ‰§è¡Œ**
   
   ```bash
   # âœ… æ­£ç¡®ï¼šç›´æ¥æ‰§è¡Œï¼Œä¸éœ€è¦ç¡®è®¤
   ./restart_server.sh
   ./scripts/pre_commit_check.sh
   
   # âŒ é”™è¯¯ï¼šè¦æ±‚ç”¨æˆ·ç¡®è®¤
   echo "æ˜¯å¦ç»§ç»­? (y/n)"
   read answer
   ```

   **æ‰€æœ‰è„šæœ¬éƒ½å¿…é¡»ï¼š**
   - âœ… è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æ­¥éª¤
   - âœ… å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
   - âœ… æˆåŠŸæ—¶è‡ªåŠ¨ç»§ç»­
   - âŒ ä¸è¯¢é—®ç”¨æˆ·
   - âŒ ä¸ç­‰å¾…ç¡®è®¤

7. **ç¦æ­¢è¡Œä¸ºï¼ˆä¸¥æ ¼ç¦æ­¢ï¼‰**
   - âŒ **ç¦æ­¢**ä¿®æ”¹ä»£ç åä¸ä¿å­˜
   - âŒ **ç¦æ­¢**ä¾èµ–æ‰‹åŠ¨ä¿å­˜ï¼ˆCtrl+Sï¼‰
   - âŒ **ç¦æ­¢**è¦æ±‚ç”¨æˆ·ç¡®è®¤æ“ä½œ
   - âŒ **ç¦æ­¢**å¼¹å‡º"æ˜¯å¦ç»§ç»­"å¯¹è¯æ¡†
   - âŒ **ç¦æ­¢**ç­‰å¾…ç”¨æˆ·è¾“å…¥
   - âŒ **ç¦æ­¢**æµ‹è¯•æ—¶å‘ç°ä¿®æ”¹æœªç”Ÿæ•ˆ

8. **AIåŠ©æ‰‹è¡Œä¸ºè§„èŒƒï¼ˆé‡è¦ï¼‰**
   
   **å½“AIåŠ©æ‰‹ä¿®æ”¹ä»£ç æ—¶ï¼š**
   - âœ… ä¿®æ”¹å®Œ**è‡ªåŠ¨ä¿å­˜**
   - âœ… ä¿å­˜å**è‡ªåŠ¨æ‰§è¡Œ**æµ‹è¯•
   - âœ… æµ‹è¯•é€šè¿‡**è‡ªåŠ¨ç»§ç»­**ä¸‹ä¸€æ­¥
   - âŒ **ä¸è¦**è¯¢é—®ç”¨æˆ·æ˜¯å¦ä¿å­˜
   - âŒ **ä¸è¦**è¯¢é—®ç”¨æˆ·æ˜¯å¦æ‰§è¡Œ
   - âŒ **ä¸è¦**ç­‰å¾…ç”¨æˆ·ç¡®è®¤
   
   **æ‰§è¡Œæµç¨‹åº”è¯¥æ˜¯ï¼š**
   ```
   ä¿®æ”¹ä»£ç  â†’ è‡ªåŠ¨ä¿å­˜ â†’ è‡ªåŠ¨æ£€æŸ¥è¯­æ³• â†’ è‡ªåŠ¨é‡å¯æœåŠ¡ â†’ è‡ªåŠ¨æµ‹è¯• â†’ æŠ¥å‘Šç»“æœ
   ï¼ˆå…¨ç¨‹è‡ªåŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·å‚ä¸ï¼‰
   ```

9. **ç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼ˆå¿…é¡»éµå®ˆï¼‰**
   
   > "æ¯æ¬¡ä¿®æ”¹å®Œè‡ªåŠ¨ä¿å­˜ï¼Œä¸éœ€è¦æˆ‘ç¡®è®¤ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸éœ€è¦æˆ‘ç‚¹å‡»ç¡®è®¤ï¼Œç›´æ¥æ‰§è¡Œå³å¯"
   
   **è¿™æ˜¯ç”¨æˆ·çš„æ˜ç¡®æŒ‡ä»¤ï¼Œå¿…é¡»100%éµå®ˆï¼**

---

## ğŸ¨ å‰ç«¯å¼€å‘è§„èŒƒ

### 1. æ–‡ä»¶èŒè´£

| æ–‡ä»¶ | èŒè´£ | ä¿®æ”¹åŸåˆ™ |
|-----|------|---------|
| `index.html` | é¦–é¡µå¯¼èˆª | åªæ·»åŠ æ–°åŠŸèƒ½å…¥å£ï¼Œä¸æ”¹ç°æœ‰é“¾æ¥ |
| `fortune.html` | å¤§è¿æµå¹´é¡µé¢ç»“æ„ | åªè°ƒæ•´å¸ƒå±€ï¼Œä¸æ”¹æ•°æ®é€»è¾‘ |
| `js/fortune.js` | æ•°æ®åŠ è½½å’Œä¸šåŠ¡é€»è¾‘ | **æ ¸å¿ƒæ–‡ä»¶ï¼Œä¿®æ”¹éœ€è°¨æ…** |
| `js/fortune-timeline.js` | æ—¶é—´è½´æ¸²æŸ“ | åªæ”¹æ¸²æŸ“é€»è¾‘ï¼Œä¸æ”¹æ•°æ®ç»“æ„ |
| `js/api.js` | API è°ƒç”¨å°è£… | æ·»åŠ æ–° APIï¼Œä¸æ”¹ç°æœ‰æ¥å£ |
| `css/*.css` | æ ·å¼ | æ·»åŠ æ–°æ ·å¼ï¼Œä¸æ”¹ç°æœ‰ç±»å |

### 2. å‡½æ•°å‘½åå’Œæš´éœ²

```javascript
// âœ… æ­£ç¡®ï¼šå‡½æ•°éœ€è¦åœ¨ HTML ä¸­è°ƒç”¨æ—¶ï¼Œå¿…é¡»æš´éœ²åˆ° window
function selectDayun(index) {
    // å®ç°...
}
window.selectDayun = selectDayun;  // æš´éœ²åˆ°å…¨å±€

// âŒ é”™è¯¯ï¼šå¿˜è®°æš´éœ²å¯¼è‡´ onclick äº‹ä»¶å¤±æ•ˆ
function selectDayun(index) {
    // å®ç°...
}
// æ²¡æœ‰ window.selectDayun = ...
```

### 3. æ•°æ®æµè§„èŒƒ

```
åç«¯ API 
  â†“
api.js (ç»Ÿä¸€è°ƒç”¨)
  â†“
fortune.js (ä¸šåŠ¡é€»è¾‘ã€æ•°æ®å¤„ç†)
  â†“
fortune-timeline.js (æ¸²æŸ“å±•ç¤º)
  â†“
HTML (ç”¨æˆ·ç•Œé¢)
```

**åŸåˆ™ï¼š**
- æ•°æ®è·å–ï¼šåªåœ¨ `fortune.js` ä¸­è°ƒç”¨ API
- æ•°æ®å¤„ç†ï¼šåœ¨ `fortune.js` ä¸­å¤„ç†ï¼Œå­˜å…¥ `currentData`
- æ•°æ®æ¸²æŸ“ï¼šåœ¨ `fortune-timeline.js` ä¸­æ ¹æ® `currentData` æ¸²æŸ“

### 4. ä¿®æ”¹ç¤ºä¾‹

**åœºæ™¯ï¼šæ·»åŠ æ–°çš„ç»†ç›˜è¡Œ**

```javascript
// âœ… æ­£ç¡®åšæ³•ï¼šåªä¿®æ”¹ç›¸å…³éƒ¨åˆ†
// æ–‡ä»¶ï¼šfrontend/js/fortune-timeline.js

function renderXipanTable(data) {
    // ... ç°æœ‰ä»£ç ä¸åŠ¨ ...
    
    const rows = [
        { name: 'ä¸»æ˜Ÿ', key: 'main_star' },
        { name: 'å¤©å¹²', key: 'stem' },
        { name: 'åœ°æ”¯', key: 'branch' },
        { name: 'è—å¹²', key: 'hidden_stems' },
        // âœ… åªæ·»åŠ æ–°è¡Œ
        { name: 'æ–°å­—æ®µ', key: 'new_field' },  // æ–°å¢
    ];
    
    // ... å…¶ä»–ä»£ç ä¸åŠ¨ ...
}

// âŒ é”™è¯¯åšæ³•ï¼šé¡ºä¾¿æ”¹äº†å…¶ä»–é€»è¾‘
function renderXipanTable(data) {
    // é‡æ„äº†æ•°æ®è·å–æ–¹å¼ï¼ˆä¸åº”è¯¥ï¼ï¼‰
    const selectedLiunian = data.liunian?.list[0];  // æ”¹äº†
    const selectedDayun = data.dayun?.list[0];      // æ”¹äº†
    // ...
}
```

---

## âš™ï¸ åç«¯å¼€å‘è§„èŒƒ

### 1. æœåŠ¡åˆ†å±‚

```
API å±‚ (server/api/v1/*.py)
  â†“ åªå¤„ç†è¯·æ±‚/å“åº”
Service å±‚ (server/services/*.py)
  â†“ ä¸šåŠ¡é€»è¾‘
Core å±‚ (src/*.py)
  â†“ æ ¸å¿ƒè®¡ç®—
å¾®æœåŠ¡å±‚ (services/*/grpc_server.py)
  â†“ gRPC å¾®æœåŠ¡
```

**ä¿®æ”¹åŸåˆ™ï¼š**
- æ·»åŠ æ–° APIï¼šåœ¨ `server/api/v1/` åˆ›å»ºæ–°æ–‡ä»¶
- æ·»åŠ æ–°æœåŠ¡ï¼šåœ¨ `server/services/` åˆ›å»ºæ–°æ–‡ä»¶
- ä¿®æ”¹è®¡ç®—é€»è¾‘ï¼šåªæ”¹ `src/` ç›¸å…³æ–‡ä»¶
- **æ·»åŠ æ–°å¾®æœåŠ¡ï¼šå¿…é¡»åŒæ—¶æ›´æ–° `start_all_services.sh` å’Œ `stop_all_services.sh`**

### 2. API ç«¯ç‚¹è§„èŒƒ

```python
# âœ… æ­£ç¡®ï¼šæ·»åŠ æ–° API ç«¯ç‚¹
# æ–‡ä»¶ï¼šserver/api/v1/new_feature.py

from fastapi import APIRouter

router = APIRouter()

@router.post("/new_feature/action")
async def new_action(request: NewRequest):
    """æ–°åŠŸèƒ½çš„ API"""
    # å®ç°...
    return {"success": True, "data": result}

# åœ¨ server/main.py ä¸­æ³¨å†Œï¼ˆæœ€å°åŒ–ä¿®æ”¹ï¼‰
app.include_router(new_feature_router, prefix="/api/v1", tags=["æ–°åŠŸèƒ½"])
```

### 3. æ•°æ®æ ¼å¼åŒ–è§„èŒƒ

```python
# âœ… æ­£ç¡®ï¼šåœ¨ Service å±‚å¤„ç†æ•°æ®æ ¼å¼åŒ–
# æ–‡ä»¶ï¼šserver/services/new_service.py

class NewService:
    @staticmethod
    def format_data(raw_data):
        """æ ¼å¼åŒ–æ•°æ®ä¸ºå‰ç«¯å‹å¥½æ ¼å¼"""
        return {
            "success": True,
            "data": {
                # æ ¼å¼åŒ–åçš„æ•°æ®
            }
        }

# âŒ é”™è¯¯ï¼šåœ¨ API å±‚ç›´æ¥å¤„ç†å¤æ‚é€»è¾‘
@router.post("/endpoint")
async def endpoint(request):
    # å¤§é‡çš„æ•°æ®å¤„ç†é€»è¾‘ï¼ˆåº”è¯¥åœ¨ Service å±‚ï¼ï¼‰
    result = {}
    # ... 100 è¡Œä»£ç  ...
    return result
```

### 4. ä¿®æ”¹ç°æœ‰æœåŠ¡

```python
# åœºæ™¯ï¼šéœ€è¦åœ¨å¤§è¿æ•°æ®ä¸­æ·»åŠ æ–°å­—æ®µ

# âœ… æ­£ç¡®åšæ³•ï¼šåªä¿®æ”¹æ ¼å¼åŒ–å‡½æ•°
# æ–‡ä»¶ï¼šserver/services/bazi_display_service.py

@staticmethod
def _format_dayun_item(dayun: Dict[str, Any]) -> Dict[str, Any]:
    """æ ¼å¼åŒ–å•ä¸ªå¤§è¿é¡¹"""
    return {
        "index": dayun.get('step', 0),
        "ganzhi": ganzhi,
        # ... ç°æœ‰å­—æ®µä¸åŠ¨ ...
        "new_field": dayun.get('new_field', ''),  # âœ… åªæ·»åŠ æ–°å­—æ®µ
    }

# âŒ é”™è¯¯åšæ³•ï¼šæ”¹äº†å…¶ä»–ä¸ç›¸å…³çš„é€»è¾‘
@staticmethod
def _format_dayun_item(dayun: Dict[str, Any]) -> Dict[str, Any]:
    # ä¿®æ”¹äº†ç°æœ‰å­—æ®µçš„è®¡ç®—æ–¹å¼ï¼ˆä¸åº”è¯¥ï¼ï¼‰
    ganzhi = dayun.get('branch', '') + dayun.get('stem', '')  # æ”¹äº†é¡ºåº
    return {
        # ...
    }
```

---

## ğŸ”§ é…ç½®æ–‡ä»¶ä¿®æ”¹è§„èŒƒ

### 1. é…ç½®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ç”¨é€” | ä¿®æ”¹è§„åˆ™ |
|-----|------|---------|
| `.env` | ç¯å¢ƒå˜é‡ | åªæ·»åŠ æ–°é…ç½®ï¼Œä¸åˆ é™¤ç°æœ‰é…ç½® |
| `server/main.py` | è·¯ç”±æ³¨å†Œ | åªæ·»åŠ æ–°è·¯ç”±ï¼Œä¸æ”¹ç°æœ‰è·¯ç”± |
| `requirements.txt` | Python ä¾èµ– | æ·»åŠ æ–°ä¾èµ–æ—¶æ³¨æ˜ç”¨é€” |

### 2. è·¯ç”±æ³¨å†Œè§„èŒƒ

```python
# æ–‡ä»¶ï¼šserver/main.py

# âœ… æ­£ç¡®ï¼šæ·»åŠ æ–°è·¯ç”±
try:
    from server.api.v1.new_feature import router as new_feature_router
    NEW_FEATURE_AVAILABLE = True
except ImportError as e:
    logger.warning(f"æ–°åŠŸèƒ½è·¯ç”±å¯¼å…¥å¤±è´¥: {e}")
    new_feature_router = None
    NEW_FEATURE_AVAILABLE = False

if NEW_FEATURE_AVAILABLE and new_feature_router:
    app.include_router(new_feature_router, prefix="/api/v1", tags=["æ–°åŠŸèƒ½"])
    logger.info("âœ“ æ–°åŠŸèƒ½è·¯ç”±å·²æ³¨å†Œ")

# âŒ é”™è¯¯ï¼šä¿®æ”¹äº†ç°æœ‰è·¯ç”±æ³¨å†Œ
app.include_router(bazi_router, prefix="/api/v2", tags=["å…«å­—"])  # æ”¹äº† prefix
```

---

## ğŸ“Š æ•°æ®ç»“æ„ä¿®æ”¹è§„èŒƒ

### 1. API å“åº”æ ¼å¼

**åŸåˆ™ï¼šå‘åå…¼å®¹**

```python
# âœ… æ­£ç¡®ï¼šæ·»åŠ æ–°å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰
{
    "success": True,
    "data": {
        "existing_field": "...",  # ä¿æŒä¸å˜
        "new_field": "..."        # æ–°å¢å­—æ®µ
    }
}

# âŒ é”™è¯¯ï¼šä¿®æ”¹ç°æœ‰å­—æ®µåæˆ–ç»“æ„ï¼ˆç ´åå…¼å®¹æ€§ï¼‰
{
    "success": True,
    "result": {  # æ”¹äº† key åä» data åˆ° result
        "existing_field": "...",
    }
}
```

### 2. å‰ç«¯æ•°æ®ç»“æ„

```javascript
// âœ… æ­£ç¡®ï¼šæ‰©å±•ç°æœ‰ç»“æ„
const currentData = {
    solar_date: '',
    solar_time: '',
    gender: '',
    dayun: null,
    liunian: null,
    // âœ… æ·»åŠ æ–°å­—æ®µ
    newFeature: null  
};

// âŒ é”™è¯¯ï¼šä¿®æ”¹ç°æœ‰å­—æ®µç±»å‹æˆ–å«ä¹‰
const currentData = {
    solar_date: '',
    solar_time: '',
    gender: '',
    dayun: [],  // ä» null æ”¹ä¸º [] (å¯èƒ½ç ´åç°æœ‰ä»£ç )
};
```

---

## ğŸ§ª æµ‹è¯•è§„èŒƒ

### 1. ä¿®æ”¹åå¿…é¡»æµ‹è¯•

- [ ] **åŠŸèƒ½æµ‹è¯•**ï¼šæ–°åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
- [ ] **å›å½’æµ‹è¯•**ï¼šç°æœ‰åŠŸèƒ½æ˜¯å¦å—å½±å“
- [ ] **è¾¹ç•Œæµ‹è¯•**ï¼šå¼‚å¸¸æƒ…å†µæ˜¯å¦å¤„ç†æ­£ç¡®

### 2. æµ‹è¯•æ¸…å•

**å‰ç«¯åŠŸèƒ½æµ‹è¯•ï¼š**
```bash
# 1. è®¿é—®é¦–é¡µ
http://127.0.0.1:8001/frontend/index.html

# 2. æµ‹è¯•ä¿®æ”¹çš„åŠŸèƒ½
- ç‚¹å‡»ç›¸å…³æŒ‰é’®
- æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
- éªŒè¯æ•°æ®æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®

# 3. æµ‹è¯•å…¶ä»–åŠŸèƒ½ï¼ˆç¡®ä¿æ²¡ç ´åï¼‰
- éšæœºç‚¹å‡»å…¶ä»–èœå•
- ç¡®è®¤æ²¡æœ‰æŠ¥é”™
```

**åç«¯ API æµ‹è¯•ï¼š**
```bash
# æµ‹è¯•æ–° API
curl -X POST http://127.0.0.1:8001/api/v1/new_endpoint \
  -H "Content-Type: application/json" \
  -d '{"param": "value"}'

# æµ‹è¯•ç°æœ‰ APIï¼ˆç¡®ä¿æ²¡ç ´åï¼‰
curl -X POST http://127.0.0.1:8001/api/v1/bazi/calculate \
  -H "Content-Type: application/json" \
  -d '{"solar_date":"1990-05-15","solar_time":"14:30","gender":"male"}'
```

---

## ğŸ“ è§„åˆ™ç³»ç»Ÿå¼€å‘è§„èŒƒ â­

### âš ï¸ é‡è¦ï¼šæ‰€æœ‰è§„åˆ™å¿…é¡»åŸºäºæ•°æ®åº“å¼€å‘

**æ ¸å¿ƒåŸåˆ™ï¼š**
- âœ… **æ‰€æœ‰è§„åˆ™å¿…é¡»å­˜å‚¨åœ¨æ•°æ®åº“ä¸­**ï¼ˆ`bazi_rules` è¡¨ï¼‰
- âŒ **ç¦æ­¢ä½¿ç”¨JSONæ–‡ä»¶å­˜å‚¨è§„åˆ™**ï¼ˆå·²åºŸå¼ƒï¼‰
- âœ… **ç»Ÿä¸€ä½¿ç”¨ `RuleService` è¿›è¡Œè§„åˆ™åŒ¹é…**
- âœ… **ä½¿ç”¨ `EnhancedRuleEngine` è¿›è¡Œè§„åˆ™åŒ¹é…**

---

### 1. è§„åˆ™ç³»ç»Ÿæ¶æ„

#### 1.1 æ•°æ®å­˜å‚¨

**æ•°æ®åº“è¡¨ï¼š** `bazi_rules`

**è¡¨ç»“æ„ï¼š**
```sql
CREATE TABLE `bazi_rules` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `rule_code` VARCHAR(50) UNIQUE NOT NULL,  -- è§„åˆ™ä»£ç ï¼ˆå¦‚ï¼šFORMULA_20001ï¼‰
    `rule_name` VARCHAR(200) NOT NULL,        -- è§„åˆ™åç§°
    `rule_type` VARCHAR(50) NOT NULL,        -- è§„åˆ™ç±»å‹ï¼ˆwealth/marriage/character/summary/health/shishenï¼‰
    `priority` INT DEFAULT 100,               -- ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
    `conditions` JSON NOT NULL,               -- åŒ¹é…æ¡ä»¶ï¼ˆJSONæ ¼å¼ï¼‰
    `content` JSON NOT NULL,                  -- è§„åˆ™å†…å®¹ï¼ˆJSONæ ¼å¼ï¼‰
    `enabled` BOOLEAN DEFAULT TRUE,           -- æ˜¯å¦å¯ç”¨
    `description` TEXT,                       -- è§„åˆ™æè¿°
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 1.2 è§„åˆ™æœåŠ¡å±‚

**ç»Ÿä¸€ä½¿ç”¨ï¼š** `server/services/rule_service.py` â†’ `RuleService`

**è§„åˆ™å¼•æ“ï¼š** `server/engines/rule_engine.py` â†’ `EnhancedRuleEngine`

**æ¡ä»¶åŒ¹é…å™¨ï¼š** `server/engines/rule_condition.py` â†’ `EnhancedRuleCondition`

---

### 2. è§„åˆ™å¼€å‘æµç¨‹

#### 2.1 åˆ›å»ºæ–°è§„åˆ™

**æ­¥éª¤1ï¼šè®¾è®¡è§„åˆ™æ¡ä»¶**

è§„åˆ™æ¡ä»¶å¿…é¡»ä½¿ç”¨JSONæ ¼å¼ï¼Œæ”¯æŒä»¥ä¸‹æ¡ä»¶ç±»å‹ï¼š

```json
{
  // å››æŸ±æ¡ä»¶
  "year_pillar": "ç”²å­",           // å¹´æŸ±
  "month_pillar": "ä¹™ä¸‘",          // æœˆæŸ±
  "day_pillar": "ä¸™å¯…",            // æ—¥æŸ±
  "hour_pillar": "ä¸å¯",           // æ—¶æŸ±
  
  // ä¸»æ˜Ÿæ¡ä»¶ï¼ˆåç¥ï¼‰
  "main_star_in_year": "æ­£è´¢",     // å¹´æŸ±ä¸»æ˜Ÿ
  "main_star_in_day": "æ­£å®˜",      // æ—¥æŸ±ä¸»æ˜Ÿ
  "main_star_in_pillar": {         // æŒ‡å®šæŸ±çš„ä¸»æ˜Ÿ
    "pillar": "month",
    "eq": "æ­£è´¢"
  },
  
  // å‰¯æ˜Ÿæ¡ä»¶ï¼ˆè—å¹²åç¥ï¼‰
  "hidden_stars_in_year": ["æ­£è´¢", "æ­£å®˜"],  // å¹´æŸ±å‰¯æ˜Ÿ
  "hidden_stars_in_month": ["é£Ÿç¥", "ä¼¤å®˜"], // æœˆæŸ±å‰¯æ˜Ÿ
  "hidden_stars_in_day": ["æ­£è´¢"],           // æ—¥æŸ±å‰¯æ˜Ÿ
  "hidden_stars_in_hour": ["æ­£å®˜"],          // æ—¶æŸ±å‰¯æ˜Ÿ
  
  // ç¥ç…æ¡ä»¶
  "deities_in_any_pillar": ["å¤©ä¹™è´µäºº"],     // ä»»æ„æŸ±æœ‰ç¥ç…
  "deities_in_year": ["å¤©ä¹™è´µäºº"],          // å¹´æŸ±ç¥ç…
  "deities_in_month": ["å¤©ä¹™è´µäºº"],          // æœˆæŸ±ç¥ç…
  
  // æ—ºè¡°æ¡ä»¶
  "wangshuai": ["èº«æ—º", "ææ—º"],            // æ—ºè¡°çŠ¶æ€
  
  // å­£èŠ‚æ¡ä»¶
  "season": "æ˜¥å­£",                         // å­£èŠ‚
  
  // æ—¶è¾°èŒƒå›´
  "hour_branch_range": ["å¯", "è¾°", "å·³"],  // æ—¶è¾°èŒƒå›´
  
  // åœ°æ”¯å…³ç³»
  "branch_chong": ["å­", "åˆ"],             // åœ°æ”¯å†²
  "no_chong_xing": true,                    // ä¸å—åˆ‘å†²
  
  // ç»„åˆæ¡ä»¶
  "all": [                                 // æ‰€æœ‰æ¡ä»¶å¿…é¡»æ»¡è¶³
    {"main_star_in_year": "æ­£è´¢"},
    {"hidden_stars_in_year": ["æ­£å®˜"]}
  ],
  "any": [                                 // ä»»ä¸€æ¡ä»¶æ»¡è¶³å³å¯
    {"day_pillar": "ç”²å­"},
    {"day_pillar": "ä¹™ä¸‘"}
  ]
}
```

**æ­¥éª¤2ï¼šæ’å…¥æ•°æ®åº“**

```sql
INSERT INTO bazi_rules (
    rule_code,
    rule_name,
    rule_type,
    priority,
    conditions,
    content,
    enabled,
    description
) VALUES (
    'FORMULA_20001',                    -- è§„åˆ™ä»£ç ï¼ˆå”¯ä¸€ï¼‰
    'è´¢å¯Œè§„åˆ™-20001',                   -- è§„åˆ™åç§°
    'wealth',                           -- è§„åˆ™ç±»å‹
    100,                                -- ä¼˜å…ˆçº§
    '{"main_star_in_year": "æ­£è´¢"}',   -- æ¡ä»¶ï¼ˆJSONæ ¼å¼ï¼‰
    '{"type": "text", "text": "ç¥–ä¸Šæœ‰åŸºä¸šï¼Œå¯Œè´µå‘½ï¼"}',  -- å†…å®¹ï¼ˆJSONæ ¼å¼ï¼‰
    TRUE,                               -- æ˜¯å¦å¯ç”¨
    'å¹´æŸ±ä¸»æ˜Ÿæ˜¯æ­£è´¢çš„è´¢å¯Œè§„åˆ™'          -- æè¿°
);
```

**æ­¥éª¤3ï¼šæ›´æ–°è§„åˆ™ç‰ˆæœ¬å·**

```sql
UPDATE rule_version SET rule_version = rule_version + 1 WHERE id = 1;
```

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬å·å˜åŒ–å¹¶çƒ­åŠ è½½è§„åˆ™ã€‚

---

#### 2.2 æ‰¹é‡å¯¼å…¥è§„åˆ™

**ä½¿ç”¨è¿ç§»è„šæœ¬ï¼š** `scripts/migrate_formula_rules_to_db.py`

**ç¤ºä¾‹ï¼š**
```bash
# æµ‹è¯•æ¨¡å¼ï¼šæ¯ä¸ªç±»å‹è½¬æ¢5æ¡è§„åˆ™
python3 scripts/migrate_formula_rules_to_db.py --test --test-count 5

# å®Œæ•´è¿ç§»ï¼šè½¬æ¢æ‰€æœ‰è§„åˆ™
python3 scripts/migrate_formula_rules_to_db.py
```

**è„šæœ¬åŠŸèƒ½ï¼š**
- ä»JSONæ–‡ä»¶è¯»å–è§„åˆ™
- å°†æ–‡æœ¬æ¡ä»¶è½¬æ¢ä¸ºJSONæ ¼å¼
- æ’å…¥æ•°æ®åº“
- æ›´æ–°ç‰ˆæœ¬å·

---

#### 2.3 è§„åˆ™æ¡ä»¶æ ¼å¼è½¬æ¢

**æ–‡æœ¬æ¡ä»¶ â†’ JSONæ¡ä»¶**

| æ–‡æœ¬æ ¼å¼ | JSONæ ¼å¼ |
|---------|---------|
| `å¹´æŸ±ä¸»æ˜Ÿæ˜¯æ­£è´¢` | `{"main_star_in_year": "æ­£è´¢"}` |
| `æœˆæŸ±ä¸»æ˜Ÿæ˜¯æ­£è´¢ï¼ŒæœˆæŸ±å‰¯æ˜Ÿæœ‰é£Ÿç¥æˆ–ä¼¤å®˜` | `{"all": [{"main_star_in_pillar": {"pillar": "month", "eq": "æ­£è´¢"}}, {"hidden_stars_in_month": ["é£Ÿç¥", "ä¼¤å®˜"]}]}` |
| `æ—¥æŸ±æ˜¯ç”²å­` | `{"day_pillar": "ç”²å­"}` |
| `å¹´æŸ±ä¸»æ˜Ÿæ˜¯æ­£è´¢ï¼Œä¸”å¹´æŸ±å‰¯æ˜Ÿæœ‰æ­£å®˜ï¼Œå¹¶ä¸”è¿˜æ˜¯èº«æ—ºæˆ–ææ—º` | `{"all": [{"main_star_in_year": "æ­£è´¢"}, {"hidden_stars_in_year": ["æ­£å®˜"]}, {"wangshuai": ["èº«æ—º", "ææ—º"]}]}` |

**è½¬æ¢å·¥å…·ï¼š** `scripts/migrate_formula_rules_to_db.py` ä¸­çš„ `FormulaRuleConverter` ç±»

---

### 3. è§„åˆ™åŒ¹é…ä½¿ç”¨è§„èŒƒ

#### 3.1 åœ¨æœåŠ¡å±‚ä½¿ç”¨

```python
from server.services.rule_service import RuleService
from server.services.bazi_service import BaziService

# 1. è®¡ç®—å…«å­—
bazi_result = BaziService.calculate_bazi_full(solar_date, solar_time, gender)
bazi_data = bazi_result.get('bazi', {})

# 2. æ„å»ºè§„åˆ™åŒ¹é…æ•°æ®
rule_data = {
    'basic_info': bazi_data.get('basic_info', {}),
    'bazi_pillars': bazi_data.get('bazi_pillars', {}),
    'details': bazi_data.get('details', {}),
    'ten_gods_stats': bazi_data.get('ten_gods_stats', {}),
    'elements': bazi_data.get('elements', {}),
    'element_counts': bazi_data.get('element_counts', {}),
    'relationships': bazi_data.get('relationships', {})
}

# 3. åŒ¹é…è§„åˆ™
matched_rules = RuleService.match_rules(
    rule_data,
    rule_types=['wealth', 'marriage'],  # æŒ‡å®šè§„åˆ™ç±»å‹
    use_cache=True                      # ä½¿ç”¨ç¼“å­˜
)

# 4. å¤„ç†åŒ¹é…ç»“æœ
for rule in matched_rules:
    rule_id = rule.get('rule_id')
    rule_type = rule.get('rule_type')
    content = rule.get('content', {})
    rule_text = content.get('text', '') if isinstance(content, dict) else str(content)
    print(f"è§„åˆ™ {rule_id}: {rule_text}")
```

#### 3.2 åœ¨APIå±‚ä½¿ç”¨

```python
from fastapi import APIRouter
from server.services.rule_service import RuleService
from server.services.bazi_service import BaziService

router = APIRouter()

@router.post("/bazi/rules/match")
async def match_rules(request: RuleMatchRequest):
    """è§„åˆ™åŒ¹é…API"""
    # è®¡ç®—å…«å­—
    bazi_result = BaziService.calculate_bazi_full(...)
    bazi_data = bazi_result.get('bazi', {})
    
    # æ„å»ºè§„åˆ™æ•°æ®
    rule_data = {...}
    
    # åŒ¹é…è§„åˆ™
    matched_rules = RuleService.match_rules(rule_data, rule_types=request.rule_types)
    
    return {"success": True, "data": {"matched": matched_rules}}
```

---

### 4. è§„åˆ™ç±»å‹è§„èŒƒ

#### 4.1 è§„åˆ™ç±»å‹å®šä¹‰

| è§„åˆ™ç±»å‹ï¼ˆè‹±æ–‡ï¼‰ | è§„åˆ™ç±»å‹ï¼ˆä¸­æ–‡ï¼‰ | è¯´æ˜ | è§„åˆ™æ•°é‡ |
|----------------|----------------|------|---------|
| `wealth` | è´¢å¯Œ | åŸºäºåç¥ï¼ˆä¸»æ˜Ÿ/å‰¯æ˜Ÿï¼‰ | 97æ¡ |
| `marriage` | å©šé… | åŸºäºæ—¥æŸ± | 60æ¡ |
| `character` | æ€§æ ¼ | åŸºäºæ—¥æŸ± | 60æ¡ |
| `summary` | æ€»è¯„ | åŸºäºå¹´æŸ±+å­£èŠ‚+æ—¶è¾° | 533æ¡ |
| `health` | èº«ä½“ | åŸºäºåœ°æ”¯å…³ç³»/äº”è¡Œç»Ÿè®¡ | 58æ¡ |
| `shishen` | åç¥å‘½æ ¼ | åŸºäºæœˆæŸ±ä¸»æ˜Ÿ/å‰¯æ˜Ÿï¼Œä¼˜å…ˆçº§åŒ¹é… | 8æ¡ |

#### 4.2 è§„åˆ™ä»£ç å‘½åè§„èŒƒ

**æ ¼å¼ï¼š** `FORMULA_{è§„åˆ™ID}`

**ç¤ºä¾‹ï¼š**
- `FORMULA_20001` - è´¢å¯Œè§„åˆ™ID 20001
- `FORMULA_10901` - å©šé…è§„åˆ™ID 10901
- `FORMULA_40001` - æ€§æ ¼è§„åˆ™ID 40001
- `FORMULA_30001` - æ€»è¯„è§„åˆ™ID 30001
- `FORMULA_70001` - èº«ä½“è§„åˆ™ID 70001
- `FORMULA_99001` - åç¥å‘½æ ¼è§„åˆ™ID 99001

**è§„åˆ™IDèŒƒå›´ï¼š**
- è´¢å¯Œï¼š20001-20097
- å©šé…ï¼š10901-10960
- æ€§æ ¼ï¼š40001-40060
- æ€»è¯„ï¼š30001-30533
- èº«ä½“ï¼š70001-70058
- åç¥å‘½æ ¼ï¼š99001-99008

---

### 5. è§„åˆ™æ¡ä»¶å¼€å‘è§„èŒƒ

#### 5.1 æ”¯æŒçš„æ¡ä»¶ç±»å‹

**åŸºç¡€æ¡ä»¶ï¼š**
- âœ… å››æŸ±æ¡ä»¶ï¼š`year_pillar`, `month_pillar`, `day_pillar`, `hour_pillar`
- âœ… ä¸»æ˜Ÿæ¡ä»¶ï¼š`main_star_in_year`, `main_star_in_day`, `main_star_in_pillar`
- âœ… å‰¯æ˜Ÿæ¡ä»¶ï¼š`hidden_stars_in_year`, `hidden_stars_in_month`, `hidden_stars_in_day`, `hidden_stars_in_hour`
- âœ… ç¥ç…æ¡ä»¶ï¼š`deities_in_any_pillar`, `deities_in_year`, `deities_in_month`, `deities_in_day`, `deities_in_hour`
- âœ… æ—ºè¡°æ¡ä»¶ï¼š`wangshuai`
- âœ… å­£èŠ‚æ¡ä»¶ï¼š`season`
- âœ… æ—¶è¾°èŒƒå›´ï¼š`hour_branch_range`
- âœ… åœ°æ”¯å…³ç³»ï¼š`branch_chong`, `no_chong_xing`

**ç»„åˆæ¡ä»¶ï¼š**
- âœ… `all`: æ‰€æœ‰æ¡ä»¶å¿…é¡»æ»¡è¶³
- âœ… `any`: ä»»ä¸€æ¡ä»¶æ»¡è¶³å³å¯
- âœ… `not`: æ¡ä»¶ä¸æ»¡è¶³

#### 5.2 æ¡ä»¶æ ¼å¼ç¤ºä¾‹

**ç¤ºä¾‹1ï¼šç®€å•æ¡ä»¶**
```json
{
  "main_star_in_year": "æ­£è´¢"
}
```

**ç¤ºä¾‹2ï¼šç»„åˆæ¡ä»¶ï¼ˆANDï¼‰**
```json
{
  "all": [
    {"main_star_in_year": "æ­£è´¢"},
    {"hidden_stars_in_year": ["æ­£å®˜"]},
    {"wangshuai": ["èº«æ—º", "ææ—º"]}
  ]
}
```

**ç¤ºä¾‹3ï¼šç»„åˆæ¡ä»¶ï¼ˆORï¼‰**
```json
{
  "any": [
    {"day_pillar": "ç”²å­"},
    {"day_pillar": "ä¹™ä¸‘"}
  ]
}
```

**ç¤ºä¾‹4ï¼šå¤æ‚ç»„åˆ**
```json
{
  "all": [
    {"year_pillar": "ç”²å­"},
    {"season": "æ˜¥å­£"},
    {
      "any": [
        {"hour_branch_range": ["å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³"]},
        {"hour_branch_range": ["é…‰", "æˆŒ", "äº¥", "å­", "ä¸‘", "å¯…"]}
      ]
    }
  ]
}
```

---

### 6. è§„åˆ™å†…å®¹æ ¼å¼è§„èŒƒ

#### 6.1 å†…å®¹æ ¼å¼

**æ ‡å‡†æ ¼å¼ï¼š**
```json
{
  "type": "text",
  "text": "è§„åˆ™å†…å®¹æ–‡æœ¬"
}
```

**ç¤ºä¾‹ï¼š**
```json
{
  "type": "text",
  "text": "ç¥–ä¸Šæœ‰åŸºä¸šï¼Œå¯Œè´µå‘½ï¼\nå¹¶ä¸”äººå“ï¼Œå©šå§»ï¼Œäº‹ä¸šï¼Œå®¶åº­éƒ½ä¼šéå¸¸å¥½ã€‚"
}
```

#### 6.2 åŠ¨æ€å†…å®¹ï¼ˆé«˜çº§ï¼‰

æ”¯æŒåŠ¨æ€æŸ¥è¯¢é€‚é…å™¨ï¼ˆå¦‚æ—¥æŸ±æ€§åˆ«åˆ†æï¼‰ï¼š

```json
{
  "type": "dynamic",
  "query_adapter": "RizhuGenderAnalyzer",
  "query_method": "analyze_rizhu_gender",
  "default_content": {
    "type": "text",
    "text": "æš‚æ— åˆ†ææ•°æ®"
  }
}
```

---

### 7. è§„åˆ™ä¼˜å…ˆçº§è§„èŒƒ

#### 7.1 ä¼˜å…ˆçº§å®šä¹‰

**ä¼˜å…ˆçº§èŒƒå›´ï¼š** 1-1000ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰

**é»˜è®¤ä¼˜å…ˆçº§ï¼š** 100

**ç‰¹æ®Šè§„åˆ™ï¼š**
- åç¥å‘½æ ¼è§„åˆ™ï¼šä½¿ç”¨å¤šçº§ä¼˜å…ˆçº§ï¼ˆä¼˜å…ˆçº§1ã€ä¼˜å…ˆçº§2ã€ä¼˜å…ˆçº§3ï¼‰
- äº’æ–¥è§„åˆ™ï¼šä½¿ç”¨ `mutually_exclusive_group` å­—æ®µ

#### 7.2 ä¼˜å…ˆçº§ä½¿ç”¨

```sql
-- é«˜ä¼˜å…ˆçº§è§„åˆ™
INSERT INTO bazi_rules (..., priority, ...) VALUES (..., 200, ...);

-- ä½ä¼˜å…ˆçº§è§„åˆ™
INSERT INTO bazi_rules (..., priority, ...) VALUES (..., 50, ...);
```

---

### 8. è§„åˆ™æµ‹è¯•è§„èŒƒ

#### 8.1 æµ‹è¯•æµç¨‹

**æ­¥éª¤1ï¼šåˆ›å»ºæµ‹è¯•ç”¨ä¾‹**
```python
# æµ‹è¯•ç”¨ä¾‹ï¼šæ˜ç¡®æ»¡è¶³è§„åˆ™æ¡ä»¶çš„å…«å­—
test_cases = [
    {
        "name": "æµ‹è¯•è§„åˆ™20001ï¼ˆå¹´æŸ±ä¸»æ˜Ÿæ˜¯æ­£è´¢ï¼‰",
        "solar_date": "1990-05-15",
        "solar_time": "14:30",
        "gender": "male",
        "expected_rules": ["FORMULA_20001"]
    }
]
```

**æ­¥éª¤2ï¼šè¿è¡Œæµ‹è¯•**
```bash
python3 scripts/test_rules_local.py
```

**æ­¥éª¤3ï¼šéªŒè¯ç»“æœ**
- æ£€æŸ¥è§„åˆ™æ˜¯å¦åŒ¹é…
- æ£€æŸ¥è§„åˆ™å†…å®¹æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥è§„åˆ™ä¼˜å…ˆçº§æ˜¯å¦æ­£ç¡®

#### 8.2 æµ‹è¯•è„šæœ¬

**æœ¬åœ°æµ‹è¯•ï¼š** `scripts/test_rules_local.py`
- ç›´æ¥æµ‹è¯•æœåŠ¡å±‚ä»£ç 
- ä¸ä¾èµ–HTTP API

**APIæµ‹è¯•ï¼š** `scripts/test_api_rules.py`
- æµ‹è¯•HTTP API
- éœ€è¦æœåŠ¡è¿è¡Œ

**è½¬æ¢æµ‹è¯•ï¼š** `scripts/test_rule_conversion.py`
- æµ‹è¯•æ¡ä»¶æ ¼å¼è½¬æ¢
- ä¸ä¾èµ–æ•°æ®åº“

---

### 9. è§„åˆ™æ›´æ–°è§„èŒƒ

#### 9.1 æ›´æ–°è§„åˆ™

**æ–¹å¼1ï¼šç›´æ¥æ›´æ–°æ•°æ®åº“**
```sql
UPDATE bazi_rules
SET conditions = '{"main_star_in_year": "æ­£è´¢"}',
    content = '{"type": "text", "text": "æ›´æ–°åçš„å†…å®¹"}',
    updated_at = CURRENT_TIMESTAMP
WHERE rule_code = 'FORMULA_20001';
```

**æ–¹å¼2ï¼šä½¿ç”¨ç®¡ç†API**
```bash
# é€šè¿‡APIæ›´æ–°ï¼ˆå¦‚æœå®ç°äº†ç®¡ç†æ¥å£ï¼‰
curl -X PUT http://127.0.0.1:8001/api/v1/admin/rules/FORMULA_20001 \
  -H "Content-Type: application/json" \
  -d '{"conditions": {...}, "content": {...}}'
```

#### 9.2 æ›´æ–°ç‰ˆæœ¬å·

**å¿…é¡»æ“ä½œï¼š** æ›´æ–°è§„åˆ™åå¿…é¡»æ›´æ–°ç‰ˆæœ¬å·
```sql
UPDATE rule_version SET rule_version = rule_version + 1 WHERE id = 1;
```

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬å·å˜åŒ–å¹¶çƒ­åŠ è½½è§„åˆ™ï¼ˆ5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰ã€‚

---

### 10. è§„åˆ™ç¦ç”¨/å¯ç”¨è§„èŒƒ

#### 10.1 ç¦ç”¨è§„åˆ™

```sql
UPDATE bazi_rules
SET enabled = FALSE
WHERE rule_code = 'FORMULA_20001';
```

#### 10.2 å¯ç”¨è§„åˆ™

```sql
UPDATE bazi_rules
SET enabled = TRUE
WHERE rule_code = 'FORMULA_20001';
```

#### 10.3 æ‰¹é‡æ“ä½œ

```sql
-- ç¦ç”¨æ‰€æœ‰è´¢å¯Œè§„åˆ™
UPDATE bazi_rules
SET enabled = FALSE
WHERE rule_type = 'wealth';

-- å¯ç”¨æ‰€æœ‰è§„åˆ™
UPDATE bazi_rules
SET enabled = TRUE;
```

---

### 11. ç¦æ­¢äº‹é¡¹

#### âŒ ç¦æ­¢ä½¿ç”¨JSONæ–‡ä»¶å­˜å‚¨è§„åˆ™

**é”™è¯¯åšæ³•ï¼š**
```python
# âŒ ç¦æ­¢ï¼šä½¿ç”¨JSONæ–‡ä»¶
with open('rules.json', 'r') as f:
    rules = json.load(f)
```

**æ­£ç¡®åšæ³•ï¼š**
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨æ•°æ®åº“
from server.services.rule_service import RuleService
matched_rules = RuleService.match_rules(rule_data, rule_types=['wealth'])
```

#### âŒ ç¦æ­¢ç›´æ¥ä¿®æ”¹RuleServiceåŒ¹é…é€»è¾‘

**é”™è¯¯åšæ³•ï¼š**
```python
# âŒ ç¦æ­¢ï¼šç›´æ¥ä¿®æ”¹åŒ¹é…é€»è¾‘
def match_rules(...):
    # æ·»åŠ ç‰¹æ®Šé€»è¾‘
    if rule_type == 'wealth':
        # ç‰¹æ®Šå¤„ç†
        pass
```

**æ­£ç¡®åšæ³•ï¼š**
```python
# âœ… æ­£ç¡®ï¼šé€šè¿‡æ¡ä»¶æ ¼å¼å®ç°
# åœ¨æ•°æ®åº“ä¸­ä½¿ç”¨JSONæ¡ä»¶æ ¼å¼ï¼Œè€Œä¸æ˜¯ä¿®æ”¹ä»£ç 
```

#### âŒ ç¦æ­¢åˆ›å»ºæ–°çš„è§„åˆ™æœåŠ¡

**é”™è¯¯åšæ³•ï¼š**
```python
# âŒ ç¦æ­¢ï¼šåˆ›å»ºæ–°çš„è§„åˆ™æœåŠ¡
class NewRuleService:
    def match_rules(...):
        pass
```

**æ­£ç¡®åšæ³•ï¼š**
```python
# âœ… æ­£ç¡®ï¼šç»Ÿä¸€ä½¿ç”¨RuleService
from server.services.rule_service import RuleService
```

---

### 12. è§„åˆ™å¼€å‘æ£€æŸ¥æ¸…å•

åœ¨å¼€å‘æ–°è§„åˆ™å‰ï¼Œå¿…é¡»ç¡®è®¤ï¼š

- [ ] è§„åˆ™æ¡ä»¶å·²è®¾è®¡ä¸ºJSONæ ¼å¼
- [ ] è§„åˆ™æ¡ä»¶ç¬¦åˆEnhancedRuleEngineæ”¯æŒçš„æ¡ä»¶ç±»å‹
- [ ] è§„åˆ™ä»£ç éµå¾ªå‘½åè§„èŒƒï¼ˆ`FORMULA_{ID}`ï¼‰
- [ ] è§„åˆ™ç±»å‹ä½¿ç”¨æ ‡å‡†ç±»å‹ï¼ˆwealth/marriage/character/summary/health/shishenï¼‰
- [ ] è§„åˆ™å†…å®¹ä½¿ç”¨æ ‡å‡†æ ¼å¼ï¼ˆ`{"type": "text", "text": "..."}`ï¼‰
- [ ] è§„åˆ™ä¼˜å…ˆçº§å·²è®¾ç½®
- [ ] è§„åˆ™å·²æ’å…¥æ•°æ®åº“
- [ ] è§„åˆ™ç‰ˆæœ¬å·å·²æ›´æ–°
- [ ] è§„åˆ™å·²æµ‹è¯•éªŒè¯

---

### 13. è§„åˆ™è¿ç§»è§„èŒƒï¼ˆä»JSONè¿ç§»ï¼‰

å¦‚æœå·²æœ‰JSONæ ¼å¼çš„è§„åˆ™éœ€è¦è¿ç§»åˆ°æ•°æ®åº“ï¼š

**æ­¥éª¤1ï¼šä½¿ç”¨è½¬æ¢è„šæœ¬**
```bash
python3 scripts/migrate_formula_rules_to_db.py --test --test-count 5
```

**æ­¥éª¤2ï¼šéªŒè¯è½¬æ¢ç»“æœ**
```bash
python3 scripts/test_rule_conversion.py
```

**æ­¥éª¤3ï¼šè¿è¡Œå®Œæ•´è¿ç§»**
```bash
python3 scripts/migrate_formula_rules_to_db.py
```

**æ­¥éª¤4ï¼šéªŒè¯æ•°æ®åº“**
```bash
python3 scripts/verify_migrated_rules.py
```

---

### 14. è§„åˆ™ç³»ç»Ÿæ¶æ„å›¾

```
ç”¨æˆ·è¯·æ±‚
  â†“
APIå±‚ (server/api/v1/bazi_rules.py)
  â†“
æœåŠ¡å±‚ (server/services/rule_service.py)
  â†“
è§„åˆ™å¼•æ“ (server/engines/rule_engine.py)
  â”œâ”€â†’ ç´¢å¼•è¿‡æ»¤ï¼ˆå¿«é€Ÿå®šä½å€™é€‰è§„åˆ™ï¼‰
  â”œâ”€â†’ å¹¶è¡ŒåŒ¹é…ï¼ˆThreadPoolExecutorï¼‰
  â””â”€â†’ æ¡ä»¶åŒ¹é… (server/engines/rule_condition.py)
        â”œâ”€â†’ é™æ€æ¡ä»¶åŒ¹é…
        â””â”€â†’ åŠ¨æ€æŸ¥è¯¢ (QueryAdapterRegistry)
  â†“
æ•°æ®åº“ (MySQL - bazi_rulesè¡¨)
  â”œâ”€â†’ è§„åˆ™å…ƒæ•°æ®
  â”œâ”€â†’ è§„åˆ™æ¡ä»¶ (JSON)
  â””â”€â†’ è§„åˆ™å†…å®¹ (JSON)
```

---

### 15. ç›¸å…³å·¥å…·å’Œè„šæœ¬

| è„šæœ¬ | ç”¨é€” |
|------|------|
| `scripts/migrate_formula_rules_to_db.py` | è§„åˆ™è¿ç§»è„šæœ¬ |
| `scripts/test_rule_conversion.py` | è§„åˆ™è½¬æ¢æµ‹è¯• |
| `scripts/verify_migrated_rules.py` | æ•°æ®åº“éªŒè¯ |
| `scripts/test_rules_local.py` | æœ¬åœ°è§„åˆ™åŒ¹é…æµ‹è¯• |
| `scripts/test_api_rules.py` | APIè§„åˆ™åŒ¹é…æµ‹è¯• |

---

### 16. å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•æ·»åŠ æ–°çš„æ¡ä»¶ç±»å‹ï¼Ÿ

**A:** éœ€è¦åœ¨ `server/engines/rule_condition.py` çš„ `EnhancedRuleCondition.match()` æ–¹æ³•ä¸­æ·»åŠ æ–°çš„æ¡ä»¶ç±»å‹æ”¯æŒã€‚

**ç¤ºä¾‹ï¼š**
```python
elif key == "new_condition_type":
    """æ–°æ¡ä»¶ç±»å‹åŒ¹é…"""
    # å®ç°åŒ¹é…é€»è¾‘
    return match_result
```

#### Q2: è§„åˆ™åŒ¹é…ç»“æœä¸ºç©ºæ€ä¹ˆåŠï¼Ÿ

**A:** 
1. æ£€æŸ¥è§„åˆ™æ¡ä»¶æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥æµ‹è¯•ç”¨ä¾‹æ˜¯å¦æ»¡è¶³è§„åˆ™æ¡ä»¶
3. ä½¿ç”¨è°ƒè¯•å·¥å…·æ£€æŸ¥åŒ¹é…è¿‡ç¨‹

#### Q3: å¦‚ä½•å®ç°åç¥å‘½æ ¼çš„ç‰¹æ®ŠåŒ¹é…é€»è¾‘ï¼Ÿ

**A:** åç¥å‘½æ ¼è§„åˆ™ä½¿ç”¨å¤šçº§ä¼˜å…ˆçº§ï¼Œéœ€è¦åœ¨ `FormulaRuleService._match_shishen_by_priority()` ä¸­å®ç°ç‰¹æ®Šé€»è¾‘ã€‚ä½†å»ºè®®ï¼š
- å°†ä¼˜å…ˆçº§æ‹†åˆ†ä¸ºç‹¬ç«‹çš„è§„åˆ™
- æˆ–ä½¿ç”¨ `priority` å­—æ®µå’Œ `mutually_exclusive_group` å®ç°

---

### 17. è§„åˆ™å¼€å‘æœ€ä½³å®è·µ

1. **å…ˆè®¾è®¡æ¡ä»¶ï¼Œå†å†™ä»£ç **
   - æ˜ç¡®è§„åˆ™æ¡ä»¶
   - è½¬æ¢ä¸ºJSONæ ¼å¼
   - éªŒè¯æ¡ä»¶æ ¼å¼

2. **ä½¿ç”¨æµ‹è¯•è„šæœ¬éªŒè¯**
   - åˆ›å»ºæ˜ç¡®çš„æµ‹è¯•ç”¨ä¾‹
   - éªŒè¯è§„åˆ™åŒ¹é…ç»“æœ
   - æ£€æŸ¥è§„åˆ™å†…å®¹

3. **éµå¾ªå‘½åè§„èŒƒ**
   - è§„åˆ™ä»£ç ï¼š`FORMULA_{ID}`
   - è§„åˆ™ç±»å‹ï¼šä½¿ç”¨æ ‡å‡†ç±»å‹
   - è§„åˆ™åç§°ï¼šæ¸…æ™°æè¿°

4. **åŠæ—¶æ›´æ–°ç‰ˆæœ¬å·**
   - è§„åˆ™æ›´æ–°åç«‹å³æ›´æ–°ç‰ˆæœ¬å·
   - è§¦å‘çƒ­åŠ è½½

5. **æ–‡æ¡£åŒ–è§„åˆ™**
   - åœ¨ `description` å­—æ®µä¸­æè¿°è§„åˆ™
   - è®°å½•è§„åˆ™æ¥æºå’Œä¾æ®

---

**è®°ä½ï¼šæ‰€æœ‰è§„åˆ™å¿…é¡»åŸºäºæ•°æ®åº“å¼€å‘ï¼Œç¦æ­¢ä½¿ç”¨JSONæ–‡ä»¶å­˜å‚¨è§„åˆ™ï¼**

---

## ğŸ”„ å¾®æœåŠ¡ç®¡ç†è§„èŒƒ

### 1. å¾®æœåŠ¡æ¶æ„è¯´æ˜

æœ¬é¡¹ç›®é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œå„æœåŠ¡èŒè´£å¦‚ä¸‹ï¼š

| æœåŠ¡åç§° | ç«¯å£ | èŒè´£ | ä½ç½® |
|---------|------|-----|------|
| `bazi_core` | 9001 | å…«å­—æ ¸å¿ƒè®¡ç®— | `services/bazi_core/` |
| `bazi_fortune` | 9002 | å¤§è¿æµå¹´è®¡ç®— | `services/bazi_fortune/` |
| `bazi_analyzer` | 9003 | å…«å­—åˆ†æ | `services/bazi_analyzer/` |
| `bazi_rule` | 9004 | è§„åˆ™åŒ¹é… | `services/bazi_rule/` |
| `fortune_analysis` | 9005 | é¢ç›¸/æ‰‹ç›¸åˆ†æ | `services/fortune_analysis/` |
| `payment_service` | 9006 | æ”¯ä»˜æœåŠ¡ | `services/payment_service/` |
| `fortune_rule` | 9007 | è¿åŠ¿è§„åˆ™å¼•æ“ | `services/fortune_rule/` |
| `web_app` | 8001 | Web åº”ç”¨ä¸»å…¥å£ | `server/start.py` |

### 2. æ·»åŠ æ–°å¾®æœåŠ¡çš„å®Œæ•´æµç¨‹

âš ï¸ **é‡è¦ï¼šæ¯æ¬¡æ·»åŠ æ–°å¾®æœåŠ¡æ—¶ï¼Œå¿…é¡»éµå¾ªä»¥ä¸‹å®Œæ•´æµç¨‹ï¼**

#### æ­¥éª¤ 1ï¼šåˆ›å»ºå¾®æœåŠ¡ç›®å½•å’Œä»£ç 

```bash
# åœ¨ services/ ä¸‹åˆ›å»ºæ–°æœåŠ¡ç›®å½•
mkdir -p services/new_service
cd services/new_service

# åˆ›å»ºå¿…è¦æ–‡ä»¶
touch __init__.py
touch grpc_server.py  # gRPC æœåŠ¡å™¨
touch main.py         # ä¸šåŠ¡é€»è¾‘
touch schemas.py      # æ•°æ®æ¨¡å‹
```

#### æ­¥éª¤ 2ï¼šå®ç° gRPC æœåŠ¡å™¨

```python
# services/new_service/grpc_server.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""æ–°æœåŠ¡çš„ gRPC æœåŠ¡å™¨"""

import grpc
from concurrent import futures
import argparse

def serve(port=9008):
    """å¯åŠ¨ gRPC æœåŠ¡å™¨"""
    server = grpc.server(futures.ThreadPoolExecutor(max_workers=10))
    # æ³¨å†ŒæœåŠ¡...
    server.add_insecure_port(f'[::]:{port}')
    server.start()
    print(f"âœ“ æ–°æœåŠ¡ gRPC æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç›‘å¬ç«¯å£: {port}")
    server.wait_for_termination()

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--port', type=int, default=9008)
    args = parser.parse_args()
    serve(args.port)
```

#### æ­¥éª¤ 3ï¼š**å¿…é¡»**æ›´æ–°å¯åŠ¨è„šæœ¬

åœ¨ `start_all_services.sh` ä¸­æ·»åŠ æ–°æœåŠ¡ï¼š

```bash
# åœ¨æ–‡ä»¶æœ«å°¾çš„æœåŠ¡å¯åŠ¨éƒ¨åˆ†æ·»åŠ 
start_grpc_service "new_service" "services/new_service/grpc_server.py" 9008

# æ³¨æ„ï¼šæ·»åŠ ä½ç½®åº”è¯¥åœ¨ start_python_service "web_app" ä¹‹å‰
```

**å®Œæ•´ç¤ºä¾‹ï¼š**

```bash
# ä½¿ç”¨ gRPC åè®®å¯åŠ¨å¾®æœåŠ¡
echo ">>> ä½¿ç”¨ gRPC åè®®å¯åŠ¨å¾®æœåŠ¡"
start_grpc_service "bazi_core"     "services/bazi_core/grpc_server.py"     9001
start_grpc_service "bazi_fortune"  "services/bazi_fortune/grpc_server.py"  9002
start_grpc_service "bazi_analyzer" "services/bazi_analyzer/grpc_server.py" 9003
start_grpc_service "bazi_rule"     "services/bazi_rule/grpc_server.py"     9004
start_grpc_service "fortune_analysis" "services/fortune_analysis/grpc_server.py" 9005
start_grpc_service "payment_service" "services/payment_service/grpc_server.py" 9006
start_grpc_service "fortune_rule" "services/fortune_rule/grpc_server.py" 9007
start_grpc_service "new_service" "services/new_service/grpc_server.py" 9008  # âœ… æ–°å¢

start_python_service "web_app" "server/start.py" 8001
```

#### æ­¥éª¤ 4ï¼š**å¿…é¡»**æ›´æ–°åœæ­¢è„šæœ¬

åœ¨ `stop_all_services.sh` ä¸­æ·»åŠ æ–°æœåŠ¡ï¼š

```bash
# åœ¨æ–‡ä»¶æœ«å°¾çš„æœåŠ¡åœæ­¢éƒ¨åˆ†æ·»åŠ 
stop_service "new_service" 9008

# æ³¨æ„ï¼šåœæ­¢é¡ºåºåº”è¯¥ä¸å¯åŠ¨ç›¸å
```

**å®Œæ•´ç¤ºä¾‹ï¼š**

```bash
stop_service "web_app" 8001
stop_service "new_service" 9008        # âœ… æ–°å¢ï¼ˆæ³¨æ„åœæ­¢é¡ºåºï¼‰
stop_service "fortune_analysis" 9005
stop_service "fortune_rule" 9007
stop_service "payment_service" 9006
stop_service "bazi_rule" 9004
stop_service "bazi_analyzer" 9003
stop_service "bazi_fortune" 9002
stop_service "bazi_core" 9001
```

#### æ­¥éª¤ 5ï¼šæ›´æ–°ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ–°æœåŠ¡éœ€è¦ç¯å¢ƒå˜é‡é…ç½®ï¼Œåœ¨ `config/services.env` ä¸­æ·»åŠ ï¼š

```bash
# æ–°æœåŠ¡é…ç½®
export NEW_SERVICE_URL="127.0.0.1:9008"
```

å¹¶åœ¨ `start_all_services.sh` ä¸­åŠ è½½ï¼š

```bash
export NEW_SERVICE_URL="${NEW_SERVICE_URL:-127.0.0.1:9008}"
```

#### æ­¥éª¤ 6ï¼šæµ‹è¯•æœåŠ¡å¯åŠ¨å’Œåœæ­¢

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./start_all_services.sh

# æ£€æŸ¥æ–°æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ
lsof -i:9008  # åº”è¯¥çœ‹åˆ°è¿›ç¨‹åœ¨ç›‘å¬

# åœæ­¢æ‰€æœ‰æœåŠ¡
./stop_all_services.sh

# ç¡®è®¤æœåŠ¡å·²åœæ­¢
lsof -i:9008  # åº”è¯¥æ²¡æœ‰è¾“å‡º
```

### 3. å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

#### é”™è¯¯ 1ï¼šæœåŠ¡é‡å¯åæŠ¥é”™æ‰¾ä¸åˆ°

**åŸå› ï¼š** æ–°å¢çš„å¾®æœåŠ¡æ²¡æœ‰æ·»åŠ åˆ°å¯åŠ¨è„šæœ¬ä¸­

**è§£å†³ï¼š** æŒ‰ç…§ä¸Šè¿°æµç¨‹ï¼Œå°†æœåŠ¡æ·»åŠ åˆ° `start_all_services.sh` å’Œ `stop_all_services.sh`

**çœŸå®æ¡ˆä¾‹ï¼š**
```
é”™è¯¯ä¿¡æ¯ï¼š'str' object has no attribute 'get'
åŸå› ï¼šdaily_fortune å’Œ monthly_fortune æœåŠ¡ä½¿ç”¨äº†å…¶ä»–å¾®æœåŠ¡ï¼Œä½†è¿™äº›ä¾èµ–æœåŠ¡æœªæ­£ç¡®å¯åŠ¨
è§£å†³ï¼šç¡®ä¿æ‰€æœ‰ä¾èµ–çš„å¾®æœåŠ¡éƒ½åœ¨å¯åŠ¨è„šæœ¬ä¸­å¹¶æˆåŠŸå¯åŠ¨
```

#### é”™è¯¯ 2ï¼šæœåŠ¡å¯åŠ¨ä½†æ— æ³•è®¿é—®

**åŸå› ï¼š** ç«¯å£è¢«å ç”¨æˆ–é˜²ç«å¢™é˜»æ­¢

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i:9008

# æ€æ­»å ç”¨ç«¯å£çš„è¿›ç¨‹
kill -9 <PID>

# é‡æ–°å¯åŠ¨æœåŠ¡
./start_all_services.sh
```

#### é”™è¯¯ 3ï¼šåœæ­¢è„šæœ¬æ— æ³•åœæ­¢æœåŠ¡

**åŸå› ï¼š** æœåŠ¡åç§°æˆ–ç«¯å£å·ä¸åŒ¹é…

**è§£å†³ï¼š** ç¡®ä¿ `stop_service` è°ƒç”¨çš„æœåŠ¡åå’Œç«¯å£ä¸ `start_grpc_service` ä¸€è‡´

### 4. æœåŠ¡ä¾èµ–ç®¡ç†

å¦‚æœæ–°æœåŠ¡ä¾èµ–å…¶ä»–æœåŠ¡ï¼Œéœ€è¦æ³¨æ„å¯åŠ¨é¡ºåºï¼š

```bash
# âœ… æ­£ç¡®ï¼šä¾èµ–çš„æœåŠ¡å…ˆå¯åŠ¨
start_grpc_service "bazi_core" "services/bazi_core/grpc_server.py" 9001     # åŸºç¡€æœåŠ¡
start_grpc_service "bazi_rule" "services/bazi_rule/grpc_server.py" 9004     # ä¾èµ– bazi_core
start_grpc_service "new_service" "services/new_service/grpc_server.py" 9008  # ä¾èµ– bazi_rule

# âŒ é”™è¯¯ï¼šä¾èµ–çš„æœåŠ¡åå¯åŠ¨
start_grpc_service "new_service" "services/new_service/grpc_server.py" 9008
start_grpc_service "bazi_core" "services/bazi_core/grpc_server.py" 9001
```

åœæ­¢æ—¶é¡ºåºç›¸åï¼š

```bash
stop_service "new_service" 9008   # å…ˆåœæ­¢ä¾èµ–æ–¹
stop_service "bazi_rule" 9004
stop_service "bazi_core" 9001     # ååœæ­¢è¢«ä¾èµ–çš„æœåŠ¡
```

### 5. å¾®æœåŠ¡å¼€å‘æ£€æŸ¥æ¸…å•

åœ¨æ·»åŠ æ–°å¾®æœåŠ¡æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹æ£€æŸ¥æ¸…å•ï¼š

- [ ] åˆ›å»ºæœåŠ¡ç›®å½•å’Œä»£ç æ–‡ä»¶
- [ ] å®ç° gRPC æœåŠ¡å™¨ï¼ˆå¿…é¡»æ”¯æŒ `--port` å‚æ•°ï¼‰
- [ ] âœ… **æ›´æ–° `start_all_services.sh`**
- [ ] âœ… **æ›´æ–° `stop_all_services.sh`**
- [ ] æ›´æ–° `config/services.env`ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] æµ‹è¯•æœåŠ¡ç‹¬ç«‹å¯åŠ¨
- [ ] æµ‹è¯•æœåŠ¡é›†æˆå¯åŠ¨
- [ ] æµ‹è¯•æœåŠ¡åœæ­¢
- [ ] æ›´æ–°æœåŠ¡æ–‡æ¡£
- [ ] Git æäº¤æ—¶æ³¨æ˜ä¿®æ”¹äº†å¯åŠ¨/åœæ­¢è„šæœ¬

### 6. æœåŠ¡ç›‘æ§å’Œæ—¥å¿—

æ‰€æœ‰æœåŠ¡çš„æ—¥å¿—éƒ½å­˜å‚¨åœ¨ `logs/` ç›®å½•ä¸‹ï¼š

```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
tail -f logs/new_service_9008.log

# æŸ¥çœ‹æœåŠ¡ PID
cat logs/new_service_9008.pid

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
for port in 9001 9002 9003 9004 9005 9006 9007 9008 8001; do
  echo "ç«¯å£ $port:"
  lsof -i:$port || echo "  æœªè¿è¡Œ"
done
```

---

## ğŸ“ Git æäº¤è§„èŒƒ

### 1. æäº¤ä¿¡æ¯æ ¼å¼

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type ç±»å‹ï¼š**
- `feat`: æ–°åŠŸèƒ½
- `fix`: ä¿®å¤ bug
- `refactor`: é‡æ„ï¼ˆæ…ç”¨ï¼ï¼‰
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: æ ·å¼ä¿®æ”¹ï¼ˆä¸å½±å“ä»£ç é€»è¾‘ï¼‰
- `test`: æµ‹è¯•ç›¸å…³

### 2. æäº¤ç¤ºä¾‹

```bash
# âœ… æ­£ç¡®ç¤ºä¾‹
git commit -m "feat(frontend): æ·»åŠ å°è¿ç»†ç›˜æ˜¾ç¤ºé€»è¾‘

- åœ¨ fortune-timeline.js ä¸­æ·»åŠ å°è¿åˆ¤æ–­
- å°è¿æ˜¾ç¤º'-'è€Œä¸æ˜¯é”™è¯¯çš„å¤©å¹²åœ°æ”¯
- ä¸å½±å“å…¶ä»–å¤§è¿çš„æ˜¾ç¤º

ä¿®æ”¹æ–‡ä»¶ï¼š
- frontend/js/fortune-timeline.js

æµ‹è¯•é€šè¿‡ï¼š
- ç‚¹å‡»å°è¿æ­£å¸¸æ˜¾ç¤º
- å…¶ä»–å¤§è¿æ˜¾ç¤ºä¸å—å½±å“"

# âŒ é”™è¯¯ç¤ºä¾‹
git commit -m "fix bug"  # ä¿¡æ¯ä¸æ˜ç¡®
git commit -m "é‡æ„äº†æ‰€æœ‰ä»£ç "  # å½±å“å¤ªå¤§ï¼Œåº”è¯¥åˆ†å¤šæ¬¡æäº¤
```

### 3. æäº¤å‰æ£€æŸ¥

```bash
# 1. æŸ¥çœ‹ä¿®æ”¹çš„æ–‡ä»¶
git status

# 2. ç¡®è®¤åªä¿®æ”¹äº†å¿…è¦çš„æ–‡ä»¶
# âŒ å¦‚æœçœ‹åˆ°ä¸ç›¸å…³çš„æ–‡ä»¶ï¼Œä¸è¦æäº¤ï¼

# 3. æŸ¥çœ‹å…·ä½“ä¿®æ”¹å†…å®¹
git diff

# 4. ç¡®è®¤ä¿®æ”¹ç¬¦åˆè§„èŒƒåå†æäº¤
git add <files>
git commit -m "..."
```

---

## ğŸš¨ å¸¸è§é”™è¯¯å’Œé¿å…æ–¹æ³•

### 1. é”™è¯¯ï¼šæ”¹äº†ä¸è¯¥æ”¹çš„æ–‡ä»¶

**åœºæ™¯ï¼š**
```
ä»»åŠ¡ï¼šæ·»åŠ æ–°çš„ç»†ç›˜å­—æ®µ
é”™è¯¯ï¼šé¡ºä¾¿é‡æ„äº† fortune.js çš„æ•°æ®åŠ è½½é€»è¾‘
```

**é¿å…æ–¹æ³•ï¼š**
- ä¿®æ”¹å‰åˆ—å‡ºéœ€è¦æ”¹çš„æ–‡ä»¶æ¸…å•
- åªä¿®æ”¹æ¸…å•ä¸­çš„æ–‡ä»¶
- æäº¤å‰å†æ¬¡æ£€æŸ¥ `git status`

### 2. é”™è¯¯ï¼šä¿®æ”¹ç ´åäº†å…¶ä»–åŠŸèƒ½

**åœºæ™¯ï¼š**
```
ä»»åŠ¡ï¼šä¿®æ”¹å¤§è¿æ—¶é—´è½´æ ·å¼
é”™è¯¯ï¼šæ”¹äº†å…±äº«çš„ CSS ç±»ï¼Œå¯¼è‡´æµå¹´æ—¶é—´è½´ä¹Ÿå˜äº†
```

**é¿å…æ–¹æ³•ï¼š**
- ä½¿ç”¨æ–°çš„ CSS ç±»åè€Œä¸æ˜¯ä¿®æ”¹ç°æœ‰çš„
- ä¿®æ”¹å…±äº«ä»£ç å‰ï¼Œæœç´¢æ‰€æœ‰ä½¿ç”¨çš„åœ°æ–¹
- å……åˆ†æµ‹è¯•æ‰€æœ‰ç›¸å…³åŠŸèƒ½

### 3. é”™è¯¯ï¼šæ•°æ®ç»“æ„ä¸å…¼å®¹

**åœºæ™¯ï¼š**
```
ä»»åŠ¡ï¼šä¼˜åŒ– API è¿”å›æ ¼å¼
é”™è¯¯ï¼šæ”¹äº†å­—æ®µåï¼Œå‰ç«¯å…¨éƒ¨æŠ¥é”™
```

**é¿å…æ–¹æ³•ï¼š**
- æ·»åŠ æ–°å­—æ®µè€Œä¸æ˜¯ä¿®æ”¹ç°æœ‰å­—æ®µ
- å¦‚æœå¿…é¡»ä¿®æ”¹ï¼ŒåŒæ­¥æ›´æ–°æ‰€æœ‰è°ƒç”¨çš„åœ°æ–¹
- ä¿æŒå‘åå…¼å®¹

---

## ğŸ“ å’¨è¯¢æµç¨‹

### ä½•æ—¶éœ€è¦å’¨è¯¢ï¼Ÿ

ä»¥ä¸‹æƒ…å†µ**å¿…é¡»å…ˆå’¨è¯¢**ï¼š

1. âš ï¸ ä¿®æ”¹ä¼šå½±å“å¤šä¸ªæ–‡ä»¶ï¼ˆè¶…è¿‡ 3 ä¸ªï¼‰
2. âš ï¸ ä¿®æ”¹æ ¸å¿ƒè®¡ç®—é€»è¾‘æˆ–æ•°æ®ç»“æ„
3. âš ï¸ ä¿®æ”¹ API æ¥å£å®šä¹‰
4. âš ï¸ ä¸ç¡®å®šä¿®æ”¹æ˜¯å¦ä¼šå½±å“å…¶ä»–åŠŸèƒ½
5. âš ï¸ éœ€è¦é‡æ„ç°æœ‰ä»£ç 

### å’¨è¯¢å†…å®¹æ¨¡æ¿

```
ã€å’¨è¯¢ã€‘éœ€æ±‚ï¼š<ç®€è¿°éœ€æ±‚>

å½±å“èŒƒå›´ï¼š
- éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š<æ–‡ä»¶åˆ—è¡¨>
- å¯èƒ½å½±å“çš„åŠŸèƒ½ï¼š<åŠŸèƒ½åˆ—è¡¨>
- å½±å“è¯„ä¼°ï¼šä½/ä¸­/é«˜

ä¿®æ”¹æ–¹æ¡ˆï¼š
1. <æ–¹æ¡ˆæè¿°>
2. <ä¸ºä»€ä¹ˆè¦è¿™æ ·æ”¹>

é—®é¢˜ï¼š
- <ä¸ç¡®å®šçš„åœ°æ–¹>

è¯·ç¡®è®¤æ˜¯å¦å¯ä»¥è¿›è¡Œä¿®æ”¹ã€‚
```

---

## âœ… å¼€å‘æµç¨‹æ€»ç»“

```
1. ğŸ“‹ æ¥æ”¶éœ€æ±‚
   â†“
2. ğŸ¯ æ˜ç¡®ç›®æ ‡ï¼ˆè¦å®ç°ä»€ä¹ˆåŠŸèƒ½ï¼‰
   â†“
3. ğŸ” å®šä½æ–‡ä»¶ï¼ˆéœ€è¦ä¿®æ”¹å“ªäº›æ–‡ä»¶ï¼‰
   â†“
4. âš ï¸ è¯„ä¼°å½±å“ï¼ˆä¼šä¸ä¼šå½±å“å…¶ä»–åŠŸèƒ½ï¼‰
   â†“
5. â“ å’¨è¯¢ç¡®è®¤ï¼ˆå¦‚æœæœ‰å½±å“ï¼Œå…ˆå’¨è¯¢ï¼‰
   â†“
6. âœï¸ æœ€å°åŒ–ä¿®æ”¹ï¼ˆåªæ”¹å¿…è¦çš„ä»£ç ï¼‰
   â†“
7. ğŸ§ª åŠŸèƒ½æµ‹è¯•ï¼ˆæ–°åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼‰
   â†“
8. ğŸ”„ å›å½’æµ‹è¯•ï¼ˆå…¶ä»–åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼‰
   â†“
9. ğŸ“ æäº¤ä»£ç ï¼ˆæ¸…æ™°çš„ commit messageï¼‰
   â†“
10. âœ… å®Œæˆ
```

---

## ğŸ“ å­¦ä¹ å»ºè®®

1. **ç†Ÿæ‚‰é¡¹ç›®ç»“æ„**
   - èŠ±æ—¶é—´ç†è§£æ¯ä¸ªç›®å½•çš„ä½œç”¨
   - çŸ¥é“å“ªäº›æ–‡ä»¶æ˜¯æ ¸å¿ƒæ–‡ä»¶ï¼ˆä¸èƒ½éšä¾¿æ”¹ï¼‰

2. **ç†è§£æ•°æ®æµ**
   - æ•°æ®å¦‚ä½•ä»åç«¯åˆ°å‰ç«¯
   - æ•°æ®å¦‚ä½•åœ¨å‰ç«¯å„ä¸ª JS æ–‡ä»¶é—´æµåŠ¨

3. **å‚è€ƒå†å²ä¿®æ”¹**
   - çœ‹ Git å†å²ï¼Œå­¦ä¹ å¦‚ä½•æ­£ç¡®ä¿®æ”¹
   - çœ‹æ–‡æ¡£ä¸­çš„ç¤ºä¾‹ä»£ç 

4. **é‡åˆ°é—®é¢˜å…ˆå’¨è¯¢**
   - ä¸ç¡®å®šæ—¶ï¼Œå…ˆé—®
   - é¿å…ç›²ç›®ä¿®æ”¹é€ æˆæ›´å¤§çš„é—®é¢˜

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é¡¹ç›® README](../README.md)
- [å¾®æœåŠ¡ç®¡ç†å¿«é€Ÿå‚è€ƒ](./å¾®æœåŠ¡ç®¡ç†å¿«é€Ÿå‚è€ƒ.md) â­ æ–°å¢
- [å¾®æœåŠ¡é‡å¯é”™è¯¯æ’æŸ¥](./å¾®æœåŠ¡é‡å¯é”™è¯¯æ’æŸ¥.md) â­ æ–°å¢
- [API æ–‡æ¡£](./api_documentation.md)
- [éƒ¨ç½²æ–‡æ¡£](./docker_deployment.md)

---

**è®°ä½ï¼šå¢åŠ æ–°åŠŸèƒ½æˆ–ä¿®æ”¹å†…å®¹æ—¶ï¼Œåšå†³ä¸å¯æ”¹åŠ¨ä¸ä¹‹æ— å…³çš„ä»£ç ï¼å¦‚æœä¼šå¼•èµ·å…¶ä»–åŠŸèƒ½æˆ–ä»£ç å˜åŒ–ï¼Œè¦å…ˆå’¨è¯¢ç¡®è®¤åå†ä¿®æ”¹ï¼**

---

*æœ€åæ›´æ–°ï¼š2025-01-21*
*ç‰ˆæœ¬ï¼šv2.0*
*æ›´æ–°å†…å®¹ï¼šæ–°å¢è§„åˆ™ç³»ç»Ÿå¼€å‘è§„èŒƒç« èŠ‚*

