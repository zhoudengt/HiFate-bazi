# ACR é…ç½®éªŒè¯æ¸…å•

## ğŸ“‹ ä»é˜¿é‡Œäº‘æ§åˆ¶å°æå–çš„é…ç½®ä¿¡æ¯

åŸºäºæ‚¨æä¾›çš„é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡æˆªå›¾ï¼Œä»¥ä¸‹æ˜¯æ­£ç¡®çš„é…ç½®å€¼ï¼š

### âœ… æ­£ç¡®çš„é…ç½®å€¼

| Secret åç§° | æœŸæœ›å€¼ | è¯´æ˜ |
|------------|--------|------|
| `ACR_REGISTRY` | `crpi-llets4xvyuzoxiyx.cn-beijing.personal.cr.aliyuncs.com` | å…¬ç½‘åœ°å€ï¼ˆä¸æ˜¯ VPC åœ°å€ï¼‰ |
| `ACR_NAMESPACE` | `hifate-bazi-namespaces` | å‘½åç©ºé—´ï¼ˆæ³¨æ„å¤§å°å†™ï¼‰ |
| `ACR_USERNAME` | `aliyun3959725177` | é˜¿é‡Œäº‘è´¦å·åï¼ˆæˆ– AccessKey IDï¼‰ |
| `ACR_PASSWORD` | `[æ‚¨çš„è®¿é—®å¯†ç æˆ– AccessKey Secret]` | è®¿é—®å¯†ç æˆ– AccessKey Secret |

### ğŸ“¦ å®Œæ•´é•œåƒåœ°å€æ ¼å¼

```
crpi-llets4xvyuzoxiyx.cn-beijing.personal.cr.aliyuncs.com/hifate-bazi-namespaces/hifate-bazi:<tag>
```

**ç¤ºä¾‹**ï¼š
- `crpi-llets4xvyuzoxiyx.cn-beijing.personal.cr.aliyuncs.com/hifate-bazi-namespaces/hifate-bazi:master`
- `crpi-llets4xvyuzoxiyx.cn-beijing.personal.cr.aliyuncs.com/hifate-bazi-namespaces/hifate-bazi:latest`

---

## ğŸ” é…ç½®æ ¼å¼éªŒè¯

### 1. ACR_REGISTRY

**æœŸæœ›å€¼**ï¼š`crpi-llets4xvyuzoxiyx.cn-beijing.personal.cr.aliyuncs.com`

**æ£€æŸ¥ç‚¹**ï¼š
- âœ… ä½¿ç”¨å…¬ç½‘åœ°å€ï¼ˆä¸æ˜¯ VPC åœ°å€ `-vpc`ï¼‰
- âœ… ä¸åŒ…å« `http://` æˆ– `https://` å‰ç¼€
- âœ… æ ¼å¼ï¼š`å®ä¾‹ID.åœ°åŸŸ.personal.cr.aliyuncs.com`
- âœ… ä¸é˜¿é‡Œäº‘æ§åˆ¶å°æ˜¾ç¤ºçš„"å…¬ç½‘åœ°å€"ä¸€è‡´

**å¸¸è§é”™è¯¯**ï¼š
- âŒ ä½¿ç”¨ VPC åœ°å€ï¼š`crpi-llets4xvyuzoxiyx-vpc.cn-beijing.personal.cr.aliyuncs.com`
- âŒ åŒ…å«åè®®å‰ç¼€ï¼š`https://crpi-llets4xvyuzoxiyx.cn-beijing.personal.cr.aliyuncs.com`
- âŒ å¤šç©ºæ ¼æˆ–æ¢è¡Œ

---

### 2. ACR_NAMESPACE

**æœŸæœ›å€¼**ï¼š`hifate-bazi-namespaces`

**æ£€æŸ¥ç‚¹**ï¼š
- âœ… ä¸é˜¿é‡Œäº‘æ§åˆ¶å°ä¸­çš„å‘½åç©ºé—´åç§°**å®Œå…¨ä¸€è‡´**
- âœ… æ³¨æ„å¤§å°å†™ï¼ˆå…¨å°å†™ï¼‰
- âœ… ä¸åŒ…å«å‰åç©ºæ ¼

**å¸¸è§é”™è¯¯**ï¼š
- âŒ å¤§å°å†™é”™è¯¯ï¼š`Hifate-Bazi-Namespaces` æˆ– `HIFATE-BAZI-NAMESPACES`
- âŒ æ‹¼å†™é”™è¯¯ï¼š`hifate-bazi-namespace`ï¼ˆå°‘äº†ä¸€ä¸ª sï¼‰
- âŒ å‰åç©ºæ ¼

---

### 3. ACR_USERNAME

**æœŸæœ›å€¼**ï¼š`aliyun3959725177`ï¼ˆé˜¿é‡Œäº‘è´¦å·åï¼‰

**è¯´æ˜**ï¼š
- âœ… å¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘è´¦å·åï¼ˆå¦‚ï¼š`aliyun3959725177`ï¼‰
- âœ… ä¹Ÿå¯ä»¥ä½¿ç”¨ AccessKey IDï¼ˆæ ¼å¼ï¼š`LTAI...`ï¼Œé€šå¸¸ä»¥ `LTAI` å¼€å¤´ï¼‰
- âš ï¸ æ³¨æ„ï¼šå¦‚æœæ˜¯ RAM å­è´¦å·ï¼Œä¸æ”¯æŒåŒ…å«ç‚¹å·çš„åˆ«å

**æ£€æŸ¥ç‚¹**ï¼š
- âœ… å¦‚æœä½¿ç”¨è´¦å·åï¼šä¸ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°çš„è´¦å·ä¸€è‡´
- âœ… å¦‚æœä½¿ç”¨ AccessKey IDï¼šæ ¼å¼ä¸º `LTAI` å¼€å¤´
- âœ… ä¸åŒ…å«å‰åç©ºæ ¼

**å¸¸è§é”™è¯¯**ï¼š
- âŒ ä½¿ç”¨äº† AccessKey Secret ä½œä¸ºç”¨æˆ·åï¼ˆåº”è¯¥æ˜¯ AccessKey IDï¼‰
- âŒ ä½¿ç”¨äº†åŒ…å«ç‚¹å·çš„ RAM å­è´¦å·åˆ«å

---

### 4. ACR_PASSWORD

**æœŸæœ›å€¼**ï¼š`[æ‚¨çš„è®¿é—®å¯†ç æˆ– AccessKey Secret]`

**è¯´æ˜**ï¼š
- âœ… å¦‚æœä½¿ç”¨è´¦å·å¯†ç ï¼šæ˜¯åœ¨å¼€é€šå®¹å™¨é•œåƒæœåŠ¡æ—¶è®¾ç½®çš„è®¿é—®å¯†ç 
- âœ… å¦‚æœä½¿ç”¨ AccessKeyï¼šæ˜¯ AccessKey Secretï¼ˆä¸æ˜¯ AccessKey IDï¼‰
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¸è¦æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–æ¢è¡Œ

**æ£€æŸ¥ç‚¹**ï¼š
- âœ… å¦‚æœä½¿ç”¨è´¦å·å¯†ç ï¼šåœ¨é˜¿é‡Œäº‘æ§åˆ¶å°"è®¿é—®å‡­è¯"ä¸­å¯ä»¥è®¾ç½®/æŸ¥çœ‹
- âœ… å¦‚æœä½¿ç”¨ AccessKey Secretï¼šæ ¼å¼é€šå¸¸è¾ƒé•¿ï¼ˆ30+ å­—ç¬¦ï¼‰
- âœ… æ²¡æœ‰å‰åç©ºæ ¼æˆ–æ¢è¡Œ

**å¦‚ä½•æŸ¥æ‰¾**ï¼š
1. **ä½¿ç”¨è®¿é—®å¯†ç **ï¼š
   - ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°
   - è¿›å…¥"å®¹å™¨é•œåƒæœåŠ¡" > "è®¿é—®å‡­è¯"
   - è®¾ç½®æˆ–æŸ¥çœ‹è®¿é—®å¯†ç 

2. **ä½¿ç”¨ AccessKey**ï¼ˆæ¨èï¼‰ï¼š
   - ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°
   - è¿›å…¥"è®¿é—®æ§åˆ¶" > "AccessKey ç®¡ç†"
   - åˆ›å»º AccessKeyï¼ˆè·å– AccessKey ID å’Œ AccessKey Secretï¼‰
   - `ACR_USERNAME` = AccessKey ID
   - `ACR_PASSWORD` = AccessKey Secret

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### æ–¹æ³• 1: ä½¿ç”¨ GitHub Actions æµ‹è¯•ï¼ˆæ¨èï¼‰

**æ­¥éª¤**ï¼š
1. è®¿é—® GitHub Actions é¡µé¢ï¼š
   ```
   https://github.com/zhoudengt/HiFate-bazi/actions
   ```

2. é€‰æ‹© `ğŸ§ª Test ACR Configuration` workflow

3. ç‚¹å‡»å³ä¸Šè§’çš„ `Run workflow` æŒ‰é’®

4. é€‰æ‹©æµ‹è¯•ç±»å‹ï¼š`login_only`ï¼ˆä»…æµ‹è¯•ç™»å½•ï¼‰

5. ç‚¹å‡»ç»¿è‰²çš„ `Run workflow` æŒ‰é’®

6. æŸ¥çœ‹æµ‹è¯•ç»“æœï¼š
   - âœ… å¦‚æœæ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œè¯´æ˜é…ç½®æ­£ç¡®
   - âŒ å¦‚æœç™»å½•å¤±è´¥ï¼ŒæŸ¥çœ‹é”™è¯¯ä¿¡æ¯å¹¶ä¿®æ­£é…ç½®

**æµ‹è¯•å†…å®¹**ï¼š
- âœ… æ£€æŸ¥æ‰€æœ‰ 4 ä¸ª secrets æ˜¯å¦å·²é…ç½®
- âœ… æ˜¾ç¤ºé…ç½®çš„å€¼ï¼ˆå¯†ç éšè—ï¼‰
- âœ… æµ‹è¯• Docker ç™»å½•åˆ° ACR
- âœ… æ˜¾ç¤ºé•œåƒåç§°æ ¼å¼

---

### æ–¹æ³• 2: æœ¬åœ°æµ‹è¯• Docker ç™»å½•

**æ­¥éª¤**ï¼š
1. ç¡®ä¿æœ¬åœ°å·²å®‰è£… Docker

2. è¿è¡Œ Docker ç™»å½•å‘½ä»¤ï¼š
   ```bash
   docker login crpi-llets4xvyuzoxiyx.cn-beijing.personal.cr.aliyuncs.com -u aliyun3959725177
   ```

3. è¾“å…¥å¯†ç ï¼ˆAccessKey Secret æˆ–è®¿é—®å¯†ç ï¼‰

4. æŸ¥çœ‹ç»“æœï¼š
   - âœ… `Login Succeeded` - é…ç½®æ­£ç¡®
   - âŒ `Error response from daemon: Get ... unauthorized` - ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯

---

### æ–¹æ³• 3: è¿è¡Œæœ¬åœ°æ£€æŸ¥è„šæœ¬

**æ­¥éª¤**ï¼š
1. è¿è¡Œæ£€æŸ¥è„šæœ¬ï¼š
   ```bash
   bash scripts/check_acr_secrets.sh
   ```

2. æŸ¥çœ‹è¾“å‡ºï¼Œç¡®è®¤æ ¼å¼æ˜¯å¦æ­£ç¡®

**æ³¨æ„**ï¼šæœ¬åœ°è„šæœ¬åªèƒ½æ£€æŸ¥æ ¼å¼ï¼Œæ— æ³•æµ‹è¯•å®é™…çš„ç™»å½•ï¼ˆå› ä¸ºæ— æ³•è®¿é—® GitHub Secretsï¼‰

---

## âœ… é…ç½®æ£€æŸ¥æ¸…å•

åœ¨ GitHub Secrets ä¸­é€ä¸€æ£€æŸ¥ï¼š

### æ­¥éª¤ 1: è®¿é—® GitHub Secrets é¡µé¢

```
https://github.com/zhoudengt/HiFate-bazi/settings/secrets/actions
```

### æ­¥éª¤ 2: æ£€æŸ¥æ¯ä¸ª Secret

#### ACR_REGISTRY
- [ ] æ˜¯å¦å­˜åœ¨
- [ ] å€¼æ˜¯å¦ä¸ºï¼š`crpi-llets4xvyuzoxiyx.cn-beijing.personal.cr.aliyuncs.com`
- [ ] æ˜¯å¦ä½¿ç”¨å…¬ç½‘åœ°å€ï¼ˆä¸æ˜¯ VPC åœ°å€ï¼‰
- [ ] æ˜¯å¦ä¸åŒ…å« `http://` æˆ– `https://` å‰ç¼€

#### ACR_NAMESPACE
- [ ] æ˜¯å¦å­˜åœ¨
- [ ] å€¼æ˜¯å¦ä¸ºï¼š`hifate-bazi-namespaces`
- [ ] å¤§å°å†™æ˜¯å¦æ­£ç¡®ï¼ˆå…¨å°å†™ï¼‰
- [ ] æ˜¯å¦ä¸é˜¿é‡Œäº‘æ§åˆ¶å°ä¸­çš„å‘½åç©ºé—´åç§°ä¸€è‡´

#### ACR_USERNAME
- [ ] æ˜¯å¦å­˜åœ¨
- [ ] å€¼æ˜¯å¦ä¸ºï¼š`aliyun3959725177` æˆ– AccessKey ID
- [ ] å¦‚æœä½¿ç”¨ AccessKey IDï¼Œæ ¼å¼æ˜¯å¦ä¸º `LTAI...` å¼€å¤´
- [ ] æ˜¯å¦ä¸åŒ…å«å‰åç©ºæ ¼

#### ACR_PASSWORD
- [ ] æ˜¯å¦å­˜åœ¨
- [ ] å€¼æ˜¯å¦ä¸ºè®¿é—®å¯†ç æˆ– AccessKey Secret
- [ ] æ˜¯å¦å®Œæ•´å¤åˆ¶ï¼ˆæ²¡æœ‰é—æ¼å­—ç¬¦ï¼‰
- [ ] æ˜¯å¦ä¸åŒ…å«å‰åç©ºæ ¼æˆ–æ¢è¡Œ

---

## âš ï¸ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: Docker ç™»å½•å¤±è´¥ - unauthorized

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Error response from daemon: Get "https://...": unauthorized: authentication required
```

**å¯èƒ½åŸå› **ï¼š
1. `ACR_USERNAME` ä¸æ­£ç¡®
2. `ACR_PASSWORD` ä¸æ­£ç¡®
3. AccessKey æœªå¯ç”¨æˆ–æ²¡æœ‰ ACR è®¿é—®æƒé™

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ `ACR_USERNAME` æ˜¯è´¦å·åæˆ– AccessKey IDï¼ˆä¸æ˜¯ AccessKey Secretï¼‰
2. ç¡®è®¤ `ACR_PASSWORD` æ˜¯è®¿é—®å¯†ç æˆ– AccessKey Secret
3. å¦‚æœä½¿ç”¨ AccessKeyï¼Œç¡®è®¤ AccessKey å·²å¯ç”¨ä¸”æœ‰ ACR è®¿é—®æƒé™

---

### é—®é¢˜ 2: é•œåƒæ¨é€å¤±è´¥ - repository does not exist

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Error response from daemon: repository does not exist
```

**å¯èƒ½åŸå› **ï¼š
1. `ACR_NAMESPACE` ä¸æ­£ç¡®ï¼ˆå¤§å°å†™æˆ–æ‹¼å†™é”™è¯¯ï¼‰
2. å‘½åç©ºé—´ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `ACR_NAMESPACE` æ˜¯å¦ä¸é˜¿é‡Œäº‘æ§åˆ¶å°ä¸­çš„å‘½åç©ºé—´åç§°å®Œå…¨ä¸€è‡´
2. åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°ç¡®è®¤å‘½åç©ºé—´æ˜¯å¦å­˜åœ¨
3. æ³¨æ„å¤§å°å†™ï¼ˆåº”è¯¥æ˜¯å…¨å°å†™ï¼š`hifate-bazi-namespaces`ï¼‰

---

### é—®é¢˜ 3: é•œåƒæ¨é€å¤±è´¥ - denied: requested access to the resource is denied

**é”™è¯¯ä¿¡æ¯**ï¼š
```
denied: requested access to the resource is denied
```

**å¯èƒ½åŸå› **ï¼š
1. è´¦å·æ²¡æœ‰æ¨é€é•œåƒçš„æƒé™
2. AccessKey æƒé™ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤è´¦å·æœ‰å®¹å™¨é•œåƒæœåŠ¡çš„æ¨é€æƒé™
2. å¦‚æœä½¿ç”¨ RAM å­è´¦å·ï¼Œç¡®è®¤å·²æˆäºˆ ACR ç›¸å…³æƒé™
3. æ£€æŸ¥ AccessKey çš„æƒé™èŒƒå›´

---

### é—®é¢˜ 4: æ„å»ºæˆåŠŸä½†æ¨é€å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
1. `ACR_REGISTRY` ä½¿ç”¨äº† VPC åœ°å€ï¼ˆGitHub Actions æ— æ³•è®¿é—®ï¼‰
2. ç½‘ç»œé—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ `ACR_REGISTRY` ä½¿ç”¨å…¬ç½‘åœ°å€ï¼ˆä¸æ˜¯ `-vpc` åœ°å€ï¼‰
2. æ£€æŸ¥ GitHub Actions çš„ç½‘ç»œè¿æ¥
3. æŸ¥çœ‹æ„å»ºæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

---

## ğŸ“Š é…ç½®éªŒè¯ç»“æœ

### éªŒè¯æ­¥éª¤

1. âœ… **æ ¼å¼éªŒè¯**ï¼šä½¿ç”¨ `scripts/check_acr_secrets.sh` æ£€æŸ¥æ ¼å¼
2. âœ… **GitHub Actions æµ‹è¯•**ï¼šä½¿ç”¨ `test-acr-config.yml` æµ‹è¯•ç™»å½•
3. âœ… **æ„å»ºæµ‹è¯•**ï¼šæ¨é€ä»£ç ï¼ŒæŸ¥çœ‹ `build-and-push.yml` æ˜¯å¦æˆåŠŸ

### éªŒè¯ç»“æœ

å¦‚æœæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œé…ç½®æ­£ç¡®ï¼

---

## ğŸ“ å¿«é€Ÿå‚è€ƒ

### GitHub Secrets é…ç½®é¡µé¢
```
https://github.com/zhoudengt/HiFate-bazi/settings/secrets/actions
```

### GitHub Actions æµ‹è¯•é¡µé¢
```
https://github.com/zhoudengt/HiFate-bazi/actions/workflows/test-acr-config.yml
```

### æ­£ç¡®çš„é…ç½®å€¼
```
ACR_REGISTRY = crpi-llets4xvyuzoxiyx.cn-beijing.personal.cr.aliyuncs.com
ACR_NAMESPACE = hifate-bazi-namespaces
ACR_USERNAME = aliyun3959725177  (æˆ– AccessKey ID)
ACR_PASSWORD = [æ‚¨çš„è®¿é—®å¯†ç æˆ– AccessKey Secret]
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. âœ… ç¡®è®¤ GitHub Secrets é…ç½®æ­£ç¡®
2. âœ… ä½¿ç”¨ GitHub Actions æµ‹è¯•é…ç½®ï¼ˆ`test-acr-config.yml`ï¼‰
3. âœ… å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œæ¨é€ä»£ç è§¦å‘ `build-and-push.yml`
4. âœ… æŸ¥çœ‹æ„å»ºæ—¥å¿—ï¼Œç¡®è®¤é•œåƒæˆåŠŸæ¨é€åˆ° ACR

