# Docker åŸºç¡€é•œåƒä¼˜åŒ–æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

é€šè¿‡é¢„æ„å»ºåŒ…å«æ‰€æœ‰ Python ä¾èµ–çš„åŸºç¡€é•œåƒï¼Œå°†éƒ¨ç½²æ—¶é—´ä» **5-10 åˆ†é’Ÿ**ç¼©çŸ­åˆ° **10-20 ç§’**ã€‚

## ğŸ¯ åŸç†

```
ä¼ ç»Ÿæ–¹å¼ï¼š
python:3.11-slim â†’ å®‰è£…ä¾èµ–(5-10åˆ†é’Ÿ) â†’ å¤åˆ¶ä»£ç  â†’ è¿è¡Œ

ä¼˜åŒ–æ–¹å¼ï¼š
hifate-base:latestï¼ˆå·²å«ä¾èµ–ï¼‰â†’ å¤åˆ¶ä»£ç  â†’ è¿è¡Œï¼ˆå‡ ç§’ï¼‰
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é¦–æ¬¡æ„å»ºåŸºç¡€é•œåƒ

```bash
./scripts/docker/build_base.sh
```

**é¢„è®¡è€—æ—¶**ï¼š5-10 åˆ†é’Ÿï¼ˆä»…éœ€ä¸€æ¬¡ï¼‰

### 2. æ£€æŸ¥åŸºç¡€é•œåƒçŠ¶æ€

```bash
./scripts/docker/check_base.sh
```

### 3. æ­£å¸¸éƒ¨ç½²ï¼ˆå¿«é€Ÿï¼‰

```bash
docker compose up -d --build web
```

**é¢„è®¡è€—æ—¶**ï¼š10-20 ç§’

## âš ï¸ é‡è¦æé†’

### ä½•æ—¶éœ€è¦é‡å»ºåŸºç¡€é•œåƒ

| åœºæ™¯ | æ˜¯å¦éœ€è¦é‡å»º | å‘½ä»¤ |
|------|------------|------|
| âœ… ä¿®æ”¹ä»£ç  | âŒ ä¸éœ€è¦ | ç›´æ¥éƒ¨ç½² |
| âš ï¸ **ä¿®æ”¹ requirements.txt** | âœ… **å¿…é¡»é‡å»º** | `./scripts/docker/build_base.sh` |
| âš ï¸ ä¿®æ”¹ Dockerfile.base | âœ… éœ€è¦é‡å»º | `./scripts/docker/build_base.sh` |

### å®‰å…¨æœºåˆ¶

1. **è·¨å¹³å°å…¼å®¹**ï¼šä½¿ç”¨ `--platform linux/amd64` ç¡®ä¿ Mac M1/Intel éƒ½èƒ½æ„å»º
2. **ä¿é™©å±‚**ï¼šåº”ç”¨ Dockerfile ä¼šå†æ¬¡æ‰§è¡Œ `pip install`ï¼Œç¡®ä¿ä¾èµ–å®Œæ•´
3. **è‡ªåŠ¨æ£€æŸ¥**ï¼š`check_base.sh` ä¼šæ£€æµ‹ requirements.txt æ˜¯å¦å˜æ›´

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | ä¼ ç»Ÿæ–¹å¼ | åŸºç¡€é•œåƒ | æå‡ |
|------|---------|---------|------|
| é¦–æ¬¡éƒ¨ç½² | 10-15åˆ†é’Ÿ | 5-10åˆ†é’Ÿï¼ˆæ„å»ºåŸºç¡€é•œåƒï¼‰ | 1æ¬¡æ€§ |
| ä»£ç æ›´æ–° | 1-2åˆ†é’Ÿ | **10-20ç§’** | **6-12å€** |
| ä¾èµ–æ›´æ–° | 10-15åˆ†é’Ÿ | 5-10åˆ†é’Ÿï¼ˆé‡å»ºåŸºç¡€é•œåƒï¼‰ | 1æ¬¡æ€§ |

## ğŸ› ï¸ ç»´æŠ¤å‘½ä»¤

```bash
# æ„å»ºåŸºç¡€é•œåƒ
./scripts/docker/build_base.sh

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
./scripts/docker/check_base.sh

# æŸ¥çœ‹åŸºç¡€é•œåƒä¿¡æ¯
docker images hifate-base

# åˆ é™¤æ—§ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
docker rmi hifate-base:20241128
```

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šModuleNotFoundError

**åŸå› **ï¼šrequirements.txt å·²å˜æ›´ä½†åŸºç¡€é•œåƒæœªæ›´æ–°

**è§£å†³**ï¼š
```bash
./scripts/docker/build_base.sh
```

### é—®é¢˜2ï¼šæ„å»ºå¤±è´¥

**æ£€æŸ¥**ï¼š
- ç½‘ç»œè¿æ¥ï¼ˆéœ€è¦ä¸‹è½½ä¾èµ–ï¼‰
- requirements.txt æ ¼å¼æ˜¯å¦æ­£ç¡®
- Docker æ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´ï¼ˆè‡³å°‘ 5GBï¼‰

### é—®é¢˜3ï¼šåŸºç¡€é•œåƒä¸å­˜åœ¨

**è§£å†³**ï¼š
```bash
./scripts/docker/build_base.sh
```

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### æ–‡ä»¶ç»“æ„

```
Dockerfile.base          # åŸºç¡€é•œåƒå®šä¹‰
Dockerfile               # åº”ç”¨é•œåƒï¼ˆä½¿ç”¨åŸºç¡€é•œåƒï¼‰
scripts/docker/
  â”œâ”€â”€ build_base.sh      # æ„å»ºè„šæœ¬
  â””â”€â”€ check_base.sh      # æ£€æŸ¥è„šæœ¬
```

### åŸºç¡€é•œåƒå†…å®¹

- Python 3.11-slim
- æ‰€æœ‰ requirements.txt ä¸­çš„ä¾èµ–
- ç³»ç»Ÿä¾èµ–ï¼ˆgcc, g++, opencv ç›¸å…³åº“ç­‰ï¼‰
- å›½å†…é•œåƒæºé…ç½®ï¼ˆé˜¿é‡Œäº‘ã€æ¸…åï¼‰

### ä¿é™©å±‚æœºåˆ¶

åº”ç”¨ Dockerfile ä¸­çš„ä¿é™©å±‚ï¼š

```dockerfile
# å¦‚æœ requirements.txt æœ‰å˜æ›´ä½†åŸºç¡€é•œåƒæœªæ›´æ–°ï¼Œè¿™é‡Œä¼šè¡¥ä¸Š
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade -r requirements.txt
```

è¿™ç¡®ä¿äº†å³ä½¿å¿˜è®°æ›´æ–°åŸºç¡€é•œåƒï¼Œéƒ¨ç½²ä¹Ÿä¸ä¼šå¤±è´¥ã€‚

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å®šæœŸæ£€æŸ¥**ï¼šæ¯æ¬¡éƒ¨ç½²å‰è¿è¡Œ `check_base.sh`
2. **ç‰ˆæœ¬ç®¡ç†**ï¼šåŸºç¡€é•œåƒä½¿ç”¨æ—¥æœŸæ ‡ç­¾ï¼ˆ`hifate-base:20241128`ï¼‰
3. **æ¸…ç†æ—§ç‰ˆæœ¬**ï¼šå®šæœŸæ¸…ç†ä¸éœ€è¦çš„æ—§é•œåƒ
4. **æ–‡æ¡£æ›´æ–°**ï¼šä¿®æ”¹ requirements.txt æ—¶æ›´æ–°ç›¸å…³æ–‡æ¡£

## ğŸ“ è¿›é˜¶ä½¿ç”¨

### æ¨é€åˆ°é˜¿é‡Œäº‘ ACRï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦å¤šæœåŠ¡å™¨å…±äº«åŸºç¡€é•œåƒï¼š

```bash
# ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
docker login --username=your_username registry.cn-hangzhou.aliyuncs.com

# æ‰“æ ‡ç­¾
docker tag hifate-base:latest registry.cn-hangzhou.aliyuncs.com/hifate/base:latest

# æ¨é€
docker push registry.cn-hangzhou.aliyuncs.com/hifate/base:latest
```

### æœåŠ¡å™¨ç«¯ä½¿ç”¨

å¦‚æœæœåŠ¡å™¨éœ€è¦æ„å»ºåŸºç¡€é•œåƒï¼š

```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@123.57.216.15

# æ‹‰å–ä»£ç 
cd /opt/HiFate-bazi && git pull

# æ„å»ºåŸºç¡€é•œåƒ
./scripts/docker/build_base.sh
```

---

**è®°ä½**ï¼šä¿®æ”¹ requirements.txt åï¼Œå¿…é¡»é‡å»ºåŸºç¡€é•œåƒï¼

