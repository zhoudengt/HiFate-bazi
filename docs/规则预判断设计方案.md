# è§„åˆ™é¢„åˆ¤æ–­è®¾è®¡æ–¹æ¡ˆ

> **ç›®æ ‡**ï¼šé€šè¿‡è§„åˆ™é¢„åˆ¤æ–­ï¼Œå‡å°‘LLMæ¨ç†è´Ÿæ‹…ï¼Œæå‡åˆ†ææ·±åº¦å’Œé€Ÿåº¦

---

## ğŸ“Š å½“å‰é—®é¢˜

### ç°çŠ¶åˆ†æ

**å½“å‰æ¶æ„**ï¼š
```
ç”¨æˆ·é—®é¢˜ â†’ æ„å›¾è¯†åˆ« â†’ è§„åˆ™åŒ¹é… â†’ LLMæ·±åº¦è§£è¯»
                         â†“
                   è¿”å›åŒ¹é…çš„è§„åˆ™
                   ï¼ˆæ— é¢„åˆ¤æ–­ç»“æœï¼‰
```

**å­˜åœ¨çš„é—®é¢˜**ï¼š

1. **LLMè´Ÿæ‹…è¿‡é‡**
   - LLMéœ€è¦ä»å¤´æ¨ç†å‰å‡¶
   - LLMéœ€è¦è‡ªå·±è®¡ç®—è¯„åˆ†
   - LLMéœ€è¦åˆ¤æ–­é£é™©ç­‰çº§

2. **åˆ†æä¸å¤Ÿæ·±å…¥**
   - LLMæŠŠæ—¶é—´èŠ±åœ¨åŸºç¡€åˆ¤æ–­ä¸Š
   - æ²¡æœ‰è¶³å¤Ÿtokenåšæ·±åº¦è§£é‡Š
   - ç¼ºå°‘ç»“æ„åŒ–çš„åˆ¤æ–­ä¾æ®

3. **é€Ÿåº¦è¾ƒæ…¢**
   - LLMæ¨ç†æ—¶é—´é•¿ï¼ˆ20-25ç§’ï¼‰
   - å¤§éƒ¨åˆ†æ—¶é—´åœ¨åšé‡å¤åˆ¤æ–­

---

## ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆï¼šè§„åˆ™é¢„åˆ¤æ–­ç³»ç»Ÿ

### æ–¹æ¡ˆæ¦‚è§ˆ

```
ç”¨æˆ·é—®é¢˜ â†’ æ„å›¾è¯†åˆ« â†’ è§„åˆ™åŒ¹é… + é¢„åˆ¤æ–­ â†’ LLMæ·±åº¦è§£è¯»
                         â†“                     â†“
                   è¿”å›åŒ¹é…è§„åˆ™          åªéœ€è§£é‡Šï¼Œä¸éœ€åˆ¤æ–­
                   + é¢„åˆ¤æ–­ç»“æœ          èŠ‚çœæ¨ç†æ—¶é—´
```

### é¢„åˆ¤æ–­å†…å®¹

æ¯æ¡è§„åˆ™åŒ¹é…åï¼Œè‡ªåŠ¨ç”Ÿæˆé¢„åˆ¤æ–­ï¼š

```json
{
  "rule_code": "WEALTH_001",
  "conditions": {...},
  "description": "è´¢è¿æè¿°...",
  
  // æ–°å¢ï¼šé¢„åˆ¤æ–­ç»“æœ
  "pre_judgment": {
    "score": 3,                    // è¯„åˆ†ï¼ˆ1-10ï¼‰
    "level": "å·®",                  // ç­‰çº§ï¼šå¥½/ä¸­/å·®
    "tendency": "ä¸‹é™",             // è¶‹åŠ¿ï¼šä¸Šå‡/ç¨³å®š/ä¸‹é™
    "risk_level": "é«˜",             // é£é™©ï¼šä½/ä¸­/é«˜
    "key_factors": [               // å…³é”®å› ç´ 
      "åŠ«è´¢",
      "åœŸæ—ºå…‹æ°´"
    ],
    "five_element_impact": {       // äº”è¡Œå½±å“
      "favorable": ["é‡‘", "æ°´"],
      "unfavorable": ["åœŸ", "æœ¨"]
    },
    "ten_god_impact": {            // åç¥å½±å“
      "strong": ["åŠ«è´¢"],
      "weak": ["æ­£è´¢"]
    }
  }
}
```

---

## ğŸ”§ å®æ–½æ–¹æ¡ˆ

### é˜¶æ®µ1ï¼šæ•°æ®å¢å¼ºï¼ˆä¸ä¿®æ”¹æ•°æ®åº“ï¼‰âœ…

**ç­–ç•¥**ï¼šåœ¨ç°æœ‰ `FortuneContextService` ä¸­å¢å¼ºæ•°æ®

**ä¿®æ”¹æ–‡ä»¶**ï¼š`server/services/fortune_context_service.py`

**å·²å®ç°çš„å¢å¼º**ï¼š
- âœ… äº”è¡Œå¹³è¡¡åˆ†æï¼ˆ`WuxingBalanceAnalyzer`ï¼‰
- âœ… å…³ç³»åˆ†æï¼ˆ`FortuneRelationAnalyzer`ï¼‰
- âœ… å–œå¿Œç¥åˆ†æï¼ˆ`WangShuaiAnalyzer`ï¼‰

**æ•°æ®æ ¼å¼**ï¼š
```python
fortune_context = {
    'time_analysis': {
        'liunian_list': [
            {
                'year': 2025,
                'stem': 'ä¹™',
                'branch': 'å·³',
                
                # å·²æœ‰çš„å¢å¼ºæ•°æ®
                'balance_analysis': {
                    'current_balance': {...},
                    'changes': {...},
                    'impact': "ç«åœŸè¿‡æ—º..."
                },
                'relation_analysis': {
                    'stem_relation': {...},
                    'branch_relation': {...}
                },
                
                # å¯ä»¥ç»§ç»­æ·»åŠ 
                'fortune_score': {
                    'wealth': 3,
                    'career': 6,
                    'health': 4,
                    'marriage': 7
                },
                'risk_factors': [
                    {'factor': 'åŠ«è´¢', 'severity': 'high'},
                    {'factor': 'åœŸæ—º', 'severity': 'medium'}
                ]
            }
        ]
    }
}
```

---

### é˜¶æ®µ2ï¼šè§„åˆ™åº“æ‰©å±•ï¼ˆå¯é€‰ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼‰

**ç­–ç•¥**ï¼šä¸ºè§„åˆ™è¡¨æ·»åŠ å¯é€‰å­—æ®µ `pre_judgment`

**æ•°æ®åº“ä¿®æ”¹**ï¼ˆå¯é€‰ï¼‰ï¼š
```sql
-- ä¸ä¿®æ”¹ç°æœ‰è¡¨ç»“æ„ï¼Œä½¿ç”¨JSONå­—æ®µæ‰©å±•
-- ç°æœ‰è§„åˆ™å¦‚æœæ²¡æœ‰ pre_judgmentï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€€åŒ–åˆ°LLMå…¨æ¨ç†æ¨¡å¼

-- ç¤ºä¾‹ï¼šä¸ºéƒ¨åˆ†é«˜é¢‘è§„åˆ™æ·»åŠ é¢„åˆ¤æ–­
UPDATE bazi_rules 
SET pre_judgment = JSON_OBJECT(
    'score', 3,
    'level', 'å·®',
    'key_factors', JSON_ARRAY('åŠ«è´¢', 'åœŸæ—ºå…‹æ°´')
)
WHERE rule_code = 'FORMULA_WEALTH_10001';
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸å½±å“ç°æœ‰è§„åˆ™ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… å¯ä»¥é€æ­¥æ·»åŠ é¢„åˆ¤æ–­
- âœ… ä¸éœ€è¦å…¨éƒ¨è§„åˆ™éƒ½æœ‰é¢„åˆ¤æ–­

---

### é˜¶æ®µ3ï¼šLLM Promptä¼˜åŒ–

**ä¿®æ”¹**ï¼š`docs/Coze_Boté…ç½®æ–‡æ¡£-å‘½ç†åˆ†æä¸“å®¶-ç²¾ç®€ç‰ˆ.md`

**å¢å¼ºPrompt**ï¼š
```markdown
## è¾“å…¥æ•°æ®è¯´æ˜

ä½ ä¼šæ”¶åˆ°ä»¥ä¸‹ç»“æ„åŒ–æ•°æ®ï¼š

1. **å…«å­—åŸå±€**ï¼šç”¨æˆ·çš„å››æŸ±ã€åç¥ã€äº”è¡Œ
2. **æµå¹´å¤§è¿**ï¼šå½“å‰/æŸ¥è¯¢çš„æ—¶é—´æ®µä¿¡æ¯
3. **äº”è¡Œå¹³è¡¡**ï¼šäº”è¡Œå¼ºå¼±å˜åŒ–åˆ†æ
4. **å…³ç³»åˆ†æ**ï¼šæµå¹´ä¸å…«å­—çš„ç”Ÿå…‹å…³ç³»
5. **é¢„åˆ¤æ–­ç»“æœ**ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š
   - score: è¯„åˆ†ï¼ˆ1-10ï¼‰
   - level: ç­‰çº§ï¼ˆå¥½/ä¸­/å·®ï¼‰
   - key_factors: å…³é”®å½±å“å› ç´ 

## åˆ†æè¦æ±‚

å¦‚æœæœ‰é¢„åˆ¤æ–­ç»“æœï¼š
- âŒ ä¸è¦é‡å¤åˆ¤æ–­å‰å‡¶
- âœ… ç›´æ¥ä½¿ç”¨é¢„åˆ¤æ–­çš„è¯„åˆ†å’Œç­‰çº§
- âœ… é‡ç‚¹è§£é‡Š"ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªåˆ†æ•°"
- âœ… æä¾›å…·ä½“åœºæ™¯å’Œå»ºè®®

å¦‚æœæ²¡æœ‰é¢„åˆ¤æ–­ç»“æœï¼š
- æŒ‰ç…§åŸæœ‰æµç¨‹å…¨é¢åˆ†æ
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”ï¼ˆé¢„æœŸï¼‰

| æŒ‡æ ‡ | å½“å‰ | ä¼˜åŒ–åï¼ˆæœ‰é¢„åˆ¤æ–­ï¼‰ | æå‡ |
|------|------|-------------------|------|
| **LLMå“åº”æ—¶é—´** | 20-25ç§’ | 10-15ç§’ | **-50%** |
| **åˆ†ææ·±åº¦** | ä¸­ | é«˜ | **+30%** |
| **tokenæ¶ˆè€—** | 3000-4000 | 2000-2500 | **-30%** |
| **å‡†ç¡®æ€§** | 85% | 90%+ | **+5%** |

---

## ğŸš€ å®æ–½è·¯çº¿å›¾

### Phase 1ï¼ˆå·²å®Œæˆï¼‰âœ…
- [x] `WuxingBalanceAnalyzer` - äº”è¡Œå¹³è¡¡åˆ†æ
- [x] `FortuneRelationAnalyzer` - å…³ç³»åˆ†æ
- [x] `WangShuaiAnalyzer` - æ—ºè¡°å–œå¿Œåˆ†æ

### Phase 2ï¼ˆæœ¬æ¬¡ä¼˜åŒ–ï¼‰âœ…
- [x] åœ¨ `FortuneContextService` ä¸­æ·»åŠ è¯„åˆ†è®¡ç®—
- [x] æ ¹æ®äº”è¡Œå’Œåç¥è®¡ç®—è´¢è¿/äº‹ä¸š/å¥åº·è¯„åˆ†
- [x] è¯†åˆ«é£é™©å› ç´ 

### Phase 3ï¼ˆæœªæ¥å¯é€‰ï¼‰
- [ ] æ•°æ®åº“æ·»åŠ  `pre_judgment` å­—æ®µï¼ˆå¯é€‰ï¼‰
- [ ] ä¸ºé«˜é¢‘è§„åˆ™æ·»åŠ é¢„åˆ¤æ–­æ•°æ®
- [ ] æœºå™¨å­¦ä¹ æ¨¡å‹è®­ç»ƒï¼ˆè‡ªåŠ¨é¢„åˆ¤æ–­ï¼‰

---

## ğŸ’» ä»£ç å®ç°ï¼ˆPhase 2ï¼‰

### 1. æ·»åŠ è¯„åˆ†è®¡ç®—å™¨

**æ–‡ä»¶**ï¼š`server/services/fortune_scoring_service.py`ï¼ˆæ–°å»ºï¼‰

```python
class FortuneScoring:
    """è¿åŠ¿è¯„åˆ†è®¡ç®—å™¨"""
    
    @staticmethod
    def calculate_wealth_score(
        balance_analysis: dict,
        relation_analysis: dict,
        xi_ji: dict
    ) -> dict:
        """
        è®¡ç®—è´¢è¿è¯„åˆ†
        
        Returns:
            {
                'score': 1-10,
                'level': 'å¥½'/'ä¸­'/'å·®',
                'risk_factors': [...],
                'favorable_factors': [...]
            }
        """
        score = 5  # åŸºå‡†åˆ†
        risk_factors = []
        favorable_factors = []
        
        # æ ¹æ®äº”è¡Œå¹³è¡¡è°ƒæ•´
        balance = balance_analysis.get('current_balance', {})
        if 'è´¢æ˜Ÿ' in xi_ji.get('xi_shen', []):
            if balance.get('è´¢æ˜Ÿå¼ºåº¦', 0) > 0:
                score += 2
                favorable_factors.append('è´¢æ˜Ÿä¸ºå–œç¥ä¸”æœ‰åŠ›')
            else:
                score -= 1
                risk_factors.append('è´¢æ˜Ÿä¸ºå–œç¥ä½†æ— åŠ›')
        
        # æ ¹æ®ç”Ÿå…‹å…³ç³»è°ƒæ•´
        if relation_analysis.get('has_wealth_harm'):
            score -= 2
            risk_factors.append('è´¢æ˜Ÿå—å…‹')
        
        # è¯„çº§
        if score >= 7:
            level = 'å¥½'
        elif score >= 4:
            level = 'ä¸­'
        else:
            level = 'å·®'
        
        return {
            'score': max(1, min(10, score)),
            'level': level,
            'risk_factors': risk_factors,
            'favorable_factors': favorable_factors
        }
```

### 2. é›†æˆåˆ° FortuneContextService

**ä¿®æ”¹**ï¼š`server/services/fortune_context_service.py`

```python
from server.services.fortune_scoring_service import FortuneScoring

class FortuneContextService:
    @staticmethod
    def get_fortune_context(...):
        # ... ç°æœ‰ä»£ç  ...
        
        # ä¸ºæ¯ä¸ªæµå¹´æ·»åŠ è¯„åˆ†é¢„åˆ¤æ–­
        for liunian in liunian_list:
            # å·²æœ‰çš„åˆ†æ
            liunian['balance_analysis'] = balance_analyzer.analyze(...)
            liunian['relation_analysis'] = relation_analyzer.analyze(...)
            
            # æ–°å¢ï¼šè¯„åˆ†é¢„åˆ¤æ–­
            if intent_types and 'wealth' in intent_types:
                liunian['wealth_score'] = FortuneScoring.calculate_wealth_score(
                    liunian['balance_analysis'],
                    liunian['relation_analysis'],
                    xi_ji
                )
            
            # å¯ä»¥ä¸ºå…¶ä»–æ„å›¾ç±»å‹æ·»åŠ è¯„åˆ†
            # ...
```

---

## âš ï¸ å…¼å®¹æ€§ä¿è¯

### å‘åå…¼å®¹ç­–ç•¥

1. **é¢„åˆ¤æ–­ä¸ºå¯é€‰**
   - ç°æœ‰è§„åˆ™æ²¡æœ‰é¢„åˆ¤æ–­ â†’ æ­£å¸¸å·¥ä½œ
   - æ–°è§„åˆ™æœ‰é¢„åˆ¤æ–­ â†’ åˆ©ç”¨é¢„åˆ¤æ–­

2. **LLMè‡ªåŠ¨é€‚é…**
   - æ£€æµ‹åˆ°é¢„åˆ¤æ–­ â†’ ä½¿ç”¨é¢„åˆ¤æ–­
   - æœªæ£€æµ‹åˆ° â†’ å…¨æ¨ç†æ¨¡å¼

3. **æ¸è¿›å¼è¿ç§»**
   - ä¸éœ€è¦ä¸€æ¬¡æ€§ä¿®æ”¹æ‰€æœ‰è§„åˆ™
   - å¯ä»¥å…ˆä¸ºé«˜é¢‘åœºæ™¯æ·»åŠ é¢„åˆ¤æ–­
   - é€æ­¥æ‰©å±•è¦†ç›–èŒƒå›´

---

## ğŸ“ æ€»ç»“

### å·²å®Œæˆçš„ä¼˜åŒ–âœ…

1. **äº”è¡Œå¹³è¡¡åˆ†æ** - åŠ¨æ€åˆ†ææµå¹´å¯¹äº”è¡Œçš„å½±å“
2. **å…³ç³»åˆ†æ** - æµå¹´ä¸å…«å­—çš„ç”Ÿå…‹å…³ç³»
3. **å–œå¿Œç¥åˆ†æ** - æ ¹æ®æ—ºè¡°ç¡®å®šå–œå¿Œ

### æœ¬æ¬¡æ–°å¢âœ…

4. **è¯„åˆ†ç³»ç»Ÿ** - æ ¹æ®åˆ†æç»“æœè‡ªåŠ¨è¯„åˆ†
5. **é£é™©è¯†åˆ«** - è¯†åˆ«å…³é”®é£é™©å› ç´ 
6. **æœ‰åˆ©å› ç´ è¯†åˆ«** - è¯†åˆ«æœ‰åˆ©æ¡ä»¶

### æ ¸å¿ƒåŸåˆ™

- âœ… **ä¸å½±å“ç°æœ‰åŠŸèƒ½**ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… **å¯é€‰æ¸è¿›å¼è¿ç§»**ï¼ˆä¸éœ€è¦ä¸€æ¬¡æ€§ä¿®æ”¹ï¼‰
- âœ… **æ™ºèƒ½é€€åŒ–**ï¼ˆæ— é¢„åˆ¤æ–­æ—¶è‡ªåŠ¨å…¨æ¨ç†ï¼‰

---

**å®æ–½å»ºè®®**ï¼šå…ˆå®æ–½Phase 2ï¼ˆè¯„åˆ†ç³»ç»Ÿï¼‰ï¼Œæµ‹è¯•æ•ˆæœåå†è€ƒè™‘Phase 3ï¼ˆæ•°æ®åº“æ‰©å±•ï¼‰ã€‚

