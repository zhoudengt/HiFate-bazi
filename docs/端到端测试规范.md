# 端到端测试规范

**版本**：v1.0  
**更新日期**：2025-11-25  
**适用范围**：所有涉及 Intent Service 的功能修改

---

## 📋 目录

1. [为什么需要端到端测试](#为什么需要端到端测试)
2. [测试时机](#测试时机)
3. [测试范围](#测试范围)
4. [测试流程](#测试流程)
5. [测试脚本](#测试脚本)
6. [测试用例设计原则](#测试用例设计原则)
7. [验收标准](#验收标准)

---

## ❓ 为什么需要端到端测试

### 问题背景
在时间意图识别的架构重构中，我们发现：
- ❌ **修改了Prompt，但服务未重启** → 新Prompt未生效
- ❌ **只测试了示例中的年份** → 边界情况（如"十年"）未覆盖
- ❌ **LLM返回格式不符合预期** → 下游代码报错

### 端到端测试的价值
1. ✅ **验证完整流程**：从用户输入 → Intent Service → Smart Fortune API → 返回结果
2. ✅ **覆盖边界情况**：不仅测试示例，还测试边界（3年、10年、20年）
3. ✅ **确保服务已重启**：如果服务未重启，测试会失败
4. ✅ **回归测试**：确保新功能不影响旧功能

---

## ⏰ 测试时机

### 必须执行端到端测试的情况

| 修改类型 | 示例 | 测试时机 |
|---------|------|---------|
| **Prompt修改** | 修改 Intent Prompt | ✅ 修改后、重启服务后 |
| **Intent Service代码修改** | 修改 classifier.py | ✅ 修改后、重启服务后 |
| **API接口修改** | 修改 smart_fortune.py | ✅ 修改后、重启服务后 |
| **新功能添加** | 增加新的时间类型 | ✅ 开发完成后 |
| **Bug修复** | 修复时间识别错误 | ✅ 修复后 |
| **依赖升级** | 升级LLM版本 | ✅ 升级后 |

### 测试频率
- **开发阶段**：每次修改后
- **发布前**：必须全部通过
- **生产环境**：每次部署后（冒烟测试）

---

## 📦 测试范围

### 测试类别

#### 1. 基础时间表达
- 今年、明年、后年
- 未指定时间（默认今年）

#### 2. 后N年表达（重点）
- 后三年、后五年
- **边界测试**：后十年、后八年、后二十年

#### 3. 未来N年表达
- 未来三年、未来五年
- **边界测试**：未来十年

#### 4. 接下来N年表达
- 接下来三年
- **边界测试**：接下来十年

#### 5. 明确年份范围
- 2025-2028年
- 2025到2030年
- 单个年份（2025年）

#### 6. 最近N年表达
- 最近两年、最近三年
- 近几年（默认3年）

#### 7. 口语化表达
- 这几年、三年内

#### 8. 命理无关问题（婉拒测试）
- 日常闲聊："你好，在吗"
- 技术问题："怎么注册账号"

---

## 🔄 测试流程

### 完整测试流程

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 修改代码/Prompt                                           │
└──────────────────────┬──────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. 重启相关服务                                              │
│    - Intent Service (端口 9008)                              │
│    - Smart Fortune API (端口 8001)                           │
└──────────────────────┬──────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. 等待服务就绪（5-10秒）                                     │
└──────────────────────┬──────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. 执行端到端测试脚本                                         │
│    ./tests/e2e_time_intent_test.sh                           │
└──────────────────────┬──────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. 检查测试结果                                              │
│    - 通过率 ≥ 95%：✅ 通过                                    │
│    - 通过率 < 95%：❌ 失败，需要修复                          │
└──────────────────────┬──────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────────┐
│ 6. 查看测试报告                                              │
│    tests/e2e_test_report_YYYYMMDD_HHMMSS.txt                 │
└─────────────────────────────────────────────────────────────┘
```

### 服务重启命令

```bash
# 方式1：使用统一启动脚本（推荐）
cd /Users/zhoudt/.cursor/worktrees/HiFate-bazi/Nc6xW
./start_all_services.sh

# 方式2：单独重启Intent Service
python3 services/intent_service/grpc_server.py > logs/intent_service_9008.log 2>&1 &

# 方式3：单独重启Smart Fortune API
.venv/bin/python server/start.py > logs/web_app_8001.log 2>&1 &
```

### 测试执行命令

```bash
# 1. 进入项目目录
cd /Users/zhoudt/.cursor/worktrees/HiFate-bazi/Nc6xW

# 2. 赋予执行权限（首次）
chmod +x tests/e2e_time_intent_test.sh

# 3. 执行测试
./tests/e2e_time_intent_test.sh

# 4. 查看详细输出（如需）
./tests/e2e_time_intent_test.sh 2>&1 | tee tests/test_output.log
```

---

## 📝 测试脚本

### 脚本位置
`tests/e2e_time_intent_test.sh`

### 脚本功能
1. ✅ 自动执行所有测试用例
2. ✅ 实时显示测试进度和结果
3. ✅ 生成测试报告
4. ✅ 返回正确的退出码（0=成功，1=失败）

### 使用方法

```bash
# 基本使用
./tests/e2e_time_intent_test.sh

# 自定义服务地址
BASE_URL=http://192.168.1.100:8001 ./tests/e2e_time_intent_test.sh

# 在CI/CD中使用
./tests/e2e_time_intent_test.sh && echo "测试通过" || (echo "测试失败" && exit 1)
```

### 输出示例

```
=========================================
端到端测试：时间意图识别（LLM）
版本：v2.0
日期：2025-11-25 12:00:00
=========================================

【类别1：基础时间表达】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
测试 #1: 基础-今年
问题: 我今年的财运如何
期望年份: [2025]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ 通过
  时间类型: this_year
  实际年份: [2025]
  时间描述: 今年（2025年）
  明确指定: false

...

=========================================
测试总结
=========================================
总测试数: 20
通过: 19
失败: 1
通过率: 95.0%
```

---

## 💡 测试用例设计原则

### 1. 不穷举，测推理能力
❌ **错误做法**：穷举所有可能
```bash
test "后三年" → [2026, 2027, 2028]
test "后四年" → [2026, 2027, 2028, 2029]
test "后五年" → [2026, 2027, 2028, 2029, 2030]
...（穷举到二十年）
```

✅ **正确做法**：测试关键点和边界
```bash
test "后三年" → [2026, 2027, 2028]  # 典型场景
test "后十年" → [2026, ..., 2035]   # 边界测试
test "后二十年" → [2026, ..., 2045] # 极限测试
```

### 2. 覆盖多种表达方式
- "后N年"、"未来N年"、"接下来N年"
- "最近N年"、"近几年"
- 口语化表达："这几年"、"N年内"

### 3. 测试边界情况
- **最小值**：明年（N=1）
- **典型值**：后三年（N=3）
- **边界值**：后十年（N=10）、后二十年（N=20）

### 4. 测试非命理问题的婉拒
- 日常闲聊
- 技术问题
- 其他领域问题

---

## ✅ 验收标准

### 通过标准
- **通过率 ≥ 95%**
- **所有边界测试通过**（十年、二十年）
- **婉拒测试通过**（非命理问题被正确拒绝）
- **无ERROR日志**

### 失败处理
1. **检查服务是否重启**
   ```bash
   curl http://localhost:8001/health
   curl http://localhost:9008  # Intent Service健康检查
   ```

2. **检查日志**
   ```bash
   tail -f logs/intent_service_9008.log
   tail -f logs/web_app_8001.log
   ```

3. **检查Prompt是否生效**
   - 确认Prompt文件已修改
   - 确认服务已重启（PID变化）
   - 确认日志中没有使用旧Prompt

4. **检查LLM返回格式**
   - 确认返回了`time_intent`字段
   - 确认`target_years`是数组格式
   - 确认`is_fortune_related`字段存在

---

## 🔧 故障排查

### 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 未找到time_intent | Intent Service未重启 | 重启Intent Service |
| 年份不正确 | Prompt未更新 | 检查Prompt文件，重启服务 |
| API无响应 | 服务未启动 | 检查服务状态，启动服务 |
| JSON解析失败 | 响应格式错误 | 检查API日志 |

### 调试命令

```bash
# 1. 检查服务状态
lsof -ti:8001  # Smart Fortune API
lsof -ti:9008  # Intent Service

# 2. 手动测试单个用例
curl "http://localhost:8001/api/v1/smart-analyze?question=%E6%88%91%E5%90%8E%E5%8D%81%E5%B9%B4%E7%9A%84%E8%B4%A2%E8%BF%90&year=1987&month=1&day=7&hour=9&gender=male" | python3 -m json.tool

# 3. 查看实时日志
tail -f logs/intent_service_9008.log | grep "时间意图"
```

---

## 📚 相关文档

- **测试脚本**：`tests/e2e_time_intent_test.sh`
- **Prompt文档**：`services/intent_service/prompts/intent_classification_v2.md`
- **架构设计**：`docs/时间意图识别-正确架构方案.md`
- **开发规范**：`docs/DEVELOPMENT_GUIDELINES.md`

---

## 🎯 核心要点

1. ✅ **每次修改后必须测试**（尤其是Prompt修改）
2. ✅ **测试边界情况**（不仅仅是示例）
3. ✅ **确保服务已重启**（新代码才能生效）
4. ✅ **通过率 ≥ 95%**（验收标准）
5. ✅ **保存测试报告**（可追溯）

---

**记住**：
- 🚫 **不要**修改Prompt后忘记重启服务
- 🚫 **不要**只测试Prompt中的示例
- 🚫 **不要**忽略边界测试（十年、二十年）
- ✅ **一定要**在发布前运行完整测试
- ✅ **一定要**检查测试报告

---

**版本历史**：
- v1.0 (2025-11-25): 初始版本，针对时间意图识别

**作者**：架构团队  
**审核**：技术负责人  
**状态**：✅ 已发布

