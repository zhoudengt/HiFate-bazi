# 开发调试指南 - 查看详细日志

## ✅ **已完成配置**

所有服务日志现在都保存到文件中，方便您查看详细信息！

---

## 📂 **日志文件位置**

| 日志文件 | 内容 | 大小 |
|---------|------|------|
| **logs/intent_service.log** | Intent识别（LLM输入输出、时间意图等） | 实时更新 |
| **logs/main_service.log** | 八字、十神、流年、大运、喜忌神等所有信息 | 实时更新 |

---

## 🔍 **查看日志的3种方式**

### **方式1：实时监控（推荐）**

使用提供的脚本实时查看：

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
./view_logs.sh
```

这会同时显示两个日志文件的实时内容，按 `Ctrl+C` 停止。

### **方式2：手动查看**

```bash
# 实时查看主服务日志（包含八字、十神、流年、大运等）
tail -f logs/main_service.log

# 实时查看Intent识别日志
tail -f logs/intent_service.log

# 同时查看两个日志
tail -f logs/intent_service.log logs/main_service.log
```

### **方式3：搜索特定信息**

使用搜索脚本快速查找：

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi

# 查看八字信息
./search_logs.sh bazi

# 查看十神信息
./search_logs.sh shishen

# 查看流年信息
./search_logs.sh liunian

# 查看大运信息
./search_logs.sh dayun

# 查看喜忌神
./search_logs.sh xiji

# 查看完整JSON数据
./search_logs.sh json

# 查看某个特定年份（如2029年）
./search_logs.sh 2029
```

---

## 🧪 **完整测试流程**

### **步骤1：启动日志监控**

打开一个终端窗口：

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
./view_logs.sh
```

保持这个窗口开着，您会实时看到所有日志。

### **步骤2：在浏览器中测试**

访问：`http://localhost:8001/frontend/smart-fortune-stream.html`

输入测试数据：
- 出生年份：1990
- 出生月份：5
- 出生日期：15
- 出生时辰：14
- 性别：男
- 问题：**2029年适合投资吗？**

点击"🚀 开始分析"

### **步骤3：查看日志输出**

在日志监控窗口中，您会看到完整的处理过程：

#### **1. Intent识别阶段**（logs/intent_service.log）

```
🔍🔍🔍🔍🔍🔍🔍🔍...
[Intent LLM] 输入识别
🔍🔍🔍🔍🔍🔍🔍🔍...
用户问题: 2029年适合投资吗？
使用缓存: True
Prompt版本: v1.0
🔍🔍🔍🔍🔍🔍🔍🔍...

✅✅✅✅✅✅✅✅...
[Intent LLM] 识别结果
✅✅✅✅✅✅✅✅...
完整JSON:
{
  "is_fortune_related": true,
  "intents": [
    "wealth"
  ],
  "time_intent": {
    "type": "specific_year",
    "target_years": [
      2029
    ],
    "description": "2029年",
    "is_explicit": true
  },
  "confidence": 0.95,
  "keywords": [
    "2029年",
    "投资"
  ],
  "reasoning": "用户询问2029年的投资运势"
}

⏰ 时间意图:
  - 类型: specific_year
  - 目标年份: [2029]
  - 描述: 2029年
✅✅✅✅✅✅✅✅...
```

#### **2. 八字计算阶段**（logs/main_service.log）

```
================================================================================
[STEP1] Intent识别完成
================================================================================
输入问题: 2029年适合投资吗？
Intent结果: {
  "is_fortune_related": true,
  "intents": ["wealth"],
  "time_intent": {
    "type": "specific_year",
    "target_years": [2029],
    "description": "2029年"
  }
}
时间意图类型: specific_year
目标年份: [2029]
时间描述: 2029年
================================================================================

================================================================================
[STEP2] 八字计算完成
================================================================================
出生日期: 1990-05-15 14:00
性别: male
八字四柱:
  year: 庚 午 (金火)
  month: 辛 巳 (金火)
  day: 壬 午 (水火)
  hour: 丁 未 (火土)
日主: 壬
十神: {"年干": "偏印", "年支": "正财", "月干": "劫财", ...}
================================================================================
```

#### **3. 流年大运阶段**（logs/main_service.log）

```
================================================================================
[STEP4] Fortune Context完成
================================================================================
返回流年数量: 1
流年列表: ['2029年己酉']
  - 2029年: 己酉 | 十神=偏印 | 五行=土金
大运: 甲申 (18-27岁)
喜忌神: xi=['水', '木'] | ji=['火', '土']
五行平衡: {"木": 0, "火": 4, "土": 1, "金": 3, "水": 1}
旺衰: 偏弱
================================================================================
```

#### **4. 传递给最终LLM**（logs/main_service.log）

```
🎯🎯🎯🎯🎯🎯🎯🎯...
[STEP5] 传递给最终LLM的完整数据
🎯🎯🎯🎯🎯🎯🎯🎯...
用户问题: 2029年适合投资吗？
意图: wealth
流年年份: 2029
流年干支: 己酉
流年十神: 偏印
大运干支: 甲申 (18-27岁)
喜神: ['水', '木']
忌神: ['火', '土']
旺衰: 偏弱

📦 完整JSON数据:
{
  "intent": "wealth",
  "question": "2029年适合投资吗？",
  "bazi": {
    "pillars": {
      "year": {
        "stem": "庚",
        "branch": "午",
        "stem_element": "金",
        "branch_element": "火"
      },
      ...
    },
    "day_stem": "壬",
    "shishen": {
      "年干": "偏印",
      "年支": "正财",
      "月干": "劫财",
      ...
    }
  },
  "liunian": {
    "year": 2029,
    "label": "2029年己酉",
    "stem": "己",
    "branch": "酉",
    "stem_element": "土",
    "branch_element": "金",
    "stem_shishen": "偏印",
    "branch_shishen": "比肩"
  },
  "dayun": {
    "stem": "甲",
    "branch": "申",
    "age_start": 18,
    "age_end": 27,
    "stem_element": "木",
    "branch_element": "金"
  },
  "metadata": {
    "has_liunian": true,
    "has_dayun": true,
    "target_year_from_question": 2029
  },
  "xi_ji": {
    "xi_shen": ["水", "木"],
    "ji_shen": ["火", "土"]
  },
  "wangshuai": "偏弱"
}
🎯🎯🎯🎯🎯🎯🎯🎯...
```

---

## 📋 **快速搜索命令**

### **在日志中搜索特定内容**

```bash
# 搜索八字四柱
grep -A 10 "八字四柱" logs/main_service.log

# 搜索十神
grep "十神:" logs/main_service.log

# 搜索流年
grep "流年列表" logs/main_service.log

# 搜索大运
grep "大运:" logs/main_service.log

# 搜索喜忌神
grep "喜忌神:" logs/main_service.log

# 搜索某个特定年份
grep "2029年" logs/main_service.log

# 搜索Intent识别结果
grep -A 20 "Intent LLM.*识别结果" logs/intent_service.log

# 搜索target_years
grep "target_years" logs/intent_service.log
```

---

## 🐛 **调试技巧**

### **1. 检查年份识别是否正确**

```bash
# 查看Intent识别的target_years
grep "target_years" logs/intent_service.log | tail -5
```

**期望看到**：`"target_years": [2029]` （如果输入是"2029年"）

### **2. 检查流年数据是否正确**

```bash
# 查看流年列表
grep "流年列表" logs/main_service.log | tail -5
```

**期望看到**：`流年列表: ['2029年己酉']`

### **3. 检查传递给LLM的数据**

```bash
# 查看完整的JSON数据
./search_logs.sh json
```

确认：
- ✅ `"year": 2029` 在 liunian 中
- ✅ `"target_year_from_question": 2029` 在 metadata 中

### **4. 查看最近的一次完整分析**

```bash
# 查看最后100行日志（包含完整流程）
tail -100 logs/main_service.log
```

---

## 📊 **日志级别说明**

日志中的不同标记：

| 标记 | 含义 | 示例 |
|-----|------|------|
| `🔍🔍🔍` | Intent输入阶段 | 用户问题识别 |
| `✅✅✅` | Intent输出阶段 | LLM识别结果 |
| `[STEP1]` | Intent识别完成 | 显示Intent结果 |
| `[STEP2]` | 八字计算完成 | 显示四柱、十神 |
| `[STEP4]` | 流年大运完成 | 显示流年、大运、喜忌神 |
| `🎯🎯🎯` | 传递给最终LLM | 显示完整JSON数据 |

---

## 🚨 **常见问题排查**

### **问题1：看不到日志输出**

**检查**：
```bash
# 检查日志文件是否存在
ls -lh logs/main_service.log

# 检查服务是否运行
ps aux | grep "uvicorn.*8001"
```

**解决**：如果服务没运行，重启服务：
```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
lsof -ti :8001 | xargs kill -9
.venv/bin/python -m uvicorn server.main:app --host 0.0.0.0 --port 8001 > logs/main_service.log 2>&1 &
```

### **问题2：日志文件太大**

**清空日志**：
```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
> logs/main_service.log
> logs/intent_service.log
echo "✅ 日志已清空"
```

### **问题3：找不到某个年份的数据**

**搜索**：
```bash
# 搜索2029年的所有信息
grep "2029" logs/main_service.log logs/intent_service.log
```

---

## 🎯 **开发调试工作流**

### **推荐工作流程**

```
1. 启动日志监控
   → ./view_logs.sh

2. 在浏览器中测试
   → http://localhost:8001/frontend/smart-fortune-stream.html

3. 观察日志输出
   → 实时查看所有步骤的详细数据

4. 如果有问题
   → 使用 ./search_logs.sh 搜索关键信息
   → 或使用 grep 命令精确查找

5. 修复代码后
   → 服务会自动重启（--reload模式）
   → 日志继续输出
```

---

## 📖 **相关文档**

- `docs/日志位置说明.md` - 日志文件详细说明
- `docs/修复记录-环境变量Token问题.md` - 环境变量配置
- `docs/日志查看指南.md` - 完整的日志查看指南

---

## ✅ **总结**

**现在您可以看到所有详细信息**：

| 数据 | 日志位置 | 查看方式 |
|------|---------|---------|
| ✅ Intent识别 | `logs/intent_service.log` | `./view_logs.sh` |
| ✅ 八字四柱 | `logs/main_service.log` | `./search_logs.sh bazi` |
| ✅ 十神 | `logs/main_service.log` | `./search_logs.sh shishen` |
| ✅ 流年 | `logs/main_service.log` | `./search_logs.sh liunian` |
| ✅ 大运 | `logs/main_service.log` | `./search_logs.sh dayun` |
| ✅ 喜忌神 | `logs/main_service.log` | `./search_logs.sh xiji` |
| ✅ 完整JSON | `logs/main_service.log` | `./search_logs.sh json` |

**开发阶段，所有信息都清晰可见！** 🚀

