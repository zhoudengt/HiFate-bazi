# 11.20算法公式规则转换 - 工作总结

## ✅ 已完成的工作

### 1. Excel读取和JSON转换 ✓

**输入：** `docs/11.20算法公式.xlsx`  
**输出：** `docs/11.20算法公式.json`

**统计结果：**
- 📊 **财富规则**：97条（✅ 有结果数据）
- 📊 **性格规则**：60条（⚠️ 结果为None）
- 📊 **总评规则**：533条（⚠️ 结果为None）
- 📊 **身体规则**：58条（⚠️ 结果为None）
- 🎯 **总计**：**748条规则**

---

### 2. 底层数据结构分析 ✓

**分析了以下数据源：**

#### ✅ 可用字段（已确认）

| 数据字段 | 位置 | 用途 |
|---------|------|------|
| `details[pillar]['main_star']` | 天干十神 | 财富规则中的"年干主星"、"月干主星"等 |
| `details[pillar]['hidden_stars']` | 地支藏干十神 | 财富规则中的"副星" |
| `ten_gods_stats['main']` | 主星统计 | 十神统计（天干） |
| `ten_gods_stats['sub']` | 副星统计 | 十神统计（地支藏干） |
| `ten_gods_stats['totals']` | 总和统计 | 主星+副星总和 |
| `element_counts` | 五行统计 | 身体规则中的五行条件 |
| `relationships['branch_relations']` | 地支关系 | 身体规则中的冲刑害合 |
| `bazi_pillars[pillar]` | 四柱干支 | 年柱、日柱等条件 |

#### ✅ 可用API（已确认）

1. **八字计算**：`POST /api/v1/bazi/calculate` → 获取基础八字数据
2. **旺衰分析**：`POST /api/v1/bazi/wangshuai` → 判断"身旺"、"极旺"
3. **大运流年**：gRPC服务 `bazi-fortune-service`

---

### 3. 规则模式分析 ✓

#### 财富规则条件模式（97条）

| 模式 | 数量 | 示例 |
|-----|------|------|
| 副星 | 44条 | `日支副星是正财` |
| 主星（未指定柱） | 25条 | `主星有正财` |
| 年干主星 | 12条 | `年干主星是正财` |
| 月干主星 | 8条 | `月干主星是正财` |
| 时干主星 | 5条 | `时干主星是正财` |
| 其他 | 3条 | 复合条件 |

#### 身体规则条件类型（58条）

| 类型 | 数量 | 示例 |
|-----|------|------|
| 五行 | 15条 | `木` |
| 日干 | 20条 | `甲` |
| 日支 | 12条 | `子` |
| 地支 | 6条 | `子午冲` |
| 天干地支 | 5条 | `对应五行属性火低于1个` |

#### 总评规则模式（533条）

- **条件类型**：年柱
- **复合条件**：年柱 + 季节 + 时辰
- **示例**：`甲子，且出生于春季，并且出生于卯时到申时`

#### 性格规则模式（60条）

- **条件类型**：日柱
- **涵盖**：60个不同日柱组合

---

### 4. 问题清单生成 ✓

**生成文件：** `docs/规则转换问题清单.md`

**关键问题（共8个）：**

1. ❓ 十神"主星"和"副星"的数据映射关系
2. ❓ 地支关系（冲刑害合）的判断方式
3. ❓ 五行统计的计算规则
4. ❓ 季节和时辰范围的定义
5. ❓ 复合条件的解析规则
6. ❓ 结果列缺失数据的处理方案
7. ❓ 两列"结果"的合并策略
8. ❓ 特殊术语（身旺、禄、长生等）的定义

**详细内容请查看：** [规则转换问题清单.md](./规则转换问题清单.md)

---

## 📋 规则示例

### 财富规则示例

```json
{
  "ID": 20001,
  "类型": "财富",
  "性别": "无论男女",
  "筛选条件1": "十神",
  "筛选条件2": "年干主星是正财",
  "数量": null,
  "结果": "祖上有基业，富贵命！"
}
```

**条件解析：**
```python
if details['year']['main_star'] == '正财':
    return "祖上有基业，富贵命！"
```

---

### 复合条件示例

```json
{
  "ID": 20003,
  "筛选条件2": "年干主星是正财，且副星有正官，并且还是身旺或极旺",
  "结果": "祖上有基业，富贵命！并且人品，婚姻，事业，家庭都会非常好。年轻的时候就会有成就。"
}
```

**条件解析（待确认）：**
```python
# 条件1：年干主星是正财
cond1 = details['year']['main_star'] == '正财'

# 条件2：副星有正官（需确认：哪一柱的副星？）
cond2 = any('正官' in details[p]['hidden_stars'] for p in ['year', 'month', 'day', 'hour'])

# 条件3：身旺或极旺（需确认：如何判断？）
wangshuai = call_wangshuai_api()
cond3 = wangshuai['status'] in ['身旺', '极旺']

if cond1 and cond2 and cond3:
    return result
```

---

### 总评规则示例

```json
{
  "ID": 30001,
  "筛选条件1": "年柱",
  "筛选条件2": "甲子，且出生于春季，并且出生于卯时到申时",
  "结果": null
}
```

**条件解析（待确认）：**
```python
# 条件1：年柱是甲子
cond1 = (bazi_pillars['year']['stem'] == '甲' and 
         bazi_pillars['year']['branch'] == '子')

# 条件2：出生于春季（需确认：春季定义？）
month = basic_info['solar_date'].month
cond2 = month in [2, 3, 4]  # 或者按农历？或节气？

# 条件3：出生于卯时到申时（需确认：范围？）
hour_branch = bazi_pillars['hour']['branch']
cond3 = hour_branch in ['卯', '辰', '巳', '午', '未', '申']

if cond1 and cond2 and cond3:
    return result  # 但result为None
```

---

## 🔄 开发规范检查清单

### ✅ 遵守开发规范

#### 1. 最小影响原则
- ✅ 本次开发为**新增功能**，不会改动现有代码
- ✅ 新建文件：
  - `server/services/formula_rule_service.py`（新建）
  - `server/api/v1/formula_analysis.py`（新建）
  - `frontend/formula-analysis.html`（新建）

#### 2. 文件职责明确
- ✅ **API层**：`server/api/v1/formula_analysis.py` - 处理HTTP请求
- ✅ **Service层**：`server/services/formula_rule_service.py` - 业务逻辑和规则匹配
- ✅ **Core层**：复用现有的 `BaziCalculator`、`WangshuaiAnalyzer`
- ✅ **Frontend**：`frontend/formula-analysis.html` - 用户界面

#### 3. 数据结构兼容
- ✅ 只使用现有数据结构，不修改
- ✅ API返回格式：
```json
{
  "matched_rules": {
    "wealth": [...],
    "character": [...],
    "summary": [...],
    "health": [...]
  },
  "total_matched": 12
}
```

#### 4. 需要确认的潜在影响
- ⚠️ 如果需要判断"身旺/极旺"，会调用 `/api/v1/bazi/wangshuai`（不修改，只调用）
- ⚠️ 如果需要农历月份，需要确认现有数据中是否包含

---

## 🎯 待办事项（等待用户确认）

### 优先级1：关键问题（阻塞开发）

- [ ] **问题1**：确认"年干主星"、"副星"等术语的数据映射
- [ ] **问题3**：确认五行统计规则（是否直接用`element_counts`）
- [ ] **问题5**：确认"副星有正官"是指哪一柱的副星（年柱？全部？）
- [ ] **问题8**：确认"身旺"、"极旺"的判断方式

### 优先级2：数据完善（影响功能完整性）

- [ ] **问题6**：补充性格、总评、身体规则的结果数据（当前为None）
- [ ] **问题7**：确认两列"结果"的处理方式

### 优先级3：细节定义（影响准确性）

- [ ] **问题4**：确认季节定义（农历？节气？阳历？）
- [ ] **问题4**：确认时辰范围（"卯时到申时"的具体定义）
- [ ] **问题8**：确认特殊术语（禄、长生、库等）的判断规则

---

## 📝 建议的开发方案

### 方案A：先开发财富规则（推荐）

**优点：**
- ✅ 数据完整（97条规则全部有结果）
- ✅ 条件类型单一（十神）
- ✅ 可以快速验证规则匹配引擎
- ✅ 后续扩展到其他规则类型

**步骤：**
1. 确认问题1、5、8（财富规则相关）
2. 转换财富规则为JSON（包含条件解析逻辑）
3. 开发规则匹配Service
4. 开发API和前端
5. 测试验证

### 方案B：等待全部数据后一起开发

**优点：**
- ✅ 一次性完成全部功能
- ✅ 架构更统一

**缺点：**
- ❌ 等待时间较长
- ❌ 无法快速验证

---

## 🚀 下一步行动

### 立即行动（等待用户答复）

请用户确认以下关键问题后，即可开始开发：

#### ✅ 最小确认清单（可立即开始财富规则开发）

1. **十神映射**：
   - "年干主星是正财" = `details['year']['main_star'] == '正财'`？
   - "副星有正官" = 全部四柱的 `hidden_stars` 中包含？还是特定柱？

2. **身旺判断**：
   - 是否调用 `/api/v1/bazi/wangshuai` 获取 `status` 字段？
   - "身旺"、"极旺"的具体值是什么？

3. **开发策略**：
   - 先开发财富规则（方案A）？
   - 还是等待全部数据（方案B）？

---

**准备就绪！一旦确认以上问题，立即开始开发！** 🎉

---

**文档生成时间：** 2025-11-20  
**分析工具：** Python + openpyxl  
**数据来源：** docs/11.20算法公式.xlsx (748条规则)  
**状态：** ⏸️ 等待用户确认关键问题

