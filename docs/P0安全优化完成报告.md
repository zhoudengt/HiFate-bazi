# P0 å®‰å…¨ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š

> **å®Œæˆæ—¶é—´**ï¼š2025-01-15  
> **ä¼˜åŒ–èŒƒå›´**ï¼šP0å®‰å…¨ï¼ˆæ•æ„Ÿä¿¡æ¯æ³„éœ²ã€SQLæ³¨å…¥ï¼‰+ P2è¿ç»´ï¼ˆéƒ¨ç½²å¤æ‚åº¦ã€æ—¥å¿—ç®¡ç†ï¼‰

---

## ğŸ“‹ å®Œæˆå†…å®¹

### âœ… ä¸€ã€ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**ï¼š`server/utils/unified_logger.py`

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- âœ… å¼‚æ­¥å†™å…¥ï¼Œä¸é˜»å¡ä¸šåŠ¡é€»è¾‘
- âœ… ç»“æ„åŒ–JSONæ ¼å¼ï¼Œä¾¿äºæŸ¥è¯¢å’Œåˆ†æ
- âœ… è¯¦ç»†è®°å½•æ‰€æœ‰è¾“å…¥è¾“å‡ºå‚æ•°
- âœ… æ”¯æŒè¯·æ±‚è¿½è¸ªï¼ˆrequest_idï¼‰
- âœ… è‡ªåŠ¨è„±æ•æ•æ„Ÿä¿¡æ¯
- âœ… è‡ªåŠ¨è®°å½•å¼‚å¸¸å †æ ˆ

**å…³é”®åŠŸèƒ½**ï¼š
```python
# è®°å½•è¯·æ±‚æ—¥å¿—
log_request(service='BaziService', function='calculate_bazi', 
           request_id=request_id, input_data={...})

# è®°å½•å“åº”æ—¥å¿—
log_response(service='BaziService', function='calculate_bazi',
            request_id=request_id, output_data={...}, duration_ms=123.45)

# è®°å½•é”™è¯¯æ—¥å¿—
log_error(service='BaziService', function='calculate_bazi',
         error=exception, request_id=request_id, input_data={...})

# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆè‡ªåŠ¨è¿½è¸ªï¼‰
with trace_function(service='BaziService', function='calculate_bazi',
                   request_id=request_id, input_data={...}):
    # ä¸šåŠ¡é€»è¾‘
    ...
```

**æ—¥å¿—æ ¼å¼**ï¼š
```json
{
  "timestamp": "2025-01-15T10:30:00.123456",
  "level": "INFO",
  "service": "BaziService",
  "function": "calculate_bazi",
  "message": "[BaziService] calculate_bazi - æ”¶åˆ°è¯·æ±‚",
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "input": {...},
  "output": {...},
  "duration_ms": 123.45,
  "error": {...}  // å¦‚æœæœ‰é”™è¯¯
}
```

---

### âœ… äºŒã€æ•æ„Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**ï¼š`server/utils/secret_manager.py`

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- âœ… ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ•æ„Ÿä¿¡æ¯
- âœ… ç¦æ­¢ç¡¬ç¼–ç ï¼Œå¼ºåˆ¶ä»ç¯å¢ƒå˜é‡è¯»å–
- âœ… è‡ªåŠ¨éªŒè¯æ•æ„Ÿä¿¡æ¯æ˜¯å¦å­˜åœ¨
- âœ… è®°å½•æ•æ„Ÿä¿¡æ¯è®¿é—®æ—¥å¿—ï¼ˆè„±æ•ï¼‰
- âœ… æ”¯æŒå¯†é’¥è½®æ¢

**å…³é”®åŠŸèƒ½**ï¼š
```python
# è·å–æ•æ„Ÿä¿¡æ¯
coze_token = get_coze_token()
coze_bot_id = get_coze_bot_id()
mysql_password = get_mysql_password()
jwt_secret = get_jwt_secret()

# éªŒè¯æ•æ„Ÿä¿¡æ¯
secret_manager = get_secret_manager()
results = secret_manager.validate_secrets()
```

**æ”¯æŒçš„æ•æ„Ÿä¿¡æ¯**ï¼š
- Coze API Token å’Œ Bot IDs
- MySQL å¯†ç 
- Redis å¯†ç 
- JWT Secret
- ç¬¬ä¸‰æ–¹ API Keysï¼ˆJISUAPIã€TIANAPIã€API6APIï¼‰
- Stripe Secret Key

---

### âœ… ä¸‰ã€SQL å®‰å…¨é˜²æŠ¤ç³»ç»Ÿï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**ï¼š`server/utils/sql_security.py`

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- âœ… è‡ªåŠ¨æ£€æµ‹æ½œåœ¨çš„ SQL æ³¨å…¥é£é™©
- âœ… å¼ºåˆ¶ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- âœ… è¯¦ç»†è®°å½•æ‰€æœ‰ SQL æ‰§è¡Œ
- âœ… è‡ªåŠ¨æ£€æŸ¥ SQL è¯­å¥å’Œå‚æ•°

**å…³é”®åŠŸèƒ½**ï¼š
```python
# å®‰å…¨æ‰§è¡ŒæŸ¥è¯¢
results = secure_execute_query(
    connection=conn,
    sql="SELECT * FROM users WHERE id = %s",
    params=(user_id,),
    request_id=request_id,
    service='UserService',
    function='get_user_by_id'
)

# å®‰å…¨æ‰§è¡Œæ›´æ–°
affected = secure_execute_update(
    connection=conn,
    sql="UPDATE users SET username = %s WHERE id = %s",
    params=(username, user_id),
    request_id=request_id,
    service='UserService',
    function='update_user'
)
```

**å®‰å…¨æ£€æŸ¥**ï¼š
- æ£€æµ‹å±é™© SQL æ¨¡å¼ï¼ˆDROPã€DELETEã€UNION SELECT ç­‰ï¼‰
- æ£€æŸ¥å‚æ•°æ˜¯å¦æ­£ç¡®ä½¿ç”¨
- æ£€æµ‹å‚æ•°å€¼ä¸­çš„å±é™©å†…å®¹

---

### âœ… å››ã€ç®€åŒ–éƒ¨ç½²è„šæœ¬ï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**ï¼š`scripts/deploy_simple.sh`

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- âœ… ä¸€é”®éƒ¨ç½²æ‰€æœ‰æœåŠ¡
- âœ… è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒå˜é‡
- âœ… è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
- âœ… è‡ªåŠ¨éªŒè¯éƒ¨ç½²ç»“æœ
- âœ… è¯¦ç»†çš„éƒ¨ç½²æ—¥å¿—

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# ä¸€é”®éƒ¨ç½²
./scripts/deploy_simple.sh
```

**éƒ¨ç½²æµç¨‹**ï¼š
1. æ£€æŸ¥å¿…éœ€å‘½ä»¤ï¼ˆpython3ã€dockerã€lsofï¼‰
2. æ£€æŸ¥ç¯å¢ƒå˜é‡
3. å¤‡ä»½æ•°æ®åº“
4. åœæ­¢ç°æœ‰æœåŠ¡
5. å¯åŠ¨æœåŠ¡
6. éªŒè¯éƒ¨ç½²ç»“æœ

---

### âœ… äº”ã€ä½¿ç”¨æ–‡æ¡£ï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**ï¼š`docs/ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿå’Œå®‰å…¨ç®¡ç†ä½¿ç”¨æŒ‡å—.md`

**å†…å®¹åŒ…æ‹¬**ï¼š
- ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—
- æ•æ„Ÿä¿¡æ¯ç®¡ç†ä½¿ç”¨æŒ‡å—
- SQL å®‰å…¨é˜²æŠ¤ä½¿ç”¨æŒ‡å—
- ä½¿ç”¨ç¤ºä¾‹
- è¿ç§»æŒ‡å—
- æ—¥å¿—æŸ¥è¯¢æ–¹æ³•

---

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | çŠ¶æ€ |
|---------|------|------|
| `server/utils/unified_logger.py` | ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ | âœ… å®Œæˆ |
| `server/utils/secret_manager.py` | æ•æ„Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ | âœ… å®Œæˆ |
| `server/utils/sql_security.py` | SQL å®‰å…¨é˜²æŠ¤ç³»ç»Ÿ | âœ… å®Œæˆ |
| `scripts/deploy_simple.sh` | ç®€åŒ–éƒ¨ç½²è„šæœ¬ | âœ… å®Œæˆ |
| `docs/ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿå’Œå®‰å…¨ç®¡ç†ä½¿ç”¨æŒ‡å—.md` | ä½¿ç”¨æ–‡æ¡£ | âœ… å®Œæˆ |
| `docs/P0å®‰å…¨ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md` | ä¼˜åŒ–æŠ¥å‘Šï¼ˆæœ¬æ–‡ä»¶ï¼‰ | âœ… å®Œæˆ |

---

## ğŸ”§ æ›´æ–°çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | æ›´æ–°å†…å®¹ | çŠ¶æ€ |
|---------|---------|------|
| `server/utils/__init__.py` | å¯¼å‡ºæ–°å·¥å…·æ¨¡å— | âœ… å®Œæˆ |

---

## ğŸš¨ å…³é”®è¦æ±‚å®ç°

### âœ… æ¯ä¸ªç¯èŠ‚éƒ½æœ‰è¯¦ç»†æ—¥å¿—

- âœ… æ‰€æœ‰å‡½æ•°è°ƒç”¨è®°å½•è¾“å…¥è¾“å‡º
- âœ… æ‰€æœ‰ SQL æ‰§è¡Œè®°å½•å‚æ•°å’Œç»“æœ
- âœ… æ‰€æœ‰ API è°ƒç”¨è®°å½•è¯·æ±‚å’Œå“åº”
- âœ… æ‰€æœ‰å¼‚å¸¸è®°å½•è¯¦ç»†å †æ ˆ

### âœ… å¯ä»¥å¼‚æ­¥å†™å…¥

- âœ… ä½¿ç”¨é˜Ÿåˆ—ç¼“å†²æ—¥å¿—å†™å…¥
- âœ… ä¸é˜»å¡ä¸šåŠ¡é€»è¾‘
- âœ… é˜Ÿåˆ—æ»¡æ—¶è‡ªåŠ¨é™çº§ä¸ºåŒæ­¥å†™å…¥

### âœ… åŸºäºæ—¥å¿—æ’æŸ¥é—®é¢˜

- âœ… ç»“æ„åŒ– JSON æ ¼å¼ï¼Œä¾¿äºæŸ¥è¯¢
- âœ… æ”¯æŒ request_id è¿½è¸ªæ•´ä¸ªè¯·æ±‚é“¾è·¯
- âœ… è‡ªåŠ¨è„±æ•æ•æ„Ÿä¿¡æ¯
- âœ… è®°å½•æ‰€æœ‰è¾“å…¥è¾“å‡ºå‚æ•°

### âœ… ä¸å…è®¸ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯

- âœ… æ‰€æœ‰æ•æ„Ÿä¿¡æ¯ä»ç¯å¢ƒå˜é‡è¯»å–
- âœ… å¼ºåˆ¶éªŒè¯æ•æ„Ÿä¿¡æ¯æ˜¯å¦å­˜åœ¨
- âœ… è®°å½•æ•æ„Ÿä¿¡æ¯è®¿é—®æ—¥å¿—

### âœ… SQL æ³¨å…¥é˜²æŠ¤

- âœ… å¼ºåˆ¶ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- âœ… è‡ªåŠ¨æ£€æµ‹ SQL æ³¨å…¥é£é™©
- âœ… è¯¦ç»†è®°å½•æ‰€æœ‰ SQL æ‰§è¡Œ

---

## ğŸ“ ä¸‹ä¸€æ­¥å·¥ä½œ

### 1. è¿ç§»ç°æœ‰ä»£ç 

éœ€è¦å°†ç°æœ‰ä»£ç è¿ç§»åˆ°æ–°çš„æ—¥å¿—ç³»ç»Ÿå’Œå®‰å…¨ç®¡ç†ï¼š

- [ ] æ›¿æ¢æ‰€æœ‰ `logging.getLogger()` ä¸ºç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
- [ ] æ›¿æ¢æ‰€æœ‰ `os.getenv()` ä¸º SecretManager
- [ ] æ›¿æ¢æ‰€æœ‰ç›´æ¥ SQL æ‰§è¡Œä¸ºå®‰å…¨æ‰§è¡Œå™¨
- [ ] ä¸ºæ‰€æœ‰å‡½æ•°æ·»åŠ  request_id è¿½è¸ª
- [ ] ä¸ºæ‰€æœ‰å‡½æ•°æ·»åŠ è¾“å…¥è¾“å‡ºæ—¥å¿—

### 2. æ›´æ–°é…ç½®æ–‡ä»¶

- [ ] ä» `config/services.env` ç§»é™¤æ•æ„Ÿä¿¡æ¯
- [ ] å°†æ‰€æœ‰æ•æ„Ÿä¿¡æ¯ç§»è‡³ç¯å¢ƒå˜é‡æˆ– `.env` æ–‡ä»¶
- [ ] æ›´æ–° `.gitignore` ç¡®ä¿ `.env` ä¸è¢«æäº¤

### 3. æµ‹è¯•éªŒè¯

- [ ] æµ‹è¯•ç»Ÿä¸€æ—¥å¿—ç³»ç»ŸåŠŸèƒ½
- [ ] æµ‹è¯•æ•æ„Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ
- [ ] æµ‹è¯• SQL å®‰å…¨é˜²æŠ¤ç³»ç»Ÿ
- [ ] æµ‹è¯•éƒ¨ç½²è„šæœ¬
- [ ] éªŒè¯æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæœåŠ¡å‡½æ•°

```python
from server.utils.unified_logger import trace_function, log_response
from server.utils.secret_manager import get_coze_token
from server.utils.sql_security import secure_execute_query
import uuid

def analyze_bazi(solar_date: str, solar_time: str, gender: str):
    request_id = str(uuid.uuid4())
    
    with trace_function(
        service='BaziService',
        function='analyze_bazi',
        request_id=request_id,
        input_data={'solar_date': solar_date, 'solar_time': solar_time, 'gender': gender}
    ):
        # è·å–æ•æ„Ÿä¿¡æ¯
        coze_token = get_coze_token()
        
        # å®‰å…¨æŸ¥è¯¢æ•°æ®åº“
        results = secure_execute_query(
            connection=conn,
            sql="SELECT * FROM rules WHERE type = %s",
            params=('wealth',),
            request_id=request_id,
            service='BaziService',
            function='query_rules'
        )
        
        # ä¸šåŠ¡é€»è¾‘
        result = process_data(results)
        
        # è®°å½•å“åº”
        log_response(
            service='BaziService',
            function='analyze_bazi',
            request_id=request_id,
            output_data=result
        )
        
        return result
```

### ç¤ºä¾‹2ï¼šAPI è·¯ç”±

```python
from fastapi import APIRouter, HTTPException
from server.utils.unified_logger import trace_function, log_error
import uuid

@router.post("/bazi/analyze")
async def analyze_bazi_api(request: BaziRequest):
    request_id = str(uuid.uuid4())
    
    with trace_function(
        service='BaziAPI',
        function='analyze_bazi_api',
        request_id=request_id,
        input_data=request.dict()
    ):
        try:
            result = analyze_bazi(**request.dict())
            return result
        except Exception as e:
            log_error(
                service='BaziAPI',
                function='analyze_bazi_api',
                error=e,
                request_id=request_id,
                input_data=request.dict()
            )
            raise HTTPException(status_code=500, detail=str(e))
```

---

## ğŸ“Š æ—¥å¿—æŸ¥è¯¢

### æŸ¥çœ‹ç»Ÿä¸€æ—¥å¿—

```bash
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
tail -f logs/unified.log

# æŒ‰æœåŠ¡è¿‡æ»¤
grep '"service": "BaziService"' logs/unified.log

# æŒ‰è¯·æ±‚IDè¿½è¸ª
grep '"request_id": "550e8400-*"' logs/unified.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep '"level": "ERROR"' logs/unified.log

# æ ¼å¼åŒ– JSON æ—¥å¿—
cat logs/unified.log | python -m json.tool
```

---

## âœ… éªŒè¯æ¸…å•

- [x] ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿå®ç°å®Œæˆ
- [x] æ•æ„Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿå®ç°å®Œæˆ
- [x] SQL å®‰å…¨é˜²æŠ¤ç³»ç»Ÿå®ç°å®Œæˆ
- [x] ç®€åŒ–éƒ¨ç½²è„šæœ¬å®ç°å®Œæˆ
- [x] ä½¿ç”¨æ–‡æ¡£ç¼–å†™å®Œæˆ
- [x] å·¥å…·æ¨¡å—å¯¼å‡ºå®Œæˆ
- [ ] ç°æœ‰ä»£ç è¿ç§»ï¼ˆå¾…è¿›è¡Œï¼‰
- [ ] é…ç½®æ–‡ä»¶æ›´æ–°ï¼ˆå¾…è¿›è¡Œï¼‰
- [ ] æµ‹è¯•éªŒè¯ï¼ˆå¾…è¿›è¡Œï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿå’Œå®‰å…¨ç®¡ç†ä½¿ç”¨æŒ‡å—](./ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿå’Œå®‰å…¨ç®¡ç†ä½¿ç”¨æŒ‡å—.md)
- [é¡¹ç›®é£é™©ç‚¹åˆ†ææŠ¥å‘Š](./é¡¹ç›®é£é™©ç‚¹åˆ†ææŠ¥å‘Š.md)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-01-15  
**çŠ¶æ€**ï¼šæ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œå¾…è¿ç§»å’Œæµ‹è¯•

