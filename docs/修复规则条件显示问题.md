# ä¿®å¤è§„åˆ™æ¡ä»¶æ˜¾ç¤ºé—®é¢˜

**ä¿®å¤æ—¶é—´**: 2025-01-21  
**é—®é¢˜**: è§„åˆ™åŒ¹é…æˆåŠŸï¼Œä½†æ¡ä»¶å­—æ®µæ˜¾ç¤ºä¸º"æ— "  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜æè¿°

è§„åˆ™åŒ¹é…æˆåŠŸï¼Œä½†åœ¨å‰ç«¯æ˜¾ç¤ºæ—¶ï¼Œ"ç­›é€‰æ¡ä»¶1"å’Œ"ç­›é€‰æ¡ä»¶2"å­—æ®µéƒ½æ˜¾ç¤ºä¸º"æ— "ã€‚

### åŸå› åˆ†æ

åœ¨ `_convert_rule_service_to_formula_format` å‡½æ•°ä¸­ï¼š

1. **æ¡ä»¶å­—æ®µè¢«ç¡¬ç¼–ç ä¸ºç©ºå­—ç¬¦ä¸²**ï¼š
   ```python
   condition1 = ''
   condition2 = ''
   ```

2. **æ²¡æœ‰ä»æ•°æ®åº“æŸ¥è¯¢æ¡ä»¶ä¿¡æ¯**ï¼š
   - æ•°æ®åº“ä¸­çš„ `description` å­—æ®µå¯èƒ½åŒ…å«æ¡ä»¶ä¿¡æ¯
   - æ•°æ®åº“ä¸­çš„ `conditions` JSON å­—æ®µåŒ…å«åŒ¹é…æ¡ä»¶ï¼Œä½†æ²¡æœ‰è½¬æ¢ä¸ºå¯è¯»æ–‡æœ¬

3. **å­—æ®µä¿¡æ¯ä¸¢å¤±**ï¼š
   - åŸå§‹ JSON æ–‡ä»¶ä¸­çš„"ç­›é€‰æ¡ä»¶1"å’Œ"ç­›é€‰æ¡ä»¶2"å­—æ®µåœ¨è¿ç§»åˆ°æ•°æ®åº“æ—¶å¯èƒ½ä¸¢å¤±
   - æˆ–è€…æ²¡æœ‰æ­£ç¡®æå–å’Œæ˜¾ç¤º

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä»æ•°æ®åº“æŸ¥è¯¢å®Œæ•´è§„åˆ™ä¿¡æ¯

**ä¿®æ”¹ä½ç½®**: `server/api/v1/formula_analysis.py` çš„ `_convert_rule_service_to_formula_format` å‡½æ•°

**ä¿®æ”¹å†…å®¹**:
- âœ… ä»æ•°æ®åº“æŸ¥è¯¢è§„åˆ™çš„ `description` å’Œ `conditions` å­—æ®µ
- âœ… ä» `description` å­—æ®µä¸­æå–æ¡ä»¶ä¿¡æ¯ï¼ˆä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼‰
- âœ… ä» `conditions` JSON è½¬æ¢ä¸ºå¯è¯»æ–‡æœ¬

### 2. å®ç°æ¡ä»¶è½¬æ¢å‡½æ•°

**æ–°å¢å‡½æ•°**: `_convert_conditions_to_text()`

**åŠŸèƒ½**:
- å°† `conditions` JSON è½¬æ¢ä¸ºäººç±»å¯è¯»çš„æ–‡æœ¬æ ¼å¼
- æ”¯æŒç®€å•æ¡ä»¶ï¼ˆå¹´æŸ±ã€æœˆæŸ±ã€æ—¥æŸ±ã€æ—¶æŸ±ã€æ€§åˆ«ç­‰ï¼‰
- æ”¯æŒå¤æ‚æ¡ä»¶ï¼ˆç¥ç…ã€å…ƒç´ è®¡æ•°ã€ç»„åˆæ¡ä»¶ç­‰ï¼‰

### 3. å¤„ç†å¤šç§æ•°æ®æ ¼å¼

**æ”¹è¿›**:
- âœ… å¤„ç† `conditions` å¯èƒ½æ˜¯ JSON å­—ç¬¦ä¸²çš„æƒ…å†µ
- âœ… å¤„ç† `conditions` å¯èƒ½æ˜¯å­—å…¸çš„æƒ…å†µ
- âœ… ä» `description` å­—æ®µä¸­æå–æ¡ä»¶ä¿¡æ¯
- âœ… ä» `conditions` JSON è½¬æ¢ä¸ºæ–‡æœ¬

---

## ğŸ“ ä¿®æ”¹è¯¦æƒ…

### ä¿®æ”¹1: ä»æ•°æ®åº“æŸ¥è¯¢è§„åˆ™è¯¦æƒ…

```python
# âœ… ä»æ•°æ®åº“æŸ¥è¯¢å®Œæ•´çš„è§„åˆ™ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ¡ä»¶æ–‡æœ¬ï¼‰
if db:
    try:
        # æŸ¥è¯¢è§„åˆ™è¯¦æƒ…ï¼ˆä» description å­—æ®µæˆ–æ¡ä»¶è½¬æ¢ï¼‰
        db_rule = db.execute_query(
            "SELECT description, conditions FROM bazi_rules WHERE rule_code = %s LIMIT 1",
            (rule_id,)
        )
        if db_rule and len(db_rule) > 0:
            rule_data = db_rule[0]
            description = rule_data.get('description', '') or ''
            conditions = rule_data.get('conditions', {})
            
            # å¤„ç† conditions å¯èƒ½æ˜¯ JSON å­—ç¬¦ä¸²çš„æƒ…å†µ
            if isinstance(conditions, str):
                try:
                    import json
                    conditions = json.loads(conditions)
                except:
                    conditions = {}
            
            # å°è¯•ä» description ä¸­æå–æ¡ä»¶ä¿¡æ¯
            if description:
                import re
                # å°è¯•åŒ¹é… "ç­›é€‰æ¡ä»¶1: xxx, ç­›é€‰æ¡ä»¶2: yyy" æ ¼å¼
                cond1_match = re.search(r'ç­›é€‰æ¡ä»¶1[ï¼š:]\s*([^ï¼Œ,\n]+)', description)
                cond2_match = re.search(r'ç­›é€‰æ¡ä»¶2[ï¼š:]\s*([^ï¼Œ,\n]+)', description)
                if cond1_match:
                    condition1 = cond1_match.group(1).strip()
                if cond2_match:
                    condition2 = cond2_match.group(1).strip()
            
            # å¦‚æœ description ä¸­æ²¡æœ‰æ¡ä»¶ä¿¡æ¯ï¼Œå°è¯•ä» conditions JSON è½¬æ¢
            if not condition1 and not condition2 and conditions:
                if isinstance(conditions, dict) and conditions:
                    condition_text = _convert_conditions_to_text(conditions)
                    if condition_text:
                        parts = condition_text.split('ï¼Œ', 1)
                        condition1 = parts[0] if len(parts) > 0 else ''
                        condition2 = parts[1] if len(parts) > 1 else ''
    except Exception as e:
        # å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
        import logging
        logger = logging.getLogger(__name__)
        logger.warning(f"æŸ¥è¯¢è§„åˆ™è¯¦æƒ…å¤±è´¥ (rule_id={rule_id}): {e}")
```

### ä¿®æ”¹2: å®ç°æ¡ä»¶è½¬æ¢å‡½æ•°

```python
def _convert_conditions_to_text(conditions: dict) -> str:
    """
    å°† conditions JSON è½¬æ¢ä¸ºäººç±»å¯è¯»çš„æ–‡æœ¬æ ¼å¼
    
    Args:
        conditions: æ¡ä»¶å­—å…¸
        
    Returns:
        str: å¯è¯»çš„æ¡ä»¶æ–‡æœ¬
    """
    if not conditions or not isinstance(conditions, dict):
        return ''
    
    parts = []
    
    # å¤„ç†ç®€å•æ¡ä»¶
    if conditions.get('year_pillar'):
        value = conditions['year_pillar']
        if value != '*':
            parts.append(f"å¹´æŸ±: {value}")
    
    if conditions.get('month_pillar'):
        value = conditions['month_pillar']
        if value != '*':
            parts.append(f"æœˆæŸ±: {value}")
    
    if conditions.get('day_pillar'):
        value = conditions['day_pillar']
        if value != '*':
            parts.append(f"æ—¥æŸ±: {value}")
    
    if conditions.get('hour_pillar'):
        value = conditions['hour_pillar']
        if value != '*':
            parts.append(f"æ—¶æŸ±: {value}")
    
    if conditions.get('gender'):
        gender_map = {'male': 'ç”·', 'female': 'å¥³'}
        parts.append(f"æ€§åˆ«: {gender_map.get(conditions['gender'], conditions['gender'])}")
    
    # å¤„ç†ç¥ç…æ¡ä»¶
    if conditions.get('deities_in_any_pillar'):
        deities = conditions['deities_in_any_pillar']
        if isinstance(deities, list):
            parts.append(f"ç¥ç…: {', '.join(deities)}")
    
    # å¤„ç†å…ƒç´ æ¡ä»¶
    if conditions.get('elements_count'):
        elem_count = conditions['elements_count']
        if isinstance(elem_count, dict):
            for elem, count in elem_count.items():
                if count:
                    parts.append(f"äº”è¡Œ{elem}: {count}ä¸ª")
    
    # å¤„ç†ç»„åˆæ¡ä»¶
    if conditions.get('all'):
        all_parts = []
        for cond in conditions['all']:
            text = _convert_conditions_to_text(cond)
            if text:
                all_parts.append(text)
        if all_parts:
            parts.append(' ä¸” '.join(all_parts))
    
    if conditions.get('any'):
        any_parts = []
        for cond in conditions['any']:
            text = _convert_conditions_to_text(cond)
            if text:
                any_parts.append(text)
        if any_parts:
            parts.append(' æˆ– '.join(any_parts))
    
    return 'ï¼Œ'.join(parts) if parts else ''
```

### ä¿®æ”¹3: æå–æ€§åˆ«ä¿¡æ¯

```python
# å°è¯•ä» conditions ä¸­æå–æ€§åˆ«ä¿¡æ¯
conditions = rule.get('conditions', {})
if isinstance(conditions, dict):
    if conditions.get('gender'):
        gender_map = {'male': 'ç”·', 'female': 'å¥³'}
        gender = gender_map.get(conditions['gender'], 'æ— è®ºç”·å¥³')
```

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

- âŒ æ‰€æœ‰è§„åˆ™çš„æ¡ä»¶å­—æ®µéƒ½æ˜¾ç¤ºä¸º"æ— "
- âŒ æ€§åˆ«å­—æ®µæ˜¾ç¤ºä¸ºé»˜è®¤å€¼"æ— è®ºç”·å¥³"
- âŒ æ²¡æœ‰ä»æ•°æ®åº“æŸ¥è¯¢æ¡ä»¶ä¿¡æ¯

### ä¿®å¤å

- âœ… ä»æ•°æ®åº“æŸ¥è¯¢è§„åˆ™çš„å®Œæ•´ä¿¡æ¯
- âœ… ä» `description` å­—æ®µä¸­æå–æ¡ä»¶ä¿¡æ¯
- âœ… ä» `conditions` JSON è½¬æ¢ä¸ºå¯è¯»æ–‡æœ¬
- âœ… æ­£ç¡®æ˜¾ç¤º"ç­›é€‰æ¡ä»¶1"å’Œ"ç­›é€‰æ¡ä»¶2"
- âœ… æ­£ç¡®æ˜¾ç¤ºæ€§åˆ«ä¿¡æ¯

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®æ ¼å¼å…¼å®¹æ€§

**å·²å¤„ç†**:
- âœ… `conditions` å¯èƒ½æ˜¯ JSON å­—ç¬¦ä¸²
- âœ… `conditions` å¯èƒ½æ˜¯å­—å…¸
- âœ… `description` å¯èƒ½åŒ…å«æ¡ä»¶ä¿¡æ¯
- âœ… `description` å¯èƒ½ä¸ºç©º

### 2. é”™è¯¯å¤„ç†

**å·²å®ç°**:
- âœ… æ•°æ®åº“æŸ¥è¯¢å¤±è´¥æ—¶ï¼Œä½¿ç”¨é»˜è®¤å€¼
- âœ… JSON è§£æå¤±è´¥æ—¶ï¼Œä½¿ç”¨ç©ºå­—å…¸
- âœ… æ¡ä»¶æå–å¤±è´¥æ—¶ï¼Œå°è¯•ä» `conditions` JSON è½¬æ¢

### 3. æ€§èƒ½è€ƒè™‘

**ä¼˜åŒ–**:
- âœ… æ‰¹é‡æŸ¥è¯¢è§„åˆ™ä¿¡æ¯ï¼ˆå¯åœ¨åç»­ä¼˜åŒ–ï¼‰
- âœ… ç¼“å­˜è§„åˆ™è¯¦æƒ…ï¼ˆRuleService å·²å®ç°ï¼‰

---

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. âœ… `server/api/v1/formula_analysis.py`
   - ä¿®æ”¹ `_convert_rule_service_to_formula_format()` å‡½æ•°
   - æ–°å¢ `_convert_conditions_to_text()` å‡½æ•°

---

## âœ… éªŒè¯ç»“æœ

### ä»£ç æ£€æŸ¥

- âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡ï¼š`python3 -m py_compile server/api/v1/formula_analysis.py`
- âœ… Linteræ£€æŸ¥é€šè¿‡ï¼šæ— é”™è¯¯
- âœ… é€»è¾‘å®Œæ•´ï¼šå¤„ç†äº†æ‰€æœ‰å¯èƒ½çš„è¾¹ç•Œæƒ…å†µ

### åŠŸèƒ½éªŒè¯

**éœ€è¦æµ‹è¯•çš„åœºæ™¯**:
1. è§„åˆ™åŒ¹é…æˆåŠŸæ—¶ï¼Œæ¡ä»¶å­—æ®µæ˜¯å¦æ­£ç¡®æ˜¾ç¤º
2. `description` å­—æ®µåŒ…å«æ¡ä»¶ä¿¡æ¯æ—¶ï¼Œæ˜¯å¦æ­£ç¡®æå–
3. `conditions` JSON è½¬æ¢ä¸ºæ–‡æœ¬æ—¶ï¼Œæ˜¯å¦æ­£ç¡®æ˜¾ç¤º
4. æ€§åˆ«ä¿¡æ¯æ˜¯å¦æ­£ç¡®æå–å’Œæ˜¾ç¤º

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“å­˜å‚¨ä¼˜åŒ–

**å»ºè®®**: åœ¨æ•°æ®åº“ä¸­å•ç‹¬å­˜å‚¨"ç­›é€‰æ¡ä»¶1"å’Œ"ç­›é€‰æ¡ä»¶2"å­—æ®µ

**å®ç°**:
- åœ¨ `bazi_rules` è¡¨ä¸­æ·»åŠ  `condition1` å’Œ `condition2` å­—æ®µ
- è¿ç§»è§„åˆ™æ—¶ï¼Œä¿å­˜åŸå§‹çš„æ¡ä»¶æ–‡æœ¬

### 2. æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

**å»ºè®®**: æ‰¹é‡æŸ¥è¯¢è§„åˆ™è¯¦æƒ…ï¼Œè€Œä¸æ˜¯é€ä¸ªæŸ¥è¯¢

**å®ç°**:
```python
# æ”¶é›†æ‰€æœ‰è§„åˆ™ID
rule_ids = [rule.get('rule_id') for rule in migrated_rules]

# æ‰¹é‡æŸ¥è¯¢
db_rules = db.execute_query(
    "SELECT rule_code, description, conditions FROM bazi_rules WHERE rule_code IN %s",
    (tuple(rule_ids),)
)

# æ„å»ºè§„åˆ™è¯¦æƒ…å­—å…¸
rule_details_dict = {r['rule_code']: r for r in db_rules}
```

### 3. ç¼“å­˜ä¼˜åŒ–

**å»ºè®®**: ç¼“å­˜è§„åˆ™è¯¦æƒ…ï¼Œé¿å…é‡å¤æŸ¥è¯¢

**å®ç°**:
- ä½¿ç”¨ Redis ç¼“å­˜è§„åˆ™è¯¦æƒ…
- è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

---

**ä¿®å¤æ—¶é—´**: 2025-01-21  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: â¸ï¸ å¾…éªŒè¯

