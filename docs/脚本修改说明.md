# 部署脚本修改说明

## 📝 修改位置

**文件**：`scripts/deploy_remote.sh`  
**修改位置**：第 97-146 行（步骤 3：检查代码）

---

## 🔄 修改内容

### 原来的逻辑（有问题）：

```bash
# 步骤 3：克隆或更新代码
echo -e "${BLUE}[3/8] 更新代码...${NC}"
if [ -d ".git" ]; then
    # 有 .git 就更新
    ...
else
    # 没有 .git 就要求清空目录
    if [ "$(ls -A . 2>/dev/null | grep -v '^\.git$')" ]; then
        echo -e "${YELLOW}是否清空目录并重新克隆？(y/N): ${NC}"
        read -p "" CLEAR_DIR
        if [ "$CLEAR_DIR" == "y" ] || [ "$CLEAR_DIR" == "Y" ]; then
            # 清空目录
            ...
        else
            echo -e "${RED}❌ 目录不为空，无法克隆代码${NC}"
            exit 1
        fi
    fi
    # 尝试克隆
    git clone ...
fi
```

**问题**：
- 只检查 `.git` 目录
- ZIP 下载的代码没有 `.git`，会被要求清空目录
- 不检查代码是否已存在

---

### 修改后的逻辑（正确）：

```bash
# 步骤 3：检查代码
echo -e "${BLUE}[3/8] 检查代码...${NC}"

# 优先检查代码是否已存在（通过检查关键文件）
if [ -f "scripts/deploy_remote.sh" ] || [ -f "docker-compose.yml" ] || [ -f "server/main.py" ]; then
    echo -e "${GREEN}✅ 检测到代码已存在${NC}"
    
    # 如果有 .git，尝试更新（可选）
    if [ -d ".git" ]; then
        echo -e "${GREEN}✅ 检测到 Git 仓库，可以更新代码${NC}"
        echo -e "${YELLOW}是否更新代码？(Y/n): ${NC}"
        read -t 5 -p "" UPDATE_CODE || UPDATE_CODE="n"
        
        if [ "$UPDATE_CODE" != "n" ] && [ "$UPDATE_CODE" != "N" ]; then
            # 更新代码
            ...
        else
            echo -e "${GREEN}✅ 跳过代码更新，使用当前代码${NC}"
        fi
    else
        echo -e "${GREEN}✅ 代码已存在（ZIP 下载方式），直接使用当前代码${NC}"
        echo -e "${YELLOW}提示：如需更新代码，请重新下载 ZIP 包${NC}"
    fi
else
    # 代码不存在，需要克隆或下载
    echo -e "${YELLOW}⚠️  代码不存在，需要下载代码${NC}"
    
    if [ -d ".git" ]; then
        # 尝试拉取
        ...
    else
        echo -e "${RED}❌ 代码不存在，请先下载代码${NC}"
        echo -e "${YELLOW}下载方式：${NC}"
        echo -e "  1. 使用 ZIP 包：wget ..."
        echo -e "  2. 使用 Git：git clone ..."
        exit 1
    fi
fi
```

**改进**：
- ✅ 优先检查代码是否已存在（检查关键文件）
- ✅ 支持 ZIP 下载方式（不需要 .git）
- ✅ 不再要求清空目录
- ✅ 如果代码不存在，给出明确的下载提示

---

## 🔧 手动修改步骤

### 在服务器上修改脚本：

```bash
# 1. 进入项目目录
cd /opt/HiFate-bazi

# 2. 编辑脚本
vim scripts/deploy_remote.sh

# 3. 找到第 97 行（步骤 3 开始）
# 4. 删除原来的代码（第 97-146 行）
# 5. 替换为新的代码（见下面的完整代码）
```

---

## 📋 完整替换代码

### 需要替换的部分（第 97-146 行）：

```bash
# 步骤 3：检查代码
echo -e "${BLUE}[3/8] 检查代码...${NC}"

# 优先检查代码是否已存在（通过检查关键文件）
if [ -f "scripts/deploy_remote.sh" ] || [ -f "docker-compose.yml" ] || [ -f "server/main.py" ]; then
    echo -e "${GREEN}✅ 检测到代码已存在${NC}"
    
    # 如果有 .git，尝试更新（可选）
    if [ -d ".git" ]; then
        echo -e "${GREEN}✅ 检测到 Git 仓库，可以更新代码${NC}"
        echo -e "${YELLOW}是否更新代码？(Y/n): ${NC}"
        read -t 5 -p "" UPDATE_CODE || UPDATE_CODE="n"
        
        if [ "$UPDATE_CODE" != "n" ] && [ "$UPDATE_CODE" != "N" ]; then
            echo -e "${YELLOW}拉取最新代码...${NC}"
            timeout 30 git fetch origin 2>/dev/null || {
                echo -e "${YELLOW}⚠️  网络连接超时，跳过代码更新${NC}"
            }
            git checkout master 2>/dev/null || true
            timeout 60 git pull origin master 2>/dev/null || {
                echo -e "${YELLOW}⚠️  代码拉取失败，使用当前代码继续部署${NC}"
            }
            echo -e "${GREEN}✅ 代码检查完成${NC}"
        else
            echo -e "${GREEN}✅ 跳过代码更新，使用当前代码${NC}"
        fi
    else
        echo -e "${GREEN}✅ 代码已存在（ZIP 下载方式），直接使用当前代码${NC}"
        echo -e "${YELLOW}提示：如需更新代码，请重新下载 ZIP 包${NC}"
    fi
else
    # 代码不存在，需要克隆或下载
    echo -e "${YELLOW}⚠️  代码不存在，需要下载代码${NC}"
    
    # 检查是否有 .git（可能是空目录）
    if [ -d ".git" ]; then
        echo -e "${YELLOW}检测到 .git 目录，尝试拉取代码...${NC}"
        git pull origin master 2>/dev/null || {
            echo -e "${RED}❌ Git 拉取失败，请手动下载代码${NC}"
            echo -e "${YELLOW}建议：使用 ZIP 包下载方式${NC}"
            exit 1
        }
    else
        echo -e "${RED}❌ 代码不存在，请先下载代码${NC}"
        echo -e "${YELLOW}下载方式：${NC}"
        echo -e "  1. 使用 ZIP 包：wget https://github.com.cnpmjs.org/zhoudengt/HiFate-bazi/archive/refs/heads/master.zip"
        echo -e "  2. 使用 Git：git clone https://github.com.cnpmjs.org/zhoudengt/HiFate-bazi.git ."
        exit 1
    fi
fi
```

---

## 🎯 关键修改点

### 1. 检查逻辑改变

**原来**：
```bash
if [ -d ".git" ]; then
    # 有 .git
else
    # 没有 .git，要求清空目录
fi
```

**现在**：
```bash
if [ -f "scripts/deploy_remote.sh" ] || [ -f "docker-compose.yml" ] || [ -f "server/main.py" ]; then
    # 代码已存在（不管有没有 .git）
else
    # 代码不存在
fi
```

### 2. 移除清空目录逻辑

**删除的部分**：
```bash
# 检查目录是否为空
if [ "$(ls -A . 2>/dev/null | grep -v '^\.git$')" ]; then
    echo -e "${YELLOW}是否清空目录并重新克隆？(y/N): ${NC}"
    read -p "" CLEAR_DIR
    if [ "$CLEAR_DIR" == "y" ] || [ "$CLEAR_DIR" == "Y" ]; then
        # 清空目录
        ...
    else
        exit 1
    fi
fi
```

### 3. 支持 ZIP 下载

**新增的部分**：
```bash
else
    echo -e "${GREEN}✅ 代码已存在（ZIP 下载方式），直接使用当前代码${NC}"
    echo -e "${YELLOW}提示：如需更新代码，请重新下载 ZIP 包${NC}"
fi
```

---

## ✅ 修改后的效果

1. ✅ **支持 ZIP 下载**：检测到代码存在就直接使用，不要求 .git
2. ✅ **不再要求清空目录**：代码已存在就继续部署
3. ✅ **更智能的检测**：通过关键文件判断代码是否存在
4. ✅ **更好的提示**：如果代码不存在，给出明确的下载方式

---

## 📝 快速修改（复制粘贴）

在服务器上执行：

```bash
cd /opt/HiFate-bazi

# 备份原脚本
cp scripts/deploy_remote.sh scripts/deploy_remote.sh.bak

# 使用 sed 替换（如果熟悉的话）
# 或者直接用 vim 编辑，找到第 97 行开始替换
```

---

**修改完成后，直接执行 `./scripts/deploy_remote.sh` 即可！**

