# 11.20算法公式规则转换 - 问题清单

## 📊 规则统计概览

| 工作表 | 规则数量 | 筛选条件1类型 | 备注 |
|-------|---------|-------------|------|
| 财富 | 97条 | 十神 | ✅ 有结果数据 |
| 性格 | 60条 | 日柱 | ⚠️ 结果列全部为None |
| 总评 | 533条 | 年柱 | ⚠️ 结果列全部为None |
| 身体 | 58条 | 地支/天干地支/日干/日支/五行 | ⚠️ 结果列全部为None |

**总计：748 条规则**

---

## ❓ 关键问题清单

### Q1. 十神相关（财富规则）

**问题ID：** `Q1`

**问题：** Excel中'筛选条件1'为'十神'时，是指主星、副星还是两者统计？

**原因：** 规则条件中出现了"年干主星"、"副星"等表述，需要明确数据来源

**举例：**
- `年干主星是正财` → 是否对应 `details['year']['main_star'] == '正财'`？
- `副星有正官` → 是否对应 `details['year']['hidden_stars']` 中包含 '正官'？
- `日支副星是正财` → 是否对应 `details['day']['hidden_stars']` 中包含 '正财'？

**需要确认：**
- 主星：天干十神，存储在 `details[pillar]['main_star']`
- 副星：地支藏干的十神，存储在 `details[pillar]['hidden_stars']` (数组)
- 是否正确？

**条件模式分布（财富规则）：**
- 副星：44条
- 主星（未指定柱）：25条
- 年干主星：12条
- 月干主星：8条
- 时干主星：5条
- 其他：3条

---

### Q2. 地支关系（身体规则）

**问题ID：** `Q2`

**问题：** Excel中'地支'相关条件，如'子午冲'，如何匹配？

**原因：** 需要确认是使用 `relationships['branch_relations']` 还是手动检查地支

**举例：**
```json
// 八字数据中的地支关系
"relationships": {
  "branch_relations": {
    "chong": [{"pillars": ["year", "hour"], "branches": ["子", "午"]}],
    "xing": [],
    "hai": [],
    "liuhe": []
  }
}
```

**身体规则中的地支条件：**
- `子午冲`
- `丑未冲`
- `寅申冲`
- `卯酉冲`
- `辰戍冲`
- `巳亥冲`

**需要确认：**
- 是否直接使用 `relationships['branch_relations']['chong']` 来判断？
- 还是需要检查四柱地支是否包含这两个地支（如年支=子，月支=午）？

---

### Q3. 五行统计（身体规则）

**问题ID：** `Q3`

**问题：** Excel中'天干地支'条件，如'对应五行属性火低于1个（包含1个）'，如何计算？

**原因：** 需要确认是否使用 `element_counts` 字段

**举例：**
```json
// 八字数据中的五行统计
"element_counts": {
  "木": 2,
  "火": 1,
  "土": 3,
  "金": 0,
  "水": 2
}
```

**需要确认：**
- `element_counts` 是否已包含天干+地支的五行统计？
- "低于1个（包含1个）"是指 `<=1` 吗？
- 举例：如果 `element_counts['火'] == 1`，是否满足"火低于1个（包含1个）"？

---

### Q4. 年柱/日柱条件（总评/性格规则）

**问题ID：** `Q4`

**问题：** Excel中'年柱'条件，如'甲子，且出生于春季，并且出生于卯时到申时'，如何解析？

**原因：** 涉及复合条件解析，需要定义季节和时辰范围

**举例：**
```
条件：甲子，且出生于春季，并且出生于卯时到申时
```

**需要确认：**

1. **年柱/日柱匹配**：
   - `甲子` → `bazi_pillars['year']['stem']=='甲' and bazi_pillars['year']['branch']=='子'`？

2. **季节定义**：
   - 春季 = 农历1-3月？还是阳历2-4月？还是立春-立夏？
   - 夏季 = ?
   - 秋季 = ?
   - 冬季 = ?

3. **时辰范围**：
   - "卯时到申时" = ['卯', '辰', '巳', '午', '未', '申']？
   - "酉时到寅时" = ['酉', '戌', '亥', '子', '丑', '寅']？
   - 是否跨日（如酉时到寅时）？

---

### Q5. 复合条件解析

**问题ID：** `Q5`

**问题：** 如何解析复杂的复合条件？

**举例（财富规则）：**
```
年干主星是正财，且副星有正官，并且还是身旺或极旺
```

**解析步骤：**
1. `年干主星是正财` → `details['year']['main_star'] == '正财'`
2. `副星有正官` → 哪一柱的副星？全部副星中有正官？
3. `身旺或极旺` → 需要调用旺衰分析API吗？

**需要确认：**
- "副星有正官"是指：
  - 年柱的副星？
  - 还是四柱中任意一柱的副星？
- "身旺或极旺"的判断标准：
  - 是否需要调用 `/api/v1/bazi/wangshuai` API？
  - 还是有简单的判断规则？

---

### Q6. 结果列缺失数据

**问题ID：** `Q6`

**问题：** 除财富规则外，其他三个工作表的结果列全部为 `None`，是否需要补充？

**统计：**
- ✅ 财富规则：97条，全部有结果
- ❌ 性格规则：60条，0条有结果
- ❌ 总评规则：533条，0条有结果
- ❌ 身体规则：58条，0条有结果

**需要确认：**
- 是否需要用户提供缺失的结果数据？
- 还是先开发财富规则，其他规则后续补充？

---

### Q7. Excel表格中的两列'结果'

**问题ID：** `Q7`

**问题：** Excel中有些工作表有两列'结果'，应该如何处理？

**举例：**
- 财富表：只有1列'结果'
- 性格、总评、身体表：有2列'结果'

**需要确认：**
- 两列'结果'是否需要合并显示？
- 还是选择其中一列？
- 如果都是None，如何处理？

---

### Q8. 特殊术语定义

**问题ID：** `Q8`

**问题：** Excel中出现的特殊术语需要明确定义

**术语清单：**

| 术语 | 出现位置 | 需要确认 |
|-----|---------|---------|
| 身旺 | 财富规则 | 旺衰分析结果？ |
| 极旺 | 财富规则 | 旺衰分析结果？ |
| "禄"临官 | 财富规则 | 如何判断？ |
| 不受刑冲 | 财富规则 | 检查relationships？ |
| 长生 | 财富规则 | 十二长生？ |
| 库 | 财富规则 | 四库（辰戌丑未）？ |
| 春季/夏季/秋季/冬季 | 总评规则 | 季节定义？ |
| 农历六月 | 总评规则 | 如何获取农历月份？ |

---

## 🔍 底层数据结构分析

### 可用的八字数据字段

```python
{
  "basic_info": {
    "solar_date": "2020-01-07",
    "solar_time": "19:21",
    "gender": "male"
  },
  "bazi_pillars": {
    "year": {"stem": "己", "branch": "亥"},
    "month": {"stem": "丁", "branch": "丑"},
    "day": {"stem": "己", "branch": "未"},
    "hour": {"stem": "甲", "branch": "戌"}
  },
  "details": {
    "year": {
      "main_star": "比肩",
      "hidden_stars": ["正财", "正印"]
    },
    "month": {
      "main_star": "伤官",
      "hidden_stars": ["偏印", "七杀", "偏财"]
    },
    "day": {
      "main_star": "元男",
      "hidden_stars": ["比肩", "偏印"]
    },
    "hour": {
      "main_star": "正官",
      "hidden_stars": ["偏财", "正官", "偏印"]
    }
  },
  "ten_gods_stats": {
    "main": {"比肩": 1, "伤官": 1, "元男": 1, "正官": 1},
    "sub": {"正财": 1, "正印": 1, "偏印": 4, "七杀": 1, "偏财": 2, "比肩": 1, "正官": 1},
    "totals": {"比肩": 2, "伤官": 1, "元男": 1, "正官": 2, "正财": 1, "正印": 1, "偏印": 4, "七杀": 1, "偏财": 2}
  },
  "element_counts": {
    "木": 2, "火": 1, "土": 3, "金": 0, "水": 2
  },
  "relationships": {
    "branch_relations": {
      "chong": [],
      "xing": [{"type": "三刑", "pillars": ["month", "day", "hour"], "branches": ["丑", "未", "戌"]}],
      "hai": [],
      "liuhe": []
    }
  }
}
```

### 可用的API

1. **八字计算**：`POST /api/v1/bazi/calculate`
2. **旺衰分析**：`POST /api/v1/bazi/wangshuai`
3. **大运流年**：通过gRPC服务 `bazi-fortune-service`

---

## 🎯 建议的开发策略

### 阶段1：先开发财富规则（数据完整）

- ✅ 97条规则，全部有结果数据
- ✅ 条件类型单一（十神）
- ✅ 可以先实现并测试

### 阶段2：补充其他规则数据

- 等待用户提供性格、总评、身体规则的结果数据
- 或者暂时跳过，只显示"规则匹配但结果待完善"

### 阶段3：前端展示

- 创建统一的规则匹配展示页面
- 按类别（财富/性格/总评/身体）分tab显示
- 显示匹配的规则ID和结果文本

---

## ✅ 下一步行动

1. **等待用户答复以上问题**
2. **确认问题答案后，开始转换JSON规则**
3. **开发规则匹配Service**
4. **开发API和前端页面**
5. **测试验证**

---

**生成时间：** 2025-11-20  
**规则来源：** docs/11.20算法公式.xlsx  
**JSON文件：** docs/11.20算法公式.json

