# 批量修改规则内容 - 详细操作流程

## 概述

本流程用于批量修改规则匹配的内容（`content` 字段），其他字段（`rule_code`、`conditions`、`rule_name` 等）保持不变。

## 前置准备

### 1. 确认工具已安装

```bash
# 检查 pandas 和 openpyxl 是否已安装
python -c "import pandas; import openpyxl; print('✓ 依赖已安装')"
```

如果未安装，执行：
```bash
pip install pandas openpyxl
```

### 2. 确认数据库连接

确保数据库配置正确，可以正常连接。

## 完整操作流程

### 步骤 1：创建 Excel 模板（可选）

如果您还没有 Excel 文件，可以先创建模板：

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi

python scripts/excel_to_rules_content_json.py --mode template \
  --template-output rules_template.xlsx
```

**输出：**
```
✓ 已创建 Excel 模板文件: rules_template.xlsx
  包含列: ['rule_code', 'content_text', 'content_type']
  示例数据: 3 行
  注意：rule_code 列可以不带 'MARR-' 前缀，程序会自动添加
```

**模板文件位置：**
- `/Users/zhoudt/Downloads/project/HiFate-bazi/rules_template.xlsx`

### 步骤 2：编辑 Excel 文件

#### 2.1 打开 Excel 文件

使用 Excel、WPS、LibreOffice 等工具打开 `rules_template.xlsx`。

#### 2.2 Excel 文件格式要求

**必需的列：**

| 列名 | 说明 | 示例 | 注意事项 |
|------|------|------|----------|
| `rule_code` | 规则编号 | `10156` 或 `MARR-10156` | 可以不带前缀，程序会自动添加 `MARR-` |
| `content_text` | 规则内容文本 | `注意关注，外来女人争丈夫。` | 不能为空 |

**可选的列：**

| 列名 | 说明 | 默认值 | 注意事项 |
|------|------|--------|----------|
| `content_type` | 内容类型 | `description` | 如果为空，使用默认值 |

#### 2.3 Excel 文件示例

```
| rule_code | content_text                    | content_type |
|-----------|--------------------------------|--------------|
| 10156     | 注意关注，外来女人争丈夫。      | description  |
| 10157     | 其他规则内容1                   | description  |
| 10158     | 其他规则内容2                   | description  |
```

**重要说明：**
- `rule_code` 可以写 `10156`（不带前缀），程序会自动转换为 `MARR-10156`
- `rule_code` 也可以写 `MARR-10156`（带前缀），程序会保持不变
- `content_text` 是您要修改的新内容
- `content_type` 如果为空，会自动使用 `description`

#### 2.4 填写数据

1. 在 `rule_code` 列填写规则编号（如 `10156`）
2. 在 `content_text` 列填写新的规则内容（如 `注意关注，外来女人争丈夫。`）
3. 在 `content_type` 列填写内容类型（可选，默认为 `description`）

#### 2.5 保存文件

保存 Excel 文件，确保格式为 `.xlsx`。

### 步骤 3：转换为 JSON 格式

将编辑好的 Excel 文件转换为 JSON 格式：

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi

python scripts/excel_to_rules_content_json.py --mode convert \
  --excel rules_template.xlsx \
  --output rules_content.json
```

**输出示例：**
```
============================================================
Excel 转规则内容 JSON 工具
============================================================

读取 Excel 文件: rules_template.xlsx
读取到 3 行数据
列名: ['rule_code', 'content_text', 'content_type']

✓ 转换完成
  成功: 3 条
  跳过: 0 条
  输出文件: rules_content.json

============================================================
✓ 转换完成，共 3 条规则
  使用以下命令导入更新：
  python scripts/batch_update_content_from_json.py --mode import --file rules_content.json
============================================================
```

**生成的文件：**
- `rules_content.json` - 转换后的 JSON 文件

**JSON 文件格式：**
```json
[
  {
    "rule_code": "MARR-10156",
    "content": {
      "text": "注意关注，外来女人争丈夫。",
      "type": "description"
    }
  },
  {
    "rule_code": "MARR-10157",
    "content": {
      "text": "其他规则内容1",
      "type": "description"
    }
  }
]
```

**注意：** 程序会自动将 `10156` 转换为 `MARR-10156`。

### 步骤 4：测试更新（模拟运行）

在正式更新数据库之前，先进行模拟运行，查看会更新哪些规则：

```bash
python scripts/batch_update_content_from_json.py --mode import \
  --file rules_content.json \
  --dry-run
```

**输出示例：**
```
============================================================
基于 JSON 文件批量修改规则内容工具
（只修改 content 字段，其他字段不可改动）
============================================================
⚠️  模拟运行模式（不会实际更新数据库）

从文件导入规则内容: rules_content.json

从文件读取到 3 条规则

  [模拟] 规则 MARR-10156:
    原内容: {"text": "外来女人争丈夫。", "type": "description"}
    新内容: {"text": "注意关注，外来女人争丈夫。", "type": "description"}
    规则名称: 婚姻规则10156 (不变)
    规则条件: "{\"all\": [{\"gender\": \"female\"}, ... (不变)

  [模拟] 规则 MARR-10157:
    原内容: {"text": "原内容1", "type": "description"}
    新内容: {"text": "其他规则内容1", "type": "description"}
    规则名称: 婚姻规则10157 (不变)
    规则条件: ... (不变)

============================================================
更新结果：
  总计: 3
  成功: 0
  失败: 0
  未找到: 0
============================================================
```

**检查要点：**
- ✅ 确认原内容和新内容对比正确
- ✅ 确认规则名称、规则条件等字段保持不变
- ✅ 确认没有错误提示

### 步骤 5：执行实际更新

确认无误后，执行实际更新（去掉 `--dry-run` 参数）：

```bash
python scripts/batch_update_content_from_json.py --mode import \
  --file rules_content.json
```

**输出示例：**
```
============================================================
基于 JSON 文件批量修改规则内容工具
（只修改 content 字段，其他字段不可改动）
============================================================

从文件导入规则内容: rules_content.json

从文件读取到 3 条规则

✓ 已更新规则 MARR-10156
✓ 已更新规则 MARR-10157
✓ 已更新规则 MARR-10158

✓ 规则版本号已更新

============================================================
更新结果：
  总计: 3
  成功: 3
  失败: 0
  未找到: 0
============================================================
```

**重要说明：**
- ✅ 只更新 `content` 字段
- ✅ `rule_code`、`conditions`、`rule_name` 等字段保持不变
- ✅ 自动更新规则版本号，触发热加载

### 步骤 6：验证更新结果

#### 6.1 通过 API 验证

```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/rules/match \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "rule_types": ["marriage_ten_gods"],
    "include_bazi": false
  }' | jq '.matched_rules[] | select(.rule_code == "MARR-10156") | .content'
```

#### 6.2 通过数据库验证

```sql
SELECT rule_code, content, updated_at 
FROM bazi_rules 
WHERE rule_code = 'MARR-10156';
```

## 完整命令示例

### 示例 1：修改规则 MARR-10156

```bash
# 1. 创建模板
python scripts/excel_to_rules_content_json.py --mode template \
  --template-output rule_10156.xlsx

# 2. 编辑 Excel 文件，填写：
#    rule_code: 10156
#    content_text: 注意关注，外来女人争丈夫。

# 3. 转换为 JSON
python scripts/excel_to_rules_content_json.py --mode convert \
  --excel rule_10156.xlsx \
  --output rule_10156.json

# 4. 测试更新
python scripts/batch_update_content_from_json.py --mode import \
  --file rule_10156.json \
  --dry-run

# 5. 执行实际更新
python scripts/batch_update_content_from_json.py --mode import \
  --file rule_10156.json
```

### 示例 2：批量修改多个规则

```bash
# 1. 创建模板
python scripts/excel_to_rules_content_json.py --mode template \
  --template-output batch_rules.xlsx

# 2. 在 Excel 中填写多行数据：
#    10156 | 注意关注，外来女人争丈夫。 | description
#    10157 | 其他规则内容1             | description
#    10158 | 其他规则内容2             | description

# 3. 转换为 JSON
python scripts/excel_to_rules_content_json.py --mode convert \
  --excel batch_rules.xlsx \
  --output batch_rules.json

# 4. 测试更新
python scripts/batch_update_content_from_json.py --mode import \
  --file batch_rules.json \
  --dry-run

# 5. 执行实际更新
python scripts/batch_update_content_from_json.py --mode import \
  --file batch_rules.json
```

## 高级用法

### 自定义列名

如果 Excel 文件使用不同的列名：

```bash
python scripts/excel_to_rules_content_json.py --mode convert \
  --excel rules.xlsx \
  --output rules_content.json \
  --rule-code-column "规则编号" \
  --content-text-column "规则内容" \
  --content-type-column "内容类型"
```

### 指定工作表

如果 Excel 文件有多个工作表：

```bash
python scripts/excel_to_rules_content_json.py --mode convert \
  --excel rules.xlsx \
  --output rules_content.json \
  --sheet "规则表"
```

### 自定义前缀

如果规则编号使用不同的前缀：

```bash
python scripts/excel_to_rules_content_json.py --mode convert \
  --excel rules.xlsx \
  --output rules_content.json \
  --rule-code-prefix "RULE-"
```

### 禁用自动添加前缀

如果 Excel 中的 `rule_code` 已经包含完整的前缀：

```bash
python scripts/excel_to_rules_content_json.py --mode convert \
  --excel rules.xlsx \
  --output rules_content.json \
  --no-auto-prefix
```

## 常见问题

### Q1: Excel 文件读取失败？

**A:** 检查：
- 文件路径是否正确
- 文件格式是否为 `.xlsx`（不是 `.xls`）
- 文件是否被其他程序占用

### Q2: 提示缺少必需的列？

**A:** 检查 Excel 文件是否包含 `rule_code` 和 `content_text` 列，列名必须完全匹配（区分大小写）。

### Q3: 规则更新后没有生效？

**A:** 检查：
- 规则版本号是否已更新（应该自动更新）
- 服务是否支持热加载
- 可能需要重启服务

### Q4: 如何只更新部分规则？

**A:** 在 Excel 文件中只填写需要更新的规则，其他规则不填写即可。

### Q5: 如何批量添加前缀到所有规则？

**A:** 使用 `batch_update_rule_content.py` 工具：

```bash
python scripts/batch_update_rule_content.py --mode prefix \
  --prefix "注意关注，" \
  --dry-run
```

## 注意事项

1. **备份数据**：批量更新前建议先导出规则作为备份
2. **测试运行**：务必先使用 `--dry-run` 测试，确认无误后再实际更新
3. **只修改 content**：工具只修改 `content` 字段，其他字段保持不变
4. **自动添加前缀**：`rule_code` 可以不带 `MARR-` 前缀，程序会自动添加
5. **版本号更新**：更新后会自动更新规则版本号，触发热加载
6. **数据验证**：更新后建议通过 API 或数据库验证结果

## 文件位置

- **Excel 模板**：`/Users/zhoudt/Downloads/project/HiFate-bazi/rules_content_template.xlsx`
- **转换工具**：`scripts/excel_to_rules_content_json.py`
- **导入工具**：`scripts/batch_update_content_from_json.py`
- **详细文档**：`docs/Excel格式说明.md`

## 快速参考

```bash
# 完整流程（一行命令）
python scripts/excel_to_rules_content_json.py --mode convert \
  --excel rules.xlsx --output rules.json && \
python scripts/batch_update_content_from_json.py --mode import \
  --file rules.json --dry-run
```

