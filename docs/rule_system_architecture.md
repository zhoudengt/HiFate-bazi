# HiFateè§„åˆ™ç³»ç»Ÿæ•´ä½“æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
- [è§„åˆ™å­˜å‚¨](#è§„åˆ™å­˜å‚¨)
- [è§„åˆ™åŒ¹é…æµç¨‹](#è§„åˆ™åŒ¹é…æµç¨‹)
- [è§„åˆ™ç±»å‹ä½“ç³»](#è§„åˆ™ç±»å‹ä½“ç³»)
- [æ¡ä»¶åŒ¹é…èƒ½åŠ›](#æ¡ä»¶åŒ¹é…èƒ½åŠ›)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [çƒ­åŠ è½½æœºåˆ¶](#çƒ­åŠ è½½æœºåˆ¶)
- [è§„åˆ™å¯¼å…¥å¯¼å‡º](#è§„åˆ™å¯¼å…¥å¯¼å‡º)
- [API æ¥å£](#api-æ¥å£)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)
- [æ‰©å±•æ€§](#æ‰©å±•æ€§)

---

## ç³»ç»Ÿæ¦‚è¿°

HiFateè§„åˆ™ç³»ç»Ÿæ˜¯ä¸€ä¸ª**åŸºäºæ•°æ®åº“çš„ã€é«˜æ€§èƒ½çš„ã€æ”¯æŒçƒ­åŠ è½½çš„è§„åˆ™å¼•æ“**ï¼Œç”¨äºæ ¹æ®ç”¨æˆ·çš„ç”Ÿè¾°å…«å­—ä¿¡æ¯åŒ¹é…ç›¸åº”çš„å‘½ç†è§„åˆ™ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **æ•°æ®åº“å­˜å‚¨**ï¼šè§„åˆ™å­˜å‚¨åœ¨ MySQL æ•°æ®åº“ä¸­ï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°
- âœ… **é«˜æ€§èƒ½åŒ¹é…**ï¼šä½¿ç”¨ç´¢å¼•ä¼˜åŒ–å’Œå¹¶è¡ŒåŒ¹é…ï¼Œæ”¯æŒ 462+ æ¡è§„åˆ™
- âœ… **çƒ­åŠ è½½æœºåˆ¶**ï¼šæ”¯æŒè§„åˆ™å’Œå†…å®¹çš„çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡
- âœ… **å¤æ‚æ¡ä»¶æ”¯æŒ**ï¼šæ”¯æŒ 50+ ç§æ¡ä»¶ç±»å‹ï¼ŒåŒ…æ‹¬å››æŸ±ã€ç¥ç…ã€åç¥ã€å¤§è¿æµå¹´ç­‰
- âœ… **åŠ¨æ€æŸ¥è¯¢**ï¼šæ”¯æŒåŠ¨æ€å†…å®¹æŸ¥è¯¢ï¼ˆå¦‚æ—¥æŸ±æ€§åˆ«åˆ†æï¼‰
- âœ… **å¤šçº§ç¼“å­˜**ï¼šL1 å†…å­˜ç¼“å­˜ + L2 Redis ç¼“å­˜
- âœ… **è§„åˆ™åˆ†ç±»**ï¼šæ”¯æŒå¤šç§è§„åˆ™ç±»å‹ï¼ˆå©šå§»ã€æ¡ƒèŠ±ã€æ—¥æŸ±ç­‰ï¼‰

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¤–éƒ¨è¯·æ±‚å±‚                                â”‚
â”‚  (FastAPI RESTful API / gRPC Service)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è§„åˆ™æœåŠ¡å±‚                                 â”‚
â”‚  RuleService (å•ä¾‹æ¨¡å¼)                                      â”‚
â”‚  - è§„åˆ™åŒ¹é…å…¥å£                                              â”‚
â”‚  - ç¼“å­˜ç®¡ç†                                                  â”‚
â”‚  - çƒ­åŠ è½½ç®¡ç†                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§„åˆ™å¼•æ“     â”‚ â”‚  æ¡ä»¶åŒ¹é…å™¨  â”‚ â”‚  æŸ¥è¯¢é€‚é…å™¨  â”‚
â”‚ RuleEngine   â”‚ â”‚ RuleConditionâ”‚ â”‚ QueryAdapterâ”‚
â”‚ - ç´¢å¼•ä¼˜åŒ–    â”‚ â”‚ - 50+æ¡ä»¶ç±»å‹ â”‚ â”‚ - åŠ¨æ€æŸ¥è¯¢  â”‚
â”‚ - å¹¶è¡ŒåŒ¹é…    â”‚ â”‚ - ç»„åˆæ¡ä»¶   â”‚ â”‚ - å†…å®¹ç¼“å­˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®å­˜å‚¨å±‚                       â”‚
â”‚  MySQL (bazi_rules è¡¨)                      â”‚
â”‚  - è§„åˆ™å®šä¹‰ (conditions, content)            â”‚
â”‚  - è§„åˆ™å…ƒæ•°æ® (rule_code, rule_type, etc.)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
ç”¨æˆ·è¯·æ±‚
  â†“
API æ¥å£ (/api/v1/bazi/rules/match)
  â†“
BaziCalculator.build_rule_input()  (æ„å»ºå…«å­—æ•°æ®)
  â†“
RuleService.match_rules()  (è§„åˆ™åŒ¹é…æœåŠ¡)
  â†“
  â”œâ”€â†’ æ£€æŸ¥ç¼“å­˜ (MultiLevelCache)
  â”œâ”€â†’ EnhancedRuleEngine.match_rules()  (è§„åˆ™å¼•æ“)
  â”‚     â”œâ”€â†’ ç´¢å¼•è¿‡æ»¤ (å¿«é€Ÿå®šä½å€™é€‰è§„åˆ™)
  â”‚     â””â”€â†’ å¹¶è¡ŒåŒ¹é… (ThreadPoolExecutor)
  â”‚           â””â”€â†’ EnhancedRuleCondition.match()  (æ¡ä»¶åŒ¹é…)
  â”‚                 â”œâ”€â†’ é™æ€æ¡ä»¶åŒ¹é…
  â”‚                 â””â”€â†’ åŠ¨æ€æŸ¥è¯¢ (QueryAdapterRegistry)
  â””â”€â†’ æ ¼å¼åŒ–ç»“æœå¹¶ç¼“å­˜
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. RuleServiceï¼ˆè§„åˆ™æœåŠ¡å±‚ï¼‰

**ä½ç½®ï¼š** `server/services/rule_service.py`

**èŒè´£ï¼š**
- è§„åˆ™å¼•æ“å•ä¾‹ç®¡ç†
- ç¼“å­˜ç®¡ç†ï¼ˆL1 + L2ï¼‰
- çƒ­åŠ è½½ç®¡ç†
- è§„åˆ™åŒ¹é…å…¥å£

**å…³é”®æ–¹æ³•ï¼š**
```python
RuleService.get_engine()           # è·å–è§„åˆ™å¼•æ“å®ä¾‹
RuleService.match_rules()          # åŒ¹é…è§„åˆ™
RuleService.reload_rules()         # é‡æ–°åŠ è½½è§„åˆ™
RuleService.start_auto_reload()    # å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
```

**æ ¸å¿ƒä»£ç ï¼š**
```python
class RuleService:
    _engine: Optional[EnhancedRuleEngine] = None
    _cache = None
    _reloader: Optional[RuleReloader] = None
    
    @classmethod
    def match_rules(cls, bazi_data: Dict, rule_types: List[str] = None, 
                     use_cache: bool = True) -> List[Dict]:
        # 1. ç”Ÿæˆç¼“å­˜é”®
        cache_key = cls._generate_cache_key(bazi_data, rule_types)
        
        # 2. æ£€æŸ¥ç¼“å­˜
        if use_cache:
            cached_result = cls.get_cache().get(cache_key)
            if cached_result is not None:
                return cached_result
        
        # 3. åŒ¹é…è§„åˆ™
        engine = cls.get_engine()
        matched_rules = engine.match_rules(bazi_data, rule_types)
        
        # 4. æ ¼å¼åŒ–ç»“æœï¼ˆæ”¯æŒåŠ¨æ€æŸ¥è¯¢ï¼‰
        formatted_rules = cls._format_rules(matched_rules, bazi_data)
        
        # 5. ç¼“å­˜ç»“æœ
        if use_cache:
            cls.get_cache().set(cache_key, formatted_rules)
        
        return formatted_rules
```

### 2. EnhancedRuleEngineï¼ˆè§„åˆ™å¼•æ“ï¼‰

**ä½ç½®ï¼š** `server/engines/rule_engine.py`

**èŒè´£ï¼š**
- è§„åˆ™ç´¢å¼•æ„å»º
- è§„åˆ™åŒ¹é…æ‰§è¡Œ
- å¹¶è¡ŒåŒ¹é…ä¼˜åŒ–

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- **ç´¢å¼•ä¼˜åŒ–**ï¼šæŒ‰å¹´æŸ±ã€æœˆæŸ±ã€æ—¥æŸ±ã€æ—¶æŸ±ã€ç¥ç…ã€è§„åˆ™ç±»å‹å»ºç«‹ç´¢å¼•
- **å¹¶è¡ŒåŒ¹é…**ï¼šä½¿ç”¨ ThreadPoolExecutor å¹¶è¡ŒåŒ¹é…è§„åˆ™
- **ä¼˜å…ˆçº§æ’åº**ï¼šæŒ‰ priority å­—æ®µæ’åºåŒ¹é…ç»“æœ

**ç´¢å¼•ç»“æ„ï¼š**
```python
{
    'by_year_pillar': {},    # å¹´æŸ±ç´¢å¼•
    'by_month_pillar': {},   # æœˆæŸ±ç´¢å¼•
    'by_day_pillar': {},     # æ—¥æŸ±ç´¢å¼•
    'by_hour_pillar': {},    # æ—¶æŸ±ç´¢å¼•
    'by_deity': {},          # ç¥ç…ç´¢å¼•
    'by_rule_type': {},      # è§„åˆ™ç±»å‹ç´¢å¼•
}
```

**åŒ¹é…ç®—æ³•ï¼š**
```python
def match_rules(self, bazi_data: Dict, rule_types: List[str] = None):
    # 1. ä½¿ç”¨ç´¢å¼•å¿«é€Ÿè¿‡æ»¤å€™é€‰è§„åˆ™
    candidate_rules = self._get_candidate_rules(bazi_data, rule_types)
    
    # 2. å¹¶è¡ŒåŒ¹é…è§„åˆ™
    with ThreadPoolExecutor(max_workers=20) as executor:
        futures = [
            executor.submit(self._match_single_rule, rule, bazi_data)
            for rule in candidate_rules
        ]
        matched_rules = [
            rule for rule, future in zip(candidate_rules, futures)
            if future.result()
        ]
    
    # 3. æŒ‰ä¼˜å…ˆçº§æ’åº
    matched_rules.sort(key=lambda r: r.get('priority', 100), reverse=True)
    
    return matched_rules
```

### 3. EnhancedRuleConditionï¼ˆæ¡ä»¶åŒ¹é…å™¨ï¼‰

**ä½ç½®ï¼š** `server/engines/rule_condition.py`

**èŒè´£ï¼š**
- è§£æå’ŒåŒ¹é…è§„åˆ™æ¡ä»¶
- æ”¯æŒ 50+ ç§æ¡ä»¶ç±»å‹
- æ”¯æŒç»„åˆæ¡ä»¶ï¼ˆAND/OR/NOTï¼‰

**æ”¯æŒçš„æ¡ä»¶ç±»å‹ï¼š**

#### å››æŸ±æ¡ä»¶
- `year_pillar`, `month_pillar`, `day_pillar`, `hour_pillar`
- `pillar_equals`, `pillar_in`, `pillar_relation`

#### ç¥ç…æ¡ä»¶
- `deities_in_year`, `deities_in_month`, `deities_in_day`, `deities_in_hour`
- `deities_in_any_pillar`, `deities_count`

#### åç¥æ¡ä»¶
- `ten_gods_main`, `ten_gods_sub`, `ten_gods_total`
- `ten_gods_main_count`, `ten_god_order`

#### å¤©å¹²åœ°æ”¯æ¡ä»¶
- `stems_count`, `branches_count`
- `stems_chong`, `stems_wuhe_pairs`
- `stems_sequence`, `day_branch_simple`

#### å¤§è¿æµå¹´æ¡ä»¶
- `dayun_branch_equals`, `dayun_branch_in`
- `liunian_combines_pillar`, `liunian_ganzhi_equals`
- `suiyun_binglin_kongwang`, `month_ten_gods_with_dayun_liunian`

#### å…¶ä»–æ¡ä»¶
- `element_total`, `element_relation`
- `nayin_count_in_pillars`, `branch_liuhe_sanhe_count`
- `lunar_month_in`, `lunar_day_in`
- `gender`, `star_fortune_in_*`

**æ¡ä»¶åŒ¹é…ç¤ºä¾‹ï¼š**
```python
# ç®€å•æ¡ä»¶
{"year_pillar": "ç”²å­", "gender": "male"}

# ç»„åˆæ¡ä»¶
{
  "all": [
    {"day_pillar": "åºšè¾°"},
    {"gender": "male"},
    {
      "any": [
        {"deities_in_any_pillar": ["å¤©ä¹™è´µäºº"]},
        {"ten_gods_main": {"names": ["æ­£å®˜"], "pillars": ["year"]}}
      ]
    }
  ]
}
```

### 4. QueryAdapterRegistryï¼ˆæŸ¥è¯¢é€‚é…å™¨ï¼‰

**ä½ç½®ï¼š** `server/engines/query_adapters.py`

**èŒè´£ï¼š**
- åŠ¨æ€å†…å®¹æŸ¥è¯¢
- é€‚é…å™¨æ³¨å†Œå’Œç®¡ç†
- å†…å®¹ç¼“å­˜

**å·²æ³¨å†Œçš„é€‚é…å™¨ï¼š**
- `RizhuGenderAnalyzer`ï¼šæ—¥æŸ±æ€§åˆ«åˆ†æ

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```json
{
  "type": "dynamic",
  "query_adapter": "RizhuGenderAnalyzer",
  "query_method": "analyze_rizhu_gender",
  "default_content": {
    "type": "description",
    "text": "æš‚æ— åˆ†ææ•°æ®"
  }
}
```

---

## è§„åˆ™å­˜å‚¨

### æ•°æ®åº“è¡¨ç»“æ„

#### bazi_rulesï¼ˆè§„åˆ™ä¸»è¡¨ï¼‰

```sql
CREATE TABLE `bazi_rules` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è§„åˆ™ID',
    `rule_code` VARCHAR(50) UNIQUE NOT NULL COMMENT 'è§„åˆ™ä»£ç ï¼ˆå”¯ä¸€ï¼‰',
    `rule_name` VARCHAR(200) NOT NULL COMMENT 'è§„åˆ™åç§°',
    `rule_type` VARCHAR(50) NOT NULL COMMENT 'è§„åˆ™ç±»å‹',
    `priority` INT DEFAULT 100 COMMENT 'ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰',
    `conditions` JSON NOT NULL COMMENT 'åŒ¹é…æ¡ä»¶ï¼ˆJSONæ ¼å¼ï¼‰',
    `content` JSON NOT NULL COMMENT 'è§„åˆ™å†…å®¹ï¼ˆJSONæ ¼å¼ï¼‰',
    `enabled` BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    `description` TEXT COMMENT 'è§„åˆ™æè¿°',
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    INDEX `idx_rule_type` (`rule_type`),
    INDEX `idx_priority` (`priority`),
    INDEX `idx_enabled` (`enabled`),
    INDEX `idx_rule_code` (`rule_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å…«å­—è§„åˆ™è¡¨';
```

#### rizhu_gender_contentsï¼ˆæ—¥æŸ±æ€§åˆ«å†…å®¹è¡¨ï¼‰

```sql
CREATE TABLE `rizhu_gender_contents` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'å†…å®¹ID',
    `rizhu` VARCHAR(10) NOT NULL COMMENT 'æ—¥æŸ±ï¼ˆå¦‚ï¼šç”²å­ï¼‰',
    `gender` VARCHAR(10) NOT NULL COMMENT 'æ€§åˆ«ï¼ˆmale/femaleï¼‰',
    `descriptions` JSON NOT NULL COMMENT 'æè¿°åˆ—è¡¨ï¼ˆJSONæ•°ç»„ï¼‰',
    `enabled` BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    `version` INT DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·ï¼ˆç”¨äºçƒ­åŠ è½½ï¼‰',
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    UNIQUE KEY `uk_rizhu_gender` (`rizhu`, `gender`),
    INDEX `idx_rizhu` (`rizhu`),
    INDEX `idx_gender` (`gender`),
    INDEX `idx_enabled` (`enabled`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ—¥æŸ±æ€§åˆ«å†…å®¹è¡¨';
```

#### rule_versionï¼ˆç‰ˆæœ¬å·è¡¨ï¼‰

```sql
CREATE TABLE `rule_version` (
    `id` INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç‰ˆæœ¬ID',
    `rule_version` INT DEFAULT 1 COMMENT 'è§„åˆ™ç‰ˆæœ¬å·',
    `content_version` INT DEFAULT 1 COMMENT 'å†…å®¹ç‰ˆæœ¬å·',
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è§„åˆ™ç‰ˆæœ¬å·è¡¨';
```

### è§„åˆ™æ•°æ®æ ¼å¼

#### è§„åˆ™æ¡ä»¶ï¼ˆconditionsï¼‰

**ç®€å•æ¡ä»¶ï¼š**
```json
{
  "year_pillar": "ç”²å­",
  "gender": "male"
}
```

**ç»„åˆæ¡ä»¶ï¼š**
```json
{
  "all": [
    {"year_pillar": "ç”²å­"},
    {"gender": "male"},
    {
      "any": [
        {"deities_in_any_pillar": ["å¤©ä¹™è´µäºº"]},
        {"ten_gods_main": {"names": ["æ­£å®˜"], "pillars": ["year"]}}
      ]
    }
  ]
}
```

**å¤æ‚æ¡ä»¶ï¼š**
```json
{
  "all": [
    {"stems_count": {"stems": ["æˆŠ", "ä¸"], "eq": [3, 1]}},
    {"day_branch_simple": {"branches": ["å­", "åˆ"], "min": 1}},
    {
      "any": [
        {"dayun_branch_equals": {"branch": "å­"}},
        {"liunian_ganzhi_equals": {"ganzhi": "ç”²å­"}}
      ]
    }
  ]
}
```

#### è§„åˆ™å†…å®¹ï¼ˆcontentï¼‰

**é™æ€å†…å®¹ï¼š**
```json
{
  "type": "description",
  "items": [
    {"type": "description", "text": "è§„åˆ™æè¿°å†…å®¹1"},
    {"type": "description", "text": "è§„åˆ™æè¿°å†…å®¹2"}
  ]
}
```

**åŠ¨æ€å†…å®¹ï¼š**
```json
{
  "type": "dynamic",
  "query_adapter": "RizhuGenderAnalyzer",
  "query_method": "analyze_rizhu_gender",
  "default_content": {
    "type": "description",
    "text": "æš‚æ— åˆ†ææ•°æ®"
  }
}
```

---

## è§„åˆ™åŒ¹é…æµç¨‹

### å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·è¯·æ±‚
   â†“
2. æ„å»ºå…«å­—æ•°æ® (BaziCalculator.build_rule_input)
   - åŒ…å«ï¼šå››æŸ±ã€ç¥ç…ã€åç¥ã€å¤§è¿æµå¹´ç­‰å®Œæ•´ä¿¡æ¯
   â†“
3. ç”Ÿæˆç¼“å­˜é”®
   - åŸºäºï¼šæ—¥æœŸã€æ—¶é—´ã€æ€§åˆ«ã€å››æŸ±ã€è§„åˆ™ç±»å‹
   â†“
4. æ£€æŸ¥ç¼“å­˜
   - L1 ç¼“å­˜ï¼ˆå†…å­˜ï¼‰
   - L2 ç¼“å­˜ï¼ˆRedisï¼‰
   â†“
5. è§„åˆ™å¼•æ“åŒ¹é…
   â”œâ”€â†’ ç´¢å¼•è¿‡æ»¤ï¼ˆå¿«é€Ÿå®šä½å€™é€‰è§„åˆ™ï¼‰
   â”œâ”€â†’ å¹¶è¡ŒåŒ¹é…ï¼ˆThreadPoolExecutorï¼‰
   â”‚     â””â”€â†’ æ¡ä»¶åŒ¹é…ï¼ˆEnhancedRuleConditionï¼‰
   â”‚           â”œâ”€â†’ é™æ€æ¡ä»¶åŒ¹é…
   â”‚           â””â”€â†’ åŠ¨æ€æŸ¥è¯¢ï¼ˆQueryAdapterRegistryï¼‰
   â””â”€â†’ ä¼˜å…ˆçº§æ’åº
   â†“
6. æ ¼å¼åŒ–ç»“æœ
   - å¤„ç†åŠ¨æ€å†…å®¹
   - æ ¼å¼åŒ–è¾“å‡º
   â†“
7. ç¼“å­˜ç»“æœ
   â†“
8. è¿”å›åŒ¹é…çš„è§„åˆ™åˆ—è¡¨
```

### åŒ¹é…ç®—æ³•

1. **ç´¢å¼•è¿‡æ»¤**ï¼šæ ¹æ®å…«å­—æ•°æ®å¿«é€Ÿå®šä½å€™é€‰è§„åˆ™
   - é€šè¿‡å¹´æŸ±ã€æœˆæŸ±ã€æ—¥æŸ±ã€æ—¶æŸ±ã€ç¥ç…ç­‰ç´¢å¼•å¿«é€Ÿè¿‡æ»¤
   - é€šå¸¸å¯è¿‡æ»¤ 80%+ çš„è§„åˆ™

2. **å¹¶è¡ŒåŒ¹é…**ï¼šä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡ŒåŒ¹é…å¤šä¸ªè§„åˆ™
   - çº¿ç¨‹æ•° = min(CPUæ ¸å¿ƒæ•° Ã— 2, 20)
   - å¤šæ ¸ CPU ä¸‹å¯æå‡ 3-5 å€æ€§èƒ½

3. **æ¡ä»¶è¯„ä¼°**ï¼šé€’å½’è¯„ä¼°æ¡ä»¶æ ‘ï¼ˆall/any/notï¼‰
   - æ”¯æŒåµŒå¥—ç»„åˆæ¡ä»¶
   - æ”¯æŒ 50+ ç§æ¡ä»¶ç±»å‹

4. **ç»“æœæ’åº**ï¼šæŒ‰ priority é™åºæ’åº
   - ä¼˜å…ˆçº§é«˜çš„è§„åˆ™æ’åœ¨å‰é¢

---

## è§„åˆ™ç±»å‹ä½“ç³»

### æ”¯æŒçš„è§„åˆ™ç±»å‹ï¼ˆ21+ ç§ï¼‰

| è§„åˆ™ç±»å‹ | è¯´æ˜ | æ•°é‡ |
|---------|------|------|
| `marriage_ten_gods` | å©šå§»åç¥è§„åˆ™ | ~50 |
| `marriage_element` | å©šå§»äº”è¡Œè§„åˆ™ | ~30 |
| `marriage_day_stem` | å©šå§»æ—¥å¹²è§„åˆ™ | ~20 |
| `marriage_day_branch` | å©šå§»æ—¥æ”¯è§„åˆ™ | ~30 |
| `marriage_day_pillar` | å©šå§»æ—¥æŸ±è§„åˆ™ | ~40 |
| `marriage_stem_pattern` | å©šå§»å¤©å¹²æ¨¡å¼ | ~15 |
| `marriage_branch_pattern` | å©šå§»åœ°æ”¯æ¨¡å¼ | ~20 |
| `marriage_bazi_pattern` | å©šå§»å…«å­—æ¨¡å¼ | ~25 |
| `marriage_deity` | å©šå§»ç¥ç…è§„åˆ™ | ~30 |
| `marriage_month_branch` | å©šå§»æœˆæ”¯è§„åˆ™ | ~15 |
| `marriage_year_branch` | å©šå§»å¹´æ”¯è§„åˆ™ | ~10 |
| `marriage_year_stem` | å©šå§»å¹´å¹²è§„åˆ™ | ~10 |
| `marriage_year_pillar` | å©šå§»å¹´æŸ±è§„åˆ™ | ~15 |
| `marriage_nayin` | å©šå§»çº³éŸ³è§„åˆ™ | ~20 |
| `marriage_lunar_birthday` | å©šå§»å†œå†ç”Ÿæ—¥è§„åˆ™ | ~15 |
| `marriage_hour_pillar` | å©šå§»æ—¶æŸ±è§„åˆ™ | ~10 |
| `marriage_year_event` | å©šå§»å¹´äº‹è§„åˆ™ | ~10 |
| `marriage_luck_cycle` | å©šå§»è¿åŠ¿å‘¨æœŸ | ~15 |
| `marriage_general` | å©šå§»é€šç”¨è§„åˆ™ | ~20 |
| `taohua_general` | æ¡ƒèŠ±é€šç”¨è§„åˆ™ | ~15 |
| `rizhu_gender_dynamic` | æ—¥æŸ±æ€§åˆ«åŠ¨æ€æŸ¥è¯¢ | 1 |
| **æ€»è®¡** | | **462+** |

### è§„åˆ™ç±»å‹è¯´æ˜

- **å©šå§»ç±»è§„åˆ™**ï¼šä¸»è¦å…³æ³¨å©šå§»ç›¸å…³çš„å‘½ç†åˆ†æ
- **æ¡ƒèŠ±ç±»è§„åˆ™**ï¼šå…³æ³¨æ¡ƒèŠ±è¿ç›¸å…³çš„åˆ†æ
- **æ—¥æŸ±ç±»è§„åˆ™**ï¼šåŸºäºæ—¥æŸ±çš„æ€§åˆ«åŠ¨æ€åˆ†æ

---

## æ¡ä»¶åŒ¹é…èƒ½åŠ›

### ç»„åˆæ¡ä»¶

æ”¯æŒä¸‰ç§é€»è¾‘ç»„åˆï¼š

```json
{
  "all": [...],    // æ‰€æœ‰æ¡ä»¶éƒ½å¿…é¡»æ»¡è¶³ï¼ˆANDï¼‰
  "any": [...],    // ä»»ä¸€æ¡ä»¶æ»¡è¶³å³å¯ï¼ˆORï¼‰
  "not": {...}     // æ¡ä»¶ä¸æ»¡è¶³ï¼ˆNOTï¼‰
}
```

### æ¡ä»¶ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šç®€å•æ¡ä»¶
```json
{
  "year_pillar": "ç”²å­",
  "gender": "male"
}
```

#### ç¤ºä¾‹2ï¼šç»„åˆæ¡ä»¶
```json
{
  "all": [
    {"day_pillar": "åºšè¾°"},
    {"gender": "male"},
    {
      "any": [
        {"deities_in_any_pillar": ["å¤©ä¹™è´µäºº"]},
        {"ten_gods_main": {"names": ["æ­£å®˜"], "pillars": ["year"]}}
      ]
    }
  ]
}
```

#### ç¤ºä¾‹3ï¼šå¤æ‚æ¡ä»¶ï¼ˆå¤©å¹²ç‰¹å®šæ•°é‡ï¼‰
```json
{
  "all": [
    {"stems_count": {"stems": ["æˆŠ", "ä¸"], "eq": [3, 1]}},
    {"day_branch_simple": {"branches": ["å­", "åˆ"], "min": 1}}
  ]
}
```

#### ç¤ºä¾‹4ï¼šå¤§è¿æµå¹´æ¡ä»¶
```json
{
  "all": [
    {"dayun_branch_equals": {"branch": "å­"}},
    {
      "any": [
        {"liunian_ganzhi_equals": {"ganzhi": "ç”²å­"}},
        {"month_ten_gods_with_dayun_liunian": {
          "ten_gods": ["æ­£å®˜", "ä¸ƒæ€"],
          "check_dayun": true,
          "check_liunian": true
        }}
      ]
    }
  ]
}
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ä¼˜åŒ–

- **å¤šç»´åº¦ç´¢å¼•**ï¼šå¹´æŸ±ã€æœˆæŸ±ã€æ—¥æŸ±ã€æ—¶æŸ±ã€ç¥ç…ã€è§„åˆ™ç±»å‹
- **å¿«é€Ÿè¿‡æ»¤**ï¼šå…ˆé€šè¿‡ç´¢å¼•è¿‡æ»¤å€™é€‰è§„åˆ™ï¼Œå‡å°‘åŒ¹é…æ•°é‡
- **ç´¢å¼•å‘½ä¸­ç‡**ï¼šé€šå¸¸å¯è¿‡æ»¤ 80%+ çš„è§„åˆ™

**ç´¢å¼•æ„å»ºç¤ºä¾‹ï¼š**
```python
# å¹´æŸ±ç´¢å¼•
if 'year_pillar' in conditions:
    year_pillar = conditions['year_pillar']
    self._index['by_year_pillar'][year_pillar].append(rule)

# ç¥ç…ç´¢å¼•
if 'deities_in_any_pillar' in conditions:
    for deity in conditions['deities_in_any_pillar']:
        self._index['by_deity'][deity].append(rule)
```

### 2. å¹¶è¡ŒåŒ¹é…

- **çº¿ç¨‹æ± **ï¼šä½¿ç”¨ ThreadPoolExecutorï¼Œçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— 2
- **å¹¶è¡Œåº¦**ï¼šæœ€å¤š 20 ä¸ªçº¿ç¨‹å¹¶è¡ŒåŒ¹é…
- **æ€§èƒ½æå‡**ï¼šå¤šæ ¸ CPU ä¸‹å¯æå‡ 3-5 å€æ€§èƒ½

**å¹¶è¡ŒåŒ¹é…ä»£ç ï¼š**
```python
cpu_count = os.cpu_count() or 4
max_workers = min(cpu_count * 2, 20)

with ThreadPoolExecutor(max_workers=max_workers) as executor:
    futures = [
        executor.submit(self._match_single_rule, rule, bazi_data)
        for rule in candidate_rules
    ]
    matched_rules = [
        rule for rule, future in zip(candidate_rules, futures)
        if future.result()
    ]
```

### 3. å¤šçº§ç¼“å­˜

- **L1 ç¼“å­˜**ï¼šå†…å­˜ç¼“å­˜ï¼ˆPython dictï¼‰
- **L2 ç¼“å­˜**ï¼šRedis ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
- **ç¼“å­˜é”®**ï¼šåŸºäºå…«å­—æ•°æ® MD5 å“ˆå¸Œ
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼šé€šå¸¸ > 90%

**ç¼“å­˜é”®ç”Ÿæˆï¼š**
```python
def _generate_cache_key(bazi_data: Dict, rule_types: List[str] = None) -> str:
    key_parts = [
        bazi_data.get('basic_info', {}).get('solar_date', ''),
        bazi_data.get('basic_info', {}).get('solar_time', ''),
        bazi_data.get('basic_info', {}).get('gender', ''),
    ]
    # æ·»åŠ å››æŸ±ä¿¡æ¯
    for pillar_type in ['year', 'month', 'day', 'hour']:
        pillar = bazi_data.get('bazi_pillars', {}).get(pillar_type, {})
        key_parts.append(f"{pillar.get('stem', '')}{pillar.get('branch', '')}")
    
    # æ·»åŠ è§„åˆ™ç±»å‹
    if rule_types:
        key_parts.append(str(sorted(rule_types)))
    
    key_str = ':'.join(key_parts)
    return f"bazi:rules:{hashlib.md5(key_str.encode()).hexdigest()}"
```

### 4. å»¶è¿ŸåŠ è½½

- **å•ä¾‹æ¨¡å¼**ï¼šè§„åˆ™å¼•æ“å•ä¾‹ï¼Œé¦–æ¬¡è®¿é—®æ—¶åŠ è½½
- **æŒ‰éœ€åŠ è½½**ï¼šåªåŠ è½½å¯ç”¨çš„è§„åˆ™ï¼ˆenabled = 1ï¼‰

---

## çƒ­åŠ è½½æœºåˆ¶

### çƒ­åŠ è½½æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      HotReloadManager (å•ä¾‹)        â”‚
â”‚  - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ¨¡å—çš„çƒ­æ›´æ–°          â”‚
â”‚  - å®šæ—¶æ£€æŸ¥ç‰ˆæœ¬å·å˜åŒ–                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚          â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚è§„åˆ™   â”‚ â”‚å†…å®¹   â”‚ â”‚å…¶ä»–    â”‚
â”‚çƒ­åŠ è½½ â”‚ â”‚çƒ­åŠ è½½ â”‚ â”‚æ¨¡å—    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çƒ­åŠ è½½æµç¨‹

1. **ç‰ˆæœ¬å·æ£€æŸ¥**ï¼šæ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ `rule_version` è¡¨
2. **è§„åˆ™æ›´æ–°**ï¼šå¦‚æœ `rule_version` å˜åŒ–ï¼Œé‡æ–°åŠ è½½è§„åˆ™
3. **å†…å®¹æ›´æ–°**ï¼šå¦‚æœ `content_version` å˜åŒ–ï¼Œæ¸…ç©ºå†…å®¹ç¼“å­˜
4. **è‡ªåŠ¨åˆ·æ–°**ï¼šæ— éœ€é‡å¯æœåŠ¡ï¼Œè‡ªåŠ¨ç”Ÿæ•ˆ

### ç‰ˆæœ¬å·ç®¡ç†

**æ›´æ–°è§„åˆ™ç‰ˆæœ¬å·ï¼ˆè§¦å‘è§„åˆ™çƒ­åŠ è½½ï¼‰ï¼š**
```sql
UPDATE rule_version SET rule_version = rule_version + 1;
```

**æ›´æ–°å†…å®¹ç‰ˆæœ¬å·ï¼ˆè§¦å‘å†…å®¹ç¼“å­˜æ¸…ç†ï¼‰ï¼š**
```sql
UPDATE rule_version SET content_version = content_version + 1;
```

**çƒ­åŠ è½½ä»£ç ï¼š**
```python
class RuleReloader:
    def _reload_loop(self):
        while self.running:
            time.sleep(self.interval)  # é»˜è®¤ 300 ç§’
            try:
                # æ£€æŸ¥ç‰ˆæœ¬å·
                current_version = RuleContentDAO.get_content_version()
                current_rule_version = RuleContentDAO.get_rule_version()
                
                # è§„åˆ™æ›´æ–°
                if current_rule_version > RuleService._cached_rule_version:
                    RuleService.reload_rules()
                    RuleService._cached_rule_version = current_rule_version
                
                # å†…å®¹æ›´æ–°
                if current_version > RuleService._cached_content_version:
                    QueryAdapterRegistry._content_cache.clear()
                    RuleService._cached_content_version = current_version
            except Exception as e:
                print(f"âš  è§„åˆ™åˆ·æ–°å¤±è´¥: {e}")
```

---

## è§„åˆ™å¯¼å…¥å¯¼å‡º

### è§„åˆ™å¯¼å…¥

#### ä» Excel/JSON å¯¼å…¥

**è„šæœ¬ï¼š** `scripts/import_cc_confirm_rules.py`

**åŠŸèƒ½ï¼š**
- è§£æ Excel/JSON æ ¼å¼çš„è§„åˆ™æ•°æ®
- è‡ªåŠ¨è¯†åˆ«è§„åˆ™ç±»å‹
- è½¬æ¢æ¡ä»¶æ ¼å¼
- æ‰¹é‡å†™å…¥æ•°æ®åº“

**ä½¿ç”¨ï¼š**
```bash
python scripts/import_cc_confirm_rules.py \
  --input docs/ccç¡®è®¤.json \
  --sheet "Sheet1"
```

#### æ¡ä»¶å¤„ç†å™¨

**ä½ç½®ï¼š** `scripts/import_cc_confirm_rules.py`

**åŠŸèƒ½ï¼š**
- å°†è‡ªç„¶è¯­è¨€æ¡ä»¶è½¬æ¢ä¸ºç»“æ„åŒ–æ¡ä»¶
- æ”¯æŒ 30+ ç§æ¡ä»¶å¤„ç†å™¨
- è‡ªåŠ¨è¯†åˆ«æ¡ä»¶ç±»å‹

**ä¸»è¦å¤„ç†å™¨ï¼š**

| å¤„ç†å™¨ | åŠŸèƒ½ | ç¤ºä¾‹ |
|--------|------|------|
| `handle_day_pillar_combines` | æ—¥æŸ±ç»„åˆæ¡ä»¶ | "æ—¥æŸ±æ˜¯ç”²å­æˆ–ä¹™ä¸‘" |
| `handle_stems_sequence` | å¤©å¹²é¡ºåºæ¡ä»¶ | "å¤©å¹²å‡ºç°é¡ºåºä¸ºç”²ã€ä¹™ã€ä¸™" |
| `handle_ten_god_order` | åç¥é¡ºåºæ¡ä»¶ | "ä¸ƒæ€åœ¨å‰ï¼Œæ­£å®˜åœ¨å" |
| `handle_deities_huagai_liuhe_sanhe` | ç¥ç…æ¡ä»¶ | "å¸¦æœ‰åç›–ï¼Œå…­åˆä¸‰åˆæ•°é‡â‰¥3" |
| `handle_dayun_branch_equals` | å¤§è¿æ¡ä»¶ | "å¤§è¿åœ°æ”¯ç­‰äºæ—¥æ”¯" |
| `handle_liunian_combines_pillar` | æµå¹´æ¡ä»¶ | "æµå¹´ä¸æœˆæŸ±ç»„åˆ" |
| `handle_stems_specific_count` | å¤©å¹²ç‰¹å®šæ•°é‡ | "å¤©å¹²å‡ºç°ä¸‰ä¸ªæˆŠä¸€ä¸ªä¸" |
| `handle_stems_chong` | å¤©å¹²å››å†² | "å¤©å¹²å‡ºç°å››å†²" |
| `handle_stems_wuhe_pairs` | å¤©å¹²äº”åˆ | "å¤©å¹²å‡ºç°äº”åˆ" |
| `handle_branch_liuhe_sanhe_count` | åœ°æ”¯å…­åˆä¸‰åˆ | "å…­åˆä¸‰åˆæ•°é‡â‰¥3" |

**å¤„ç†å™¨æ˜ å°„ï¼š**
```python
EXTENDED_CONDITION_HANDLERS = {
    "æ—¥æŸ±": {
        "ç»„åˆ": handle_day_pillar_combines,
        "ç®€å•": handle_day_pillar_simple,
    },
    "å¤©å¹²": {
        "é¡ºåº": handle_stems_sequence,
        "ç‰¹å®šæ•°é‡": handle_stems_specific_count,
        "å››å†²": handle_stems_chong,
        "äº”åˆ": handle_stems_wuhe_pairs,
    },
    "åç¥": {
        "é¡ºåº": handle_ten_god_order,
    },
    "å¤§è¿": {
        "åœ°æ”¯ç­‰äºæ—¥æ”¯": handle_dayun_branch_equals,
    },
    "æµå¹´": {
        "ä¸æœˆæŸ±ç»„åˆ": handle_liunian_combines_pillar,
        "å¹²æ”¯ç­‰äº": handle_liunian_ganzhi_equals,
    },
    # ... æ›´å¤šå¤„ç†å™¨
}
```

### è§„åˆ™å¯¼å‡º

**è„šæœ¬ï¼š** `scripts/export_rules_to_json.py`ï¼ˆå¯é€‰ï¼‰

**åŠŸèƒ½ï¼š**
- ä»æ•°æ®åº“å¯¼å‡ºè§„åˆ™åˆ° JSON
- æ”¯æŒæŒ‰è§„åˆ™ç±»å‹è¿‡æ»¤
- æ”¯æŒæ ¼å¼è½¬æ¢

---

## API æ¥å£

### 1. åŒ¹é…è§„åˆ™

**æ¥å£ï¼š** `POST /api/v1/bazi/rules/match`

**è¯·æ±‚ï¼š**
```json
{
  "solar_date": "1990-05-15",
  "solar_time": "14:30",
  "gender": "male",
  "rule_types": ["marriage_ten_gods", "marriage_element"],
  "include_bazi": true
}
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "bazi_data": {
    "bazi": {...},
    "rizhu": "ç”²å­",
    "matched_rules": [...]
  },
  "matched_rules": [
    {
      "rule_id": "MARR_001",
      "rule_code": "MARR_001",
      "rule_name": "è§„åˆ™åç§°",
      "rule_type": "marriage_ten_gods",
      "priority": 100,
      "content": {
        "type": "description",
        "items": [
          {"type": "description", "text": "è§„åˆ™æè¿°å†…å®¹"}
        ]
      },
      "description": "è§„åˆ™æè¿°"
    }
  ],
  "rule_count": 1
}
```

### 2. è·å–è§„åˆ™ç±»å‹

**æ¥å£ï¼š** `GET /api/v1/bazi/rules/types`

**å“åº”ï¼š**
```json
{
  "success": true,
  "rule_types": [
    "marriage_ten_gods",
    "marriage_element",
    "marriage_day_stem",
    "marriage_day_branch",
    "marriage_day_pillar",
    "marriage_stem_pattern",
    "marriage_branch_pattern",
    "marriage_bazi_pattern",
    "marriage_deity",
    "marriage_month_branch",
    "marriage_year_branch",
    "marriage_year_stem",
    "marriage_year_pillar",
    "marriage_nayin",
    "marriage_lunar_birthday",
    "marriage_hour_pillar",
    "marriage_year_event",
    "marriage_luck_cycle",
    "marriage_general",
    "taohua_general",
    "rizhu_gender_dynamic"
  ],
  "count": 21
}
```

### 3. è·å–è§„åˆ™ç»Ÿè®¡

**æ¥å£ï¼š** `GET /api/v1/bazi/rules/stats`

**å“åº”ï¼š**
```json
{
  "success": true,
  "total_rules": 462,
  "enabled_rules": 462,
  "rule_type_count": {
    "marriage_ten_gods": 50,
    "marriage_element": 30,
    "marriage_day_stem": 20,
    ...
  },
  "cache_stats": {
    "l1_hit_rate": 0.95,
    "l2_hit_rate": 0.90,
    "total_hit_rate": 0.92
  }
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### Python ä»£ç ç¤ºä¾‹

```python
from server.services.rule_service import RuleService
from src.tool.BaziCalculator import BaziCalculator

# 1. æ„å»ºå…«å­—æ•°æ®
calculator = BaziCalculator("1990-05-15", "14:30", "male")
bazi_data = calculator.build_rule_input()

# 2. åŒ¹é…è§„åˆ™
matched_rules = RuleService.match_rules(
    bazi_data=bazi_data,
    rule_types=["marriage_ten_gods", "marriage_element"],
    use_cache=True
)

# 3. å¤„ç†ç»“æœ
for rule in matched_rules:
    print(f"{rule['rule_name']}: {rule['content']}")
```

### gRPC è°ƒç”¨ç¤ºä¾‹

```python
from src.clients.bazi_rule_client_grpc import BaziRuleClient

client = BaziRuleClient(base_url="127.0.0.1:9004")
result = client.match_rules(
    solar_date="1990-05-15",
    solar_time="14:30",
    gender="male",
    rule_types=["marriage_ten_gods"],
    use_cache=True
)

print(f"åŒ¹é…åˆ° {len(result['matched'])} æ¡è§„åˆ™")
```

### HTTP API è°ƒç”¨ç¤ºä¾‹

```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/rules/match \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "rule_types": ["marriage_ten_gods", "marriage_element"],
    "include_bazi": true
  }'
```

---

## æŠ€æœ¯æ ˆ

- **è¯­è¨€**ï¼šPython 3.8+
- **æ•°æ®åº“**ï¼šMySQL 5.7+ï¼ˆJSON å­—æ®µæ”¯æŒï¼‰
- **ç¼“å­˜**ï¼šRedisï¼ˆå¯é€‰ï¼ŒL2 ç¼“å­˜ï¼‰
- **å¹¶å‘**ï¼šThreadPoolExecutorï¼ˆå¹¶è¡ŒåŒ¹é…ï¼‰
- **åºåˆ—åŒ–**ï¼šJSONï¼ˆè§„åˆ™æ¡ä»¶/å†…å®¹ï¼‰
- **æ¡†æ¶**ï¼šFastAPIï¼ˆAPI å±‚ï¼‰ï¼ŒgRPCï¼ˆå¾®æœåŠ¡é€šä¿¡ï¼‰

---

## æ€§èƒ½æŒ‡æ ‡

- **è§„åˆ™æ•°é‡**ï¼š462+ æ¡è§„åˆ™
- **è§„åˆ™ç±»å‹**ï¼š21+ ç§
- **æ¡ä»¶ç±»å‹**ï¼š50+ ç§
- **åŒ¹é…é€Ÿåº¦**ï¼š
  - æ— ç¼“å­˜ï¼š< 100ms
  - æœ‰ç¼“å­˜ï¼š< 10ms
- **å¹¶å‘æ”¯æŒ**ï¼š1000+ å¹¶å‘è¯·æ±‚
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼š> 90%
- **ç´¢å¼•è¿‡æ»¤ç‡**ï¼š> 80%

---

## æ‰©å±•æ€§

### æ·»åŠ æ–°è§„åˆ™ç±»å‹

1. åœ¨ `import_cc_confirm_rules.py` ä¸­æ·»åŠ æ¡ä»¶å¤„ç†å™¨
2. åœ¨ `rule_condition.py` ä¸­æ·»åŠ åŒ¹é…é€»è¾‘ï¼ˆå¦‚éœ€è¦ï¼‰
3. å¯¼å…¥è§„åˆ™åˆ°æ•°æ®åº“

**ç¤ºä¾‹ï¼š**
```python
# 1. æ·»åŠ æ¡ä»¶å¤„ç†å™¨
def handle_new_condition(cond2: str, qty: str):
    # è§£ææ¡ä»¶
    # è¿”å›ç»“æ„åŒ–æ¡ä»¶å­—å…¸
    return [{"new_condition": {...}}], None

# 2. æ³¨å†Œå¤„ç†å™¨
EXTENDED_CONDITION_HANDLERS["æ–°ç±»å‹"] = {
    "æ–°æ¡ä»¶": handle_new_condition
}

# 3. åœ¨ rule_condition.py ä¸­æ·»åŠ åŒ¹é…é€»è¾‘
elif key == "new_condition":
    # åŒ¹é…é€»è¾‘
    return match_new_condition(value, bazi_data)
```

### æ·»åŠ æ–°æ¡ä»¶ç±»å‹

1. åœ¨ `rule_condition.py` çš„ `EnhancedRuleCondition.match()` ä¸­æ·»åŠ æ¡ä»¶å¤„ç†
2. åœ¨ `rule_engine.py` çš„ç´¢å¼•æ„å»ºä¸­æ·»åŠ ç´¢å¼•ï¼ˆå¦‚éœ€è¦ï¼‰

**ç¤ºä¾‹ï¼š**
```python
# åœ¨ rule_condition.py ä¸­æ·»åŠ 
elif key == "new_condition_type":
    # åŒ¹é…é€»è¾‘
    condition_value = value
    bazi_value = bazi_data.get('...')
    return condition_value == bazi_value
```

### æ·»åŠ æ–°æŸ¥è¯¢é€‚é…å™¨

1. åœ¨ `query_adapters.py` ä¸­æ³¨å†Œé€‚é…å™¨
2. åœ¨è§„åˆ™å†…å®¹ä¸­ä½¿ç”¨ `"type": "dynamic"` å’Œ `"query_adapter"`

**ç¤ºä¾‹ï¼š**
```python
# 1. æ³¨å†Œé€‚é…å™¨
QueryAdapterRegistry.register(
    adapter_name="NewAnalyzer",
    adapter_class=NewAnalyzer,
    query_method="analyze_new"
)

# 2. åœ¨è§„åˆ™ä¸­ä½¿ç”¨
{
  "type": "dynamic",
  "query_adapter": "NewAnalyzer",
  "query_method": "analyze_new"
}
```

---

## æ ¸å¿ƒæ–‡ä»¶æ¸…å•

```
server/
â”œâ”€â”€ engines/
â”‚   â”œâ”€â”€ rule_engine.py          # è§„åˆ™å¼•æ“ï¼ˆç´¢å¼•ä¼˜åŒ–ã€å¹¶è¡ŒåŒ¹é…ï¼‰
â”‚   â”œâ”€â”€ rule_condition.py      # æ¡ä»¶åŒ¹é…å™¨ï¼ˆ1500+ è¡Œï¼Œ50+ æ¡ä»¶ç±»å‹ï¼‰
â”‚   â””â”€â”€ query_adapters.py      # æŸ¥è¯¢é€‚é…å™¨ï¼ˆåŠ¨æ€å†…å®¹æŸ¥è¯¢ï¼‰
â”œâ”€â”€ services/
â”‚   â””â”€â”€ rule_service.py        # è§„åˆ™æœåŠ¡å±‚ï¼ˆå•ä¾‹ã€ç¼“å­˜ã€çƒ­åŠ è½½ï¼‰
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ schema.sql             # æ•°æ®åº“è¡¨ç»“æ„
â”‚   â””â”€â”€ rule_content_dao.py    # è§„åˆ™å†…å®¹ DAO
â”œâ”€â”€ hot_reload/
â”‚   â”œâ”€â”€ hot_reload_manager.py  # çƒ­åŠ è½½ç®¡ç†å™¨
â”‚   â””â”€â”€ version_manager.py    # ç‰ˆæœ¬å·ç®¡ç†
â””â”€â”€ api/v1/
    â””â”€â”€ bazi_rules.py          # API æ¥å£

scripts/
â”œâ”€â”€ import_cc_confirm_rules.py  # è§„åˆ™å¯¼å…¥è„šæœ¬ï¼ˆä¸»å¯¼å…¥ï¼‰
â”œâ”€â”€ import_zhuijia_rules.py    # è¿½åŠ è§„åˆ™å¯¼å…¥
â””â”€â”€ handle_deities_huagai_liuhe_sanhe.py  # ç‰¹æ®Šæ¡ä»¶å¤„ç†å™¨

src/
â””â”€â”€ bazi_calculator.py         # å…«å­—è®¡ç®—å™¨ï¼ˆè°ƒç”¨è§„åˆ™åŒ¹é…ï¼‰
```

---

## æ€»ç»“

HiFateè§„åˆ™ç³»ç»Ÿæ˜¯ä¸€ä¸ª**é«˜æ€§èƒ½ã€å¯æ‰©å±•ã€æ”¯æŒçƒ­åŠ è½½çš„è§„åˆ™å¼•æ“**ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### æ ¸å¿ƒä¼˜åŠ¿

1. âœ… **æ•°æ®åº“é©±åŠ¨**ï¼šè§„åˆ™å­˜å‚¨åœ¨ MySQLï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°
2. âœ… **é«˜æ€§èƒ½**ï¼šç´¢å¼•ä¼˜åŒ– + å¹¶è¡ŒåŒ¹é… + å¤šçº§ç¼“å­˜
3. âœ… **çƒ­åŠ è½½**ï¼šæ”¯æŒè§„åˆ™å’Œå†…å®¹çš„çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡
4. âœ… **å¤æ‚æ¡ä»¶**ï¼šæ”¯æŒ 50+ ç§æ¡ä»¶ç±»å‹å’Œç»„åˆæ¡ä»¶
5. âœ… **åŠ¨æ€æŸ¥è¯¢**ï¼šæ”¯æŒåŠ¨æ€å†…å®¹æŸ¥è¯¢
6. âœ… **æ˜“äºæ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°è§„åˆ™ç±»å‹å’Œæ¡ä»¶ç±»å‹

### å½“å‰çŠ¶æ€

- **è§„åˆ™æ•°é‡**ï¼š462+ æ¡
- **è§„åˆ™ç±»å‹**ï¼š21+ ç§
- **æ¡ä»¶ç±»å‹**ï¼š50+ ç§
- **æ€§èƒ½**ï¼š< 100msï¼ˆæ— ç¼“å­˜ï¼‰ï¼Œ< 10msï¼ˆæœ‰ç¼“å­˜ï¼‰
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼š> 90%
- **ç´¢å¼•è¿‡æ»¤ç‡**ï¼š> 80%

### é€‚ç”¨åœºæ™¯

- âœ… å‘½ç†åˆ†æç³»ç»Ÿ
- âœ… è§„åˆ™åŒ¹é…å¼•æ“
- âœ… æ¡ä»¶åˆ¤æ–­ç³»ç»Ÿ
- âœ… åŠ¨æ€å†…å®¹æŸ¥è¯¢

---

**æœ€åæ›´æ–°ï¼š** 2025-01-15  
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0

