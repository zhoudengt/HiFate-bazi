# æµ‹è¯•å’Œä»£ç æ£€æŸ¥æŒ‡å—

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æµ‹è¯•å·¥å…·](#æµ‹è¯•å·¥å…·)
- [ä»£ç æ£€æŸ¥å·¥å…·](#ä»£ç æ£€æŸ¥å·¥å…·)
- [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
- [CI/CD é›†æˆ](#cicd-é›†æˆ)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¦‚è¿°

æœ¬é¡¹ç›®å·²é›†æˆå®Œæ•´çš„æµ‹è¯•å’Œä»£ç æ£€æŸ¥å·¥å…·é“¾ï¼Œç¡®ä¿ä»£ç è´¨é‡å’ŒåŠŸèƒ½æ­£ç¡®æ€§ã€‚

### å·¥å…·åˆ—è¡¨

| å·¥å…· | ç”¨é€” | ç±»å‹ |
|------|------|------|
| **pytest** | è¿è¡Œæµ‹è¯• | æµ‹è¯•æ¡†æ¶ |
| **pytest-cov** | æµ‹è¯•è¦†ç›–ç‡ | æµ‹è¯•å·¥å…· |
| **pylint** | ä»£ç è´¨é‡æ£€æŸ¥ | ä»£ç æ£€æŸ¥ |
| **black** | ä»£ç æ ¼å¼åŒ– | ä»£ç æ ¼å¼åŒ– |
| **mypy** | ç±»å‹æ£€æŸ¥ | ç±»å‹æ£€æŸ¥ |
| **isort** | å¯¼å…¥æ’åº | ä»£ç æ ¼å¼åŒ– |
| **flake8** | ä»£ç é£æ ¼æ£€æŸ¥ | ä»£ç æ£€æŸ¥ |

---

## æµ‹è¯•å·¥å…·

### pytest

**ç”¨é€”**ï¼šè¿è¡Œå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•

**é…ç½®æ–‡ä»¶**ï¼š`pytest.ini`

**è¿è¡Œæµ‹è¯•**ï¼š
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/unit/

# è¿è¡Œé›†æˆæµ‹è¯•
pytest tests/integration/

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest tests/unit/test_bazi_service.py

# æ˜¾ç¤ºè¦†ç›–ç‡
pytest --cov=server --cov-report=html
```

**æµ‹è¯•æ ‡è®°**ï¼š
```python
@pytest.mark.unit
def test_something():
    pass

@pytest.mark.integration
def test_api():
    pass
```

### æµ‹è¯•è¦†ç›–ç‡

**ç›®æ ‡**ï¼šå•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 50%

**æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š**ï¼š
```bash
pytest --cov=server --cov-report=html
# æ‰“å¼€ htmlcov/index.html æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
```

---

## ä»£ç æ£€æŸ¥å·¥å…·

### 1. Blackï¼ˆä»£ç æ ¼å¼åŒ–ï¼‰

**ç”¨é€”**ï¼šè‡ªåŠ¨æ ¼å¼åŒ– Python ä»£ç 

**ä½¿ç”¨**ï¼š
```bash
# æ£€æŸ¥æ ¼å¼
black --check server/

# è‡ªåŠ¨æ ¼å¼åŒ–
black server/
```

**é…ç½®**ï¼š`pyproject.toml`

### 2. pylintï¼ˆä»£ç è´¨é‡æ£€æŸ¥ï¼‰

**ç”¨é€”**ï¼šæ£€æŸ¥ä»£ç è´¨é‡ã€å‘ç°æ½œåœ¨é”™è¯¯

**ä½¿ç”¨**ï¼š
```bash
# æ£€æŸ¥ä»£ç 
pylint server/

# åªæ˜¾ç¤ºé”™è¯¯
pylint server/ --errors-only
```

**é…ç½®**ï¼š`.pylintrc`

### 3. mypyï¼ˆç±»å‹æ£€æŸ¥ï¼‰

**ç”¨é€”**ï¼šæ£€æŸ¥ç±»å‹æ³¨è§£

**ä½¿ç”¨**ï¼š
```bash
# ç±»å‹æ£€æŸ¥
mypy server/ --ignore-missing-imports
```

**é…ç½®**ï¼š`pyproject.toml`

### 4. isortï¼ˆå¯¼å…¥æ’åºï¼‰

**ç”¨é€”**ï¼šè‡ªåŠ¨æ’åº import è¯­å¥

**ä½¿ç”¨**ï¼š
```bash
# æ£€æŸ¥å¯¼å…¥é¡ºåº
isort --check server/

# è‡ªåŠ¨æ’åº
isort server/
```

**é…ç½®**ï¼š`pyproject.toml`

---

## ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿæ£€æŸ¥ï¼ˆæ¨èï¼‰

ä½¿ç”¨è„šæœ¬ä¸€é”®è¿è¡Œæ‰€æœ‰æ£€æŸ¥ï¼š

```bash
./scripts/tests/run_tests.sh
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
1. æ£€æŸ¥ä»£ç æ ¼å¼ï¼ˆBlackï¼‰
2. æ£€æŸ¥å¯¼å…¥æ’åºï¼ˆisortï¼‰
3. æ£€æŸ¥ä»£ç è´¨é‡ï¼ˆpylintï¼‰
4. æ£€æŸ¥ç±»å‹ï¼ˆmypyï¼‰
5. è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆpytestï¼‰

### æ‰‹åŠ¨è¿è¡Œ

#### 1. ä»£ç æ ¼å¼åŒ–
```bash
# æ ¼å¼åŒ–æ‰€æœ‰ä»£ç 
black server/ src/ services/

# æ ¼å¼åŒ–ç‰¹å®šæ–‡ä»¶
black server/api/v1/bazi.py
```

#### 2. ä»£ç æ£€æŸ¥
```bash
# pylint æ£€æŸ¥
pylint server/

# mypy ç±»å‹æ£€æŸ¥
mypy server/

# flake8 æ£€æŸ¥
flake8 server/
```

#### 3. è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/unit/ -v

# è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆéœ€è¦æœåŠ¡è¿è¡Œï¼‰
pytest tests/integration/ -v

# æŸ¥çœ‹è¦†ç›–ç‡
pytest --cov=server --cov-report=term-missing
```

---

## CI/CD é›†æˆ

### GitHub Actions

**é…ç½®æ–‡ä»¶**ï¼š`.github/workflows/ci.yml`

**è§¦å‘æ¡ä»¶**ï¼š
- æ¨é€åˆ° `master` æˆ– `develop` åˆ†æ”¯
- åˆ›å»º Pull Request

**å·¥ä½œæµ**ï¼š
1. **ä»£ç è´¨é‡æ£€æŸ¥**ï¼ˆlintï¼‰
   - Black æ ¼å¼æ£€æŸ¥
   - isort å¯¼å…¥æ£€æŸ¥
   - pylint è´¨é‡æ£€æŸ¥
   - mypy ç±»å‹æ£€æŸ¥

2. **å•å…ƒæµ‹è¯•**ï¼ˆtestï¼‰
   - è¿è¡Œå•å…ƒæµ‹è¯•
   - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
   - ä¸Šä¼ åˆ° Codecov

3. **é›†æˆæµ‹è¯•**ï¼ˆintegration-testï¼‰
   - è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆå¯é€‰ï¼‰

### åœ¨ deploy.sh ä¸­é›†æˆ

éƒ¨ç½²è„šæœ¬å·²é›†æˆæµ‹è¯•å’Œæ£€æŸ¥ï¼š

```bash
./deploy.sh
# é€‰æ‹© 1) å®Œæ•´éƒ¨ç½²
# ä¼šè‡ªåŠ¨è¿è¡Œï¼š
# - ä»£ç æ ¼å¼æ£€æŸ¥
# - ä»£ç è´¨é‡æ£€æŸ¥
# - å•å…ƒæµ‹è¯•
# - å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­
```

---

## æœ€ä½³å®è·µ

### 1. æäº¤ä»£ç å‰

```bash
# 1. æ ¼å¼åŒ–ä»£ç 
black server/

# 2. æ’åºå¯¼å…¥
isort server/

# 3. è¿è¡Œæµ‹è¯•
pytest tests/unit/ -v

# 4. æ£€æŸ¥ä»£ç è´¨é‡
pylint server/ --errors-only
```

### 2. å¼€å‘æ–°åŠŸèƒ½æ—¶

1. **å…ˆå†™æµ‹è¯•**ï¼ˆTDDï¼‰
   ```python
   # å…ˆå†™æµ‹è¯•
   def test_new_feature():
       result = new_feature()
       assert result == expected
   
   # å†å®ç°åŠŸèƒ½
   def new_feature():
       return expected
   ```

2. **è¿è¡Œæµ‹è¯•éªŒè¯**
   ```bash
   pytest tests/unit/test_new_feature.py -v
   ```

3. **æ£€æŸ¥ä»£ç è´¨é‡**
   ```bash
   pylint server/services/new_service.py
   ```

### 3. ä¿®å¤ Bug æ—¶

1. **å…ˆå†™æµ‹è¯•å¤ç° Bug**
   ```python
   def test_bug_reproduction():
       # å¤ç° Bug çš„åœºæ™¯
       with pytest.raises(ExpectedError):
           buggy_function()
   ```

2. **ä¿®å¤ Bug**
3. **éªŒè¯æµ‹è¯•é€šè¿‡**
   ```bash
   pytest tests/unit/test_bug_fix.py -v
   ```

### 4. ä»£ç å®¡æŸ¥æ¸…å•

æäº¤ä»£ç å‰æ£€æŸ¥ï¼š

- [ ] ä»£ç å·²æ ¼å¼åŒ–ï¼ˆ`black --check`ï¼‰
- [ ] å¯¼å…¥å·²æ’åºï¼ˆ`isort --check`ï¼‰
- [ ] æ—  pylint é”™è¯¯ï¼ˆ`pylint --errors-only`ï¼‰
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆ`pytest tests/unit/`ï¼‰
- [ ] æµ‹è¯•è¦†ç›–ç‡ä¸é™ä½
- [ ] æ–°å¢åŠŸèƒ½æœ‰å¯¹åº”æµ‹è¯•

---

## é…ç½®æ–‡ä»¶è¯´æ˜

### pytest.ini

pytest æµ‹è¯•é…ç½®ï¼š
- æµ‹è¯•è·¯å¾„ï¼š`tests/`
- è¦†ç›–ç‡ç›®æ ‡ï¼š> 50%
- è¾“å‡ºæ ¼å¼ï¼šè¯¦ç»†æ¨¡å¼

### .pylintrc

pylint ä»£ç è´¨é‡é…ç½®ï¼š
- æœ€å¤§è¡Œé•¿åº¦ï¼š120
- å¿½ç•¥ç›®å½•ï¼š`tests/`, `proto/generated/`
- ç¦ç”¨æŸäº›æ£€æŸ¥ï¼ˆå¦‚ç¼ºå°‘æ–‡æ¡£å­—ç¬¦ä¸²ï¼‰

### pyproject.toml

ç»Ÿä¸€é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«ï¼š
- Black æ ¼å¼åŒ–é…ç½®
- isort å¯¼å…¥æ’åºé…ç½®
- mypy ç±»å‹æ£€æŸ¥é…ç½®
- pytest é…ç½®
- coverage è¦†ç›–ç‡é…ç½®

---

## å¸¸è§é—®é¢˜

### Q1: æµ‹è¯•å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**: æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ï¼Œä¿®å¤é—®é¢˜åé‡æ–°è¿è¡Œæµ‹è¯•ã€‚

```bash
pytest tests/unit/test_xxx.py -v  # æŸ¥çœ‹è¯¦ç»†é”™è¯¯
```

### Q2: pylint æŠ¥é”™å¤ªå¤šæ€ä¹ˆåŠï¼Ÿ

**A**: å¯ä»¥å…ˆåªæ£€æŸ¥é”™è¯¯ï¼ˆ`--errors-only`ï¼‰ï¼Œè­¦å‘Šå¯ä»¥é€æ­¥ä¿®å¤ã€‚

```bash
pylint server/ --errors-only  # åªæ˜¾ç¤ºé”™è¯¯
```

### Q3: å¦‚ä½•è·³è¿‡æŸäº›æµ‹è¯•ï¼Ÿ

**A**: ä½¿ç”¨ pytest æ ‡è®°ï¼š

```python
@pytest.mark.skip(reason="éœ€è¦æ•°æ®åº“è¿æ¥")
def test_requires_db():
    pass
```

### Q4: å¦‚ä½•æé«˜æµ‹è¯•è¦†ç›–ç‡ï¼Ÿ

**A**: 
1. è¿è¡Œè¦†ç›–ç‡æŠ¥å‘Šï¼š`pytest --cov=server --cov-report=html`
2. æŸ¥çœ‹ `htmlcov/index.html` æ‰¾å‡ºæœªè¦†ç›–çš„ä»£ç 
3. ä¸ºæœªè¦†ç›–çš„ä»£ç æ·»åŠ æµ‹è¯•

---

## æ€»ç»“

### å·¥ä½œæµç¨‹

```
å¼€å‘ä»£ç 
  â†“
æ ¼å¼åŒ–ä»£ç ï¼ˆblackï¼‰
  â†“
æ’åºå¯¼å…¥ï¼ˆisortï¼‰
  â†“
è¿è¡Œæµ‹è¯•ï¼ˆpytestï¼‰
  â†“
ä»£ç æ£€æŸ¥ï¼ˆpylintï¼‰
  â†“
æäº¤ä»£ç 
  â†“
CI/CD è‡ªåŠ¨æ£€æŸ¥
  â†“
éƒ¨ç½²
```

### å…³é”®å‘½ä»¤

```bash
# ä¸€é”®æ£€æŸ¥
./scripts/tests/run_tests.sh

# æ ¼å¼åŒ–ä»£ç 
black server/

# è¿è¡Œæµ‹è¯•
pytest tests/unit/ -v

# æŸ¥çœ‹è¦†ç›–ç‡
pytest --cov=server --cov-report=html
```

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

