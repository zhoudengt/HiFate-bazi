# 服务启动脚本修复说明

## 问题描述

执行 `stop_all_services.sh` 时，发现所有服务的进程都不存在，但 PID 文件还存在。这说明：
- 服务启动失败后，PID 文件被写入，但进程已退出
- 或者服务被手动 kill 后，PID 文件没有清理

## 修复内容

### 1. 添加端口检查函数

新增 `check_port()` 函数，支持多种方式检查端口：
- 优先使用 `lsof`（macOS/Linux 常用）
- 备选 `netstat`（传统工具）
- 备选 `ss`（现代工具）
- 如果都没有，假设端口空闲（允许启动）

### 2. 启动前清理残留 PID 文件

在启动服务前：
- 检查 PID 文件是否存在
- 如果存在，检查进程是否真的在运行
- 如果进程不存在，自动清理残留的 PID 文件

### 3. 启动后验证进程

启动服务后：
- 等待 1 秒，检查进程是否还在运行
- 如果进程已退出，删除 PID 文件并显示错误信息
- 显示最近 10 行日志，便于排查问题

### 4. 验证端口监听

再次等待 1 秒后：
- 检查端口是否真的在监听
- 如果端口未监听，显示警告信息
- 显示最近 10 行日志

## 修复后的行为

### 启动成功
```
>>> 启动 bazi_core（端口 9001） …
    ✓ 已启动 PID=12345，日志: logs/bazi_core_9001.log
```

### 启动失败（进程退出）
```
>>> 启动 bazi_core（端口 9001） …
✗ bazi_core 启动失败，进程已退出。请查看日志: logs/bazi_core_9001.log
   最近10行日志:
   [错误信息...]
```

### 端口被占用
```
⚠️  端口 9001 已被占用，跳过启动 bazi_core
```

### 清理残留 PID 文件
```
ℹ️  清理残留的 PID 文件: logs/bazi_core_9001.pid
>>> 启动 bazi_core（端口 9001） …
```

## 改进点

1. **自动清理残留文件**：启动前自动清理无效的 PID 文件
2. **启动验证**：启动后验证进程和端口，确保服务真的在运行
3. **错误提示**：启动失败时显示日志，便于排查问题
4. **端口检查**：启动前检查端口是否被占用，避免启动失败
5. **跨平台兼容**：支持 lsof、netstat、ss 等多种端口检查工具

## 使用说明

### 启动所有服务
```bash
./start_all_services.sh
```

### 停止所有服务
```bash
./stop_all_services.sh
```

### 查看服务日志
```bash
tail -f logs/bazi_core_9001.log
tail -f logs/bazi_fortune_9002.log
tail -f logs/bazi_analyzer_9003.log
tail -f logs/bazi_rule_9004.log
tail -f logs/web_app_8001.log
```

## 注意事项

1. 启动脚本会在启动后等待 2 秒进行验证，这是正常的
2. 如果服务启动失败，会显示错误信息和日志，请根据提示排查
3. PID 文件会在服务停止时自动清理，如果手动 kill 进程，下次启动时会自动清理残留文件

