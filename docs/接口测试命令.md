# HiFate系统 - 接口测试命令

## 📋 目录

- [基础接口](#基础接口)
- [规则匹配接口](#规则匹配接口)
- [AI分析接口](#ai分析接口)
- [健康检查](#健康检查)
- [快速测试脚本](#快速测试脚本)

---

## 基础接口

### 1. 计算基础八字信息

**接口：** `POST /api/v1/bazi/calculate`

**功能：** 计算生辰八字的基础信息（四柱、十神、五行、神煞等）

**命令：**
```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male"
  }'
```

**参数说明：**
- `solar_date`: 阳历日期，格式：YYYY-MM-DD
- `solar_time`: 出生时间，格式：HH:MM
- `gender`: 性别，`male`（男）或 `female`（女）

**返回内容：**
- 四柱信息（年柱、月柱、日柱、时柱）
- 十神统计
- 五行统计
- 神煞列表
- 纳音信息
- 匹配的规则

---

### 2. 生成八字界面信息

**接口：** `POST /api/v1/bazi/interface`

**功能：** 生成完整的八字界面信息（包含命宫、身宫、胎元、胎息、命卦等）

**命令：**
```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/interface \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "name": "张三",
    "location": "北京",
    "latitude": 39.90,
    "longitude": 116.40
  }'
```

**参数说明：**
- `solar_date`: 阳历日期（必填）
- `solar_time`: 出生时间（必填）
- `gender`: 性别（必填）
- `name`: 姓名（可选）
- `location`: 出生地点（可选）
- `latitude`: 纬度（可选）
- `longitude`: 经度（可选）

---

### 3. 计算详细八字信息（包含大运流年）

**接口：** `POST /api/v1/bazi/detail`

**功能：** 计算详细八字信息，包含大运、流年、流月、流日、流时等

**命令：**
```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/detail \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "current_time": "2025-01-15 10:00"
  }'
```

**参数说明：**
- `solar_date`: 阳历日期（必填）
- `solar_time`: 出生时间（必填）
- `gender`: 性别（必填）
- `current_time`: 当前时间，格式：YYYY-MM-DD HH:MM（可选，默认使用系统当前时间）

**返回内容：**
- 基础八字信息
- 大运序列
- 流年序列
- 当前大运流年信息

---

## 规则匹配接口

### 4. 匹配八字规则

**接口：** `POST /api/v1/bazi/rules/match`

**功能：** 根据生辰八字匹配相应的规则并返回匹配结果

**命令（匹配所有规则）：**
```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/rules/match \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "rule_types": null,
    "include_bazi": true
  }'
```

**命令（只匹配婚姻相关规则）：**
```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/rules/match \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "rule_types": [
      "marriage_ten_gods",
      "marriage_element",
      "marriage_day_pillar",
      "marriage_deity"
    ],
    "include_bazi": true
  }'
```

**命令（只匹配日柱性别分析）：**
```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/rules/match \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "rule_types": ["rizhu_gender_dynamic"],
    "include_bazi": true
  }'
```

**参数说明：**
- `solar_date`: 阳历日期（必填）
- `solar_time`: 出生时间（必填）
- `gender`: 性别（必填）
- `rule_types`: 要匹配的规则类型列表（可选，`null` 表示匹配所有类型）
- `include_bazi`: 是否包含八字计算结果（可选，默认 `true`）

**常用规则类型：**
- `marriage_ten_gods` - 婚姻十神规则
- `marriage_element` - 婚姻五行规则
- `marriage_day_pillar` - 婚姻日柱规则
- `marriage_deity` - 婚姻神煞规则
- `taohua_general` - 桃花通用规则
- `rizhu_gender_dynamic` - 日柱性别动态分析

---

### 5. 获取规则类型列表

**接口：** `GET /api/v1/bazi/rules/types`

**功能：** 获取所有可用的规则类型列表

**命令：**
```bash
curl http://127.0.0.1:8001/api/v1/bazi/rules/types
```

**返回示例：**
```json
{
  "success": true,
  "rule_types": [
    "marriage_ten_gods",
    "marriage_element",
    "marriage_day_pillar",
    "rizhu_gender_dynamic",
    ...
  ],
  "count": 20
}
```

---

### 6. 获取规则统计信息

**接口：** `GET /api/v1/bazi/rules/stats`

**功能：** 获取规则引擎统计信息

**命令：**
```bash
curl http://127.0.0.1:8001/api/v1/bazi/rules/stats
```

**返回示例：**
```json
{
  "success": true,
  "total_rules": 462,
  "enabled_rules": 462,
  "rule_types": {
    "marriage_ten_gods": 50,
    "marriage_element": 30,
    ...
  },
  "cache_stats": {...}
}
```

---

### 7. 查询日柱性别规则内容

**接口：** `POST /api/v1/bazi/rules/query-rizhu-gender`

**功能：** 专门查询日柱性别规则的内容

**命令：**
```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/rules/query-rizhu-gender \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male"
  }'
```

---

## AI分析接口

### 8. AI分析八字

**接口：** `POST /api/v1/bazi/ai-analyze`

**功能：** 调用 Coze AI 进行八字分析

**命令：**
```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/ai-analyze \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "user_question": "请分析我的财运和事业",
    "include_rizhu_analysis": true
  }'
```

**参数说明：**
- `solar_date`: 阳历日期（必填）
- `solar_time`: 出生时间（必填）
- `gender`: 性别（必填）
- `user_question`: 用户的问题或分析需求（可选）
- `access_token`: Coze Access Token（可选，不提供则使用环境变量）
- `bot_id`: Coze Bot ID（可选，不提供则使用环境变量）
- `api_base`: Coze API 基础URL（可选，默认 https://api.coze.cn/v1）
- `include_rizhu_analysis`: 是否包含日柱性别分析结果（可选，默认 `true`）

---

## 健康检查

### 9. 健康检查

**接口：** `GET /health`

**功能：** 检查服务是否正常运行

**命令：**
```bash
curl http://127.0.0.1:8001/health
```

**返回示例：**
```json
{
  "status": "ok",
  "timestamp": "2025-01-15T10:00:00"
}
```

---

## 快速测试脚本

### 完整测试脚本

创建一个测试脚本 `test_api.sh`：

```bash
#!/bin/bash

BASE_URL="http://127.0.0.1:8001"

echo "=========================================="
echo "HiFate系统 - API 测试"
echo "=========================================="
echo ""

# 1. 健康检查
echo "1. 健康检查"
echo "----------------------------------------"
curl -s "${BASE_URL}/health" | jq .
echo ""
echo ""

# 2. 基础八字计算
echo "2. 基础八字计算"
echo "----------------------------------------"
curl -s -X POST "${BASE_URL}/api/v1/bazi/calculate" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male"
  }' | jq '.success, .data.bazi.bazi_pillars'
echo ""
echo ""

# 3. 规则类型列表
echo "3. 获取规则类型列表"
echo "----------------------------------------"
curl -s "${BASE_URL}/api/v1/bazi/rules/types" | jq .
echo ""
echo ""

# 4. 规则统计信息
echo "4. 获取规则统计信息"
echo "----------------------------------------"
curl -s "${BASE_URL}/api/v1/bazi/rules/stats" | jq .
echo ""
echo ""

# 5. 匹配所有规则
echo "5. 匹配所有规则"
echo "----------------------------------------"
curl -s -X POST "${BASE_URL}/api/v1/bazi/rules/match" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "rule_types": null,
    "include_bazi": true
  }' | jq '.success, .rule_count, .matched_rules | length'
echo ""
echo ""

# 6. 匹配日柱性别分析
echo "6. 匹配日柱性别分析"
echo "----------------------------------------"
curl -s -X POST "${BASE_URL}/api/v1/bazi/rules/match" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "rule_types": ["rizhu_gender_dynamic"],
    "include_bazi": false
  }' | jq '.success, .rule_count'
echo ""
echo ""

# 7. 详细八字（包含大运流年）
echo "7. 详细八字（包含大运流年）"
echo "----------------------------------------"
curl -s -X POST "${BASE_URL}/api/v1/bazi/detail" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "current_time": "2025-01-15 10:00"
  }' | jq '.success, .data.fortune.current_dayun, .data.fortune.current_liunian'
echo ""
echo ""

echo "=========================================="
echo "测试完成"
echo "=========================================="
```

**使用方法：**
```bash
chmod +x test_api.sh
./test_api.sh
```

---

## 使用 jq 美化输出

如果安装了 `jq`，可以使用它来美化 JSON 输出：

```bash
# 安装 jq（macOS）
brew install jq

# 使用示例
curl -s http://127.0.0.1:8001/api/v1/bazi/rules/types | jq .
```

---

## 使用 Python 测试

### Python 测试脚本

创建 `test_api.py`：

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""API 测试脚本"""

import requests
import json

BASE_URL = "http://127.0.0.1:8001"

def test_health():
    """测试健康检查"""
    print("1. 健康检查")
    response = requests.get(f"{BASE_URL}/health")
    print(f"   状态码: {response.status_code}")
    print(f"   响应: {response.json()}")
    print()

def test_calculate_bazi():
    """测试基础八字计算"""
    print("2. 基础八字计算")
    data = {
        "solar_date": "1990-05-15",
        "solar_time": "14:30",
        "gender": "male"
    }
    response = requests.post(f"{BASE_URL}/api/v1/bazi/calculate", json=data)
    result = response.json()
    print(f"   状态码: {response.status_code}")
    print(f"   成功: {result.get('success')}")
    if result.get('success'):
        pillars = result.get('data', {}).get('bazi', {}).get('bazi_pillars', {})
        print(f"   年柱: {pillars.get('year', {}).get('stem')}{pillars.get('year', {}).get('branch')}")
        print(f"   月柱: {pillars.get('month', {}).get('stem')}{pillars.get('month', {}).get('branch')}")
        print(f"   日柱: {pillars.get('day', {}).get('stem')}{pillars.get('day', {}).get('branch')}")
        print(f"   时柱: {pillars.get('hour', {}).get('stem')}{pillars.get('hour', {}).get('branch')}")
    print()

def test_match_rules():
    """测试规则匹配"""
    print("3. 匹配规则")
    data = {
        "solar_date": "1990-05-15",
        "solar_time": "14:30",
        "gender": "male",
        "rule_types": ["rizhu_gender_dynamic"],
        "include_bazi": False
    }
    response = requests.post(f"{BASE_URL}/api/v1/bazi/rules/match", json=data)
    result = response.json()
    print(f"   状态码: {response.status_code}")
    print(f"   成功: {result.get('success')}")
    print(f"   匹配规则数: {result.get('rule_count')}")
    print()

def test_get_rule_types():
    """测试获取规则类型"""
    print("4. 获取规则类型")
    response = requests.get(f"{BASE_URL}/api/v1/bazi/rules/types")
    result = response.json()
    print(f"   状态码: {response.status_code}")
    print(f"   规则类型数: {result.get('count')}")
    print(f"   规则类型: {', '.join(result.get('rule_types', [])[:5])}...")
    print()

if __name__ == "__main__":
    print("=" * 50)
    print("HiFate系统 - API 测试")
    print("=" * 50)
    print()
    
    try:
        test_health()
        test_calculate_bazi()
        test_match_rules()
        test_get_rule_types()
        
        print("=" * 50)
        print("测试完成")
        print("=" * 50)
    except Exception as e:
        print(f"测试失败: {e}")
```

**使用方法：**
```bash
python3 test_api.py
```

---

## 常见问题

### Q1: 接口返回 500 错误

**A:** 检查：
1. 服务是否正常启动：`curl http://127.0.0.1:8001/health`
2. 微服务是否都在运行：检查 `logs/` 目录下的日志文件
3. 数据库连接是否正常

### Q2: 接口返回 400 错误

**A:** 检查：
1. 请求参数格式是否正确
2. 日期格式是否为 `YYYY-MM-DD`
3. 时间格式是否为 `HH:MM`
4. 性别是否为 `male` 或 `female`

### Q3: 如何查看详细的请求和响应？

**A:** 使用 `-v` 参数：
```bash
curl -v -X POST http://127.0.0.1:8001/api/v1/bazi/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male"
  }'
```

### Q4: 如何保存响应到文件？

**A:** 使用重定向：
```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male"
  }' > response.json
```

---

## 接口文档

访问 Swagger UI 查看完整的接口文档：

```
http://127.0.0.1:8001/docs
```

或者访问 ReDoc：

```
http://127.0.0.1:8001/redoc
```

---

**最后更新：** 2025-01-15  
**适用版本：** HiFate系统 v1.0

