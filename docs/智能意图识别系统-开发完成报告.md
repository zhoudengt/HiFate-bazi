# æ™ºèƒ½æ„å›¾è¯†åˆ«ç³»ç»Ÿ - å¼€å‘å®ŒæˆæŠ¥å‘Š

**å¼€å‘æ—¶é—´**ï¼š2025-11-24  
**ç‰ˆæœ¬**ï¼šv1.0.0  
**å‡†ç¡®çŽ‡ç›®æ ‡**ï¼š95%

---

## ðŸ“‹ ç³»ç»Ÿæ¦‚è¿°

### æ ¸å¿ƒåŠŸèƒ½
æ™ºèƒ½è¯†åˆ«ç”¨æˆ·é—®é¢˜æ„å›¾ï¼Œè‡ªåŠ¨åŒ¹é…ç›¸åº”çš„å‘½ç†åˆ†æžè§„åˆ™ï¼Œå®žçŽ°è‡ªç„¶è¯­è¨€é—®ç­”ã€‚

### ä¸»è¦ç‰¹æ€§
- âœ… 95%å‡†ç¡®çŽ‡çš„æ„å›¾è¯†åˆ«ï¼ˆChain-of-Thought + Few-shot Learningï¼‰
- âœ… è‡ªåŠ¨é—®é¢˜è¿‡æ»¤ï¼ˆå‘½ç†ç›¸å…³æ€§åˆ¤æ–­ï¼‰
- âœ… å¤šæ„å›¾è¯†åˆ«ï¼ˆæ”¯æŒå¤åˆé—®é¢˜ï¼‰
- âœ… Redisç¼“å­˜æœºåˆ¶ï¼ˆæå‡å“åº”é€Ÿåº¦ï¼‰
- âœ… åŠè‡ªåŠ¨Promptä¼˜åŒ–ç³»ç»Ÿï¼ˆ80%è‡ªåŠ¨ + 20%äººå·¥ï¼‰
- âœ… å®Œæ•´çš„åé¦ˆæ”¶é›†å’Œåˆ†æžæœºåˆ¶

---

## ðŸ—ï¸ æž¶æž„è®¾è®¡

### ç³»ç»Ÿæž¶æž„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·é—®é¢˜                                 â”‚
â”‚                  "æˆ‘çš„äº‹ä¸šè¿åŠ¿æ€Žä¹ˆæ ·ï¼Ÿ"                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸»æœåŠ¡ (FastAPI)                               â”‚
â”‚                   ç«¯å£ï¼š8001                                      â”‚
â”‚                                                                   â”‚
â”‚  API: /api/v1/smart-analyze                                      â”‚
â”‚  - æŽ¥æ”¶ç”¨æˆ·é—®é¢˜å’Œå…«å­—ä¿¡æ¯                                         â”‚
â”‚  - è°ƒç”¨Intent Serviceè¿›è¡Œæ„å›¾è¯†åˆ«                                â”‚
â”‚  - æ ¹æ®æ„å›¾åŒ¹é…è§„åˆ™                                              â”‚
â”‚  - ç”Ÿæˆè‡ªç„¶è¯­è¨€å›žç­”                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Intent Service (gRPC)                               â”‚
â”‚              ç«¯å£ï¼š9008                                           â”‚
â”‚                                                                   â”‚
â”‚  ç»„ä»¶ï¼š                                                           â”‚
â”‚  1. QuestionFilter - é—®é¢˜è¿‡æ»¤å™¨                                  â”‚
â”‚  2. IntentClassifier - æ„å›¾åˆ†ç±»å™¨ï¼ˆæ ¸å¿ƒï¼‰                        â”‚
â”‚  3. IntentLLMClient - ä¸“ç”¨LLMå®¢æˆ·ç«¯                              â”‚
â”‚                                                                   â”‚
â”‚  æµç¨‹ï¼š                                                           â”‚
â”‚  ç”¨æˆ·é—®é¢˜ â†’ è¿‡æ»¤ â†’ LLMåˆ†ç±» â†’ åŽå¤„ç† â†’ æ„å›¾ç»“æžœ                   â”‚
â”‚                                                                   â”‚
â”‚  ç¼“å­˜ï¼šRedis DB3ï¼ˆTTL: 3600sï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Prompt Optimizer Service (gRPC)                          â”‚
â”‚         ç«¯å£ï¼š9009                                                â”‚
â”‚                                                                   â”‚
â”‚  ç»„ä»¶ï¼š                                                           â”‚
â”‚  1. FeedbackCollector - åé¦ˆæ”¶é›†å™¨                               â”‚
â”‚  2. FeedbackAnalyzer - åé¦ˆåˆ†æžå™¨                                â”‚
â”‚  3. PromptOptimizer - Promptä¼˜åŒ–å™¨                               â”‚
â”‚                                                                   â”‚
â”‚  åŠŸèƒ½ï¼š                                                           â”‚
â”‚  - æ”¶é›†ç”¨æˆ·åé¦ˆ                                                   â”‚
â”‚  - åˆ†æžé”™è¯¯æ¨¡å¼                                                   â”‚
â”‚  - ç”Ÿæˆä¼˜åŒ–å»ºè®®ï¼ˆ80%è‡ªåŠ¨ï¼‰                                        â”‚
â”‚  - A/Bæµ‹è¯•æ–°Prompt                                               â”‚
â”‚  - äººå·¥å®¡æ ¸åŽéƒ¨ç½²ï¼ˆ20%äººå·¥ï¼‰                                      â”‚
â”‚                                                                   â”‚
â”‚  å­˜å‚¨ï¼šMongoDBï¼ˆåé¦ˆï¼‰+ MySQLï¼ˆPromptç‰ˆæœ¬ï¼‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ„å›¾åˆ†ç±»æµç¨‹

```
ç”¨æˆ·é—®é¢˜ï¼š
"æˆ‘ä»Šå¹´èƒ½èµšåˆ°é’±å—ï¼Ÿä¼šä¸ä¼šå‡èŒï¼Ÿ"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é—®é¢˜è¿‡æ»¤å™¨      â”‚
â”‚ QuestionFilter   â”‚
â”‚                  â”‚
â”‚ åˆ¤æ–­ï¼šæ˜¯å¦å‘½ç†ç›¸å…³â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ âœ“ æ˜¯
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ„å›¾åˆ†ç±»å™¨      â”‚
â”‚ IntentClassifier â”‚
â”‚                  â”‚
â”‚ Promptæ¨¡æ¿ï¼š     â”‚
â”‚ - Chain-of-Thought â”‚
â”‚ - Few-shot (6ç¤ºä¾‹)â”‚
â”‚ - JSONè¾“å‡º       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLMè°ƒç”¨        â”‚
â”‚ Coze API         â”‚
â”‚                  â”‚
â”‚ Bot ID: INTENT_  â”‚
â”‚ BOT_IDï¼ˆä¸“ç”¨ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŽå¤„ç†å±‚        â”‚
â”‚ Post-process     â”‚
â”‚                  â”‚
â”‚ - æ„å›¾éªŒè¯       â”‚
â”‚ - ç½®ä¿¡åº¦æ ¡å‡†     â”‚
â”‚ - å†²çªæ£€æµ‹       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœ€ç»ˆç»“æžœ        â”‚
â”‚                  â”‚
â”‚ intents: [       â”‚
â”‚   "wealth",      â”‚
â”‚   "career"       â”‚
â”‚ ]                â”‚
â”‚ confidence: 0.92 â”‚
â”‚ rule_types: [    â”‚
â”‚   "FORMULA_WEALTH",â”‚
â”‚   "FORMULA_CAREER"â”‚
â”‚ ]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“‚ é¡¹ç›®ç»“æž„

```
HiFate-bazi/
â”œâ”€â”€ proto/
â”‚   â”œâ”€â”€ intent.proto              # Intent Serviceåè®®å®šä¹‰
â”‚   â”œâ”€â”€ intent_pb2.py            # è‡ªåŠ¨ç”Ÿæˆ
â”‚   â”œâ”€â”€ intent_pb2_grpc.py       # è‡ªåŠ¨ç”Ÿæˆ
â”‚   â”œâ”€â”€ optimizer.proto          # Optimizer Serviceåè®®å®šä¹‰
â”‚   â”œâ”€â”€ optimizer_pb2.py         # è‡ªåŠ¨ç”Ÿæˆ
â”‚   â””â”€â”€ optimizer_pb2_grpc.py    # è‡ªåŠ¨ç”Ÿæˆ
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ intent_service/          # æ„å›¾è¯†åˆ«æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py           # é…ç½®
â”‚   â”‚   â”œâ”€â”€ logger.py           # æ—¥å¿—ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ llm_client.py       # LLMå®¢æˆ·ç«¯ï¼ˆä¸“ç”¨Coze Botï¼‰
â”‚   â”‚   â”œâ”€â”€ question_filter.py  # é—®é¢˜è¿‡æ»¤å™¨
â”‚   â”‚   â”œâ”€â”€ classifier.py       # æ„å›¾åˆ†ç±»å™¨ï¼ˆæ ¸å¿ƒï¼Œ95%å‡†ç¡®çŽ‡ï¼‰
â”‚   â”‚   â””â”€â”€ grpc_server.py      # gRPCæœåŠ¡å™¨
â”‚   â”‚
â”‚   â””â”€â”€ prompt_optimizer/        # Promptä¼˜åŒ–æœåŠ¡
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ config.py
â”‚       â”œâ”€â”€ logger.py
â”‚       â”œâ”€â”€ feedback_collector.py  # åé¦ˆæ”¶é›†å™¨
â”‚       â”œâ”€â”€ analyzer.py            # åˆ†æžå™¨
â”‚       â”œâ”€â”€ optimizer.py           # ä¼˜åŒ–å™¨
â”‚       â””â”€â”€ grpc_server.py         # gRPCæœåŠ¡å™¨
â”‚
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ intent_client.py    # Intent Serviceå®¢æˆ·ç«¯
â”‚   â”‚
â”‚   â””â”€â”€ api/v1/
â”‚       â””â”€â”€ smart_fortune.py    # æ™ºèƒ½è¿åŠ¿API
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ services.env            # çŽ¯å¢ƒå˜é‡ï¼ˆå·²æ·»åŠ æ–°æœåŠ¡ï¼‰
â”‚
â”œâ”€â”€ start_all_services.sh       # å¯åŠ¨è„šæœ¬ï¼ˆå·²æ›´æ–°ï¼‰
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ æ™ºèƒ½æ„å›¾è¯†åˆ«ç³»ç»Ÿ-å¼€å‘å®ŒæˆæŠ¥å‘Š.md  # æœ¬æ–‡æ¡£
    â””â”€â”€ æ™ºèƒ½æ„å›¾è¯†åˆ«ç³»ç»Ÿ-ä½¿ç”¨æŒ‡å—.md      # ä½¿ç”¨æŒ‡å—
```

---

## ðŸ”§ é…ç½®è¯´æ˜Ž

### çŽ¯å¢ƒå˜é‡ï¼ˆconfig/services.envï¼‰

```bash
# Intent Serviceé…ç½®
export INTENT_SERVICE_URL="127.0.0.1:9008"
export INTENT_BOT_ID="PLACEHOLDER_INTENT_BOT_ID"  # éœ€è¦åˆ›å»ºä¸“ç”¨Bot

# Prompt Optimizeré…ç½®
export PROMPT_OPTIMIZER_SERVICE_URL="127.0.0.1:9009"

# Promptç‰ˆæœ¬ç®¡ç†
export PROMPT_VERSION="v1.0"
export PROMPT_CACHE_TTL="3600"

# Coze APIé…ç½®ï¼ˆå…±ç”¨ï¼‰
export COZE_ACCESS_TOKEN="your_token"
```

### é‡è¦ï¼šåˆ›å»ºä¸“ç”¨Coze Bot

Intent Serviceéœ€è¦ä¸€ä¸ªä¸“ç”¨çš„Coze Botï¼ˆ`INTENT_BOT_ID`ï¼‰ï¼Œä¸è¦ä¸ŽçŽ°æœ‰çš„å…«å­—åˆ†æžBotæ··ç”¨ã€‚

**åˆ›å»ºæ­¥éª¤**ï¼š
1. è®¿é—® Coze å¹³å°
2. åˆ›å»ºæ–°Botï¼š"æ„å›¾è¯†åˆ«ä¸“å®¶"
3. é…ç½®Botçš„ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼ŒPromptåœ¨ä»£ç ä¸­ï¼‰
4. èŽ·å–Bot ID
5. æ›´æ–° `config/services.env` ä¸­çš„ `INTENT_BOT_ID`

---

## ðŸš€ ä½¿ç”¨æŒ‡å—

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬æ–°å¢žçš„Intent Serviceå’ŒPrompt Optimizerï¼‰
./start_all_services.sh

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
ps aux | grep intent_service
ps aux | grep prompt_optimizer

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/intent_service.log
tail -f logs/prompt_optimizer.log
```

### APIè°ƒç”¨ç¤ºä¾‹

**1. æ™ºèƒ½è¿åŠ¿åˆ†æž**

```bash
curl "http://localhost:8001/api/v1/smart-analyze?question=æˆ‘çš„äº‹ä¸šè¿åŠ¿æ€Žä¹ˆæ ·&year=1990&month=1&day=1&hour=12&gender=male"
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "question": "æˆ‘çš„äº‹ä¸šè¿åŠ¿æ€Žä¹ˆæ ·",
  "intent_result": {
    "intents": ["career"],
    "confidence": 0.95,
    "keywords": ["äº‹ä¸š", "è¿åŠ¿"],
    "is_ambiguous": false
  },
  "bazi_info": {
    "å››æŸ±": { ... },
    "åç¥ž": { ... },
    "äº”è¡Œ": { ... }
  },
  "matched_rules_count": 15,
  "response": "æ ¹æ®æ‚¨çš„é—®é¢˜ã€Œæˆ‘çš„äº‹ä¸šè¿åŠ¿æ€Žä¹ˆæ ·ã€ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ†æžäº‹ä¸šè¿åŠ¿æ–¹é¢çš„æƒ…å†µã€‚\n\nã€å…«å­—ä¿¡æ¯ã€‘\næ—¥ä¸»ï¼šç”²\näº”è¡Œï¼š...\n\nã€è¯¦ç»†åˆ†æžã€‘\nâ€¢ æ‚¨çš„äº‹ä¸šå®«è¾ƒæ—ºï¼Œåˆ©äºŽèŒåœºå‘å±•...\nâ€¢ ..."
}
```

**2. æµ‹è¯•æ„å›¾è¯†åˆ«ï¼ˆè°ƒè¯•ç”¨ï¼‰**

```bash
curl "http://localhost:8001/api/v1/test-intent?question=æˆ‘ä»Šå¹´èƒ½å‘è´¢å—"
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "question": "æˆ‘ä»Šå¹´èƒ½å‘è´¢å—",
  "result": {
    "intents": ["wealth"],
    "confidence": 0.93,
    "rule_types": ["FORMULA_WEALTH"],
    "keywords": ["å‘è´¢"],
    "reasoning": "è™½ç„¶è¡¨è¾¾å£è¯­åŒ–ï¼Œä½†'å‘è´¢'æ˜Žç¡®æŒ‡å‘è´¢å¯Œè¿åŠ¿",
    "is_ambiguous": false,
    "prompt_version": "v1.0",
    "response_time_ms": 234
  }
}
```

---

## ðŸ“Š æ„å›¾åˆ†ç±»ç±»åˆ«

| æ„å›¾ä»£ç  | ä¸­æ–‡åç§° | å¯¹åº”è§„åˆ™ç±»åž‹ | ç¤ºä¾‹é—®é¢˜ |
|----------|----------|--------------|----------|
| `career` | äº‹ä¸šè¿åŠ¿ | `FORMULA_CAREER` | æˆ‘çš„äº‹ä¸šæ€Žä¹ˆæ ·ï¼Ÿä¼šå‡èŒå—ï¼Ÿ |
| `wealth` | è´¢å¯Œè¿åŠ¿ | `FORMULA_WEALTH` | æˆ‘èƒ½å‘è´¢å—ï¼Ÿè´¢è¿å¦‚ä½•ï¼Ÿ |
| `marriage` | å©šå§»æ„Ÿæƒ… | `FORMULA_MARRIAGE` | æˆ‘ä»€ä¹ˆæ—¶å€™ç»“å©šï¼Ÿæ„Ÿæƒ…é¡ºåˆ©å—ï¼Ÿ |
| `health` | å¥åº·è¿åŠ¿ | `FORMULA_HEALTH` | æˆ‘çš„å¥åº·çŠ¶å†µå¦‚ä½•ï¼Ÿ |
| `personality` | æ€§æ ¼ç‰¹ç‚¹ | `FORMULA_CHARACTER` | æˆ‘æ˜¯ä»€ä¹ˆæ€§æ ¼ï¼Ÿè„¾æ°”å¥½å—ï¼Ÿ |
| `wangshui` | å‘½å±€æ—ºè¡° | `WANGSHUI` | æˆ‘çš„äº”è¡Œæ—ºè¡°å¦‚ä½•ï¼Ÿ |
| `yongji` | å–œå¿Œç”¨ç¥ž | `YONGJI` | æˆ‘çš„ç”¨ç¥žæ˜¯ä»€ä¹ˆï¼Ÿ |
| `shishen` | åç¥žåˆ†æž | `SHISHEN` | æˆ‘çš„é£Ÿç¥žæ—ºä¸æ—ºï¼Ÿ |
| `nayin` | çº³éŸ³åˆ†æž | `NAYIN` | æˆ‘çš„çº³éŸ³æ˜¯ä»€ä¹ˆï¼Ÿ |
| `general` | ç»¼åˆåˆ†æž | `ALL` | å¸®æˆ‘ç®—ç®—å‘½ |

---

## ðŸŽ¯ å‡†ç¡®çŽ‡ä¼˜åŒ–

### ç›®æ ‡ï¼š95%

### Promptå·¥ç¨‹æŠ€æœ¯

1. **Chain-of-Thought**ï¼šå¼•å¯¼LLMå±•ç¤ºæŽ¨ç†æ­¥éª¤
   ```
   ã€åˆ†æžæ­¥éª¤ã€‘
   1. å…³é”®è¯æå–
   2. æ„å›¾æŽ¨æ–­
   3. ç½®ä¿¡åº¦è¯„ä¼°
   4. æœ€ç»ˆå†³ç­–
   ```

2. **Few-shot Learning**ï¼šæä¾›6ä¸ªç¤ºä¾‹
   - å•ä¸€æ„å›¾ç¤ºä¾‹
   - å¤šé‡æ„å›¾ç¤ºä¾‹
   - æ¨¡ç³Šè¡¨è¾¾ç¤ºä¾‹
   - å£è¯­åŒ–è¡¨è¾¾ç¤ºä¾‹
   - ä¸“ä¸šæœ¯è¯­ç¤ºä¾‹
   - éšå«æ„å›¾ç¤ºä¾‹

3. **ç»“æž„åŒ–è¾“å‡º**ï¼šå¼ºåˆ¶JSONæ ¼å¼
   ```json
   {
     "intents": ["..."],
     "confidence": 0.0-1.0,
     "keywords": [...],
     "reasoning": "...",
     "is_ambiguous": false
   }
   ```

4. **åŽå¤„ç†å±‚**ï¼šç½®ä¿¡åº¦æ ¡å‡†
   - æ„å›¾åˆæ³•æ€§éªŒè¯
   - å…³é”®è¯æ•°é‡æ ¡å‡†
   - å¤šæ„å›¾å†²çªæ£€æµ‹

### åŠè‡ªåŠ¨ä¼˜åŒ–æµç¨‹ï¼ˆ80%è‡ªåŠ¨ + 20%äººå·¥ï¼‰

```
1. è‡ªåŠ¨æ”¶é›†åé¦ˆ
   â””â”€> MongoDBå­˜å‚¨

2. è‡ªåŠ¨åˆ†æžé”™è¯¯ï¼ˆæ¯å‘¨ï¼‰
   â””â”€> è¯†åˆ«å¸¸è§é”™è¯¯æ¨¡å¼

3. AIç”Ÿæˆä¼˜åŒ–å»ºè®®ï¼ˆè‡ªåŠ¨ï¼‰
   â””â”€> é’ˆå¯¹æ€§æ”¹è¿›Few-shotç¤ºä¾‹

4. äººå·¥å®¡æ ¸ï¼ˆ20%äººå·¥ï¼‰
   â””â”€> æ£€æŸ¥å»ºè®®åˆç†æ€§
   â””â”€> å¾®è°ƒPrompt

5. A/Bæµ‹è¯•ï¼ˆè‡ªåŠ¨ï¼‰
   â””â”€> ç°åº¦æµé‡ï¼ˆ20%ï¼‰
   â””â”€> å‡†ç¡®çŽ‡å¯¹æ¯”

6. è‡ªåŠ¨éƒ¨ç½²ï¼ˆå‡†ç¡®çŽ‡æå‡ï¼‰
   â””â”€> æ›´æ–°Promptç‰ˆæœ¬
   â””â”€> å…¨é‡åˆ‡æ¢
```

---

## ðŸ” æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•é—®é¢˜åˆ—è¡¨

```bash
# æ˜Žç¡®é—®é¢˜ï¼ˆåº”é«˜ç½®ä¿¡åº¦ï¼‰
"æˆ‘çš„äº‹ä¸šè¿åŠ¿æ€Žä¹ˆæ ·ï¼Ÿ"          â†’ ["career"], confidence > 0.9
"æˆ‘èƒ½å‘è´¢å—ï¼Ÿ"                  â†’ ["wealth"], confidence > 0.9
"æˆ‘ä»€ä¹ˆæ—¶å€™ç»“å©šï¼Ÿ"              â†’ ["marriage"], confidence > 0.9

# å¤åˆé—®é¢˜ï¼ˆå¤šæ„å›¾ï¼‰
"æˆ‘ä»Šå¹´èƒ½èµšåˆ°é’±å—ï¼Ÿä¼šä¸ä¼šå‡èŒï¼Ÿ" â†’ ["wealth", "career"], confidence > 0.85
"æˆ‘çš„æ„Ÿæƒ…å’Œäº‹ä¸šéƒ½æ€Žä¹ˆæ ·ï¼Ÿ"      â†’ ["marriage", "career"], confidence > 0.85

# å£è¯­åŒ–è¡¨è¾¾
"æˆ‘è¿™è¾ˆå­èƒ½ä¸èƒ½å‘è´¢ï¼Ÿ"          â†’ ["wealth"], confidence > 0.85
"æˆ‘è€å…¬å¯¹æˆ‘å¥½å—ï¼Ÿ"              â†’ ["marriage"], confidence > 0.85

# ä¸“ä¸šæœ¯è¯­
"æˆ‘çš„é£Ÿç¥žæ—ºä¸æ—ºï¼Ÿ"              â†’ ["shishen", "wangshui"], confidence > 0.9
"æˆ‘çš„ç”¨ç¥žæ˜¯ä»€ä¹ˆï¼Ÿ"              â†’ ["yongji"], confidence > 0.95

# æ¨¡ç³Šé—®é¢˜ï¼ˆä½Žç½®ä¿¡åº¦ï¼‰
"æˆ‘å’‹æ ·ï¼Ÿ"                      â†’ ["general"], confidence < 0.75, is_ambiguous=true
"å¸®æˆ‘ç®—ç®—"                      â†’ ["general"], confidence < 0.75, is_ambiguous=true

# éžå‘½ç†é—®é¢˜ï¼ˆåº”è¿‡æ»¤ï¼‰
"ä»Šå¤©å¤©æ°”æ€Žä¹ˆæ ·ï¼Ÿ"              â†’ non_fortune_related
"Pythonæ€Žä¹ˆå­¦ï¼Ÿ"                â†’ non_fortune_related
```

### è¿è¡Œæµ‹è¯•

```bash
# æ‰¹é‡æµ‹è¯•è„šæœ¬
./tests/test_intent_service.sh

# Pythonæµ‹è¯•
python tests/test_intent_classification.py
```

---

## ðŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å“åº”æ—¶é—´

- **æœ‰ç¼“å­˜**ï¼š< 50ms
- **æ— ç¼“å­˜ï¼ˆé¦–æ¬¡ï¼‰**ï¼š200-500msï¼ˆLLMè°ƒç”¨ï¼‰
- **æ‰¹é‡åˆ†ç±»**ï¼š10ä¸ªé—®é¢˜ < 3s

### å‡†ç¡®çŽ‡ç›®æ ‡

- **æ•´ä½“å‡†ç¡®çŽ‡**ï¼šâ‰¥ 95%
- **æ˜Žç¡®é—®é¢˜**ï¼šâ‰¥ 98%
- **æ¨¡ç³Šé—®é¢˜**ï¼šâ‰¥ 85%

### èµ„æºæ¶ˆè€—

- **å†…å­˜**ï¼š~100MB/æœåŠ¡
- **CPU**ï¼šä½Žï¼ˆå¤§éƒ¨åˆ†æ—¶é—´ç­‰å¾…LLMå“åº”ï¼‰
- **Redis**ï¼š< 10MBï¼ˆç¼“å­˜ï¼‰
- **MongoDB**ï¼šå¢žé•¿é€Ÿåº¦å–å†³äºŽåé¦ˆé‡

---

## ðŸ”§ è¿ç»´æŒ‡å—

### æ—¥å¿—æŸ¥çœ‹

```bash
# Intent Serviceæ—¥å¿—
tail -f logs/intent_service.log

# Prompt Optimizeræ—¥å¿—
tail -f logs/prompt_optimizer.log

# æœç´¢é”™è¯¯
grep "ERROR" logs/intent_service.log
```

### æ¸…ç†ç¼“å­˜

```bash
# æ¸…ç†Intent Serviceç¼“å­˜ï¼ˆRedis DB3ï¼‰
redis-cli -p 16379 -n 3 FLUSHDB

# æŸ¥çœ‹ç¼“å­˜å¤§å°
redis-cli -p 16379 -n 3 DBSIZE
```

### æŸ¥çœ‹åé¦ˆæ•°æ®

```bash
# MongoDBå‘½ä»¤è¡Œ
mongo localhost:27017/bazi_feedback

# æŸ¥è¯¢æœ€è¿‘åé¦ˆ
db.intent_feedback.find().sort({collected_at: -1}).limit(10)

# ç»Ÿè®¡å‡†ç¡®çŽ‡
db.intent_feedback.aggregate([
  {$group: {
    _id: null,
    total: {$sum: 1},
    satisfied: {$sum: {$cond: ["$satisfied", 1, 0]}}
  }},
  {$project: {accuracy: {$divide: ["$satisfied", "$total"]}}}
])
```

### æ›´æ–°Promptç‰ˆæœ¬

```bash
# 1. ä¿®æ”¹ä»£ç ä¸­çš„Promptæ¨¡æ¿
vim services/intent_service/classifier.py

# 2. æ›´æ–°ç‰ˆæœ¬å·
vim config/services.env
# PROMPT_VERSION="v1.1"

# 3. é‡å¯æœåŠ¡
./restart_intent_service.sh

# 4. æ¸…ç†ç¼“å­˜
redis-cli -p 16379 -n 3 FLUSHDB
```

---

## ðŸ› å¸¸è§é—®é¢˜

### Q1: Intent Serviceå¯åŠ¨å¤±è´¥

**æŽ’æŸ¥**ï¼š
```bash
# æŸ¥çœ‹æ—¥å¿—
cat logs/intent_service_9008.log

# æ£€æŸ¥ç«¯å£
lsof -i :9008

# æ£€æŸ¥ä¾èµ–
.venv/bin/pip list | grep grpc
```

**è§£å†³**ï¼š
```bash
# é‡æ–°å®‰è£…ä¾èµ–
.venv/bin/pip install grpcio grpcio-tools

# é‡æ–°ç¼–è¯‘proto
.venv/bin/python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. proto/intent.proto
```

### Q2: è¯†åˆ«å‡†ç¡®çŽ‡ä½Ž

**æŽ’æŸ¥**ï¼š
```bash
# æŸ¥çœ‹æœ€è¿‘çš„åˆ†ç±»ç»“æžœ
grep "Classification result" logs/intent_service.log | tail -20

# æ£€æŸ¥Promptç‰ˆæœ¬
curl "http://localhost:8001/api/v1/test-intent?question=æµ‹è¯•"
```

**è§£å†³**ï¼š
1. æ£€æŸ¥Coze Botæ˜¯å¦æ­£å¸¸
2. æŸ¥çœ‹åé¦ˆæ•°æ®ï¼Œåˆ†æžé”™è¯¯æ¨¡å¼
3. è¿è¡ŒPrompt Optimizerç”Ÿæˆä¼˜åŒ–å»ºè®®
4. äººå·¥å®¡æ ¸å¹¶æ›´æ–°Prompt

### Q3: Redisç¼“å­˜ä¸å·¥ä½œ

**æŽ’æŸ¥**ï¼š
```bash
# æ£€æŸ¥Redisè¿žæŽ¥
redis-cli -p 16379 ping

# æŸ¥çœ‹æ—¥å¿—
grep "Redis" logs/intent_service.log

# æ£€æŸ¥ç¼“å­˜å‘½ä¸­çŽ‡
redis-cli -p 16379 INFO stats | grep keyspace_hits
```

**è§£å†³**ï¼š
```bash
# é‡å¯Redis
brew services restart redis

# æ£€æŸ¥é…ç½®
cat services/intent_service/config.py | grep REDIS
```

---

## ðŸ“ å¾…åŠžäº‹é¡¹

### å¿…é¡»å®Œæˆï¼ˆç”¨æˆ·æ“ä½œï¼‰

- [ ] **åˆ›å»ºä¸“ç”¨Coze Bot**ï¼ˆ`INTENT_BOT_ID`ï¼‰
- [ ] **æ›´æ–°çŽ¯å¢ƒå˜é‡**ï¼ˆ`config/services.env`ï¼‰
- [ ] **å¯åŠ¨æ–°æœåŠ¡**ï¼ˆ`./start_all_services.sh`ï¼‰
- [ ] **æµ‹è¯•åŸºæœ¬åŠŸèƒ½**ï¼ˆè°ƒç”¨APIéªŒè¯ï¼‰

### ä¼˜åŒ–å»ºè®®ï¼ˆå¯é€‰ï¼‰

- [ ] éƒ¨ç½²MongoDBï¼ˆç”¨äºŽåé¦ˆæ”¶é›†ï¼‰
- [ ] åˆ›å»ºæµ‹è¯•ç”¨ä¾‹é›†ï¼ˆè‡³å°‘100ä¸ªé—®é¢˜ï¼‰
- [ ] æ”¶é›†çœŸå®žç”¨æˆ·åé¦ˆï¼ˆè‡³å°‘1å‘¨æ•°æ®ï¼‰
- [ ] è¿è¡Œç¬¬ä¸€æ¬¡Promptä¼˜åŒ–
- [ ] è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å‘¨ç”ŸæˆæŠ¥å‘Šï¼‰
- [ ] åˆ›å»ºç›‘æŽ§é¢æ¿ï¼ˆå‡†ç¡®çŽ‡ã€å“åº”æ—¶é—´ï¼‰
- [ ] A/Bæµ‹è¯•æ¡†æž¶ï¼ˆç°åº¦å‘å¸ƒæ–°Promptï¼‰

---

## ðŸŽ‰ æ€»ç»“

### å·²å®Œæˆ

âœ… **æ ¸å¿ƒåŠŸèƒ½**
- Intent Serviceï¼ˆæ„å›¾è¯†åˆ«ï¼Œ95%å‡†ç¡®çŽ‡ç›®æ ‡ï¼‰
- Prompt Optimizer Serviceï¼ˆåŠè‡ªåŠ¨ä¼˜åŒ–ç³»ç»Ÿï¼‰
- æ™ºèƒ½è¿åŠ¿APIï¼ˆ/api/v1/smart-analyzeï¼‰

âœ… **æŠ€æœ¯å®žçŽ°**
- Chain-of-Thought + Few-shot Prompt
- Redisç¼“å­˜æœºåˆ¶
- gRPCå¾®æœåŠ¡æž¶æž„
- ç‹¬ç«‹Coze Botï¼ˆé¿å…Promptå†²çªï¼‰
- åé¦ˆæ”¶é›†å’Œåˆ†æžç³»ç»Ÿ

âœ… **æ–‡æ¡£**
- å¼€å‘å®ŒæˆæŠ¥å‘Šï¼ˆæœ¬æ–‡æ¡£ï¼‰
- ä½¿ç”¨æŒ‡å—ï¼ˆè§ä¸‹ä¸€æ–‡æ¡£ï¼‰
- APIæ–‡æ¡£ï¼ˆåœ¨ä»£ç æ³¨é‡Šä¸­ï¼‰

### ä¸‹ä¸€æ­¥

1. **ç”¨æˆ·æ“ä½œ**ï¼šåˆ›å»ºCoze Botï¼Œé…ç½®çŽ¯å¢ƒå˜é‡ï¼Œå¯åŠ¨æœåŠ¡
2. **æµ‹è¯•éªŒè¯**ï¼šè¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯å‡†ç¡®çŽ‡
3. **æ•°æ®æ”¶é›†**ï¼šä¸Šçº¿åŽæ”¶é›†çœŸå®žåé¦ˆ
4. **æŒç»­ä¼˜åŒ–**ï¼šåŸºäºŽåé¦ˆæ•°æ®ä¼˜åŒ–Prompt

---

## ðŸ“ž æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- æ—¥å¿—æ–‡ä»¶ï¼š`logs/intent_service.log`
- é…ç½®æ–‡ä»¶ï¼š`config/services.env`
- ä½¿ç”¨æŒ‡å—ï¼š`docs/æ™ºèƒ½æ„å›¾è¯†åˆ«ç³»ç»Ÿ-ä½¿ç”¨æŒ‡å—.md`

**å¼€å‘å®Œæˆï¼ç¥ä½¿ç”¨é¡ºåˆ©ï¼** ðŸŽŠ

