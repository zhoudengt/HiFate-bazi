# 微服务日志说明

## 日志位置

所有微服务的日志都保存在 `logs/` 目录下：

- `logs/bazi_core_9001.log` - bazi-core-service 日志
- `logs/bazi_fortune_9002.log` - bazi-fortune-service 日志
- `logs/bazi_analyzer_9003.log` - bazi-analyzer-service 日志
- `logs/bazi_rule_9004.log` - bazi-rule-service 日志
- `logs/web_app_8001.log` - Web App 日志

## 日志格式

### 微服务端日志

每个微服务在收到请求和完成处理时都会打印日志：

```
[2025-11-15 15:30:00] 📥 bazi-core-service: 收到请求 - solar_date=1990-05-15, solar_time=14:30, gender=male
[2025-11-15 15:30:00] ✅ bazi-core-service: 计算完成
[2025-11-15 15:30:00] ✅ bazi-core-service: 响应已返回
```

### 客户端日志

客户端调用微服务时会在 Web App 日志中记录：

```
[2025-11-15 15:30:00] 🔵 调用 bazi-core-service (gRPC): 127.0.0.1:9001, solar_date=1990-05-15, solar_time=14:30, gender=male
[2025-11-15 15:30:00] ✅ bazi-core-service (gRPC): 调用成功
```

或失败时：

```
[2025-11-15 15:30:00] ❌ bazi-core-service (gRPC): 调用失败 - <错误信息>
```

## 如何确认请求是否走微服务

### 方法1: 查看微服务日志

如果请求走了微服务，会在对应的微服务日志文件中看到：

```bash
# 查看 bazi-core-service 日志
tail -f logs/bazi_core_9001.log

# 查看 bazi-rule-service 日志
tail -f logs/bazi_rule_9004.log

# 查看 bazi-fortune-service 日志
tail -f logs/bazi_fortune_9002.log
```

**如果日志文件为空或没有新的日志输出，说明请求没有走微服务。**

### 方法2: 查看 Web App 日志

在 `logs/web_app_8001.log` 中查找：

- `🔵 调用 bazi-*-service (gRPC)` - 表示尝试调用微服务
- `✅ bazi-*-service (gRPC): 调用成功` - 表示成功调用微服务
- `❌ bazi-*-service (gRPC): 调用失败` - 表示调用失败，会回退到本地计算

### 方法3: 检查环境变量

确认环境变量是否配置：

```bash
echo $BAZI_CORE_SERVICE_URL
echo $BAZI_FORTUNE_SERVICE_URL
echo $BAZI_RULE_SERVICE_URL
```

如果环境变量未设置或为空，请求不会走微服务。

### 方法4: 检查服务状态

```bash
# 检查服务进程
ps aux | grep grpc_server

# 检查端口监听
lsof -i :9001  # bazi-core
lsof -i :9002  # bazi-fortune
lsof -i :9004  # bazi-rule
```

## 常见情况

### 情况1: 日志为空

**可能原因**:
1. 服务未启动
2. 服务启动失败
3. 日志输出被重定向但未正确刷新

**解决方法**:
1. 检查服务进程是否存在
2. 重启服务：`./stop_all_services.sh && ./start_all_services.sh`
3. 查看服务启动时的输出

### 情况2: 只有客户端日志，没有服务端日志

**说明**: 请求尝试调用微服务，但连接失败，回退到本地计算

**解决方法**:
1. 检查微服务是否正常运行
2. 检查端口是否监听
3. 检查网络连接

### 情况3: 客户端和服务端都有日志

**说明**: 请求成功走微服务

## 实时监控日志

### 同时监控所有日志

```bash
# 使用 tail -f 监控所有微服务日志
tail -f logs/bazi_core_9001.log logs/bazi_fortune_9002.log logs/bazi_rule_9004.log logs/web_app_8001.log
```

### 使用 grep 过滤特定请求

```bash
# 查找特定日期的请求
grep "1990-05-15" logs/bazi_core_9001.log

# 查找错误日志
grep "❌" logs/*.log

# 查找成功调用
grep "✅" logs/*.log
```

## 日志级别

- `📥` - 收到请求
- `✅` - 成功完成
- `❌` - 错误/失败
- `🔵` - 客户端调用

## 注意事项

1. **日志刷新**: 所有 `print` 语句都添加了 `flush=True`，确保日志立即写入文件
2. **时间戳**: 每条日志都包含时间戳，方便追踪请求处理时间
3. **日志文件大小**: 日志文件会持续增长，建议定期清理或使用日志轮转

---

生成时间: 2025-11-15
