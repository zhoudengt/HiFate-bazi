# 开发规范 - 快速参考

**更新日期**: 2025-11-24

---

## 📌 最重要的规范

### 1. 【强制】前后端职责分离

**前端只做展示，后端负责所有业务逻辑**

- ✅ 前端：接收输入 → 调用API → 展示结果
- ❌ 前端：不做计算、不做判断、不处理业务逻辑

详见：[前后端职责分离规范](前后端职责分离规范.md)

---

### 2. 【强制】最小影响原则

**坚决不可改动与之无关的代码**

修改前检查清单：
```
✓ 修改文件：[最小集合]
✓ 影响范围：[低/中/高]
✓ 影响功能：[列表]
✓ 需要确认：[是/否]
```

---

### 3. 【强制】分层架构

```
前端（frontend/）
  ↓ HTTP请求
API层（server/api/）
  ↓ 调用
Service层（server/services/）
  ↓ 调用
Core层（src/）
```

**不可跨层调用！**

---

## 📁 前端架构规范

### 文件职责

```
frontend/
├── js/
│   ├── fortune.js              # 数据逻辑和API调用（不可改UI）
│   ├── fortune-timeline.js     # 渲染和UI展示（不可改逻辑）
│   └── config.js               # API地址配置
├── css/                        # 样式文件
└── *.html                      # 页面文件
```

**职责分明**：
- `fortune.js` → 数据获取、状态管理
- `fortune-timeline.js` → DOM渲染、用户交互
- **不可跨界修改**

### 前端代码规范

**✅ 允许做的**：
```javascript
// 1. 调用API
const response = await fetch('/api/v1/smart-analyze?...');
const data = await response.json();

// 2. 展示数据
document.getElementById('result').textContent = data.response;

// 3. UI交互
button.addEventListener('click', () => analyzeFortune());
```

**❌ 禁止做的**：
```javascript
// ❌ 不要在前端计算八字
function calculateBazi(year, month, day) { ... }

// ❌ 不要在前端匹配规则
function matchRules(bazi) { ... }

// ❌ 不要在前端拼接复杂文本
function generateAnalysis(bazi, rules) { ... }
```

---

## 🐍 后端架构规范

### 文件职责

```
server/
├── api/                # API层：请求处理、参数验证
│   ├── v1/
│   │   ├── bazi_api.py
│   │   └── smart_fortune.py
├── services/           # Service层：业务逻辑
│   ├── bazi_service.py
│   ├── fortune_context_service.py
│   └── ...
└── db/                 # 数据库连接

src/                    # Core层：核心计算
├── bazi_calculator.py
├── bazi_*.py
└── ...
```

**分层原则**：
- 只修改必要的层
- 不跨层修改
- API → Service → Core 单向依赖

### 后端代码规范

**必须在后端做的**：
- ✅ 所有计算（八字、五行、十神、流年大运）
- ✅ 所有业务判断（规则匹配、条件判断）
- ✅ 所有文本生成（分析结果、建议）
- ✅ 返回完整的结构化数据

---

## 🔑 核心规则

### 1. 字符编码
- **数据库**：`utf8mb4`
- **Python**：UTF-8
- **JSON**：`ensure_ascii=False`

### 2. API设计
```python
# 参数验证
if not year or not month:
    return jsonify({'error': '缺少参数'}), 400

# 响应格式
return {
    'success': True,
    'data': {...},
    'error': None
}
```

### 3. 数据结构兼容
- **只添加新字段**，不修改/删除现有字段
- **保持向后兼容**
- API接口变更 → **必须咨询用户**

### 4. 错误处理
```python
try:
    result = service.analyze(...)
    return jsonify({'success': True, 'data': result})
except Exception as e:
    logger.error(f"Error: {e}")
    return jsonify({'success': False, 'error': str(e)}), 500
```

---

## 📝 代码规范

### Python命名
```python
# 类名：大驼峰
class BaziCalculator:
    pass

# 函数名：小写下划线
def calculate_bazi(year, month, day):
    pass

# 常量：大写下划线
MAX_RETRY_COUNT = 3

# 私有方法：单下划线前缀
def _internal_method(self):
    pass
```

### JavaScript命名
```javascript
// 变量/函数：小驼峰
let userName = "张三";
function analyzeFortune() { }

// 常量：大写下划线
const API_BASE_URL = "http://localhost:8001";

// 类名：大驼峰
class FortuneAnalyzer { }
```

---

## 🧪 测试规范

### 测试前检查
```bash
# 1. 语法检查
python3 -m py_compile file.py

# 2. 启动服务
./start_all_services.sh

# 3. 测试API
curl http://localhost:8001/api/v1/smart-analyze?...

# 4. 查看日志
tail -f logs/web_app_8001.log
```

### 本地测试
- ✅ 修改后立即测试
- ✅ 检查所有相关功能
- ✅ 确保不影响现有功能

---

## 📦 Git Flow

### 分支策略
```
master (生产环境)
  ↑ merge
develop (开发环境)
  ↑ merge  
feature/* (功能分支)
```

### 提交规范
```bash
[类型] 简短描述

- 修改文件：列出主要文件
- 功能说明：详细说明
- 测试情况：测试通过
```

**类型**：
- `[修复]` - Bug修复
- `[新增]` - 新功能
- `[优化]` - 性能优化
- `[文档]` - 文档更新

---

## 🔒 核心文件（修改前必须咨询）

| 文件 | 作用 | 风险 |
|------|------|------|
| `server/main.py` | 路由注册 | 高 |
| `src/bazi_calculator.py` | 核心计算逻辑 | 极高 |
| `frontend/js/fortune.js` | 前端主逻辑 | 高 |
| `server/db/mysql_connector.py` | 数据库连接 | 高 |

---

## 📚 详细文档

- [前后端职责分离规范](前后端职责分离规范.md) ⭐ 新增
- [快速开始](quick_start.md)
- [API文档](bazi_api_structure.json)
- [开发规范](DEVELOPMENT_GUIDELINES.md)
- [规则系统](rule_system_architecture.md)

---

## ✅ 开发原则

1. **先咨询，后修改**：不确定时询问用户
2. **小步快跑**：每次修改一个功能点
3. **及时测试**：修改后立即测试
4. **清晰记录**：修改过程记录到文档
5. **保持简洁**：避免过度设计
6. **注重性能**：考虑缓存和优化
7. **用户体验**：前端交互流畅、错误提示清晰
8. **职责分离**：前端展示、后端逻辑 ⭐ 新增

---

**记住：前端只做展示，后端负责逻辑。简单、清晰、易维护！** ✅

