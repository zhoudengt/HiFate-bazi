# 面相分析V2 - 快速使用指南

## 🚀 3步快速开始

### 步骤1：安装AI库（如果还没安装）

```bash
# 激活虚拟环境
source .venv/bin/activate

# 安装核心依赖
pip install mediapipe opencv-python numpy Pillow
```

### 步骤2：初始化数据库（首次使用）

```bash
# 创建数据库表
mysql -h 127.0.0.1 -P 13306 -u root -p --default-character-set=utf8mb4 bazi_system < server/db/migrations/face_v2_schema.sql

# 导入面相规则
python scripts/import_face_rules_v2.py
```

### 步骤3：启动服务

```bash
# 方式1：使用启动脚本
bash start_face_analysis_v2.sh

# 方式2：直接启动主服务
source .venv/bin/activate
python server/main.py
```

---

## 📸 使用方式

### 方式一：前端界面（推荐）

1. **打开浏览器**，访问：
   ```
   http://localhost:8001/face-analysis-v2.html
   ```

2. **上传照片**：
   - 点击上传框
   - 选择一张正面清晰的照片
   - 建议：五官清晰、光线充足、正面拍摄

3. **选择分析类型**（可选）：
   - ☑️ 十三宫位
   - ☑️ 六亲宫位
   - ☑️ 十神定位
   - ☐ 详细特征

4. **填写生辰信息**（可选）：
   - 年份、月份、日期、性别
   - 用于结合八字综合分析

5. **点击"开始分析"**：
   - 等待3-5秒
   - 查看分析结果

### 方式二：API调用

#### 1. 综合面相分析

```bash
curl -X POST "http://localhost:8001/api/v2/face/analyze" \
  -F "image=@你的照片.jpg" \
  -F "analysis_types=gongwei,liuqin,shishen" \
  -F "birth_year=1990" \
  -F "birth_month=5" \
  -F "birth_day=15" \
  -F "gender=male"
```

#### 2. 仅检测关键点

```bash
curl -X POST "http://localhost:8001/api/v2/face/detect" \
  -F "image=@你的照片.jpg"
```

#### 3. 查询规则

```bash
# 查询十三宫位规则
curl "http://localhost:8001/api/v2/face/rules/gongwei"

# 查询印堂规则
curl "http://localhost:8001/api/v2/face/rules/gongwei?position=印堂"
```

#### 4. 健康检查

```bash
curl "http://localhost:8001/api/v2/face/health"
```

---

## 📊 分析结果说明

### 返回的数据结构

```json
{
  "success": true,
  "data": {
    "face_detected": true,
    "landmarks": {
      "mediapipe_points": 468,      // MediaPipe检测到的关键点数量
      "mapped_features": 99          // 映射到面相特征点的数量
    },
    "santing_analysis": {            // 三停分析
      "upper_ratio": 0.33,          // 上停比例（额头）
      "middle_ratio": 0.34,         // 中停比例（眉到鼻）
      "lower_ratio": 0.33,          // 下停比例（鼻到下巴）
      "evaluation": "三停匀称，五官协调，运势平稳"
    },
    "wuyan_analysis": {             // 五眼分析
      "evaluation": "五眼匀称，面部协调，美观大方"
    },
    "gongwei_analysis": [           // 十三宫位分析
      {
        "name": "印堂",
        "position": "印堂",
        "features": ["位置居中"],
        "interpretations": [
          "印堂开阔明润，命宫开阔，运势亨通",
          "心胸宽广，为人正直"
        ]
      }
    ],
    "liuqin_analysis": [...],        // 六亲分析
    "shishen_analysis": [...],       // 十神分析
    "overall_summary": "综合面相分析完成"
  }
}
```

---

## 🎯 使用示例

### Python调用示例

```python
import requests

# 上传照片进行分析
url = "http://localhost:8001/api/v2/face/analyze"
files = {'image': open('test_face.jpg', 'rb')}
data = {
    'analysis_types': 'gongwei,liuqin,shishen',
    'birth_year': 1990,
    'birth_month': 5,
    'birth_day': 15,
    'gender': 'male'
}

response = requests.post(url, files=files, data=data)
result = response.json()

if result['success']:
    print("分析成功！")
    print("三停分析：", result['data']['santing_analysis']['evaluation'])
    print("宫位分析：", len(result['data']['gongwei_analysis']), "个宫位")
else:
    print("分析失败：", result.get('error', '未知错误'))
```

### JavaScript调用示例

```javascript
// 使用FormData上传
const formData = new FormData();
formData.append('image', fileInput.files[0]);
formData.append('analysis_types', 'gongwei,liuqin,shishen');

fetch('http://localhost:8001/api/v2/face/analyze', {
    method: 'POST',
    body: formData
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        console.log('分析成功！', data.data);
    } else {
        console.error('分析失败：', data.error);
    }
});
```

---

## ⚠️ 常见问题

### Q1: 服务启动失败

**检查步骤**：
```bash
# 1. 检查端口是否被占用
lsof -i :8001

# 2. 查看日志
tail -f logs/main_service.log

# 3. 检查依赖是否安装
python -c "import mediapipe; print('OK')"
```

### Q2: 未检测到人脸

**解决方案**：
- ✅ 确保照片为正面照
- ✅ 检查光线是否充足
- ✅ 五官是否清晰可见
- ✅ 尝试更换照片

### Q3: 规则没有显示

**解决方案**：
```bash
# 1. 确认规则已导入
mysql -h 127.0.0.1 -P 13306 -u root -p -e "SELECT COUNT(*) FROM bazi_system.face_rules_v2"

# 2. 重新导入规则
python scripts/import_face_rules_v2.py

# 3. 重启服务
```

### Q4: 依赖安装失败

**解决方案**：
```bash
# 使用国内镜像
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple mediapipe
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple opencv-python
```

---

## 📍 访问地址

- **前端页面**：http://localhost:8001/face-analysis-v2.html
- **API文档**：http://localhost:8001/docs
- **健康检查**：http://localhost:8001/api/v2/face/health

---

## 💡 使用技巧

1. **照片要求**：
   - 正面清晰，五官完整
   - 光线充足，避免阴影
   - 建议尺寸：800x600以上

2. **分析类型选择**：
   - 快速分析：只选"十三宫位"
   - 完整分析：全选所有类型
   - 专业分析：结合生辰信息

3. **结果解读**：
   - 三停五眼：看面部比例
   - 宫位分析：看具体部位运势
   - 综合总结：整体评价

---

## 🔗 相关文档

- **完整使用指南**：`docs/面相分析V2-使用指南.md`
- **项目总结**：`README_FACE_V2.md`
- **API文档**：访问 http://localhost:8001/docs

---

**祝您使用愉快！** 🎉

