# 历史问题复盘

## 问题1：生产环境服务崩溃和页面报错 - 2025-12-14

### 问题描述
- **现象**：所有微服务容器持续重启，生产页面报错 500
- **影响**：全部服务中断，前端功能完全不可用
- **复现**：生产环境访问页面返回 500 错误

### 根因分析
1. **直接原因**：
   - gRPC 代码兼容性问题：`add_registered_method_handlers` 方法不存在
   - 硬编码本地路径：`/Users/zhoudt/.../debug.log` 导致 FileNotFoundError
   - MySQL 密码配置问题：容器内环境变量为空
   - 容器代码未同步：proto 目录未挂载，使用镜像内旧代码

2. **根本原因**：
   - 代码生成工具版本与运行时版本不一致
   - 开发时使用了硬编码路径
   - 容器配置不完整，缺少代码目录挂载
   - 环境变量未正确传递到容器

3. **规范违反**：
   - ❌ 违反了路径配置规范（硬编码本地路径）
   - ❌ 违反了容器代码挂载规范（proto 目录未挂载）
   - ❌ 违反了 gRPC 兼容性规范（版本不一致）

### 解决方案
1. **修复 gRPC 代码兼容性**：
   - 删除所有 `add_registered_method_handlers` 方法调用
   - 为所有微服务添加 proto 目录挂载

2. **修复硬编码路径**：
   - 移除所有硬编码本地路径的调试日志代码
   - 如需日志，使用动态路径并添加异常处理

3. **修复 MySQL 配置**：
   - 确保容器启动使用 `--env-file`
   - 验证环境变量正确加载

4. **确保代码一致性**：
   - 所有微服务容器挂载 proto、services、src 目录
   - 通过 Git 和容器挂载确保代码同步

### 预防措施
1. **规范更新**：
   - ✅ 添加路径配置规范（禁止硬编码路径）
   - ✅ 添加容器代码挂载规范（必须挂载 proto 目录）
   - ✅ 添加 gRPC 兼容性规范（版本一致性）

2. **检查清单**：
   - [ ] 代码中无硬编码路径
   - [ ] 所有微服务容器挂载 proto 目录
   - [ ] gRPC 代码兼容性已验证
   - [ ] 环境变量正确传递到容器

## 问题2：十神命格规则匹配失败 - 2025-11-28

### 问题描述
- **现象**：生日 1987-01-07 09:00 无法匹配十神命格规则
- **影响**：所有十神命格规则都无法匹配，影响规则分析功能
- **复现**：调用 `/bazi/formula-analysis` API，`shishen_count` 始终为 0

### 根因分析
1. **直接原因**：
   - `formula_analysis.py` 中十神命格使用 `FormulaRuleService` 匹配
   - `FormulaRuleService` 期望旧格式（文本条件），但数据库规则已迁移为 JSON 格式
   - 规则条件格式问题：`hidden_stars_in_year` 包含文本描述（如"日柱副星有正财"）

2. **根本原因**：
   - 规则迁移后未统一匹配服务
   - 规则引擎未支持混合条件格式（文本描述+十神名称）
   - 缺少规则匹配的统一测试

3. **规范违反**：
   - ❌ 未使用统一的 `RuleService` 匹配规则
   - ❌ 规则条件格式不统一
   - ❌ 缺少规则匹配的验证测试

### 解决方案
1. **修改 `formula_analysis.py`**：
   - 移除 `FormulaRuleService` 特殊处理
   - 统一使用 `RuleService` 匹配所有规则（包括十神命格）

2. **增强 `rule_condition.py`**：
   - 增强 `hidden_stars_in_*` 条件处理
   - 支持解析文本描述（如"日柱副星有正财"）并检查对应柱

### 预防措施
1. **规范更新**：
   - ✅ 所有规则必须使用 `RuleService` 匹配
   - ✅ 规则条件格式必须统一为 JSON
   - ✅ 新增规则类型必须同步更新前后端

2. **检查清单**：
   - [ ] 新规则类型是否使用 `RuleService` 匹配
   - [ ] 规则条件格式是否符合 JSON 规范
   - [ ] 前后端是否同步支持新规则类型
   - [ ] 是否编写了规则匹配测试

## 问题3：数据库编码异常导致查询失败 - 2025-12-18

### 问题描述
- **现象**：生产环境"分数"和"幸运颜色"显示"暂无"
- **影响**：用户无法看到建除分数和幸运颜色信息
- **复现**：API 返回 `score: null` 和 `lucky_colors: null`，但数据库查询显示有数据

### 根因分析
1. **直接原因**：
   - 数据库记录编码异常（UTF-8 字符被错误编码为多字节序列）
   - Python 查询时无法匹配编码异常的记录
   - 使用普通 `WHERE` 条件查询返回 `None`

2. **根本原因**：
   - 数据导入时未使用正确的编码方式
   - 直接使用 SQL 插入中文字符，可能受到客户端编码影响
   - 未使用 `UNHEX` 或 `BINARY` 比较确保编码一致性

3. **规范违反**：
   - ❌ 未使用 `UNHEX` 插入中文字符数据
   - ❌ 未使用 `BINARY` 比较进行精确匹配
   - ❌ 未验证数据编码正确性

### 解决方案
1. **数据插入使用 UNHEX**：
   ```sql
   INSERT INTO daily_fortune_jianchu (jianchu, content, score, enabled) 
   VALUES (UNHEX('E694B6'), UNHEX('E883BDE9878FE5B08FE7BB93...'), 90, 1);
   ```

2. **查询使用 BINARY 比较**：
   ```python
   cursor.execute(
       "SELECT jianchu, score FROM daily_fortune_jianchu WHERE BINARY jianchu = %s",
       ('收',)
   )
   ```

### 预防措施
1. **规范更新**：
   - ✅ 所有包含中文字符的数据插入必须使用 `UNHEX`
   - ✅ 所有中文字段查询必须使用 `BINARY` 比较
   - ✅ 数据同步脚本必须验证编码正确性

2. **检查清单**：
   - [ ] 数据插入是否使用 `UNHEX`（中文字符）
   - [ ] 数据查询是否使用 `BINARY` 比较（中文字段）
   - [ ] 数据同步脚本是否验证编码正确性

## 问题4：开发上线成功率低

### 问题描述
- **现象**：多次开发上线达不到效果，总是需要重启服务
- **影响**：开发效率低，上线风险高
- **复现**：每次开发完成后，总是需要手动触发热更新或重启服务

### 根因分析
1. **直接原因**：
   - 热更新未自动触发
   - 开发完成后未验证热更新状态
   - 缺乏自动化的完整性检查

2. **根本原因**：
   - 缺乏自动化热更新系统
   - 缺乏完整性验证工具
   - 缺乏智能决策引擎

### 解决方案
1. **自动化热更新系统**：
   - 文件变更自动检测
   - 自动触发热更新
   - 自动验证热更新成功
   - 失败自动回滚

2. **完整性验证系统**：
   - 自动检查所有必需文件
   - 自动检查所有必需注册
   - 生成完整性报告

3. **智能决策引擎**：
   - 自动判断是否需要热更新
   - 禁止重启服务（强制热更新）
   - 提供明确的执行建议

### 预防措施
1. **使用自动化工具**：
   - ✅ 开发时使用文件监控自动触发热更新
   - ✅ 开发完成后使用完整性验证器检查
   - ✅ 使用智能决策引擎判断操作

2. **检查清单**：
   - [ ] 是否使用自动化热更新工具
   - [ ] 是否使用完整性验证器
   - [ ] 是否使用智能决策引擎
   - [ ] 是否禁止重启服务

