# 问题历史复盘

## 问题复盘：登录端点热更新后丢失问题（第三次出现）- 2025-12-23

**状态**：🔴 **未解决** - 问题依然存在，需要进一步排查

### 问题描述
- **现象**：每次上线后，登录页面报错 "Unsupported endpoint: /auth/login. Available endpoints:"
- **影响**：用户无法登录，影响所有需要认证的功能
- **复现**：每次增量部署后，登录功能失效
- **发生次数**：第三次出现（2025-12-23）

### 根因分析

#### 直接原因
1. **热更新后端点列表为空**：`SUPPORTED_ENDPOINTS` 字典在热更新后变为空字典
2. **装饰器未执行**：模块重新加载时，装饰器 `@_register("/auth/login")` 可能未执行
3. **动态注册未触发**：请求时动态注册逻辑存在，但端点列表为空时未触发恢复机制

#### 根本原因
1. **热更新流程缺陷**：
   - `reloaders.py` 中清空端点后，如果模块重新加载失败，端点会保持为空
   - 模块加载时的验证列表缺少 `/auth/login`，导致即使端点丢失也不会被发现和修复
   - 请求时如果端点列表为空，动态注册逻辑只针对特定端点，不会恢复所有端点

2. **缺乏兜底机制**：
   - 没有在请求时检查端点列表是否为空
   - 如果端点列表为空，应该立即恢复所有端点，而不是只注册请求的端点

3. **验证机制不完整**：
   - 模块加载时的验证列表缺少 `/auth/login`
   - 热更新后没有强制验证关键端点

### 解决方案

#### 修复1：在请求时检查端点列表是否为空（关键修复）
**文件**：`server/api/grpc_gateway.py` 第837行

**修改**：
```python
# ⭐ 关键修复：如果端点列表为空，说明热更新后装饰器未执行，立即恢复所有端点
if len(SUPPORTED_ENDPOINTS) == 0:
    logger.warning(f"⚠️  端点列表为空，可能是热更新后装饰器未执行，立即恢复所有端点...")
    try:
        # 调用 _ensure_endpoints_registered 恢复关键端点
        _ensure_endpoints_registered()
        # 重新获取 handler
        handler = SUPPORTED_ENDPOINTS.get(endpoint)
        logger.info(f"✅ 端点恢复完成，当前端点数量: {len(SUPPORTED_ENDPOINTS)}, 目标端点是否存在: {handler is not None}")
    except Exception as e:
        logger.error(f"❌ 端点恢复失败: {e}", exc_info=True)
```

**原因**：
- 如果端点列表为空，说明热更新后装饰器未执行
- 在请求时立即恢复所有端点，确保功能可用
- 这是最可靠的兜底机制

#### 修复2：在模块加载时验证列表中添加 `/auth/login`
**文件**：`server/api/grpc_gateway.py` 第1291行

**修改**：
```python
key_endpoints = ["/daily-fortune-calendar/query", "/bazi/interface", "/bazi/shengong-minggong", "/bazi/rizhu-liujiazi", "/auth/login"]
```

**原因**：
- 确保模块加载时检查 `/auth/login` 是否已注册
- 如果缺失，会自动触发 `_ensure_endpoints_registered()` 中的手动注册逻辑

#### 修复3：增强热更新后端点恢复机制
**文件**：`server/hot_reload/reloaders.py` 第221-237行

**修改**：
- 如果端点数量为0，调用 `_reload_endpoints()` 恢复端点
- 如果 `_reload_endpoints()` 也失败，直接注册关键端点

### 预防措施

#### 1. 规范更新
- ✅ 添加端点恢复机制规范（请求时检查端点列表是否为空）
- ✅ 添加关键端点验证规范（模块加载时必须验证所有关键端点）
- ✅ 添加热更新后端点恢复验证规范

#### 2. 检查清单
- [ ] 所有关键端点是否在验证列表中（包括 `/auth/login`）
- [ ] 请求时是否检查端点列表是否为空
- [ ] 热更新后是否验证端点恢复
- [ ] 是否测试了端点列表为空的情况

#### 3. 自动化测试
- 添加端点恢复机制测试
- 添加热更新后端点验证测试
- 添加端点列表为空时的恢复测试

### 经验教训

1. **兜底机制的重要性**：
   - 即使有完善的验证机制，也要在请求时添加兜底机制
   - 如果端点列表为空，应该立即恢复所有端点，而不是只注册请求的端点

2. **验证列表的完整性**：
   - 所有关键端点必须在验证列表中
   - 验证列表应该包含所有前端调用的端点

3. **热更新流程的健壮性**：
   - 热更新后必须验证端点恢复
   - 如果端点恢复失败，应该有明确的错误提示和恢复机制

### 相关文件
- `server/api/grpc_gateway.py` - gRPC 网关，端点注册和恢复逻辑
- `server/hot_reload/reloaders.py` - 热更新重载器，端点恢复机制
- `server/api/v1/auth.py` - 登录端点实现

### 下次预防
1. **部署前检查**：
   - 验证所有关键端点是否在验证列表中
   - 测试端点列表为空时的恢复机制

2. **部署后验证**：
   - 检查端点列表是否为空
   - 测试登录功能是否正常

3. **监控告警**：
   - 如果端点列表为空，应该触发告警
   - 如果端点恢复失败，应该记录详细日志
