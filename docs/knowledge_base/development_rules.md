# 开发规范摘要

## 核心原则

### 零停机原则
- 所有设计必须保证服务不中断
- 热更新：代码修改自动重载，无需重启
- 版本发布：滚动更新，新旧容器平滑切换
- 功能增加：向后兼容，增量部署

### 热更新强制规范（最高优先级）
- **所有代码更新必须通过热更新上线，坚决不允许重启服务！**
- 启动服务后禁止任何形式的重启操作
- 文件监控器每5秒检查一次文件变化
- 所有服务必须支持热更新（100%覆盖）

### gRPC 优先原则
- 所有服务间交互必须使用 gRPC
- 前端与后端交互通过 gRPC-Web 网关
- REST API 仅作为兼容层，新功能必须同时注册 gRPC 端点

### 规则存储规范
- **所有规则必须存储在数据库中，禁止从文件读取！**
- 规则匹配必须使用 `RuleService`
- 禁止使用 `FormulaRuleService`（已废弃）

## 新功能开发强制规范

### 开发前必读
- 必须阅读"新功能开发强制规范"章节
- 必须完成开发规范检查清单
- 违反规范的代码将被要求重构

### 开发流程
1. 需求分析 → 明确功能需求，评估影响范围
2. 规范检查 → 阅读相关规范章节，确认架构设计
3. 开发实现 → 按照规范编写代码，同步编写测试
4. 规范验证 → 运行开发规范检查清单
5. 代码审查 → 检查是否符合规范
6. 合并代码 → 所有检查通过后合并

### 开发规范检查清单

#### 架构设计检查
- [ ] 是否遵循 gRPC 优先原则
- [ ] 是否在 `grpc_gateway.py` 中注册了 gRPC 端点
- [ ] 是否遵循零停机原则（支持热更新）
- [ ] 是否考虑了负载均衡和故障转移

#### 代码规范检查
- [ ] 是否使用 Pydantic 模型定义请求/响应
- [ ] 是否使用 `Field` 提供字段描述和示例
- [ ] 是否使用 `@validator` 验证关键字段
- [ ] 是否遵循 JSON 序列化规范（`ensure_ascii=False`）
- [ ] 是否使用动态路径（禁止硬编码本地路径）
- [ ] 文件操作是否有异常处理（不影响业务）

#### 热更新检查（必须！）
- [ ] **开发完成后是否自动触发热更新（必须！）**
- [ ] 是否验证热更新状态正常
- [ ] **是否验证对应功能在热更新后正常工作（必须！）**
- [ ] 是否检查热更新日志（如有错误）
- [ ] **是否验证 API 端点正确注册到 gRPC 网关（必须！）**

## 路径配置规范

### 禁止的操作
- ❌ 硬编码本地路径（如 `/Users/zhoudt/...`）
- ❌ 硬编码 Mac 路径
- ❌ 硬编码 Windows 路径
- ❌ 日志写入无异常处理

### 正确的做法
- ✅ 基于项目根目录动态获取路径
- ✅ 使用 `os.path.join` 构建路径（跨平台兼容）
- ✅ 文件操作必须有异常处理
- ✅ 日志写入失败不影响业务

## 容器代码挂载规范

### 必须挂载的目录
- **proto** - gRPC 生成代码（必须！）
- **services** - 微服务代码
- **src** - 核心计算代码
- **server** - Web 服务代码

### Docker Compose 标准配置
```yaml
volumes:
  - /opt/HiFate-bazi/proto:/app/proto:ro
  - /opt/HiFate-bazi/services:/app/services:ro
  - /opt/HiFate-bazi/src:/app/src:ro
  - /opt/HiFate-bazi/server:/app/server:ro
```

## 热更新 API 接口

| 接口 | 方法 | 功能 |
|------|------|------|
| `/api/v1/hot-reload/status` | GET | 获取热更新状态 |
| `/api/v1/hot-reload/check` | POST | 手动触发检查 |
| `/api/v1/hot-reload/versions` | GET | 获取版本号 |
| `/api/v1/hot-reload/reload/{module}` | POST | 重载指定模块 |
| `/api/v1/hot-reload/rollback` | POST | 回滚到上一版本 |

## 开发完成后的标准流程

1. ✅ 代码修改完成
2. ✅ 运行测试验证
3. ✅ **自动触发热更新（必须！）**
4. ✅ 验证热更新成功
5. ✅ 验证功能正常
6. ✅ 提交代码

**热更新触发方式**：
```bash
# 方式1：手动触发热更新（推荐）
curl -X POST http://localhost:8001/api/v1/hot-reload/check

# 方式2：使用自动化工具
python3 scripts/ai/auto_hot_reload.py --trigger
```

