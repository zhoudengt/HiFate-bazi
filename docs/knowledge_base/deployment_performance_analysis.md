# å¢é‡éƒ¨ç½²è„šæœ¬æ€§èƒ½åˆ†æ

> **ç›®çš„**ï¼šåˆ†æå¢é‡éƒ¨ç½²è„šæœ¬çš„æ‰§è¡Œæ—¶é—´ï¼Œæ‰¾å‡ºå¯èƒ½å¡ä½çš„æ­¥éª¤
> **æœ€åæ›´æ–°**ï¼š2026-01-22

---

## ğŸ“Š å„æ­¥éª¤è€—æ—¶åˆ†æ

### 1. éƒ¨ç½²å‰æ£€æŸ¥ï¼ˆæœ¬åœ°æ‰§è¡Œï¼‰

| æ­¥éª¤ | é¢„è®¡è€—æ—¶ | å¯èƒ½å¡ä½çš„åŸå›  |
|------|---------|---------------|
| è¯­æ³•éªŒè¯ | 5-10ç§’ | æ‰«æå¤§é‡ Python æ–‡ä»¶ |
| æ¨¡å—å¯¼å…¥éªŒè¯ | 2-5ç§’ | æœ¬åœ°å¯èƒ½ç¼ºå°‘ä¾èµ– |
| **æ•°æ®åº“å˜æ›´æ£€æµ‹** | **10-30ç§’** | **è¿æ¥ç”Ÿäº§æ•°æ®åº“ï¼Œæ¯”è¾ƒè¡¨ç»“æ„** |
| **é…ç½®å˜æ›´æ£€æµ‹** | **5-10ç§’** | **SSH è¿æ¥ç”Ÿäº§æœåŠ¡å™¨è¯»å–é…ç½®** |
| ç”¨æˆ·ç¡®è®¤ | ç­‰å¾…è¾“å…¥ | äº¤äº’å¼ç­‰å¾… |

**æœ€å¯èƒ½å¡ä½çš„æ­¥éª¤**ï¼š
- æ•°æ®åº“å˜æ›´æ£€æµ‹ï¼šéœ€è¦è¿æ¥ç”Ÿäº§æ•°æ®åº“ï¼ˆ8.210.52.217:3306ï¼‰ï¼Œå¦‚æœç½‘ç»œæ…¢æˆ–æ•°æ®åº“å“åº”æ…¢ï¼Œå¯èƒ½è¶…æ—¶
- é…ç½®å˜æ›´æ£€æµ‹ï¼šéœ€è¦ SSH è¿æ¥ç”Ÿäº§æœåŠ¡å™¨ï¼Œå¦‚æœè¿æ¥æ…¢å¯èƒ½è¶…æ—¶

### 2. æœåŠ¡å™¨è¿æ¥æ£€æŸ¥

| æ­¥éª¤ | é¢„è®¡è€—æ—¶ | å¯èƒ½å¡ä½çš„åŸå›  |
|------|---------|---------------|
| Node1 SSH è¿æ¥ | 0.5-1ç§’ | ç½‘ç»œå»¶è¿Ÿ |
| Node2 SSH è¿æ¥ | 0.5-1ç§’ | ç½‘ç»œå»¶è¿Ÿ |

**å®é™…æµ‹è¯•**ï¼š
- Node1 SSH è¿æ¥ï¼š~1ç§’
- Node2 SSH è¿æ¥ï¼š~1ç§’

### 3. æ‹‰å–ä»£ç ï¼ˆæœåŠ¡å™¨ç«¯æ‰§è¡Œï¼‰

| æ­¥éª¤ | é¢„è®¡è€—æ—¶ | å¯èƒ½å¡ä½çš„åŸå›  |
|------|---------|---------------|
| Node1 git fetch | 1-3ç§’ | GitHub è®¿é—®é€Ÿåº¦ |
| Node1 git pull | 1-2ç§’ | ä»£ç å·®å¼‚å¤§å° |
| Node2 git fetch | 1-3ç§’ | GitHub è®¿é—®é€Ÿåº¦ |
| Node2 git pull | 1-2ç§’ | ä»£ç å·®å¼‚å¤§å° |

**å®é™…æµ‹è¯•**ï¼š
- git fetchï¼š~1.7ç§’
- git pullï¼š~1.6ç§’

### 4. éªŒè¯åŒæœºä»£ç ä¸€è‡´æ€§

| æ­¥éª¤ | é¢„è®¡è€—æ—¶ | å¯èƒ½å¡ä½çš„åŸå›  |
|------|---------|---------------|
| è·å–åŒæœº Git ç‰ˆæœ¬ | 2-4ç§’ | 2æ¬¡ SSH è¿æ¥ |
| æ£€æŸ¥å…³é”®æ–‡ä»¶ä¸€è‡´æ€§ | 10-20ç§’ | å¤šæ¬¡ SSH è¿æ¥ + md5sum |

**å¯èƒ½å¡ä½**ï¼šå¦‚æœåŒæœºä»£ç ä¸ä¸€è‡´ï¼Œéœ€è¦å¼ºåˆ¶åŒæ­¥ï¼Œå¯èƒ½è€—æ—¶æ›´é•¿

### 5. æœåŠ¡å™¨ç«¯éªŒè¯

| æ­¥éª¤ | é¢„è®¡è€—æ—¶ | å¯èƒ½å¡ä½çš„åŸå›  |
|------|---------|---------------|
| Node1 è¯­æ³•éªŒè¯ | 10-20ç§’ | æ‰«æå¤§é‡æ–‡ä»¶ |
| Node2 è¯­æ³•éªŒè¯ | 10-20ç§’ | æ‰«æå¤§é‡æ–‡ä»¶ |
| Node1 æ¨¡å—å¯¼å…¥éªŒè¯ | 5-10ç§’ | å¯¼å…¥æ‰€æœ‰æ¨¡å— |
| Node2 æ¨¡å—å¯¼å…¥éªŒè¯ | 5-10ç§’ | å¯¼å…¥æ‰€æœ‰æ¨¡å— |

### 6. è§¦å‘çƒ­æ›´æ–°

| æ­¥éª¤ | é¢„è®¡è€—æ—¶ | å¯èƒ½å¡ä½çš„åŸå›  |
|------|---------|---------------|
| Node1 çƒ­æ›´æ–°è§¦å‘ | 2-5ç§’ | ç­‰å¾…æœåŠ¡å“åº” |
| Node2 çƒ­æ›´æ–°è§¦å‘ | 2-5ç§’ | ç­‰å¾…æœåŠ¡å“åº” |
| çƒ­æ›´æ–°éªŒè¯ | 5-10ç§’ | ç­‰å¾…æœåŠ¡é‡æ–°åŠ è½½ |

---

## ğŸ”´ æœ€å¯èƒ½å¡ä½çš„æ­¥éª¤

### 1. æ•°æ®åº“å˜æ›´æ£€æµ‹ï¼ˆæœ€å¯èƒ½ï¼‰

**ä½ç½®**ï¼šç¬¬ä¸€æ­¥ - éƒ¨ç½²å‰æ£€æŸ¥
**è„šæœ¬ä½ç½®**ï¼š`scripts/db/detect_db_changes.py`
**è€—æ—¶**ï¼š10-30ç§’ï¼ˆå¦‚æœç½‘ç»œæ…¢å¯èƒ½æ›´é•¿ï¼‰

**åŸå› **ï¼š
- éœ€è¦è¿æ¥ç”Ÿäº§æ•°æ®åº“ï¼ˆ8.210.52.217:3306ï¼‰
- éœ€è¦æ¯”è¾ƒæœ¬åœ°å’Œç”Ÿäº§æ•°æ®åº“çš„è¡¨ç»“æ„
- å¦‚æœæ•°æ®åº“å“åº”æ…¢æˆ–ç½‘ç»œå»¶è¿Ÿé«˜ï¼Œå¯èƒ½è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è„šæœ¬å·²è®¾ç½® 10 ç§’è¶…æ—¶
- å¦‚æœè¶…æ—¶ï¼Œä¼šè·³è¿‡æ•°æ®åº“æ£€æµ‹ç»§ç»­æ‰§è¡Œ

### 2. é…ç½®å˜æ›´æ£€æµ‹

**ä½ç½®**ï¼šç¬¬ä¸€æ­¥ - éƒ¨ç½²å‰æ£€æŸ¥
**è„šæœ¬ä½ç½®**ï¼š`scripts/config/detect_config_changes.py`
**è€—æ—¶**ï¼š5-10ç§’

**åŸå› **ï¼š
- éœ€è¦ SSH è¿æ¥ç”Ÿäº§æœåŠ¡å™¨è¯»å–é…ç½®æ–‡ä»¶
- å¦‚æœ SSH è¿æ¥æ…¢å¯èƒ½è¶…æ—¶

### 3. åŒæœºä»£ç ä¸€è‡´æ€§æ£€æŸ¥

**ä½ç½®**ï¼šç¬¬å››æ­¥ - éªŒè¯åŒæœºä»£ç ä¸€è‡´æ€§
**è€—æ—¶**ï¼š10-30ç§’

**åŸå› **ï¼š
- éœ€è¦å¤šæ¬¡ SSH è¿æ¥ä¸¤å°æœåŠ¡å™¨
- éœ€è¦è®¡ç®—å¤šä¸ªæ–‡ä»¶çš„ md5 å€¼
- å¦‚æœåŒæœºä»£ç ä¸ä¸€è‡´ï¼Œéœ€è¦å¼ºåˆ¶åŒæ­¥ï¼Œè€—æ—¶æ›´é•¿

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ è¿›åº¦æç¤º**ï¼šåœ¨æ¯ä¸ªå¯èƒ½è€—æ—¶çš„æ­¥éª¤æ·»åŠ è¿›åº¦æç¤º
2. **è®¾ç½®è¶…æ—¶**ï¼šä¸ºæ‰€æœ‰ SSH å’Œæ•°æ®åº“æ“ä½œè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
3. **å¹¶è¡Œæ‰§è¡Œ**ï¼šNode1 å’Œ Node2 çš„æŸäº›æ“ä½œå¯ä»¥å¹¶è¡Œæ‰§è¡Œ
4. **ç¼“å­˜ç»“æœ**ï¼šæ•°æ®åº“å’Œé…ç½®å˜æ›´æ£€æµ‹ç»“æœå¯ä»¥ç¼“å­˜ï¼Œé¿å…é‡å¤æ£€æµ‹

---

## ğŸ“ å¿«é€Ÿè¯Šæ–­å‘½ä»¤

```bash
# æµ‹è¯• SSH è¿æ¥é€Ÿåº¦
time sshpass -p "$SSH_PASSWORD" ssh root@8.210.52.217 "echo 'test'"

# æµ‹è¯•æ•°æ®åº“è¿æ¥é€Ÿåº¦
time python3 scripts/db/detect_db_changes.py

# æµ‹è¯•é…ç½®æ£€æµ‹é€Ÿåº¦
time python3 scripts/config/detect_config_changes.py

# æµ‹è¯• Git æ“ä½œé€Ÿåº¦
time sshpass -p "$SSH_PASSWORD" ssh root@8.210.52.217 "cd /opt/HiFate-bazi && git fetch origin"
```

---

## ğŸ” å¦‚ä½•å®šä½å¡ä½çš„ä½ç½®

1. **ä½¿ç”¨è°ƒè¯•æ¨¡å¼**ï¼š
   ```bash
   bash -x deploy/scripts/incremental_deploy_production.sh 2>&1 | tee deploy.log
   ```

2. **æ·»åŠ æ—¶é—´æˆ³**ï¼š
   ```bash
   bash deploy/scripts/incremental_deploy_production.sh 2>&1 | while IFS= read -r line; do echo "[$(date +%H:%M:%S)] $line"; done
   ```

3. **æ£€æŸ¥æœ€åè¾“å‡º**ï¼š
   ```bash
   tail -20 deploy.log
   ```
