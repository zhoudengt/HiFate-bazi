# 热更新系统设计规范

## 📋 目录

1. [系统概述](#1-系统概述)
2. [架构设计](#2-架构设计)
3. [监控机制](#3-监控机制)
4. [更新流程](#4-更新流程)
5. [代码规范](#5-代码规范)
6. [生产环境要求](#6-生产环境要求)
7. [无重启更新方案](#7-无重启更新方案)
8. [回滚机制](#8-回滚机制)
9. [监控和告警](#9-监控和告警)
10. [使用指南](#10-使用指南)

---

## 1. 系统概述

### 1.1 设计目标

- ✅ **零停机更新**：所有代码更新无需重启服务
- ✅ **实时监控**：监控所有代码文件的变化
- ✅ **自动热更新**：检测到变化后自动重新加载
- ✅ **代码验证**：更新前进行语法检查和完整性验证
- ✅ **回滚机制**：更新失败自动回滚到上一版本
- ✅ **生产就绪**：满足生产环境的高可用要求

### 1.2 核心特性

1. **文件监控**：实时监控所有 Python 源代码文件
2. **版本管理**：基于文件修改时间和内容哈希的版本控制
3. **语法检查**：更新前自动检查 Python 语法
4. **模块重载**：使用 `importlib.reload` 重新加载模块
5. **错误处理**：更新失败时自动回滚
6. **日志记录**：详细记录所有更新操作

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                   文件监控层                              │
│  FileMonitor - 监控所有代码文件变化                      │
│  - 文件扫描                                              │
│  - 哈希计算                                              │
│  - 语法检查                                              │
└──────────────────────┬──────────────────────────────────┘
                       │
                       │ 文件变化事件
                       │
┌──────────────────────▼──────────────────────────────────┐
│                 版本管理层                                │
│  VersionManager - 管理模块版本号                          │
│  - 版本检查                                              │
│  - 版本缓存                                              │
│  - 变化检测                                              │
└──────────────────────┬──────────────────────────────────┘
                       │
                       │ 版本变化事件
                       │
┌──────────────────────▼──────────────────────────────────┐
│               热更新管理器层                              │
│  HotReloadManager - 统一管理热更新                        │
│  - 定时检查                                              │
│  - 模块重载                                              │
│  - 回调执行                                              │
└──────────────────────┬──────────────────────────────────┘
                       │
                       │ 重载指令
                       │
        ┌──────────────┼──────────────┐
        │              │              │
┌───────▼──────┐ ┌─────▼──────┐ ┌───▼──────────┐
│ 规则重载器    │ │ 内容重载器  │ │ 源代码重载器 │
│ RuleReloader │ │ContentReload│ │SourceCodeRel│
└──────────────┘ └─────────────┘ └─────────────┘
```

### 2.2 组件说明

| 组件 | 职责 | 实现文件 |
|------|------|---------|
| **FileMonitor** | 文件监控、语法检查 | `server/hot_reload/file_monitor.py` |
| **VersionManager** | 版本号管理、变化检测 | `server/hot_reload/version_manager.py` |
| **HotReloadManager** | 热更新调度、模块重载 | `server/hot_reload/hot_reload_manager.py` |
| **Reloaders** | 具体模块的重载逻辑 | `server/hot_reload/reloaders.py` |

---

## 3. 监控机制

### 3.1 文件监控

#### 监控范围
- **源代码目录**：`src/`, `server/`, `services/`
- **文件类型**：所有 `.py` 文件
- **排除项**：`__pycache__`, `.pyc`, `.git`, `.venv` 等

#### 监控指标
1. **文件修改时间**（mtime）：检测文件是否被修改
2. **文件内容哈希**（MD5）：检测文件内容是否变化
3. **语法有效性**：使用 AST 解析检查 Python 语法

#### 监控频率
- **默认间隔**：5秒检查一次
- **可配置**：通过环境变量 `HOT_RELOAD_CHECK_INTERVAL` 配置

### 3.2 版本管理

#### 版本号生成规则

| 模块类型 | 版本号来源 | 说明 |
|---------|-----------|------|
| **rules** | 数据库 `rule_version` 表 | 规则版本号 |
| **content** | 数据库 `rule_version` 表 | 内容版本号 |
| **source** | 文件修改时间戳 | 最新文件的 mtime |
| **config** | 配置文件修改时间 | 配置文件的 mtime |

#### 版本变化检测
```python
# 检查版本是否变化
current_version = VersionManager.get_version('source')
cached_version = VersionManager.get_cached_version('source')

if current_version > cached_version:
    # 版本变化，需要重新加载
    reload_module('source')
```

### 3.3 自动检查机制

#### 定时检查
- **检查间隔**：默认 5 分钟（300秒）
- **检查内容**：所有注册的模块版本号
- **触发条件**：版本号变化

#### 手动触发
```bash
# 通过 API 手动触发
curl -X POST http://localhost:8001/api/v1/hot-reload/check

# 检查指定模块
curl -X POST http://localhost:8001/api/v1/hot-reload/check?module_name=source
```

---

## 4. 更新流程

### 4.1 标准更新流程

```
1. 开发人员修改代码
   ↓
2. 文件监控器检测到文件变化（5秒内）
   ↓
3. 计算文件哈希，检查语法
   ↓
4. 如果语法错误，记录错误，不更新
   ↓
5. 如果语法正确，更新版本号
   ↓
6. 热更新管理器检测到版本变化（5分钟内）
   ↓
7. 执行模块重载（importlib.reload）
   ↓
8. 验证重载结果
   ↓
9. 如果成功，更新版本缓存
   ↓
10. 如果失败，回滚到上一版本
```

### 4.2 更新类型

#### 1. 规则更新
```python
# 更新数据库中的规则版本号
UPDATE rule_version SET rule_version = rule_version + 1;

# 自动触发规则重载（5分钟内）
```

#### 2. 内容更新
```python
# 更新数据库中的内容版本号
UPDATE rule_version SET content_version = content_version + 1;

# 自动触发内容缓存清理（5分钟内）
```

#### 3. 源代码更新
```python
# 修改 Python 文件
# 文件监控器自动检测（5秒内）
# 热更新管理器自动重载（5分钟内）
```

### 4.3 更新验证

#### 语法检查
```python
# 使用 AST 解析检查语法
try:
    ast.parse(source_code, filename=file_path)
    syntax_valid = True
except SyntaxError:
    syntax_valid = False
    # 不进行更新
```

#### 模块重载验证
```python
# 重载后验证模块是否正常
try:
    importlib.reload(module)
    # 验证模块关键函数是否可用
    if hasattr(module, 'required_function'):
        module.required_function()
        reload_success = True
except Exception as e:
    reload_success = False
    # 回滚
```

---

## 5. 代码规范

### 5.1 热更新兼容性规范

#### ✅ 必须遵守的规范

1. **避免全局状态**
   ```python
   # ❌ 错误：全局变量在重载时不会重置
   global_counter = 0
   
   # ✅ 正确：使用类或函数封装
   class Counter:
       def __init__(self):
           self.count = 0
   ```

2. **使用单例模式**
   ```python
   # ✅ 正确：单例模式支持热更新
   class Service:
       _instance = None
       
       @classmethod
       def get_instance(cls):
           if cls._instance is None:
               cls._instance = cls()
           return cls._instance
   ```

3. **避免在模块级别执行代码**
   ```python
   # ❌ 错误：模块导入时执行，重载时会重复执行
   print("模块已加载")
   database_connection = connect()
   
   # ✅ 正确：使用函数或类初始化
   def get_database():
       if not hasattr(get_database, '_connection'):
           get_database._connection = connect()
       return get_database._connection
   ```

4. **使用依赖注入**
   ```python
   # ✅ 正确：依赖注入，便于测试和热更新
   class Service:
       def __init__(self, dependency):
           self.dependency = dependency
   ```

### 5.2 生产环境代码规范

#### 1. 错误处理

```python
# ✅ 必须：所有函数都要有异常处理
def process_data(data):
    try:
        result = complex_operation(data)
        return result
    except SpecificException as e:
        logger.error(f"处理失败: {e}", exc_info=True)
        raise  # 重新抛出或返回默认值
    except Exception as e:
        logger.critical(f"未知错误: {e}", exc_info=True)
        raise
```

#### 2. 日志记录

```python
# ✅ 必须：使用结构化日志
import logging

logger = logging.getLogger(__name__)

def process_request(request):
    logger.info("处理请求", extra={
        'request_id': request.id,
        'user_id': request.user_id
    })
    
    try:
        result = do_work(request)
        logger.info("处理成功", extra={
            'request_id': request.id,
            'duration': result.duration
        })
        return result
    except Exception as e:
        logger.error("处理失败", extra={
            'request_id': request.id,
            'error': str(e)
        }, exc_info=True)
        raise
```

#### 3. 性能要求

```python
# ✅ 必须：关键路径性能监控
import time
from functools import wraps

def monitor_performance(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        try:
            result = func(*args, **kwargs)
            duration = time.time() - start
            if duration > 1.0:  # 超过1秒记录警告
                logger.warning(f"函数 {func.__name__} 执行缓慢: {duration:.2f}秒")
            return result
        except Exception as e:
            duration = time.time() - start
            logger.error(f"函数 {func.__name__} 执行失败: {e}, 耗时: {duration:.2f}秒")
            raise
    return wrapper
```

#### 4. 资源管理

```python
# ✅ 必须：使用上下文管理器管理资源
from contextlib import contextmanager

@contextmanager
def database_connection():
    conn = None
    try:
        conn = get_connection()
        yield conn
        conn.commit()
    except Exception:
        if conn:
            conn.rollback()
        raise
    finally:
        if conn:
            conn.close()
```

#### 5. 类型提示

```python
# ✅ 推荐：使用类型提示
from typing import Optional, List, Dict

def process_data(
    data: Dict[str, Any],
    options: Optional[Dict] = None
) -> List[Dict]:
    """处理数据
    
    Args:
        data: 输入数据
        options: 可选配置
        
    Returns:
        处理后的数据列表
    """
    pass
```

---

## 6. 生产环境要求

### 6.1 代码质量要求

| 要求 | 标准 | 检查方式 |
|------|------|---------|
| **语法正确** | 100% | AST 解析检查 |
| **类型提示** | 推荐 | mypy 检查 |
| **代码覆盖率** | > 80% | pytest-cov |
| **代码风格** | PEP 8 | black, flake8 |
| **文档完整** | 100% | docstring 检查 |

### 6.2 性能要求

| 指标 | 要求 | 说明 |
|------|------|------|
| **API 响应时间** | < 500ms (P95) | 95% 的请求在 500ms 内完成 |
| **热更新延迟** | < 5分钟 | 代码修改后 5 分钟内生效 |
| **内存使用** | < 2GB | 单服务实例内存占用 |
| **CPU 使用** | < 70% | 正常负载下 CPU 使用率 |

### 6.3 可靠性要求

| 要求 | 标准 | 说明 |
|------|------|------|
| **服务可用性** | > 99.9% | 年度可用时间 |
| **错误率** | < 0.1% | 请求错误率 |
| **数据一致性** | 100% | 数据不丢失、不重复 |
| **回滚成功率** | > 99% | 更新失败时回滚成功率 |

### 6.4 安全要求

| 要求 | 标准 | 说明 |
|------|------|------|
| **认证授权** | 必须 | 所有接口需要认证 |
| **输入验证** | 必须 | 使用 Pydantic 验证 |
| **SQL 注入防护** | 必须 | 使用参数化查询 |
| **XSS 防护** | 必须 | 输出转义 |
| **日志脱敏** | 必须 | 敏感信息不记录日志 |

---

## 7. 无重启更新方案

### 7.1 更新策略

#### 策略1：灰度发布（推荐）

```
1. 部署新代码到测试环境
   ↓
2. 验证功能正常
   ↓
3. 部署到生产环境（不重启）
   ↓
4. 监控 10% 流量
   ↓
5. 逐步增加到 50%、100%
   ↓
6. 如果出现问题，立即回滚
```

#### 策略2：蓝绿部署

```
1. 准备新版本代码（绿色环境）
   ↓
2. 保持旧版本运行（蓝色环境）
   ↓
3. 切换流量到绿色环境
   ↓
4. 监控新版本运行情况
   ↓
5. 如果正常，停止蓝色环境
   ↓
6. 如果异常，切换回蓝色环境
```

### 7.2 代码部署流程

#### 步骤1：代码准备

```bash
# 1. 拉取最新代码
git pull origin main

# 2. 运行测试
pytest tests/

# 3. 代码检查
black --check .
flake8 .
mypy .

# 4. 构建版本号
VERSION=$(date +%Y%m%d%H%M%S)
echo $VERSION > .version
```

#### 步骤2：代码部署

```bash
# 1. 备份当前代码
cp -r /opt/HiFate-bazi /opt/HiFate-bazi.backup.$(date +%Y%m%d%H%M%S)

# 2. 部署新代码（不重启服务）
rsync -av --exclude='.git' --exclude='__pycache__' \
  ./ /opt/HiFate-bazi/

# 3. 触发热更新检查（可选，系统会自动检测）
curl -X POST http://localhost:8001/api/v1/hot-reload/check
```

#### 步骤3：验证更新

```bash
# 1. 检查热更新状态
curl http://localhost:8001/api/v1/hot-reload/status

# 2. 检查服务健康
curl http://localhost:8001/health

# 3. 检查版本号
curl http://localhost:8001/api/v1/hot-reload/versions

# 4. 运行冒烟测试
pytest tests/smoke/
```

### 7.3 更新检查清单

#### 更新前检查

- [ ] 代码已通过所有测试
- [ ] 代码已通过代码检查（black, flake8, mypy）
- [ ] 已更新版本号
- [ ] 已更新变更日志
- [ ] 已通知相关人员

#### 更新后检查

- [ ] 热更新状态正常
- [ ] 服务健康检查通过
- [ ] 关键功能测试通过
- [ ] 性能指标正常
- [ ] 错误日志无异常

---

## 8. 回滚机制

### 8.1 自动回滚

#### 触发条件

1. **语法错误**：文件语法检查失败
2. **导入失败**：模块导入时抛出异常
3. **初始化失败**：模块初始化时抛出异常
4. **功能验证失败**：关键函数调用失败

#### 回滚流程

```python
# 回滚逻辑
try:
    # 尝试更新
    new_module = importlib.reload(module)
    # 验证功能
    if not verify_module(new_module):
        raise Exception("功能验证失败")
    # 更新成功
    update_version_cache()
except Exception as e:
    # 回滚到上一版本
    rollback_module(module)
    logger.error(f"更新失败，已回滚: {e}")
```

### 8.2 手动回滚

#### 通过 API 回滚

```bash
# 回滚到上一版本
curl -X POST http://localhost:8001/api/v1/hot-reload/rollback?module_name=source

# 回滚所有模块
curl -X POST http://localhost:8001/api/v1/hot-reload/rollback
```

#### 通过代码回滚

```bash
# 1. 恢复备份代码
cp -r /opt/HiFate-bazi.backup.20250115120000/* /opt/HiFate-bazi/

# 2. 触发热更新
curl -X POST http://localhost:8001/api/v1/hot-reload/check
```

---

## 9. 监控和告警

### 9.1 监控指标

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| **热更新成功率** | 更新成功的比例 | < 95% |
| **热更新延迟** | 从代码修改到生效的时间 | > 10分钟 |
| **语法错误数** | 检测到的语法错误数量 | > 0 |
| **回滚次数** | 回滚操作的次数 | > 5次/小时 |

### 9.2 告警规则

```python
# 告警规则示例
if hot_reload_success_rate < 0.95:
    send_alert("热更新成功率过低", level="warning")

if syntax_error_count > 0:
    send_alert("检测到语法错误", level="critical")

if rollback_count > 5:
    send_alert("回滚次数过多", level="warning")
```

---

## 10. 使用指南

### 10.1 开发人员指南

#### 修改代码

1. **修改代码文件**
2. **保存文件**（文件监控器会在 5 秒内检测到）
3. **等待自动更新**（热更新管理器会在 5 分钟内重载）
4. **验证功能**（检查日志和功能是否正常）

#### 查看更新状态

```bash
# 查看热更新状态
curl http://localhost:8001/api/v1/hot-reload/status

# 查看所有模块版本
curl http://localhost:8001/api/v1/hot-reload/versions

# 手动触发更新
curl -X POST http://localhost:8001/api/v1/hot-reload/check
```

### 10.2 运维人员指南

#### 部署新版本

```bash
# 1. 部署代码（不重启服务）
./scripts/deploy.sh --no-restart

# 2. 监控更新状态
watch -n 5 'curl -s http://localhost:8001/api/v1/hot-reload/status | jq'

# 3. 验证功能
./scripts/smoke_test.sh
```

#### 回滚操作

```bash
# 1. 查看备份列表
ls -la /opt/HiFate-bazi.backup.*

# 2. 选择备份版本
BACKUP_VERSION="20250115120000"

# 3. 恢复备份
cp -r /opt/HiFate-bazi.backup.$BACKUP_VERSION/* /opt/HiFate-bazi/

# 4. 触发热更新
curl -X POST http://localhost:8001/api/v1/hot-reload/check
```

---

## 11. 最佳实践

### 11.1 代码编写

1. **避免全局状态**：使用类或函数封装状态
2. **使用单例模式**：支持热更新的单例实现
3. **依赖注入**：便于测试和热更新
4. **错误处理**：所有函数都要有异常处理
5. **日志记录**：关键操作都要记录日志

### 11.2 更新操作

1. **小步更新**：每次更新尽量小，便于回滚
2. **充分测试**：更新前充分测试
3. **监控告警**：更新后密切监控
4. **准备回滚**：更新前准备回滚方案

### 11.3 生产环境

1. **灰度发布**：先小流量验证
2. **监控告警**：设置完善的监控和告警
3. **文档记录**：记录所有更新操作
4. **应急预案**：准备应急处理方案

---

**文档版本**: v1.0  
**最后更新**: 2025-01-XX  
**维护者**: 开发团队

