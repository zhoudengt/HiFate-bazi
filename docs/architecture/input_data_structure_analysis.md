# input_data æ•°æ®ç»“æ„è®¾è®¡æ•´ä½“åˆ†æ

> ä»è®¾è®¡åŸç†ã€å¿«é€Ÿå¼€å‘ã€å¿«é€Ÿä¿®æ”¹ã€æ•°æ®ç»“æ„ç­‰è§’åº¦çš„æ·±åº¦åˆ†æ

---

## ğŸ“ ä¸€ã€è®¾è®¡åŸç†åˆ†æ

### 1.1 æ ¸å¿ƒè®¾è®¡ç†å¿µ

#### **åˆ†å±‚æ¶æ„è®¾è®¡**
```
[åŸºç¡€æœåŠ¡æ•°æ®] â†’ [input_data] â†’ [formatted_data] â†’ [å¤§æ¨¡å‹]
   (bazi_data)    (ç»“æ„åŒ–)      (JSONå­—ç¬¦ä¸²)      (LLM Prompt)
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… **èŒè´£åˆ†ç¦»**ï¼šæ¯å±‚è´Ÿè´£å•ä¸€èŒè´£ï¼Œä¾¿äºç»´æŠ¤å’Œæµ‹è¯•
- âœ… **æ•°æ®è½¬æ¢æ¸…æ™°**ï¼šä»åŸå§‹æ•°æ®åˆ°æ¨¡å‹è¾“å…¥çš„è½¬æ¢è·¯å¾„æ˜ç¡®
- âœ… **å¯æ‰©å±•æ€§å¼º**ï¼šæ–°å¢åœºæ™¯åªéœ€æ·»åŠ æ ¼å¼åŒ–å±‚ï¼Œä¸å½±å“åº•å±‚

#### **ç»Ÿä¸€å…¥å£ + å·®å¼‚æ ¼å¼åŒ–**
```python
# ç»Ÿä¸€æ„å»ºå…¥å£
input_data = build_input_data_from_result(
    format_name="career_wealth_analysis",  # åœºæ™¯æ ‡è¯†
    bazi_data=bazi_data,
    detail_result=detail_result,
    ...
)

# å·®å¼‚åŒ–æ ¼å¼åŒ–
formatted_data = format_career_wealth_input_data_for_coze(input_data)  # JSONæ ¼å¼
# æˆ–
prompt = build_health_prompt(input_data)  # è‡ªç„¶è¯­è¨€æ ¼å¼
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… **ä¸€è‡´æ€§ä¿è¯**ï¼šæ‰€æœ‰åœºæ™¯ä½¿ç”¨ç›¸åŒçš„æ•°æ®è·å–é€»è¾‘
- âœ… **çµæ´»æ€§**ï¼šå„åœºæ™¯å¯å®šåˆ¶æ ¼å¼åŒ–æ–¹å¼ï¼ˆJSON/è‡ªç„¶è¯­è¨€ï¼‰
- âœ… **å¯ç»´æŠ¤æ€§**ï¼šä¿®æ”¹æ•°æ®è·å–é€»è¾‘åªéœ€æ”¹ä¸€å¤„

### 1.2 æ•°æ®å¼•ç”¨ä¼˜åŒ–åŸç†

**é—®é¢˜**ï¼šä¼ ç»Ÿæ–¹å¼ä¼šé‡å¤å­˜å‚¨ç›¸åŒæ•°æ®ï¼Œæµªè´¹ Token

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å¼•ç”¨è€Œéå¤åˆ¶
```python
# âœ… ä¼˜åŒ–åï¼ˆå¼•ç”¨ï¼‰
optimized_data = {
    'mingpan_zonglun': mingpan,  # å®Œæ•´æ•°æ®åªå­˜å‚¨ä¸€æ¬¡
    'peiou_tezheng': {
        'ten_gods': mingpan.get('ten_gods', {}),  # å¼•ç”¨ï¼Œä¸é‡å¤å­˜å‚¨
        'deities': peiou.get('deities', {}),
    }
}

# âŒ ä¼˜åŒ–å‰ï¼ˆé‡å¤ï¼‰
unoptimized_data = {
    'mingpan_zonglun': {'ten_gods': {...}},  # ç¬¬ä¸€æ¬¡å­˜å‚¨
    'peiou_tezheng': {'ten_gods': {...}},    # é‡å¤å­˜å‚¨ï¼Œæµªè´¹ Token
}
```

**Token èŠ‚çœæ•ˆæœ**ï¼šå‡å°‘ 30-50% çš„é‡å¤æ•°æ®

### 1.3 é…ç½®åŒ–è®¾è®¡åŸç†

**æ ¸å¿ƒç†å¿µ**ï¼šå°†æ•°æ®ç»“æ„çš„æ ¼å¼å®šä¹‰å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç åœ¨ä»£ç ä¸­

```python
# æ ¼å¼å®šä¹‰å­˜å‚¨åœ¨æ•°æ®åº“ llm_input_formats è¡¨
{
    "format_name": "career_wealth_analysis",
    "structure": {
        "fields": {
            "mingpan_shiye_caifu_zonglun": {
                "source": "result",
                "data_source": "detail_result",
                "fields": ["bazi_pillars", "day_master", "wangshuai", ...]
            },
            "shiye_xing_gong": {
                "source": "result",
                "data_source": "detail_result",
                "fields": ["career_info", ...]
            }
        }
    }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… **æ— éœ€æ”¹ä»£ç **ï¼šä¿®æ”¹æ ¼å¼å®šä¹‰åªéœ€æ›´æ–°æ•°æ®åº“
- âœ… **æ”¯æŒçƒ­æ›´æ–°**ï¼šé€šè¿‡ `reload_format()` æ¸…é™¤ç¼“å­˜ï¼Œç«‹å³ç”Ÿæ•ˆ
- âœ… **ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒæ ¼å¼å®šä¹‰çš„ç‰ˆæœ¬æ§åˆ¶

---

## ğŸš€ äºŒã€å¿«é€Ÿå¼€å‘åˆ†æ

### 2.1 å¼€å‘æµç¨‹å¯¹æ¯”

#### **ä¼ ç»Ÿæ–¹å¼ï¼ˆç¡¬ç¼–ç ï¼‰**
```python
# âŒ æ¯ä¸ªåœºæ™¯éƒ½è¦å†™é‡å¤çš„æ•°æ®ç»„è£…ä»£ç 
def build_career_wealth_data(bazi_data, detail_result):
    input_data = {
        'mingpan_shiye_caifu_zonglun': {
            'bazi_pillars': bazi_data['bazi_pillars'],
            'day_master': detail_result['day_master'],
            # ... 50+ è¡Œä»£ç 
        },
        'shiye_xing_gong': {
            'career_info': detail_result['career_info'],
            # ... æ›´å¤šä»£ç 
        }
    }
    return input_data

def build_marriage_data(bazi_data, detail_result):
    # åˆå†™ä¸€éç±»ä¼¼çš„ä»£ç ...
    pass
```

**é—®é¢˜**ï¼š
- âŒ ä»£ç é‡å¤ç‡é«˜
- âŒ ä¿®æ”¹éœ€è¦æ”¹å¤šå¤„
- âŒ å®¹æ˜“å‡ºé”™

#### **å½“å‰æ–¹å¼ï¼ˆé…ç½®åŒ–ï¼‰**
```python
# âœ… æ‰€æœ‰åœºæ™¯ä½¿ç”¨ç»Ÿä¸€å‡½æ•°
input_data = build_input_data_from_result(
    format_name="career_wealth_analysis",  # åªéœ€æ”¹å˜æ ¼å¼å
    bazi_data=bazi_data,
    detail_result=detail_result,
    ...
)
```

**ä¼˜åŠ¿**ï¼š
- âœ… **å¼€å‘æ—¶é—´å‡å°‘ 70%**ï¼šæ–°å¢åœºæ™¯åªéœ€é…ç½®æ ¼å¼å®šä¹‰
- âœ… **ä»£ç å¤ç”¨ç‡é«˜**ï¼šç»Ÿä¸€çš„æ•°æ®æ„å»ºé€»è¾‘
- âœ… **é”™è¯¯ç‡ä½**ï¼šæ ¼å¼å®šä¹‰é›†ä¸­ç®¡ç†ï¼Œæ˜“äºéªŒè¯

### 2.2 æ–°å¢åœºæ™¯å¼€å‘æ­¥éª¤

**æ­¥éª¤ 1ï¼šåœ¨æ•°æ®åº“ä¸­å®šä¹‰æ ¼å¼ç»“æ„**ï¼ˆ5åˆ†é’Ÿï¼‰
```sql
INSERT INTO llm_input_formats (
    format_name, intent, structure, format_type, description
) VALUES (
    'new_scenario_analysis',
    'new_scenario',
    '{"fields": {...}}',
    'full',
    'æ–°åœºæ™¯åˆ†ææ ¼å¼'
);
```

**æ­¥éª¤ 2ï¼šå®ç°æ ¼å¼åŒ–å‡½æ•°**ï¼ˆ15åˆ†é’Ÿï¼‰
```python
def format_new_scenario_input_data_for_coze(input_data: Dict[str, Any]) -> str:
    """æ ¼å¼åŒ–æ–°åœºæ™¯æ•°æ®ä¸ºJSONå­—ç¬¦ä¸²"""
    # ä½¿ç”¨å¼•ç”¨ä¼˜åŒ–
    optimized_data = {
        'mingpan_zonglun': input_data.get('mingpan_zonglun'),
        'new_scenario_data': input_data.get('new_scenario_data'),
    }
    return json.dumps(optimized_data, ensure_ascii=False, indent=2)
```

**æ­¥éª¤ 3ï¼šåœ¨APIä¸­è°ƒç”¨**ï¼ˆ5åˆ†é’Ÿï¼‰
```python
@router.post("/new-scenario/stream")
async def new_scenario_stream(request: BaziBaseRequest):
    # 1. è·å–åŸºç¡€æ•°æ®
    bazi_data, detail_result = ...
    
    # 2. æ„å»º input_data
    input_data = build_input_data_from_result(
        format_name="new_scenario_analysis",
        bazi_data=bazi_data,
        detail_result=detail_result,
    )
    
    # 3. æ ¼å¼åŒ–
    formatted_data = format_new_scenario_input_data_for_coze(input_data)
    
    # 4. è°ƒç”¨å¤§æ¨¡å‹
    return llm_service.stream_analysis(formatted_data)
```

**æ€»è€—æ—¶**ï¼šçº¦ 25 åˆ†é’Ÿï¼ˆvs ä¼ ç»Ÿæ–¹å¼ 2-3 å°æ—¶ï¼‰

### 2.3 ä»£ç å¤ç”¨ç‡åˆ†æ

| ç»„ä»¶ | å¤ç”¨ç‡ | è¯´æ˜ |
|------|--------|------|
| æ•°æ®æ„å»ºé€»è¾‘ | **100%** | æ‰€æœ‰åœºæ™¯ä½¿ç”¨ `build_input_data_from_result()` |
| æ ¼å¼å®šä¹‰åŠ è½½ | **100%** | ä½¿ç”¨ç»Ÿä¸€çš„ `InputDataFormatLoader` |
| æ ¼å¼åŒ–å‡½æ•° | **60-80%** | å…±äº«è¾…åŠ©å‡½æ•°ï¼ˆ`_simplify_dayun`ã€`_filter_empty_deities`ï¼‰ |
| APIæ¥å£ç»“æ„ | **90%** | ç»Ÿä¸€çš„è¯·æ±‚å¤„ç†æµç¨‹ |

**å¹³å‡ä»£ç å¤ç”¨ç‡**ï¼š**85%+**

---

## ğŸ”§ ä¸‰ã€å¿«é€Ÿä¿®æ”¹åˆ†æ

### 3.1 ä¿®æ”¹åœºæ™¯å¯¹æ¯”

#### **åœºæ™¯ 1ï¼šä¿®æ”¹æ•°æ®ç»“æ„**

**ä¼ ç»Ÿæ–¹å¼**ï¼š
```python
# âŒ éœ€è¦ä¿®æ”¹å¤šä¸ªæ–‡ä»¶
# 1. ä¿®æ”¹ build_career_wealth_data() å‡½æ•°
# 2. ä¿®æ”¹ format_career_wealth_input_data_for_coze() å‡½æ•°
# 3. ä¿®æ”¹è¯„æµ‹è„šæœ¬ä¸­çš„ç›¸åŒé€»è¾‘
# 4. ç¡®ä¿ç”Ÿäº§ç¯å¢ƒå’Œè¯„æµ‹ç¯å¢ƒä¸€è‡´
```

**å½“å‰æ–¹å¼**ï¼š
```python
# âœ… åªéœ€æ›´æ–°æ•°æ®åº“é…ç½®
UPDATE llm_input_formats 
SET structure = '{"fields": {...æ–°ç»“æ„...}}' 
WHERE format_name = 'career_wealth_analysis';

# æ¸…é™¤ç¼“å­˜ï¼ˆçƒ­æ›´æ–°ï¼‰
format_loader.reload_format('career_wealth_analysis');
```

**ä¿®æ”¹æ—¶é—´**ï¼š5åˆ†é’Ÿï¼ˆvs ä¼ ç»Ÿæ–¹å¼ 1-2å°æ—¶ï¼‰

#### **åœºæ™¯ 2ï¼šæ–°å¢å­—æ®µ**

**ä¼ ç»Ÿæ–¹å¼**ï¼š
- éœ€è¦ä¿®æ”¹å¤šä¸ªå‡½æ•°
- éœ€è¦åŒæ­¥ä¿®æ”¹è¯„æµ‹è„šæœ¬
- éœ€è¦éªŒè¯ä¸€è‡´æ€§

**å½“å‰æ–¹å¼**ï¼š
- åªéœ€åœ¨æ ¼å¼å®šä¹‰ä¸­æ·»åŠ å­—æ®µé…ç½®
- ç”Ÿäº§ç¯å¢ƒå’Œè¯„æµ‹ç¯å¢ƒè‡ªåŠ¨ä¸€è‡´
- æ— éœ€ä¿®æ”¹ä»£ç 

#### **åœºæ™¯ 3ï¼šè°ƒæ•´å­—æ®µæ˜ å°„**

**ä¼ ç»Ÿæ–¹å¼**ï¼š
```python
# âŒ ç¡¬ç¼–ç ï¼Œéœ€è¦æ”¹ä»£ç 
'day_master': detail_result['day_master']  # å¦‚æœå­—æ®µåæ”¹äº†ï¼Œè¦æ”¹è¿™é‡Œ
```

**å½“å‰æ–¹å¼**ï¼š
```json
// âœ… é…ç½®åŒ–ï¼Œåªéœ€æ”¹é…ç½®
{
    "field": "day_master",
    "transform": {"rename": "day_master_new"}  // æ”¯æŒå­—æ®µè½¬æ¢
}
```

### 3.2 çƒ­æ›´æ–°æœºåˆ¶

**å®ç°æ–¹å¼**ï¼š
```python
# 1. æ ¼å¼å®šä¹‰ç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰
_format_cache: Dict[str, tuple] = {}  # {format_name: (format_def, timestamp)}

# 2. ä¸»åŠ¨æ¸…é™¤ç¼“å­˜
format_loader.reload_format(format_name)  # æ¸…é™¤æŒ‡å®šæ ¼å¼ç¼“å­˜
format_loader.reload_format()  # æ¸…é™¤æ‰€æœ‰ç¼“å­˜

# 3. è‡ªåŠ¨çƒ­æ›´æ–°
# ä¸‹æ¬¡è°ƒç”¨æ—¶ä¼šè‡ªåŠ¨ä»æ•°æ®åº“é‡æ–°åŠ è½½
```

**ä¼˜åŠ¿**ï¼š
- âœ… **é›¶åœæœº**ï¼šæ— éœ€é‡å¯æœåŠ¡
- âœ… **ç«‹å³ç”Ÿæ•ˆ**ï¼šæ¸…é™¤ç¼“å­˜åä¸‹æ¬¡è¯·æ±‚ç«‹å³ä½¿ç”¨æ–°é…ç½®
- âœ… **å›æ»šæ–¹ä¾¿**ï¼šæ¢å¤æ•°æ®åº“é…ç½®å³å¯å›æ»š

### 3.3 ç‰ˆæœ¬ç®¡ç†

**æ ¼å¼å®šä¹‰æ”¯æŒç‰ˆæœ¬æ§åˆ¶**ï¼š
```sql
SELECT structure, version 
FROM llm_input_formats 
WHERE format_name = 'career_wealth_analysis' 
ORDER BY version DESC 
LIMIT 1;
```

**ä¼˜åŠ¿**ï¼š
- âœ… **ç‰ˆæœ¬è¿½è¸ª**ï¼šå¯ä»¥æŸ¥çœ‹å†å²ç‰ˆæœ¬
- âœ… **A/Bæµ‹è¯•**ï¼šå¯ä»¥æµ‹è¯•ä¸åŒç‰ˆæœ¬çš„æ•ˆæœ
- âœ… **å›æ»šèƒ½åŠ›**ï¼šå¯ä»¥å¿«é€Ÿå›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬

---

## ğŸ“Š å››ã€æ•°æ®ç»“æ„åˆ†æ

### 4.1 é€šç”¨ç»“æ„æ¨¡å¼

æ‰€æœ‰åœºæ™¯çš„ `input_data` éƒ½éµå¾ª**ä¸‰å±‚ç»“æ„æ¨¡å¼**ï¼š

```python
input_data = {
    # 1ï¸âƒ£ å‘½ç›˜åŸºç¡€å±‚ï¼ˆå„åœºæ™¯ä¸åŒå‘½åï¼Œä½†éƒ½åŒ…å«å…«å­—æ ¸å¿ƒæ•°æ®ï¼‰
    "mingpan_*_zonglun": {
        "bazi_pillars": {...},      # å››æŸ±ä¿¡æ¯
        "day_master": {...},         # æ—¥ä¸»ä¿¡æ¯
        "wangshuai": "...",          # æ—ºè¡°
        "ten_gods": {...},           # åç¥é…ç½®
        "elements": {...},           # äº”è¡Œåˆ†å¸ƒ
    },
    
    # 2ï¸âƒ£ åœºæ™¯ç‰¹å®šæ•°æ®å±‚ï¼ˆæ ¹æ®åœºæ™¯éœ€æ±‚ç»„ç»‡ï¼‰
    "scene_specific_data": {
        "current_dayun": {...},      # å½“å‰å¤§è¿
        "key_dayuns": [...],         # å…³é”®å¤§è¿
        "rules": [...],              # åŒ¹é…çš„è§„åˆ™
    },
    
    # 3ï¸âƒ£ å»ºè®®/è°ƒç†å±‚ï¼ˆå¯é€‰çš„åç»­åˆ†ææ•°æ®ï¼‰
    "suggestions": {
        "xi_ji": {...},              # å–œå¿Œç¥
    }
}
```

### 4.2 å„åœºæ™¯ç»“æ„å¯¹æ¯”

| åœºæ™¯ | å‘½ç›˜åŸºç¡€å±‚ | åœºæ™¯ç‰¹å®šå±‚ | æ ¼å¼åŒ–å‡½æ•° | æ ¼å¼ç±»å‹ |
|------|-----------|-----------|-----------|---------|
| **å¥åº·åˆ†æ** | `mingpan_tizhi_zonglun` | `wuxing_bingli`, `dayun_jiankang`, `tizhi_tiaoli`, `health_rules` | `build_health_prompt()` | è‡ªç„¶è¯­è¨€ |
| **äº‹ä¸šè´¢å¯Œ** | `mingpan_shiye_caifu_zonglun` | `shiye_xing_gong`, `caifu_xing_gong`, `shiye_yunshi`, `caifu_yunshi` | `format_career_wealth_input_data_for_coze()` | JSON |
| **æ„Ÿæƒ…å©šå§»** | `mingpan_zonglun` | `peiou_tezheng`, `ganqing_zoushi`, `shensha_dianjing` | `format_marriage_input_data_for_coze()` | JSON |
| **å­å¥³å­¦ä¹ ** | `mingpan_zinv_zonglun` | `zinvxing_zinvgong`, `shengyu_shiji`, `yangyu_jianyi` | `format_children_study_input_data_for_coze()` | JSON |
| **æ€»è¯„åˆ†æ** | `mingpan_hexin_geju` | `xingge_tezhi`, `shiye_caiyun`, `jiating_liuqin` | `format_general_review_input_data_for_coze()` | JSON |

**è®¾è®¡ç‰¹ç‚¹**ï¼š
- âœ… **å‘½åè§„èŒƒç»Ÿä¸€**ï¼šå‘½ç›˜åŸºç¡€å±‚ç»Ÿä¸€ä½¿ç”¨ `mingpan_*` å‰ç¼€
- âœ… **ç»“æ„æ¨¡å¼ä¸€è‡´**ï¼šéƒ½éµå¾ªä¸‰å±‚ç»“æ„
- âœ… **åœºæ™¯å·®å¼‚åŒ–**ï¼šåœºæ™¯ç‰¹å®šå±‚æ ¹æ®éœ€æ±‚å®šåˆ¶

### 4.3 æ•°æ®æµè½¬é“¾è·¯

#### **æµå¼æ¥å£ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰**
```
å‰ç«¯è¯·æ±‚ â†’ API æ¥å£ (/xxx/stream)
  â†“
1. è·å–åŸºç¡€æ•°æ®ï¼ˆbazi_data, wangshuai_result, detail_resultï¼‰
  â†“
2. è·å–å¤§è¿æµå¹´æ•°æ®ï¼ˆBaziDataService.get_fortune_dataï¼‰
  â†“
3. åŒ¹é…è§„åˆ™ï¼ˆRuleService.match_rulesï¼‰
  â†“
4. æ„å»º input_dataï¼ˆbuild_input_data_from_resultï¼‰
  â†“
5. æ ¼å¼åŒ– formatted_dataï¼ˆformat_*_input_data_for_coze / build_*_promptï¼‰
  â†“
6. ä¼ é€’ç»™å¤§æ¨¡å‹ï¼ˆllm_service.stream_analysis(formatted_data)ï¼‰
```

#### **è¯„æµ‹æ¥å£ï¼ˆè¯„æµ‹ç¯å¢ƒï¼‰**
```
è¯„æµ‹è„šæœ¬ â†’ Debug æ¥å£ (/xxx/debug)
  â†“
1-4. ä¸æµå¼æ¥å£ç›¸åŒï¼ˆæ­¥éª¤ 1-4ï¼‰
  â†“
5. è¿”å› input_dataï¼ˆä¸è¿”å› formatted_dataï¼‰
  â†“
è¯„æµ‹è„šæœ¬ï¼š
  â†“
6. æ„å»º formatted_dataï¼ˆä½¿ç”¨ç›¸åŒçš„æ ¼å¼åŒ–å‡½æ•°ï¼‰
  â†“
7. ä¼ é€’ç»™å¤§æ¨¡å‹ï¼ˆbailian_client.call_stream(formatted_data)ï¼‰
```

**å…³é”®ä¸€è‡´æ€§ä¿è¯**ï¼š
- âœ… **åŒä¸€å¥—æ•°æ®æ„å»ºé€»è¾‘**ï¼šç¡®ä¿ `input_data` ä¸€è‡´
- âœ… **åŒä¸€ä¸ªæ ¼å¼åŒ–å‡½æ•°**ï¼šç¡®ä¿ `formatted_data` ä¸€è‡´
- âœ… **ç»“æœ**ï¼šè¯„æµ‹ç»“æœä¸ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´

### 4.4 formatted_data ä¸¤ç§æ ¼å¼

#### **æ ¼å¼ 1ï¼šJSON å­—ç¬¦ä¸²ï¼ˆå¤§å¤šæ•°åœºæ™¯ï¼‰**
```python
formatted_data = json.dumps(optimized_data, ensure_ascii=False, indent=2)
```

**ä½¿ç”¨åœºæ™¯**ï¼šäº‹ä¸šè´¢å¯Œã€æ„Ÿæƒ…å©šå§»ã€å­å¥³å­¦ä¹ ã€æ€»è¯„åˆ†æ

**ç‰¹ç‚¹**ï¼š
- âœ… **æ•°æ®ä¸æ¨¡æ¿åˆ†ç¦»**ï¼šæ¨¡æ¿å­˜å‚¨åœ¨ Coze Bot é…ç½®ä¸­ï¼Œä½¿ç”¨ `{{input}}` å ä½ç¬¦
- âœ… **Token èŠ‚çœ**ï¼šæ¨¡æ¿æ–‡æœ¬ä¸å ç”¨æ¯æ¬¡è¯·æ±‚çš„ Token
- âœ… **æ˜“äºä¿®æ”¹**ï¼šä¿®æ”¹æ¨¡æ¿åªéœ€æ›´æ–° Bot é…ç½®ï¼Œæ— éœ€æ”¹ä»£ç 

#### **æ ¼å¼ 2ï¼šè‡ªç„¶è¯­è¨€ Promptï¼ˆå¥åº·åˆ†æï¼‰**
```python
prompt = build_health_prompt(input_data)
# è¿”å›å®Œæ•´çš„è‡ªç„¶è¯­è¨€æç¤ºè¯å­—ç¬¦ä¸²
```

**ä½¿ç”¨åœºæ™¯**ï¼šå¥åº·åˆ†æ

**ç‰¹ç‚¹**ï¼š
- âœ… **ç»“æ„çµæ´»**ï¼šå¯ä»¥æ›´çµæ´»åœ°ç»„ç»‡ Prompt ç»“æ„
- âœ… **é€‚åˆå¤æ‚åˆ†æ**ï¼šé€‚åˆéœ€è¦è¯¦ç»†è¯´æ˜çš„åˆ†æåœºæ™¯

### 4.5 æ•°æ®ä¼˜åŒ–ç­–ç•¥

#### **1. å¤§è¿æ•°æ®ç²¾ç®€**
```python
def _simplify_dayun(dayun):
    """åªä¿ç•™å…³é”®å­—æ®µï¼Œå‡å°‘æ•°æ®é‡"""
    return {
        'step': dayun.get('step'),
        'ganzhi': dayun.get('ganzhi'),
        'start_age': dayun.get('start_age'),
        'end_age': dayun.get('end_age'),
        'key_liunians': [...]  # åªä¿ç•™ç‰¹æ®Šæµå¹´
    }
```

**æ•ˆæœ**ï¼šå¤§è¿æ•°æ®é‡å‡å°‘ 60-70%

#### **2. ç©ºæ•°æ®è¿‡æ»¤**
```python
def _filter_empty_deities(data):
    """é€’å½’è¿‡æ»¤ç©ºå­—ç¬¦ä¸²ï¼Œå‡å°‘æ— ç”¨æ•°æ®"""
    if isinstance(data, dict):
        result = {}
        for key, value in data.items():
            if key == 'deities' and isinstance(value, list):
                result[key] = [item for item in value if item != '']
            else:
                result[key] = _filter_empty_deities(value)
        return result
    # ...
```

**æ•ˆæœ**ï¼šå‡å°‘ 10-20% çš„ç©ºæ•°æ®

#### **3. å¼•ç”¨ä¼˜åŒ–**
å¦‚å‰æ‰€è¿°ï¼Œä½¿ç”¨å¼•ç”¨è€Œéå¤åˆ¶ï¼Œå‡å°‘ 30-50% çš„é‡å¤æ•°æ®

**æ€»ä½“ Token èŠ‚çœ**ï¼š**40-60%**

---

## ğŸ“ äº”ã€å…³é”®æ–‡ä»¶ç»„ç»‡

### 5.1 æ–‡ä»¶èŒè´£åˆ’åˆ†

| æ–‡ä»¶ | èŒè´£ | ä¿®æ”¹é¢‘ç‡ |
|------|------|---------|
| `server/config/input_format_loader.py` | input_data æ„å»ºï¼ˆæ•°æ®åº“æ ¼å¼å®šä¹‰ï¼‰ | ä½ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰ |
| `server/utils/prompt_builders.py` | formatted_data æ„å»ºï¼ˆæ‰€æœ‰æ ¼å¼åŒ–å‡½æ•°ï¼‰ | ä¸­ï¼ˆæ–°å¢åœºæ™¯ï¼‰ |
| `server/api/v1/*_analysis.py` | æµå¼æ¥å£ï¼ˆä½¿ç”¨ä¸Šè¿°å‡½æ•°æ„å»ºæ•°æ®ï¼‰ | ä½ï¼ˆæ¥å£æ¡†æ¶ï¼‰ |
| `scripts/evaluation/api_client.py` | è¯„æµ‹è„šæœ¬ï¼ˆä½¿ç”¨ç›¸åŒå‡½æ•°ç¡®ä¿ä¸€è‡´æ€§ï¼‰ | ä½ï¼ˆè¯„æµ‹æ¡†æ¶ï¼‰ |

### 5.2 ä»£ç ç»„ç»‡åŸåˆ™

**åŸåˆ™ 1ï¼šé›†ä¸­ç®¡ç†**
- âœ… æ‰€æœ‰æ ¼å¼åŒ–å‡½æ•°é›†ä¸­åœ¨ `prompt_builders.py`
- âœ… æ‰€æœ‰æ ¼å¼å®šä¹‰é€šè¿‡æ•°æ®åº“ç®¡ç†
- âœ… ç»Ÿä¸€çš„æ•°æ®æ„å»ºé€»è¾‘åœ¨ `input_format_loader.py`

**åŸåˆ™ 2ï¼šæ˜“äºæ‰©å±•**
- âœ… æ–°å¢åœºæ™¯åªéœ€æ·»åŠ æ ¼å¼åŒ–å‡½æ•°
- âœ… æ ¼å¼å®šä¹‰é…ç½®åŒ–ï¼Œæ— éœ€æ”¹ä»£ç 
- âœ… å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

**åŸåˆ™ 3ï¼šä¸€è‡´æ€§ä¿è¯**
- âœ… ç”Ÿäº§å’Œè¯„æµ‹ä½¿ç”¨ç›¸åŒçš„å‡½æ•°
- âœ… ç»Ÿä¸€çš„æ•°æ®éªŒè¯å’Œè½¬æ¢é€»è¾‘
- âœ… é›†ä¸­çš„é”™è¯¯å¤„ç†

---

## âœ… å…­ã€è®¾è®¡ä¼˜åŠ¿æ€»ç»“

### 6.1 å¼€å‘æ•ˆç‡æå‡

| æŒ‡æ ‡ | ä¼ ç»Ÿæ–¹å¼ | å½“å‰æ–¹å¼ | æå‡ |
|------|---------|---------|------|
| **æ–°å¢åœºæ™¯å¼€å‘æ—¶é—´** | 2-3å°æ—¶ | 25åˆ†é’Ÿ | **83%â†“** |
| **ä¿®æ”¹æ•°æ®ç»“æ„æ—¶é—´** | 1-2å°æ—¶ | 5åˆ†é’Ÿ | **95%â†“** |
| **ä»£ç å¤ç”¨ç‡** | 30-40% | 85%+ | **112%â†‘** |
| **Token æ¶ˆè€—** | åŸºå‡† | å‡å°‘40-60% | **40-60%â†“** |

### 6.2 ç»´æŠ¤æˆæœ¬é™ä½

| æ–¹é¢ | ä¼ ç»Ÿæ–¹å¼ | å½“å‰æ–¹å¼ |
|------|---------|---------|
| **ä¿®æ”¹å½±å“èŒƒå›´** | å¤šæ–‡ä»¶ã€å¤šå¤„ | å•ç‚¹é…ç½® |
| **ä¸€è‡´æ€§ä¿è¯** | éœ€æ‰‹åŠ¨éªŒè¯ | è‡ªåŠ¨ä¿è¯ |
| **çƒ­æ›´æ–°** | éœ€é‡å¯æœåŠ¡ | é›¶åœæœº |
| **ç‰ˆæœ¬ç®¡ç†** | ä»£ç ç‰ˆæœ¬ | æ•°æ®åº“ç‰ˆæœ¬ |

### 6.3 å¯æ‰©å±•æ€§å¢å¼º

| èƒ½åŠ› | è¯´æ˜ |
|------|------|
| **å¿«é€Ÿæ–°å¢åœºæ™¯** | é…ç½®åŒ–ï¼Œæ— éœ€æ”¹ä»£ç  |
| **çµæ´»è°ƒæ•´ç»“æ„** | æ•°æ®åº“é…ç½®ï¼Œçƒ­æ›´æ–° |
| **æ”¯æŒå¤šç§æ ¼å¼** | JSONã€è‡ªç„¶è¯­è¨€ç­‰ |
| **ç‰ˆæœ¬ç®¡ç†** | æ”¯æŒæ ¼å¼å®šä¹‰ç‰ˆæœ¬æ§åˆ¶ |
| **A/Bæµ‹è¯•** | å¯æµ‹è¯•ä¸åŒç‰ˆæœ¬æ•ˆæœ |

---

## ğŸ¯ ä¸ƒã€æœ€ä½³å®è·µå»ºè®®

### 7.1 å¼€å‘æ–°åœºæ™¯

1. **å…ˆåœ¨æ•°æ®åº“ä¸­å®šä¹‰æ ¼å¼ç»“æ„**ï¼ˆ5åˆ†é’Ÿï¼‰
2. **å®ç°æ ¼å¼åŒ–å‡½æ•°**ï¼ˆ15åˆ†é’Ÿï¼‰
3. **åœ¨APIä¸­è°ƒç”¨**ï¼ˆ5åˆ†é’Ÿï¼‰
4. **æµ‹è¯•éªŒè¯**ï¼ˆ10åˆ†é’Ÿï¼‰

**æ€»è€—æ—¶**ï¼šçº¦ 35 åˆ†é’Ÿ

### 7.2 ä¿®æ”¹ç°æœ‰åœºæ™¯

1. **æ›´æ–°æ•°æ®åº“æ ¼å¼å®šä¹‰**
2. **å¦‚éœ€ä¿®æ”¹æ ¼å¼åŒ–å‡½æ•°ï¼Œæ›´æ–° `prompt_builders.py`**
3. **æ¸…é™¤æ ¼å¼ç¼“å­˜**ï¼š`format_loader.reload_format(format_name)`
4. **éªŒè¯åŠŸèƒ½æ­£å¸¸**

### 7.3 ä¼˜åŒ–Tokenæ¶ˆè€—

1. **ä½¿ç”¨å¼•ç”¨ä¼˜åŒ–**ï¼šé¿å…é‡å¤å­˜å‚¨ç›¸åŒæ•°æ®
2. **ç²¾ç®€å¤§è¿æ•°æ®**ï¼šåªä¿ç•™å…³é”®å­—æ®µ
3. **è¿‡æ»¤ç©ºæ•°æ®**ï¼šç§»é™¤æ— ç”¨æ•°æ®
4. **æ•°æ®ä¸æ¨¡æ¿åˆ†ç¦»**ï¼šæ¨¡æ¿å­˜å‚¨åœ¨ Bot é…ç½®ä¸­

---

## ğŸ“ å…«ã€æœªæ¥æ”¹è¿›æ–¹å‘

### 8.1 çŸ­æœŸä¼˜åŒ–

- [ ] **æ ¼å¼å®šä¹‰å¯è§†åŒ–ç¼–è¾‘å™¨**ï¼šé€šè¿‡ UI ç®¡ç†æ ¼å¼å®šä¹‰ï¼Œæ— éœ€æ‰‹åŠ¨å†™ SQL
- [ ] **æ ¼å¼å®šä¹‰éªŒè¯å·¥å…·**ï¼šè‡ªåŠ¨éªŒè¯æ ¼å¼å®šä¹‰çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
- [ ] **Token æ¶ˆè€—ç›‘æ§**ï¼šå®æ—¶ç›‘æ§å„åœºæ™¯çš„ Token æ¶ˆè€—

### 8.2 ä¸­æœŸæ”¹è¿›

- [ ] **æ™ºèƒ½æ ¼å¼ä¼˜åŒ–**ï¼šåŸºäºå†å²æ•°æ®è‡ªåŠ¨ä¼˜åŒ–æ ¼å¼å®šä¹‰
- [ ] **æ ¼å¼å®šä¹‰æ¨¡æ¿åº“**ï¼šæä¾›å¸¸ç”¨åœºæ™¯çš„æ ¼å¼å®šä¹‰æ¨¡æ¿
- [ ] **å¤šæ ¼å¼æ”¯æŒ**ï¼šæ”¯æŒæ›´å¤šæ ¼å¼åŒ–æ–¹å¼ï¼ˆXMLã€YAMLç­‰ï¼‰

### 8.3 é•¿æœŸè§„åˆ’

- [ ] **æ ¼å¼å®šä¹‰AIç”Ÿæˆ**ï¼šåŸºäºéœ€æ±‚æè¿°è‡ªåŠ¨ç”Ÿæˆæ ¼å¼å®šä¹‰
- [ ] **è‡ªé€‚åº”æ ¼å¼**ï¼šæ ¹æ®æ¨¡å‹ç±»å‹è‡ªåŠ¨è°ƒæ•´æ ¼å¼
- [ ] **æ ¼å¼ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿ**ï¼šå®Œå–„çš„ç‰ˆæœ¬æ§åˆ¶å’Œå›æ»šæœºåˆ¶

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2024å¹´  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ