# 胎神功能实现说明

## 实现概述

在万年历接口中添加了胎神功能，支持获取胎神方位和解释文本。

## 实现位置

**主要文件**：`server/services/calendar_api_service.py`

## 功能特性

1. **自动检测库支持**：优先尝试使用 `lunar_python` 库的胎神方法
2. **备用计算方案**：如果库不支持，使用基于日支的备用计算方案
3. **自动生成解释**：根据胎神方位自动生成解释文本
4. **兼容第三方API**：支持从第三方API（jisuapi、tianapi、6api）提取胎神信息

## 返回格式

### 胎神字段

在 `deities` 字典中包含两个新字段：

```json
{
  "deities": {
    "xishen": "正南",
    "caishen": "正东",
    "fushen": "正南",
    "yanggui": "东北",
    "yingui": "西南",
    "taishen": "占门厕外正东",  // 新增：胎神方位
    "taishen_explanation": "本日胎神在门、厕之外的正东方位，在这些方位不可随意敲打、动刀剪或移动物件，以免对孕妇和胎儿不利。"  // 新增：胎神解释
  }
}
```

### 胎神格式示例

- `占门厕外正东` - 胎神在门和厕所之外的正东方位
- `占碓磨门外正北` - 胎神在碓磨门外的正北方位
- `占房床外西南` - 胎神在房床之外的西南方位

### 解释文本格式

解释文本会根据胎神描述自动生成，包含：
- 位置信息（门、厕、床等）
- 方位信息（正东、正西、正南、正北、东北、东南、西北、西南）
- 注意事项说明

## 实现方法

### 1. `_get_taishen_from_lunar()`

尝试从 `lunar_python` 库获取胎神，支持多种可能的方法名：
- `getDayPositionTaiShenDesc()`（最可能）
- `getPositionTaiShen()`
- `getDayTaiShen()`
- `getTaiShen()`
- `getDayPositionTaiShen()`
- `getTaiShenDesc()`

如果库不支持，自动回退到备用计算方案。

### 2. `_calculate_taishen_fallback()`

备用计算方案，根据日支计算胎神方位：

| 日支 | 胎神方位 |
|------|---------|
| 子 | 占碓磨门外正北 |
| 丑 | 占厕外东北 |
| 寅 | 占门炉外东北 |
| 卯 | 占门房内正东 |
| 辰 | 占门栖外正东 |
| 巳 | 占门床外正东 |
| 午 | 占碓磨外正南 |
| 未 | 占厕外西南 |
| 申 | 占碓磨门外西南 |
| 酉 | 占门栖外西南 |
| 戌 | 占房床外西南 |
| 亥 | 占房床外西南 |

### 3. `_generate_taishen_explanation()`

根据胎神方位自动生成解释文本，包含：
- 位置描述（门、厕、床等）
- 方位描述（正东、正西等）
- 注意事项说明

## 使用示例

### API 调用

```bash
curl -X POST http://localhost:8001/api/v1/calendar/query \
  -H "Content-Type: application/json" \
  -d '{"date": "2025-01-15"}'
```

### 响应示例

```json
{
  "success": true,
  "provider": "local",
  "date": "2025-01-15",
  "deities": {
    "taishen": "占门厕外正东",
    "taishen_explanation": "本日胎神在门、厕之外的正东方位，在这些方位不可随意敲打、动刀剪或移动物件，以免对孕妇和胎儿不利。"
  }
}
```

## 兼容性

1. **向后兼容**：不影响现有功能，胎神字段为新增字段
2. **库兼容**：自动检测 `lunar_python` 是否支持胎神
3. **API兼容**：支持从第三方API提取胎神信息
4. **降级处理**：如果库不支持，自动使用备用计算方案

## 测试

运行测试脚本：

```bash
python3 scripts/test_taishen_api.py
```

## 注意事项

1. 胎神计算基于传统黄历规则，备用方案使用简化规则
2. 如果 `lunar_python` 库支持胎神，优先使用库的方法
3. 解释文本会根据胎神描述自动生成，确保准确性
4. 所有方法都有异常处理，确保不影响现有功能

