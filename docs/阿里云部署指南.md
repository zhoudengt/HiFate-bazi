# HiFateç³»ç»Ÿ - é˜¿é‡Œäº‘éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æœåŠ¡å™¨é…ç½®æ¨è](#æœåŠ¡å™¨é…ç½®æ¨è)
- [éƒ¨ç½²å‰å‡†å¤‡](#éƒ¨ç½²å‰å‡†å¤‡)
- [è¯¦ç»†éƒ¨ç½²æ­¥éª¤](#è¯¦ç»†éƒ¨ç½²æ­¥éª¤)
- [æœåŠ¡ç®¡ç†](#æœåŠ¡ç®¡ç†)
- [ç›‘æ§å’Œç»´æŠ¤](#ç›‘æ§å’Œç»´æŠ¤)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)

---

## ç³»ç»Ÿæ¦‚è¿°

### æ¶æ„è¯´æ˜

HiFateç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäºå¾®æœåŠ¡æ¶æ„çš„å…«å­—ç®—å‘½å¹³å°ï¼ŒåŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

**Webåº”ç”¨å±‚**
- FastAPIä¸»åº”ç”¨ (ç«¯å£8001) - æä¾›HTTP/REST APIæ¥å£

**å¾®æœåŠ¡å±‚ (gRPC)**
- bazi_core (9001) - å…«å­—æ ¸å¿ƒè®¡ç®—æœåŠ¡ï¼Œè®¡ç®—å››æŸ±ã€ç¥ç…ã€åç¥ç­‰
- bazi_fortune (9002) - å¤§è¿æµå¹´æœåŠ¡ï¼Œè®¡ç®—è¿åŠ¿å‘¨æœŸ
- bazi_analyzer (9003) - å…«å­—åˆ†ææœåŠ¡ï¼Œæ‰§è¡Œå„ç§åˆ†æå™¨
- bazi_rule (9004) - è§„åˆ™åŒ¹é…æœåŠ¡ï¼ŒåŒ¹é…462+æ¡è§„åˆ™
- fortune_analysis (9005) - é¢ç›¸æ‰‹ç›¸åˆ†ææœåŠ¡
- payment_service (9006) - æ”¯ä»˜æœåŠ¡ï¼ŒStripeé›†æˆ
- fortune_rule (9007) - é¢ç›¸æ‰‹ç›¸è§„åˆ™æœåŠ¡

**æ•°æ®å­˜å‚¨å±‚**
- MySQL 8.0 - ä¸»æ•°æ®åº“
- Redis 7.0 - ç¼“å­˜å’Œä¼šè¯å­˜å‚¨

**åå‘ä»£ç†å±‚**
- Nginx - è´Ÿè½½å‡è¡¡å’Œåå‘ä»£ç†

### æŠ€æœ¯æ ˆ

- Python 3.11
- FastAPI + Uvicorn
- gRPC + Protobuf
- MySQL 8.0
- Redis 7.0
- Docker (å¯é€‰)
- Nginx

---

## æœåŠ¡å™¨é…ç½®æ¨è

### åŸºç¡€é…ç½® (é€‚åˆ10-15ä¸‡ç”¨æˆ·)

| é…ç½®é¡¹ | æ¨èå€¼ | è¯´æ˜ |
|--------|--------|------|
| **ECSå®ä¾‹** | ecs.c6.2xlarge | 8æ ¸32GB |
| **æœåŠ¡å™¨æ•°é‡** | 2å°åŸºç¡€ + å¼¹æ€§æ‰©å±• | ä¸»å¤‡æ¶æ„ |
| **æ“ä½œç³»ç»Ÿ** | CentOS 7.9 / Ubuntu 20.04 | æ¨èCentOS 7.9 |
| **ç³»ç»Ÿç›˜** | 40GB SSD | ESSDäº‘ç›˜ |
| **æ•°æ®ç›˜** | 200GB SSD | å­˜å‚¨MySQLå’ŒRedisæ•°æ® |
| **å¸¦å®½** | 20Mbps/å° | æŒ‰éœ€å‡çº§ |
| **åœ°åŸŸ** | æ ¹æ®ç”¨æˆ·åˆ†å¸ƒé€‰æ‹© | å»ºè®®åä¸œã€ååŒ— |

### ç½‘ç»œé…ç½®

1. **VPCé…ç½®**
   - åˆ›å»ºä¸“æœ‰ç½‘ç»œVPC
   - åˆ›å»º2ä¸ªå¯ç”¨åŒºçš„äº¤æ¢æœº
   - ç¡®ä¿æœåŠ¡å™¨åœ¨åŒä¸€VPCå†…ç½‘äº’é€š

2. **å®‰å…¨ç»„è§„åˆ™**

| ç«¯å£ | åè®® | æºåœ°å€ | è¯´æ˜ |
|------|------|---------|------|
| 80 | TCP | 0.0.0.0/0 | HTTPè®¿é—® |
| 443 | TCP | 0.0.0.0/0 | HTTPSè®¿é—®(å¯é€‰) |
| 22 | TCP | æ‚¨çš„IP | SSHç®¡ç† |
| 8001 | TCP | VPCå†…ç½‘ | Webåº”ç”¨(å†…ç½‘) |
| 9001-9007 | TCP | VPCå†…ç½‘ | å¾®æœåŠ¡(å†…ç½‘) |
| 3306 | TCP | VPCå†…ç½‘ | MySQL(å†…ç½‘) |
| 6379 | TCP | VPCå†…ç½‘ | Redis(å†…ç½‘) |

### æˆæœ¬ä¼°ç®—

| èµ„æº | é…ç½® | æœˆæˆæœ¬ |
|------|------|--------|
| ECSæœåŠ¡å™¨ | 2å° Ã— 8æ ¸32GB, 20Mbps | Â¥1,200 |
| æ•°æ®ç›˜ | 2 Ã— 200GB SSD | Â¥200 |
| è´Ÿè½½å‡è¡¡SLB | 40Mbps | Â¥150 |
| MySQL RDS | 8æ ¸32GB (å¯é€‰) | Â¥1,000 |
| Redis | 16GBä¸»ä» | Â¥300 |
| CDN | é™æ€èµ„æºåŠ é€Ÿ | Â¥150 |
| **æ€»è®¡(è‡ªå»ºæ•°æ®åº“)** | | **Â¥1,700** |
| **æ€»è®¡(ä½¿ç”¨RDS)** | | **Â¥3,000** |

---

## éƒ¨ç½²å‰å‡†å¤‡

### 1. è´­ä¹°é˜¿é‡Œäº‘èµ„æº

- [ ] è´­ä¹°2å°ECSæœåŠ¡å™¨ (8æ ¸32GB, 20Mbps)
- [ ] é…ç½®å®‰å…¨ç»„è§„åˆ™
- [ ] ç¡®ä¿ä¸¤å°æœåŠ¡å™¨åœ¨åŒä¸€VPC
- [ ] è‡³å°‘ä¸€å°æœåŠ¡å™¨ç»‘å®šå…¬ç½‘IP
- [ ] (å¯é€‰) è´­ä¹°SLBè´Ÿè½½å‡è¡¡
- [ ] (å¯é€‰) è´­ä¹°åŸŸåå¹¶å®ŒæˆICPå¤‡æ¡ˆ

### 2. è·å–å¿…è¦ä¿¡æ¯

```bash
# è®°å½•ä»¥ä¸‹ä¿¡æ¯:
èŠ‚ç‚¹1å…¬ç½‘IP: _____._____._____._____ 
èŠ‚ç‚¹1å†…ç½‘IP: 172.16.0.___
èŠ‚ç‚¹2å…¬ç½‘IP: _____._____._____._____ (å¯é€‰)
èŠ‚ç‚¹2å†…ç½‘IP: 172.16.0.___

MySQL Rootå¯†ç : ________________
MySQLç”¨æˆ·å¯†ç : ________________
Rediså¯†ç : ________________
```

### 3. å‡†å¤‡APIå¯†é’¥

- [ ] Coze API Token (å·²åœ¨é…ç½®ä¸­: `pat_m2Nah3l...`)
- [ ] Coze Bot ID (å·²åœ¨é…ç½®ä¸­: `7573909067308695606`)
- [ ] (å¯é€‰) Stripeæ”¯ä»˜å¯†é’¥

### 4. æœ¬åœ°å‡†å¤‡

```bash
# åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•ç¡®è®¤æ–‡ä»¶å®Œæ•´æ€§
cd /Users/zhoudt/Downloads/project/HiFate-bazi

# æ£€æŸ¥å…³é”®æ–‡ä»¶
ls -la start_all_services.sh
ls -la requirements.txt
ls -la server/start.py
ls -la services/*/grpc_server.py
```

---

## è¯¦ç»†éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1: è¿æ¥åˆ°æœåŠ¡å™¨

```bash
# ä»æœ¬åœ°ç»ˆç«¯è¿æ¥åˆ°æœåŠ¡å™¨
ssh root@<æœåŠ¡å™¨å…¬ç½‘IP>

# é¦–æ¬¡ç™»å½•åå»ºè®®ä¿®æ”¹rootå¯†ç 
passwd
```

### æ­¥éª¤2: ç³»ç»Ÿåˆå§‹åŒ–

```bash
# === CentOS 7.9 ç³»ç»Ÿ ===
# æ›´æ–°ç³»ç»Ÿ
yum update -y
yum install -y epel-release

# å®‰è£…åŸºç¡€è½¯ä»¶
yum install -y git curl wget vim net-tools lsof

# å®‰è£…Python 3.11 (CentOSéœ€è¦é¢å¤–æº)
yum install -y gcc openssl-devel bzip2-devel libffi-devel
cd /tmp
wget https://www.python.org/ftp/python/3.11.0/Python-3.11.0.tgz
tar xzf Python-3.11.0.tgz
cd Python-3.11.0
./configure --enable-optimizations
make altinstall
ln -sf /usr/local/bin/python3.11 /usr/bin/python3.11
ln -sf /usr/local/bin/pip3.11 /usr/bin/pip3.11

# === Ubuntu 20.04 ç³»ç»Ÿ ===
# apt update && apt upgrade -y
# apt install -y git curl wget vim net-tools lsof python3.11 python3.11-venv python3-pip

# å®‰è£…Docker (å¯é€‰ï¼Œç”¨äºMySQLå’ŒRedis)
yum install -y docker
systemctl start docker
systemctl enable docker

# å®‰è£…Nginx
yum install -y nginx
systemctl enable nginx

# é…ç½®é˜²ç«å¢™ (CentOS)
systemctl start firewalld
systemctl enable firewalld
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-service=ssh
firewall-cmd --reload

# Ubuntuä½¿ç”¨ufw
# ufw allow 80/tcp
# ufw allow 443/tcp
# ufw allow 22/tcp
# ufw enable
```

### æ­¥éª¤3: åˆ›å»ºéƒ¨ç½²ç›®å½•

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /opt/HiFate-bazi
cd /opt/HiFate-bazi

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs
mkdir -p mysql/data
mkdir -p redis/data

# è®¾ç½®æƒé™
chmod 755 /opt/HiFate-bazi
```

### æ­¥éª¤4: ä¸Šä¼ é¡¹ç›®ä»£ç 

**æ–¹å¼A: ä½¿ç”¨SCPä»æœ¬åœ°ä¸Šä¼  (æ¨è)**

```bash
# åœ¨æœ¬åœ°ç»ˆç«¯æ‰§è¡Œ (ä¸æ˜¯æœåŠ¡å™¨ä¸Š)
cd /Users/zhoudt/Downloads/project/HiFate-bazi

# å‹ç¼©é¡¹ç›® (æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶)
tar --exclude='.git' \
    --exclude='__pycache__' \
    --exclude='*.pyc' \
    --exclude='.venv' \
    --exclude='logs/*' \
    --exclude='*.log' \
    -czf HiFate-bazi.tar.gz .

# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp HiFate-bazi.tar.gz root@<æœåŠ¡å™¨IP>:/opt/HiFate-bazi/

# å›åˆ°æœåŠ¡å™¨ç»ˆç«¯ï¼Œè§£å‹
ssh root@<æœåŠ¡å™¨IP>
cd /opt/HiFate-bazi
tar -xzf HiFate-bazi.tar.gz
rm HiFate-bazi.tar.gz
```

**æ–¹å¼B: ä½¿ç”¨Git (å¦‚æœæœ‰Gitä»“åº“)**

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /opt/HiFate-bazi
git clone <your-git-repo-url> .

# æˆ–è€…å¦‚æœå·²æœ‰ä»£ç ï¼Œæ‹‰å–æ›´æ–°
git pull origin main
```

### æ­¥éª¤5: å®‰è£…Pythonä¾èµ–

```bash
cd /opt/HiFate-bazi

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3.11 -m venv .venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# å‡çº§pip
pip install --upgrade pip

# å®‰è£…é¡¹ç›®ä¾èµ–
pip install -r requirements.txt

# éªŒè¯å®‰è£…
python -c "import fastapi, grpc, redis, pymysql; print('ä¾èµ–å®‰è£…æˆåŠŸ')"
```

### æ­¥éª¤6: é…ç½®ç¯å¢ƒå˜é‡

```bash
cd /opt/HiFate-bazi

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim config/services.env
```

**èŠ‚ç‚¹1 (ä¸»èŠ‚ç‚¹) é…ç½®å†…å®¹:**

```bash
# gRPC æœåŠ¡åœ°å€ï¼ˆä¸éœ€è¦ http:// å‰ç¼€ï¼‰
export BAZI_CORE_SERVICE_URL="127.0.0.1:9001"
export BAZI_FORTUNE_SERVICE_URL="127.0.0.1:9002"
export BAZI_ANALYZER_SERVICE_URL="127.0.0.1:9003"
export BAZI_RULE_SERVICE_URL="127.0.0.1:9004"
export FORTUNE_ANALYSIS_SERVICE_URL="127.0.0.1:9005"
export FORTUNE_RULE_SERVICE_URL="127.0.0.1:9007"
export PAYMENT_SERVICE_URL="127.0.0.1:9006"

# Coze APIé…ç½® (å¤§æ¨¡å‹æœåŠ¡)
export COZE_ACCESS_TOKEN="pat_m2Nah3lrHI3XhV1eSIx7JAuQgYOr3ecFFQk1mHSZx29LITCIlITRdq4UljDL2isf"
export COZE_BOT_ID="7573909067308695606"

# MySQLé…ç½®
export MYSQL_HOST="127.0.0.1"
export MYSQL_PORT="3306"
export MYSQL_DB="hifate_bazi"
export MYSQL_USER="bazi_user"
export MYSQL_PASSWORD="your_secure_password_here"  # è¯·ä¿®æ”¹
export MYSQL_ROOT_PASSWORD="your_root_password_here"  # è¯·ä¿®æ”¹

# Redisé…ç½®
export REDIS_HOST="127.0.0.1"
export REDIS_PORT="6379"
export REDIS_PASSWORD="your_redis_password_here"  # è¯·ä¿®æ”¹

# èŠ‚ç‚¹é…ç½®
export NODE_ROLE="master"
export NODE_ID="1"

# Stripeæ”¯ä»˜é…ç½® (å¯é€‰)
# export STRIPE_SECRET_KEY="sk_test_..."
# export STRIPE_PUBLISHABLE_KEY="pk_test_..."
```

**ä¿å­˜åè®¾ç½®æƒé™:**

```bash
chmod 600 config/services.env
```

### æ­¥éª¤7: å®‰è£…å¹¶é…ç½®MySQL

**ä½¿ç”¨Dockerå®‰è£… (æ¨è)**

```bash
# ç”Ÿæˆå®‰å…¨çš„å¯†ç  (æˆ–ä½¿ç”¨æ‚¨è‡ªå·±çš„å¯†ç )
MYSQL_ROOT_PASSWORD="$(openssl rand -base64 32)"
MYSQL_PASSWORD="$(openssl rand -base64 32)"

echo "MySQL Rootå¯†ç : $MYSQL_ROOT_PASSWORD"
echo "MySQLç”¨æˆ·å¯†ç : $MYSQL_PASSWORD"
echo "è¯·è®°å½•è¿™äº›å¯†ç å¹¶æ›´æ–°åˆ° config/services.env"

# å¯åŠ¨MySQLå®¹å™¨
docker run -d \
  --name mysql-master \
  --restart unless-stopped \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD" \
  -e MYSQL_DATABASE=hifate_bazi \
  -e MYSQL_USER=bazi_user \
  -e MYSQL_PASSWORD="$MYSQL_PASSWORD" \
  -v /opt/HiFate-bazi/mysql/data:/var/lib/mysql \
  mysql:8.0 \
  --character-set-server=utf8mb4 \
  --collation-server=utf8mb4_unicode_ci \
  --default-authentication-plugin=mysql_native_password

# ç­‰å¾…MySQLå¯åŠ¨å®Œæˆ
echo "ç­‰å¾…MySQLå¯åŠ¨..."
sleep 20

# éªŒè¯MySQLè¿è¡ŒçŠ¶æ€
docker ps | grep mysql-master
docker logs mysql-master --tail 20
```

**å¯¼å…¥æ•°æ®åº“ç»“æ„ (å¦‚æœæœ‰schemaæ–‡ä»¶)**

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
if [ -f server/db/schema.sql ]; then
    echo "æ­£åœ¨å¯¼å…¥æ•°æ®åº“ç»“æ„..."
    docker exec -i mysql-master mysql -uroot -p"$MYSQL_ROOT_PASSWORD" hifate_bazi < server/db/schema.sql
    echo "æ•°æ®åº“ç»“æ„å¯¼å…¥å®Œæˆ"
else
    echo "æœªæ‰¾åˆ°schema.sqlï¼Œè·³è¿‡æ•°æ®åº“åˆå§‹åŒ–"
    echo "å¦‚æœéœ€è¦ï¼Œè¯·æ‰‹åŠ¨å¯¼å…¥æ•°æ®åº“æ–‡ä»¶"
fi
```

**ä½¿ç”¨yumç›´æ¥å®‰è£… (å¤‡é€‰æ–¹æ¡ˆ)**

```bash
# å®‰è£…MySQLä»“åº“
yum install -y https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm

# å®‰è£…MySQL
yum install -y mysql-community-server

# å¯åŠ¨MySQL
systemctl start mysqld
systemctl enable mysqld

# è·å–ä¸´æ—¶rootå¯†ç 
TEMP_PASSWORD=$(grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}')
echo "MySQLä¸´æ—¶å¯†ç : $TEMP_PASSWORD"

# ç™»å½•MySQLå¹¶ä¿®æ”¹å¯†ç  (éœ€è¦æ‰‹åŠ¨æ“ä½œ)
mysql -uroot -p"$TEMP_PASSWORD"
# æ‰§è¡Œ: ALTER USER 'root'@'localhost' IDENTIFIED BY 'YourNewPassword123!';
```

### æ­¥éª¤8: å®‰è£…å¹¶é…ç½®Redis

**ä½¿ç”¨Dockerå®‰è£… (æ¨è)**

```bash
# ç”ŸæˆRediså¯†ç 
REDIS_PASSWORD="$(openssl rand -base64 32)"
echo "Rediså¯†ç : $REDIS_PASSWORD"
echo "è¯·è®°å½•æ­¤å¯†ç å¹¶æ›´æ–°åˆ° config/services.env"

# å¯åŠ¨Rediså®¹å™¨
docker run -d \
  --name redis-master \
  --restart unless-stopped \
  -p 6379:6379 \
  -v /opt/HiFate-bazi/redis/data:/data \
  redis:7-alpine \
  redis-server \
  --requirepass "$REDIS_PASSWORD" \
  --appendonly yes \
  --appendfsync everysec \
  --maxmemory 8gb \
  --maxmemory-policy allkeys-lru

# éªŒè¯Redisè¿è¡ŒçŠ¶æ€
docker ps | grep redis-master
docker exec redis-master redis-cli -a "$REDIS_PASSWORD" ping
```

**ä½¿ç”¨yumç›´æ¥å®‰è£… (å¤‡é€‰æ–¹æ¡ˆ)**

```bash
# å®‰è£…Redis
yum install -y redis

# é…ç½®Rediså¯†ç 
sed -i "s/# requirepass foobared/requirepass $REDIS_PASSWORD/" /etc/redis.conf

# å¯åŠ¨Redis
systemctl start redis
systemctl enable redis

# æµ‹è¯•è¿æ¥
redis-cli -a "$REDIS_PASSWORD" ping
```

### æ­¥éª¤9: æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„å¯†ç 

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œå¡«å…¥åˆšæ‰ç”Ÿæˆçš„å¯†ç 
vim config/services.env

# æ›´æ–°ä»¥ä¸‹é…ç½®:
# export MYSQL_PASSWORD="åˆšæ‰ç”Ÿæˆçš„MySQLå¯†ç "
# export MYSQL_ROOT_PASSWORD="åˆšæ‰ç”Ÿæˆçš„MySQL Rootå¯†ç "
# export REDIS_PASSWORD="åˆšæ‰ç”Ÿæˆçš„Rediså¯†ç "
```

### æ­¥éª¤10: å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
cd /opt/HiFate-bazi

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# èµ‹äºˆå¯åŠ¨è„šæœ¬æ‰§è¡Œæƒé™
chmod +x start_all_services.sh
chmod +x stop_all_services.sh
chmod +x check_services.sh

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./start_all_services.sh

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 10

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
./check_services.sh
```

**å¯åŠ¨è„šæœ¬ä¼šä¾æ¬¡å¯åŠ¨:**
1. bazi_core (gRPC, 9001)
2. bazi_fortune (gRPC, 9002)
3. bazi_analyzer (gRPC, 9003)
4. bazi_rule (gRPC, 9004)
5. fortune_analysis (gRPC, 9005)
6. payment_service (gRPC, 9006)
7. fortune_rule (gRPC, 9007)
8. web_app (HTTP, 8001)

### æ­¥éª¤11: éªŒè¯æœåŠ¡è¿è¡Œ

```bash
# æŸ¥çœ‹æœåŠ¡è¿›ç¨‹
ps aux | grep python | grep -E "(grpc_server|start.py)"

# æŸ¥çœ‹ç«¯å£ç›‘å¬çŠ¶æ€
netstat -tlnp | grep -E "(8001|900[1-7])"

# æˆ–ä½¿ç”¨lsof
lsof -i :8001
lsof -i :9001

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/web_app_8001.log
tail -f logs/bazi_core_9001.log

# æµ‹è¯•Webåº”ç”¨å¥åº·æ£€æŸ¥
curl http://127.0.0.1:8001/health

# æµ‹è¯•APIæ¥å£
curl http://127.0.0.1:8001/docs
```

**é¢„æœŸè¾“å‡º:**

```bash
# ps aux åº”è¯¥æ˜¾ç¤º8ä¸ªPythonè¿›ç¨‹
# netstat åº”è¯¥æ˜¾ç¤º8ä¸ªç«¯å£åœ¨LISTENçŠ¶æ€
# curl health åº”è¯¥è¿”å› {"status": "ok"} æˆ–ç±»ä¼¼å“åº”
```

### æ­¥éª¤12: é…ç½®Nginxåå‘ä»£ç†

```bash
# åˆ›å»ºNginxé…ç½®æ–‡ä»¶
cat > /etc/nginx/conf.d/HiFate-bazi.conf << 'EOF'
# ä¸Šæ¸¸æœåŠ¡å™¨é…ç½®
upstream web_app_backend {
    server 127.0.0.1:8001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

server {
    listen 80;
    server_name _;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸåï¼Œå¦‚: bazi.example.com
    
    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/HiFate-bazi-access.log;
    error_log /var/log/nginx/HiFate-bazi-error.log;
    
    # å®¢æˆ·ç«¯æœ€å¤§è¯·æ±‚ä½“å¤§å°
    client_max_body_size 10M;
    client_body_buffer_size 128k;
    
    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # ä»£ç†æ‰€æœ‰è¯·æ±‚åˆ°åç«¯
    location / {
        proxy_pass http://web_app_backend;
        proxy_http_version 1.1;
        
        # è¯·æ±‚å¤´è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # ç¼“å†²è®¾ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹ (ä¸è®°å½•æ—¥å¿—)
    location /health {
        access_log off;
        proxy_pass http://web_app_backend/health;
    }
    
    # APIæ–‡æ¡£
    location /docs {
        proxy_pass http://web_app_backend/docs;
    }
    
    location /redoc {
        proxy_pass http://web_app_backend/redoc;
    }
    
    # é™æ€æ–‡ä»¶ (å¦‚æœæœ‰)
    location /static/ {
        alias /opt/HiFate-bazi/frontend/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
EOF

# æµ‹è¯•Nginxé…ç½®
nginx -t

# å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œé‡å¯Nginx
systemctl restart nginx

# è®¾ç½®Nginxå¼€æœºè‡ªå¯
systemctl enable nginx

# æŸ¥çœ‹NginxçŠ¶æ€
systemctl status nginx
```

### æ­¥éª¤13: é…ç½®é˜²ç«å¢™å’Œå®‰å…¨ç»„

```bash
# CentOSé˜²ç«å¢™é…ç½®
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload

# Ubuntué˜²ç«å¢™é…ç½®
# ufw allow 'Nginx Full'
# ufw reload

# é˜¿é‡Œäº‘å®‰å…¨ç»„è§„åˆ™ (åœ¨æ§åˆ¶å°é…ç½®):
# - å…¥æ–¹å‘: å…è®¸ 80/TCP (0.0.0.0/0)
# - å…¥æ–¹å‘: å…è®¸ 443/TCP (0.0.0.0/0)
# - å…¥æ–¹å‘: å…è®¸ 22/TCP (æ‚¨çš„IP)
# - å…¶ä»–ç«¯å£ä»…å…è®¸VPCå†…ç½‘è®¿é—®
```

### æ­¥éª¤14: æµ‹è¯•å¤–ç½‘è®¿é—®

```bash
# ä»æœ¬åœ°ç”µè„‘æµè§ˆå™¨è®¿é—®
# http://<æœåŠ¡å™¨å…¬ç½‘IP>
# http://<æœåŠ¡å™¨å…¬ç½‘IP>/health
# http://<æœåŠ¡å™¨å…¬ç½‘IP>/docs

# æˆ–ä½¿ç”¨curlæµ‹è¯•
curl http://<æœåŠ¡å™¨å…¬ç½‘IP>/health
```

### æ­¥éª¤15: é…ç½®å¼€æœºè‡ªå¯åŠ¨

```bash
# åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
cat > /etc/systemd/system/HiFate-bazi.service << 'EOF'
[Unit]
Description=Wenzhen Bazi Service
After=network.target mysql.service redis.service

[Service]
Type=forking
User=root
WorkingDirectory=/opt/HiFate-bazi
ExecStart=/opt/HiFate-bazi/start_all_services.sh
ExecStop=/opt/HiFate-bazi/stop_all_services.sh
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# é‡è½½systemd
systemctl daemon-reload

# å¯ç”¨å¼€æœºè‡ªå¯
systemctl enable HiFate-bazi

# æµ‹è¯•æœåŠ¡
# systemctl start HiFate-bazi
# systemctl status HiFate-bazi
```

---

## æœåŠ¡ç®¡ç†

### æ—¥å¸¸ç®¡ç†å‘½ä»¤

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/HiFate-bazi
source .venv/bin/activate

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
./check_services.sh

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep python

# æŸ¥çœ‹ç«¯å£
netstat -tlnp | grep -E "(8001|900[1-7])"

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./start_all_services.sh

# åœæ­¢æ‰€æœ‰æœåŠ¡
./stop_all_services.sh

# é‡å¯æ‰€æœ‰æœåŠ¡
./stop_all_services.sh && ./start_all_services.sh

# é‡å¯å•ä¸ªæœåŠ¡ (éœ€è¦å…ˆåœæ­¢å†å¯åŠ¨)
# æ‰¾åˆ°æœåŠ¡çš„PID
cat logs/bazi_core_9001.pid
# æ€æ­»è¿›ç¨‹
kill $(cat logs/bazi_core_9001.pid)
# å•ç‹¬å¯åŠ¨
source .venv/bin/activate
python services/bazi_core/grpc_server.py --port 9001 > logs/bazi_core_9001.log 2>&1 &
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
ls -lh logs/

# å®æ—¶æŸ¥çœ‹Webåº”ç”¨æ—¥å¿—
tail -f logs/web_app_8001.log

# å®æ—¶æŸ¥çœ‹å¾®æœåŠ¡æ—¥å¿—
tail -f logs/bazi_core_9001.log
tail -f logs/bazi_rule_9004.log

# æŸ¥çœ‹Nginxæ—¥å¿—
tail -f /var/log/nginx/HiFate-bazi-access.log
tail -f /var/log/nginx/HiFate-bazi-error.log

# æŸ¥çœ‹Dockerå®¹å™¨æ—¥å¿— (å¦‚æœä½¿ç”¨Docker)
docker logs -f mysql-master
docker logs -f redis-master

# æœç´¢é”™è¯¯æ—¥å¿—
grep -i error logs/*.log
grep -i exception logs/*.log

# æŒ‰æ—¶é—´æ’åºæŸ¥çœ‹æ—¥å¿—
ls -lt logs/
```

### æ›´æ–°éƒ¨ç½²

```bash
# 1. å¤‡ä»½å½“å‰ä»£ç 
cd /opt/HiFate-bazi
tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz \
    --exclude='.venv' \
    --exclude='logs' \
    --exclude='mysql' \
    --exclude='redis' \
    .

# 2. åœæ­¢æœåŠ¡
./stop_all_services.sh

# 3. æ‹‰å–æ–°ä»£ç  (Gitæ–¹å¼)
git pull origin main

# æˆ–ä¸Šä¼ æ–°ä»£ç  (SCPæ–¹å¼)
# scp -r new-code/* root@<æœåŠ¡å™¨IP>:/opt/HiFate-bazi/

# 4. æ›´æ–°ä¾èµ–
source .venv/bin/activate
pip install -r requirements.txt --upgrade

# 5. é‡å¯æœåŠ¡
./start_all_services.sh

# 6. éªŒè¯
./check_services.sh
curl http://localhost:8001/health
```

### æ•°æ®åº“ç®¡ç†

```bash
# è¿›å…¥MySQLå®¹å™¨
docker exec -it mysql-master mysql -uroot -p

# æˆ–ç›´æ¥æ‰§è¡ŒSQL
docker exec mysql-master mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "SHOW DATABASES;"

# å¤‡ä»½æ•°æ®åº“
docker exec mysql-master mysqldump -uroot -p"$MYSQL_ROOT_PASSWORD" \
    --single-transaction \
    --routines \
    --triggers \
    hifate_bazi > backup_$(date +%Y%m%d).sql

# æ¢å¤æ•°æ®åº“
docker exec -i mysql-master mysql -uroot -p"$MYSQL_ROOT_PASSWORD" hifate_bazi < backup.sql

# æŸ¥çœ‹æ•°æ®åº“å¤§å°
docker exec mysql-master mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e \
    "SELECT table_schema AS 'Database', 
     ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)' 
     FROM information_schema.tables 
     GROUP BY table_schema;"
```

### Redisç®¡ç†

```bash
# è¿æ¥Redis
docker exec -it redis-master redis-cli -a "$REDIS_PASSWORD"

# æŸ¥çœ‹Redisä¿¡æ¯
docker exec redis-master redis-cli -a "$REDIS_PASSWORD" INFO

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
docker exec redis-master redis-cli -a "$REDIS_PASSWORD" INFO memory

# æŸ¥çœ‹æ‰€æœ‰key
docker exec redis-master redis-cli -a "$REDIS_PASSWORD" KEYS '*'

# æ¸…ç©ºç¼“å­˜ (è°¨æ…ä½¿ç”¨)
# docker exec redis-master redis-cli -a "$REDIS_PASSWORD" FLUSHALL
```

---

## ç›‘æ§å’Œç»´æŠ¤

### ç³»ç»Ÿç›‘æ§

```bash
# æŸ¥çœ‹ç³»ç»Ÿè´Ÿè½½
top
htop  # éœ€è¦å®‰è£…: yum install -y htop

# æŸ¥çœ‹CPUä½¿ç”¨ç‡
mpstat 1 5

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹ç£ç›˜IO
iostat -x 1 5

# æŸ¥çœ‹ç½‘ç»œæµé‡
iftop  # éœ€è¦å®‰è£…: yum install -y iftop
```

### åº”ç”¨ç›‘æ§

```bash
# æŸ¥çœ‹æœåŠ¡å“åº”æ—¶é—´
time curl http://localhost:8001/health

# å‹åŠ›æµ‹è¯• (éœ€è¦å®‰è£…abæˆ–wrk)
ab -n 1000 -c 10 http://localhost:8001/health

# æŸ¥çœ‹æ•°æ®åº“è¿æ¥æ•°
docker exec mysql-master mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e \
    "SHOW PROCESSLIST;"

# æŸ¥çœ‹Redisè¿æ¥æ•°
docker exec redis-master redis-cli -a "$REDIS_PASSWORD" CLIENT LIST
```

### æ—¥å¿—æ¸…ç†

```bash
# æ¸…ç†7å¤©å‰çš„æ—¥å¿—
find /opt/HiFate-bazi/logs -name "*.log" -mtime +7 -delete

# æ¸…ç†Nginxæ—¥å¿—
find /var/log/nginx -name "*.log" -mtime +7 -delete

# æˆ–ä½¿ç”¨logrotateè‡ªåŠ¨æ¸…ç†
cat > /etc/logrotate.d/HiFate-bazi << 'EOF'
/opt/HiFate-bazi/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
}
EOF
```

### å®šæ—¶ä»»åŠ¡

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹ä»»åŠ¡:
# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½æ•°æ®åº“
0 2 * * * cd /opt/HiFate-bazi && docker exec mysql-master mysqldump -uroot -p"$MYSQL_ROOT_PASSWORD" hifate_bazi > /opt/backups/mysql_$(date +\%Y\%m\%d).sql

# æ¯å¤©å‡Œæ™¨3ç‚¹æ¸…ç†æ—§æ—¥å¿—
0 3 * * * find /opt/HiFate-bazi/logs -name "*.log" -mtime +7 -delete

# æ¯5åˆ†é’Ÿæ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
*/5 * * * * curl -f http://localhost:8001/health || /opt/HiFate-bazi/start_all_services.sh

# æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
crontab -l
```

---

## å¸¸è§é—®é¢˜

### Q1: æœåŠ¡å¯åŠ¨å¤±è´¥

**é—®é¢˜:** è¿è¡Œ`start_all_services.sh`åæœåŠ¡æœªå¯åŠ¨

**æ’æŸ¥æ­¥éª¤:**

```bash
# 1. æŸ¥çœ‹æ—¥å¿—
tail -f logs/*.log

# 2. æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8001
lsof -i :9001

# 3. æ£€æŸ¥Pythonç¯å¢ƒ
source .venv/bin/activate
python --version
pip list | grep -E "(fastapi|grpc)"

# 4. æ‰‹åŠ¨å¯åŠ¨å•ä¸ªæœåŠ¡æµ‹è¯•
python services/bazi_core/grpc_server.py --port 9001
```

**å¸¸è§åŸå› :**
- ç«¯å£è¢«å ç”¨: ä½¿ç”¨`lsof`æŸ¥æ‰¾å ç”¨è¿›ç¨‹å¹¶æ€æ­»
- ä¾èµ–æœªå®‰è£…: é‡æ–°è¿è¡Œ`pip install -r requirements.txt`
- ç¯å¢ƒå˜é‡æœªåŠ è½½: ç¡®è®¤`config/services.env`å­˜åœ¨ä¸”å·²source
- MySQL/Redisæœªå¯åŠ¨: æ£€æŸ¥`docker ps`

### Q2: æ— æ³•è®¿é—®Webç•Œé¢

**é—®é¢˜:** æµè§ˆå™¨è®¿é—®å…¬ç½‘IPæ— å“åº”

**æ’æŸ¥æ­¥éª¤:**

```bash
# 1. æ£€æŸ¥NginxçŠ¶æ€
systemctl status nginx
nginx -t

# 2. æ£€æŸ¥é˜²ç«å¢™
firewall-cmd --list-all
# æˆ–
iptables -L -n

# 3. æ£€æŸ¥Webåº”ç”¨æ˜¯å¦è¿è¡Œ
curl http://localhost:8001/health

# 4. æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log

# 5. æ£€æŸ¥å®‰å…¨ç»„è§„åˆ™ (é˜¿é‡Œäº‘æ§åˆ¶å°)
```

**è§£å†³æ–¹æ¡ˆ:**
- Nginxæœªå¯åŠ¨: `systemctl start nginx`
- é˜²ç«å¢™é˜»æ­¢: `firewall-cmd --add-port=80/tcp --permanent && firewall-cmd --reload`
- å®‰å…¨ç»„æœªå¼€æ”¾: åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°å¼€æ”¾80ç«¯å£
- Webåº”ç”¨æœªå¯åŠ¨: `./start_all_services.sh`

### Q3: MySQLè¿æ¥å¤±è´¥

**é—®é¢˜:** æ—¥å¿—æ˜¾ç¤º"Can't connect to MySQL server"

**æ’æŸ¥æ­¥éª¤:**

```bash
# 1. æ£€æŸ¥MySQLå®¹å™¨çŠ¶æ€
docker ps | grep mysql
docker logs mysql-master

# 2. æµ‹è¯•MySQLè¿æ¥
docker exec mysql-master mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "SELECT 1;"

# 3. æ£€æŸ¥å¯†ç é…ç½®
grep MYSQL_PASSWORD config/services.env

# 4. æ£€æŸ¥ç«¯å£
netstat -tlnp | grep 3306
```

**è§£å†³æ–¹æ¡ˆ:**
- MySQLæœªå¯åŠ¨: `docker start mysql-master`
- å¯†ç é”™è¯¯: æ›´æ–°`config/services.env`ä¸­çš„å¯†ç 
- ç«¯å£å†²çª: åœæ­¢å…¶ä»–MySQLæœåŠ¡æˆ–æ›´æ”¹ç«¯å£

### Q4: Redisè¿æ¥å¤±è´¥

**é—®é¢˜:** æ—¥å¿—æ˜¾ç¤º"Redis connection error"

**æ’æŸ¥æ­¥éª¤:**

```bash
# 1. æ£€æŸ¥Rediså®¹å™¨
docker ps | grep redis
docker logs redis-master

# 2. æµ‹è¯•Redisè¿æ¥
docker exec redis-master redis-cli -a "$REDIS_PASSWORD" ping

# 3. æ£€æŸ¥é…ç½®
grep REDIS_PASSWORD config/services.env
```

**è§£å†³æ–¹æ¡ˆ:**
- Redisæœªå¯åŠ¨: `docker start redis-master`
- å¯†ç é”™è¯¯: æ›´æ–°é…ç½®æ–‡ä»¶
- å†…å­˜ä¸è¶³: æ£€æŸ¥`docker stats`å¹¶è°ƒæ•´maxmemory

### Q5: æœåŠ¡å“åº”æ…¢

**é—®é¢˜:** APIå“åº”æ—¶é—´è¶…è¿‡5ç§’

**æ’æŸ¥æ­¥éª¤:**

```bash
# 1. æŸ¥çœ‹ç³»ç»Ÿè´Ÿè½½
top
free -h
df -h

# 2. æŸ¥çœ‹æ•°æ®åº“æ€§èƒ½
docker exec mysql-master mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "SHOW PROCESSLIST;"

# 3. æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
docker exec mysql-master tail /var/log/mysql/slow-query.log

# 4. æŸ¥çœ‹Rediså‘½ä¸­ç‡
docker exec redis-master redis-cli -a "$REDIS_PASSWORD" INFO stats
```

**ä¼˜åŒ–æ–¹æ¡ˆ:**
- å¢åŠ æœåŠ¡å™¨é…ç½® (CPU/å†…å­˜)
- ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•
- å¢åŠ Redisç¼“å­˜
- å¯ç”¨Nginxç¼“å­˜
- ä½¿ç”¨CDNåŠ é€Ÿé™æ€èµ„æº

### Q6: å†…å­˜å ç”¨è¿‡é«˜

**é—®é¢˜:** æœåŠ¡å™¨å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%

**æ’æŸ¥æ­¥éª¤:**

```bash
# æŸ¥çœ‹å„è¿›ç¨‹å†…å­˜å ç”¨
ps aux --sort=-%mem | head -20

# æŸ¥çœ‹Dockerå®¹å™¨å†…å­˜
docker stats --no-stream

# æŸ¥çœ‹MySQLå†…å­˜é…ç½®
docker exec mysql-master mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e \
    "SHOW VARIABLES LIKE '%buffer%';"
```

**è§£å†³æ–¹æ¡ˆ:**
- è°ƒæ•´MySQL buffer poolå¤§å°
- é™åˆ¶Redisæœ€å¤§å†…å­˜
- é‡å¯é•¿æ—¶é—´è¿è¡Œçš„Pythonè¿›ç¨‹
- å‡çº§æœåŠ¡å™¨å†…å­˜

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–

```sql
-- æ·»åŠ ç´¢å¼• (åœ¨MySQLä¸­æ‰§è¡Œ)
-- æ ¹æ®å®é™…æŸ¥è¯¢æ·»åŠ åˆé€‚çš„ç´¢å¼•

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SHOW VARIABLES LIKE 'slow_query%';
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;

-- åˆ†æè¡¨
ANALYZE TABLE your_table_name;

-- ä¼˜åŒ–è¡¨
OPTIMIZE TABLE your_table_name;
```

### 2. Redisç¼“å­˜ä¼˜åŒ–

```bash
# å¢åŠ Rediså†…å­˜é™åˆ¶
docker exec redis-master redis-cli -a "$REDIS_PASSWORD" CONFIG SET maxmemory 8gb

# è®¾ç½®è¿‡æœŸç­–ç•¥
docker exec redis-master redis-cli -a "$REDIS_PASSWORD" CONFIG SET maxmemory-policy allkeys-lru

# å¯ç”¨æŒä¹…åŒ–
docker exec redis-master redis-cli -a "$REDIS_PASSWORD" CONFIG SET save "900 1 300 10 60 10000"
```

### 3. Nginxä¼˜åŒ–

```nginx
# ç¼–è¾‘ /etc/nginx/nginx.conf

# å·¥ä½œè¿›ç¨‹æ•° (é€šå¸¸è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°)
worker_processes auto;

# æ¯ä¸ªè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°
events {
    worker_connections 2048;
    use epoll;
}

http {
    # å¼€å¯æ–‡ä»¶ç¼“å­˜
    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    
    # è°ƒæ•´ç¼“å†²åŒºå¤§å°
    client_body_buffer_size 128k;
    client_max_body_size 10m;
    
    # å¼€å¯gzipå‹ç¼©
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 1024;
    
    # å…¶ä»–é…ç½®...
}
```

### 4. åº”ç”¨å±‚ä¼˜åŒ–

```python
# åœ¨ä»£ç ä¸­å¢åŠ ç¼“å­˜
# ä¾‹å¦‚åœ¨ server/ ç›¸å…³æ–‡ä»¶ä¸­ä½¿ç”¨ @lru_cache æˆ– Redisç¼“å­˜

# è¿æ¥æ± ä¼˜åŒ–
# å¢åŠ  MySQL å’Œ Redis è¿æ¥æ± å¤§å°
# åœ¨é…ç½®æ–‡ä»¶ä¸­è°ƒæ•´
```

### 5. ç³»ç»Ÿå±‚é¢ä¼˜åŒ–

```bash
# è°ƒæ•´ç³»ç»Ÿå‚æ•°
cat >> /etc/sysctl.conf << 'EOF'
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
fs.file-max = 65535

# TCPä¼˜åŒ–
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30
net.core.somaxconn = 1024
net.ipv4.tcp_max_syn_backlog = 2048
EOF

# åº”ç”¨é…ç½®
sysctl -p

# å¢åŠ ç”¨æˆ·æ–‡ä»¶é™åˆ¶
cat >> /etc/security/limits.conf << 'EOF'
* soft nofile 65535
* hard nofile 65535
EOF
```

### 6. ä½¿ç”¨CDN

```bash
# å¯¹äºé™æ€èµ„æºï¼Œå»ºè®®ä½¿ç”¨é˜¿é‡Œäº‘CDN
# 1. åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°å¼€é€šCDN
# 2. æ·»åŠ åŠ é€ŸåŸŸå
# 3. é…ç½®æºç«™ä¸ºæ‚¨çš„ECSå…¬ç½‘IP
# 4. é…ç½®ç¼“å­˜è§„åˆ™
# 5. åœ¨å‰ç«¯é¡µé¢ä½¿ç”¨CDNåŸŸå
```

---

## å®‰å…¨åŠ å›º

### 1. SSHå®‰å…¨

```bash
# ç¦ç”¨rootç™»å½• (å¯é€‰)
# å…ˆåˆ›å»ºæ™®é€šç”¨æˆ·
# useradd -m -s /bin/bash yourusername
# passwd yourusername
# usermod -aG wheel yourusername

# ä¿®æ”¹SSHé…ç½®
# vim /etc/ssh/sshd_config
# PermitRootLogin no
# PasswordAuthentication no  # ä½¿ç”¨å¯†é’¥ç™»å½•
# systemctl restart sshd
```

### 2. é…ç½®HTTPS (æ¨è)

```bash
# å®‰è£…certbot
yum install -y certbot python3-certbot-nginx

# è·å–SSLè¯ä¹¦
certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
echo "0 3 * * * certbot renew --quiet" | crontab -
```

### 3. é˜²ç«å¢™è§„åˆ™

```bash
# åªå…è®¸å¿…è¦çš„ç«¯å£
firewall-cmd --permanent --remove-service=dhcpv6-client
firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="ä½ çš„IP" port protocol="tcp" port="22" accept'
firewall-cmd --reload
```

### 4. æ•°æ®åº“å®‰å…¨

```bash
# MySQLåªç›‘å¬æœ¬åœ°
# ä¿®æ”¹Dockerå¯åŠ¨å‘½ä»¤ï¼Œç§»é™¤ -p 3306:3306

# æˆ–æ·»åŠ  --bind-address=127.0.0.1

# å®šæœŸå¤‡ä»½
# è§å‰é¢çš„å®šæ—¶ä»»åŠ¡éƒ¨åˆ†
```

---

## æ‰©å±•å’Œå‡çº§

### æ°´å¹³æ‰©å±• (å¤šå°æœåŠ¡å™¨)

å¦‚æœå•å°æœåŠ¡å™¨æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œå¯ä»¥éƒ¨ç½²å¤šå°æœåŠ¡å™¨:

1. **åœ¨ç¬¬2å°æœåŠ¡å™¨ä¸Šé‡å¤æ­¥éª¤1-14**
2. **é…ç½®SLBè´Ÿè½½å‡è¡¡** (é˜¿é‡Œäº‘æ§åˆ¶å°)
3. **é…ç½®MySQLè¯»å†™åˆ†ç¦»** (ä¸»ä»å¤åˆ¶)
4. **é…ç½®Redisé›†ç¾¤** (ä¸»ä»æˆ–Sentinel)

### ä½¿ç”¨Docker Composeéƒ¨ç½²

é¡¹ç›®å·²åŒ…å«`Dockerfile`,å¯ä»¥ä½¿ç”¨Docker Composeç®€åŒ–éƒ¨ç½²:

```bash
# åˆ›å»º docker-compose.yml
# å‚è€ƒ docs/éƒ¨ç½²æ–¹æ¡ˆ.md ä¸­çš„é…ç½®

# å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### ä½¿ç”¨Kuberneteséƒ¨ç½²

å¯¹äºå¤§è§„æ¨¡éƒ¨ç½²,å¯ä»¥è€ƒè™‘K8s:

```bash
# 1. æ„å»ºDockeré•œåƒ
# 2. æ¨é€åˆ°é•œåƒä»“åº“
# 3. ç¼–å†™K8s YAMLæ–‡ä»¶
# 4. ä½¿ç”¨kubectléƒ¨ç½²

# å…·ä½“æ­¥éª¤è¯·å‚è€ƒ docs/éƒ¨ç½²æ–¹æ¡ˆ.md
```

---

## é™„å½•

### A. ç«¯å£è¯´æ˜

| æœåŠ¡ | ç«¯å£ | åè®® | è¯´æ˜ |
|------|------|------|------|
| Nginx | 80 | HTTP | å¯¹å¤–WebæœåŠ¡ |
| Nginx | 443 | HTTPS | å¯¹å¤–HTTPS (å¯é€‰) |
| Web App | 8001 | HTTP | FastAPIåº”ç”¨ |
| bazi_core | 9001 | gRPC | æ ¸å¿ƒè®¡ç®—æœåŠ¡ |
| bazi_fortune | 9002 | gRPC | è¿åŠ¿æœåŠ¡ |
| bazi_analyzer | 9003 | gRPC | åˆ†ææœåŠ¡ |
| bazi_rule | 9004 | gRPC | è§„åˆ™æœåŠ¡ |
| fortune_analysis | 9005 | gRPC | é¢ç›¸æ‰‹ç›¸åˆ†æ |
| payment_service | 9006 | gRPC | æ”¯ä»˜æœåŠ¡ |
| fortune_rule | 9007 | gRPC | é¢ç›¸æ‰‹ç›¸è§„åˆ™ |
| MySQL | 3306 | MySQL | æ•°æ®åº“ |
| Redis | 6379 | Redis | ç¼“å­˜ |

### B. é‡è¦æ–‡ä»¶è·¯å¾„

```
/opt/HiFate-bazi/                    # é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ config/services.env               # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ start_all_services.sh             # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ stop_all_services.sh              # åœæ­¢è„šæœ¬
â”œâ”€â”€ check_services.sh                 # æ£€æŸ¥è„šæœ¬
â”œâ”€â”€ logs/                             # æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ web_app_8001.log
â”‚   â”œâ”€â”€ bazi_core_9001.log
â”‚   â””â”€â”€ ...
â”œâ”€â”€ .venv/                            # Pythonè™šæ‹Ÿç¯å¢ƒ
â”œâ”€â”€ server/                           # Webåº”ç”¨ä»£ç 
â”œâ”€â”€ services/                         # å¾®æœåŠ¡ä»£ç 
â””â”€â”€ requirements.txt                  # Pythonä¾èµ–

/etc/nginx/conf.d/HiFate-bazi.conf   # Nginxé…ç½®
/var/log/nginx/                       # Nginxæ—¥å¿—
/etc/systemd/system/HiFate-bazi.service  # SystemdæœåŠ¡
```

### C. æœ‰ç”¨çš„å‘½ä»¤åˆ«å

```bash
# æ·»åŠ åˆ° ~/.bashrc
cat >> ~/.bashrc << 'EOF'

# HiFateé¡¹ç›®åˆ«å
alias bazi-cd='cd /opt/HiFate-bazi && source .venv/bin/activate'
alias bazi-start='cd /opt/HiFate-bazi && ./start_all_services.sh'
alias bazi-stop='cd /opt/HiFate-bazi && ./stop_all_services.sh'
alias bazi-check='cd /opt/HiFate-bazi && ./check_services.sh'
alias bazi-logs='tail -f /opt/HiFate-bazi/logs/*.log'
alias bazi-nginx='tail -f /var/log/nginx/HiFate-bazi-*.log'
EOF

# é‡æ–°åŠ è½½
source ~/.bashrc
```

### D. è”ç³»ä¿¡æ¯

- **é¡¹ç›®è·¯å¾„**: `/opt/HiFate-bazi`
- **Gitä»“åº“**: (å¦‚æœ‰)
- **æŠ€æœ¯æ”¯æŒ**: (è”ç³»æ–¹å¼)
- **æ–‡æ¡£ç‰ˆæœ¬**: 1.0
- **æœ€åæ›´æ–°**: 2025-11-20

---

## å¿«é€Ÿå‚è€ƒå¡ç‰‡

### ğŸš€ å¿«é€Ÿå¯åŠ¨

```bash
cd /opt/HiFate-bazi
source .venv/bin/activate
./start_all_services.sh
```

### ğŸ›‘ åœæ­¢æœåŠ¡

```bash
cd /opt/HiFate-bazi
./stop_all_services.sh
```

### ğŸ“Š æŸ¥çœ‹çŠ¶æ€

```bash
cd /opt/HiFate-bazi
./check_services.sh
curl http://localhost:8001/health
```

### ğŸ“ æŸ¥çœ‹æ—¥å¿—

```bash
tail -f /opt/HiFate-bazi/logs/web_app_8001.log
tail -f /var/log/nginx/HiFate-bazi-error.log
```

### ğŸ”„ é‡å¯æœåŠ¡

```bash
cd /opt/HiFate-bazi
./stop_all_services.sh && sleep 3 && ./start_all_services.sh
```

---

**éƒ¨ç½²å®Œæˆåï¼Œè¯·è®¿é—® `http://<æœåŠ¡å™¨IP>/docs` æŸ¥çœ‹APIæ–‡æ¡£ï¼**

**å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æˆ–å‚è€ƒå¸¸è§é—®é¢˜ç« èŠ‚ã€‚**


