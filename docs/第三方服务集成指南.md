# ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•é…ç½®å’Œä½¿ç”¨HiFateç³»ç»Ÿé›†æˆçš„ä¸‰å¤§ç¬¬ä¸‰æ–¹æœåŠ¡ï¼š

1. **ç»Ÿä¸€æ”¯ä»˜æœåŠ¡** - Stripeã€PayPalã€æ”¯ä»˜å®å›½é™…ç‰ˆã€å¾®ä¿¡æ”¯ä»˜
2. **æ¨é€æœåŠ¡** - OneSignal
3. **æ•°æ®åˆ†ææœåŠ¡** - Google Analytics 4 + è‡ªå®šä¹‰åˆ†æ

---

## ğŸ¯ å®¢æˆ·åœ°åŸŸè¦†ç›–

- **ç¾æ´²**: Stripe (ä¸»åŠ›) + PayPal (å¤‡é€‰)
- **æ¬§æ´²**: Stripe (ä¸»åŠ›) + PayPal (å¤‡é€‰)
- **é¦™æ¸¯**: Stripe + PayPal + æ”¯ä»˜å® + å¾®ä¿¡
- **æ¾³é—¨**: æ”¯ä»˜å® + å¾®ä¿¡ + Stripe
- **è²å¾‹å®¾**: Stripe (æ”¯æŒPHPæ¯”ç´¢) + PayPal
- **ä¸­å›½å¤§é™†**: æ”¯ä»˜å® + å¾®ä¿¡ + Stripe

---

## ğŸ’³ 1. ç»Ÿä¸€æ”¯ä»˜æœåŠ¡

### 1.1 ä¾èµ–å®‰è£…

```bash
pip install stripe>=7.0.0
pip install paypalrestsdk>=1.13.1
pip install alipay-sdk-python>=3.7.0
pip install wechatpy>=1.8.18
```

### 1.2 ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```bash
# ========== Stripe ==========
STRIPE_SECRET_KEY=sk_test_xxxxx  # æµ‹è¯•ç¯å¢ƒ
# STRIPE_SECRET_KEY=sk_live_xxxxx  # ç”Ÿäº§ç¯å¢ƒ

# ========== PayPal ==========
PAYPAL_CLIENT_ID=xxxxx
PAYPAL_CLIENT_SECRET=xxxxx
PAYPAL_MODE=sandbox  # sandbox æˆ– live

# ========== æ”¯ä»˜å®å›½é™…ç‰ˆ ==========
ALIPAY_APP_ID=20xxxxxxxxxxxxxx
ALIPAY_PRIVATE_KEY_PATH=/path/to/private_key.pem
ALIPAY_PUBLIC_KEY_PATH=/path/to/public_key.pem
ALIPAY_GATEWAY_URL=https://openapi.alipay.com/gateway.do  # ç”Ÿäº§
# ALIPAY_GATEWAY_URL=https://openapi.alipaydev.com/gateway.do  # æµ‹è¯•

# ========== å¾®ä¿¡æ”¯ä»˜ ==========
WECHAT_APP_ID=wxxxxxxxxxxxxxxx
WECHAT_MCH_ID=1234567890
WECHAT_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
WECHAT_MCH_CERT_PATH=/path/to/apiclient_cert.pem
WECHAT_MCH_KEY_PATH=/path/to/apiclient_key.pem

# ========== å‰åç«¯URLé…ç½® ==========
FRONTEND_BASE_URL=http://localhost:8001/frontend
BACKEND_BASE_URL=http://localhost:8001
```

### 1.3 è·å–APIå¯†é’¥

#### Stripe
1. è®¿é—® https://dashboard.stripe.com/
2. æ³¨å†Œè´¦å·
3. åœ¨"å¼€å‘è€…" â†’ "APIå¯†é’¥"è·å–
4. æµ‹è¯•ç¯å¢ƒä½¿ç”¨ `sk_test_` å¼€å¤´çš„å¯†é’¥

#### PayPal
1. è®¿é—® https://developer.paypal.com/
2. åˆ›å»ºåº”ç”¨
3. è·å– Client ID å’Œ Secret

#### æ”¯ä»˜å®å›½é™…ç‰ˆ
1. è®¿é—® https://open.alipay.com/
2. åˆ›å»ºåº”ç”¨
3. ç”ŸæˆRSAå¯†é’¥å¯¹
4. é…ç½®å…¬é’¥åˆ°æ”¯ä»˜å®æ§åˆ¶å°

#### å¾®ä¿¡æ”¯ä»˜
1. è®¿é—® https://pay.weixin.qq.com/
2. ç”³è¯·å•†æˆ·å·
3. ä¸‹è½½APIè¯ä¹¦
4. è·å–APIå¯†é’¥

### 1.4 APIæ¥å£

#### åˆ›å»ºæ”¯ä»˜
```bash
POST /api/v1/payment/unified/create
Content-Type: application/json

{
  "provider": "stripe",  # stripe/paypal/alipay/wechat
  "amount": "19.90",
  "currency": "USD",
  "product_name": "æœˆè®¢é˜…ä¼šå‘˜",
  "customer_email": "user@example.com"  # Stripeå¿…éœ€
}
```

#### éªŒè¯æ”¯ä»˜
```bash
POST /api/v1/payment/unified/verify
Content-Type: application/json

{
  "provider": "stripe",
  "session_id": "cs_test_xxxxx"  # Stripeä½¿ç”¨
  # æˆ–
  "payment_id": "PAYID-xxxxx"    # PayPalä½¿ç”¨
  # æˆ–
  "order_id": "ALIPAY_xxxxx"     # æ”¯ä»˜å®/å¾®ä¿¡ä½¿ç”¨
}
```

#### æŸ¥çœ‹å¯ç”¨æ¸ é“
```bash
GET /api/v1/payment/providers
```

#### æ¨èæ”¯ä»˜æ¸ é“
```bash
GET /api/v1/payment/recommend?region=hongkong&currency=HKD
```

### 1.5 è´§å¸ä»£ç æ”¯æŒ

| è´§å¸ | ä»£ç  | Stripe | PayPal | æ”¯ä»˜å® | å¾®ä¿¡ |
|------|------|--------|--------|--------|------|
| ç¾å…ƒ | USD | âœ… | âœ… | âœ… | âŒ |
| æ¸¯å¸ | HKD | âœ… | âœ… | âœ… | âœ… |
| äººæ°‘å¸ | CNY | âŒ | âŒ | âœ… | âœ… |
| æ¬§å…ƒ | EUR | âœ… | âœ… | âŒ | âŒ |
| è²å¾‹å®¾æ¯”ç´¢ | PHP | âœ… | âœ… | âŒ | âŒ |

---

## ğŸ”” 2. æ¨é€æœåŠ¡

### 2.1 ä¾èµ–å®‰è£…

```bash
# OneSignalä½¿ç”¨æ ‡å‡†HTTPè¯·æ±‚ï¼Œæ— éœ€é¢å¤–ä¾èµ–
pip install requests
```

### 2.2 ç¯å¢ƒå˜é‡é…ç½®

```bash
# ========== OneSignal ==========
ONESIGNAL_APP_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
ONESIGNAL_REST_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 2.3 è·å–APIå¯†é’¥

1. è®¿é—® https://onesignal.com/
2. æ³¨å†Œè´¦å·
3. åˆ›å»ºåº”ç”¨
4. åœ¨"Settings" â†’ "Keys & IDs"è·å–
   - App ID
   - REST API Key

### 2.4 å‰ç«¯é›†æˆ

åœ¨ `frontend/index.html` æ·»åŠ ï¼š

```html
<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
<script>
  window.OneSignal = window.OneSignal || [];
  OneSignal.push(function() {
    OneSignal.init({
      appId: "YOUR_ONESIGNAL_APP_ID",
      notifyButton: {
        enable: true,
      },
      allowLocalhostAsSecureOrigin: true
    });
    
    // è®¾ç½®ç”¨æˆ·ID
    OneSignal.setExternalUserId(localStorage.getItem('user_id'));
  });
</script>
```

### 2.5 APIæ¥å£

#### å‘é€æ¨é€é€šçŸ¥
```bash
POST /api/v1/push/send
Content-Type: application/json

{
  "user_ids": ["user_12345"],
  "title": "ä»Šæ—¥è¿åŠ¿æé†’",
  "content": "æ‚¨çš„ä»Šæ—¥è¿åŠ¿å·²æ›´æ–°",
  "url": "https://yourdomain.com/bazi-daily-fortune.html"
}
```

#### å‘é€å¹¿æ’­é€šçŸ¥
```bash
POST /api/v1/push/broadcast
Content-Type: application/json

{
  "title": "ç³»ç»Ÿé€šçŸ¥",
  "content": "æ–°åŠŸèƒ½ä¸Šçº¿å•¦ï¼"
}
```

#### å‘é€è¿åŠ¿æé†’
```bash
POST /api/v1/push/fortune-reminder
Content-Type: application/json

{
  "user_id": "user_12345",
  "fortune_type": "daily"  # daily æˆ– monthly
}
```

### 2.6 æ¨é€åœºæ™¯

- âœ… ä»Šæ—¥/æœ¬æœˆè¿åŠ¿æé†’
- âœ… å…«å­—åˆ†æå®Œæˆé€šçŸ¥
- âœ… æ”¯ä»˜æˆåŠŸé€šçŸ¥
- âœ… VIPä¼šå‘˜åˆ°æœŸæé†’
- âœ… ç³»ç»Ÿé€šçŸ¥
- âœ… æ–°åŠŸèƒ½ä¸Šçº¿é€šçŸ¥
- âœ… è¥é”€æ¨å¹¿æ¶ˆæ¯

---

## ğŸ“Š 3. æ•°æ®åˆ†ææœåŠ¡

### 3.1 Google Analytics 4 (å‰ç«¯)

#### é›†æˆæ­¥éª¤

1. è®¿é—® https://analytics.google.com/
2. åˆ›å»ºGA4åª’ä½“èµ„æº
3. è·å– Measurement ID (G-XXXXXXXXXX)
4. åœ¨å‰ç«¯é¡µé¢æ·»åŠ ä»£ç ï¼š

```html
<!-- Google Analytics 4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-XXXXXXXXXX', {
    'send_page_view': true,
    'user_id': localStorage.getItem('user_id')
  });
</script>
```

#### äº‹ä»¶è¿½è¸ª

```javascript
// å…«å­—è®¡ç®—
gtag('event', 'bazi_calculation', {
  'event_category': 'bazi',
  'birth_year': 1990,
  'gender': 'male'
});

// è§„åˆ™åŒ¹é…
gtag('event', 'rule_match', {
  'event_category': 'analysis',
  'rule_type': 'wealth',
  'match_count': 28
});

// æ”¯ä»˜
gtag('event', 'purchase', {
  'transaction_id': '12345',
  'value': 19.90,
  'currency': 'USD',
  'items': [{
    'item_name': 'æœˆè®¢é˜…ä¼šå‘˜',
    'price': 19.90
  }]
});

// åŠŸèƒ½ä½¿ç”¨
gtag('event', 'feature_usage', {
  'feature_name': 'daily_fortune'
});
```

### 3.2 è‡ªå®šä¹‰åˆ†æ (åç«¯)

#### APIæ¥å£

#### è¿½è¸ªäº‹ä»¶
```bash
POST /api/v1/analytics/track
Content-Type: application/json

{
  "event_name": "custom_event",
  "user_id": "user_12345",
  "properties": {
    "category": "test",
    "value": 100
  }
}
```

#### è¿½è¸ªå…«å­—è®¡ç®—
```bash
POST /api/v1/analytics/bazi-calculation
Content-Type: application/json

{
  "user_id": "user_12345",
  "solar_date": "1990-05-20",
  "gender": "male",
  "calculation_time_ms": 150
}
```

#### è¿½è¸ªè§„åˆ™åŒ¹é…
```bash
POST /api/v1/analytics/rule-match
Content-Type: application/json

{
  "user_id": "user_12345",
  "rule_type": "wealth",
  "matched_count": 28,
  "total_rules": 808
}
```

#### è¿½è¸ªæ”¯ä»˜
```bash
POST /api/v1/analytics/payment
Content-Type: application/json

{
  "user_id": "user_12345",
  "provider": "stripe",
  "amount": "19.90",
  "currency": "USD",
  "product_name": "æœˆè®¢é˜…ä¼šå‘˜",
  "status": "success"
}
```

#### è·å–ç»Ÿè®¡
```bash
GET /api/v1/analytics/statistics
```

#### è·å–ç”¨æˆ·äº‹ä»¶
```bash
GET /api/v1/analytics/user/{user_id}/events?limit=50
```

---

## ğŸ§ª æµ‹è¯•é¡µé¢

è®¿é—®æµ‹è¯•é¡µé¢ï¼š
```
http://127.0.0.1:8001/frontend/third-party-services.html
```

åŠŸèƒ½ï¼š
- âœ… æµ‹è¯•å„æ”¯ä»˜æ¸ é“
- âœ… æŸ¥çœ‹å¯ç”¨æ”¯ä»˜æ–¹å¼
- âœ… å‘é€æ¨é€é€šçŸ¥
- âœ… æµ‹è¯•è¿åŠ¿æé†’
- âœ… è¿½è¸ªè‡ªå®šä¹‰äº‹ä»¶
- âœ… æŸ¥çœ‹ç»Ÿè®¡æ•°æ®
- âœ… æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€

---

## ğŸ“ˆ ä½¿ç”¨åœºæ™¯

### æ”¯ä»˜åœºæ™¯

1. **ç¾æ´²å®¢æˆ·è´­ä¹°ä¼šå‘˜** â†’ æ¨èStripe (USD)
2. **é¦™æ¸¯å®¢æˆ·è´­ä¹°** â†’ æ¨èStripe/æ”¯ä»˜å®/å¾®ä¿¡ (HKD)
3. **è²å¾‹å®¾å®¢æˆ·** â†’ æ¨èStripe (PHP)
4. **æ¬§æ´²å®¢æˆ·** â†’ æ¨èStripe (EUR)
5. **ä¸­å›½å®¢æˆ·** â†’ æ¨èæ”¯ä»˜å®/å¾®ä¿¡ (CNY)

### æ¨é€åœºæ™¯

1. **æ¯æ—¥è¿åŠ¿æé†’** â†’ æ—©ä¸Š8ç‚¹å®šæ—¶æ¨é€
2. **åˆ†æå®Œæˆ** â†’ å®æ—¶æ¨é€
3. **æ”¯ä»˜æˆåŠŸ** â†’ å³æ—¶é€šçŸ¥
4. **VIPåˆ°æœŸ** â†’ æå‰3å¤©æé†’
5. **æ–°åŠŸèƒ½ä¸Šçº¿** â†’ å¹¿æ’­é€šçŸ¥

### åˆ†æåœºæ™¯

1. **ç”¨æˆ·è¡Œä¸ºåˆ†æ** â†’ GA4è¿½è¸ªé¡µé¢æµè§ˆã€ç‚¹å‡»
2. **è½¬åŒ–æ¼æ–—** â†’ æ³¨å†Œâ†’è®¡ç®—â†’ä»˜è´¹çš„è½¬åŒ–ç‡
3. **åŠŸèƒ½ä½¿ç”¨ç‡** â†’ å“ªäº›åŠŸèƒ½æœ€å—æ¬¢è¿
4. **æ”¯ä»˜åˆ†æ** â†’ ä¸åŒåœ°åŒºåå¥½çš„æ”¯ä»˜æ–¹å¼
5. **ç•™å­˜åˆ†æ** â†’ ç”¨æˆ·æ´»è·ƒåº¦å’Œç•™å­˜ç‡

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### æ”¯ä»˜é—®é¢˜

**é—®é¢˜**: Stripeæ”¯ä»˜åˆ›å»ºå¤±è´¥
**è§£å†³**: æ£€æŸ¥ `STRIPE_SECRET_KEY` æ˜¯å¦æ­£ç¡®ï¼Œæµ‹è¯•ç¯å¢ƒä½¿ç”¨ `sk_test_` å¼€å¤´

**é—®é¢˜**: æ”¯ä»˜å®æŠ¥ç­¾åé”™è¯¯
**è§£å†³**: æ£€æŸ¥ç§é’¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼Œå¯†é’¥æ ¼å¼æ˜¯å¦åŒ¹é…

**é—®é¢˜**: å¾®ä¿¡æ”¯ä»˜äºŒç»´ç ç”Ÿæˆå¤±è´¥
**è§£å†³**: æ£€æŸ¥å•†æˆ·å·ã€APIå¯†é’¥ã€è¯ä¹¦è·¯å¾„æ˜¯å¦é…ç½®æ­£ç¡®

### æ¨é€é—®é¢˜

**é—®é¢˜**: OneSignalæ¨é€å¤±è´¥
**è§£å†³**: 
1. æ£€æŸ¥ `ONESIGNAL_APP_ID` å’Œ `ONESIGNAL_REST_API_KEY`
2. ç¡®è®¤ç”¨æˆ·å·²è®¢é˜…æ¨é€ï¼ˆå‰ç«¯å·²åˆå§‹åŒ–ï¼‰
3. æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦æ­£ç¡®

**é—®é¢˜**: å‰ç«¯æœªæ”¶åˆ°æ¨é€
**è§£å†³**:
1. ç¡®è®¤æµè§ˆå™¨å…è®¸é€šçŸ¥æƒé™
2. æ£€æŸ¥OneSignal SDKæ˜¯å¦åŠ è½½æˆåŠŸ
3. ç¡®è®¤ç”¨æˆ·å·²ç™»å½•å¹¶è®¾ç½®external_user_id

### åˆ†æé—®é¢˜

**é—®é¢˜**: GA4æ•°æ®æœªä¸ŠæŠ¥
**è§£å†³**:
1. æ£€æŸ¥ Measurement ID æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤gtag.jså·²åŠ è½½
3. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹ç½‘ç»œè¯·æ±‚

**é—®é¢˜**: åç«¯ç»Ÿè®¡æ•°æ®ä¸ºç©º
**è§£å†³**: 
1. ç¡®è®¤å·²è°ƒç”¨è¿½è¸ªAPI
2. æ£€æŸ¥è¯·æ±‚æ˜¯å¦æˆåŠŸ
3. ç”Ÿäº§ç¯å¢ƒéœ€ä½¿ç”¨æ•°æ®åº“å­˜å‚¨

---

## ğŸ’° æˆæœ¬é¢„ä¼°

| æœåŠ¡ | å…è´¹é¢åº¦ | ä»˜è´¹ä»·æ ¼ | æœˆæˆæœ¬(1000ç”¨æˆ·) |
|------|---------|---------|-----------------|
| **Stripe** | æ— é™åˆ¶äº¤æ˜“ | 2.9% + $0.30/ç¬” | æŒ‰äº¤æ˜“æ”¶è´¹ |
| **PayPal** | æ— é™åˆ¶äº¤æ˜“ | 3.4% + $0.30/ç¬” | æŒ‰äº¤æ˜“æ”¶è´¹ |
| **æ”¯ä»˜å®** | - | 0.6%-1.2% | æŒ‰äº¤æ˜“æ”¶è´¹ |
| **å¾®ä¿¡æ”¯ä»˜** | - | 0.6% | æŒ‰äº¤æ˜“æ”¶è´¹ |
| **OneSignal** | 10,000ç”¨æˆ· | $9/æœˆèµ· | $0 (å…è´¹) |
| **GA4** | æ— é™åˆ¶ | å…è´¹ | $0 |

**æœˆåº¦æ€»æˆæœ¬**: $0 ~ $9 (ä¸å«äº¤æ˜“æ‰‹ç»­è´¹)

---

## ğŸš€ ä¸Šçº¿æ¸…å•

### æ”¯ä»˜æœåŠ¡
- [ ] è·å–æ‰€æœ‰æ”¯ä»˜æ¸ é“çš„ç”Ÿäº§ç¯å¢ƒå¯†é’¥
- [ ] é…ç½®ç”Ÿäº§ç¯å¢ƒå›è°ƒURL
- [ ] æµ‹è¯•æ¯ä¸ªæ”¯ä»˜æ¸ é“
- [ ] é…ç½®æ”¯ä»˜æˆåŠŸ/å¤±è´¥é¡µé¢
- [ ] å®ç°è®¢å•è®°å½•åŠŸèƒ½

### æ¨é€æœåŠ¡
- [ ] è·å–OneSignalç”Ÿäº§ç¯å¢ƒé…ç½®
- [ ] å‰ç«¯é›†æˆOneSignal SDK
- [ ] é…ç½®æ¨é€æ—¶é—´ç­–ç•¥
- [ ] æµ‹è¯•æ¨é€åˆ°è¾¾ç‡
- [ ] å®ç°æ¨é€å†å²è®°å½•

### æ•°æ®åˆ†æ
- [ ] åˆ›å»ºGA4ç”Ÿäº§ç¯å¢ƒåª’ä½“èµ„æº
- [ ] æ‰€æœ‰é¡µé¢é›†æˆGA4ä»£ç 
- [ ] é…ç½®å…³é”®äº‹ä»¶è¿½è¸ª
- [ ] è®¾ç½®è½¬åŒ–ç›®æ ‡
- [ ] é…ç½®æ•°æ®æŠ¥è¡¨

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼ŸæŸ¥çœ‹æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒï¼š
- Stripe: https://stripe.com/docs
- PayPal: https://developer.paypal.com/
- OneSignal: https://documentation.onesignal.com/
- GA4: https://support.google.com/analytics/

---

**å¼€å‘å®Œæˆæ—¶é—´**: 2025-11-20
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0

