# 服务安全性监控方案

## 📋 概述

本方案提供全面的服务安全性监控，包括攻击检测、异常行为监控、告警机制等，确保系统安全稳定运行。

## 🎯 监控目标

1. **实时检测安全威胁**：SQL 注入、XSS 攻击、暴力破解等
2. **异常行为识别**：可疑访问、频率异常、敏感操作等
3. **自动防护**：IP 封禁、频率限制、请求拦截
4. **告警通知**：及时通知安全事件，快速响应
5. **安全审计**：完整的安全事件日志，便于追溯

## 🏗️ 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    安全监控架构                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户请求                                                       │
│      ↓                                                          │
│  【安全中间件】SecurityMiddleware                               │
│      ├─ IP 封禁检查                                            │
│      ├─ 频率限制检查                                           │
│      ├─ SQL 注入检测                                           │
│      ├─ XSS 攻击检测                                           │
│      └─ 可疑访问检测                                           │
│      ↓                                                          │
│  【安全监控器】SecurityMonitor                                  │
│      ├─ 攻击模式检测                                           │
│      ├─ 异常行为分析                                           │
│      ├─ 事件记录                                               │
│      └─ 告警触发                                               │
│      ↓                                                          │
│  【告警管理器】AlertManager                                     │
│      ├─ 告警规则检查                                           │
│      ├─ 通知发送                                               │
│      └─ 告警历史                                               │
│      ↓                                                          │
│  【结构化日志】StructuredLogger                                 │
│      └─ 安全事件日志（JSON 格式）                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 🔍 监控内容

### 1. SQL 注入攻击检测

**检测模式**：
- `UNION SELECT` 组合
- `OR 1=1` 等逻辑注入
- `--` 注释注入
- `; DROP TABLE` 等命令注入
- `xp_cmdshell` 等存储过程调用

**响应措施**：
- 记录安全事件（严重程度：critical）
- 自动封禁 IP
- 触发告警通知
- 返回 400 错误

### 2. XSS 攻击检测

**检测模式**：
- `<script>` 标签
- `javascript:` 协议
- `onerror`、`onload` 等事件处理器
- `<iframe>` 标签
- `<img onerror>` 等

**响应措施**：
- 记录安全事件（严重程度：high）
- 触发告警通知
- 返回 400 错误

### 3. 暴力破解检测

**检测条件**：
- 5 分钟内失败登录尝试 ≥ 5 次

**响应措施**：
- 记录安全事件（严重程度：high）
- 触发告警通知
- 可选：自动封禁 IP

### 4. 频率限制检测

**检测条件**：
- 1 分钟内请求数 > 100 次（可配置）

**响应措施**：
- 记录安全事件（严重程度：medium）
- 返回 429 Too Many Requests
- 触发告警通知

### 5. 可疑访问检测

**检测端点**：
- `/admin`
- `/api/v1/admin`
- `/api/v1/internal`
- `/.env`
- `/config`
- `/debug`

**响应措施**：
- 记录安全事件（严重程度：medium）
- 触发告警通知

### 6. 敏感操作监控

**检测操作**：
- DELETE、UPDATE、DROP、ALTER、CREATE 等数据库操作

**响应措施**：
- 记录安全事件（严重程度：high）
- 触发告警通知
- 记录操作详情（用户、IP、时间等）

### 7. 数据库错误监控

**检测条件**：
- SQL 语法错误（可能是注入攻击）
- 数据库连接错误
- 权限错误

**响应措施**：
- 记录安全事件（严重程度：medium）
- 触发告警通知

## 🚨 告警机制

### 告警级别

| 级别 | 说明 | 响应时间 | 通知方式 |
|------|------|---------|---------|
| **critical** | 严重威胁（SQL 注入） | 立即 | 邮件 + 短信 + 钉钉 |
| **high** | 高风险（XSS、暴力破解） | 5 分钟内 | 邮件 + 钉钉 |
| **medium** | 中等风险（频率限制、可疑访问） | 15 分钟内 | 邮件 |
| **low** | 低风险（信息性） | 1 小时内 | 日志 |

### 告警规则

**自动告警规则**：
1. SQL 注入攻击 → critical
2. XSS 攻击 → high
3. 暴力破解 → high
4. 频率限制超出 → medium
5. 可疑访问 → medium
6. 敏感操作 → high
7. 数据库错误 → medium

**自定义告警规则**：
- 可通过 `AlertManager` 添加自定义规则
- 支持条件函数、持续时间、重复间隔等

### 通知渠道

**内置通知器**：
- 控制台通知（开发环境）
- 日志通知（所有环境）
- 文件通知（可选）

**扩展通知器**（需实现）：
- 邮件通知
- 短信通知
- 钉钉/企业微信通知
- Webhook 通知

## 📊 监控指标

### 实时指标

- **总安全事件数**：累计检测到的安全事件
- **事件类型分布**：按类型统计（SQL 注入、XSS 等）
- **严重程度分布**：按严重程度统计
- **封禁 IP 数量**：当前封禁的 IP 数量
- **封禁 IP 列表**：所有被封禁的 IP

### 历史统计

- **事件趋势**：按时间统计事件数量
- **攻击来源**：按 IP 统计攻击次数
- **攻击目标**：按端点统计攻击次数
- **告警历史**：所有告警记录

## 🔧 配置说明

### 环境变量

```bash
# 安全监控配置
SECURITY_MONITOR_ENABLED=true              # 是否启用安全监控
SECURITY_AUTO_BLOCK_ENABLED=true           # 是否自动封禁 IP
SECURITY_RATE_LIMIT_ENABLED=true           # 是否启用频率限制
SECURITY_RATE_LIMIT_THRESHOLD=100          # 频率限制阈值（请求/分钟）

# 告警配置
ALERT_EMAIL_ENABLED=false                  # 是否启用邮件告警
ALERT_EMAIL_RECIPIENTS=admin@example.com   # 告警邮件接收人
ALERT_DINGTALK_ENABLED=false               # 是否启用钉钉告警
ALERT_DINGTALK_WEBHOOK=                    # 钉钉 Webhook URL
```

### 中间件配置

在 `server/main.py` 中启用安全中间件：

```python
from server.middleware.security_middleware import SecurityMiddleware
from server.core.rate_limiter import RateLimiter

# 创建限流器
rate_limiter = RateLimiter.get("api", rate=100)  # 每秒100次

# 添加安全中间件
app.add_middleware(SecurityMiddleware, rate_limiter=rate_limiter)
```

## 📡 API 接口

### 获取安全统计

```bash
GET /api/v1/security/stats

响应：
{
  "total_events": 150,
  "events_by_type": {
    "sql_injection": 5,
    "xss_attack": 10,
    "brute_force": 3,
    "rate_limit_exceeded": 50,
    "suspicious_access": 82
  },
  "events_by_severity": {
    "critical": 5,
    "high": 13,
    "medium": 132
  },
  "blocked_ips_count": 2,
  "blocked_ips": ["192.168.1.100", "10.0.0.50"]
}
```

### 获取封禁 IP 列表

```bash
GET /api/v1/security/blocked-ips

响应：
{
  "blocked_ips": ["192.168.1.100", "10.0.0.50"],
  "count": 2
}
```

### 解封 IP

```bash
POST /api/v1/security/unblock-ip
Content-Type: application/json

{
  "ip": "192.168.1.100"
}

响应：
{
  "success": true,
  "message": "IP 192.168.1.100 已解封"
}
```

### 检查 IP 状态

```bash
GET /api/v1/security/check-ip/{ip}

响应：
{
  "ip": "192.168.1.100",
  "blocked": false,
  "status": "allowed"
}
```

## 📝 日志格式

### 安全事件日志

```json
{
  "timestamp": "2025-12-18T17:20:00.000Z",
  "level": "ERROR",
  "logger": "security_monitor",
  "message": "[安全事件] sql_injection: 检测到 SQL 注入攻击模式: (\\bUNION\\b.*\\bSELECT\\b)",
  "event_type": "sql_injection",
  "severity": "critical",
  "source_ip": "192.168.1.100",
  "endpoint": "/api/v1/bazi/calculate",
  "service": "hifate-bazi",
  "host": "node1"
}
```

## 🔄 集成步骤

### 1. 启用安全监控

在 `server/main.py` 中：

```python
# 导入安全监控模块
from server.observability.security_monitor import get_security_monitor
from server.middleware.security_middleware import SecurityMiddleware
from server.core.rate_limiter import RateLimiter

# 创建限流器
rate_limiter = RateLimiter.get("api", rate=100)

# 添加安全中间件
app.add_middleware(SecurityMiddleware, rate_limiter=rate_limiter)

# 初始化安全监控器（自动初始化）
security_monitor = get_security_monitor()
```

### 2. 注册安全监控 API

在 `server/main.py` 的 `_register_all_routers_to_manager()` 中：

```python
from server.api.v1.security_monitor import router as security_monitor_router

router_manager.register_router(
    "security_monitor",
    lambda: security_monitor_router,
    prefix="/api/v1",
    tags=["安全监控"]
)
```

### 3. 配置告警通知

```python
from server.observability.alert_manager import AlertManager, log_notifier

# 获取告警管理器
alert_manager = AlertManager.get_instance()

# 添加日志通知器
alert_manager.add_notifier(log_notifier)

# 启动告警检查
alert_manager.start(check_interval=30)
```

## 📈 监控仪表板（建议）

### Grafana 仪表板配置

**指标查询**：
- 安全事件总数：`sum(security_events_total)`
- SQL 注入事件：`sum(security_events_total{type="sql_injection"})`
- 封禁 IP 数量：`count(security_blocked_ips)`

**告警规则**：
- SQL 注入攻击：`rate(security_events_total{type="sql_injection"}[5m]) > 0`
- 频率限制超出：`rate(security_events_total{type="rate_limit_exceeded"}[5m]) > 10`

## ✅ 检查清单

### 部署前检查

- [ ] 安全监控模块已创建
- [ ] 安全中间件已集成
- [ ] 安全监控 API 已注册
- [ ] 告警管理器已配置
- [ ] 环境变量已配置
- [ ] 日志输出已配置

### 运行检查

- [ ] 安全监控器正常工作
- [ ] 安全中间件正常拦截
- [ ] 告警通知正常发送
- [ ] 日志正常记录
- [ ] API 接口正常访问

## 🚨 应急响应

### 发现攻击时

1. **立即响应**
   - 查看安全事件日志
   - 确认攻击类型和来源 IP
   - 检查是否已自动封禁

2. **手动封禁**（如需要）
   ```bash
   # 通过 API 查看封禁列表
   curl http://localhost:8001/api/v1/security/blocked-ips
   
   # 手动封禁（需要实现）
   # 或直接修改代码添加 IP 到封禁列表
   ```

3. **分析攻击**
   - 查看攻击模式
   - 分析攻击目标
   - 评估影响范围

4. **修复漏洞**（如发现）
   - 修复代码漏洞
   - 更新安全规则
   - 重新部署

5. **记录和复盘**
   - 记录攻击详情
   - 分析根本原因
   - 更新安全策略

## 📚 相关文件

| 文件 | 用途 |
|------|------|
| `server/observability/security_monitor.py` | 安全监控核心模块 |
| `server/middleware/security_middleware.py` | 安全中间件 |
| `server/api/v1/security_monitor.py` | 安全监控 API |
| `server/observability/alert_manager.py` | 告警管理器 |
| `server/observability/structured_logger.py` | 结构化日志 |
| `server/core/rate_limiter.py` | 频率限制器 |

## 🔒 安全最佳实践

1. **定期审查**：每周审查安全事件日志
2. **规则更新**：根据新威胁更新检测规则
3. **IP 白名单**：为可信 IP 添加白名单
4. **日志保留**：保留至少 30 天的安全日志
5. **告警优化**：根据实际情况调整告警阈值
6. **应急演练**：定期进行安全应急演练

---

**核心要点**：
- **实时监控**：所有请求都经过安全检查
- **自动防护**：严重攻击自动封禁 IP
- **完整日志**：所有安全事件都有详细日志
- **及时告警**：严重事件立即告警通知
- **可追溯性**：所有安全事件可追溯和分析

