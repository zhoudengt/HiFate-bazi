# 数据库连接规范

## 核心原则

为了保证数据一致性，所有环境（生产、开发）统一连接生产Node1 Docker MySQL和MongoDB。

**重要说明**：
- **仅数据库连接生产**：所有环境的数据库连接统一指向生产Node1 Docker MySQL和MongoDB
- **代码开发流程不变**：代码开发必须遵循正规流程：本地开发 → Git提交 → 增量部署到双机
- **禁止直接在生产服务器开发**：严禁在生产服务器上直接修改代码，必须通过Git版本控制和增量部署

## 数据库连接信息

### Node1 Docker MySQL

- **公网地址**: `8.210.52.217:3306`（本地开发使用）
- **私网地址**: `172.18.121.222:3306`（生产环境使用）
- **用户名**: `root`
- **密码**: `Yuanqizhan@163`
- **数据库**: `hifate_bazi`

### Node1 Docker MongoDB

- **公网地址**: `8.210.52.217:27017`（本地开发使用）
- **私网地址**: `172.18.121.222:27017`（生产环境使用）
- **数据库**: `bazi_feedback`
- **认证**: 默认无认证（如需要认证，通过环境变量配置）

## 环境变量配置

### 本地开发环境

```bash
# MySQL配置
MYSQL_HOST=8.210.52.217  # Node1 公网IP
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=Yuanqizhan@163
MYSQL_DATABASE=hifate_bazi

# MongoDB配置
MONGO_HOST=8.210.52.217  # Node1 公网IP
MONGO_PORT=27017
MONGO_DB=bazi_feedback
```

### 生产环境（Node1/Node2）

```bash
# MySQL配置
MYSQL_HOST=172.18.121.222  # Node1 内网IP
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=Yuanqizhan@163
MYSQL_DATABASE=hifate_bazi

# MongoDB配置
MONGO_HOST=172.18.121.222  # Node1 内网IP
MONGO_PORT=27017
MONGO_DB=bazi_feedback
```

## 代码开发流程

### 标准流程

```
1. 本地开发（连接生产数据库）
   ↓
2. 本地测试验证
   ↓
3. 提交到Git（git commit）
   ↓
4. 推送到GitHub（git push）
   ↓
5. 增量部署到双机（使用增量部署脚本）
   ↓
6. 验证部署结果
```

### 禁止操作

| 操作 | 状态 | 原因 | 正确方式 |
|------|------|------|---------|
| ❌ **直接在服务器上修改代码** | **禁止** | 破坏代码一致性，无法版本控制 | 本地修改 → Git → 部署 |
| ❌ **直接在服务器上修改配置文件** | **禁止** | 配置不一致，难以追踪 | 本地修改 → Git → 部署 |
| ❌ **在服务器上手动编辑文件** | **禁止** | 无法版本控制，容易丢失 | 本地修改 → Git → 部署 |
| ❌ **跳过Git直接部署** | **禁止** | 无法追踪变更，无法回滚 | 必须通过Git版本控制 |
| ❌ **修改数据库连接配置** | **禁止** | 破坏数据一致性 | 统一使用生产数据库 |

## 修改连接配置（仅限特殊情况）

只有在以下特殊情况下才允许修改数据库连接配置：

1. **数据库迁移**：需要迁移到新的数据库服务器
2. **测试环境**：需要创建独立的测试数据库
3. **紧急故障**：生产数据库故障，需要临时切换到备用数据库

**修改流程**：
1. 明确修改理由和影响范围
2. 更新所有相关配置文件
3. 更新开发规范文档
4. 通知所有开发人员
5. 验证连接正常

## 安全注意事项

1. **访问控制**：确保生产数据库有适当的访问控制和安全措施
2. **密码管理**：数据库密码通过环境变量配置，不要硬编码在代码中
3. **网络隔离**：生产数据库应该配置防火墙，限制访问来源
4. **备份机制**：确保生产数据库有定期备份机制
5. **权限管理**：开发环境可能需要只读权限，避免误操作

## 性能考虑

1. **网络延迟**：开发环境连接远程数据库可能有延迟，需要评估影响
2. **连接池配置**：合理配置连接池参数，避免连接数过多
3. **查询优化**：开发时注意查询性能，避免影响生产数据库性能

## 相关文档

- [环境变量配置规范](../.cursorrules#环境变量配置规范)
- [代码修改流程规范](../.cursorrules#代码修改流程规范)
- [部署规范](deployment.md)






