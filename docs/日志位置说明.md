# 日志位置说明 - 八字、十神、大运、流年等信息在哪里

## 📊 **数据流和日志分布**

```
用户输入："2029年适合投资吗？"
          ↓
┌─────────────────────────────────────────────┐
│  步骤1：Intent识别（LLM）                    │
│  日志：logs/intent_service.log              │
│  内容：时间意图、事项意图                     │
└─────────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────────┐
│  步骤2：八字计算                             │
│  日志：标准输出（terminal/进程日志）          │
│  内容：四柱、日主、十神                       │
└─────────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────────┐
│  步骤3：流年大运计算                         │
│  日志：标准输出（terminal/进程日志）          │
│  内容：流年干支、大运、喜忌神、旺衰            │
└─────────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────────┐
│  步骤4：传递给最终LLM                        │
│  日志：标准输出（terminal/进程日志）          │
│  内容：完整JSON数据（包含上述所有信息）        │
└─────────────────────────────────────────────┘
```

---

## 📂 **日志文件位置**

### **1. Intent识别日志**

**文件**：`logs/intent_service.log`

**包含内容**：
- 用户问题
- Intent LLM识别结果（JSON）
- 时间意图（`target_years`）
- 事项意图（`intents`）

**查看命令**：
```bash
tail -f logs/intent_service.log
```

**示例输出**：
```
🔍🔍🔍...
[Intent LLM] 输入识别
用户问题: 2029年适合投资吗？

✅✅✅...
[Intent LLM] 识别结果
{
  "is_fortune_related": true,
  "intents": ["wealth"],
  "time_intent": {
    "type": "specific_year",
    "target_years": [2029],
    "description": "2029年"
  }
}
```

---

### **2. 主服务日志（八字、流年、大运等）**

**⚠️ 重要**：这些日志打印到**标准输出（stdout）**，不是文件！

**查看方式**：

#### **方法1：直接在启动终端查看**

如果您是手动启动的服务：
```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
.venv/bin/python -m uvicorn server.main:app --host 0.0.0.0 --port 8001
```

所有日志会直接打印在终端中，包括：
- ✅ `[STEP1] Intent识别完成`
- ✅ `[STEP2] 八字计算完成`
- ✅ `[STEP4] Fortune Context完成`
- ✅ `[STEP5] 传递给最终LLM的完整数据`

#### **方法2：后台启动并重定向到文件**

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
.venv/bin/python -m uvicorn server.main:app --host 0.0.0.0 --port 8001 2>&1 | tee logs/main_service.log
```

这样日志会同时：
- 打印到终端
- 写入到 `logs/main_service.log`

然后查看：
```bash
tail -f logs/main_service.log
```

#### **方法3：只输出到文件**

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
.venv/bin/python -m uvicorn server.main:app --host 0.0.0.0 --port 8001 > logs/main_service.log 2>&1 &
```

查看：
```bash
tail -f logs/main_service.log
```

---

## 🔍 **查看详细信息**

### **八字信息（STEP2）**

**位置**：主服务标准输出

**搜索命令**：
```bash
grep -A 15 "STEP2.*八字计算完成" logs/main_service.log
```

**示例输出**：
```
================================================================================
[STEP2] 八字计算完成
================================================================================
出生日期: 1990-05-15 14:00
性别: male
八字四柱:
  year: 庚 午 (金火)
  month: 辛 巳 (金火)
  day: 壬 午 (水火)
  hour: 丁 未 (火土)
日主: 壬
十神: {"年干": "偏印", "年支": "正财", "月干": "劫财", ...}
================================================================================
```

---

### **流年大运信息（STEP4）**

**位置**：主服务标准输出

**搜索命令**：
```bash
grep -A 25 "STEP4.*Fortune Context完成" logs/main_service.log
```

**示例输出**：
```
================================================================================
[STEP4] Fortune Context完成
================================================================================
返回流年数量: 1
流年列表: ['2029年己酉']
  - 2029年: 己酉 | 十神=偏印 | 五行=土金
大运: 甲申 (18-27岁)
喜忌神: xi=['水', '木'] | ji=['火', '土']
五行平衡: {"木": 0, "火": 4, "土": 1, "金": 3, "水": 1}
旺衰: 偏弱
================================================================================
```

---

### **传递给最终LLM的完整数据（STEP5）**

**位置**：主服务标准输出

**搜索命令**：
```bash
grep -A 60 "STEP5.*传递给最终LLM" logs/main_service.log
```

**示例输出**：
```
🎯🎯🎯...
[STEP5] 传递给最终LLM的完整数据
🎯🎯🎯...
用户问题: 2029年适合投资吗？
意图: wealth
流年年份: 2029
流年干支: 己酉
流年十神: 偏印
大运干支: 甲申 (18-27岁)
喜神: ['水', '木']
忌神: ['火', '土']
旺衰: 偏弱

📦 完整JSON数据:
{
  "intent": "wealth",
  "question": "2029年适合投资吗？",
  "bazi": {
    "pillars": {...},
    "day_stem": "壬",
    "shishen": {...}
  },
  "liunian": {
    "year": 2029,
    "stem": "己",
    "branch": "酉",
    "stem_shishen": "偏印",
    ...
  },
  "dayun": {
    "stem": "甲",
    "branch": "申",
    "age_start": 18,
    "age_end": 27
  },
  "xi_ji": {
    "xi_shen": ["水", "木"],
    "ji_shen": ["火", "土"]
  },
  "wangshuai": "偏弱"
}
🎯🎯🎯...
```

---

## 🚀 **推荐的启动方式（查看完整日志）**

### **启动脚本**

创建 `start_with_logs.sh`：

```bash
#!/bin/bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi

# 启动Intent Service
echo "启动 Intent Service..."
.venv/bin/python3 services/intent_service/grpc_server.py > logs/intent_service.log 2>&1 &
echo "Intent Service PID: $!"

# 等待2秒
sleep 2

# 启动主服务（输出到文件并在终端显示）
echo "启动主服务..."
.venv/bin/python -m uvicorn server.main:app \
  --host 0.0.0.0 \
  --port 8001 \
  2>&1 | tee logs/main_service.log
```

使用：
```bash
chmod +x start_with_logs.sh
./start_with_logs.sh
```

这样您就能在终端实时看到所有日志！

---

### **查看日志脚本**

创建 `view_logs.sh`：

```bash
#!/bin/bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi

echo "======================================"
echo "实时监控所有日志"
echo "======================================"
echo ""
echo "按 Ctrl+C 停止"
echo ""

# 同时监控两个日志文件
tail -f logs/intent_service.log logs/main_service.log
```

使用：
```bash
chmod +x view_logs.sh
./view_logs.sh
```

---

## 📋 **快速查找数据**

### **查找八字信息**

```bash
# 查找最近的八字计算
grep -A 15 "八字计算完成" logs/main_service.log | tail -20
```

### **查找十神信息**

```bash
# 十神信息在八字计算结果中
grep "十神:" logs/main_service.log
```

### **查找流年信息**

```bash
# 查找流年列表
grep "流年列表:" logs/main_service.log

# 查找某个特定年份
grep "2029年" logs/main_service.log
```

### **查找大运信息**

```bash
# 查找大运
grep "大运:" logs/main_service.log
```

### **查找喜忌神**

```bash
# 查找喜忌神
grep "喜忌神:" logs/main_service.log
```

### **查找旺衰**

```bash
# 查找旺衰
grep "旺衰:" logs/main_service.log
```

---

## 🎯 **当前服务日志位置**

根据您当前的启动方式：

| 服务 | 日志位置 | 查看命令 |
|------|---------|---------|
| Intent Service | `logs/intent_service.log` | `tail -f logs/intent_service.log` |
| 主服务 | **标准输出**（终端） | 需要在启动终端查看 |

**⚠️ 建议**：使用上面的启动脚本，将主服务日志重定向到 `logs/main_service.log`

---

## 🔧 **修改日志输出位置**

如果您想把主服务日志永久输出到文件，修改启动命令：

**当前启动方式**（之前的命令）：
```bash
.venv/bin/python -m uvicorn server.main:app --host 0.0.0.0 --port 8001 > logs/server_8001.log 2>&1 &
```

但是这个命令启动失败了（端口被占用），所以日志只有错误信息。

**正确的方式**：
1. 先停止占用8001端口的进程
2. 重新启动并指定日志文件

```bash
# 停止旧进程
lsof -ti :8001 | xargs kill -9

# 重新启动
cd /Users/zhoudt/Downloads/project/HiFate-bazi
.venv/bin/python -m uvicorn server.main:app \
  --host 0.0.0.0 \
  --port 8001 \
  > logs/main_service.log 2>&1 &

# 查看日志
tail -f logs/main_service.log
```

---

## ✅ **总结**

**所有数据打印位置**：

| 数据类型 | 日志位置 | 当前状态 |
|---------|---------|---------|
| **Intent识别** | `logs/intent_service.log` | ✅ 正常输出到文件 |
| **八字四柱** | 主服务标准输出 | ⚠️ 在终端显示 |
| **十神** | 主服务标准输出 | ⚠️ 在终端显示 |
| **流年** | 主服务标准输出 | ⚠️ 在终端显示 |
| **大运** | 主服务标准输出 | ⚠️ 在终端显示 |
| **喜忌神** | 主服务标准输出 | ⚠️ 在终端显示 |
| **旺衰** | 主服务标准输出 | ⚠️ 在终端显示 |
| **完整JSON** | 主服务标准输出 | ⚠️ 在终端显示 |

**建议操作**：

1. 停止当前的主服务进程
2. 使用重定向启动：`... > logs/main_service.log 2>&1 &`
3. 查看日志：`tail -f logs/main_service.log`

这样所有信息就都能保存到文件并查看了！

