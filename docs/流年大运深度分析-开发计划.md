# æµå¹´å¤§è¿æ·±åº¦åˆ†æ - å¼€å‘è®¡åˆ’

> ğŸ“… **åˆ›å»ºæ—¶é—´**ï¼š2025-11-24  
> ğŸ¯ **ç›®æ ‡**ï¼šåŸºäºç°æœ‰åŠŸèƒ½ï¼Œå¢å¼ºæµå¹´å¤§è¿åˆ†ææ·±åº¦ï¼Œç»“åˆå…«å­—åŸå±€ã€å–œå¿Œç¥ã€äº”è¡Œå¹³è¡¡  
> ğŸ’¡ **åŸåˆ™**ï¼šä¼˜å…ˆå¤ç”¨ç°æœ‰æ¨¡å—ï¼Œæœ€å°åŒ–å¼€å‘ï¼Œå¾®æœåŠ¡è®¾è®¡

---

## ğŸ“‹ ç›®å½•

- [éœ€æ±‚åˆ†æ](#éœ€æ±‚åˆ†æ)
- [ç°æœ‰åŠŸèƒ½ç›˜ç‚¹](#ç°æœ‰åŠŸèƒ½ç›˜ç‚¹)
- [å¼€å‘ä»»åŠ¡](#å¼€å‘ä»»åŠ¡)
- [å®ç°æ–¹æ¡ˆ](#å®ç°æ–¹æ¡ˆ)
- [APIè®¾è®¡](#apiè®¾è®¡)
- [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)

---

## ğŸ¯ éœ€æ±‚åˆ†æ

### ç”¨æˆ·åé¦ˆ

> "æ„Ÿè§‰åªç”¨äº†æµå¹´ï¼Œæ²¡æœ‰ç”¨å¤§è¿çš„æ•°æ®ï¼Œè€Œä¸”æµå¹´éƒ½æ˜¯æ­»çš„ï¼Œè¦ç»“åˆè‡ªå·±çš„å¤§è¿ã€å…«å­—æ‰èƒ½æ‹†è§£å‡ºè‡ªå·±çš„å‘½è¿å§"

### é—®é¢˜åˆ†æ

**å½“å‰åˆ†æï¼ˆæµ…å±‚ï¼‰**ï¼š
```
2027å¹´æµå¹´ä¸æœªï¼Œå¤§è¿ä¸™åˆ
ğŸ’° è§åè´¢ï¼Œæœ‰æŠ•èµ„æœºä¼š
```
**é—®é¢˜**ï¼š
1. âŒ åªçœ‹æµå¹´å¤©å¹²åç¥ï¼Œæ²¡æœ‰æ·±åº¦ç»“åˆå¤§è¿
2. âŒ åˆ†ææ˜¯"æ­»çš„"ï¼ˆé€šç”¨çš„ï¼‰ï¼Œæ‰€æœ‰æ—¥ä¸»æˆŠçš„äººçœ‹åˆ°çš„éƒ½ä¸€æ ·
3. âŒ æ²¡æœ‰è€ƒè™‘å…«å­—åŸå±€çš„äº”è¡Œå¼ºå¼±
4. âŒ æ²¡æœ‰è€ƒè™‘ç”¨ç¥ã€å–œç¥ã€å¿Œç¥
5. âŒ æ²¡æœ‰åˆ†ææµå¹´+å¤§è¿+å…«å­—çš„ç»¼åˆç”Ÿå…‹å…³ç³»

**åº”è¯¥çš„åˆ†æï¼ˆæ·±å±‚ï¼‰**ï¼š
```
ã€å…«å­—åŸå±€ã€‘
æ—¥ä¸»ï¼šæˆŠåœŸ
äº”è¡Œï¼šé‡‘1 ç«1 åœŸ3 æœ¨3ï¼ˆåœŸæ—ºç¼ºæ°´ï¼‰
å–œç¥ï¼šæ°´ã€æœ¨ï¼ˆåœŸå¤ªæ—ºéœ€å…‹æ³„ï¼‰â­ ç”¨WangShuaiAnalyzer
å¿Œç¥ï¼šç«ã€åœŸï¼ˆå†æ—ºå°±è¿‡äº†ï¼‰

ã€2027å¹´æµå¹´ä¸æœª + å¤§è¿ä¸™åˆã€‘
æµå¹´ï¼šä¸ç«ç”ŸæœªåœŸ
å¤§è¿ï¼šä¸™ç«ç”Ÿåˆç«
ç»¼åˆï¼šç«åœŸä¸¤æ—º â­ æ–°å¢äº”è¡Œå¹³è¡¡åˆ†æ

ã€äº”è¡ŒåŠ¨æ€å¹³è¡¡ã€‘â­ æ–°å¢
å…«å­—åŸå±€ï¼šé‡‘1 ç«1 åœŸ3 æœ¨3 æ°´0
+ æµå¹´ä¸æœªï¼šç«1 åœŸ1
+ å¤§è¿ä¸™åˆï¼šç«2
= ç»¼åˆï¼šé‡‘1 ç«4 åœŸ4 æœ¨3 æ°´0
â†’ ç«åœŸè¿‡æ—ºï¼Œæ°´æœ¨ä¸è¶³

ã€ç”Ÿå…‹å…³ç³»ã€‘â­ æ–°å¢
æµå¹´ä¸ç« vs å¤§è¿ä¸™ç«ï¼šæ¯”åŠ«å¹¶è§ï¼Œç«äº‰æ¿€çƒˆ
æµå¹´æœªåœŸ vs å¤§è¿åˆç«ï¼šåˆæœªç›¸åˆï¼Œç«åœŸæ›´æ—º
æµå¹´æœªåœŸ vs æ—¥æ”¯è¾°åœŸï¼šè¾°æœªç›¸ç ´ï¼Œä¸å‰ â­ ç”¨relations.py

ã€å–œå¿Œåˆ†æã€‘â­ ç”¨WangShuaiAnalyzer
æµå¹´ä¸ç« = åå°ï¼ˆå¿Œç¥ï¼Œèº«æ—ºä¸å®œå†ç”Ÿï¼‰
æµå¹´æœªåœŸ = æ¯”è‚©ï¼ˆå¿Œç¥ï¼Œèº«æ—ºä¸å®œå†æ—ºï¼‰
å¤§è¿ä¸™ç« = æ­£å°ï¼ˆå¿Œç¥ï¼‰
â†’ æµå¹´å¤§è¿éƒ½æ˜¯å¿Œç¥ï¼Œä¸åˆ©

ã€ç»¼åˆç»“è®ºã€‘
âŒ 2027å¹´è´¢è¿ä¸€èˆ¬ï¼ˆåœŸæ—ºå…‹æ°´ï¼Œæ°´=è´¢æ˜Ÿï¼›å¿Œç¥å½“ä»¤ï¼‰
âœ… å­¦ä¹ ã€è€ƒè¯æœ‰åˆ©ï¼ˆå°æ˜Ÿæ—ºï¼‰
âš ï¸ æ³¨æ„å¥åº·ï¼ˆåœŸæ—ºå…‹æ°´ï¼Œæ°´=è‚¾ã€æ³Œå°¿ç³»ç»Ÿï¼‰
âš ï¸ é¿å…æŠ•èµ„ï¼ˆå¿Œç¥å¹´ï¼Œä¸å®œå†’é™©ï¼‰
```

---

## ğŸ” ç°æœ‰åŠŸèƒ½ç›˜ç‚¹

### âœ… å·²æœ‰åŠŸèƒ½ï¼ˆå¯ç›´æ¥å¤ç”¨ï¼‰

| åŠŸèƒ½ | ä½ç½® | çŠ¶æ€ | å¤ç”¨æ–¹å¼ |
|------|------|------|----------|
| **å¤©å¹²åœ°æ”¯å…³ç³»** | `src/data/relations.py` | âœ… å®Œå–„ | ç›´æ¥å¯¼å…¥ä½¿ç”¨ |
| **äº”è¡Œå±æ€§** | `src/data/constants.py` | âœ… å®Œå–„ | ç›´æ¥å¯¼å…¥ä½¿ç”¨ |
| **äº”è¡Œç”Ÿå…‹å…³ç³»** | `ELEMENT_RELATIONS` | âœ… å®Œå–„ | ç›´æ¥å¯¼å…¥ä½¿ç”¨ |
| **åç¥è®¡ç®—** | `WenZhenBazi.get_main_star()` | âœ… å®Œå–„ | è°ƒç”¨ç°æœ‰æ–¹æ³• |
| **å¤§è¿æµå¹´æ•°æ®** | `BaziDetailService` | âœ… å®Œå–„ | è°ƒç”¨APIè·å– |
| **å–œç¥å¿Œç¥åˆ†æ** | `WangShuaiAnalyzer` | âœ… å®Œå–„ | â­ **å…³é”®å¤ç”¨** |
| **æµå¹´å¤§è¿ä¸Šä¸‹æ–‡** | `FortuneContextService` | âœ… å·²æœ‰ | å¢å¼ºæ­¤æœåŠ¡ |

### âŒ ç¼ºå¤±åŠŸèƒ½ï¼ˆéœ€è¦å¼€å‘ï¼‰

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|--------|------|
| **äº”è¡ŒåŠ¨æ€å¹³è¡¡åˆ†æ** | ğŸ”´ é«˜ | ä¸­ | è®¡ç®—ï¼šå…«å­—+æµå¹´+å¤§è¿çš„ç»¼åˆäº”è¡Œ |
| **æµå¹´å¤§è¿å…³ç³»åˆ†æ** | ğŸ”´ é«˜ | ä¸­ | æµå¹´vså¤§è¿vså…«å­—çš„ç”Ÿå…‹å†²åˆ |
| **å–œå¿Œç¥ä¸æµå¹´å¤§è¿åŒ¹é…** | ğŸ”´ é«˜ | å° | åˆ¤æ–­æµå¹´/å¤§è¿æ˜¯ç”¨ç¥/å¿Œç¥ |

---

## ğŸ“¦ å¼€å‘ä»»åŠ¡

### ä»»åŠ¡1ï¼šäº”è¡ŒåŠ¨æ€å¹³è¡¡åˆ†ææ¨¡å—ï¼ˆæ–°å»ºï¼‰

**ä½ç½®**ï¼š`src/analyzers/wuxing_balance_analyzer.py`

**åŠŸèƒ½**ï¼š
- è®¡ç®—å…«å­—åŸå±€äº”è¡Œç»Ÿè®¡
- è®¡ç®—æµå¹´äº”è¡Œ
- è®¡ç®—å¤§è¿äº”è¡Œ
- ç»¼åˆç»Ÿè®¡ï¼šå…«å­— + æµå¹´ + å¤§è¿
- åˆ¤æ–­ï¼šå“ªä¸ªäº”è¡Œè¿‡æ—º/è¿‡å¼±

**è¾“å…¥**ï¼š
```python
{
    "bazi_elements": {"é‡‘": 1, "æœ¨": 3, "æ°´": 0, "ç«": 1, "åœŸ": 3},
    "liunian": {"stem": "ä¸", "branch": "æœª"},
    "dayun": {"stem": "ä¸™", "branch": "åˆ"}
}
```

**è¾“å‡º**ï¼š
```python
{
    "bazi_elements": {"é‡‘": 1, "æœ¨": 3, "æ°´": 0, "ç«": 1, "åœŸ": 3},
    "liunian_elements": {"ç«": 1, "åœŸ": 1},
    "dayun_elements": {"ç«": 2},
    "combined_elements": {"é‡‘": 1, "æœ¨": 3, "æ°´": 0, "ç«": 4, "åœŸ": 4},
    "analysis": {
        "strong_elements": ["ç«", "åœŸ"],  # è¿‡æ—º
        "weak_elements": ["æ°´"],          # è¿‡å¼±
        "balanced_elements": ["é‡‘", "æœ¨"]
    }
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… å¤ç”¨ `STEM_ELEMENTS`, `BRANCH_ELEMENTS`
- âœ… åœ°æ”¯äº”è¡Œæƒé‡ï¼šæœ¬æ°”ä¸ºä¸»ï¼ˆå¦‚åˆç«=2ï¼Œå·³ç«=1.5ï¼‰

---

### ä»»åŠ¡2ï¼šæµå¹´å¤§è¿å…³ç³»åˆ†ææ¨¡å—ï¼ˆæ–°å»ºï¼‰

**ä½ç½®**ï¼š`src/analyzers/fortune_relation_analyzer.py`

**åŠŸèƒ½**ï¼š
- æµå¹´å¤©å¹² vs å¤§è¿å¤©å¹²ï¼ˆç”Ÿ/å…‹/å†²/åˆï¼‰
- æµå¹´åœ°æ”¯ vs å¤§è¿åœ°æ”¯ï¼ˆç”Ÿ/å…‹/å†²/åˆ/åˆ‘/å®³/ç ´ï¼‰
- æµå¹´ vs å…«å­—å››æŸ±ï¼ˆå†²å¤ªå²ã€å†²æ—¥æŸ±ç­‰ï¼‰
- å¤§è¿ vs å…«å­—å››æŸ±

**è¾“å…¥**ï¼š
```python
{
    "bazi_pillars": {...},
    "liunian": {"stem": "ä¸", "branch": "æœª"},
    "dayun": {"stem": "ä¸™", "branch": "åˆ"}
}
```

**è¾“å‡º**ï¼š
```python
{
    "liunian_dayun_relation": {
        "stem_relation": "æ¯”åŠ«å¹¶è§ï¼ˆä¸ä¸™éƒ½æ˜¯ç«ï¼‰",
        "branch_relation": "åˆæœªç›¸åˆï¼ˆç«åœŸæ›´æ—ºï¼‰"
    },
    "liunian_bazi_relation": {
        "vs_day_pillar": "è¾°æœªç›¸ç ´ï¼ˆæµå¹´æœªvsæ—¥æ”¯è¾°ï¼‰",
        "vs_year_pillar": "æ— ç‰¹æ®Šå…³ç³»",
        ...
    },
    "dayun_bazi_relation": {
        "vs_day_pillar": "åˆè¾°ç›¸ç”Ÿï¼ˆå¤§è¿åˆç«ç”Ÿæ—¥æ”¯è¾°åœŸï¼‰",
        ...
    },
    "summary": "æµå¹´å¤§è¿ç«åœŸä¸¤æ—ºï¼Œä¸æ—¥æŸ±æœ‰ç ´ï¼Œéœ€æ³¨æ„èº«ä½“å’Œäººé™…å…³ç³»"
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… å¤ç”¨ `src/data/relations.py`ï¼ˆBRANCH_CHONG, BRANCH_LIUHE, BRANCH_XING, BRANCH_HAI, BRANCH_POï¼‰
- âœ… å¤ç”¨ `ELEMENT_RELATIONS`ï¼ˆäº”è¡Œç”Ÿå…‹ï¼‰
- âœ… å¤ç”¨ `STEM_HE`ï¼ˆå¤©å¹²åˆï¼‰

---

### ä»»åŠ¡3ï¼šå¢å¼ºFortuneContextServiceï¼ˆä¿®æ”¹ç°æœ‰ï¼‰

**ä½ç½®**ï¼š`server/services/fortune_context_service.py`

**å¢å¼ºåŠŸèƒ½**ï¼š
1. è°ƒç”¨ `WangShuaiAnalyzer` è·å–å–œå¿Œç¥
2. è°ƒç”¨ `WuxingBalanceAnalyzer` è·å–äº”è¡Œå¹³è¡¡
3. è°ƒç”¨ `FortuneRelationAnalyzer` è·å–å…³ç³»åˆ†æ
4. ç»¼åˆç”Ÿæˆæ·±åº¦åˆ†ææ–‡æœ¬

**ä¿®æ”¹æ–¹æ³•**ï¼š
```python
@staticmethod
def get_fortune_context(
    bazi_info: dict,
    user_question: str,
    intent: str,
    day_stem: str,
    # â­ æ–°å¢å‚æ•°
    solar_date: str,  # ç”¨äºWangShuaiAnalyzer
    solar_time: str,
    gender: str
) -> dict:
    """
    å¢å¼ºç‰ˆï¼šè·å–æ·±åº¦æµå¹´å¤§è¿åˆ†æ
    
    æ–°å¢æ­¥éª¤ï¼š
    1. è°ƒç”¨WangShuaiAnalyzerè·å–å–œå¿Œç¥
    2. è°ƒç”¨WuxingBalanceAnalyzerè®¡ç®—äº”è¡Œå¹³è¡¡
    3. è°ƒç”¨FortuneRelationAnalyzeråˆ†æå…³ç³»
    4. ç»¼åˆç”Ÿæˆæ·±åº¦åˆ†æ
    """
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```python
{
    "liunian_list": [...],
    "dayun": {...},
    "fortune_summary": """
ã€å…«å­—åŸå±€ã€‘
æ—¥ä¸»ï¼šæˆŠåœŸï¼ˆåœŸæ—ºï¼‰
äº”è¡Œï¼šé‡‘1 ç«1 åœŸ3 æœ¨3 æ°´0
å–œç¥ï¼šæ°´ã€æœ¨ | å¿Œç¥ï¼šç«ã€åœŸ

ã€2027å¹´æµå¹´ä¸æœª + å¤§è¿ä¸™åˆã€‘
äº”è¡Œå¹³è¡¡ï¼šé‡‘1 ç«4 åœŸ4 æœ¨3 æ°´0ï¼ˆç«åœŸè¿‡æ—ºï¼‰â­
æµå¹´vså¤§è¿ï¼šåˆæœªç›¸åˆï¼Œç«åœŸæ›´æ—º
æµå¹´vsæ—¥æŸ±ï¼šè¾°æœªç›¸ç ´ï¼Œä¸å‰

ã€å–œå¿Œåˆ†æã€‘â­
æµå¹´ä¸ç« = åå°ï¼ˆå¿Œç¥ï¼‰
æµå¹´æœªåœŸ = æ¯”è‚©ï¼ˆå¿Œç¥ï¼‰
å¤§è¿ä¸™ç« = æ­£å°ï¼ˆå¿Œç¥ï¼‰
â†’ æµå¹´å¤§è¿éƒ½æ˜¯å¿Œç¥

ã€è´¢è¿åˆ†æã€‘
âŒ ä¸åˆ©è´¢è¿ï¼ˆåœŸæ—ºå…‹æ°´ï¼Œæ°´ä¸ºè´¢æ˜Ÿï¼›å¿Œç¥å½“ä»¤ï¼‰
âš ï¸ é¿å…æŠ•èµ„å’Œå¤§é¢æ”¯å‡º
âœ… å¯è€ƒè™‘ç¨³å¥ç†è´¢

ã€å¥åº·å»ºè®®ã€‘
âš ï¸ åœŸæ—ºå…‹æ°´ï¼Œæ³¨æ„è‚¾è„ã€æ³Œå°¿ç³»ç»Ÿ
âš ï¸ ç«æ—ºæ³¨æ„å¿ƒè¡€ç®¡ã€è¡€å‹
    """
}
```

---

## ğŸ—ï¸ å®ç°æ–¹æ¡ˆ

### é˜¶æ®µ1ï¼šåˆ›å»ºåŸºç¡€åˆ†ææ¨¡å—ï¼ˆæ ¸å¿ƒï¼‰

#### 1.1 åˆ›å»º WuxingBalanceAnalyzer

```python
# src/analyzers/wuxing_balance_analyzer.py
from src.data.constants import STEM_ELEMENTS, BRANCH_ELEMENTS

class WuxingBalanceAnalyzer:
    """äº”è¡ŒåŠ¨æ€å¹³è¡¡åˆ†æå™¨"""
    
    # åœ°æ”¯äº”è¡Œæƒé‡ï¼ˆæœ¬æ°”ä¸ºä¸»ï¼‰
    BRANCH_ELEMENT_WEIGHTS = {
        'å­': {'æ°´': 2},
        'åˆ': {'ç«': 2},
        'å¯': {'æœ¨': 2},
        'é…‰': {'é‡‘': 2},
        'å¯…': {'æœ¨': 1.5, 'ç«': 0.3, 'åœŸ': 0.2},
        'ç”³': {'é‡‘': 1.5, 'æ°´': 0.3, 'åœŸ': 0.2},
        'å·³': {'ç«': 1.5, 'é‡‘': 0.3, 'åœŸ': 0.2},
        'äº¥': {'æ°´': 1.5, 'æœ¨': 0.3, 'åœŸ': 0.2},
        'è¾°': {'åœŸ': 1.5, 'æœ¨': 0.3, 'æ°´': 0.2},
        'æˆŒ': {'åœŸ': 1.5, 'é‡‘': 0.3, 'ç«': 0.2},
        'ä¸‘': {'åœŸ': 1.5, 'æ°´': 0.3, 'é‡‘': 0.2},
        'æœª': {'åœŸ': 1.5, 'ç«': 0.3, 'æœ¨': 0.2},
    }
    
    @staticmethod
    def analyze(bazi_elements: dict, liunian: dict, dayun: dict) -> dict:
        """åˆ†æäº”è¡ŒåŠ¨æ€å¹³è¡¡"""
        # 1. è®¡ç®—æµå¹´äº”è¡Œ
        liunian_elements = WuxingBalanceAnalyzer._calculate_ganzhi_elements(
            liunian['stem'], liunian['branch']
        )
        
        # 2. è®¡ç®—å¤§è¿äº”è¡Œ
        dayun_elements = WuxingBalanceAnalyzer._calculate_ganzhi_elements(
            dayun['stem'], dayun['branch']
        )
        
        # 3. ç»¼åˆç»Ÿè®¡
        combined_elements = WuxingBalanceAnalyzer._combine_elements(
            bazi_elements, liunian_elements, dayun_elements
        )
        
        # 4. åˆ¤æ–­æ—ºå¼±
        analysis = WuxingBalanceAnalyzer._analyze_balance(combined_elements)
        
        return {
            "bazi_elements": bazi_elements,
            "liunian_elements": liunian_elements,
            "dayun_elements": dayun_elements,
            "combined_elements": combined_elements,
            "analysis": analysis
        }
```

#### 1.2 åˆ›å»º FortuneRelationAnalyzer

```python
# src/analyzers/fortune_relation_analyzer.py
from src.data.relations import *
from src.data.constants import STEM_ELEMENTS, BRANCH_ELEMENTS

class FortuneRelationAnalyzer:
    """æµå¹´å¤§è¿å…³ç³»åˆ†æå™¨"""
    
    @staticmethod
    def analyze(bazi_pillars: dict, liunian: dict, dayun: dict) -> dict:
        """åˆ†ææµå¹´å¤§è¿ä¸å…«å­—çš„å…³ç³»"""
        # 1. æµå¹´vså¤§è¿
        liunian_dayun = FortuneRelationAnalyzer._analyze_liunian_dayun(
            liunian, dayun
        )
        
        # 2. æµå¹´vså…«å­—
        liunian_bazi = FortuneRelationAnalyzer._analyze_fortune_bazi(
            liunian, bazi_pillars
        )
        
        # 3. å¤§è¿vså…«å­—
        dayun_bazi = FortuneRelationAnalyzer._analyze_fortune_bazi(
            dayun, bazi_pillars
        )
        
        return {
            "liunian_dayun_relation": liunian_dayun,
            "liunian_bazi_relation": liunian_bazi,
            "dayun_bazi_relation": dayun_bazi,
        }
    
    @staticmethod
    def _analyze_liunian_dayun(liunian: dict, dayun: dict) -> dict:
        """åˆ†ææµå¹´ä¸å¤§è¿çš„å…³ç³»"""
        ln_stem, ln_branch = liunian['stem'], liunian['branch']
        dy_stem, dy_branch = dayun['stem'], dayun['branch']
        
        result = {}
        
        # å¤©å¹²å…³ç³»
        if STEM_HE.get(ln_stem) == dy_stem:
            result['stem_relation'] = f"{ln_stem}{dy_stem}ç›¸åˆ"
        elif STEM_ELEMENTS[ln_stem] == STEM_ELEMENTS[dy_stem]:
            result['stem_relation'] = f"{ln_stem}{dy_stem}æ¯”åŠ«å¹¶è§"
        else:
            result['stem_relation'] = "æ— ç‰¹æ®Šå…³ç³»"
        
        # åœ°æ”¯å…³ç³»
        if BRANCH_CHONG.get(ln_branch) == dy_branch:
            result['branch_relation'] = f"{ln_branch}{dy_branch}ç›¸å†²"
        elif BRANCH_LIUHE.get(ln_branch) == dy_branch:
            result['branch_relation'] = f"{ln_branch}{dy_branch}å…­åˆ"
        elif dy_branch in BRANCH_XING.get(ln_branch, []):
            result['branch_relation'] = f"{ln_branch}{dy_branch}ç›¸åˆ‘"
        else:
            result['branch_relation'] = "æ— ç‰¹æ®Šå…³ç³»"
        
        return result
```

---

### é˜¶æ®µ2ï¼šå¢å¼ºFortuneContextService

```python
# server/services/fortune_context_service.py

# â­ æ–°å¢å¯¼å…¥
from src.analyzers.wangshuai_analyzer import WangShuaiAnalyzer
from src.analyzers.wuxing_balance_analyzer import WuxingBalanceAnalyzer
from src.analyzers.fortune_relation_analyzer import FortuneRelationAnalyzer

class FortuneContextService:
    @staticmethod
    def get_fortune_context(
        bazi_info: dict,
        user_question: str,
        intent: str,
        day_stem: str,
        # â­ æ–°å¢å‚æ•°
        solar_date: str,
        solar_time: str,
        gender: str
    ) -> dict:
        # ... åŸæœ‰é€»è¾‘ ...
        
        # â­ æ–°å¢ï¼šè·å–å–œå¿Œç¥
        wangshuai_analyzer = WangShuaiAnalyzer()
        wangshuai_result = wangshuai_analyzer.analyze(solar_date, solar_time, gender)
        xi_ji = wangshuai_result.get('xi_ji', {})
        xi_ji_elements = wangshuai_result.get('xi_ji_elements', {})
        
        # â­ æ–°å¢ï¼šäº”è¡Œå¹³è¡¡åˆ†æ
        for liunian in liunian_list:
            balance_result = WuxingBalanceAnalyzer.analyze(
                bazi_elements,
                liunian,
                dayun
            )
            liunian['balance_analysis'] = balance_result
            
            # â­ æ–°å¢ï¼šå…³ç³»åˆ†æ
            relation_result = FortuneRelationAnalyzer.analyze(
                bazi_pillars,
                liunian,
                dayun
            )
            liunian['relation_analysis'] = relation_result
        
        # â­ æ–°å¢ï¼šç”Ÿæˆæ·±åº¦åˆ†ææ–‡æœ¬
        fortune_summary = FortuneContextService._generate_deep_analysis(
            liunian_list,
            dayun,
            xi_ji,
            xi_ji_elements,
            intent
        )
        
        return {
            "liunian_list": liunian_list,
            "dayun": dayun,
            "fortune_summary": fortune_summary,
            "xi_ji": xi_ji,  # â­ æ–°å¢
            "xi_ji_elements": xi_ji_elements  # â­ æ–°å¢
        }
```

---

## ğŸ”Œ APIè®¾è®¡

### ä¿®æ”¹ç°æœ‰API

**ä½ç½®**ï¼š`server/api/v1/smart_fortune.py`

**ä¿®æ”¹**ï¼š`smart_analyze` å‡½æ•°

```python
# åŸä»£ç 
fortune_context = FortuneContextService.get_fortune_context(
    detail_result,
    question,
    intent_result['intent'],
    day_stem
)

# â­ ä¿®æ”¹ä¸º
fortune_context = FortuneContextService.get_fortune_context(
    detail_result,
    question,
    intent_result['intent'],
    day_stem,
    # æ–°å¢å‚æ•°
    solar_date=year_str,
    solar_time=time_str,
    gender=gender
)
```

**æ— éœ€æ–°å¢API**ï¼Œç°æœ‰APIè‡ªåŠ¨å¢å¼ºï¼

---

## âœ… æµ‹è¯•è®¡åˆ’

### æµ‹è¯•ç”¨ä¾‹

**æµ‹è¯•æ•°æ®**ï¼š
- å‡ºç”Ÿï¼š1987å¹´9æœˆ16æ—¥5æ—¶ï¼Œç”·
- æ—¥ä¸»ï¼šæˆŠåœŸ
- é—®é¢˜ï¼š"æˆ‘åå¹´èƒ½å‘è´¢å—ï¼Ÿ"
- æµå¹´ï¼š2027å¹´ï¼ˆä¸æœªï¼‰
- å¤§è¿ï¼šä¸™åˆï¼ˆå‡è®¾ï¼‰

**æœŸæœ›è¾“å‡º**ï¼š
```
ã€å…«å­—åŸå±€ã€‘
æ—¥ä¸»ï¼šæˆŠåœŸ
äº”è¡Œï¼šé‡‘1 ç«1 åœŸ3 æœ¨3 æ°´0
å–œç¥ï¼ˆäº”è¡Œï¼‰ï¼šæ°´ã€æœ¨
å¿Œç¥ï¼ˆäº”è¡Œï¼‰ï¼šç«ã€åœŸ

ã€2027å¹´æµå¹´ä¸æœª + å¤§è¿ä¸™åˆã€‘
äº”è¡Œç»¼åˆï¼šé‡‘1 ç«4 åœŸ4 æœ¨3 æ°´0ï¼ˆç«åœŸè¿‡æ—ºï¼‰
æµå¹´vså¤§è¿ï¼šåˆæœªç›¸åˆï¼Œç«åœŸæ›´æ—º
æµå¹´vsæ—¥æŸ±ï¼šè¾°æœªç›¸ç ´ï¼Œä¸å‰

ã€å–œå¿Œåˆ†æã€‘
æµå¹´ä¸ç« = åå°ï¼ˆå¿Œç¥ï¼‰
æµå¹´æœªåœŸ = æ¯”è‚©ï¼ˆå¿Œç¥ï¼‰
â†’ æµå¹´ä¸ºå¿Œç¥å¹´

ã€è´¢è¿åˆ†æã€‘
âŒ 2027å¹´è´¢è¿ä¸åˆ©
åŸå› ï¼šåœŸæ—ºå…‹æ°´ï¼ˆæ°´ä¸ºè´¢æ˜Ÿï¼‰ï¼›å¿Œç¥å½“ä»¤
å»ºè®®ï¼šé¿å…æŠ•èµ„ã€å¤§é¢æ”¯å‡ºï¼›ä»¥ç¨³å¥ä¸ºä¸»
```

### æµ‹è¯•å‘½ä»¤

```bash
curl "http://localhost:8001/api/v1/smart-analyze?question=æˆ‘åå¹´èƒ½å‘è´¢å—ï¼Ÿ&year=1987&month=9&day=16&hour=5&gender=male&include_fortune_context=true"
```

---

## ğŸ“… å¼€å‘æ—¶é—´è¡¨

| ä»»åŠ¡ | æ—¶é—´ | çŠ¶æ€ |
|------|------|------|
| æ›´æ–°å¼€å‘è§„èŒƒ | 0.5h | âœ… å®Œæˆ |
| åˆ›å»ºç³»ç»ŸåŠŸèƒ½ç›˜ç‚¹æ–‡æ¡£ | 1h | âœ… å®Œæˆ |
| åˆ›å»ºå¼€å‘è®¡åˆ’ | 1h | âœ… å®Œæˆ |
| å®ç°WuxingBalanceAnalyzer | 2h | â³ å¾…å¼€å§‹ |
| å®ç°FortuneRelationAnalyzer | 2h | â³ å¾…å¼€å§‹ |
| å¢å¼ºFortuneContextService | 2h | â³ å¾…å¼€å§‹ |
| æµ‹è¯•éªŒè¯ | 1h | â³ å¾…å¼€å§‹ |
| æ–‡æ¡£æ›´æ–° | 0.5h | â³ å¾…å¼€å§‹ |

**é¢„è®¡æ€»æ—¶é—´**ï¼š10å°æ—¶

---

## ğŸš€ å¼€å§‹å®ç°

ç¡®è®¤æ— è¯¯åï¼Œå¼€å§‹æŒ‰é˜¶æ®µå®ç°ï¼š
1. âœ… WuxingBalanceAnalyzer
2. âœ… FortuneRelationAnalyzer
3. âœ… å¢å¼ºFortuneContextService
4. âœ… æµ‹è¯•éªŒè¯

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### âœ… éµå®ˆå¼€å‘è§„èŒƒ

1. **å¾®æœåŠ¡è®¾è®¡åŸåˆ™**ï¼š
   - âœ… WuxingBalanceAnalyzer - ç‹¬ç«‹æ¨¡å—ï¼ˆå¯å¤ç”¨ï¼‰
   - âœ… FortuneRelationAnalyzer - ç‹¬ç«‹æ¨¡å—ï¼ˆå¯å¤ç”¨ï¼‰
   - âœ… ç»„è£…å¼å¼€å‘ï¼šå¤ç”¨ç°æœ‰æ¨¡å— + æ–°é€»è¾‘

2. **æœ€å°å½±å“åŸåˆ™**ï¼š
   - âœ… åªæ–°å¢æ–‡ä»¶ï¼Œä¸ä¿®æ”¹æ ¸å¿ƒé€»è¾‘
   - âœ… åªå¢å¼ºFortuneContextServiceï¼Œä¸åŠ¨å…¶ä»–æœåŠ¡
   - âœ… APIå±‚åªä¿®æ”¹å‚æ•°ä¼ é€’ï¼Œä¸æ”¹å“åº”æ ¼å¼

3. **ä¼˜å…ˆå¤ç”¨ç°æœ‰åŠŸèƒ½**ï¼š
   - âœ… å¤ç”¨ WangShuaiAnalyzerï¼ˆå–œå¿Œç¥ï¼‰
   - âœ… å¤ç”¨ relations.pyï¼ˆå¤©å¹²åœ°æ”¯å…³ç³»ï¼‰
   - âœ… å¤ç”¨ ELEMENT_RELATIONSï¼ˆäº”è¡Œç”Ÿå…‹ï¼‰
   - âœ… å¤ç”¨ BaziDetailServiceï¼ˆå¤§è¿æµå¹´æ•°æ®ï¼‰

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ç³»ç»ŸåŠŸèƒ½ç›˜ç‚¹](./ç³»ç»ŸåŠŸèƒ½ç›˜ç‚¹-å¯å¤ç”¨æ¨¡å—æ¸…å•.md)
- [å¼€å‘è§„èŒƒ](./DEVELOPMENT_GUIDELINES.md)
- [æ™ºèƒ½é—®ç­”å…³è”æµå¹´å¤§è¿](./æ™ºèƒ½é—®ç­”å…³è”æµå¹´å¤§è¿-2025-11-24.md)

