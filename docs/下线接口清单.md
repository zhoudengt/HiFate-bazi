# 下线接口清单

> **文档创建时间**: 2026-01-02  
> **最后更新时间**: 2026-01-02

本文档梳理了项目中所有已废弃、不再使用或被新版本替代的API接口和函数，用于指导代码清理和接口下线工作。

---

## 1. 被新版本替代的接口

### 1.1 身体健康分析接口

#### 旧接口：`health_analysis.py`

- **文件路径**: `server/api/v1/health_analysis.py`
- **端点**:
  - `POST /api/v1/health/stream` - 流式健康分析
  - `POST /api/v1/health/debug` - 调试接口
- **状态**: ⚠️ **使用方案1（`build_health_prompt`），前端仍在使用**
- **前端使用**: `local_frontend/js/health-analysis.js` 调用 `/api/v1/health/stream`（第124行）
- **问题**: 
  - 使用已废弃的方案1（自然语言 Prompt）
  - 未使用优化后的方案2（Coze Bot 模板）

#### 新接口：`health_analysis_v2.py`

- **文件路径**: `server/api/v1/health_analysis_v2.py`
- **端点**:
  - `POST /api/v1/health-analysis-v2/stream` - 流式健康分析（V2）
  - `POST /api/v1/health-analysis-v2/test` - 测试接口
- **状态**: ✅ **使用方案2（`format_input_data_for_coze`），已优化**
- **优势**:
  - 使用 Coze Bot 模板（方案2）
  - 数据格式统一，便于维护
  - 与总评分析、感情婚姻、事业财富、子女学习等接口保持一致

#### 建议

1. **前端迁移**：将 `local_frontend/js/health-analysis.js` 迁移到 V2 接口
   - 修改 API 端点：`/api/v1/health/stream` → `/api/v1/health-analysis-v2/stream`
   - 测试迁移后的功能
2. **下线旧接口**：前端迁移完成后，下线 `health_analysis.py`
   - 移除 `server/api/v1/health_analysis.py`
   - 从 `server/main.py` 中移除相关路由注册
   - 移除 `build_health_prompt` 函数

---

## 2. 已废弃但未使用的函数（方案1遗留代码）

### 2.1 总评分析接口的遗留函数

#### `build_general_review_prompt`

- **文件路径**: `server/api/v1/general_review_analysis.py`
- **原位置**: 第1857行（已移除）
- **状态**: ✅ **已移除（2026-01-02）**
- **替代方案**: `format_input_data_for_coze`（方案2）
- **使用情况**: 未在任何接口中调用
- **清理状态**: ✅ **已完成**

### 2.2 事业财富分析接口的遗留函数

#### `build_natural_language_prompt`

- **文件路径**: `server/api/v1/career_wealth_analysis.py`
- **原位置**: 第501行（已移除）
- **状态**: ✅ **已移除（2026-01-02）**
- **替代方案**: `format_input_data_for_coze`（方案2）
- **使用情况**: 未在任何接口中调用
- **清理状态**: ✅ **已完成**

### 2.3 感情婚姻分析接口的遗留函数

#### `build_natural_language_prompt`

- **文件路径**: `server/api/v1/marriage_analysis.py`
- **原位置**: 第349行（已移除）
- **状态**: ✅ **已移除（2026-01-02）**
- **替代方案**: `format_input_data_for_coze`（方案2）
- **使用情况**: 未在任何接口中调用
- **清理状态**: ✅ **已完成**

### 2.4 子女学习分析接口的遗留函数

#### `build_natural_language_prompt`

- **文件路径**: `server/api/v1/children_study_analysis.py`
- **原位置**: 第1257行（已移除）
- **状态**: ✅ **已移除（2026-01-02）**
- **替代方案**: `format_input_data_for_coze`（方案2）
- **原使用情况**: 仅在 debug 接口中使用（已更新）
- **清理状态**: ✅ **已完成**
- **Debug接口更新**: 
  - 已移除对 `build_natural_language_prompt` 的调用
  - Debug 接口现在只返回方案2数据（`formatted_data`）

### 2.5 身体健康分析接口的遗留函数

#### `build_health_prompt`

- **文件路径**: `server/api/v1/health_analysis.py`
- **位置**: 第843行
- **状态**: ⚠️ **仍在使用（旧版接口中）**
- **替代方案**: `health_analysis_v2.py` 使用 `format_input_data_for_coze`
- **建议**: 随 `health_analysis.py` 一起下线（前端迁移到 V2 后）

---

## 3. 已废弃的字段

### 3.1 大运显示接口废弃字段

#### `dayun_index`

- **文件路径**: `server/api/v1/bazi_display.py`
- **位置**: 第55行
- **字段名**: `dayun_index`
- **状态**: ⚠️ **已标记为废弃，但接口仍在使用**
- **说明**: 优先使用 `dayun_year_start` 和 `dayun_year_end`
- **建议**: 
  - 保持字段以维持向后兼容性
  - 新代码应使用 `dayun_year_start` 和 `dayun_year_end`
  - 在文档中标注为废弃字段

---

## 4. 已迁移但保持兼容的接口

### 4.1 算法公式分析接口

#### `formula_analysis.py`

- **文件路径**: `server/api/v1/formula_analysis.py`
- **端点**:
  - `POST /api/v1/bazi/formula-analysis` - 公式分析
  - `GET /api/v1/bazi/formula-rules/info` - 规则信息
- **状态**: ✅ **内部已迁移到 `RuleService`（数据库规则），但保持API兼容性**
- **前端使用**: `local_frontend/formula-analysis.html` 仍在使用
- **内部实现**: 
  - 已从文件读取规则迁移到数据库规则（`RuleService`）
  - `FormulaRuleService` 已完全废弃
- **建议**: 
  - ✅ **保持接口**，但标记为"已迁移，内部实现已变更"
  - 前端无需修改
  - 内部实现已优化为使用数据库规则

---

## 5. 建议的下线计划

### 5.1 立即下线（已完成）

#### ✅ 方案1遗留函数清理（2026-01-02）

**已完成的工作**：
- ✅ 移除 `build_general_review_prompt` (`general_review_analysis.py`)
- ✅ 移除 `build_natural_language_prompt` (`career_wealth_analysis.py`)
- ✅ 移除 `build_natural_language_prompt` (`marriage_analysis.py`)
- ✅ 移除 `build_natural_language_prompt` (`children_study_analysis.py`)
- ✅ 更新 `children_study_analysis.py` 的 debug 接口，移除方案1相关代码

**清理效果**：
- 代码更简洁：移除了约 1500+ 行废弃代码
- 维护成本降低：不再需要维护两套方案
- 一致性提升：所有接口统一使用方案2（Coze Bot 模板）

### 5.2 前端迁移后下线（待执行）

#### ⚠️ 身体健康分析接口（`health_analysis.py`）

**前置条件**：
1. 前端迁移：将 `local_frontend/js/health-analysis.js` 迁移到 V2 接口
2. 功能测试：验证迁移后的功能正常
3. 确认无其他依赖：检查是否有其他代码依赖旧接口

**下线步骤**：
1. 修改前端代码：`local_frontend/js/health-analysis.js`
   - 修改 API 端点：`/api/v1/health/stream` → `/api/v1/health-analysis-v2/stream`
2. 测试验证：
   - 端到端测试健康分析功能
   - 验证流式响应正常
   - 验证数据格式正确
3. 下线旧接口：
   - 移除 `server/api/v1/health_analysis.py`
   - 从 `server/main.py` 中移除相关路由注册
   - 移除 `build_health_prompt` 函数
4. 清理相关导入：
   - 清理不再使用的导入
   - 更新相关文档

**预计时间**: 待前端迁移完成后执行

### 5.3 保持兼容（不下线）

#### ✅ 算法公式分析接口

- **原因**: 前端仍在使用，且内部实现已优化
- **状态**: 保持接口，内部实现已迁移到数据库规则
- **建议**: 无需下线，保持API兼容性

#### ✅ 大运显示接口废弃字段

- **原因**: 需要保持向后兼容性
- **状态**: 字段标记为废弃，但接口仍在使用
- **建议**: 保持字段，新代码使用新字段

---

## 6. 清理统计

### 6.1 已清理的函数

| 函数名 | 文件 | 状态 | 清理时间 |
|--------|------|------|----------|
| `build_general_review_prompt` | `general_review_analysis.py` | ✅ 已移除 | 2026-01-02 |
| `build_natural_language_prompt` | `career_wealth_analysis.py` | ✅ 已移除 | 2026-01-02 |
| `build_natural_language_prompt` | `marriage_analysis.py` | ✅ 已移除 | 2026-01-02 |
| `build_natural_language_prompt` | `children_study_analysis.py` | ✅ 已移除 | 2026-01-02 |

### 6.2 待清理的接口

| 接口文件 | 状态 | 前置条件 | 预计时间 |
|----------|------|----------|----------|
| `health_analysis.py` | ⚠️ 待下线 | 前端迁移到 V2 | 待定 |

### 6.3 保持兼容的接口

| 接口文件 | 状态 | 原因 |
|----------|------|------|
| `formula_analysis.py` | ✅ 保持 | 前端仍在使用，内部已优化 |

---

## 7. 注意事项

1. **前端依赖**: 确认前端不再使用后再下线接口
2. **向后兼容**: 某些接口虽然已迁移，但需要保持API兼容性
3. **测试验证**: 下线前必须进行完整测试
4. **方案1遗留代码**: 感情婚姻、事业财富、子女学习、总评分析等接口的方案1遗留函数已全部清理完成
5. **Debug接口**: Debug 接口已更新为只返回方案2数据，不再返回方案1的 prompt

---

## 8. 更新日志

- **2026-01-02**: 
  - 创建下线接口清单文档
  - 完成方案1遗留函数清理（方案A：完全清理）
  - 更新 `children_study_analysis.py` 的 debug 接口

---

## 9. 相关文档

- [开发规范](../.cursorrules)
- [热更新规范](standards/hot-reload.md)
- [gRPC协议规范](standards/grpc-protocol.md)

