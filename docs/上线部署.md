# HiFateç³»ç»Ÿ - Gitå·¥ä½œæµä¸ä¸Šçº¿éƒ¨ç½²è§„èŒƒ

## ğŸ“‹ ç›®å½•

- [Gitå·¥ä½œæµè§„èŒƒ](#gitå·¥ä½œæµè§„èŒƒ)
- [ç¯å¢ƒè¯´æ˜](#ç¯å¢ƒè¯´æ˜)
- [åˆ†æ”¯ä¸æäº¤](#åˆ†æ”¯ä¸æäº¤)
- [å¼€å‘ & æµ‹è¯•æµç¨‹](#å¼€å‘--æµ‹è¯•æµç¨‹)
- [ä¸Šçº¿éƒ¨ç½²æµç¨‹](#ä¸Šçº¿éƒ¨ç½²æµç¨‹)
- [è‡ªåŠ¨åŒ– & å¥åº·è„šæœ¬](#è‡ªåŠ¨åŒ–--å¥åº·è„šæœ¬)
- [å›æ»šè®¡åˆ’](#å›æ»šè®¡åˆ’)
- [æ³¨æ„äº‹é¡¹ä¸å‚è€ƒ](#æ³¨æ„äº‹é¡¹ä¸å‚è€ƒ)

---

## Gitå·¥ä½œæµè§„èŒƒ

### æ¨¡å‹æ¦‚è§ˆ

```
main (ç”Ÿäº§) â† release/* â† develop â† feature/*, bugfix/*
                        â†‘
                     hotfix/*
```

### å‘å¸ƒèŠ‚ç‚¹

- `main`ï¼šç”Ÿäº§å¯éƒ¨ç½²ä»£ç ï¼Œä»…å…è®¸é€šè¿‡ Pull Requestï¼ˆPRï¼‰åˆå¹¶ã€‚
- `develop`ï¼šæ—¥å¸¸å¼€å‘åˆ†æ”¯ï¼Œæ‰€æœ‰ feature/bugfix æœ€ç»ˆåˆå¹¶ç›®æ ‡ã€‚
- `release/x.y.z`ï¼šå‡†å¤‡å‘å¸ƒçš„åˆ†æ”¯ï¼Œåªå…è®¸ä¿®å¤ä¸æ–‡æ¡£æ›´æ–°ï¼Œæµ‹è¯•é€šè¿‡ååˆå¹¶ `main`ã€‚
- `feature/*`ã€`bugfix/*`ã€`hotfix/*`ï¼šçŸ­ç”Ÿå‘½å‘¨æœŸåˆ†æ”¯ï¼Œç”¨äºåŠŸèƒ½å¼€å‘ã€é—®é¢˜ä¿®å¤ä¸ç´§æ€¥é”™è¯¯å¤„ç†ã€‚

---

## ç¯å¢ƒè¯´æ˜

| ç¯å¢ƒ | åˆ†æ”¯ | æœåŠ¡å™¨ | è¯´æ˜ |
|------|------|--------|------|
| å¼€å‘ | `develop` | Dev Server | æŒç»­æ„å»ºã€å•å…ƒ/é›†æˆæµ‹è¯• |
| æµ‹è¯• | `develop` | Test Server | QA ä¸ä¸šåŠ¡éªŒè¯ |
| é¢„å‘å¸ƒ | `release/*` | Staging Server | å‡†ç”Ÿäº§éªŒè¯ |
| ç”Ÿäº§ | `main` | Prod Server | é¢å‘å®¢æˆ·æœåŠ¡ |

### ç¯å¢ƒå˜é‡çº¦å®š

```
export ENV=production
export DEBUG=false
export MYSQL_HOST=prod-mysql.internal
export REDIS_HOST=redis-master
export NODE_ROLE=master
```

æ‰€æœ‰é…ç½®ä½¿ç”¨ `config/services.env`ï¼ˆæˆ– `.env`ï¼‰ç®¡ç†ï¼Œæ•æ„Ÿä¿¡æ¯ä¸æäº¤ä»“åº“ã€‚

---

## åˆ†æ”¯ä¸æäº¤

### åˆ†æ”¯ç­–ç•¥ç¤ºä¾‹

```
# åŠŸèƒ½åˆ†æ”¯
git checkout develop
git pull origin develop
git checkout -b feature/å©šé…è§„åˆ™å®Œå–„

# Bug ä¿®å¤
git checkout develop
git checkout -b bugfix/è§„åˆ™åŒ¹é…å¼‚å¸¸

# ç´§æ€¥ä¿®å¤
git checkout main
git checkout -b hotfix/1.0.1-utf8
```

åˆå¹¶æµç¨‹ï¼š

1. `feature/*` â†’ PR â†’ `develop`ï¼Œé€šè¿‡æµ‹è¯•ååˆå¹¶ã€åˆ é™¤åˆ†æ”¯ã€‚
2. `develop` â†’ `release/x.y.z`ï¼Œæµ‹è¯•å®Œæˆååˆå¹¶å› `main` & `develop`ã€‚
3. `hotfix/*`ï¼šä» `main` åˆ†å‡ºï¼Œä¿®å¤ååˆå¹¶ `main`ï¼ˆæ‰“ tagï¼‰+ `develop`ã€‚

### æäº¤è§„èŒƒ

æ ¼å¼ï¼š

```
<type>(<scope>): <subject>

body

footer
```

å¸¸ç”¨ç±»å‹ï¼š

| type | æ„ä¹‰ |
|------|------|
| feat | æ–°åŠŸèƒ½ |
| fix | Bug ä¿®å¤ |
| docs | æ–‡æ¡£æ›´æ–° |
| chore | æ„å»º/å·¥å…·å˜åŠ¨ |
| refactor | ä»£ç é‡æ„ |
| perf | æ€§èƒ½ä¼˜åŒ– |
| test | æµ‹è¯•ç›¸å…³ |
| hotfix | ç´§æ€¥ä¿®å¤ |

Scope ä¸¾ä¾‹ï¼š`core`ã€`rule`ã€`api`ã€`deploy`ã€`db`ã€‚

å¸¸ç”¨å‘½ä»¤ï¼š

```
git status
git add path/to/file
git commit -m "fix(rule): ä¿®å¤å©šé…è§„åˆ™å­—ç¬¦é›†é—®é¢˜"
git push origin feature/xxx
```

---

## å¼€å‘ & æµ‹è¯•æµç¨‹

### å¼€å‘æµç¨‹

1. åˆ›å»ºåˆ†æ”¯ï¼š`feature/*` æˆ– `bugfix/*`ã€‚
2. æœ¬åœ°å¼€å‘ï¼Œéµå¾ª `docs/DEVELOPMENT_GUIDELINES.md`ã€‚
3. è¿è¡Œå•å…ƒ/é›†æˆæµ‹è¯•ï¼š`python -m pytest tests/`ã€‚
4. æäº¤ PR åˆ° `develop`ï¼Œå¡«å†™æµ‹è¯•ä¸å˜æ›´è¯´æ˜ï¼Œé™„å¸¦æˆªå›¾/æ—¥å¿—ã€‚
5. ç» Code Review ä¸ CI ç»¿è‰²ååˆå¹¶ã€‚

### æµ‹è¯•æµç¨‹

- å•å…ƒæµ‹è¯•ï¼š`python -m pytest tests/ -v`ã€‚
- é›†æˆæµ‹è¯•ï¼š`./scripts/test_api.sh`ã€`./scripts/test_microservices.sh`ã€‚
- åŠŸèƒ½éªŒè¯ï¼šæœ¬åœ°æˆ–æµ‹è¯•ç¯å¢ƒè®¿é—® `http://localhost:8001/frontend/fortune.html`ã€‚
- æ€§èƒ½æµ‹è¯•ï¼š`ab -n 1000 -c 10 http://localhost:8001/api/bazi/calculate` æˆ– `wrk -t4 -c100 -d30s http://localhost:8001/health`ã€‚

---

## ä¸Šçº¿éƒ¨ç½²æµç¨‹

### 1. åˆ›å»º Release

```
git checkout develop
git pull origin develop
git checkout -b release/1.2.0
# æ›´æ–°ç‰ˆæœ¬å·ã€CHANGELOG
git commit -am "chore: å‡†å¤‡å‘å¸ƒ v1.2.0"
git push origin release/1.2.0
```

### 2. é¢„å‘å¸ƒéƒ¨ç½²

```
ssh root@staging-server
cd /opt/HiFate-bazi
git checkout release/1.2.0
git pull origin release/1.2.0
source .venv/bin/activate
pip install -r requirements.txt --upgrade
./stop_all_services.sh
./start_all_services.sh
./check_services.sh
curl http://localhost:8001/health
```

### 3. æ­£å¼ä¸Šçº¿

```
git checkout main
git pull origin main
git merge --no-ff release/1.2.0
git tag -a v1.2.0 -m "Release v1.2.0"
git push origin main --tags
```

#### ç”Ÿäº§éƒ¨ç½²æ–¹å¼

##### æ‰‹åŠ¨éƒ¨ç½²ï¼ˆé‡è¦ç‰ˆæœ¬ï¼‰

1. å¤‡ä»½ï¼š`tar -czf /opt/backups/backup_$(date +%Y%m%d_%H%M%S).tar.gz --exclude='.venv' --exclude='logs' --exclude='mysql/data' --exclude='redis/data' .`
2. åœæœï¼š`./stop_all_services.sh`ã€‚
3. æ‹‰å–ï¼š`git checkout main && git pull origin main`ã€‚
4. å®‰è£…ä¾èµ–ï¼š`source .venv/bin/activate && pip install -r requirements.txt --upgrade`ã€‚
5. æ•°æ®åº“å¤‡ä»½ï¼š`docker exec mysql-master mysqldump -uroot -p"$MYSQL_ROOT_PASSWORD" hifate_bazi > /opt/backups/db_backup.sql`ã€‚
6. å¯åŠ¨ï¼š`./start_all_services.sh`ã€‚
7. éªŒè¯ï¼š`./check_services.sh`, `curl http://localhost:8001/health`, `netstat -tlnp | grep 8001`ã€‚
8. åŠŸèƒ½éªŒè¯ï¼šè®¿é—® `http://<prod-ip>/frontend/fortune.html`ã€‚

##### è‡ªåŠ¨éƒ¨ç½²

```
cd /opt/HiFate-bazi
./scripts/deploy.sh --version v1.2.0
```

### 4. éªŒè¯ä¸ç›‘æ§

```
curl http://prod-server-ip/health
curl http://prod-server-ip/docs
curl -X POST http://prod-server-ip/api/bazi/calculate \
  -H "Content-Type: application/json" \
  -d '{"year":1990,"month":5,"day":15,"hour":10,"gender":"ç”·"}'
```

ç›‘æ§é‡ç‚¹ï¼šæ—¥å¿—ï¼ˆ`logs/web_app_8001.log`ï¼‰ã€`/var/log/nginx/HiFate-bazi-error.log`ã€ç³»ç»Ÿè´Ÿè½½ï¼ˆ`top`/`htop`ï¼‰ã€‚

---

## è‡ªåŠ¨åŒ– & å¥åº·è„šæœ¬

### è‡ªåŠ¨éƒ¨ç½²æ‘˜è¦

- è„šæœ¬è·¯å¾„ï¼š`/opt/HiFate-bazi/scripts/deploy.sh`ã€‚
- åŠŸèƒ½ï¼šå¤‡ä»½ä»£ç /æ•°æ®åº“ â†’ åœæœ â†’ æ‹‰å–ä»£ç  â†’ å®‰è£…ä¾èµ– â†’ æ•°æ®åº“è¿ç§» â†’ å¯åŠ¨ â†’ éªŒè¯ â†’ å¼‚å¸¸å›æ»šã€‚
- å‚æ•°ï¼š`--version` æŒ‡å®šåˆ†æ”¯/æ ‡ç­¾ï¼Œ`--rollback TIMESTAMP` å›æ»šåˆ°æŒ‡å®šå¤‡ä»½ã€‚
- æ¯æ¬¡éƒ¨ç½²é»˜è®¤ä¿ç•™æœ€è¿‘ 10 ä¸ªå¤‡ä»½ï¼ˆcode + dbï¼‰ã€‚

### å¥åº·æ£€æŸ¥è„šæœ¬ï¼ˆå‚è€ƒ `scripts/health_check.sh`ï¼‰

```
#!/bin/bash
services=( "web_app:8001" "bazi_core:9001" "bazi_rule:9004" )
for entry in "${services[@]}"; do
  name=${entry%%:*}
  port=${entry##*:}
  if lsof -i :$port >/dev/null 2>&1; then
    echo "$name (port $port) running"
  else
    echo "$name (port $port) stopped"
  fi
done
curl -f http://localhost:8001/health >/dev/null 2>&1 && echo "Health OK" || echo "Health check failed"
```

å¯æ‰©å±•å†…å®¹ï¼šæ•°æ®åº“ pingã€Redis pingã€ç£ç›˜/å†…å­˜å‘Šè­¦ã€‚

---

## å›æ»šè®¡åˆ’

### ä»£ç å›æ»š

```
git checkout main
git reset --hard v1.1.0
./stop_all_services.sh
./start_all_services.sh
./check_services.sh
```

### ä½¿ç”¨å¤‡ä»½æ¢å¤

```
BACKUP_FILE="/opt/backups/backup_20250121_100000.tar.gz"
rm -rf /opt/HiFate-bazi/*
tar -xzf $BACKUP_FILE -C /opt/HiFate-bazi/
docker exec -i mysql-master mysql -uroot -p"$MYSQL_ROOT_PASSWORD" hifate_bazi < /opt/backups/db_backup.sql
```

### æ•°æ®åº“å›æ»š

```
docker exec -i mysql-master mysql -uroot -p"$MYSQL_ROOT_PASSWORD" hifate_bazi < /opt/backups/db_backup.sql
```

---

## æ³¨æ„äº‹é¡¹ä¸å‚è€ƒ

- **æœ€å°å½±å“åŸåˆ™**ï¼šåªæ”¹å¿…è¦æ–‡ä»¶ï¼Œé¿å…è¿é”ä¿®æ”¹ã€‚
- **æ•°æ®å…¼å®¹**ï¼šæ–°å¢å­—æ®µå¯è¡Œä½†ä¸è¦åˆ é™¤ç°æœ‰å­—æ®µï¼›è¿ç§»å…ˆå¤‡ä»½ã€‚
- **æ–‡æ¡£åŒæ­¥**ï¼šæ‰€æœ‰åŠŸèƒ½/ä¿®å¤ä¸Šçº¿å‰åŒæ­¥æ›´æ–° `CHANGELOG.md`ã€`docs/APIæ–‡æ¡£.md`ã€‚
- **é…ç½®ç®¡ç†**ï¼š `.env.example` ä½œä¸ºæ¨¡æ¿ï¼Œå®é™…æ•æ„Ÿä¿¡æ¯åœ¨ `.env` æˆ–æœåŠ¡ç«¯æœºå¯†æ–‡ä»¶ä¸­ã€‚
- **ç›‘æ§**ï¼šä¸Šçº¿åä¸€å‘¨è‡³å°‘è§‚å¯Ÿ 24/7ï¼Œå…³æ³¨é”™è¯¯ç‡ã€å»¶è¿Ÿã€æ•°æ®åº“è¿æ¥æ•°ã€‚

#### å‚è€ƒæ–‡æ¡£

- `docs/éƒ¨ç½²æ–¹æ¡ˆ.md`ï¼ˆåŒèŠ‚ç‚¹é«˜å¯ç”¨æ–¹æ¡ˆï¼‰
- `docs/é˜¿é‡Œäº‘éƒ¨ç½²æŒ‡å—.md`ï¼ˆé˜¿é‡Œäº‘ç¯å¢ƒè½åœ°ï¼‰
- `docs/DEVELOPMENT_GUIDELINES.md`ï¼ˆå¼€å‘è§„èŒƒï¼‰
- `scripts/health_check.sh` ä¸ `scripts/deploy.sh`ï¼ˆå®é™…è„šæœ¬ï¼‰

---

## ğŸ“Œ æ–‡æ¡£çŠ¶æ€

- **ç‰ˆæœ¬**ï¼šv1.0
- **æ›´æ–°æ—¥æœŸ**ï¼š2025-11-21
- **ç»´æŠ¤äºº**ï¼šéƒ¨ç½²ä¸è¿ç»´å›¢é˜Ÿ

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼ğŸš€**

