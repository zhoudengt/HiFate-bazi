# æµ‹è¯•æ¡ˆä¾‹æ¸…å•

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ—å‡ºé¡¹ç›®ä¸­æ‰€æœ‰çš„æµ‹è¯•æ¡ˆä¾‹ï¼ŒæŒ‰æµ‹è¯•ç±»å‹åˆ†ç±»ã€‚

---

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_bazi_service.py
â”‚   â””â”€â”€ test_auth.py
â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ test_api_bazi.py
â”œâ”€â”€ api/                     # API æ¥å£æµ‹è¯•
â”‚   â”œâ”€â”€ test_curated_api.py
â”‚   â””â”€â”€ test_fortune_display.py
â”œâ”€â”€ features/                 # åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ test_payment.py
â”‚   â””â”€â”€ test_wangshuai.py
â””â”€â”€ scripts/                 # Shell æµ‹è¯•è„šæœ¬
    â”œâ”€â”€ test_payment_simple.sh
    â”œâ”€â”€ test_payment_complete.sh
    â”œâ”€â”€ test_stripe_complete.sh
    â””â”€â”€ test_microservice_logs.sh
```

---

## ğŸ§ª å•å…ƒæµ‹è¯•ï¼ˆUnit Testsï¼‰

### 1. å…«å­—æœåŠ¡æµ‹è¯• (`tests/unit/test_bazi_service.py`)

| æµ‹è¯•ç”¨ä¾‹ | æè¿° | æµ‹è¯•å†…å®¹ |
|---------|------|---------|
| `test_calculate_bazi_full_success` | æµ‹è¯•æˆåŠŸè®¡ç®—å…«å­— | éªŒè¯è¿”å›ç»“æœç»“æ„ã€å››æŸ±æ•°æ® |
| `test_calculate_bazi_full_female` | æµ‹è¯•å¥³æ€§å…«å­—è®¡ç®— | éªŒè¯æ€§åˆ«å­—æ®µæ­£ç¡® |
| `test_calculate_bazi_full_different_dates` | æµ‹è¯•ä¸åŒæ—¥æœŸè®¡ç®— | æµ‹è¯•å¤šä¸ªæ—¥æœŸç»„åˆ |
| `test_calculate_bazi_full_invalid_input` | æµ‹è¯•æ— æ•ˆè¾“å…¥ | æµ‹è¯•æ— æ•ˆæ—¥æœŸã€æ—¶é—´ã€æ€§åˆ« |

**è¿è¡Œæ–¹å¼**ï¼š
```bash
pytest tests/unit/test_bazi_service.py -v
```

---

### 2. è®¤è¯æœåŠ¡æµ‹è¯• (`tests/unit/test_auth.py`)

| æµ‹è¯•ç”¨ä¾‹ | æè¿° | æµ‹è¯•å†…å®¹ |
|---------|------|---------|
| `test_create_access_token` | æµ‹è¯•åˆ›å»º Token | éªŒè¯ Token ç”ŸæˆæˆåŠŸ |
| `test_verify_token_success` | æµ‹è¯•éªŒè¯æœ‰æ•ˆ Token | éªŒè¯ Token è§£ææ­£ç¡® |
| `test_verify_token_expired` | æµ‹è¯•éªŒè¯è¿‡æœŸ Token | éªŒè¯è¿‡æœŸ Token è¢«æ‹’ç» |
| `test_verify_token_invalid` | æµ‹è¯•éªŒè¯æ— æ•ˆ Token | éªŒè¯æ— æ•ˆ Token è¢«æ‹’ç» |
| `test_token_expires_in` | æµ‹è¯• Token è¿‡æœŸæ—¶é—´ | éªŒè¯è¿‡æœŸæ—¶é—´è®¾ç½®æ­£ç¡® |

**è¿è¡Œæ–¹å¼**ï¼š
```bash
pytest tests/unit/test_auth.py -v
```

---

## ğŸ”— é›†æˆæµ‹è¯•ï¼ˆIntegration Testsï¼‰

### 3. å…«å­— API é›†æˆæµ‹è¯• (`tests/integration/test_api_bazi.py`)

| æµ‹è¯•ç”¨ä¾‹ | æè¿° | æµ‹è¯•å†…å®¹ |
|---------|------|---------|
| `test_health_check` | æµ‹è¯•å¥åº·æ£€æŸ¥æ¥å£ | éªŒè¯ `/health` æ¥å£æ­£å¸¸ |
| `test_monthly_fortune_success` | æµ‹è¯•æœˆè¿åŠ¿æ¥å£æˆåŠŸ | éªŒè¯æœˆè¿åŠ¿ API è¿”å›æ•°æ® |
| `test_monthly_fortune_missing_params` | æµ‹è¯•ç¼ºå°‘å‚æ•° | éªŒè¯å‚æ•°éªŒè¯åŠŸèƒ½ |
| `test_formula_analysis_success` | æµ‹è¯•ç®—æ³•å…¬å¼åˆ†æ | éªŒè¯å…¬å¼åˆ†æ API æ­£å¸¸ |

**è¿è¡Œæ–¹å¼**ï¼š
```bash
# éœ€è¦æœåŠ¡è¿è¡Œ
pytest tests/integration/test_api_bazi.py -v -m integration
```

**å‰ç½®æ¡ä»¶**ï¼š
- æœåŠ¡å·²å¯åŠ¨ï¼š`python server/start.py`
- æ•°æ®åº“å’Œ Redis å·²è¿è¡Œ

---

## ğŸŒ API æ¥å£æµ‹è¯•ï¼ˆAPI Testsï¼‰

### 4. ç²¾é€‰æ¥å£å’Œé™æµæµ‹è¯• (`tests/api/test_curated_api.py`)

| æµ‹è¯•å‡½æ•° | æè¿° | æµ‹è¯•å†…å®¹ |
|---------|------|---------|
| `test_login` | æµ‹è¯•ç™»å½•æ¥å£ | è·å– Token |
| `test_curated_api` | æµ‹è¯•ç²¾é€‰æ¥å£ | éªŒè¯ç²¾é€‰è§„åˆ™ API |
| `test_rate_limit` | æµ‹è¯•é™æµåŠŸèƒ½ | éªŒè¯é™æµæœºåˆ¶ï¼ˆ31æ¬¡è¯·æ±‚ï¼‰ |

**æµ‹è¯•åœºæ™¯**ï¼š
- âœ… æ­£å¸¸ç™»å½•è·å– Token
- âœ… è°ƒç”¨ç²¾é€‰æ¥å£è·å–è§„åˆ™
- âœ… å¿«é€Ÿå‘é€ 31 æ¬¡è¯·æ±‚è§¦å‘é™æµ

**è¿è¡Œæ–¹å¼**ï¼š
```bash
python tests/api/test_curated_api.py
```

**å‰ç½®æ¡ä»¶**ï¼š
- æœåŠ¡å·²å¯åŠ¨
- éœ€è¦ç™»å½• Token

---

### 5. å¤§è¿æµå¹´æµæœˆæ˜¾ç¤ºæµ‹è¯• (`tests/api/test_fortune_display.py`)

| æµ‹è¯•å‡½æ•° | æè¿° | æµ‹è¯•å†…å®¹ |
|---------|------|---------|
| `test_fortune_display` | æµ‹è¯•å¤§è¿æµå¹´æµæœˆæ¥å£ | éªŒè¯å¤§è¿ã€æµå¹´ã€æµæœˆæ•°æ® |

**æµ‹è¯•æ•°æ®**ï¼š
```json
{
  "solar_date": "1987-09-16",
  "solar_time": "05:00",
  "gender": "male",
  "current_time": "2025-01-17 10:00"
}
```

**éªŒè¯å†…å®¹**ï¼š
- âœ… å¤§è¿æ•°æ®ï¼ˆå½“å‰å¤§è¿ã€å¤§è¿åˆ—è¡¨ï¼‰
- âœ… æµå¹´æ•°æ®ï¼ˆå½“å‰æµå¹´ã€æµå¹´åˆ—è¡¨ï¼‰
- âœ… æµæœˆæ•°æ®ï¼ˆå½“å‰æµæœˆã€æµæœˆåˆ—è¡¨ï¼‰

**è¿è¡Œæ–¹å¼**ï¼š
```bash
python tests/api/test_fortune_display.py
```

---

## âš™ï¸ åŠŸèƒ½æµ‹è¯•ï¼ˆFeature Testsï¼‰

### 6. æ”¯ä»˜åŠŸèƒ½æµ‹è¯• (`tests/features/test_payment.py`)

| æµ‹è¯•å‡½æ•° | æè¿° | æµ‹è¯•å†…å®¹ |
|---------|------|---------|
| `test_payment_api` | æµ‹è¯•æ”¯ä»˜ API | éªŒè¯æ”¯ä»˜æ¥å£åŠŸèƒ½ |

**æµ‹è¯•åœºæ™¯**ï¼š
- âœ… æ£€æŸ¥ä¸»æœåŠ¡çŠ¶æ€
- âœ… æ£€æŸ¥æ”¯ä»˜è·¯ç”±æ³¨å†Œ
- âœ… æµ‹è¯•æ”¯ä»˜ä¼šè¯åˆ›å»º
- âœ… æµ‹è¯•æ”¯ä»˜éªŒè¯

**è¿è¡Œæ–¹å¼**ï¼š
```bash
python tests/features/test_payment.py
```

**å‰ç½®æ¡ä»¶**ï¼š
- æœåŠ¡å·²å¯åŠ¨
- æ”¯ä»˜é…ç½®å·²è®¾ç½®ï¼ˆStripe/æ”¯ä»˜å®ç­‰ï¼‰

---

### 7. æ—ºè¡°åˆ†ææµ‹è¯• (`tests/features/test_wangshuai.py`)

| æµ‹è¯•å‡½æ•° | æè¿° | æµ‹è¯•å†…å®¹ |
|---------|------|---------|
| `test_wangshuai` | æµ‹è¯•æ—ºè¡°åˆ†æåŠŸèƒ½ | éªŒè¯æ—ºè¡°åˆ†æç»“æœ |

**æµ‹è¯•æ•°æ®**ï¼š
- æ—¥æœŸï¼š`1987-01-07`
- æ—¶é—´ï¼š`09:55`
- æ€§åˆ«ï¼š`male`

**éªŒè¯å†…å®¹**ï¼š
- âœ… æ—ºè¡°çŠ¶æ€ï¼ˆèº«æ—º/èº«å¼±ï¼‰
- âœ… å¾—åˆ†è¯¦æƒ…ï¼ˆå¾—ä»¤ã€å¾—åœ°ã€å¾—åŠ¿ï¼‰
- âœ… å–œç¥ã€å¿Œç¥
- âœ… å–œç¥äº”è¡Œã€å¿Œç¥äº”è¡Œ

**è¿è¡Œæ–¹å¼**ï¼š
```bash
python tests/features/test_wangshuai.py
```

---

## ğŸ“œ Shell è„šæœ¬æµ‹è¯•ï¼ˆShell Script Testsï¼‰

### 8. æ”¯ä»˜æµ‹è¯•è„šæœ¬

| è„šæœ¬æ–‡ä»¶ | æè¿° | æµ‹è¯•å†…å®¹ |
|---------|------|---------|
| `test_payment_simple.sh` | ç®€å•æ”¯ä»˜æµ‹è¯• | åŸºç¡€æ”¯ä»˜æµç¨‹ |
| `test_payment_complete.sh` | å®Œæ•´æ”¯ä»˜æµ‹è¯• | å®Œæ•´æ”¯ä»˜æµç¨‹ |
| `test_stripe_complete.sh` | Stripe æ”¯ä»˜æµ‹è¯• | Stripe æ”¯ä»˜æµç¨‹ |

**è¿è¡Œæ–¹å¼**ï¼š
```bash
chmod +x tests/scripts/*.sh
./tests/scripts/test_payment_simple.sh
```

---

### 9. å¾®æœåŠ¡æ—¥å¿—æ£€æŸ¥ (`tests/scripts/test_microservice_logs.sh`)

| è„šæœ¬æ–‡ä»¶ | æè¿° | æµ‹è¯•å†…å®¹ |
|---------|------|---------|
| `test_microservice_logs.sh` | å¾®æœåŠ¡æ—¥å¿—æ£€æŸ¥ | æ£€æŸ¥å„å¾®æœåŠ¡æ—¥å¿— |

**æ£€æŸ¥å†…å®¹**ï¼š
- âœ… å„å¾®æœåŠ¡æ—¥å¿—æ–‡ä»¶å­˜åœ¨
- âœ… æ—¥å¿—æ–‡ä»¶å¯è¯»
- âœ… æœ€è¿‘æ—¥å¿—æ— é”™è¯¯

---

## ğŸ“Š æµ‹è¯•ç»Ÿè®¡

### æŒ‰ç±»å‹ç»Ÿè®¡

| æµ‹è¯•ç±»å‹ | æ–‡ä»¶æ•° | æµ‹è¯•ç”¨ä¾‹æ•° | çŠ¶æ€ |
|---------|--------|-----------|------|
| **å•å…ƒæµ‹è¯•** | 2 | 9 | âœ… å·²å®ç° |
| **é›†æˆæµ‹è¯•** | 1 | 4 | âœ… å·²å®ç° |
| **API æµ‹è¯•** | 2 | 3+ | âœ… å·²å®ç° |
| **åŠŸèƒ½æµ‹è¯•** | 2 | 2+ | âœ… å·²å®ç° |
| **Shell è„šæœ¬** | 4+ | - | âœ… å·²å®ç° |

### æŒ‰åŠŸèƒ½æ¨¡å—ç»Ÿè®¡

| åŠŸèƒ½æ¨¡å— | æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•ç”¨ä¾‹ |
|---------|---------|---------|
| **å…«å­—è®¡ç®—** | `test_bazi_service.py` | 4 |
| **è®¤è¯æˆæƒ** | `test_auth.py` | 5 |
| **API æ¥å£** | `test_api_bazi.py` | 4 |
| **ç²¾é€‰è§„åˆ™** | `test_curated_api.py` | 3 |
| **è¿åŠ¿æ˜¾ç¤º** | `test_fortune_display.py` | 1+ |
| **æ”¯ä»˜åŠŸèƒ½** | `test_payment.py` + Shell è„šæœ¬ | å¤šä¸ª |
| **æ—ºè¡°åˆ†æ** | `test_wangshuai.py` | 1 |

---

## ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•

### æ–¹å¼ 1ï¼šä½¿ç”¨ pytestï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
pytest tests/unit/ -v

# è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
pytest tests/integration/ -v

# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆåŒ…æ‹¬å•å…ƒå’Œé›†æˆï¼‰
pytest tests/ -v

# è¿è¡Œå¹¶æ˜¾ç¤ºè¦†ç›–ç‡
pytest --cov=server --cov-report=html
```

### æ–¹å¼ 2ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•å’Œæ£€æŸ¥
./scripts/tests/run_tests.sh
```

### æ–¹å¼ 3ï¼šå•ç‹¬è¿è¡Œ

```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
python tests/api/test_curated_api.py
python tests/features/test_wangshuai.py

# è¿è¡Œ Shell è„šæœ¬
./tests/scripts/test_payment_simple.sh
```

---

## ğŸ“ æµ‹è¯•ç”¨ä¾‹è¯¦ç»†è¯´æ˜

### å•å…ƒæµ‹è¯•ç”¨ä¾‹è¯¦æƒ…

#### å…«å­—æœåŠ¡æµ‹è¯•ç”¨ä¾‹

1. **test_calculate_bazi_full_success**
   - **è¾“å…¥**ï¼š`1990-01-15 12:00 male`
   - **éªŒè¯**ï¼šè¿”å›ç»“æœåŒ…å« baziã€bazi_pillarsã€å››æŸ±æ•°æ®

2. **test_calculate_bazi_full_female**
   - **è¾“å…¥**ï¼š`1990-05-20 14:30 female`
   - **éªŒè¯**ï¼šæ€§åˆ«å­—æ®µä¸º female

3. **test_calculate_bazi_full_different_dates**
   - **è¾“å…¥**ï¼šå¤šä¸ªæ—¥æœŸç»„åˆ
   - **éªŒè¯**ï¼šæ‰€æœ‰æ—¥æœŸéƒ½èƒ½æ­£ç¡®è®¡ç®—

4. **test_calculate_bazi_full_invalid_input**
   - **è¾“å…¥**ï¼šæ— æ•ˆæ—¥æœŸã€æ—¶é—´ã€æ€§åˆ«
   - **éªŒè¯**ï¼šæ­£ç¡®å¤„ç†æ— æ•ˆè¾“å…¥

#### è®¤è¯æœåŠ¡æµ‹è¯•ç”¨ä¾‹

1. **test_create_access_token**
   - **è¾“å…¥**ï¼šç”¨æˆ·æ•°æ®
   - **éªŒè¯**ï¼šToken æˆåŠŸåˆ›å»º

2. **test_verify_token_success**
   - **è¾“å…¥**ï¼šæœ‰æ•ˆ Token
   - **éªŒè¯**ï¼šToken éªŒè¯é€šè¿‡ï¼Œpayload æ­£ç¡®

3. **test_verify_token_expired**
   - **è¾“å…¥**ï¼šè¿‡æœŸ Token
   - **éªŒè¯**ï¼šæŠ›å‡ºè¿‡æœŸå¼‚å¸¸

4. **test_verify_token_invalid**
   - **è¾“å…¥**ï¼šæ— æ•ˆ Token å­—ç¬¦ä¸²
   - **éªŒè¯**ï¼šæŠ›å‡ºæ— æ•ˆå¼‚å¸¸

5. **test_token_expires_in**
   - **è¾“å…¥**ï¼š30 åˆ†é’Ÿè¿‡æœŸçš„ Token
   - **éªŒè¯**ï¼šè¿‡æœŸæ—¶é—´è®¾ç½®æ­£ç¡®

---

### é›†æˆæµ‹è¯•ç”¨ä¾‹è¯¦æƒ…

#### API é›†æˆæµ‹è¯•ç”¨ä¾‹

1. **test_health_check**
   - **æ¥å£**ï¼š`GET /health`
   - **éªŒè¯**ï¼šè¿”å› 200ï¼ŒåŒ…å« status å­—æ®µ

2. **test_monthly_fortune_success**
   - **æ¥å£**ï¼š`POST /api/v1/bazi/monthly-fortune`
   - **è¾“å…¥**ï¼š`1990-01-15 12:00 male`
   - **éªŒè¯**ï¼šè¿”å› 200ï¼ŒåŒ…å« success æˆ– data

3. **test_monthly_fortune_missing_params**
   - **æ¥å£**ï¼š`POST /api/v1/bazi/monthly-fortune`
   - **è¾“å…¥**ï¼šç¼ºå°‘å‚æ•°
   - **éªŒè¯**ï¼šè¿”å› 400 æˆ– 422

4. **test_formula_analysis_success**
   - **æ¥å£**ï¼š`POST /api/v1/bazi/formula-analysis`
   - **è¾“å…¥**ï¼š`1990-01-15 12:00 male`
   - **éªŒè¯**ï¼šè¿”å› 200ï¼ŒåŒ…å«ç»“æœæ•°æ®

---

## ğŸ” æµ‹è¯•è¦†ç›–èŒƒå›´

### å·²è¦†ç›–çš„åŠŸèƒ½

- âœ… å…«å­—è®¡ç®—æ ¸å¿ƒåŠŸèƒ½
- âœ… è®¤è¯ Token åˆ›å»ºå’ŒéªŒè¯
- âœ… API æ¥å£åŸºæœ¬åŠŸèƒ½
- âœ… ç²¾é€‰è§„åˆ™æ¥å£
- âœ… å¤§è¿æµå¹´æµæœˆæ˜¾ç¤º
- âœ… æ”¯ä»˜åŠŸèƒ½
- âœ… æ—ºè¡°åˆ†æ

### å¾…è¡¥å……çš„æµ‹è¯•

- â³ è§„åˆ™åŒ¹é…å¼•æ“æµ‹è¯•
- â³ è¿åŠ¿è®¡ç®—æµ‹è¯•
- â³ gRPC æœåŠ¡æµ‹è¯•
- â³ æ•°æ®åº“æ“ä½œæµ‹è¯•
- â³ ç¼“å­˜åŠŸèƒ½æµ‹è¯•
- â³ é”™è¯¯å¤„ç†æµ‹è¯•
- â³ æ€§èƒ½æµ‹è¯•

---

## ğŸ“ˆ æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | å½“å‰è¦†ç›–ç‡ | ç›®æ ‡è¦†ç›–ç‡ |
|------|-----------|-----------|
| **server/services/** | ~30% | > 80% |
| **server/api/** | ~20% | > 60% |
| **src/** | ~10% | > 50% |
| **æ€»ä½“** | ~20% | > 50% |

---

## ğŸ› ï¸ æ·»åŠ æ–°æµ‹è¯•

### æ·»åŠ å•å…ƒæµ‹è¯•

1. åœ¨ `tests/unit/` åˆ›å»ºæµ‹è¯•æ–‡ä»¶
2. ä½¿ç”¨ pytest æ ¼å¼ç¼–å†™æµ‹è¯•
3. è¿è¡Œæµ‹è¯•éªŒè¯

ç¤ºä¾‹ï¼š
```python
# tests/unit/test_new_service.py
import pytest
from server.services.new_service import NewService

class TestNewService:
    def test_new_function(self):
        result = NewService.new_function()
        assert result is not None
```

### æ·»åŠ é›†æˆæµ‹è¯•

1. åœ¨ `tests/integration/` åˆ›å»ºæµ‹è¯•æ–‡ä»¶
2. ä½¿ç”¨ `@pytest.mark.integration` æ ‡è®°
3. ç¡®ä¿æœåŠ¡å·²å¯åŠ¨

ç¤ºä¾‹ï¼š
```python
# tests/integration/test_new_api.py
@pytest.mark.asyncio
@pytest.mark.integration
async def test_new_api(client):
    response = await client.post("/api/v1/new-endpoint", json={...})
    assert response.status_code == 200
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•å’Œä»£ç æ£€æŸ¥æŒ‡å—](./æµ‹è¯•å’Œä»£ç æ£€æŸ¥æŒ‡å—.md)
- [å¼€å‘è§„èŒƒ](../DEVELOPMENT_GUIDELINES.md)
- [API æ–‡æ¡£](../API_TEST.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

