# 问题复盘：生产环境服务崩溃和页面报错 - 2025-12-14

## 📋 问题概述

**发生时间**：2025-12-14  
**影响范围**：生产环境所有微服务不可用，页面报错 500  
**严重程度**：🔴 **高危** - 全部服务中断  

---

## 🚨 问题描述

### 现象

1. **所有微服务容器持续重启**
   - 10 个微服务（9001-9010 端口）全部无法启动
   - 容器状态：`Restarting (1)`，持续循环重启
   - 所有微服务端口未监听

2. **生产页面报错 500**
   - API 调用返回 `500 Internal Server Error`
   - 错误信息：`FileNotFoundError: [Errno 2] No such file or directory: '/Users/zhoudt/Downloads/project/HiFate-bazi/.cursor/debug.log'`

3. **MySQL 连接失败**
   - 错误：`Access denied for user 'root'@'172.19.0.4' (using password: NO)`
   - 容器内 `MYSQL_PASSWORD` 环境变量为空

### 影响

- ✅ Web 服务正常运行（8001 端口）
- ✅ Nginx 正常运行（80 端口）
- ❌ 所有微服务不可用（9001-9010 端口）
- ❌ API 调用失败，返回 500 错误
- ❌ 前端功能完全不可用

---

## 🔍 根因分析（基于代码事实）

### 问题 1：gRPC 代码兼容性问题

**直接原因**：
```
AttributeError: '_Server' object has no attribute 'add_registered_method_handlers'
```

**代码事实**：
1. 本地代码 `proto/generated/*_pb2_grpc.py` 包含 `server.add_registered_method_handlers()` 方法调用（第 85 行）
2. 本地实际安装的 `grpcio` 版本：**1.70.0**
3. `requirements.txt` 已更新为 `grpcio==1.70.0`
4. 该方法在 `grpcio 1.60.0-1.70.0` 运行时库中**不存在**

**根本原因**：
- 生成 gRPC 代码时使用的 `grpcio-tools` 版本较新
- 生成的代码包含新版本方法 `add_registered_method_handlers`
- 但该方法在目标版本运行时库中不存在
- **容器内代码来自镜像，未挂载 proto 目录，使用旧代码**

**为什么本地没问题**：
- 本地可能安装了更新版本的 grpcio（测试版或开发版）
- 或本地未运行微服务，仅运行主 Web 服务

---

### 问题 2：硬编码本地路径问题

**直接原因**：
```
FileNotFoundError: [Errno 2] No such file or directory: '/Users/zhoudt/Downloads/project/HiFate-bazi/.cursor/debug.log'
```

**代码事实**：
1. 代码中 19 处硬编码了本地路径：
   - `server/api/grpc_gateway.py`: 17 处
   - `server/api/v2/desk_fengshui_api.py`: 2 处
2. 路径格式：`/Users/zhoudt/Downloads/project/HiFate-bazi/.cursor/debug.log`
3. 生产环境不存在该路径

**根本原因**：
- 开发时在本地 Mac 上使用了硬编码路径
- 未考虑生产环境的路径差异
- 缺少异常处理，日志写入失败导致请求失败

---

### 问题 3：MySQL 密码配置问题

**直接原因**：
```
Access denied for user 'root'@'172.19.0.4' (using password: NO)
```

**代码事实**：
1. `.env` 文件中 `MYSQL_PASSWORD=Yuanqizhan@163` 正确
2. 容器内环境变量 `MYSQL_PASSWORD=` 为空
3. Docker Compose 配置使用了 `${MYSQL_PASSWORD}`，但未正确加载

**根本原因**：
- 容器启动时未正确加载 `.env` 文件
- 环境变量未传递到容器内
- 使用 `docker-compose restart` 而不是 `docker-compose up -d`，未重新加载环境变量

---

### 问题 4：容器代码同步问题

**直接原因**：
- 微服务容器未挂载 `proto` 目录
- 容器内使用的是镜像构建时的旧代码
- 服务器上修复的代码无法同步到容器内

**根本原因**：
- Docker Compose 配置缺少 `volumes` 配置
- 未为微服务容器添加代码目录挂载
- 导致代码不一致

---

## ✅ 解决方案

### 解决方案 1：修复 gRPC 代码兼容性

**步骤**：

1. **删除不兼容的方法调用**
   ```bash
   # 在服务器上执行
   find proto/generated -name "*_pb2_grpc.py" -exec sed -i "/server.add_registered_method_handlers/d" {} \;
   ```

2. **为所有微服务添加 proto 目录挂载**
   ```yaml
   # deploy/docker/docker-compose.prod.yml
   volumes:
     - /opt/HiFate-bazi/proto:/app/proto:ro
     - /opt/HiFate-bazi/services:/app/services:ro
     - /opt/HiFate-bazi/src:/app/src:ro
   ```

3. **创建修复脚本**
   - `scripts/grpc/fix_grpc_generated_code.py` - 自动修复脚本
   - `scripts/grpc/verify_grpc_fix.sh` - 验证脚本

**修复文件**：
- 所有 `proto/generated/*_pb2_grpc.py` 文件（10 个）
- `deploy/docker/docker-compose.prod.yml`（为所有微服务添加挂载）

---

### 解决方案 2：修复硬编码路径

**步骤**：

1. **移除所有调试日志代码**
   - 删除了 19 处硬编码路径的调试日志代码
   - 如需调试日志，使用动态路径：`logs/debug.log`

2. **添加异常处理**
   ```python
   # 如果必须使用日志，应添加异常处理
   try:
       os.makedirs(os.path.dirname(DEBUG_LOG_PATH), exist_ok=True)
       with open(DEBUG_LOG_PATH, 'a') as f:
           f.write(...)
   except Exception:
       pass  # 忽略日志写入错误，不影响业务
   ```

**修复文件**：
- `server/api/grpc_gateway.py`（移除 17 处）
- `server/api/v2/desk_fengshui_api.py`（移除 2 处）

---

### 解决方案 3：修复 MySQL 密码配置

**步骤**：

1. **确保容器使用 --env-file**
   ```bash
   docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml \
     --env-file /opt/HiFate-bazi/.env up -d web
   ```

2. **验证环境变量加载**
   ```bash
   docker exec hifate-web env | grep MYSQL_PASSWORD
   # 应该显示：MYSQL_PASSWORD=Yuanqizhan@163
   ```

3. **重启容器以应用配置**
   ```bash
   docker-compose restart web
   # 或
   docker-compose up -d --force-recreate web
   ```

---

### 解决方案 4：确保代码一致性

**步骤**：

1. **本地修复并提交**
   ```bash
   # 修复本地代码
   python3 scripts/grpc/fix_grpc_generated_code.py
   
   # 提交到 Git
   git add proto/generated deploy/docker/docker-compose.prod.yml
   git commit -m "fix: 修复 gRPC 兼容性和代码挂载"
   git push origin master
   ```

2. **生产环境同步**
   ```bash
   # 服务器拉取代码
   ssh root@server "cd /opt/HiFate-bazi && git pull origin master"
   
   # 修复生产环境代码
   ssh root@server "cd /opt/HiFate-bazi && find proto/generated -name '*_pb2_grpc.py' -exec sed -i '/server.add_registered_method_handlers/d' {} \;"
   
   # 重启容器（应用新配置）
   ssh root@server "cd /opt/HiFate-bazi/deploy/docker && docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml --env-file /opt/HiFate-bazi/.env up -d --force-recreate --no-deps bazi-core ..."
   ```

---

## 📊 修复验证

### 修复后状态

```
✅ 本地代码已修复（0 个问题文件）
✅ 容器内代码已修复（0 个问题文件）
✅ 所有微服务正常运行（10/10 个服务）
✅ Web服务健康检查通过
✅ Nginx健康检查通过
✅ MySQL密码配置正确
✅ 页面正常访问（HTTP 200）
✅ 无相关错误日志
```

### 验证脚本

```bash
# 运行验证脚本
bash scripts/grpc/verify_grpc_fix.sh
```

---

## 🔄 预防措施

### 1. 代码生成工具版本一致性

**规范要求**：
- ✅ gRPC 代码生成工具版本必须与运行时版本一致
- ✅ 生成的代码必须在目标版本中验证可用
- ✅ 使用 `scripts/grpc/fix_grpc_generated_code.py` 修复兼容性问题

**检查清单**：
- [ ] 生成 gRPC 代码后验证在目标版本中可用
- [ ] 检查是否有不兼容的方法调用
- [ ] 运行修复脚本确保兼容性

---

### 2. 路径配置规范

**规范要求**：
- ✅ **禁止硬编码本地路径**（如 `/Users/zhoudt/...`）
- ✅ 使用动态路径（基于项目根目录）
- ✅ 所有文件操作必须有异常处理
- ✅ 调试日志不应影响业务逻辑

**正确做法**：
```python
# ✅ 正确：使用动态路径
import os
PROJECT_ROOT = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
LOG_PATH = os.path.join(PROJECT_ROOT, 'logs', 'debug.log')

# ✅ 正确：添加异常处理
try:
    os.makedirs(os.path.dirname(LOG_PATH), exist_ok=True)
    with open(LOG_PATH, 'a') as f:
        f.write(log_message)
except Exception:
    pass  # 忽略日志写入错误，不影响业务

# ❌ 错误：硬编码本地路径
with open('/Users/zhoudt/Downloads/project/HiFate-bazi/.cursor/debug.log', 'a') as f:
    f.write(log_message)
```

**检查清单**：
- [ ] 代码中无硬编码路径
- [ ] 所有文件操作有异常处理
- [ ] 日志写入失败不影响业务

---

### 3. 环境变量配置规范

**规范要求**：
- ✅ 容器启动必须使用 `--env-file` 指定环境变量文件
- ✅ 环境变量必须从 `.env` 文件读取，不硬编码
- ✅ 容器重启后必须验证环境变量正确加载

**正确做法**：
```bash
# ✅ 正确：使用 --env-file
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml \
  --env-file /opt/HiFate-bazi/.env up -d web

# ✅ 正确：验证环境变量
docker exec hifate-web env | grep MYSQL_PASSWORD

# ❌ 错误：不使用 --env-file
docker-compose up -d web  # 环境变量未加载
```

**检查清单**：
- [ ] 容器启动使用 `--env-file`
- [ ] 环境变量验证正确
- [ ] 关键配置（如密码）从环境变量读取

---

### 4. 容器代码挂载规范

**规范要求**：
- ✅ 所有需要热更新的目录必须挂载
- ✅ 微服务容器必须挂载：`proto`、`services`、`src`
- ✅ 确保本地、容器、生产环境代码完全一致

**标准配置**：
```yaml
volumes:
  - /opt/HiFate-bazi/proto:/app/proto:ro  # gRPC 生成代码
  - /opt/HiFate-bazi/services:/app/services:ro  # 微服务代码
  - /opt/HiFate-bazi/src:/app/src:ro  # 核心代码
```

**检查清单**：
- [ ] 所有微服务容器都有 volumes 配置
- [ ] proto 目录已挂载
- [ ] 容器内代码与服务器代码一致

---

## 📝 相关提交

1. `fix: 修复 gRPC 生成代码兼容性问题`
2. `fix: 为所有微服务添加 proto 目录挂载，确保代码一致性`
3. `fix: 修复生产环境硬编码路径问题`
4. `fix: 完成生产页面报错修复`

---

## 📚 相关文档

- `scripts/grpc/fix_grpc_generated_code.py` - gRPC 代码修复脚本
- `scripts/grpc/verify_grpc_fix.sh` - gRPC 修复验证脚本
- `deploy/docker/docker-compose.prod.yml` - Docker Compose 配置

---

## 🎯 经验教训

1. **代码生成工具版本必须与运行时版本一致**
   - 生成代码的工具版本可能影响代码兼容性
   - 必须验证生成的代码在目标版本中可用

2. **禁止硬编码路径**
   - 所有路径必须基于项目根目录动态获取
   - 考虑跨平台兼容性（Mac/Windows/Linux）

3. **容器配置必须完整**
   - 所有需要热更新的目录都必须挂载
   - 环境变量必须正确传递

4. **代码一致性是系统稳定性的基础**
   - 本地、容器、生产环境必须完全一致
   - 通过 Git 和容器挂载确保一致性

---

## ⏰ 修复时间线

- **14:00** - 发现问题：所有微服务崩溃
- **14:15** - 诊断：gRPC 兼容性问题
- **14:30** - 修复：删除 add_registered_method_handlers
- **14:45** - 发现：容器代码未同步
- **15:00** - 修复：添加 proto 目录挂载
- **15:15** - 发现：硬编码路径问题
- **15:30** - 修复：移除硬编码路径
- **15:45** - 修复：MySQL 密码配置
- **16:00** - 验证：所有服务正常运行

**总耗时**：约 2 小时

---

## ✅ 修复检查清单

- [x] gRPC 代码兼容性问题已修复
- [x] 硬编码路径问题已修复
- [x] MySQL 密码配置已修复
- [x] 容器代码挂载已配置
- [x] 本地、容器、生产环境代码一致
- [x] 所有服务正常运行
- [x] 页面访问正常
- [x] 无错误日志
- [x] 问题复盘文档已创建
- [x] 开发规范已更新

