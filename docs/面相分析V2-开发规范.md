# 面相分析V2 - 开发规范

> 本规范是面相分析系统的核心设计原则，所有后续开发必须遵循此规范。

---

## 🎯 特别说明：从根源解决互斥问题

**核心思想**：互斥问题必须在**特征识别阶段**和**规则匹配阶段**解决，而不是页面展示阶段。

**详细方案**：见 [互斥问题根源解决方案](./面相分析V2-互斥问题根源解决方案.md)

---

## 📋 核心原则

### 1. ⚖️ 规则互斥原则 【最重要】

**定义**：同一个宫位/特征点的不同断语，如果是互斥关系，必须按置信度选择最优的一条。

**示例**：

```json
{
  "position": "天中",
  "interpretations": [
    {
      "feature": "饱满明润",
      "interpretation": "早年得志，15-16岁学业顺利，智慧聪颖",
      "confidence": 0.9
    },
    {
      "feature": "凹陷暗沉",
      "interpretation": "早年不利，家境一般，需靠自己奋斗",
      "confidence": 0.3
    }
  ]
}
```

**互斥规则**：
- "饱满明润" vs "凹陷暗沉" → 互斥（正面 vs 负面）
- 系统检测到置信度：饱满=0.9，凹陷=0.3
- **只返回**："早年得志，15-16岁学业顺利，智慧聪颖"
- **排除**："早年不利，家境一般，需靠自己奋斗"

**互斥关键词对照表**：

| 正面特征 | 负面特征 | 说明 |
|---------|---------|------|
| 饱满、明润、开阔 | 凹陷、暗沉、狭窄 | 形态互斥 |
| 高起、挺直、圆润 | 低陷、弯曲、尖薄 | 形状互斥 |
| 宽阔、长、深 | 窄小、短、浅 | 尺寸互斥 |
| 红润、光泽、明亮 | 暗淡、发黑、无光 | 气色互斥 |
| 得志、顺利、有成 | 不利、辛苦、波折 | 运势互斥 |

**实现要求**：
1. 每次返回断语前，必须执行互斥检查
2. 按置信度降序排序
3. 优先返回置信度最高的断语
4. 互斥的低置信度断语不返回

---

### 2. 🔄 去重合并原则

**定义**：同一位置的相同特征，只显示一次，避免重复。

**场景示例**：

```
输入：
- 天庭：饱满明润 → "聪明智慧"
- 天庭：饱满明润 → "17-18岁学业有成"
- 天庭：饱满明润 → "家庭背景好"

输出（合并）：
- 天庭：
  * 聪明智慧
  * 17-18岁学业有成
  * 家庭背景好
```

**实现要求**：
1. 按 `(位置, 分类)` 分组
2. 去除完全重复的断语
3. 保持原始优先级顺序
4. 最多返回前3-5条最重要的断语

---

### 3. 📊 置信度计算原则

**定义**：每个特征都应该有置信度分数，用于互斥判断。

**计算方法**：

```python
置信度 = 基础分数 + 关键词匹配度 + 图像特征匹配度

基础分数 = 0.5（默认）
关键词匹配度 = 0.0 ~ 0.3（根据关键词）
图像特征匹配度 = 0.0 ~ 0.2（根据实际检测）
```

**关键词评分表**：

| 关键词类别 | 关键词 | 加分 |
|-----------|--------|------|
| 明显正面 | 饱满、明润、开阔、圆润 | +0.2 |
| 一般正面 | 平满、光洁、端正 | +0.1 |
| 明显负面 | 凹陷、暗沉、尖薄 | +0.2 |
| 一般负面 | 狭窄、短小、削瘦 | +0.1 |
| 中性 | 一般、普通 | +0.0 |

**实现要求**：
1. 每条规则必须有置信度字段
2. 置信度范围：0.0 ~ 1.0
3. 默认置信度：0.5
4. 互斥判断时，置信度差距 > 0.3 才触发排除

---

### 4. 🎯 规则优先级原则

**定义**：不同宫位有不同的重要性，优先级高的优先展示。

**优先级等级**：

| 等级 | 分数 | 宫位示例 | 说明 |
|------|------|---------|------|
| 极高 | 90-100 | 印堂、准头 | 命宫、财帛宫，最重要 |
| 高 | 80-89 | 天庭、地阁、夫妻宫 | 重要宫位 |
| 中 | 70-79 | 山根、六亲宫 | 一般宫位 |
| 低 | 60-69 | 承浆、奴仆宫 | 次要宫位 |

**实现要求**：
1. 每条规则必须有 priority 字段
2. 结果返回时按优先级排序
3. 前端展示时，优先级高的放在前面

---

### 5. 📂 数据结构规范

**规则数据格式**：

```json
{
  "rule_type": "gongwei",           // 规则类型：gongwei/liuqin/shishen/feature
  "position": "印堂",                // 位置名称
  "position_code": "yintang",       // 位置编码
  "conditions": {                    // 匹配条件
    "region": "between_eyebrows",
    "features": ["开阔", "平满", "明润"]
  },
  "interpretations": [               // 断语列表
    {
      "feature": "开阔平满",         // 特征描述
      "interpretation": "命宫开阔，运势亨通",  // 断语
      "category": "综合",            // 分类
      "confidence": 0.8              // 置信度（可选）
    }
  ],
  "priority": 100                    // 优先级
}
```

**API响应格式**：

```json
{
  "success": true,
  "data": {
    "gongwei_analysis": [
      {
        "name": "印堂",
        "position": "两眉之间",
        "features": ["开阔", "明润"],
        "interpretations": [
          "命宫开阔，28岁运势极佳",
          "心胸宽广，为人正直"
        ],
        "category": "综合",
        "confidence": 0.9
      }
    ]
  }
}
```

---

## 🔧 开发流程规范

### 1. 添加新规则

**步骤**：

1. 编辑规则JSON文件：
   ```bash
   vim data/face_rules_v2/gongwei_rules.json
   ```

2. 添加新规则（遵循数据格式）：
   ```json
   {
     "rule_type": "gongwei",
     "position": "新宫位",
     "conditions": {...},
     "interpretations": [...],
     "priority": 75
   }
   ```

3. 检查互斥关系：
   - 是否与现有规则冲突？
   - 特征是否互斥？
   - 置信度是否合理？

4. 重新导入规则：
   ```bash
   python scripts/import_face_rules_v2.py
   ```

5. 重启服务：
   ```bash
   pkill -f "python.*main.py"
   .venv/bin/python server/main.py
   ```

### 2. 修改规则

**注意事项**：
- ✅ 修改前备份原规则
- ✅ 修改后测试互斥逻辑
- ✅ 验证置信度计算
- ⚠️ 不要直接修改数据库（通过JSON维护）

### 3. 测试规则

**测试清单**：

```bash
# 1. 查询规则
curl "http://localhost:8001/api/v2/face/rules/gongwei?position=印堂"

# 2. 上传测试图片
curl -X POST http://localhost:8001/api/v2/face/analyze \
  -F "image=@test.jpg" \
  -F "analysis_types=gongwei"

# 3. 检查返回结果
# - 是否有重复断语？
# - 互斥规则是否正确排除？
# - 置信度是否合理？
```

---

## 🏗️ 架构规范

### 分层原则

```
前端 → API层 → 微服务层 → 规则引擎 → 数据库
```

**职责分明**：
- **前端**：只负责展示，不做规则判断
- **API层**：参数验证、格式转换
- **微服务层**：特征提取、宫位计算
- **规则引擎**：互斥判断、去重合并
- **数据库**：规则存储

### 数据流向

```
图片上传 
  ↓
人脸检测（MediaPipe 468点）
  ↓
特征映射（99个面相点）
  ↓
宫位分析（十三宫位、六亲等）
  ↓
规则匹配（查询知识库）
  ↓
互斥过滤（RuleMatcher.match_and_filter）
  ↓
去重合并（RuleMatcher.merge_duplicate_rules）
  ↓
格式化输出
  ↓
返回给前端
```

---

## 🚫 严禁操作

### 1. 不可直接修改数据库规则
- ❌ 不要直接 UPDATE face_rules_v2
- ✅ 应该修改 JSON 文件后重新导入

### 2. 不可跳过互斥检查
- ❌ 不要直接返回所有规则
- ✅ 必须经过 RuleMatcher 过滤

### 3. 不可返回重复断语
- ❌ 不要重复显示相同内容
- ✅ 必须去重合并

### 4. 不可修改现有系统
- ❌ 不要改动 mianxiang_hand_fengshui/
- ✅ 完全独立开发

---

## 📐 置信度阈值规范

### 互斥判断阈值

```python
# 置信度差距超过此值，触发互斥排除
MUTEX_THRESHOLD = 0.3

示例：
- 规则A：置信度 0.9
- 规则B：置信度 0.5
- 差距 = 0.9 - 0.5 = 0.4 > 0.3
- 结论：B被排除（因为与A互斥且置信度低）
```

### 最小置信度阈值

```python
# 低于此值的规则不返回
MIN_CONFIDENCE = 0.3

示例：
- 规则置信度 0.2 → 不返回
- 规则置信度 0.5 → 正常返回
```

### 最大返回数量

```python
# 每个位置最多返回的断语数量
MAX_INTERPRETATIONS_PER_POSITION = 5

# 如果超过5条，按 (置信度, 优先级) 排序后取前5
```

---

## 🎨 前端展示规范

### 结果分组展示

```html
宫位名称（印堂）
├─ 分类1（事业）
│  ├─ 断语1（置信度0.9）
│  └─ 断语2（置信度0.8）
├─ 分类2（健康）
│  └─ 断语3（置信度0.7）
```

### 置信度标识（可选）

- 0.8 ~ 1.0：⭐⭐⭐ 高度匹配
- 0.6 ~ 0.8：⭐⭐ 较匹配
- 0.3 ~ 0.6：⭐ 一般匹配
- < 0.3：不显示

### 颜色标识（可选）

- **正面断语**：绿色/蓝色
- **负面断语**：橙色/黄色
- **警示断语**：红色

---

## 💾 数据库规范

### 字符编码

```sql
-- 必须使用 utf8mb4
CREATE TABLE face_rules_v2 (
    ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 必需字段

```sql
rule_type VARCHAR(50) NOT NULL,      -- 规则类型
position VARCHAR(100) NOT NULL,       -- 位置
conditions JSON NOT NULL,             -- 条件
interpretation TEXT NOT NULL,         -- 断语
category VARCHAR(50),                 -- 分类
priority INT DEFAULT 50,              -- 优先级
enabled TINYINT(1) DEFAULT 1,         -- 是否启用
confidence FLOAT DEFAULT 0.8          -- 默认置信度
```

### 索引要求

```sql
INDEX idx_rule_type (rule_type),
INDEX idx_position (position),
INDEX idx_category (category),
INDEX idx_enabled (enabled)
```

---

## 🔍 规则匹配算法

### 匹配流程

```python
def match_rules(position, features):
    # 1. 查询该位置的所有规则
    rules = query_rules_by_position(position)
    
    # 2. 计算每条规则的置信度
    for rule in rules:
        rule.confidence = calculate_confidence(rule, features)
    
    # 3. 过滤低置信度规则
    rules = [r for r in rules if r.confidence >= MIN_CONFIDENCE]
    
    # 4. 应用互斥规则
    rules = apply_mutex_filter(rules)
    
    # 5. 去重合并
    rules = merge_duplicates(rules)
    
    # 6. 按优先级和置信度排序
    rules = sorted(rules, key=lambda r: (r.priority, r.confidence), reverse=True)
    
    # 7. 限制返回数量
    return rules[:MAX_INTERPRETATIONS_PER_POSITION]
```

### 互斥判断算法

```python
def apply_mutex_filter(rules):
    # 按位置分组
    groups = group_by_position(rules)
    
    filtered = []
    for position, group in groups.items():
        # 按置信度排序
        sorted_group = sorted(group, key=lambda r: r.confidence, reverse=True)
        
        selected = []
        for rule in sorted_group:
            # 检查是否与已选择的规则互斥
            is_mutex = False
            for selected_rule in selected:
                if is_mutex_relation(rule, selected_rule):
                    # 互斥且置信度低，排除
                    is_mutex = True
                    break
            
            if not is_mutex:
                selected.append(rule)
        
        filtered.extend(selected)
    
    return filtered
```

---

## 📝 规则编写规范

### 规则命名规范

```
规则位置_特征类型_序号

示例：
- 印堂_开阔_001
- 天中_饱满_001
- 天中_凹陷_002（与001互斥）
```

### 特征描述规范

**要求**：
1. 简洁明确（4-8个字）
2. 包含关键特征词
3. 避免模糊描述

**示例**：

✅ 好的描述：
- "饱满明润"
- "开阔平满"
- "鼻头圆润有肉"

❌ 不好的描述：
- "比较好"（太模糊）
- "额头不错"（不明确）
- "看起来还可以"（口语化）

### 断语编写规范

**要求**：
1. 明确具体（不要太笼统）
2. 包含年龄段/时间点（如有）
3. 包含领域分类（事业/财运/婚姻/健康）
4. 正面和负面都要有

**模板**：

```
[时间段] + [事件描述] + [结果/建议]

正面示例：
"28岁运势极佳，事业爱情双丰收，心胸宽广"

负面示例：
"28岁运势波折，需谨慎行事，调整心态"
```

---

## 🧪 测试规范

### 单元测试

```python
# test_rule_matcher.py

def test_mutex_rules():
    """测试互斥规则"""
    rules = [
        {'position': '天中', 'feature': '饱满明润', 'confidence': 0.9},
        {'position': '天中', 'feature': '凹陷暗沉', 'confidence': 0.3}
    ]
    
    result = rule_matcher.apply_mutex_filter(rules)
    
    # 应该只返回高置信度的
    assert len(result) == 1
    assert result[0]['feature'] == '饱满明润'

def test_merge_duplicates():
    """测试去重合并"""
    rules = [
        {'position': '印堂', 'feature': '开阔', 'interpretation': 'A'},
        {'position': '印堂', 'feature': '开阔', 'interpretation': 'B'},
    ]
    
    result = rule_matcher.merge_duplicates(rules)
    
    # 应该合并为一条，包含两个断语
    assert len(result) == 1
    assert len(result[0]['interpretations']) == 2
```

### 集成测试

```bash
# 1. 上传标准测试照片
curl -X POST http://localhost:8001/api/v2/face/analyze \
  -F "image=@test_standard_face.jpg"

# 2. 检查结果
# - 每个宫位是否只有一条主要特征？
# - 是否有重复断语？
# - 互斥规则是否正确处理？
```

---

## 📊 性能规范

### 响应时间要求

- 人脸检测：< 3秒
- 规则匹配：< 1秒
- 总体响应：< 5秒

### 并发要求

- 支持 10 QPS（初期）
- 支持 50 QPS（优化后）

### 缓存策略

```python
# 相同图片（hash）的分析结果缓存5分钟
CACHE_TTL = 300

# Redis key格式
cache_key = f"face_analysis:v2:{image_hash}"
```

---

## 🔄 版本管理规范

### 规则版本号

```
格式：v{major}.{minor}.{patch}

示例：
- v1.0.0：初始版本
- v1.1.0：新增10条规则
- v1.1.1：修复互斥逻辑bug
```

### 变更记录

```sql
INSERT INTO face_rule_versions (version_number, description, rule_count) VALUES
('v1.0.0', '初始版本，包含宫位、六亲、十神规则', 150),
('v1.1.0', '新增流年规则，优化互斥逻辑', 180);
```

---

## 📖 文档规范

### 代码注释

```python
def analyze_gongwei(self, features: Dict) -> List[Dict]:
    """
    分析宫位
    
    Args:
        features: 特征字典，包含位置和属性
    
    Returns:
        宫位分析结果列表
    
    互斥规则：
        - 同一宫位的正负面特征互斥
        - 按置信度选择最佳匹配
    
    去重规则：
        - 同一特征只返回一次
        - 多条断语合并显示
    """
```

### 规则文档

每个规则文件应包含：
1. 规则总数
2. 覆盖的宫位
3. 互斥关系说明
4. 更新日期

---

## 🎯 开发检查清单

每次开发完成后，检查：

- [ ] 规则是否有互斥关系定义？
- [ ] 置信度计算是否合理？
- [ ] 是否有重复断语？
- [ ] 优先级是否正确设置？
- [ ] 数据库字符编码是否utf8mb4？
- [ ] API返回格式是否规范？
- [ ] 是否添加了测试用例？
- [ ] 是否更新了文档？

---

## 🔑 核心代码示例

### 正确的规则匹配流程

```python
# services/face_knowledge_v2/service.py

def get_interpretation(self, rule_type: str, position: str, 
                      features: Dict = None, confidence_scores: Dict = None):
    """获取断语（应用互斥和去重）"""
    
    # 1. 查询规则
    rules = self.query_rules(rule_type, position)
    
    # 2. 应用互斥和去重
    matched_rules = self.rule_matcher.match_and_filter(
        rules, features or {}, confidence_scores
    )
    
    # 3. 提取断语
    interpretations = []
    for rule in matched_rules:
        if isinstance(rule.get('interpretations'), list):
            interpretations.extend(rule['interpretations'])
    
    # 4. 去重（完全相同的断语只保留一次）
    interpretations = list(dict.fromkeys(interpretations))
    
    # 5. 限制数量
    return interpretations[:5]
```

---

## 📋 规则示例（正确格式）

```json
{
  "十三宫位规则": [
    {
      "rule_type": "gongwei",
      "position": "天中",
      "position_code": "tianchong",
      "conditions": {
        "region": "forehead_top",
        "features": ["饱满", "平润", "光洁"]
      },
      "interpretations": [
        {
          "feature": "饱满明润",
          "interpretation": "早年得志，15-16岁学业顺利，智慧聪颖",
          "category": "事业",
          "confidence": 0.85
        },
        {
          "feature": "凹陷暗沉",
          "interpretation": "早年不利，家境一般，需靠自己奋斗",
          "category": "事业",
          "confidence": 0.80,
          "mutex_with": ["饱满明润"]
        }
      ],
      "priority": 80
    }
  ]
}
```

**说明**：
- 两条互斥的断语在同一规则内
- 明确标注 mutex_with 字段
- 系统自动按置信度选择

---

## 🚀 后续扩展规范

### 新增分析维度

1. 确定宫位系统（如：面相流年）
2. 定义数据结构
3. 编写规则JSON
4. 实现分析器
5. 添加API接口
6. 更新前端展示

### 新增特征

1. 确定特征点位置
2. 更新 feature_mapper.py 映射
3. 添加规则数据
4. 测试验证

---

## 📞 问题排查

### 出现重复断语

**检查**：
1. `rule_matcher.merge_duplicates()` 是否调用？
2. 前端是否去重？
3. 数据库是否有重复规则？

### 互斥规则未生效

**检查**：
1. 置信度计算是否正确？
2. 互斥关键词是否定义？
3. `_apply_mutex_rules()` 是否调用？

### 置信度异常

**检查**：
1. 关键词匹配是否正确？
2. 基础分数是否设置？
3. 范围是否在 0-1 之间？

---

## ✅ 完成标准

每个功能开发完成需满足：

1. ✅ 规则互斥正确（无冲突断语）
2. ✅ 结果去重完整（无重复显示）
3. ✅ 置信度合理（符合实际）
4. ✅ 测试通过（单元+集成）
5. ✅ 文档更新（注释+使用指南）

---

**本规范是面相分析系统的基石，所有后续开发必须严格遵循！** ⚠️

---

更新日期：2024-11-26
版本：v1.0.0

