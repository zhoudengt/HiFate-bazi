# 工程化开发流程使用指南

本文档提供了工程化开发流程的完整使用指南，帮助开发者快速上手，确保功能开发一次性成功率 ≥ 98%。

## 一、快速开始

### 1.1 开发前准备

**每次开发新功能前，必须执行**：

```bash
# 1. 运行开发前检查
python3 scripts/dev/dev_flow_check.py --pre-dev

# 2. 创建功能分支
git checkout -b feature/xxx
```

### 1.2 开发中检查

**每次代码修改后，建议执行**：

```bash
# 1. 检查修改的文件
python3 scripts/dev/dev_flow_check.py --files <修改的文件>

# 2. 运行相关测试
pytest tests/unit/test_xxx.py -v

# 3. 验证热更新
curl -X POST http://localhost:8001/api/v1/hot-reload/check
```

### 1.3 开发完成检查

**提交代码前，必须执行**：

```bash
# 1. 完整检查
python3 scripts/dev/dev_flow_check.py --all

# 2. 运行所有测试
python3 scripts/test/auto_test.py --all

# 3. 代码审查
python3 scripts/review/code_review_check.py
```

### 1.4 部署

**部署前，必须执行**：

```bash
# 1. 提交代码
git add .
git commit -m "feat: 新功能"
git push origin master

# 2. 增量部署
python3 scripts/deploy/auto_deploy.py --mode incremental
```

## 二、工具使用详解

### 2.1 开发流程检查工具

**工具位置**：`scripts/dev/dev_flow_check.py`

**功能**：
- 代码规范检查
- 完整性检查（gRPC 注册、路由注册、热更新支持）
- 命名规范检查
- 测试覆盖检查

**使用示例**：
```bash
# 开发前检查
python3 scripts/dev/dev_flow_check.py --pre-dev

# 检查指定文件
python3 scripts/dev/dev_flow_check.py --files server/api/v1/bazi.py

# 完整检查
python3 scripts/dev/dev_flow_check.py --all

# 输出 JSON 报告
python3 scripts/dev/dev_flow_check.py --all --json
```

### 2.2 命名规范检查工具

**工具位置**：`scripts/dev/check_naming.py`

**功能**：
- 变量命名检查（snake_case）
- 函数命名检查（snake_case）
- 类命名检查（PascalCase）
- 常量命名检查（UPPER_SNAKE_CASE）
- 文件命名检查（snake_case.py）

**使用示例**：
```bash
# 检查指定文件
python3 scripts/dev/check_naming.py server/api/v1/bazi.py

# 检查所有文件
python3 scripts/dev/check_naming.py --all

# 检查变更的文件（自动）
python3 scripts/dev/check_naming.py
```

### 2.3 快速修改工具

**工具位置**：`scripts/dev/quick_fix.py`

**功能**：
- 自动诊断常见问题
- 生成修复建议
- 快速验证修复结果

**使用示例**：
```bash
# 诊断问题
python3 scripts/dev/quick_fix.py --diagnose

# 修复问题（指定类型）
python3 scripts/dev/quick_fix.py --fix syntax

# 验证修复结果
python3 scripts/dev/quick_fix.py --verify

# 全流程（诊断、修复、验证）
python3 scripts/dev/quick_fix.py --all
```

### 2.4 测试自动化工具

**工具位置**：`scripts/test/auto_test.py`

**功能**：
- 自动执行所有测试
- 生成测试报告
- 生成覆盖率报告

**使用示例**：
```bash
# 运行所有测试
python3 scripts/test/auto_test.py --all

# 只运行单元测试
python3 scripts/test/auto_test.py --unit

# 只运行 API 测试
python3 scripts/test/auto_test.py --api

# 生成覆盖率报告
python3 scripts/test/auto_test.py --coverage

# 输出 JSON 报告
python3 scripts/test/auto_test.py --all --json
```

### 2.5 部署自动化工具

**工具位置**：`scripts/deploy/auto_deploy.py`

**功能**：
- 部署前检查（代码一致性、语法验证、依赖检查）
- 自动部署（增量部署或完整部署）
- 部署后验证（健康检查、功能验证）
- 自动回滚（部署失败时）

**使用示例**：
```bash
# 增量部署（推荐）
python3 scripts/deploy/auto_deploy.py --mode incremental

# 完整部署（依赖变更时）
python3 scripts/deploy/auto_deploy.py --mode full

# 只检查，不部署
python3 scripts/deploy/auto_deploy.py --check-only

# 输出 JSON 报告
python3 scripts/deploy/auto_deploy.py --mode incremental --json
```

## 三、检查清单使用

### 3.1 规则开发检查清单

**文件位置**：`docs/checklists/rule_development_checklist.md`

**使用场景**：开发新规则类型时

**检查项包括**：
- 数据库设计阶段
- 数据导入阶段
- 后端开发阶段
- 前端开发阶段
- 测试阶段
- 代码审查阶段
- 部署阶段

**使用方法**：
1. 打开检查清单文件
2. 按照清单逐项检查
3. 每完成一项，勾选对应的复选框
4. 所有项完成后，功能开发完成

### 3.2 API 开发检查清单

**文件位置**：`docs/checklists/api_development_checklist.md`

**使用场景**：开发新 API 接口时

**检查项包括**：
- 后端开发阶段
- 测试阶段
- 代码审查阶段
- 部署阶段

### 3.3 前端开发检查清单

**文件位置**：`docs/checklists/frontend_development_checklist.md`

**使用场景**：开发新前端页面时

**检查项包括**：
- 前端开发阶段
- 测试阶段
- 代码审查阶段
- 部署阶段

### 3.4 数据库变更检查清单

**文件位置**：`docs/checklists/db_change_checklist.md`

**使用场景**：进行数据库变更时

**检查项包括**：
- 变更前准备
- 变更脚本开发阶段
- 变更执行阶段（Node1 灰度节点）
- 变更执行阶段（Node2 生产节点）
- 变更后验证
- 回滚准备

## 四、常见场景流程

### 4.1 场景：开发新规则

**完整流程**：

```bash
# 1. 开发前准备
python3 scripts/dev/dev_flow_check.py --pre-dev
git checkout -b feature/rule-xxx

# 2. 数据库设计
# 创建表脚本：scripts/migration/create_xxx_table.py
python3 scripts/migration/create_xxx_table.py

# 3. 数据导入
# 解析脚本：scripts/migration/import_xxx_rules.py
python3 scripts/migration/import_xxx_rules.py
# 导入脚本：scripts/migration/import_xxx_rules_to_db.py
python3 scripts/migration/import_xxx_rules_to_db.py

# 4. 后端开发
# API 文件：server/api/v1/xxx.py
# 服务文件：server/services/xxx_service.py
# 注册 gRPC：server/api/grpc_gateway.py
# 注册路由：server/main.py

# 5. 开发中检查
python3 scripts/dev/dev_flow_check.py --files server/api/v1/xxx.py
pytest tests/unit/test_xxx.py -v

# 6. 前端开发
# 页面文件：local_frontend/xxx.html
# JS 文件：local_frontend/js/xxx.js

# 7. 开发完成检查
python3 scripts/dev/dev_flow_check.py --all
python3 scripts/test/auto_test.py --all

# 8. 部署
git add .
git commit -m "feat: 新增规则类型 xxx"
git push origin master
python3 scripts/deploy/auto_deploy.py --mode incremental
```

**检查清单**：使用 `docs/checklists/rule_development_checklist.md`

### 4.2 场景：开发新 API

**完整流程**：

```bash
# 1. 开发前准备
python3 scripts/dev/dev_flow_check.py --pre-dev
git checkout -b feature/api-xxx

# 2. 后端开发
# API 文件：server/api/v1/xxx.py
# 注册 gRPC：server/api/grpc_gateway.py
# 注册路由：server/main.py

# 3. 开发中检查
python3 scripts/dev/dev_flow_check.py --files server/api/v1/xxx.py
pytest tests/unit/test_xxx.py -v

# 4. 开发完成检查
python3 scripts/dev/dev_flow_check.py --all
python3 scripts/test/auto_test.py --all

# 5. 部署
git add .
git commit -m "feat: 新增 API xxx"
git push origin master
python3 scripts/deploy/auto_deploy.py --mode incremental
```

**检查清单**：使用 `docs/checklists/api_development_checklist.md`

### 4.3 场景：修改现有功能

**完整流程**：

```bash
# 1. 诊断问题
python3 scripts/dev/quick_fix.py --diagnose

# 2. 修复问题
# 修改代码...

# 3. 验证修复
python3 scripts/dev/quick_fix.py --verify
python3 scripts/dev/dev_flow_check.py --files <修改的文件>
pytest tests/unit/test_xxx.py -v

# 4. 部署
git add .
git commit -m "fix: 修复 xxx 问题"
git push origin master
python3 scripts/deploy/auto_deploy.py --mode incremental
```

## 五、成功标准

### 5.1 开发效率指标

- **开发时间**：减少 50% 以上
- **修改时间**：减少 70% 以上
- **测试时间**：减少 60% 以上
- **部署时间**：减少 80% 以上

### 5.2 质量指标

- **一次性成功率**：≥ 98%
- **测试覆盖率**：≥ 50%（核心模块 ≥ 70%）
- **代码审查通过率**：≥ 95%
- **部署成功率**：≥ 99%

### 5.3 问题预防指标

- **命名规范问题**：0 个（自动化检查）
- **代码规范问题**：0 个（自动化检查）
- **测试遗漏**：< 5%（自动化测试）
- **部署失败**：< 1%（自动化验证）

## 六、故障排查

### 6.1 开发流程检查失败

**问题**：`python3 scripts/dev/dev_flow_check.py --all` 失败

**排查步骤**：
1. 查看错误信息，确定失败的具体检查项
2. 根据错误信息修复问题
3. 重新运行检查

**常见问题**：
- gRPC 端点未注册 → 在 `grpc_gateway.py` 中注册
- 路由未注册 → 在 `main.py` 中注册
- 命名不规范 → 使用 `check_naming.py` 检查并修复

### 6.2 测试失败

**问题**：`python3 scripts/test/auto_test.py --all` 失败

**排查步骤**：
1. 查看测试输出，确定失败的测试用例
2. 运行单个测试用例定位问题
3. 修复问题后重新运行测试

**常见问题**：
- 测试数据不正确 → 更新测试数据
- API 接口变更 → 更新测试用例
- 环境问题 → 检查测试环境配置

### 6.3 部署失败

**问题**：`python3 scripts/deploy/auto_deploy.py --mode incremental` 失败

**排查步骤**：
1. 查看部署日志，确定失败阶段
2. 检查部署前检查是否通过
3. 检查服务器连接是否正常
4. 检查代码是否已推送到 GitHub

**常见问题**：
- 代码未推送 → 先推送到 GitHub
- 服务器连接失败 → 检查 SSH 配置
- 热更新失败 → 检查热更新服务状态

## 七、最佳实践

### 7.1 开发阶段

1. **每次修改后立即检查**：不要等到最后才检查
2. **使用检查清单**：确保不遗漏任何步骤
3. **及时修复问题**：发现问题立即修复，不要积累

### 7.2 测试阶段

1. **编写测试用例**：开发功能时同步编写测试
2. **运行所有测试**：确保没有破坏现有功能
3. **检查覆盖率**：确保测试覆盖率达标

### 7.3 部署阶段

1. **部署前检查**：确保所有检查通过
2. **部署后验证**：确保功能正常
3. **监控日志**：部署后持续监控

## 八、相关文档

- **规则开发检查清单**：`docs/checklists/rule_development_checklist.md`
- **API 开发检查清单**：`docs/checklists/api_development_checklist.md`
- **前端开发检查清单**：`docs/checklists/frontend_development_checklist.md`
- **数据库变更检查清单**：`docs/checklists/db_change_checklist.md`
- **开发规范文档**：`.cursorrules`

## 九、总结

通过使用工程化开发流程，可以：

1. **提高开发效率**：自动化检查减少人工检查时间
2. **提高代码质量**：自动化检查确保代码符合规范
3. **提高一次性成功率**：完整检查清单确保不遗漏步骤
4. **快速定位问题**：自动化工具快速诊断问题
5. **快速修复问题**：自动化工具快速修复常见问题

**核心原则**：
- ✅ 所有功能开发必须使用工程化工具
- ✅ 所有功能开发必须使用检查清单
- ✅ 所有检查必须通过才能提交代码
- ✅ 所有测试必须通过才能部署

