# 模型微调服务使用指南

## 🚀 快速开始

### 1. 初始化数据库表

```bash
# 执行SQL脚本创建表
mysql -h localhost -u root -p hifate_bazi < server/db/migrations/create_intent_training_tables.sql

# 验证表是否创建成功
mysql -h localhost -u root -p hifate_bazi -e "SHOW TABLES LIKE 'intent%';"
```

### 2. 验证问题记录功能

问题记录功能已自动集成到智能运势分析API中，每次调用API时会自动记录用户问题。

**测试**：
```bash
# 调用智能运势分析API（会自动记录问题）
curl "http://localhost:8001/api/v1/smart-fortune/smart-analyze?question=今年适合投资吗?&year=1990&month=5&day=15&hour=12&gender=male"
```

### 3. 查看统计信息

```bash
curl http://localhost:8001/api/v1/model-tuning/stats
```

**返回示例**：
```json
{
  "success": true,
  "questions": {
    "total": 100,
    "labeled": 20,
    "unlabeled": 80,
    "labeling_rate": 0.2
  },
  "training_batches": {
    "total": 5,
    "completed": 3,
    "training": 1,
    "failed": 1
  },
  "keyword_rules": {
    "total": 50
  },
  "model_versions": {
    "total": 3,
    "active": "v20251202_143000"
  }
}
```

## 📝 问题标注流程

### 步骤1：获取未标注问题

```bash
curl "http://localhost:8001/api/v1/model-tuning/questions/unlabeled?limit=100&min_confidence=0.0"
```

**返回示例**：
```json
{
  "success": true,
  "questions": [
    {
      "id": 1,
      "question": "今年适合投资吗？",
      "intents": ["wealth"],
      "confidence": 0.95,
      "method": "local_model",
      "created_at": "2025-12-02 16:20:00"
    }
  ],
  "total": 100
}
```

### 步骤2：标注问题

```bash
curl -X POST "http://localhost:8001/api/v1/model-tuning/questions/1/label" \
  -H "Content-Type: application/json" \
  -d '{
    "correct_intent": ["wealth"],
    "correct_time_intent": {
      "type": "this_year",
      "target_years": [2025],
      "description": "今年（2025年）",
      "is_explicit": true
    },
    "labeler_id": "admin"
  }'
```

**建议**：
- 优先标注低置信度问题（置信度<0.7）
- 每周标注50-100条问题
- 确保各类意图的数据量相对平衡

## 🎓 模型训练流程

### 步骤1：创建训练批次

```bash
curl -X POST "http://localhost:8001/api/v1/model-tuning/batches" \
  -H "Content-Type: application/json" \
  -d '{
    "min_confidence": 0.0,
    "description": "首次训练 - 基于100条标注数据"
  }'
```

**返回**：
```json
{
  "success": true,
  "batch_id": "batch_20251202_143000_abc12345"
}
```

### 步骤2：执行训练

```bash
curl -X POST "http://localhost:8001/api/v1/model-tuning/batches/batch_20251202_143000_abc12345/run" \
  -H "Content-Type: application/json" \
  -d '{
    "auto_extract_keywords": true
  }'
```

**返回**：
```json
{
  "success": true,
  "batch_id": "batch_20251202_143000_abc12345",
  "model_version": "v20251202_143000",
  "model_path": "./tuned_models/v20251202_143000",
  "training_samples": 100,
  "keyword_rules_added": 15
}
```

**训练时间**：
- 100条数据：约5-10分钟（CPU）
- 1000条数据：约30-60分钟（CPU）
- 使用GPU可大幅加速

### 步骤3：查看训练批次列表

```bash
curl "http://localhost:8001/api/v1/model-tuning/batches?limit=10&status=completed"
```

## 🔑 关键词规则扩展

### 自动提取关键词规则

```bash
curl -X POST "http://localhost:8001/api/v1/model-tuning/keywords/extract?min_confidence=0.8&limit=1000"
```

**返回**：
```json
{
  "success": true,
  "rules": [
    {
      "keyword": "投资",
      "intent": "wealth",
      "frequency": 50,
      "success_rate": 0.95,
      "confidence_boost": 0.095
    }
  ],
  "total_extracted": 25,
  "saved_count": 25
}
```

**规则扩展逻辑**：
- 从高置信度问题中提取关键词
- 统计关键词-意图对的出现频率
- 频率>=3的关键词自动生成规则
- 基于成功率计算置信度加成

## 📊 监控和维护

### 定期检查

**每日**：
- 查看问题记录数量
- 检查是否有异常问题

**每周**：
- 标注50-100条问题
- 检查训练批次状态

**每月**：
- 当标注问题达到100条时，执行训练
- 分析模型效果，决定是否部署

### 关键指标

1. **数据质量**：
   - 总问题数（目标：1000+）
   - 标注率（目标：>20%）
   - 各类意图的数据分布（目标：相对平衡）

2. **训练效果**：
   - 训练成功率（目标：>90%）
   - 模型准确率（目标：>85%）
   - 训练耗时（目标：<60分钟）

3. **规则扩展**：
   - 关键词规则总数（目标：100+）
   - 规则使用频率
   - 规则成功率（目标：>80%）

## ⚠️ 注意事项

### 1. 数据隐私
- 确保用户同意数据用于训练
- 敏感信息需要脱敏处理
- 遵守数据保护法规

### 2. 训练资源
- CPU训练较慢，建议使用GPU（可选）
- 每个模型版本约500MB存储空间
- 训练时可能占用较多内存

### 3. 模型质量
- 标注质量直接影响模型效果
- 建议多人标注，交叉验证
- 保留验证集，评估模型效果

### 4. 部署风险
- 新模型部署前建议A/B测试
- 监控准确率、响应时间等指标
- 准备快速回滚方案

## 🎯 最佳实践

### 1. 问题标注
- **优先级**：低置信度问题 > 高置信度问题
- **平衡性**：确保各类意图的数据量相对平衡
- **质量**：标注要准确，避免错误标注

### 2. 训练频率
- **首次训练**：标注问题达到100条
- **增量训练**：每月一次，或标注问题达到200条
- **紧急训练**：发现明显问题时，可以立即训练

### 3. 规则扩展
- **自动提取**：训练完成后自动执行
- **手动提取**：可以随时手动提取
- **规则评估**：定期评估规则效果，禁用低效规则

### 4. 模型部署
- **验证**：部署前在测试环境验证
- **A/B测试**：新模型与旧模型对比
- **监控**：部署后密切监控指标
- **回滚**：准备快速回滚方案

## 🔄 完整工作流程示例

### 第1周：数据收集
1. 启用问题记录（已自动启用）
2. 用户使用智能运势分析功能
3. 问题自动记录到数据库
4. 查看统计：已收集100条问题

### 第2周：问题标注
1. 获取未标注问题（100条）
2. 人工标注50条问题
3. 标注率：50%

### 第3周：首次训练
1. 标注问题达到100条
2. 创建训练批次
3. 执行训练（约10分钟）
4. 自动提取关键词规则（15条）
5. 模型准确率：从80%提升至85%

### 第4周：持续优化
1. 继续收集问题
2. 继续标注问题
3. 准备第二次训练

## 📚 相关文档

- [模型微调服务设计方案](./模型微调服务设计方案.md)
- [意图识别性能优化报告](./意图识别性能优化报告.md)
- [意图识别混合架构规范](../.cursorrules)

