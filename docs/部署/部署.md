æœåŠ¡å™¨ä¸Šç›´æ¥å¢é‡éƒ¨ç½²æ–¹æ³•
æ¦‚è¿°
æœ¬è®¡åˆ’æä¾›åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šç›´æ¥æ‰§è¡Œå¢é‡éƒ¨ç½²çš„å®Œæ•´æ­¥éª¤ï¼Œé€‚ç”¨äºï¼š

ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šæ“ä½œ
é€šè¿‡ SSH è¿œç¨‹æ‰§è¡Œ
æ‰‹åŠ¨æ§åˆ¶éƒ¨ç½²æµç¨‹
å‰ç½®æ¡ä»¶
ä»£ç å·²æ¨é€åˆ° GitHub (origin/master)
èƒ½å¤Ÿ SSH è¿æ¥åˆ°ç”Ÿäº§æœåŠ¡å™¨
æœåŠ¡å™¨ä¸Šé¡¹ç›®ç›®å½•ï¼š/opt/HiFate-bazi
æ–¹æ³•ä¸€ï¼šSSH è¿œç¨‹æ‰§è¡Œï¼ˆæ¨èï¼‰
æ­¥éª¤ 1ï¼šè¿æ¥åˆ° Node1 å¹¶æ‹‰å–ä»£ç 
# æ–¹å¼ 1ï¼šä½¿ç”¨ SSH åˆ«åï¼ˆå¦‚æœå·²é…ç½®ï¼‰
ssh hifate-node1 "cd /opt/HiFate-bazi && git pull origin master"

# æ–¹å¼ 2ï¼šä½¿ç”¨ IP åœ°å€å’Œå¯†é’¥
ssh -i ~/.ssh/id_rsa_hifate root@8.210.52.217 "cd /opt/HiFate-bazi && git pull origin master"

# æ–¹å¼ 3ï¼šä½¿ç”¨å¯†ç è®¤è¯
sshpass -p '${SSH_PASSWORD}' ssh root@8.210.52.217 "cd /opt/HiFate-bazi && git pull origin master"
æ­¥éª¤ 2ï¼šè¿æ¥åˆ° Node2 å¹¶æ‹‰å–ä»£ç 
# æ–¹å¼ 1ï¼šä½¿ç”¨ SSH åˆ«å
ssh hifate-node2 "cd /opt/HiFate-bazi && git pull origin master"

# æ–¹å¼ 2ï¼šä½¿ç”¨ IP åœ°å€å’Œå¯†é’¥
ssh -i ~/.ssh/id_rsa_hifate root@47.243.160.43 "cd /opt/HiFate-bazi && git pull origin master"

# æ–¹å¼ 3ï¼šä½¿ç”¨å¯†ç è®¤è¯
sshpass -p '${SSH_PASSWORD}' ssh root@47.243.160.43 "cd /opt/HiFate-bazi && git pull origin master"
æ­¥éª¤ 3ï¼šéªŒè¯åŒæœºä»£ç ç‰ˆæœ¬ä¸€è‡´
# è·å– Node1 çš„ Git ç‰ˆæœ¬
NODE1_COMMIT=$(ssh hifate-node1 "cd /opt/HiFate-bazi && git rev-parse HEAD")
echo "Node1: ${NODE1_COMMIT:0:8}"

# è·å– Node2 çš„ Git ç‰ˆæœ¬
NODE2_COMMIT=$(ssh hifate-node2 "cd /opt/HiFate-bazi && git rev-parse HEAD")
echo "Node2: ${NODE2_COMMIT:0:8}"

# éªŒè¯ç‰ˆæœ¬ä¸€è‡´
if [ "$NODE1_COMMIT" = "$NODE2_COMMIT" ]; then
    echo "âœ… åŒæœºä»£ç ç‰ˆæœ¬ä¸€è‡´"
else
    echo "âŒ åŒæœºä»£ç ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œè¯·æ£€æŸ¥"
    exit 1
fi
æ­¥éª¤ 4ï¼šè§¦å‘çƒ­æ›´æ–°
# åœ¨ Node1 ä¸Šè§¦å‘çƒ­æ›´æ–°ï¼ˆä¼šè‡ªåŠ¨åŒæ­¥åˆ° Node2ï¼‰
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/sync

# ç­‰å¾…å‡ ç§’åæ£€æŸ¥çƒ­æ›´æ–°çŠ¶æ€
sleep 5
curl http://8.210.52.217:8001/api/v1/hot-reload/status
æ­¥éª¤ 5ï¼šéªŒè¯éƒ¨ç½²ç»“æœ
# å¥åº·æ£€æŸ¥
curl http://8.210.52.217:8001/health
curl http://47.243.160.43:8001/health

# æ£€æŸ¥ Git ç‰ˆæœ¬
ssh hifate-node1 "cd /opt/HiFate-bazi && git log --oneline -2"
ssh hifate-node2 "cd /opt/HiFate-bazi && git log --oneline -2"
æ–¹æ³•äºŒï¼šç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
æ­¥éª¤ 1ï¼šSSH ç™»å½•åˆ° Node1
# ä½¿ç”¨ SSH åˆ«å
ssh hifate-node1

# æˆ–ä½¿ç”¨ IP åœ°å€
ssh root@8.210.52.217
# å¯†ç ï¼š${SSH_PASSWORD}
æ­¥éª¤ 2ï¼šåœ¨ Node1 ä¸Šæ‰§è¡Œéƒ¨ç½²
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/HiFate-bazi

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# éªŒè¯ä»£ç ç‰ˆæœ¬
git log --oneline -2

# éªŒè¯è¯­æ³•ï¼ˆå¯é€‰ï¼‰
python3 -m py_compile server/api/v1/*.py 2>&1 | head -10
æ­¥éª¤ 3ï¼šåœ¨ Node2 ä¸Šæ‰§è¡Œç›¸åŒæ“ä½œ
# æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼ŒSSH ç™»å½•åˆ° Node2
ssh hifate-node2

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/HiFate-bazi

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# éªŒè¯ä»£ç ç‰ˆæœ¬
git log --oneline -2
æ­¥éª¤ 4ï¼šéªŒè¯åŒæœºä»£ç ä¸€è‡´
åœ¨ Node1 å’Œ Node2 ä¸Šåˆ†åˆ«æ‰§è¡Œï¼š

# è·å– Git ç‰ˆæœ¬
git rev-parse HEAD
ç¡®ä¿ä¸¤ä¸ªæœåŠ¡å™¨è¿”å›çš„ commit hash å®Œå…¨ä¸€è‡´ã€‚

æ­¥éª¤ 5ï¼šè§¦å‘çƒ­æ›´æ–°
åœ¨æœ¬åœ°æˆ–ä»»ä¸€æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

# è§¦å‘ Node1 çƒ­æ›´æ–°ï¼ˆä¼šè‡ªåŠ¨åŒæ­¥åˆ° Node2ï¼‰
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/sync

# æ£€æŸ¥çƒ­æ›´æ–°çŠ¶æ€
curl http://8.210.52.217:8001/api/v1/hot-reload/status
æ­¥éª¤ 6ï¼šéªŒè¯éƒ¨ç½²
# å¥åº·æ£€æŸ¥
curl http://8.210.52.217:8001/health
curl http://47.243.160.43:8001/health

# æµ‹è¯•å…³é”®æ¥å£ï¼ˆå¯é€‰ï¼‰
curl -X POST http://8.210.52.217:8001/api/v1/bazi/interface \
  -H "Content-Type: application/json" \
  -d '{"solar_date":"1990-01-15","solar_time":"12:00","gender":"male"}' | jq .
æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šï¼‰
åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºéƒ¨ç½²è„šæœ¬
åœ¨ Node1 ä¸Šåˆ›å»º /opt/HiFate-bazi/deploy_server.shï¼š

#!/bin/bash
# æœåŠ¡å™¨ç«¯å¢é‡éƒ¨ç½²è„šæœ¬

set -e

PROJECT_DIR="/opt/HiFate-bazi"
NODE1_IP="8.210.52.217"
NODE2_IP="47.243.160.43"

echo "ğŸ”„ å¼€å§‹å¢é‡éƒ¨ç½²..."

# 1. åœ¨ Node1 ä¸Šæ‹‰å–ä»£ç 
echo "ğŸ“¥ åœ¨ Node1 ä¸Šæ‹‰å–ä»£ç ..."
cd $PROJECT_DIR
git pull origin master
NODE1_COMMIT=$(git rev-parse HEAD)
echo "âœ… Node1 ä»£ç ç‰ˆæœ¬: ${NODE1_COMMIT:0:8}"

# 2. åœ¨ Node2 ä¸Šæ‹‰å–ä»£ç 
echo "ğŸ“¥ åœ¨ Node2 ä¸Šæ‹‰å–ä»£ç ..."
ssh root@$NODE2_IP "cd $PROJECT_DIR && git pull origin master"
NODE2_COMMIT=$(ssh root@$NODE2_IP "cd $PROJECT_DIR && git rev-parse HEAD")
echo "âœ… Node2 ä»£ç ç‰ˆæœ¬: ${NODE2_COMMIT:0:8}"

# 3. éªŒè¯ç‰ˆæœ¬ä¸€è‡´
if [ "$NODE1_COMMIT" != "$NODE2_COMMIT" ]; then
    echo "âŒ é”™è¯¯ï¼šåŒæœºä»£ç ç‰ˆæœ¬ä¸ä¸€è‡´"
    exit 1
fi
echo "âœ… åŒæœºä»£ç ç‰ˆæœ¬ä¸€è‡´"

# 4. è§¦å‘çƒ­æ›´æ–°
echo "ğŸ”„ è§¦å‘çƒ­æ›´æ–°..."
curl -X POST http://$NODE1_IP:8001/api/v1/hot-reload/sync
sleep 5

# 5. éªŒè¯éƒ¨ç½²
echo "ğŸ¥ éªŒè¯éƒ¨ç½²ç»“æœ..."
curl -f http://$NODE1_IP:8001/health && echo "âœ… Node1 å¥åº·"
curl -f http://$NODE2_IP:8001/health && echo "âœ… Node2 å¥åº·"

echo "âœ… éƒ¨ç½²å®Œæˆ"
ä½¿ç”¨è„šæœ¬
# åœ¨ Node1 ä¸Šæ‰§è¡Œ
chmod +x /opt/HiFate-bazi/deploy_server.sh
/opt/HiFate-bazi/deploy_server.sh
å…³é”®å‘½ä»¤é€ŸæŸ¥
Git æ“ä½œ
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
git rev-parse HEAD

# æŸ¥çœ‹æœ€è¿‘æäº¤
git log --oneline -5

# æ£€æŸ¥æœªæäº¤æ›´æ”¹
git status
çƒ­æ›´æ–°æ“ä½œ
# è§¦å‘çƒ­æ›´æ–°
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/sync

# æ£€æŸ¥çƒ­æ›´æ–°çŠ¶æ€
curl http://8.210.52.217:8001/api/v1/hot-reload/status

# æ‰‹åŠ¨è§¦å‘æ£€æŸ¥
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check
å¥åº·æ£€æŸ¥
# Node1 å¥åº·æ£€æŸ¥
curl http://8.210.52.217:8001/health

# Node2 å¥åº·æ£€æŸ¥
curl http://47.243.160.43:8001/health
æ³¨æ„äº‹é¡¹
åŒæœºä»£ç å¿…é¡»ä¸€è‡´ï¼šéƒ¨ç½²å‰ç¡®ä¿ Node1 å’Œ Node2 çš„ä»£ç ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
é›¶åœæœºéƒ¨ç½²ï¼šä½¿ç”¨çƒ­æ›´æ–°ï¼Œä¸ä¼šé‡å¯æœåŠ¡
éªŒè¯æ­¥éª¤ï¼šéƒ¨ç½²åå¿…é¡»éªŒè¯å¥åº·æ£€æŸ¥å’Œå…³é”®åŠŸèƒ½
å›æ»šå‡†å¤‡ï¼šå¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œå¯ä»¥ä½¿ç”¨çƒ­æ›´æ–°å›æ»šåŠŸèƒ½
æ•…éšœæ’æŸ¥
é—®é¢˜ 1ï¼šGit æ‹‰å–å¤±è´¥
# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping github.com

# æ£€æŸ¥ Git é…ç½®
git remote -v

# æ‰‹åŠ¨æ‹‰å–
cd /opt/HiFate-bazi
git fetch origin
git merge origin/master
é—®é¢˜ 2ï¼šçƒ­æ›´æ–°å¤±è´¥
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://8.210.52.217:8001/health

# æ£€æŸ¥çƒ­æ›´æ–°çŠ¶æ€
curl http://8.210.52.217:8001/api/v1/hot-reload/status

# æ‰‹åŠ¨è§¦å‘æ£€æŸ¥
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check
é—®é¢˜ 3ï¼šåŒæœºä»£ç ä¸ä¸€è‡´
# åœ¨ Node1 ä¸Šé‡ç½®å¹¶æ‹‰å–
cd /opt/HiFate-bazi
git reset --hard origin/master
git pull origin master

# åœ¨ Node2 ä¸Šé‡ç½®å¹¶æ‹‰å–
ssh root@47.243.160.43 "cd /opt/HiFate-bazi && git reset --hard origin/master && git pull origin master"