# 自动化热更新使用指南

## 概述

自动化热更新系统解决开发上线成功率低的问题，通过文件监控自动触发热更新，无需手动操作，确保代码变更立即生效。

## 核心功能

1. **文件变更自动检测**：使用 `watchdog` 监听代码文件变更
2. **自动触发热更新**：文件变更后自动调用热更新 API
3. **自动验证热更新成功**：验证热更新状态，确保更新成功
4. **失败自动回滚**：热更新失败时自动回滚到上一版本
5. **禁止重启服务**：强制使用热更新，禁止重启服务

## 使用方法

### 方式1：文件监控（开发时推荐）

```bash
# 启动文件监控，自动触发热更新
python3 scripts/ai/auto_hot_reload.py --watch
```

**功能**：
- 监听 `server/`、`src/`、`services/` 目录的文件变更
- 文件变更后自动触发热更新
- 自动验证热更新成功
- 失败自动回滚

**适用场景**：
- 本地开发时
- 需要频繁修改代码时

### 方式2：手动触发（部署时推荐）

```bash
# 手动触发一次热更新
python3 scripts/ai/auto_hot_reload.py --trigger

# 触发并验证
python3 scripts/ai/auto_hot_reload.py --trigger --verify
```

**功能**：
- 立即触发热更新
- 可选：验证热更新状态
- 可选：指定模块名称

**适用场景**：
- 部署到生产环境时
- 需要立即生效时

### 方式3：验证状态

```bash
# 验证热更新状态
python3 scripts/ai/auto_hot_reload.py --verify
```

**功能**：
- 检查热更新系统是否运行正常
- 获取热更新状态信息

### 方式4：回滚

```bash
# 回滚热更新
python3 scripts/ai/auto_hot_reload.py --rollback
```

**功能**：
- 回滚到上一版本
- 恢复备份的代码

## 集成方式

### Git Hooks

**post-commit hook**：提交后自动触发热更新（仅本地开发环境）

```bash
# 已自动配置，提交代码后自动触发热更新
git commit -m "feat: 新功能"
# 自动触发热更新
```

### 开发流程检查工具

已集成到 `scripts/dev/dev_flow_check.py`：
- 完整检查后自动触发热更新
- 验证热更新成功

### 部署自动化工具

已集成到 `scripts/deploy/auto_deploy.py`：
- 增量部署时自动触发热更新
- 部署后验证热更新状态

## 配置

### API 基础 URL

默认：`http://localhost:8001`

可通过环境变量或参数配置：
```bash
# 环境变量
export API_BASE_URL=http://8.210.52.217:8001

# 命令行参数
python3 scripts/ai/auto_hot_reload.py --api-url http://8.210.52.217:8001 --trigger
```

### 监控目录

默认监控目录：
- `server/`
- `src/`
- `services/`

可在代码中修改 `WATCH_DIRS` 配置。

### 冷却时间

默认冷却时间：5秒

避免频繁触发，可在代码中修改 `trigger_cooldown` 配置。

## 常见问题

### Q1: 文件监控未启动？

**A**: 检查：
1. 是否安装了 `watchdog`：`pip install watchdog`
2. 服务是否运行：`curl http://localhost:8001/health`
3. 是否有权限访问监控目录

### Q2: 热更新触发失败？

**A**: 检查：
1. 服务是否运行：`curl http://localhost:8001/health`
2. 热更新 API 是否可用：`curl http://localhost:8001/api/v1/hot-reload/status`
3. 查看热更新日志：`tail -f logs/hot_reload_errors/*.log`

### Q3: 热更新后功能未生效？

**A**: 检查：
1. 热更新是否成功：`python3 scripts/ai/auto_hot_reload.py --verify`
2. 代码是否有语法错误
3. 模块导入是否成功
4. **必须验证实际功能**，不单单是健康检查

### Q4: 总是需要重启服务？

**A**: 
1. **禁止重启服务**，必须使用热更新
2. 使用自动化热更新工具自动触发
3. 开发完成后自动验证热更新成功

## 最佳实践

1. **开发时启动文件监控**：自动触发热更新，无需手动操作
2. **部署时手动触发一次**：确保热更新成功
3. **验证功能正常**：热更新后必须验证实际功能
4. **禁止重启服务**：必须使用热更新
5. **使用开发助手完成流程**：`python3 scripts/ai/dev_assistant.py --complete`

## 相关文档

- **智能开发助手使用指南**：`docs/智能开发助手使用指南.md`
- **热更新系统文档**：`.cursorrules` - "🔥 热更新强制规范"章节

