# 命局旺衰分析功能说明

## 📋 功能概述

命局旺衰分析功能根据八字信息计算命局的旺衰状态，包括：
- **得令分**（月支权重）：45分或0分
- **得地分**（年日时支）：根据藏干匹配计分
- **得势分**（天干生扶）：10分或0分 ✅ 已修正为10分
- **旺衰判定**：极旺、身旺、身弱、极弱、平衡
- **喜忌判定**：计算喜神和忌神
- **五行计算**：计算喜忌五行

---

## 🗂️ 文件结构

### 后端文件

```
src/
├── data/
│   └── wangshuai_config.py          # 配置加载器（从Excel读取）
└── analyzers/
    └── wangshuai_analyzer.py        # 核心分析器（计算逻辑）

server/
├── services/
│   └── wangshuai_service.py         # 服务层（业务封装）
└── api/v1/
    └── wangshuai.py                 # API路由（HTTP接口）
```

### 前端文件

```
frontend/
├── js/
│   └── pan.js                       # 添加旺衰分析显示
└── css/
    └── fatetell-layout.css          # 添加旺衰分析样式
```

---

## 🔧 配置说明

### Excel配置文件

配置文件位置：`docs/命局旺衰.xlsx`

包含以下Sheet：
1. **月支得令表** - 日干对应的得令月支列表
2. **得地五行表** - 日干对应的生得地五行和同得地五行
3. **藏干计分表** - 不同数量藏干的计分规则
4. **旺衰阈值表** - 总分对应的旺衰状态
5. **喜忌判定表** - 不同旺衰状态对应的喜忌神
6. **十神五行表** - 十神对应的五行

### 硬编码配置（备选）

如果Excel文件不存在或无法读取，系统会自动使用硬编码的默认配置。

---

## 📊 计算逻辑

### 1. 得令分（月支权重）- 45分或0分

- 根据日干查询配置表，获取得令月支列表
- 如果月支在列表中，得令=45分
- 否则，得令=0分

**日志输出示例：**
```
📊 步骤2: 计算得令分（月支权重）
   检查得令: 日干=丙, 月支=寅
   日干丙的得令月支: ['巳', '午', '寅', '卯']
   ✅ 月支寅在得令列表中，得令=45分
   得令分: 45 分
```

### 2. 得地分（年日时支）- 根据藏干匹配计分

- 根据日干确定生得地五行和同得地五行
- 检查年、日、时三柱的藏干
- 按藏干数量匹配计分规则
- 按顺序匹配藏干，匹配到生得地/同得地五行则加分，否则扣分

**日志输出示例：**
```
📊 步骤3: 计算得地分（年日时支）
   检查得地: 日干=丙, 日干五行=火
   生得地五行: 木, 同得地五行: 火
   year柱: 卯, 藏干: ['乙木']
      找到1个藏干的计分规则: {'第1个匹配': 15, '第1个不匹配': -15}
      第1个藏干乙(木)匹配，得分: 15
   year柱得分: 15
   day柱: 寅, 藏干: ['甲木', '丙火', '戊土']
      找到3个藏干的计分规则: {...}
      第1个藏干甲(木)匹配，得分: -8
      第2个藏干丙(火)匹配，得分: -4
      第3个藏干戊(土)不匹配，得分: -3
   day柱得分: -15
   得地总分: 0
```

### 3. 得势分（天干生扶）- 10分或0分 ✅ 已修正

- 检查年干、月干、时干
- 如果存在与日干同五行的天干，得势=10分
- 如果存在生扶日干的天干（生我者），得势=10分
- 否则，得势=0分

**日志输出示例：**
```
📊 步骤4: 计算得势分（天干生扶）
   检查得势: 日干=丙, 日干五行=火
   检查year_stem: 丁(火)
   ✅ year_stem丁与日干丙同五行，得势=10分
   得势分: 10 分
```

### 4. 旺衰判定

根据总分判定：
- **极旺**: 80-100分
- **身旺**: 50-79分
- **平衡**: 40-49分
- **身弱**: 20-39分
- **极弱**: 0-19分

### 5. 喜忌判定

根据旺衰状态查询配置表，确定：
- **喜神**：对命局有利的十神
- **忌神**：对命局不利的十神

### 6. 五行计算

根据十神与五行的映射关系，计算：
- **喜神五行**：喜神对应的五行
- **忌神五行**：忌神对应的五行

---

## 🔍 日志查看

### 服务日志

```bash
# 查看主服务日志
tail -f logs/web_app_8001.log | grep -i "旺衰\|wangshuai"

# 查看所有日志
tail -f logs/web_app_8001.log
```

### 日志级别

所有计算步骤都会打印详细日志，包括：
- ✅ 步骤开始标记
- 📊 计算过程详情
- ✅ 计算结果
- ❌ 错误信息

---

## 🧪 测试方法

### 1. 单元测试

```bash
# 运行测试脚本
python test_wangshuai.py
```

### 2. API测试

```bash
# 测试旺衰分析接口
curl -X POST http://localhost:8001/api/v1/bazi/wangshuai \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1987-01-07",
    "solar_time": "09:55",
    "gender": "male"
  }'
```

### 3. 前端测试

1. 访问 `http://localhost:8001/frontend/pan.html`
2. 输入出生信息并查询
3. 在"婚姻"卡片下面查看"命局旺衰"卡片
4. 点击展开查看详细分析结果

---

## 📱 前端显示

### 显示位置

旺衰分析卡片显示在"婚姻"卡片下面，包含：

1. **旺衰状态**：显示当前旺衰状态和总分
2. **得分详情**：显示得令分、得地分、得势分
3. **喜忌神**：显示喜神和忌神列表
4. **喜忌五行**：显示喜神五行和忌神五行

### 样式特点

- 渐变背景显示旺衰状态
- 不同颜色区分喜忌
- 响应式设计，支持移动端

---

## 🚀 部署说明

### 1. 重启服务

```bash
# 停止当前服务
kill $(lsof -ti:8001)

# 重新启动
python server/start.py
```

### 2. 验证部署

```bash
# 检查路由是否注册
curl http://localhost:8001/docs | grep -i "旺衰"

# 测试接口
curl -X POST http://localhost:8001/api/v1/bazi/wangshuai \
  -H "Content-Type: application/json" \
  -d '{"solar_date": "1987-01-07", "solar_time": "09:55", "gender": "male"}'
```

---

## ⚠️ 注意事项

1. **Excel配置**：如果Excel文件不存在，系统会使用硬编码配置
2. **日志级别**：确保日志级别设置为INFO或DEBUG以查看详细日志
3. **性能**：旺衰计算是同步操作，建议在异步环境中使用
4. **错误处理**：所有错误都会被捕获并记录到日志中

---

## 📝 开发日志

### 2025-01-XX

- ✅ 创建配置加载器
- ✅ 创建核心分析器
- ✅ 创建服务层和API路由
- ✅ 集成到前端（放在婚姻卡片下面）
- ✅ 添加详细日志记录
- ✅ 修正得势分数为10分（原为15分）

---

## 🔗 相关文档

- [协议架构说明.md](../协议架构说明.md)
- [部署方案.md](部署方案.md)
- [生产环境代码规范.md](生产环境代码规范.md)

