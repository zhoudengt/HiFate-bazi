# 增量部署使用指南

## 📋 概述

增量部署通过热更新机制实现零停机快速部署，适用于日常代码更新，无需重启服务。

**优势**：
- ⚡ 快速部署（30秒-2分钟）
- 🔄 零停机（服务不中断）
- 🚀 快速回滚（秒级回滚）
- 💰 低资源消耗（无需构建镜像）

## 🎯 适用场景

### ✅ 使用增量部署

- Python 代码更新
- 业务逻辑修改
- Bug 修复
- 规则更新（数据库规则）
- 配置更新
- 微服务代码修改

### ❌ 必须使用完整部署

- 依赖变更（`requirements.txt`）
- Dockerfile 变更
- 首次部署
- 重大架构变更

## 🚀 快速开始

### 方式 1：使用增量部署脚本（推荐）

```bash
# 1. 确保代码已提交并推送
git add .
git commit -m "feat: 新功能"
git push origin master

# 2. 运行增量部署脚本
bash deploy/scripts/incremental_deploy_production.sh
```

### 方式 2：手动增量部署

```bash
# 1. 在 Node1 上拉取代码
ssh root@8.210.52.217 "cd /opt/HiFate-bazi && git pull origin master"

# 2. 在 Node2 上拉取代码
ssh root@47.243.160.43 "cd /opt/HiFate-bazi && git pull origin master"

# 3. 在 Node1 上触发热更新（自动同步到 Node2）
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/sync

# 4. 验证部署结果
curl http://8.210.52.217:8001/health
curl http://47.243.160.43:8001/health
```

## 📋 部署流程

### 第一步：部署前检查

脚本会自动执行以下检查：

1. **分支检查**：确认当前分支为 `master`
2. **未提交更改检查**：确保所有更改已提交
3. **未推送提交检查**：提示是否先推送
4. **语法验证**：验证所有 Python 文件语法
5. **模块导入验证**：验证关键模块可以导入

### 第二步：服务器连接检查

- 检查 Node1 SSH 连接
- 检查 Node2 SSH 连接

### 第三步：拉取代码

- 在 Node1 上拉取最新代码
- 在 Node2 上拉取最新代码

### 第四步：服务器端验证

- 在 Node1 上验证代码语法
- 在 Node2 上验证代码语法

### 第五步：触发热更新

- 在 Node1 上触发热更新
- 自动同步到 Node2（通过 Redis）

### 第六步：部署后验证

- 健康检查（Node1 和 Node2）
- 热更新状态检查
- 关键功能验证（可选）

## 🔒 安全检查

### 部署前检查（本地）

- ✅ 当前分支为 `master`
- ✅ 无未提交的更改
- ✅ 无未推送的提交
- ✅ Python 语法验证通过
- ✅ 关键模块导入验证通过

### 服务器端验证

- ✅ 服务器 SSH 连接正常
- ✅ 代码拉取成功
- ✅ 服务器端语法验证通过
- ✅ 热更新服务可用

### 部署后验证

- ✅ 健康检查通过（Node1 和 Node2）
- ✅ 热更新状态正常
- ✅ 关键功能验证通过（可选）

## 🔄 回滚机制

### 自动回滚

如果部署失败，脚本会自动回滚：

- 健康检查失败（5次重试后）
- 语法验证失败
- 模块导入失败

### 手动回滚

```bash
# 在 Node1 上回滚
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/rollback

# 在 Node2 上回滚
curl -X POST http://47.243.160.43:8001/api/v1/hot-reload/rollback
```

## 🔍 故障排查

### 问题 1：语法验证失败

**症状**：部署脚本报错"语法验证失败"

**解决**：
```bash
# 检查语法错误
python3 -c "import ast; import glob; [ast.parse(open(f).read()) for f in glob.glob('server/**/*.py', recursive=True)]"
```

### 问题 2：热更新失败

**症状**：热更新状态异常

**解决**：
```bash
# 检查热更新状态
curl http://8.210.52.217:8001/api/v1/hot-reload/status

# 查看热更新错误日志
ssh root@8.210.52.217 "cat /opt/HiFate-bazi/logs/hot_reload_errors/*.log | tail -50"
```

### 问题 3：健康检查失败

**症状**：部署后健康检查失败

**解决**：
```bash
# 检查服务日志
ssh root@8.210.52.217 "docker logs hifate-web --tail 100"

# 手动回滚
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/rollback
```

### 问题 4：双机同步失败

**症状**：Node1 更新成功，Node2 未更新

**解决**：
```bash
# 检查 Redis 连接
ssh root@8.210.52.217 "docker exec hifate-redis redis-cli ping"

# 手动在 Node2 上触发热更新
curl -X POST http://47.243.160.43:8001/api/v1/hot-reload/check
```

## 📊 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **部署时间** | < 2分钟 | 从拉取代码到完成验证 |
| **服务中断** | 0秒 | 零停机部署 |
| **回滚时间** | < 10秒 | 热更新回滚速度 |
| **成功率** | > 99% | 部署成功率 |

## 📚 相关文档

- **开发规范**：`.cursorrules` - "🚀 增量部署规范"章节
- **热更新系统**：`.cursorrules` - "🔥 热更新强制规范"章节
- **完整部署流程**：`.cursorrules` - "🚀 CI/CD 标准流程"章节

## ⚠️ 注意事项

1. **代码必须已推送**：增量部署脚本会拉取远程代码，未推送的代码不会被部署
2. **不适用依赖变更**：修改 `requirements.txt` 必须使用完整部署
3. **双机同步**：在 Node1 上触发热更新会自动同步到 Node2，确保 Redis 连接正常
4. **监控和告警**：部署后持续监控服务状态，发现问题立即回滚
5. **测试优先**：重要变更先在测试环境验证，生产环境部署后立即验证

