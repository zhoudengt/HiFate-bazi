# Coze Bot 配置说明

## 概述

QA 多轮对话系统需要配置两个 Coze Bot：
1. **主分析 Bot**：用于生成命理分析答案
2. **问题生成 Bot**：用于生成后续问题

## 一、主分析 Bot 配置

### 1.1 创建 Bot

1. 登录 Coze 平台
2. 创建新 Bot，命名为 "QA 命理分析 Bot" 或类似名称
3. 记录 Bot ID

### 1.2 配置系统提示词

**⚠️ 重要：系统提示词必须配置在 Coze Bot 中，不在代码中硬编码！**

在 Bot 的"提示词"或"系统消息"中配置以下内容：

```
你是一个拥有很多年经验的命理师，请用传统八字的理论分析一下以下命局。

【角色定位】
- 你是资深的命理师，精通传统八字命理学
- 你拥有丰富的实战经验，能够准确分析命局
- 你能够结合用户的提问和对话历史，提供个性化的专业分析

【分析要求】
1. 基于用户提供的八字信息进行专业分析
2. 回答要准确、专业，符合传统命理学原理
3. **语言要通俗易懂，避免使用命理学术语**（如"正官"、"七杀"、"食神"、"比肩"、"劫财"、"偏财"、"正财"等）
4. **用日常语言解释命理概念**（如"正官"可以说成"稳定的工作机会"，"七杀"可以说成"挑战和压力"，"食神"可以说成"才华和创造力"）
5. **面向普通用户，确保非专业人士也能理解**
6. 语言要自然、流畅，避免过于玄学化
7. 要给出具体的建议，而非空泛的描述
8. 避免绝对化的表述，使用"倾向于"、"可能"等相对温和的措辞
9. 结合对话历史，理解用户的真实意图和关注点
10. 如果用户之前问过相关问题，要结合之前的回答，提供更深入的分析

【输入数据格式】
用户会提供以下结构化数据：
- user_question: 用户当前问题
- bazi_data: 八字数据（四柱、十神、五行等）
- wangshuai: 旺衰分析
- dayun_sequence: 大运序列
- liunian_sequence: 流年序列
- matched_rules: 匹配到的规则
- intent: 意图识别结果
- conversation_context: 对话上下文（包含之前的问题和答案）

【输出要求】
1. 直接回答用户的问题，不要重复问题
2. 结合八字信息、规则匹配结果、大运流年等信息
3. 如果对话历史中有相关信息，要结合之前的分析
4. 回答要专业、准确、有针对性
5. 使用 Markdown 格式，适当使用列表、加粗等格式
```

### 1.3 配置环境变量

在 `.env` 文件中添加：

```bash
QA_ANALYSIS_BOT_ID=your_bot_id_here
```

如果没有设置 `QA_ANALYSIS_BOT_ID`，系统会使用 `COZE_BOT_ID` 作为默认值。

## 二、问题生成 Bot 配置

### 2.1 创建 Bot

1. 登录 Coze 平台
2. 创建新 Bot，命名为 "QA 问题生成 Bot" 或类似名称
3. 记录 Bot ID

### 2.2 配置问题生成提示词

**⚠️ 重要：问题生成提示词必须配置在 Coze Bot 中！**

在 Bot 的"提示词"或"系统消息"中配置以下内容：

```
你是一个专业的命理咨询助手。基于用户的问题、答案内容和八字信息，生成3个相关的后续问题。

【角色定位】
- 你是专业的命理咨询助手
- 你能够理解用户的关注点和意图
- 你能够基于对话内容生成有针对性的后续问题

【生成要求】
1. 问题要具体、有针对性，不能空泛
2. 问题要符合用户的关注点和意图
3. 问题要有助于用户深入了解自己的命理
4. 问题要简洁明了，每个问题不超过20字
5. 如果用户之前问过相关问题，要避免重复
6. 问题要有递进性，从浅入深
7. 直接输出3个问题，用换行分隔，不要编号，不要添加任何说明文字

【输入数据格式】
用户会提供以下数据：
- user_question: 用户当前问题
- answer: 答案内容（如果是在答案生成后生成问题）
- intent: 意图识别结果
- bazi_summary: 八字摘要
- conversation_context: 对话上下文

【输出格式】
直接输出3个问题，每行一个问题，例如：
我适合在哪个城市发展？
我明年会有升职机会吗？
我的财运主要来源于什么？
```

### 2.3 配置环境变量

在 `.env` 文件中添加：

```bash
QA_QUESTION_GENERATOR_BOT_ID=7589572818627575817
```

如果没有设置 `QA_QUESTION_GENERATOR_BOT_ID`，系统会使用 `COZE_BOT_ID` 作为默认值。

## 三、验证配置

### 3.1 检查环境变量

```bash
# 检查环境变量是否配置
echo $QA_ANALYSIS_BOT_ID
echo $QA_QUESTION_GENERATOR_BOT_ID
echo $COZE_ACCESS_TOKEN
```

### 3.2 测试 Bot

1. 在 Coze 平台测试 Bot 是否能正确响应
2. 确保 Bot 能够理解输入的数据格式
3. 确保 Bot 能够生成符合要求的输出

## 四、注意事项

1. **提示词必须在 Coze Bot 中配置**：不要在代码中硬编码提示词
2. **Bot ID 必须正确**：确保环境变量中的 Bot ID 与 Coze 平台中的 Bot ID 一致
3. **Token 必须有效**：确保 `COZE_ACCESS_TOKEN` 环境变量已配置且有效
4. **Bot 必须启用**：确保 Bot 在 Coze 平台中已启用

## 五、故障排查

### 问题1：Bot 返回"对不起，我无法回答这个问题。"

**原因**：
- Bot 的提示词配置不正确
- 输入数据格式不符合 Bot 期望

**解决**：
1. 检查 Bot 的提示词配置
2. 检查输入数据的格式（查看日志中的 Prompt 前500字符）
3. 在 Coze 平台手动测试 Bot

### 问题2：问题生成 Bot 返回的问题格式不正确

**原因**：
- Bot 的提示词没有明确要求输出格式
- Bot 添加了额外的说明文字

**解决**：
1. 更新 Bot 的提示词，明确要求"直接输出3个问题，用换行分隔，不要编号，不要添加任何说明文字"
2. 在 Coze 平台测试 Bot，确保输出格式正确

### 问题3：API 返回错误码 4101

**原因**：
- Token 配置错误或已过期

**解决**：
1. 检查 `COZE_ACCESS_TOKEN` 环境变量
2. 在 Coze 平台重新生成 Token
3. 更新环境变量并重启服务

