# Stripe æ”¯ä»˜å®Œæ•´æµ‹è¯•æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
2. [å¿«é€Ÿæµ‹è¯•](#å¿«é€Ÿæµ‹è¯•)
3. [è¯¦ç»†æ­¥éª¤](#è¯¦ç»†æ­¥éª¤)
4. [æµ‹è¯•å¡å·](#æµ‹è¯•å¡å·)
5. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ”§ ç¯å¢ƒé…ç½®

### âœ… å·²å®Œæˆé…ç½®

Stripe å¯†é’¥å·²è‡ªåŠ¨é…ç½®åœ¨ `config/services.env` æ–‡ä»¶ä¸­ï¼š

```bash
export STRIPE_SECRET_KEY="sk_test_51SVUByLidTco9ErU..."
export FRONTEND_BASE_URL="http://localhost:8080"
```

**æ¯æ¬¡å¯åŠ¨æœåŠ¡æ—¶ä¼šè‡ªåŠ¨åŠ è½½æ­¤é…ç½®ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®ã€‚**

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### æ–¹æ³•1ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. ç¡®ä¿æœåŠ¡å·²å¯åŠ¨
./start_all_services.sh

# 2. è¿è¡Œæµ‹è¯•è„šæœ¬
./test_stripe_complete.sh

# 3. æŒ‰ç…§æç¤ºå®Œæˆæ“ä½œ
```

### æ–¹æ³•2ï¼šæ‰‹åŠ¨æµ‹è¯•

```bash
# 1. åˆ›å»ºæ”¯ä»˜ä¼šè¯
curl -X POST http://127.0.0.1:8001/api/v1/payment/create-session \
  -H "Content-Type: application/json" \
  -d '{
    "amount": "19.90",
    "currency": "USD",
    "product_name": "æœˆè®¢é˜…ä¼šå‘˜",
    "customer_email": "test@example.com"
  }' | python3 -m json.tool

# 2. å¤åˆ¶è¿”å›çš„ checkout_url åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€
# 3. ä½¿ç”¨æµ‹è¯•å¡å·å®Œæˆæ”¯ä»˜
```

---

## ğŸ“– è¯¦ç»†æ­¥éª¤

### æ­¥éª¤1ï¼šå¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
./start_all_services.sh
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… æœåŠ¡ bazi_core (9001) å·²å¯åŠ¨
âœ… æœåŠ¡ bazi_fortune (9002) å·²å¯åŠ¨
...
âœ… ä¸»æœåŠ¡ web_app (8001) å·²å¯åŠ¨
```

### æ­¥éª¤2ï¼šåˆ›å»ºæ”¯ä»˜ä¼šè¯

```bash
curl -X POST http://127.0.0.1:8001/api/v1/payment/create-session \
  -H "Content-Type: application/json" \
  -d '{
    "amount": "19.90",
    "currency": "USD",
    "product_name": "æœˆè®¢é˜…ä¼šå‘˜",
    "customer_email": "test@example.com"
  }'
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "success": true,
  "session_id": "cs_test_a1B2c3D4...",
  "checkout_url": "https://checkout.stripe.com/c/pay/cs_test_...",
  "status": "created",
  "message": "æ”¯ä»˜ä¼šè¯åˆ›å»ºæˆåŠŸ"
}
```

### æ­¥éª¤3ï¼šåœ¨æµè§ˆå™¨å®Œæˆæ”¯ä»˜

1. **å¤åˆ¶** ä¸Šä¸€æ­¥è¿”å›çš„ `checkout_url`
2. **åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€** è¯¥é“¾æ¥
3. **å¡«å†™æµ‹è¯•å¡ä¿¡æ¯ï¼š**
   - å¡å·ï¼š`4242 4242 4242 4242`
   - è¿‡æœŸæ—¥æœŸï¼š`12/34`ï¼ˆä»»æ„æœªæ¥æ—¥æœŸï¼‰
   - CVCï¼š`123`ï¼ˆä»»æ„3ä½æ•°å­—ï¼‰
   - é‚®ç¼–ï¼š`12345`ï¼ˆä»»æ„5ä½æ•°å­—ï¼‰
   - æŒå¡äººå§“åï¼š`Test User`ï¼ˆä»»æ„åå­—ï¼‰

4. **ç‚¹å‡»"æ”¯ä»˜"æŒ‰é’®**

5. æ”¯ä»˜æˆåŠŸåä¼šè·³è½¬åˆ°æˆåŠŸé¡µé¢

### æ­¥éª¤4ï¼šéªŒè¯æ”¯ä»˜çŠ¶æ€

```bash
# ä½¿ç”¨æ­¥éª¤2è¿”å›çš„ session_id
curl -X POST http://127.0.0.1:8001/api/v1/payment/verify \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "cs_test_ä½ çš„session_id"
  }' | python3 -m json.tool
```

**æ”¯ä»˜æˆåŠŸçš„å“åº”ï¼š**
```json
{
  "success": true,
  "status": "success",
  "payment_intent_id": "pi_...",
  "amount": "19.90",
  "currency": "USD",
  "customer_email": "test@example.com",
  "created_at": 1234567890,
  "metadata": {},
  "message": "æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢æˆåŠŸ"
}
```

### æ­¥éª¤5ï¼šåœ¨Stripeåå°æŸ¥çœ‹ï¼ˆå¯é€‰ï¼‰

```bash
# æ‰“å¼€Stripeæµ‹è¯•ç¯å¢ƒåå°
open https://dashboard.stripe.com/test/payments
```

åœ¨åå°å¯ä»¥çœ‹åˆ°ï¼š
- æ‰€æœ‰æ”¯ä»˜è®°å½•
- æ”¯ä»˜è¯¦æƒ…
- å®¢æˆ·ä¿¡æ¯
- äº‹ä»¶æ—¥å¿—

---

## ğŸ’³ æµ‹è¯•å¡å·

### æˆåŠŸæ”¯ä»˜
```
å¡å·ï¼š4242 4242 4242 4242
ç”¨é€”ï¼šæµ‹è¯•æˆåŠŸçš„æ”¯ä»˜æµç¨‹
```

### éœ€è¦3DéªŒè¯
```
å¡å·ï¼š4000 0027 6000 3184
ç”¨é€”ï¼šæµ‹è¯•éœ€è¦é¢å¤–éªŒè¯çš„æµç¨‹
```

### æ”¯ä»˜å¤±è´¥
```
å¡å·ï¼š4000 0000 0000 0002
ç”¨é€”ï¼šæµ‹è¯•æ”¯ä»˜å¤±è´¥çš„æƒ…å†µ
```

### ä½™é¢ä¸è¶³
```
å¡å·ï¼š4000 0000 0000 9995
ç”¨é€”ï¼šæµ‹è¯•ä½™é¢ä¸è¶³çš„æƒ…å†µ
```

**æ‰€æœ‰æµ‹è¯•å¡çš„é€šç”¨ä¿¡æ¯ï¼š**
- è¿‡æœŸæ—¥æœŸï¼šä»»æ„æœªæ¥æ—¥æœŸï¼ˆå¦‚ `12/34`ï¼‰
- CVCï¼šä»»æ„3ä½æ•°å­—ï¼ˆå¦‚ `123`ï¼‰
- é‚®ç¼–ï¼šä»»æ„5ä½æ•°å­—ï¼ˆå¦‚ `12345`ï¼‰

---

## ğŸ¨ ä½¿ç”¨å‰ç«¯é¡µé¢æµ‹è¯•

### å¯åŠ¨å‰ç«¯æœåŠ¡

```bash
cd frontend
python3 -m http.server 8080
```

### è®¿é—®æ”¯ä»˜é¡µé¢

```bash
open http://localhost:8080/third-party-services.html
```

### åœ¨é¡µé¢ä¸­æ“ä½œ

1. æ‰¾åˆ°"ç»Ÿä¸€æ”¯ä»˜"æ¨¡å—
2. å¡«å†™è¡¨å•ï¼š
   - æ”¯ä»˜æ¸ é“ï¼šStripe (å…¨çƒ)
   - é‡‘é¢ï¼š19.90
   - è´§å¸ï¼šUSD
   - äº§å“åç§°ï¼šæœˆè®¢é˜…ä¼šå‘˜
   - å®¢æˆ·é‚®ç®±ï¼štest@example.com

3. ç‚¹å‡»"åˆ›å»ºæ”¯ä»˜"æŒ‰é’®
4. é¡µé¢ä¼šæ˜¾ç¤ºæ”¯ä»˜é“¾æ¥ï¼Œç‚¹å‡»è·³è½¬
5. å®Œæˆæ”¯ä»˜æµç¨‹

---

## ğŸ” æŸ¥çœ‹APIæ–‡æ¡£

```bash
# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€Swagger UI
open http://127.0.0.1:8001/docs
```

åœ¨æ–‡æ¡£ä¸­å¯ä»¥ï¼š
- æŸ¥çœ‹æ‰€æœ‰æ”¯ä»˜æ¥å£
- åœ¨çº¿æµ‹è¯•API
- æŸ¥çœ‹è¯·æ±‚/å“åº”ç¤ºä¾‹

---

## â“ å¸¸è§é—®é¢˜

### Q1: æç¤º"Not Found"

**åŸå› ï¼š** æœåŠ¡æœªå¯åŠ¨æˆ–æ”¯ä»˜è·¯ç”±æœªæ³¨å†Œ

**è§£å†³ï¼š**
```bash
# é‡å¯æœåŠ¡
./start_all_services.sh

# æ£€æŸ¥æ—¥å¿—
tail -50 logs/server_8001.log | grep "æ”¯ä»˜è·¯ç”±"
# åº”è¯¥çœ‹åˆ°ï¼šâœ“ ç»Ÿä¸€æ”¯ä»˜è·¯ç”±å·²æ³¨å†Œ
```

### Q2: æç¤º"STRIPE_SECRET_KEYæœªé…ç½®"

**åŸå› ï¼š** ç¯å¢ƒå˜é‡æœªåŠ è½½

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat config/services.env | grep STRIPE

# åº”è¯¥çœ‹åˆ°ï¼š
# export STRIPE_SECRET_KEY="sk_test_..."

# é‡å¯æœåŠ¡åŠ è½½é…ç½®
./stop_all_services.sh
./start_all_services.sh
```

### Q3: æç¤º"email-validator is not installed"

**åŸå› ï¼š** ç¼ºå°‘ä¾èµ–åŒ…

**è§£å†³ï¼š**
```bash
# å®‰è£…ä¾èµ–
.venv/bin/pip install 'pydantic[email]' email-validator

# é‡å¯æœåŠ¡
./stop_all_services.sh
./start_all_services.sh
```

### Q4: æ”¯ä»˜é¡µé¢æ‰“ä¸å¼€

**åŸå› ï¼š** checkout_url å¯èƒ½éœ€è¦ä»£ç†è®¿é—®

**è§£å†³ï¼š**
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- å°è¯•ä½¿ç”¨VPN
- æˆ–ç›´æ¥åœ¨Stripeåå°æŸ¥çœ‹æ”¯ä»˜è®°å½•

### Q5: å¦‚ä½•åˆ‡æ¢åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ

**æ­¥éª¤ï¼š**
1. ç™»å½• Stripe Dashboard
2. åˆ‡æ¢åˆ° Live æ¨¡å¼
3. è·å–ç”Ÿäº§å¯†é’¥ï¼ˆ`sk_live_...`ï¼‰
4. ä¿®æ”¹ `config/services.env`ï¼š
   ```bash
   export STRIPE_SECRET_KEY="sk_live_ä½ çš„ç”Ÿäº§å¯†é’¥"
   ```
5. é‡å¯æœåŠ¡

**âš ï¸ æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒä¼šå®é™…æ‰£æ¬¾ï¼**

---

## ğŸ“Š æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] æœåŠ¡å·²å¯åŠ¨ï¼ˆ8001ç«¯å£ï¼‰
- [ ] æ”¯ä»˜è·¯ç”±å·²æ³¨å†Œ
- [ ] APIèƒ½åˆ›å»ºæ”¯ä»˜ä¼šè¯
- [ ] è¿”å›äº†æœ‰æ•ˆçš„checkout_url
- [ ] èƒ½åœ¨æµè§ˆå™¨æ‰“å¼€æ”¯ä»˜é¡µé¢
- [ ] æµ‹è¯•å¡å·èƒ½å®Œæˆæ”¯ä»˜
- [ ] æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢è¿”å›success
- [ ] Stripeåå°æ˜¾ç¤ºæ”¯ä»˜è®°å½•

---

## ğŸ¯ å®Œæ•´æµ‹è¯•å‘½ä»¤ï¼ˆå¤åˆ¶ç²˜è´´ï¼‰

```bash
# === ä¸€é”®å®Œæ•´æµ‹è¯• ===

cd /Users/zhoudt/Downloads/project/HiFate-bazi

# 1. å¯åŠ¨æœåŠ¡
./start_all_services.sh

# 2. ç­‰å¾…5ç§’
sleep 5

# 3. åˆ›å»ºæ”¯ä»˜å¹¶ä¿å­˜ç»“æœ
RESPONSE=$(curl -s -X POST http://127.0.0.1:8001/api/v1/payment/create-session \
  -H "Content-Type: application/json" \
  -d '{
    "amount": "19.90",
    "currency": "USD",
    "product_name": "æœˆè®¢é˜…ä¼šå‘˜",
    "customer_email": "test@example.com"
  }')

# 4. æ˜¾ç¤ºç»“æœ
echo "$RESPONSE" | python3 -m json.tool

# 5. æå–å¹¶æ‰“å¼€æ”¯ä»˜é“¾æ¥
CHECKOUT_URL=$(echo "$RESPONSE" | grep -o '"checkout_url":"[^"]*"' | cut -d'"' -f4)
echo ""
echo "æ”¯ä»˜é“¾æ¥ï¼š"
echo "$CHECKOUT_URL"
echo ""
echo "åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é“¾æ¥ï¼Œä½¿ç”¨å¡å· 4242424242424242 å®Œæˆæ”¯ä»˜"

# 6. è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼ˆmacOSï¼‰
open "$CHECKOUT_URL"
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æœåŠ¡æ—¥å¿—ï¼š`logs/server_8001.log`
2. APIæ–‡æ¡£ï¼šhttp://127.0.0.1:8001/docs
3. Stripeåå°ï¼šhttps://dashboard.stripe.com/test

---

**æœ€åæ›´æ–°ï¼š2025-11-20**

