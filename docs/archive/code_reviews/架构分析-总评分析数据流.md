# 架构分析：总评分析数据流

## 架构层次

### 第一层：统一接口（BaziDataOrchestrator.fetch_data）

**职责**：统一获取所有数据模块的数据

**返回格式**：
```python
{
    'bazi': {...},              # 八字数据
    'wangshuai': {...},         # 旺衰数据
    'xishen_jishen': {...},     # 喜忌数据
    'detail': {...},            # 详细数据（包含大运流年序列）
    'dayun': [...],             # 大运序列
    'liunian': [...],           # 流年序列
    'special_liunians': {       # 特殊流年（字典格式）
        'list': [...],          # 原始列表（所有特殊流年）
        'by_dayun': {...},     # 按大运分组（格式：{dayun_step: [liunian1, ...]}）
        'formatted': '...'      # 格式化后的提示词
    },
    'personality': {...},       # 性格分析
    'rizhu': {...},            # 日柱算法
    'health': {...},            # 健康分析
    'rules': [...]             # 规则匹配结果
}
```

**特点**：
- ✅ 数据都从统一接口出
- ✅ 统一接口只负责数据获取，不做业务逻辑处理
- ✅ 特殊流年已经按大运分组（`by_dayun`），但**没有按关系类型分类**

### 第二层：业务接口（general_review_analysis.py）

**职责**：参数转换、逻辑处理、格式转换

**数据转换流程**：

```
1. 从统一接口提取数据
   ↓
2. 数据转换和逻辑处理
   - 提取特殊流年列表：special_liunians = unified_data['special_liunians']['list']
   - 按关系类型分类并分组：organize_special_liunians_by_dayun()
   - 提取喜忌数据：extract_xi_ji_data()
   - 构建 input_data 结构
   ↓
3. 格式转换为 Prompt
   - build_general_review_prompt()
   - 从 dayun_liunians 中提取特殊流年
   - 格式化喜忌数据
   ↓
4. 传递给 Coze Bot
```

## 问题分析

### 问题1：特殊流年数据提取错误

**位置**：第二层接口的 `build_general_review_prompt` 函数

**问题**：
- 统一接口返回的数据已经通过 `organize_special_liunians_by_dayun` 处理，存储在 `input_data['guanjian_dayun']['dayun_liunians']` 中
- 但 `build_general_review_prompt` 函数从错误的位置提取（从 `guanjian` 顶层获取，这些字段不存在）

**修复**：
- ✅ 从 `dayun_liunians` 中正确提取并合并所有大运的特殊流年
- ✅ 这是第二层接口的数据转换逻辑修复

### 问题2：喜忌数据完整性

**位置**：第二层接口的 `build_general_review_prompt` 函数

**问题**：
- 如果数据为空，不输出任何信息，Coze Bot 无法判断是数据缺失还是确实为空

**修复**：
- ✅ 即使数据为空也明确标注"无"
- ✅ 这是第二层接口的格式转换逻辑修复

## 修复位置总结

**修复的是第二层接口**，具体是：
1. **数据转换逻辑**：`build_general_review_input_data` → `organize_special_liunians_by_dayun`（这部分是正确的）
2. **格式转换逻辑**：`build_general_review_prompt` → 从 `dayun_liunians` 提取特殊流年（这部分之前有错误，已修复）

## 数据流验证

### 统一接口返回的数据

```python
special_liunians = {
    'list': [liunian1, liunian2, ...],  # 原始列表
    'by_dayun': {                       # 按大运分组（未按关系类型分类）
        1: [liunian1, liunian2],
        2: [liunian3, liunian4]
    }
}
```

### 第二层接口转换后的数据

```python
input_data['guanjian_dayun']['dayun_liunians'] = {
    1: {
        'dayun_info': {...},
        'tiankedi_chong': [...],  # 按关系类型分类
        'tianhedi_he': [...],
        'suiyun_binglin': [...],
        'other': [...]
    },
    2: {
        'dayun_info': {...},
        'tiankedi_chong': [...],
        ...
    }
}
```

### Prompt 构建时的提取

```python
# ✅ 修复后：从 dayun_liunians 中提取并合并
dayun_liunians = guanjian.get('dayun_liunians', {})
tiankedi_chong = []
for dayun_data in dayun_liunians.values():
    tiankedi_chong.extend(dayun_data.get('tiankedi_chong', []))
```

## 结论

**修复的是第二层接口**，具体是：
- ✅ 数据转换逻辑：正确（`organize_special_liunians_by_dayun` 按关系类型分类）
- ✅ 格式转换逻辑：已修复（从 `dayun_liunians` 正确提取）

**统一接口**：
- ✅ 数据格式正确
- ✅ 提供了 `list` 和 `by_dayun` 两种格式
- ✅ 不需要修改

**第二层接口的职责**：
- ✅ 参数转换：从统一接口提取数据
- ✅ 逻辑处理：按关系类型分类特殊流年
- ✅ 格式转换：转换为 Prompt 格式

