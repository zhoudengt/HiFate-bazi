# 测试统一数据获取接口

## 测试数据
- **性别**: 男
- **公历日期**: 1979年7月22日
- **出生时间**: 早上7点15分 (07:15)
- **请求数据**: 8个大运、特殊流年、喜忌

---

## 方式1: 使用提供的脚本（推荐）

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
./重启服务并测试.sh
```

---

## 方式2: 手动重启服务

### 步骤1: 停止现有服务

```bash
# 查找服务进程
lsof -ti :8001

# 停止服务（替换 PID 为实际进程ID）
kill <PID>

# 或者强制停止
pkill -f "python.*server.main"
```

### 步骤2: 启动服务

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
source .venv/bin/activate
python server/main.py
```

### 步骤3: 测试接口

```bash
curl -X POST "http://localhost:8001/api/v1/bazi/data" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1979-07-22",
    "solar_time": "07:15",
    "gender": "male",
    "modules": {
      "bazi": true,
      "wangshuai": true,
      "xishen_jishen": true,
      "dayun": {"mode": "count", "count": 8},
      "special_liunian": {"count": 8}
    },
    "use_cache": true,
    "parallel": true,
    "verify_consistency": true
  }' | python3 -m json.tool
```

---

## 方式3: 使用热更新（如果服务支持 reload=True）

服务配置了 `reload=True`，修改 `server/main.py` 文件可以触发自动重载：

```bash
# 触发热更新
touch server/main.py

# 等待2-3秒后测试
sleep 3
curl -X POST "http://localhost:8001/api/v1/bazi/data" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1979-07-22",
    "solar_time": "07:15",
    "gender": "male",
    "modules": {
      "bazi": true,
      "wangshuai": true,
      "xishen_jishen": true,
      "dayun": {"mode": "count", "count": 8},
      "special_liunian": {"count": 8}
    }
  }'
```

---

## 预期返回结果

接口应该返回包含以下数据的JSON：

1. **喜忌数据** (`xishen_jishen`):
   - `xi_shen_elements`: 喜神五行列表
   - `ji_shen_elements`: 忌神五行列表
   - `shishen_mingge`: 十神命格
   - `wangshuai`: 旺衰

2. **大运数据** (`dayun`): 8个大运
   - 每个大运包含: `ganzhi`, `step`, `age_display`, `year_start`, `year_end`

3. **特殊流年数据** (`special_liunian`): 有关系的流年列表
   - 每个流年包含: `year`, `ganzhi`, `relations`, `dayun_step`, `dayun_ganzhi`

---

## 注意事项

1. **新路由需要重启服务**: 由于是新增的路由，服务需要重启才能加载
2. **检查日志**: 如果接口返回错误，查看 `logs/server.log` 或服务控制台输出
3. **端口占用**: 确保8001端口没有被其他服务占用

---

## 故障排查

### 问题1: 接口返回 "Not Found"
- **原因**: 服务未加载新路由
- **解决**: 重启服务

### 问题2: 接口返回 500 错误
- **原因**: 代码执行错误
- **解决**: 查看服务日志，检查错误信息

### 问题3: 数据为空
- **原因**: 模块配置错误或数据获取失败
- **解决**: 检查 `modules` 配置，查看日志中的错误信息

