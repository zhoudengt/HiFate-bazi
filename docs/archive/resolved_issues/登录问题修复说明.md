# 登录问题修复说明

## 问题描述

登录页面无法登录，原因是：
1. 前端通过 gRPC 网关调用登录接口 `/auth/login`
2. gRPC 网关的路径 `/api/grpc-web/frontend.gateway.FrontendGateway/Call` 不在认证中间件的白名单中
3. 认证中间件拦截了登录请求，要求提供 Token
4. 但登录接口本身不需要 Token，形成了死循环

## 修复方案

### 1. 认证中间件白名单更新

**文件**: `server/middleware/auth_middleware.py`

- ✅ 将 gRPC 网关路径添加到白名单：
  ```python
  "/api/grpc-web/frontend.gateway.FrontendGateway/Call"
  ```

### 2. gRPC 网关内部认证处理

**文件**: `server/api/grpc_gateway.py`

- ✅ 在 gRPC 网关内部添加认证检查逻辑
- ✅ 定义白名单端点（不需要认证）：
  ```python
  whitelist_endpoints = {
      "/auth/login",
      "/oauth/authorize",
      "/oauth/token",
      "/oauth/refresh",
  }
  ```
- ✅ 对于非白名单端点，检查并验证 Token
- ✅ 对于白名单端点，直接放行

## 修复后的流程

### 登录流程

1. **前端调用登录接口**
   ```javascript
   // local_frontend/js/auth.js
   await api.post('/auth/login', { username, password })
   ```

2. **请求通过 gRPC 网关**
   - 路径：`/api/grpc-web/frontend.gateway.FrontendGateway/Call`
   - 认证中间件检查：路径在白名单中 → **直接放行**

3. **gRPC 网关内部处理**
   - 解析请求，提取 `endpoint = "/auth/login"`
   - 检查端点：`/auth/login` 在白名单中 → **不需要认证**
   - 调用登录处理函数

4. **登录处理函数**
   - 验证用户名密码
   - 生成 JWT Token（旧版）或调用 OAuth 创建 Token（新版）
   - 返回 Token 给前端

5. **前端保存 Token**
   ```javascript
   localStorage.setItem('token', response.access_token)
   ```

### 业务接口调用流程

1. **前端调用业务接口**
   ```javascript
   const token = localStorage.getItem('token')
   await api.post('/bazi/calculate', data, {
     headers: { 'Authorization': `Bearer ${token}` }
   })
   ```

2. **请求通过 gRPC 网关**
   - 路径：`/api/grpc-web/frontend.gateway.FrontendGateway/Call`
   - 认证中间件检查：路径在白名单中 → **直接放行**

3. **gRPC 网关内部处理**
   - 解析请求，提取 `endpoint = "/bazi/calculate"`
   - 检查端点：`/bazi/calculate` **不在白名单中** → **需要认证**
   - 提取 `auth_token`（从请求体中的 field 3）
   - 调用认证服务验证 Token
   - 验证通过 → 调用业务处理函数
   - 验证失败 → 返回 401 错误

## 测试验证

### 配置检查

运行测试脚本检查配置：
```bash
python3 scripts/test_login.py
```

应该看到：
- ✅ gRPC 网关路径在白名单中
- ✅ gRPC 网关中已配置登录接口白名单

### 功能测试

1. **启动服务**
   ```bash
   python3 server/start.py
   ```

2. **访问登录页面**
   - 打开 `http://localhost:8001/local_frontend/login.html`
   - 输入用户名：`admin`
   - 输入密码：`admin123`
   - 点击登录

3. **验证登录成功**
   - 应该跳转到 `index.html`
   - 检查浏览器控制台，应该看到 "✅ 登录成功"
   - 检查 `localStorage.getItem('token')`，应该有 Token

4. **验证 Token 可用**
   - 访问需要认证的页面
   - 应该能正常加载数据

## 关键代码位置

1. **认证中间件白名单**
   - 文件：`server/middleware/auth_middleware.py`
   - 第 27 行：gRPC 网关路径

2. **gRPC 网关认证逻辑**
   - 文件：`server/api/grpc_gateway.py`
   - 第 704-732 行：认证检查逻辑
   - 第 706-711 行：白名单端点定义

3. **登录接口注册**
   - 文件：`server/api/grpc_gateway.py`
   - 第 278 行：`@_register("/auth/login")`

4. **前端登录调用**
   - 文件：`local_frontend/js/auth.js`
   - 第 8 行：`api.post('/auth/login', ...)`

## 注意事项

1. **gRPC 网关路径必须在白名单中**
   - 否则所有通过 gRPC 网关的请求都会被认证中间件拦截

2. **gRPC 网关内部需要处理认证**
   - 因为网关路径在白名单中，所以认证逻辑必须在网关内部实现
   - 根据 endpoint 判断是否需要认证

3. **Token 传递方式**
   - 前端通过 gRPC-Web 请求的 field 3 传递 Token
   - gRPC 网关从 `frontend_request["auth_token"]` 获取

4. **白名单端点**
   - 登录相关：`/auth/login`
   - OAuth 相关：`/oauth/authorize`, `/oauth/token`, `/oauth/refresh`
   - 其他接口都需要认证

## 问题排查

如果登录仍然失败，检查：

1. **服务是否启动**
   ```bash
   curl http://localhost:8001/health
   ```

2. **认证中间件是否启用**
   - 查看服务启动日志，应该看到 "✓ OAuth 2.0 认证中间件已启用"

3. **gRPC 网关路径是否正确**
   - 检查 `server/middleware/auth_middleware.py` 第 27 行

4. **登录接口是否注册**
   - 检查 `server/api/grpc_gateway.py` 第 278 行

5. **浏览器控制台错误**
   - 打开浏览器开发者工具，查看 Network 和 Console 标签
   - 检查请求是否被拦截（401 错误）
   - 检查响应内容

## 相关文件

- `server/middleware/auth_middleware.py` - 认证中间件
- `server/api/grpc_gateway.py` - gRPC 网关（包含认证逻辑）
- `server/api/v1/auth.py` - 登录接口实现
- `local_frontend/js/auth.js` - 前端登录逻辑
- `local_frontend/login.html` - 登录页面
- `scripts/test_login.py` - 登录测试脚本
