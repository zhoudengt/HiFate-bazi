# 修复说明：总评分析数据流架构

## 架构层次说明

### 第一层：统一接口（BaziDataOrchestrator.fetch_data）

**职责**：统一获取所有数据模块的数据

**返回数据格式**：
```python
{
    'special_liunians': {
        'list': [...],          # 原始列表（所有特殊流年）
        'by_dayun': {...},     # 按大运分组（格式：{dayun_step: [liunian1, ...]}）
        'formatted': '...'      # 格式化后的提示词
    },
    'xishen_jishen': {...},    # 喜忌数据
    ...
}
```

**特点**：
- ✅ 数据都从统一接口出
- ✅ 统一接口只负责数据获取，不做业务逻辑处理
- ✅ 特殊流年已经按大运分组（`by_dayun`），但**没有按关系类型分类**

### 第二层：业务接口（general_review_analysis.py）

**职责**：参数转换、逻辑处理、格式转换

**数据转换流程**：

```
统一接口返回数据
    ↓
【参数转换】从统一接口提取数据
    - special_liunians = unified_data['special_liunians']['list']
    - xishen_jishen_result = unified_data['xishen_jishen']
    ↓
【逻辑处理】业务逻辑转换
    - organize_special_liunians_by_dayun()  # 按大运分组 + 按关系类型分类
    - extract_xi_ji_data()  # 提取并分离喜忌数据
    - build_general_review_input_data()  # 构建 input_data 结构
    ↓
【格式转换】转换为 Prompt 格式
    - build_general_review_prompt()  # 转换为自然语言格式
    ↓
传递给 Coze Bot
```

## 修复位置

### 修复的是：第二层接口的格式转换逻辑

**修复位置**：`server/api/v1/general_review_analysis.py` 的 `build_general_review_prompt` 函数

**修复内容**：

#### 1. 特殊流年数据提取（第1698-1770行）

**修复前**：
```python
# ❌ 错误：从顶层获取（这些字段不存在）
tiankedi_chong = guanjian.get('tiankedi_chong', [])  # 返回 []
```

**修复后**：
```python
# ✅ 正确：从 dayun_liunians 中提取并合并
dayun_liunians = guanjian.get('dayun_liunians', {})
tiankedi_chong = []
for dayun_data in dayun_liunians.values():
    tiankedi_chong.extend(dayun_data.get('tiankedi_chong', []))
```

**说明**：
- 统一接口返回的数据已经通过 `organize_special_liunians_by_dayun` 处理
- 存储在 `input_data['guanjian_dayun']['dayun_liunians']` 中
- 需要从 `dayun_liunians` 中提取并合并所有大运的特殊流年

#### 2. 喜忌数据完整性（第1778-1821行）

**修复前**：
```python
# ❌ 如果数据为空，不输出任何信息
if xishen_wuxing:
    prompt_lines.append(f"喜神五行：{'、'.join(xishen_wuxing)}")
# 如果为空，不输出
```

**修复后**：
```python
# ✅ 即使数据为空也明确标注
if xishen_wuxing:
    prompt_lines.append(f"喜神五行：{'、'.join(xishen_wuxing)}")
else:
    prompt_lines.append("喜神五行：无")
```

## 数据流验证

### 统一接口 → 第二层接口

```
统一接口返回：
{
    'special_liunians': {
        'list': [liunian1, liunian2, ...],  # 原始列表
        'by_dayun': {1: [...], 2: [...]}   # 按大运分组（未分类）
    }
}
    ↓
第二层接口提取：
special_liunians = unified_data['special_liunians']['list']
    ↓
第二层接口逻辑处理：
organize_special_liunians_by_dayun(special_liunians, dayun_sequence)
    ↓
转换为：
{
    'dayun_liunians': {
        1: {
            'tiankedi_chong': [...],  # 按关系类型分类
            'tianhedi_he': [...],
            ...
        }
    }
}
    ↓
第二层接口格式转换（修复位置）：
从 dayun_liunians 中提取并合并 → Prompt 格式
```

## 结论

**修复的是第二层接口的格式转换逻辑**，具体是：

1. ✅ **数据转换逻辑**：正确（`organize_special_liunians_by_dayun` 按关系类型分类）
2. ✅ **格式转换逻辑**：已修复（从 `dayun_liunians` 正确提取）

**统一接口**：
- ✅ 数据格式正确
- ✅ 提供了 `list` 和 `by_dayun` 两种格式
- ✅ 不需要修改

**第二层接口的职责**：
- ✅ **参数转换**：从统一接口提取数据（正确）
- ✅ **逻辑处理**：按关系类型分类特殊流年（正确）
- ✅ **格式转换**：转换为 Prompt 格式（已修复）

## 修复验证

修复后，数据流应该是：

```
统一接口（数据获取）
    ↓
第二层接口（参数转换 + 逻辑处理 + 格式转换）
    ↓
Prompt 构建（正确提取特殊流年和喜忌数据）
    ↓
Coze Bot（收到完整数据）
```

