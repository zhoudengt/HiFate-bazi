# 修复生产环境规则问题 - 执行步骤

## 📊 问题确认

- **本地环境规则数**: 1142 条
- **生产环境匹配数**: 20 条
- **差异**: 1007 条

## 🔧 修复步骤

### 方案 1: 使用手动同步脚本（推荐）

```bash
# 1. 运行手动同步脚本（会提示输入密码）
bash scripts/manual_sync_rules_to_production.sh
```

### 方案 2: 手动执行（如果脚本无法使用）

```bash
# 步骤 1: 上传 SQL 文件
scp scripts/temp_rules_export.sql root@8.210.52.217:/tmp/rules_import.sql

# 步骤 2: SSH 到生产环境
ssh root@8.210.52.217

# 步骤 3: 执行 SQL（在生产环境服务器上）
cd /opt/HiFate-bazi
docker exec -i hifate-mysql-master mysql -uroot -p${SSH_PASSWORD} hifate_bazi < /tmp/rules_import.sql

# 步骤 4: 清除缓存
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check

# 步骤 5: 退出 SSH
exit
```

### 方案 3: 使用增量部署脚本（如果已配置）

如果已经配置了增量部署脚本，可以直接使用：

```bash
bash deploy/scripts/incremental_deploy_production.sh
```

## ✅ 验证修复

修复后，运行测试脚本验证：

```bash
# 快速测试
python3 scripts/quick_test_production.py

# 完整对比测试
python3 scripts/test_compare_api_results.py
```

## 📋 预期结果

修复成功后，生产环境应该匹配：
- **总匹配数**: 接近 1142 条（允许 10% 差异，即 1027+ 条）
- **事业规则**: 9+ 条（当前 0 条）
- **身体规则**: 20+ 条（当前 5 条）
- **总评规则**: 8+ 条（当前 1 条）

## 🚨 如果修复后仍有问题

1. **检查规则 enabled 状态**:
   ```sql
   SELECT rule_type, COUNT(*) as total, SUM(enabled) as enabled_count
   FROM bazi_rules 
   WHERE rule_code LIKE 'FORMULA_%' 
   GROUP BY rule_type;
   ```

2. **检查缓存是否清除**:
   ```bash
   curl http://8.210.52.217:8001/api/v1/hot-reload/status
   ```

3. **检查代码版本是否一致**:
   ```bash
   ssh root@8.210.52.217 'cd /opt/HiFate-bazi && git log --oneline -1'
   ```

