# 服务器启动问题修复

## 问题描述

访问登录页面时，所有资源都返回 `ERR_CONNECTION_REFUSED` 错误，原因是服务器没有运行。

## 根本原因

1. **服务器未启动**：端口 8001 上没有服务在监听
2. **导入错误**：`server/api/v1/oauth.py` 试图导入 `RefreshTokenResponse`，但 `oauth_models.py` 中没有定义

## 修复内容

### 1. 添加缺失的模型类

**文件**: `server/api/v1/oauth_models.py`

添加了 `RefreshTokenResponse` 类：

```python
class RefreshTokenResponse(BaseModel):
    """Token 刷新响应"""
    access_token: str = Field(..., description="新的 Access Token")
    token_type: str = Field(default="bearer", description="Token 类型，固定为 'bearer'")
    expires_in: int = Field(..., description="Access Token 过期时间（秒）")
    refresh_token: Optional[str] = Field(None, description="新的 Refresh Token（可选，如果提供了则替换旧的）")
    scope: Optional[str] = Field(None, description="权限范围（可选）")
```

### 2. 修复导入语句

**文件**: `server/api/v1/oauth.py`

移除了未使用的 `RefreshTokenResponse` 导入（因为实际使用的是 `TokenResponse`）

## 启动服务器

### 方法 1：使用启动脚本（推荐）

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
python3 server/start.py
```

### 方法 2：后台运行

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
python3 server/start.py &
```

### 方法 3：使用 nohup（生产环境）

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
nohup python3 server/start.py > logs/server.log 2>&1 &
```

## 验证服务器运行

### 1. 检查健康状态

```bash
curl http://localhost:8001/health
```

应该返回：
```json
{"status":"healthy","timestamp":...}
```

### 2. 检查静态文件

```bash
curl -I http://localhost:8001/frontend/config.js
curl -I http://localhost:8001/frontend/js/auth.js
curl -I http://localhost:8001/frontend/login.html
```

应该返回 `200 OK`

### 3. 检查端口监听

```bash
lsof -i :8001
```

应该看到 Python 进程在监听端口 8001

## 测试登录页面

1. **启动服务器**（如果未启动）：
   ```bash
   python3 server/start.py
   ```

2. **访问登录页面**：
   - 打开浏览器
   - 访问 `http://localhost:8001/frontend/login.html`

3. **检查浏览器控制台**（F12）：
   - 应该看到脚本成功加载
   - 不应该有 `ERR_CONNECTION_REFUSED` 错误

4. **测试登录**：
   - 用户名：`admin`
   - 密码：`admin123`
   - 应该能成功登录

## 常见问题

### Q1: 端口已被占用

**错误信息**：
```
ERROR: [Errno 48] Address already in use
```

**解决方法**：
```bash
# 查找占用端口的进程
lsof -i :8001

# 杀死进程
kill -9 <PID>

# 或使用 pkill
pkill -f "python.*start.py"
```

### Q2: 模块未找到

**错误信息**：
```
ModuleNotFoundError: No module named 'pydantic'
```

**解决方法**：
```bash
# 安装依赖
pip install -r requirements.txt

# 或激活虚拟环境
source .venv/bin/activate
pip install -r requirements.txt
```

### Q3: 导入错误

**错误信息**：
```
ImportError: cannot import name 'RefreshTokenResponse'
```

**解决方法**：
- 确保 `server/api/v1/oauth_models.py` 中定义了 `RefreshTokenResponse` 类
- 确保 `server/api/v1/oauth.py` 中的导入语句正确

## 相关文件

- `server/start.py` - 服务器启动脚本
- `server/main.py` - FastAPI 应用主文件
- `server/api/v1/oauth_models.py` - OAuth 模型定义（已修复）
- `server/api/v1/oauth.py` - OAuth 路由（已修复导入）
