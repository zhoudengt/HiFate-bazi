# é—®é¢˜è¯Šæ–­ï¼šç”Ÿäº§ç¯å¢ƒè§„åˆ™åŒ¹é…å·®å¼‚

## ğŸ“Š é—®é¢˜æè¿°

**ç°è±¡**ï¼š
- ç”Ÿäº§ç¯å¢ƒï¼ˆ8.210.52.217ï¼‰åŒ¹é…è§„åˆ™æ•°ï¼š**20 æ¡**
- æœ¬åœ°/æµ‹è¯•ç¯å¢ƒåŒ¹é…è§„åˆ™æ•°ï¼š**63 æ¡**
- å·®å¼‚ï¼š**43 æ¡è§„åˆ™**

**æµ‹è¯•æ•°æ®**ï¼š
- å‡ºç”Ÿæ—¥æœŸï¼š1987-01-07
- å‡ºç”Ÿæ—¶é—´ï¼š09:00
- æ€§åˆ«ï¼šç”·

**è¯¦ç»†å¯¹æ¯”**ï¼š

| è§„åˆ™ç±»å‹ | ç”Ÿäº§ç¯å¢ƒ | æœ¬åœ°ç¯å¢ƒ | å·®å¼‚ |
|---------|---------|---------|------|
| æ€»è®¡åŒ¹é… | 20 | 63 | +43 |
| è´¢å¯Œ (wealth) | 12 | 18 | +6 |
| å©šå§» (marriage) | 1 | 3 | +2 |
| äº‹ä¸š (career) | **0** | **9** | **+9** âš ï¸ |
| å­å¥³ (children) | 0 | 2 | +2 |
| æ€§æ ¼ (character) | 1 | 2 | +1 |
| æ€»è¯„ (summary) | 1 | 8 | +7 |
| èº«ä½“ (health) | 5 | 20 | +15 âš ï¸ |
| æ¡ƒèŠ± (peach_blossom) | 0 | 0 | âœ“ |
| åç¥å‘½æ ¼ (shishen) | 0 | 1 | +1 |
| çˆ¶æ¯ (parents) | 0 | 0 | âœ“ |

## ğŸ” å¯èƒ½åŸå› åˆ†æ

### 1. æ•°æ®åº“è§„åˆ™æ•°é‡ä¸ä¸€è‡´ï¼ˆæœ€å¯èƒ½ï¼‰

**æœ¬åœ°ç¯å¢ƒè§„åˆ™ç»Ÿè®¡**ï¼š
- æ€»è§„åˆ™æ•°ï¼š1299 æ¡
- å¯ç”¨è§„åˆ™æ•°ï¼š1299 æ¡
- **FORMULA_ å‰ç¼€è§„åˆ™**ï¼šéœ€è¦å•ç‹¬ç»Ÿè®¡

**é—®é¢˜**ï¼š
- ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“å¯èƒ½ç¼ºå°‘éƒ¨åˆ†è§„åˆ™
- æˆ–è€…è§„åˆ™ `enabled` çŠ¶æ€ä¸åŒ

### 2. è§„åˆ™ç±»å‹æ ¼å¼ä¸ä¸€è‡´

**å‘ç°**ï¼š
- æœ¬åœ°æ•°æ®åº“å­˜åœ¨ä¸¤ç§æ ¼å¼ï¼š
  - æ—§æ ¼å¼ï¼š`formula_career`, `formula_wealth` ç­‰ï¼ˆ31+56+...æ¡ï¼‰
  - æ–°æ ¼å¼ï¼š`career`, `wealth` ç­‰ï¼ˆ61+140+...æ¡ï¼‰

**ä»£ç é€»è¾‘**ï¼š
- `formula_analysis.py` åªåŒ¹é… `FORMULA_` å‰ç¼€çš„è§„åˆ™
- è§„åˆ™ç±»å‹åº”è¯¥æ˜¯æ ‡å‡†æ ¼å¼ï¼ˆ`wealth`, `marriage` ç­‰ï¼‰ï¼Œä¸æ˜¯ `formula_*` æ ¼å¼

### 3. ç¼“å­˜å½±å“

- ç”Ÿäº§ç¯å¢ƒå¯èƒ½ä½¿ç”¨äº†æ—§çš„ç¼“å­˜ç»“æœ
- è§„åˆ™æ›´æ–°åç¼“å­˜æœªæ¸…é™¤

### 4. ä»£ç ç‰ˆæœ¬ä¸ä¸€è‡´

- ç”Ÿäº§ç¯å¢ƒä»£ç å¯èƒ½ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬
- è§„åˆ™åŒ¹é…é€»è¾‘å¯èƒ½æœ‰å·®å¼‚

## ğŸ”§ è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ£€æŸ¥ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“è§„åˆ™æ•°é‡

```bash
# 1. SSH åˆ°ç”Ÿäº§ç¯å¢ƒ
ssh root@8.210.52.217

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/HiFate-bazi

# 3. æ£€æŸ¥ FORMULA_ å‰ç¼€è§„åˆ™æ€»æ•°
docker exec hifate-mysql-master mysql -uroot -pYuanqizhan@163 hifate_bazi -e "
SELECT COUNT(*) as total FROM bazi_rules WHERE rule_code LIKE 'FORMULA_%';
"

# 4. æ£€æŸ¥å¯ç”¨çš„ FORMULA_ è§„åˆ™æ•°
docker exec hifate-mysql-master mysql -uroot -pYuanqizhan@163 hifate_bazi -e "
SELECT COUNT(*) as enabled_count FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%' AND enabled = 1;
"

# 5. æŒ‰ç±»å‹ç»Ÿè®¡ FORMULA_ è§„åˆ™ï¼ˆåªç»Ÿè®¡æ ‡å‡†æ ¼å¼ç±»å‹ï¼‰
docker exec hifate-mysql-master mysql -uroot -pYuanqizhan@163 hifate_bazi -e "
SELECT 
    rule_type,
    COUNT(*) as total,
    SUM(CASE WHEN enabled = 1 THEN 1 ELSE 0 END) as enabled_count
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%' 
  AND rule_type IN ('wealth', 'marriage', 'career', 'children', 'character', 'summary', 'health', 'peach_blossom', 'shishen', 'parents')
GROUP BY rule_type
ORDER BY rule_type;
"
```

### æ­¥éª¤ 2ï¼šå¯¹æ¯”æœ¬åœ°ç¯å¢ƒè§„åˆ™æ•°é‡

```bash
# åœ¨æœ¬åœ°è¿è¡Œ
python3 scripts/check_local_db_rules.py
```

**é‡ç‚¹å…³æ³¨**ï¼š
- `career` ç±»å‹è§„åˆ™æ•°é‡ï¼ˆç”Ÿäº§ç¯å¢ƒåŒ¹é… 0 æ¡ï¼Œæœ¬åœ°åŒ¹é… 9 æ¡ï¼‰
- `health` ç±»å‹è§„åˆ™æ•°é‡ï¼ˆç”Ÿäº§ç¯å¢ƒåŒ¹é… 5 æ¡ï¼Œæœ¬åœ°åŒ¹é… 20 æ¡ï¼‰
- `summary` ç±»å‹è§„åˆ™æ•°é‡ï¼ˆç”Ÿäº§ç¯å¢ƒåŒ¹é… 1 æ¡ï¼Œæœ¬åœ°åŒ¹é… 8 æ¡ï¼‰

### æ­¥éª¤ 3ï¼šæ£€æŸ¥ç”Ÿäº§ç¯å¢ƒä»£ç ç‰ˆæœ¬

```bash
# SSH åˆ°ç”Ÿäº§ç¯å¢ƒ
ssh root@8.210.52.217

# æ£€æŸ¥ä»£ç ç‰ˆæœ¬
cd /opt/HiFate-bazi
git log --oneline -1
git status

# æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦ä¸€è‡´
git diff HEAD server/api/v1/formula_analysis.py
git diff HEAD server/services/rule_service.py
```

### æ­¥éª¤ 4ï¼šæ¸…é™¤ç”Ÿäº§ç¯å¢ƒç¼“å­˜

```bash
# æ¸…é™¤ç¼“å­˜å¹¶è§¦å‘çƒ­æ›´æ–°
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check

# ç­‰å¾… 5-10 ç§’åé‡æ–°æµ‹è¯•
curl -X POST http://8.210.52.217:8001/api/v1/bazi/formula-analysis \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1987-01-07",
    "solar_time": "09:00",
    "gender": "male"
  }' | python3 -m json.tool | grep -A 20 "statistics"
```

### æ­¥éª¤ 5ï¼šæ£€æŸ¥è§„åˆ™ enabled çŠ¶æ€

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰è§„åˆ™è¢«ç¦ç”¨
docker exec hifate-mysql-master mysql -uroot -pYuanqizhan@163 hifate_bazi -e "
SELECT 
    rule_type,
    COUNT(*) as total,
    SUM(CASE WHEN enabled = 1 THEN 1 ELSE 0 END) as enabled_count,
    SUM(CASE WHEN enabled = 0 THEN 1 ELSE 0 END) as disabled_count
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%'
GROUP BY rule_type
HAVING disabled_count > 0;
"
```

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šåŒæ­¥è§„åˆ™åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆå¦‚æœè§„åˆ™æ•°é‡ä¸ä¸€è‡´ï¼‰

å¦‚æœç”Ÿäº§ç¯å¢ƒè§„åˆ™æ•°é‡å°‘ï¼Œéœ€è¦åŒæ­¥è§„åˆ™ï¼š

```bash
# 1. å¯¼å‡ºæœ¬åœ°è§„åˆ™
python3 scripts/db/export_rules.py --output rules_export.sql

# 2. ä¸Šä¼ åˆ°ç”Ÿäº§ç¯å¢ƒ
scp rules_export.sql root@8.210.52.217:/tmp/

# 3. åœ¨ç”Ÿäº§ç¯å¢ƒå¯¼å…¥
ssh root@8.210.52.217
docker exec -i hifate-mysql-master mysql -uroot -pYuanqizhan@163 hifate_bazi < /tmp/rules_export.sql
```

### æ–¹æ¡ˆ 2ï¼šæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½è§„åˆ™

```bash
# 1. æ¸…é™¤ç¼“å­˜
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check

# 2. é‡å¯è§„åˆ™æœåŠ¡ï¼ˆå¦‚æœéœ€è¦ï¼‰
# è§„åˆ™ä¼šè‡ªåŠ¨ä»æ•°æ®åº“é‡æ–°åŠ è½½
```

### æ–¹æ¡ˆ 3ï¼šæ£€æŸ¥å¹¶ä¿®å¤è§„åˆ™ç±»å‹æ ¼å¼

å¦‚æœå‘ç°è§„åˆ™ç±»å‹æ ¼å¼ä¸ä¸€è‡´ï¼ˆ`formula_*` vs æ ‡å‡†æ ¼å¼ï¼‰ï¼Œéœ€è¦ç»Ÿä¸€ï¼š

```sql
-- æ£€æŸ¥æ˜¯å¦æœ‰ formula_* æ ¼å¼çš„è§„åˆ™ç±»å‹
SELECT DISTINCT rule_type 
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%' 
  AND rule_type LIKE 'formula_%';

-- å¦‚æœéœ€è¦ï¼Œæ›´æ–°è§„åˆ™ç±»å‹ä¸ºæ ‡å‡†æ ¼å¼
UPDATE bazi_rules 
SET rule_type = REPLACE(rule_type, 'formula_', '')
WHERE rule_code LIKE 'FORMULA_%' 
  AND rule_type LIKE 'formula_%';
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [ ] ç”Ÿäº§ç¯å¢ƒ FORMULA_ è§„åˆ™æ€»æ•°
- [ ] ç”Ÿäº§ç¯å¢ƒå¯ç”¨è§„åˆ™æ•°
- [ ] æŒ‰ç±»å‹ç»Ÿè®¡è§„åˆ™æ•°é‡ï¼ˆç‰¹åˆ«æ˜¯ career, health, summaryï¼‰
- [ ] è§„åˆ™ enabled çŠ¶æ€æ£€æŸ¥
- [ ] ä»£ç ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥
- [ ] ç¼“å­˜æ¸…é™¤åé‡æ–°æµ‹è¯•
- [ ] è§„åˆ™ç±»å‹æ ¼å¼æ£€æŸ¥

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤åï¼Œç”Ÿäº§ç¯å¢ƒåº”è¯¥åŒ¹é…ï¼š
- æ€»åŒ¹é…æ•°ï¼š**63 æ¡**ï¼ˆä¸æœ¬åœ°ä¸€è‡´ï¼‰
- äº‹ä¸šè§„åˆ™ï¼š**9 æ¡**ï¼ˆå½“å‰ 0 æ¡ï¼‰
- èº«ä½“è§„åˆ™ï¼š**20 æ¡**ï¼ˆå½“å‰ 5 æ¡ï¼‰
- æ€»è¯„è§„åˆ™ï¼š**8 æ¡**ï¼ˆå½“å‰ 1 æ¡ï¼‰

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `server/api/v1/formula_analysis.py` - è§„åˆ™åˆ†æ API
- `server/services/rule_service.py` - è§„åˆ™æœåŠ¡
- `scripts/compare_rules_production_vs_local.py` - å¯¹æ¯”è„šæœ¬
- `scripts/check_local_db_rules.py` - æœ¬åœ°è§„åˆ™æ£€æŸ¥è„šæœ¬

