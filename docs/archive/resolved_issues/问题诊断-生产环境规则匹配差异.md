# 问题诊断：生产环境规则匹配差异

## 📊 问题描述

**现象**：
- 生产环境（8.210.52.217）匹配规则数：**20 条**
- 本地/测试环境匹配规则数：**63 条**
- 差异：**43 条规则**

**测试数据**：
- 出生日期：1987-01-07
- 出生时间：09:00
- 性别：男

**详细对比**：

| 规则类型 | 生产环境 | 本地环境 | 差异 |
|---------|---------|---------|------|
| 总计匹配 | 20 | 63 | +43 |
| 财富 (wealth) | 12 | 18 | +6 |
| 婚姻 (marriage) | 1 | 3 | +2 |
| 事业 (career) | **0** | **9** | **+9** ⚠️ |
| 子女 (children) | 0 | 2 | +2 |
| 性格 (character) | 1 | 2 | +1 |
| 总评 (summary) | 1 | 8 | +7 |
| 身体 (health) | 5 | 20 | +15 ⚠️ |
| 桃花 (peach_blossom) | 0 | 0 | ✓ |
| 十神命格 (shishen) | 0 | 1 | +1 |
| 父母 (parents) | 0 | 0 | ✓ |

## 🔍 可能原因分析

### 1. 数据库规则数量不一致（最可能）

**本地环境规则统计**：
- 总规则数：1299 条
- 启用规则数：1299 条
- **FORMULA_ 前缀规则**：需要单独统计

**问题**：
- 生产环境数据库可能缺少部分规则
- 或者规则 `enabled` 状态不同

### 2. 规则类型格式不一致

**发现**：
- 本地数据库存在两种格式：
  - 旧格式：`formula_career`, `formula_wealth` 等（31+56+...条）
  - 新格式：`career`, `wealth` 等（61+140+...条）

**代码逻辑**：
- `formula_analysis.py` 只匹配 `FORMULA_` 前缀的规则
- 规则类型应该是标准格式（`wealth`, `marriage` 等），不是 `formula_*` 格式

### 3. 缓存影响

- 生产环境可能使用了旧的缓存结果
- 规则更新后缓存未清除

### 4. 代码版本不一致

- 生产环境代码可能不是最新版本
- 规则匹配逻辑可能有差异

## 🔧 诊断步骤

### 步骤 1：检查生产环境数据库规则数量

```bash
# 1. SSH 到生产环境
ssh root@8.210.52.217

# 2. 进入项目目录
cd /opt/HiFate-bazi

# 3. 检查 FORMULA_ 前缀规则总数
docker exec hifate-mysql-master mysql -uroot -p${SSH_PASSWORD} hifate_bazi -e "
SELECT COUNT(*) as total FROM bazi_rules WHERE rule_code LIKE 'FORMULA_%';
"

# 4. 检查启用的 FORMULA_ 规则数
docker exec hifate-mysql-master mysql -uroot -p${SSH_PASSWORD} hifate_bazi -e "
SELECT COUNT(*) as enabled_count FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%' AND enabled = 1;
"

# 5. 按类型统计 FORMULA_ 规则（只统计标准格式类型）
docker exec hifate-mysql-master mysql -uroot -p${SSH_PASSWORD} hifate_bazi -e "
SELECT 
    rule_type,
    COUNT(*) as total,
    SUM(CASE WHEN enabled = 1 THEN 1 ELSE 0 END) as enabled_count
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%' 
  AND rule_type IN ('wealth', 'marriage', 'career', 'children', 'character', 'summary', 'health', 'peach_blossom', 'shishen', 'parents')
GROUP BY rule_type
ORDER BY rule_type;
"
```

### 步骤 2：对比本地环境规则数量

```bash
# 在本地运行
python3 scripts/check_local_db_rules.py
```

**重点关注**：
- `career` 类型规则数量（生产环境匹配 0 条，本地匹配 9 条）
- `health` 类型规则数量（生产环境匹配 5 条，本地匹配 20 条）
- `summary` 类型规则数量（生产环境匹配 1 条，本地匹配 8 条）

### 步骤 3：检查生产环境代码版本

```bash
# SSH 到生产环境
ssh root@8.210.52.217

# 检查代码版本
cd /opt/HiFate-bazi
git log --oneline -1
git status

# 检查关键文件是否一致
git diff HEAD server/api/v1/formula_analysis.py
git diff HEAD server/services/rule_service.py
```

### 步骤 4：清除生产环境缓存

```bash
# 清除缓存并触发热更新
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check

# 等待 5-10 秒后重新测试
curl -X POST http://8.210.52.217:8001/api/v1/bazi/formula-analysis \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1987-01-07",
    "solar_time": "09:00",
    "gender": "male"
  }' | python3 -m json.tool | grep -A 20 "statistics"
```

### 步骤 5：检查规则 enabled 状态

```bash
# 检查是否有规则被禁用
docker exec hifate-mysql-master mysql -uroot -p${SSH_PASSWORD} hifate_bazi -e "
SELECT 
    rule_type,
    COUNT(*) as total,
    SUM(CASE WHEN enabled = 1 THEN 1 ELSE 0 END) as enabled_count,
    SUM(CASE WHEN enabled = 0 THEN 1 ELSE 0 END) as disabled_count
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%'
GROUP BY rule_type
HAVING disabled_count > 0;
"
```

## 🔧 修复方案

### 方案 1：同步规则到生产环境（如果规则数量不一致）

如果生产环境规则数量少，需要同步规则：

```bash
# 1. 导出本地规则
python3 scripts/db/export_rules.py --output rules_export.sql

# 2. 上传到生产环境
scp rules_export.sql root@8.210.52.217:/tmp/

# 3. 在生产环境导入
ssh root@8.210.52.217
docker exec -i hifate-mysql-master mysql -uroot -p${SSH_PASSWORD} hifate_bazi < /tmp/rules_export.sql
```

### 方案 2：清除缓存并重新加载规则

```bash
# 1. 清除缓存
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check

# 2. 重启规则服务（如果需要）
# 规则会自动从数据库重新加载
```

### 方案 3：检查并修复规则类型格式

如果发现规则类型格式不一致（`formula_*` vs 标准格式），需要统一：

```sql
-- 检查是否有 formula_* 格式的规则类型
SELECT DISTINCT rule_type 
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%' 
  AND rule_type LIKE 'formula_%';

-- 如果需要，更新规则类型为标准格式
UPDATE bazi_rules 
SET rule_type = REPLACE(rule_type, 'formula_', '')
WHERE rule_code LIKE 'FORMULA_%' 
  AND rule_type LIKE 'formula_%';
```

## 📋 检查清单

- [ ] 生产环境 FORMULA_ 规则总数
- [ ] 生产环境启用规则数
- [ ] 按类型统计规则数量（特别是 career, health, summary）
- [ ] 规则 enabled 状态检查
- [ ] 代码版本一致性检查
- [ ] 缓存清除后重新测试
- [ ] 规则类型格式检查

## 🎯 预期结果

修复后，生产环境应该匹配：
- 总匹配数：**63 条**（与本地一致）
- 事业规则：**9 条**（当前 0 条）
- 身体规则：**20 条**（当前 5 条）
- 总评规则：**8 条**（当前 1 条）

## 📝 相关文件

- `server/api/v1/formula_analysis.py` - 规则分析 API
- `server/services/rule_service.py` - 规则服务
- `scripts/compare_rules_production_vs_local.py` - 对比脚本
- `scripts/check_local_db_rules.py` - 本地规则检查脚本

