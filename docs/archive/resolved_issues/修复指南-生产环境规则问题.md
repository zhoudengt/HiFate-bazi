# 🔧 修复指南：生产环境规则匹配问题

## 📊 问题确认

**诊断结果**：
- ✅ **本地数据库规则**: 1142 条（全部启用）
- ✅ **本地 API 匹配**: 63 条
- ❌ **生产环境 API 匹配**: 20 条（差异 43 条）
- ✅ **代码逻辑**: 正常
- ✅ **前端展示**: 正常

**核心问题**: 生产环境数据库规则数量不足

## 🔍 详细对比

| 规则类型 | 本地匹配 | 生产匹配 | 差异 |
|---------|---------|---------|------|
| 总计 | 63 | 20 | -43 |
| 财富 | 18 | 12 | -6 |
| 婚姻 | 3 | 1 | -2 |
| **事业** | **9** | **0** | **-9** ⚠️ |
| 子女 | 2 | 0 | -2 |
| 性格 | 2 | 1 | -1 |
| **总评** | **8** | **1** | **-7** ⚠️ |
| **身体** | **20** | **5** | **-15** ⚠️ |
| 十神命格 | 1 | 0 | -1 |

## 🚀 修复步骤（必须手动执行）

### 步骤 1: 检查生产环境数据库规则数量

```bash
# SSH 到生产环境（需要输入密码）
ssh root@8.210.52.217

# 检查规则数量
cd /opt/HiFate-bazi
docker exec hifate-mysql-master mysql -uroot -p${SSH_PASSWORD} hifate_bazi -e "
SELECT 
    rule_type,
    COUNT(*) as total,
    SUM(CASE WHEN enabled = 1 THEN 1 ELSE 0 END) as enabled_count
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%' 
  AND rule_type IN ('wealth', 'marriage', 'career', 'children', 'character', 'summary', 'health', 'peach_blossom', 'shishen', 'parents')
GROUP BY rule_type
ORDER BY rule_type;
"
```

**预期结果**：应该看到各类型规则数量，对比本地：
- career: 应该有 61 条（生产环境可能为 0）
- health: 应该有 119 条（生产环境可能只有少量）
- summary: 应该有 555 条（生产环境可能只有少量）

### 步骤 2: 上传 SQL 文件到生产环境

```bash
# 在本地执行（需要输入 SSH 密码）
scp scripts/temp_rules_export.sql root@8.210.52.217:/tmp/rules_import.sql
```

**文件大小**: 约 1.1MB，包含 1142 条规则

### 步骤 3: 执行 SQL 同步规则

```bash
# SSH 到生产环境（如果还没连接）
ssh root@8.210.52.217

# 执行 SQL（在生产环境服务器上）
cd /opt/HiFate-bazi
docker exec -i hifate-mysql-master mysql -uroot -p${SSH_PASSWORD} hifate_bazi < /tmp/rules_import.sql
```

**预期输出**: 应该看到 MySQL 执行成功，没有错误信息

**注意**: SQL 使用 `ON DUPLICATE KEY UPDATE`，不会重复插入，可以安全执行多次

### 步骤 4: 清除缓存

```bash
# 在生产环境服务器上执行
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check

# 或退出 SSH 后在本地执行
curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check
```

### 步骤 5: 等待规则重新加载

```bash
# 等待 5-10 秒
sleep 5
```

### 步骤 6: 验证修复结果

```bash
# 在本地执行验证脚本
bash scripts/verify_fix.sh

# 或运行完整对比测试
python3 scripts/test_compare_api_results.py
```

## 📋 快速执行命令（一行命令）

```bash
# 1. 上传并执行 SQL（需要输入两次密码：scp 和 ssh）
scp scripts/temp_rules_export.sql root@8.210.52.217:/tmp/rules_import.sql && \
ssh root@8.210.52.217 "cd /opt/HiFate-bazi && docker exec -i hifate-mysql-master mysql -uroot -p${SSH_PASSWORD} hifate_bazi < /tmp/rules_import.sql && curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check"

# 2. 等待 5 秒后验证
sleep 5 && bash scripts/verify_fix.sh
```

## ✅ 预期修复结果

修复成功后，生产环境应该匹配：

- **总匹配数**: 50+ 条（接近本地 63 条）
- **事业规则**: 9+ 条（当前 0 条）
- **身体规则**: 15+ 条（当前 5 条）
- **总评规则**: 6+ 条（当前 1 条）

## 🚨 如果修复后仍有问题

### 检查 1: 规则 enabled 状态

```sql
-- 检查是否有规则被禁用
SELECT rule_type, COUNT(*) as total, SUM(enabled) as enabled_count
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%' 
GROUP BY rule_type
HAVING enabled_count < total;
```

### 检查 2: 规则类型格式

```sql
-- 检查是否有 formula_* 格式的规则类型（应该统一为标准格式）
SELECT DISTINCT rule_type 
FROM bazi_rules 
WHERE rule_code LIKE 'FORMULA_%' 
  AND rule_type LIKE 'formula_%';
```

### 检查 3: 缓存状态

```bash
curl http://8.210.52.217:8001/api/v1/hot-reload/status
```

### 检查 4: 代码版本

```bash
ssh root@8.210.52.217 'cd /opt/HiFate-bazi && git log --oneline -1'
```

## 📝 相关文件

- `scripts/temp_rules_export.sql` - SQL 导出文件（1.1MB，1142 条规则）
- `scripts/verify_fix.sh` - 验证脚本
- `scripts/test_compare_api_results.py` - 完整对比测试
- `scripts/auto_fix_loop.py` - 持续测试循环

## 💡 提示

1. **SQL 文件安全**: 使用 `ON DUPLICATE KEY UPDATE`，不会重复插入
2. **可以重复执行**: 如果第一次失败，可以重复执行 SQL
3. **缓存清除**: 清除缓存后需要等待几秒让规则重新加载
4. **验证时机**: 修复后立即验证，如果仍有问题，检查上述检查项

