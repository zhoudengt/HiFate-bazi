# 数据库变更检查清单

本文档提供了数据库变更的完整检查清单，确保变更安全可靠。

## 变更前准备

- [ ] 变更需求分析完成
  - [ ] 变更类型确认（新增表、新增字段、修改字段、新增索引等）
  - [ ] 影响范围评估
  - [ ] 回滚方案设计

- [ ] 数据库备份完成
  ```bash
  mysqldump -u root -p hifate_bazi > backup_$(date +%Y%m%d_%H%M%S).sql
  ```

## 变更脚本开发阶段

- [ ] 变更脚本已编写
  - [ ] 脚本位置：`scripts/migration/xxx.sql` 或 `scripts/migration/xxx.py`
  - [ ] 脚本使用事务（START TRANSACTION / COMMIT）
  - [ ] 脚本包含错误处理
  - [ ] 脚本支持 `--dry-run` 预览模式（如需要）

- [ ] 回滚脚本已编写
  - [ ] 脚本位置：`scripts/db/rollback/rollback_YYYYMMDD_HHMMSS.sql`
  - [ ] 脚本使用事务（START TRANSACTION / COMMIT）
  - [ ] 脚本使用 `IF EXISTS` 避免错误
  - [ ] 脚本包含验证 SQL（可选）

- [ ] 变更脚本已测试（测试环境）
  - [ ] 在测试环境执行变更脚本
  - [ ] 验证变更结果
  - [ ] 测试回滚脚本

- [ ] 编码方式检查（如涉及中文字符）
  - [ ] 数据插入使用 UNHEX（中文字符）
  - [ ] 数据查询使用 BINARY 比较（中文字段）
  - [ ] 数据同步脚本验证编码正确性

## 变更执行阶段（Node1 灰度节点）

- [ ] 变更脚本已上传到 Node1
  - [ ] 脚本文件已复制到服务器
  - [ ] 脚本权限正确（可执行）

- [ ] 变更脚本已执行（预览模式）
  ```bash
  python3 scripts/migration/xxx.py --dry-run
  ```

- [ ] 变更脚本已执行（正式执行）
  ```bash
  python3 scripts/migration/xxx.py
  ```

- [ ] 变更结果验证通过
  - [ ] 表结构正确（如新增表）
  - [ ] 字段正确（如新增字段）
  - [ ] 数据正确（如数据迁移）
  - [ ] 索引正确（如新增索引）

- [ ] Node1 功能测试通过
  - [ ] 相关功能正常
  - [ ] 无错误日志
  - [ ] 性能正常

## 变更执行阶段（Node2 生产节点）

- [ ] 变更脚本已上传到 Node2
  - [ ] 脚本文件已复制到服务器
  - [ ] 脚本权限正确（可执行）

- [ ] 变更脚本已执行（预览模式）
  ```bash
  python3 scripts/migration/xxx.py --dry-run
  ```

- [ ] 变更脚本已执行（正式执行）
  ```bash
  python3 scripts/migration/xxx.py
  ```

- [ ] 变更结果验证通过
  - [ ] 表结构正确
  - [ ] 字段正确
  - [ ] 数据正确
  - [ ] 索引正确

- [ ] Node2 功能测试通过
  - [ ] 相关功能正常
  - [ ] 无错误日志
  - [ ] 性能正常

## 变更后验证

- [ ] 双机数据库结构一致
  - [ ] Node1 和 Node2 表结构一致
  - [ ] Node1 和 Node2 字段一致
  - [ ] Node1 和 Node2 数据一致（如需要）

- [ ] 生产环境功能正常
  - [ ] 所有相关功能正常
  - [ ] 无错误日志
  - [ ] 性能正常

## 回滚准备

- [ ] 回滚脚本已验证
  - [ ] 回滚脚本在测试环境验证通过
  - [ ] 回滚脚本可以正确恢复变更

- [ ] 回滚流程已准备
  - [ ] 回滚步骤已文档化
  - [ ] 回滚责任人已确认

## 完成标准

所有检查项必须全部通过，才能认为数据库变更完成。

**成功标准**：
- ✅ 所有检查项通过
- ✅ 变更脚本执行成功
- ✅ 双机数据库结构一致
- ✅ 生产环境功能正常
- ✅ 回滚方案已准备

**注意事项**：
- ⚠️ 数据库变更必须先在 Node1（灰度节点）执行并验证
- ⚠️ Node1 验证通过后，才能在 Node2（生产节点）执行
- ⚠️ 如果 Node1 验证失败，必须回滚 Node1 变更，不得继续到 Node2
- ⚠️ 所有包含中文字符的数据操作必须使用正确的编码方式（UNHEX/BINARY）

