# 意图识别强制本地优先修复说明

## 📋 问题描述

**用户反馈**：
- 意图识别必须优先走本地模型
- 本地模型走不了才走LLM（高武）
- 现在完全不可控，不知道为什么会走LLM

## ✅ 修复方案

### 1. 强制本地优先策略

修改了 `services/intent_service/classifier.py` 的 `_need_llm_fallback` 方法：

**核心原则**：
- 🔴 **必须优先使用本地模型/关键词回退**
- 🔴 **LLM仅作为极端情况下的最后兜底**

**修改内容**：

1. **关键词回退优先**（降低阈值到0.80）
   - 置信度 >= 0.80：强制跳过LLM
   - 置信度 >= 0.60：也跳过LLM（新增）
   - 只有置信度 < 0.60 时才考虑LLM

2. **本地模型优先**（降低阈值到0.60）
   - 置信度 >= 0.60：强制跳过LLM
   - 置信度 >= 0.40：也跳过LLM（新增）
   - 只有置信度 < 0.40 时才考虑LLM

3. **LLM兜底条件更严格**（只有极端情况才使用）
   - 置信度 < 0.3 **且** 完全没有关键词
   - 问题长度 < 2（完全无法理解）
   - 置信度 < 0.3 **且** 问题模糊

### 2. 提高关键词回退置信度

修改了 `services/intent_service/local_classifier.py` 的 `_keyword_based_classify` 方法：

**置信度设置**：
- 无匹配：0.75（从0.6提高）
- 单个意图：0.95（从0.90提高）
- 多个意图：0.90（从0.80提高）
- 检测到时间关键词：+0.05（最高0.98）
- 检测到强意图关键词：+0.03（最高0.98）

### 3. 本地模型置信度提升

修改了 `services/intent_service/local_classifier.py` 的 `_model_classify` 方法：

**优化**：
- 模型置信度 < 0.3：才使用关键词回退
- 模型置信度 0.3-0.5：提升到0.6，避免触发LLM

## 🎯 测试结果

所有测试问题都使用本地关键词回退，**没有调用LLM**：

```
✅ 本地 | 我的财运怎么样？     | method=keyword_fallback | confidence=0.93
✅ 本地 | 今年适合投资吗？     | method=keyword_fallback | confidence=0.98
✅ 本地 | 我明年的财运怎么样？ | method=keyword_fallback | confidence=0.98
✅ 本地 | 我后三年的财运如何？ | method=keyword_fallback | confidence=0.98
✅ 本地 | 我2028年的财运怎么样？| method=keyword_fallback | confidence=0.98
```

## 📊 修改前后对比

| 场景 | 修改前 | 修改后 |
|------|--------|--------|
| 关键词回退阈值 | >= 0.85 跳过LLM | >= 0.80 跳过LLM（新增：>= 0.60 也跳过） |
| 本地模型阈值 | >= 0.7 跳过LLM | >= 0.60 跳过LLM（新增：>= 0.40 也跳过） |
| LLM兜底条件 | 置信度 < 0.5 | 置信度 < 0.3 **且** 无关键词 |
| 关键词回退置信度 | 0.6-0.90 | 0.75-0.98 |
| 本地模型低置信度处理 | 使用关键词回退 | 提升到0.6，避免LLM |

## 🔒 强制规则

### 规则1：关键词回退优先
```python
if method == "keyword_fallback":
    if confidence >= 0.80:
        return False  # 强制跳过LLM
    elif confidence >= 0.60:
        return False  # 也跳过LLM
```

### 规则2：本地模型优先
```python
if method == "local_model":
    if confidence >= 0.60:
        return False  # 强制跳过LLM
    elif confidence >= 0.40:
        return False  # 也跳过LLM
```

### 规则3：LLM兜底（极端情况）
```python
# 只有以下情况才使用LLM：
1. confidence < 0.3 AND len(keywords) == 0
2. len(question) < 2
3. confidence < 0.3 AND is_ambiguous
```

## 📝 相关文件

- `services/intent_service/classifier.py` - 主分类器（LLM兜底判断）
- `services/intent_service/local_classifier.py` - 本地分类器（关键词回退）

## ⚠️ 注意事项

1. **本地模型未安装**：如果 `transformers` 库未安装，会自动使用关键词回退，不会触发LLM
2. **置信度提升**：关键词回退和本地模型的置信度都已大幅提升，确保不会触发LLM
3. **极端情况**：只有在完全无法识别的情况下（置信度<0.3且无关键词）才会使用LLM

---

**修改日期**：2025-12-02  
**修改原因**：强制意图识别优先使用本地模型/关键词回退，LLM仅作为极端情况下的最后兜底

