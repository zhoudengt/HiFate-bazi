# 生产环境表检查和更新使用指南

## 概述

本指南说明如何在生产环境（Node1 和 Node2）上检查和更新以下数据库表：

1. **`rizhu_liujiazi`** - 日元-六十甲子表
2. **`daily_fortune_zodiac`** - 生肖简运表（生肖刑冲破害表）

## 功能说明

脚本会自动：
- ✅ 检查表是否存在
- ✅ 如果表不存在，自动创建表
- ✅ 如果表存在，可选择更新数据
- ✅ 在双节点（Node1 和 Node2）上执行

## 使用方法

### 方式 1：只检查表，不更新数据（推荐首次运行）

```bash
# 在本地执行（通过SSH连接到生产服务器）
bash scripts/db/check_and_update_tables_production.sh
```

**功能**：
- 检查两个表是否存在
- 如果不存在，自动创建表
- 不更新数据

### 方式 2：检查表并更新数据

```bash
# 在本地执行（通过SSH连接到生产服务器）
bash scripts/db/check_and_update_tables_production.sh --update-data
```

**功能**：
- 检查两个表是否存在
- 如果不存在，自动创建表
- 如果表存在，更新数据（调用导入脚本）

### 方式 3：在单个节点上执行（手动）

```bash
# 在 Node1 上执行
ssh root@8.210.52.217 "cd /opt/HiFate-bazi && python3 scripts/db/check_and_update_tables_production.py"

# 在 Node2 上执行
ssh root@47.243.160.43 "cd /opt/HiFate-bazi && python3 scripts/db/check_and_update_tables_production.py"

# 带数据更新
ssh root@8.210.52.217 "cd /opt/HiFate-bazi && python3 scripts/db/check_and_update_tables_production.py --update-data"
```

## 表结构说明

### 1. rizhu_liujiazi 表

**用途**：存储日元-六十甲子解析内容

**字段**：
- `id` - ID（对应Excel中的ID）
- `rizhu` - 日柱（如：乙丑）
- `analysis` - 对应解析（包含格式的完整文本）
- `enabled` - 是否启用
- `created_at` - 创建时间
- `updated_at` - 更新时间

### 2. daily_fortune_zodiac 表

**用途**：存储生肖刑冲破害关系（合、冲、刑、破、害）

**字段**：
- `id` - ID
- `day_branch` - 日支（如：辰）
- `relation_type` - 关系类型（合/冲/刑/破/害）
- `target_branch` - 目标地支（如：戌）
- `target_zodiac` - 目标生肖（如：狗）
- `content` - 内容
- `enabled` - 是否启用
- `created_at` - 创建时间
- `updated_at` - 更新时间

## 执行流程

```
1. 连接 Node1
   ├─ 检查 rizhu_liujiazi 表
   │  ├─ 不存在 → 创建表
   │  └─ 存在 → 跳过创建
   ├─ 检查 daily_fortune_zodiac 表
   │  ├─ 不存在 → 创建表
   │  └─ 存在 → 跳过创建
   └─ 如果指定 --update-data，更新数据

2. 连接 Node2
   ├─ 执行相同的检查和创建流程
   └─ 如果指定 --update-data，更新数据

3. 验证结果
   ├─ 检查表是否存在
   └─ 统计数据条数
```

## 注意事项

1. **数据更新需要 Excel 文件**：
   - `rizhu_liujiazi` 数据来源：`docs/upload/日元-六十甲子.xlsx`
   - `daily_fortune_zodiac` 数据来源：`docs/upload/每日运势-生肖刑冲破害.xlsx`
   - 如果 Excel 文件不存在，数据更新会失败（但不会影响表创建）

2. **SSH 连接要求**：
   - 需要配置 SSH 免密登录，或使用密码认证
   - 确保可以连接到 Node1 (8.210.52.217) 和 Node2 (47.243.160.43)

3. **数据库连接**：
   - 脚本使用环境变量中的 MySQL 配置
   - 确保生产环境的 `.env` 文件配置正确

4. **执行权限**：
   - 确保脚本有执行权限：`chmod +x scripts/db/check_and_update_tables_production.sh`

## 故障排查

### 问题 1：SSH 连接失败

**症状**：`Connection refused` 或 `Permission denied`

**解决**：
```bash
# 测试 SSH 连接
ssh root@8.210.52.217 "echo 'SSH连接成功'"
ssh root@47.243.160.43 "echo 'SSH连接成功'"

# 如果失败，检查 SSH 配置或使用密码认证
```

### 问题 2：数据库连接失败

**症状**：`无法连接数据库`

**解决**：
```bash
# 在生产服务器上检查环境变量
ssh root@8.210.52.217 "cd /opt/HiFate-bazi && cat .env | grep MYSQL"

# 检查 MySQL 服务是否运行
ssh root@8.210.52.217 "docker ps | grep mysql"
```

### 问题 3：表创建失败

**症状**：`创建表失败`

**解决**：
```bash
# 检查数据库权限
ssh root@8.210.52.217 "cd /opt/HiFate-bazi && python3 -c 'from server.config.mysql_config import get_mysql_connection; conn = get_mysql_connection(); print(\"连接成功\" if conn else \"连接失败\")'"
```

### 问题 4：数据更新失败

**症状**：`数据更新失败` 或 `文件不存在`

**解决**：
```bash
# 检查 Excel 文件是否存在
ssh root@8.210.52.217 "ls -la /opt/HiFate-bazi/docs/upload/"

# 如果文件不存在，需要先上传文件
```

## 相关文件

- **Python 脚本**：`scripts/db/check_and_update_tables_production.py`
- **Shell 脚本**：`scripts/db/check_and_update_tables_production.sh`
- **表创建脚本**：`scripts/migration/create_rizhu_liujiazi_table.py`
- **数据导入脚本**：
  - `scripts/migration/import_rizhu_liujiazi.py`
  - `scripts/migration/import_daily_fortune_zodiac.py`
- **表结构定义**：`server/db/schema_daily_fortune.sql`

## 执行示例

### 示例 1：首次运行（只创建表）

```bash
$ bash scripts/db/check_and_update_tables_production.sh

============================================================
生产环境表检查和更新（双节点）
============================================================

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📡 执行节点: Node1 (8.210.52.217)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
============================================================
生产环境表检查和更新
============================================================

📋 检查表状态...

1. 检查 rizhu_liujiazi 表...
  📝 表 rizhu_liujiazi 不存在，正在创建...
  ✅ 表 rizhu_liujiazi 创建成功

2. 检查 daily_fortune_zodiac 表...
  📝 表 daily_fortune_zodiac 不存在，正在创建...
  ✅ 表 daily_fortune_zodiac 创建成功

🔍 最终验证...
  ✅ rizhu_liujiazi 表存在，数据条数: 0
  ✅ daily_fortune_zodiac 表存在，数据条数: 0

============================================================
✅ 表检查和更新完成
============================================================
✅ Node1 执行成功
```

### 示例 2：更新数据

```bash
$ bash scripts/db/check_and_update_tables_production.sh --update-data

============================================================
生产环境表检查和更新（双节点）
============================================================

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📡 执行节点: Node1 (8.210.52.217)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
============================================================
生产环境表检查和更新
============================================================

📋 检查表状态...

1. 检查 rizhu_liujiazi 表...
  ✅ 表 rizhu_liujiazi 已存在

2. 检查 daily_fortune_zodiac 表...
  ✅ 表 daily_fortune_zodiac 已存在

📊 更新数据...

  更新 rizhu_liujiazi 数据...
  ✅ rizhu_liujiazi 数据更新成功

  更新 daily_fortune_zodiac 数据...
  ✅ daily_fortune_zodiac 数据更新成功

🔍 最终验证...
  ✅ rizhu_liujiazi 表存在，数据条数: 60
  ✅ daily_fortune_zodiac 表存在，数据条数: 120

============================================================
✅ 表检查和更新完成
============================================================
✅ Node1 执行成功
```

## 总结

使用本脚本可以：
- ✅ 自动检查表是否存在
- ✅ 自动创建缺失的表
- ✅ 可选择更新数据
- ✅ 在双节点上自动执行
- ✅ 提供详细的执行日志

**建议**：
1. 首次运行使用不带 `--update-data` 的参数，只创建表
2. 确认表创建成功后，再使用 `--update-data` 更新数据
3. 定期检查表状态，确保数据一致性

