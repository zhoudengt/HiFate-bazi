# HiFate-bazi ç³»ç»ŸåŠŸèƒ½ç›˜ç‚¹ - å¯å¤ç”¨æ¨¡å—æ¸…å•

> ğŸ“… **æ›´æ–°æ—¶é—´**ï¼š2025-11-24  
> ğŸ¯ **ç›®çš„**ï¼šç›˜ç‚¹ç°æœ‰åŠŸèƒ½ï¼Œé¿å…é‡å¤å¼€å‘ï¼Œä¼˜å…ˆå¤ç”¨ç°æœ‰æ¨¡å—

---

## ğŸ“‹ ç›®å½•

- [æ ¸å¿ƒè®¡ç®—æ¨¡å—](#æ ¸å¿ƒè®¡ç®—æ¨¡å—)
- [åˆ†æå™¨æ¨¡å—](#åˆ†æå™¨æ¨¡å—)
- [æœåŠ¡å±‚æ¨¡å—](#æœåŠ¡å±‚æ¨¡å—)
- [è§„åˆ™å¼•æ“](#è§„åˆ™å¼•æ“)
- [æ•°æ®ç»“æ„](#æ•°æ®ç»“æ„)
- [å¾®æœåŠ¡](#å¾®æœåŠ¡)
- [å·¥å…·å‡½æ•°](#å·¥å…·å‡½æ•°)

---

## ğŸ¯ æ ¸å¿ƒè®¡ç®—æ¨¡å—ï¼ˆ`src/`ç›®å½•ï¼‰

### 1ï¸âƒ£ å¤©å¹²åœ°æ”¯å…³ç³»ï¼ˆâ­â­â­â­â­ å¿…ç”¨ï¼‰

**ä½ç½®**ï¼š`src/data/relations.py`

**åŠŸèƒ½**ï¼š
- âœ… å¤©å¹²åˆï¼ˆç”²å·±åˆã€ä¹™åºšåˆ...ï¼‰
- âœ… åœ°æ”¯å…­åˆï¼ˆå­ä¸‘åˆã€å¯…äº¥åˆ...ï¼‰
- âœ… åœ°æ”¯å…­å†²ï¼ˆå­åˆå†²ã€ä¸‘æœªå†²...ï¼‰
- âœ… åœ°æ”¯åˆ‘ï¼ˆå¯…å·³ç”³ä¸‰åˆ‘ã€ä¸‘æˆŒæœªä¸‰åˆ‘...ï¼‰
- âœ… åœ°æ”¯å®³ï¼ˆå­æœªå®³ã€ä¸‘åˆå®³...ï¼‰
- âœ… åœ°æ”¯ç ´ï¼ˆå­é…‰ç ´ã€ä¸‘è¾°ç ´...ï¼‰
- âœ… åœ°æ”¯ä¸‰åˆå±€ï¼ˆç”³å­è¾°æ°´å±€ã€äº¥å¯æœªæœ¨å±€...ï¼‰
- âœ… åœ°æ”¯ä¸‰ä¼šå±€ï¼ˆäº¥å­ä¸‘åŒ—æ–¹æ°´ã€å¯…å¯è¾°ä¸œæ–¹æœ¨...ï¼‰

**æ•°æ®ç»“æ„**ï¼š
```python
STEM_HE = {"ç”²": "å·±", "å·±": "ç”²", ...}  # å¤©å¹²åˆ
BRANCH_LIUHE = {"å­": "ä¸‘", "ä¸‘": "å­", ...}  # åœ°æ”¯å…­åˆ
BRANCH_CHONG = {"å­": "åˆ", "åˆ": "å­", ...}  # åœ°æ”¯å…­å†²
BRANCH_XING = {"å¯…": ["å·³", "ç”³"], ...}  # åœ°æ”¯åˆ‘
BRANCH_HAI = {"å­": ["æœª"], ...}  # åœ°æ”¯å®³
BRANCH_PO = {"å­": "é…‰", "é…‰": "å­", ...}  # åœ°æ”¯ç ´
BRANCH_SANHE_GROUPS = [("ç”³", "å­", "è¾°"), ...]  # ä¸‰åˆå±€
BRANCH_SANHUI_GROUPS = [("äº¥", "å­", "ä¸‘"), ...]  # ä¸‰ä¼šå±€
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from src.data.relations import BRANCH_CHONG, STEM_HE

# åˆ¤æ–­åœ°æ”¯æ˜¯å¦ç›¸å†²
if BRANCH_CHONG.get(branch1) == branch2:
    print("ç›¸å†²")

# åˆ¤æ–­å¤©å¹²æ˜¯å¦ç›¸åˆ
if STEM_HE.get(stem1) == stem2:
    print("ç›¸åˆ")
```

---

### 2ï¸âƒ£ äº”è¡Œå±æ€§ä¸å…³ç³»ï¼ˆâ­â­â­â­â­ å¿…ç”¨ï¼‰

**ä½ç½®**ï¼š`src/data/constants.py`, `src/data/stems_branches.py`

**åŠŸèƒ½**ï¼š
- âœ… å¤©å¹²äº”è¡Œå±æ€§ï¼ˆç”²ä¹™æœ¨ã€ä¸™ä¸ç«...ï¼‰
- âœ… åœ°æ”¯äº”è¡Œå±æ€§ï¼ˆå­æ°´ã€ä¸‘åœŸ...ï¼‰
- âœ… åœ°æ”¯è—å¹²ï¼ˆå¯…è—ç”²ä¸™æˆŠ...ï¼‰
- âœ… çº³éŸ³äº”è¡Œï¼ˆç”²å­æµ·ä¸­é‡‘...ï¼‰
- âœ… å¤©å¹²åœ°æ”¯é˜´é˜³å±æ€§
- âœ… æ–¹ä½å±æ€§

**æ•°æ®ç»“æ„**ï¼š
```python
# å¤©å¹²äº”è¡Œ
STEM_ELEMENTS = {
    'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«',
    'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘',
    'å£¬': 'æ°´', 'ç™¸': 'æ°´'
}

# åœ°æ”¯äº”è¡Œ
BRANCH_ELEMENTS = {
    'å­': 'æ°´', 'ä¸‘': 'åœŸ', 'å¯…': 'æœ¨', 'å¯': 'æœ¨',
    'è¾°': 'åœŸ', 'å·³': 'ç«', 'åˆ': 'ç«', 'æœª': 'åœŸ',
    'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'æˆŒ': 'åœŸ', 'äº¥': 'æ°´'
}

# åœ°æ”¯è—å¹²
HIDDEN_STEMS = {
    'å­': ['ç™¸æ°´'],
    'ä¸‘': ['å·±åœŸ', 'ç™¸æ°´', 'è¾›é‡‘'],
    'å¯…': ['ç”²æœ¨', 'ä¸™ç«', 'æˆŠåœŸ'],
    ...
}
```

---

### 3ï¸âƒ£ äº”è¡Œç”Ÿå…‹å…³ç³»ï¼ˆâ­â­â­â­â­ å¿…ç”¨ï¼‰

**ä½ç½®**ï¼š
- `src/bazi_core/calculator.py` (line 54-60)
- `src/bazi_calculator.py` (line 118-126)
- `src/analyzers/wangshuai_analyzer.py` (line 20-26)

**åŠŸèƒ½**ï¼š
- âœ… äº”è¡Œç›¸ç”Ÿï¼ˆæœ¨â†’ç«â†’åœŸâ†’é‡‘â†’æ°´â†’æœ¨ï¼‰
- âœ… äº”è¡Œç›¸å…‹ï¼ˆæœ¨å…‹åœŸã€åœŸå…‹æ°´ã€æ°´å…‹ç«ã€ç«å…‹é‡‘ã€é‡‘å…‹æœ¨ï¼‰

**æ•°æ®ç»“æ„**ï¼š
```python
ELEMENT_RELATIONS = {
    'æœ¨': {
        'produces': 'ç«',      # æˆ‘ç”Ÿï¼ˆæœ¨ç”Ÿç«ï¼‰
        'controls': 'åœŸ',      # æˆ‘å…‹ï¼ˆæœ¨å…‹åœŸï¼‰
        'produced_by': 'æ°´',   # ç”Ÿæˆ‘ï¼ˆæ°´ç”Ÿæœ¨ï¼‰
        'controlled_by': 'é‡‘'  # å…‹æˆ‘ï¼ˆé‡‘å…‹æœ¨ï¼‰
    },
    'ç«': {'produces': 'åœŸ', 'controls': 'é‡‘', 'produced_by': 'æœ¨', 'controlled_by': 'æ°´'},
    'åœŸ': {'produces': 'é‡‘', 'controls': 'æ°´', 'produced_by': 'ç«', 'controlled_by': 'æœ¨'},
    'é‡‘': {'produces': 'æ°´', 'controls': 'æœ¨', 'produced_by': 'åœŸ', 'controlled_by': 'ç«'},
    'æ°´': {'produces': 'æœ¨', 'controls': 'ç«', 'produced_by': 'é‡‘', 'controlled_by': 'åœŸ'}
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from src.bazi_core.calculator import BaziCoreCalculator

calculator = BaziCoreCalculator("1987-09-16", "05:00", "male")
relations = calculator.element_relations

# æŸ¥è¯¢æœ¨çš„ç”Ÿå…‹å…³ç³»
wood_relations = relations['æœ¨']
print(f"æœ¨ç”Ÿ{wood_relations['produces']}")  # æœ¨ç”Ÿç«
print(f"æœ¨å…‹{wood_relations['controls']}")  # æœ¨å…‹åœŸ
```

---

### 4ï¸âƒ£ åç¥è®¡ç®—ï¼ˆâ­â­â­â­â­ å¿…ç”¨ï¼‰

**ä½ç½®**ï¼š`src/bazi_calculator.py` (WenZhenBazi class)

**åŠŸèƒ½**ï¼š
- âœ… æ ¹æ®æ—¥å¹²å’Œå…¶ä»–å¤©å¹²/åœ°æ”¯è®¡ç®—åç¥
- âœ… æ”¯æŒå¤©å¹²åç¥è®¡ç®—ï¼ˆ`get_main_star`ï¼‰
- âœ… æ”¯æŒåœ°æ”¯åç¥è®¡ç®—ï¼ˆ`get_branch_ten_gods`ï¼‰

**æ–¹æ³•ç­¾å**ï¼š
```python
def get_main_star(self, day_stem, target_stem, pillar_type):
    """
    è®¡ç®—ä¸»æ˜Ÿï¼ˆåç¥ï¼‰
    
    Args:
        day_stem: æ—¥å¹²ï¼ˆå¦‚ 'æˆŠ'ï¼‰
        target_stem: ç›®æ ‡å¤©å¹²ï¼ˆå¦‚ 'ä¸'ï¼‰
        pillar_type: æŸ±ç±»å‹ï¼ˆ'year'/'month'/'day'/'hour'ï¼‰
    
    Returns:
        str: åç¥åç§°ï¼ˆå¦‚ 'åå°'ï¼‰
    """
```

**åç¥åˆ¤æ–­é€»è¾‘**ï¼š
```python
# äº”è¡Œå…³ç³» + é˜´é˜³åˆ¤æ–­
- same (åŒäº”è¡Œ) â†’ åŒé˜´é˜³: æ¯”è‚© / å¼‚é˜´é˜³: åŠ«è´¢
- me_producing (æˆ‘ç”Ÿ) â†’ åŒé˜´é˜³: é£Ÿç¥ / å¼‚é˜´é˜³: ä¼¤å®˜
- me_controlling (æˆ‘å…‹) â†’ åŒé˜´é˜³: åè´¢ / å¼‚é˜´é˜³: æ­£è´¢
- controlling_me (å…‹æˆ‘) â†’ åŒé˜´é˜³: ä¸ƒæ€ / å¼‚é˜´é˜³: æ­£å®˜
- producing_me (ç”Ÿæˆ‘) â†’ åŒé˜´é˜³: åå° / å¼‚é˜´é˜³: æ­£å°
```

---

## ğŸ”¬ åˆ†æå™¨æ¨¡å—ï¼ˆ`src/analyzers/`ï¼‰

### 1ï¸âƒ£ æ—ºè¡°åˆ†æå™¨ï¼ˆâ­â­â­â­â­ æ ¸å¿ƒåŠŸèƒ½ï¼‰

**ä½ç½®**ï¼š`src/analyzers/wangshuai_analyzer.py`

**åŠŸèƒ½**ï¼š
- âœ… **æ—¥ä¸»æ—ºè¡°åˆ†æ**ï¼ˆææ—º/åæ—º/ä¸­å’Œ/èº«å¼±/æå¼±ï¼‰
- âœ… **å–œç¥å¿Œç¥åˆ¤æ–­**ï¼ˆåç¥ï¼‰â­
- âœ… **å–œå¿Œäº”è¡Œè®¡ç®—**ï¼ˆäº”è¡Œï¼‰â­
- âœ… **è°ƒå€™ç”¨ç¥**ï¼ˆå¤å­£ç”¨æ°´ã€å†¬å­£ç”¨ç«ï¼‰

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
class WangShuaiAnalyzer:
    def analyze(self, solar_date: str, solar_time: str, gender: str) -> Dict[str, Any]:
        """å®Œæ•´æ—ºè¡°åˆ†æï¼Œè¿”å›æ—ºè¡°çŠ¶æ€ã€å–œå¿Œç¥ã€å–œå¿Œäº”è¡Œ"""
        
    def _determine_xi_ji(self, wangshuai: str) -> Dict[str, List[str]]:
        """åˆ¤å®šå–œå¿Œç¥ï¼ˆåç¥ï¼‰â­"""
        # æ ¹æ®æ—ºè¡°çŠ¶æ€æŸ¥è¡¨
        # è¿”å›ï¼š{'xi_shen': ['é£Ÿç¥', 'ä¼¤å®˜'], 'ji_shen': ['æ­£å°', 'åå°']}
        
    def _calculate_xi_ji_elements(self, xi_ji: Dict, bazi: Dict) -> Dict[str, List[str]]:
        """è®¡ç®—å–œå¿Œäº”è¡Œ â­"""
        # æ ¹æ®å–œå¿Œç¥çš„åç¥ï¼Œæ˜ å°„åˆ°äº”è¡Œ
        # è¿”å›ï¼š{'xi_shen': ['åœŸ', 'é‡‘'], 'ji_shen': ['æ°´', 'æœ¨']}
```

**è¿”å›æ•°æ®ç»“æ„**ï¼š
```python
{
    "wangshuai": "åæ—º",
    "score": 25,
    "xi_ji": {
        "xi_shen": ["é£Ÿç¥", "ä¼¤å®˜", "åè´¢", "æ­£è´¢"],  # å–œç¥ï¼ˆåç¥ï¼‰
        "ji_shen": ["åå°", "æ­£å°", "æ¯”è‚©", "åŠ«è´¢"]    # å¿Œç¥ï¼ˆåç¥ï¼‰
    },
    "xi_ji_elements": {
        "xi_shen": ["åœŸ", "é‡‘"],  # å–œç¥äº”è¡Œ
        "ji_shen": ["æ°´", "æœ¨"]   # å¿Œç¥äº”è¡Œ
    },
    "tiaohou": {
        "tiaohou_element": "æ°´",  # è°ƒå€™ç”¨ç¥
        "season": "å¤å­£",
        "description": "å¤å­£å‡ºç”Ÿï¼Œç«æ—ºåœŸç‡¥ï¼Œéœ€è¦æ°´æ¥è°ƒèŠ‚é™æ¸©"
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from src.analyzers.wangshuai_analyzer import WangShuaiAnalyzer

analyzer = WangShuaiAnalyzer()
result = analyzer.analyze("1987-09-16", "05:00", "male")

print(f"æ—ºè¡°: {result['wangshuai']}")
print(f"å–œç¥ï¼ˆåç¥ï¼‰: {result['xi_ji']['xi_shen']}")
print(f"å–œç¥ï¼ˆäº”è¡Œï¼‰: {result['xi_ji_elements']['xi_shen']}")
```

---

### 2ï¸âƒ£ å…¶ä»–åˆ†æå™¨

| åˆ†æå™¨ | ä½ç½® | åŠŸèƒ½ | å¤ç”¨åº¦ |
|--------|------|------|--------|
| **åç¥åˆ†æå™¨** | `src/analyzers/deities_analyzer.py` | åç¥æ ¼å±€åˆ†æ | â­â­â­ |
| **æ—¥æŸ±æ€§åˆ«åˆ†æå™¨** | `src/analyzers/rizhu_gender_analyzer.py` | æ—¥æŸ±æ€§åˆ«ç‰¹å¾ | â­â­â­ |
| **è§„åˆ™åˆ†æå™¨** | `src/analyzers/fortune_rules_analyzer.py` | è§„åˆ™åŒ¹é…åˆ†æ | â­â­â­â­ |

---

## ğŸŒ æœåŠ¡å±‚æ¨¡å—ï¼ˆ`server/services/`ï¼‰

### 1ï¸âƒ£ BaziDetailServiceï¼ˆâ­â­â­â­â­ æ ¸å¿ƒæœåŠ¡ï¼‰

**ä½ç½®**ï¼š`server/services/bazi_detail_service.py`

**åŠŸèƒ½**ï¼š
- âœ… å®Œæ•´å…«å­—è®¡ç®—ï¼ˆå››æŸ±ã€åç¥ã€äº”è¡Œï¼‰
- âœ… **å¤§è¿åºåˆ—è®¡ç®—**ï¼ˆ`dayun_sequence`ï¼‰â­
- âœ… **æµå¹´åºåˆ—è®¡ç®—**ï¼ˆ`liunian_sequence`ï¼‰â­
- âœ… æµæœˆåºåˆ—è®¡ç®—ï¼ˆ`liuyue_sequence`ï¼‰
- âœ… æµæ—¥åºåˆ—è®¡ç®—ï¼ˆ`liuri_sequence`ï¼‰
- âœ… èµ·è¿äº¤è¿ä¿¡æ¯

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
@staticmethod
def calculate_detail_full(
    solar_date: str, 
    solar_time: str, 
    gender: str, 
    current_time: datetime = None,
    dayun_index: int = None,
    target_year: int = None
) -> dict:
    """
    å®Œæ•´è®¡ç®—è¯¦ç»†å…«å­—ä¿¡æ¯ï¼ˆåŒ…å«å¤§è¿æµå¹´ï¼‰
    
    Returns:
        {
            "bazi_pillars": {...},        # å››æŸ±
            "dayun_sequence": [...],      # å¤§è¿åºåˆ— â­
            "liunian_sequence": [...],    # æµå¹´åºåˆ— â­
            "liuyue_sequence": [...],     # æµæœˆåºåˆ—
            "liuri_sequence": [...],      # æµæ—¥åºåˆ—
            "elements": {...},            # äº”è¡Œç»Ÿè®¡
            "ten_gods_stats": {...},      # åç¥ç»Ÿè®¡
            ...
        }
    """
```

**å¤§è¿åºåˆ—æ•°æ®ç»“æ„**ï¼š
```python
{
    "step": 1,                    # ç¬¬å‡ æ­¥å¤§è¿
    "stem": "ä¸™",                 # å¤©å¹²
    "branch": "åˆ",               # åœ°æ”¯
    "ganzhi": "ä¸™åˆ",             # å¹²æ”¯
    "main_star": "æ­£å°",          # å¤©å¹²åç¥
    "year_start": 1990,           # èµ·å§‹å¹´ä»½
    "year_end": 1999,             # ç»“æŸå¹´ä»½
    "age_display": "3-12å²",
    "nayin": "å¤©æ²³æ°´",
    ...
}
```

**æµå¹´åºåˆ—æ•°æ®ç»“æ„**ï¼š
```python
{
    "year": 2025,                 # å¹´ä»½
    "stem": "ä¹™",                 # å¤©å¹²
    "branch": "å·³",               # åœ°æ”¯
    "ganzhi": "ä¹™å·³",             # å¹²æ”¯
    "main_star": "åŠ«è´¢",          # å¤©å¹²åç¥ï¼ˆç›¸å¯¹äºæ—¥ä¸»ï¼‰â­
    "nayin": "è¦†ç¯ç«",
    ...
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from server.services.bazi_detail_service import BaziDetailService
from datetime import datetime

# è®¡ç®—2027å¹´çš„è¯¦ç»†ä¿¡æ¯
target_time = datetime(2027, 1, 1)
result = BaziDetailService.calculate_detail_full(
    solar_date="1987-09-16",
    solar_time="05:00",
    gender="male",
    current_time=target_time
)

# è·å–å¤§è¿æµå¹´
dayun_sequence = result["dayun_sequence"]
liunian_sequence = result["liunian_sequence"]

# è·å–2027å¹´çš„æµå¹´ä¿¡æ¯
liunian_2027 = next((ln for ln in liunian_sequence if ln["year"] == 2027), None)
print(f"2027å¹´æµå¹´: {liunian_2027['ganzhi']}, åç¥: {liunian_2027['main_star']}")
```

---

### 2ï¸âƒ£ RuleServiceï¼ˆâ­â­â­â­â­ è§„åˆ™åŒ¹é…ï¼‰

**ä½ç½®**ï¼š`server/services/rule_service.py`

**åŠŸèƒ½**ï¼š
- âœ… è§„åˆ™åŒ¹é…ï¼ˆæ”¯æŒ462+æ¡è§„åˆ™ï¼‰
- âœ… å¤šçº§ç¼“å­˜ï¼ˆL1å†…å­˜ + L2 Redisï¼‰
- âœ… çƒ­åŠ è½½æœºåˆ¶
- âœ… è§„åˆ™ç±»å‹è¿‡æ»¤

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
@classmethod
def match_rules(cls, bazi_data: Dict, rule_types: List[str] = None, 
                use_cache: bool = True) -> List[Dict]:
    """
    åŒ¹é…è§„åˆ™
    
    Args:
        bazi_data: å…«å­—æ•°æ®ï¼ˆåŒ…å«å››æŸ±ã€åç¥ã€äº”è¡Œç­‰ï¼‰
        rule_types: è§„åˆ™ç±»å‹åˆ—è¡¨ï¼ˆå¦‚ ['FORMULA_WEALTH', 'FORMULA_HEALTH']ï¼‰
        use_cache: æ˜¯å¦ä½¿ç”¨ç¼“å­˜
    
    Returns:
        List[Dict]: åŒ¹é…çš„è§„åˆ™åˆ—è¡¨
    """
```

**æ”¯æŒçš„è§„åˆ™ç±»å‹**ï¼š
```python
# ç®—æ³•å…¬å¼ç±»ï¼ˆ816æ¡è§„åˆ™ï¼‰
- FORMULA_WEALTH_*    # è´¢å¯Œè§„åˆ™
- FORMULA_HEALTH_*    # å¥åº·è§„åˆ™
- FORMULA_CAREER_*    # äº‹ä¸šè§„åˆ™ï¼ˆæ˜ å°„ä¸ºcharacterï¼‰
- FORMULA_CHARACTER_* # æ€§æ ¼è§„åˆ™
- FORMULA_MARRIAGE_*  # å©šå§»è§„åˆ™

# å©šå§»ç±»ï¼ˆ300+æ¡è§„åˆ™ï¼‰
- marriage_ten_gods, marriage_element, marriage_day_stem...

# æ¡ƒèŠ±ç±»
- taohua_general
```

---

### 3ï¸âƒ£ FortuneContextServiceï¼ˆâ­â­â­â­ æµå¹´å¤§è¿ä¸Šä¸‹æ–‡ï¼‰

**ä½ç½®**ï¼š`server/services/fortune_context_service.py`

**åŠŸèƒ½**ï¼š
- âœ… æå–æµå¹´å¤§è¿ä¿¡æ¯
- âœ… æ—¶é—´å…³é”®è¯è§£æï¼ˆä»Šå¹´ã€æ˜å¹´ã€åå¹´ã€å¤§åå¹´...ï¼‰
- âœ… å¤šå¹´æµå¹´å¯¹æ¯”
- âœ… **åç¥å’Œäº”è¡Œè®¡ç®—**ï¼ˆç›¸å¯¹äºæ—¥ä¸»ï¼‰â­

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
@staticmethod
def get_fortune_context(
    bazi_info: dict,
    user_question: str,
    intent: str,
    day_stem: str  # â­ æ—¥ä¸»å¤©å¹²ï¼ˆç”¨äºè®¡ç®—åç¥ï¼‰
) -> dict:
    """
    è·å–æµå¹´å¤§è¿ä¸Šä¸‹æ–‡ä¿¡æ¯
    
    Args:
        bazi_info: å…«å­—ä¿¡æ¯ï¼ˆæ¥è‡ªBaziDetailServiceï¼‰
        user_question: ç”¨æˆ·é—®é¢˜ï¼ˆç”¨äºæå–æ—¶é—´ï¼‰
        intent: æ„å›¾ï¼ˆwealth/health/career/marriageï¼‰
        day_stem: æ—¥ä¸»å¤©å¹²ï¼ˆå¦‚ 'æˆŠ'ï¼‰
    
    Returns:
        {
            "liunian_list": [...],  # æµå¹´åˆ—è¡¨ï¼ˆå¸¦åç¥ã€äº”è¡Œåˆ†æï¼‰
            "dayun": {...},         # å½“å‰å¤§è¿
            "fortune_summary": "å¤šå¹´æµå¹´å¯¹æ¯”åˆ†ææ–‡æœ¬"
        }
    """
```

**æ—¶é—´å…³é”®è¯æ”¯æŒ**ï¼š
```python
TIME_KEYWORDS = {
    "å‰å¹´": "year_before_last",    # 2023
    "å»å¹´": "last_year",            # 2024
    "ä»Šå¹´": "this_year",            # 2025
    "æ˜å¹´": "next_year",            # 2026
    "åå¹´": "year_after_next",     # 2027 â­
    "å¤§åå¹´": "two_years_after_next",  # 2028 â­
    "è¿‡å»": "past_years",
    "æœªæ¥": "future_years",
}
```

---

### 4ï¸âƒ£ å…¶ä»–æœåŠ¡

| æœåŠ¡ | ä½ç½® | åŠŸèƒ½ | å¤ç”¨åº¦ |
|------|------|------|--------|
| **BaziService** | `bazi_service.py` | åŸºç¡€å…«å­—è®¡ç®— | â­â­â­â­ |
| **DailyFortuneService** | `daily_fortune_service.py` | æ—¥è¿åŠ¿åˆ†æ | â­â­â­ |
| **MonthlyFortuneService** | `monthly_fortune_service.py` | æœˆè¿åŠ¿åˆ†æ | â­â­â­ |

---

## âš™ï¸ è§„åˆ™å¼•æ“ï¼ˆ`server/engines/`ï¼‰

### EnhancedRuleEngineï¼ˆâ­â­â­â­â­ é«˜æ€§èƒ½è§„åˆ™åŒ¹é…ï¼‰

**ä½ç½®**ï¼š`server/engines/rule_engine.py`

**åŠŸèƒ½**ï¼š
- âœ… ç´¢å¼•ä¼˜åŒ–ï¼ˆæŒ‰å¹´æœˆæ—¥æ—¶æŸ±ã€ç¥ç…ã€è§„åˆ™ç±»å‹å»ºç«‹ç´¢å¼•ï¼‰
- âœ… å¹¶è¡ŒåŒ¹é…ï¼ˆThreadPoolExecutorï¼‰
- âœ… æ”¯æŒ50+ç§æ¡ä»¶ç±»å‹
- âœ… ç»„åˆæ¡ä»¶ï¼ˆall/any/notï¼‰

**æ¡ä»¶ç±»å‹**ï¼š
```python
- pillar_in: å››æŸ±åŒ¹é…ï¼ˆå¹´æœˆæ—¥æ—¶æŸ±çš„å¤©å¹²/åœ°æ”¯ï¼‰
- element_count: äº”è¡Œæ•°é‡
- ten_god_count: åç¥æ•°é‡
- gender: æ€§åˆ«
- stem_pattern: å¤©å¹²ç»„åˆæ¨¡å¼
- branch_pattern: åœ°æ”¯ç»„åˆæ¨¡å¼
- deity_exists: ç¥ç…å­˜åœ¨
- nayin_in: çº³éŸ³åŒ¹é…
- dayun_stem/branch: å¤§è¿å¤©å¹²/åœ°æ”¯
- liunian_stem/branch: æµå¹´å¤©å¹²/åœ°æ”¯
...
```

---

## ğŸ“Š æ•°æ®ç»“æ„

### å…«å­—æ•°æ®ï¼ˆä»BaziDetailServiceï¼‰

```python
{
    # å››æŸ±ä¿¡æ¯
    "bazi_pillars": {
        "year": {"stem": "ä¸", "branch": "å¯"},
        "month": {"stem": "å·±", "branch": "é…‰"},
        "day": {"stem": "æˆŠ", "branch": "è¾°"},   # â­ æ—¥ä¸»
        "hour": {"stem": "ä¹™", "branch": "å¯"}
    },
    
    # äº”è¡Œç»Ÿè®¡
    "elements": {"é‡‘": 1, "æœ¨": 3, "æ°´": 0, "ç«": 1, "åœŸ": 3},
    "element_counts": {"æœ¨": 3, "ç«": 1, "åœŸ": 3, "é‡‘": 1, "æ°´": 0},
    
    # åç¥ç»Ÿè®¡
    "ten_gods_stats": {
        "æ¯”è‚©": 1, "åŠ«è´¢": 2, "é£Ÿç¥": 0, ...
    },
    
    # å¤§è¿åºåˆ—ï¼ˆâ­â­â­â­â­ï¼‰
    "dayun_sequence": [
        {
            "step": 1,
            "stem": "ä¸™", "branch": "åˆ",
            "ganzhi": "ä¸™åˆ",
            "main_star": "æ­£å°",
            "year_start": 1990, "year_end": 1999,
            ...
        },
        ...
    ],
    
    # æµå¹´åºåˆ—ï¼ˆâ­â­â­â­â­ï¼‰
    "liunian_sequence": [
        {
            "year": 2025,
            "stem": "ä¹™", "branch": "å·³",
            "ganzhi": "ä¹™å·³",
            "main_star": "åŠ«è´¢",  # ç›¸å¯¹äºæ—¥ä¸»çš„åç¥
            "nayin": "è¦†ç¯ç«",
            ...
        },
        ...
    ],
    
    # æµæœˆåºåˆ—
    "liuyue_sequence": [...],
    
    # æµæ—¥åºåˆ—
    "liuri_sequence": [...],
}
```

---

## ğŸ”§ å·¥å…·å‡½æ•°

### äº”è¡Œç”Ÿå…‹åˆ¤æ–­

```python
from src.bazi_core.calculator import BaziCoreCalculator

# ä½¿ç”¨å·²æœ‰çš„ element_relations
calculator = BaziCoreCalculator("1987-09-16", "05:00", "male")
relations = calculator.element_relations

# åˆ¤æ–­äº”è¡Œç”Ÿå…‹
def is_producing(element1, element2):
    """element1æ˜¯å¦ç”Ÿelement2"""
    return relations[element1]['produces'] == element2

def is_controlling(element1, element2):
    """element1æ˜¯å¦å…‹element2"""
    return relations[element1]['controls'] == element2
```

### å¤©å¹²åœ°æ”¯å…³ç³»åˆ¤æ–­

```python
from src.data.relations import *

def is_stem_he(stem1, stem2):
    """å¤©å¹²æ˜¯å¦ç›¸åˆ"""
    return STEM_HE.get(stem1) == stem2

def is_branch_chong(branch1, branch2):
    """åœ°æ”¯æ˜¯å¦ç›¸å†²"""
    return BRANCH_CHONG.get(branch1) == branch2

def is_branch_liuhe(branch1, branch2):
    """åœ°æ”¯æ˜¯å¦å…­åˆ"""
    return BRANCH_LIUHE.get(branch1) == branch2

def is_branch_xing(branch1, branch2):
    """åœ°æ”¯æ˜¯å¦ç›¸åˆ‘"""
    return branch2 in BRANCH_XING.get(branch1, [])
```

---

## ğŸš€ å¾®æœåŠ¡

### å·²æœ‰å¾®æœåŠ¡åˆ—è¡¨

| å¾®æœåŠ¡ | ç«¯å£ | åŠŸèƒ½ | å¤ç”¨åº¦ |
|--------|------|------|--------|
| **ä¸»æœåŠ¡** | 8000 | FastAPI REST API | â­â­â­â­â­ |
| **å…«å­—åˆ†ææœåŠ¡** | 50051 | gRPCå…«å­—è®¡ç®— | â­â­â­â­ |
| **è¿åŠ¿åˆ†ææœåŠ¡** | 50052 | gRPCè¿åŠ¿åˆ†æ | â­â­â­â­ |
| **è§„åˆ™æœåŠ¡** | 50053 | gRPCè§„åˆ™åŒ¹é… | â­â­â­â­ |
| **æ”¯ä»˜æœåŠ¡** | 50055 | gRPCæ”¯ä»˜ | â­â­ |
| **æ„å›¾è¯†åˆ«æœåŠ¡** | 9008 | gRPCæ„å›¾è¯†åˆ« | â­â­â­â­ |
| **Promptä¼˜åŒ–æœåŠ¡** | 9009 | gRPC Promptä¼˜åŒ– | â­â­ |

---

## ğŸ“ ä½¿ç”¨åŸåˆ™

### âœ… ä¼˜å…ˆå¤ç”¨ï¼ˆç»„è£…å‚æ€ç»´ï¼‰

1. **å¤©å¹²åœ°æ”¯å…³ç³»** â†’ ç”¨ `src/data/relations.py`
2. **äº”è¡Œç”Ÿå…‹** â†’ ç”¨ `ELEMENT_RELATIONS`
3. **åç¥è®¡ç®—** â†’ ç”¨ `WenZhenBazi.get_main_star()`
4. **å¤§è¿æµå¹´æ•°æ®** â†’ ç”¨ `BaziDetailService.calculate_detail_full()`
5. **å–œç¥å¿Œç¥** â†’ ç”¨ `WangShuaiAnalyzer.analyze()`
6. **è§„åˆ™åŒ¹é…** â†’ ç”¨ `RuleService.match_rules()`

### âŒ é¿å…é‡å¤å¼€å‘

ä¸è¦é‡æ–°å®ç°ï¼š
- âŒ å¤©å¹²åœ°æ”¯å…³ç³»åˆ¤æ–­
- âŒ äº”è¡Œç”Ÿå…‹é€»è¾‘
- âŒ åç¥è®¡ç®—é€»è¾‘
- âŒ å¤§è¿æµå¹´è®¡ç®—
- âŒ æ—ºè¡°å–œå¿Œåˆ¤æ–­

### ğŸ¯ æ–°åŠŸèƒ½å¼€å‘æµç¨‹

```
1. ğŸ“‹ éœ€æ±‚åˆ†æ
   â†“
2. ğŸ” ç›˜ç‚¹ç°æœ‰åŠŸèƒ½ï¼ˆæŸ¥æœ¬æ–‡æ¡£ï¼‰
   - æ˜¯å¦æœ‰å¯å¤ç”¨çš„æ¨¡å—ï¼Ÿ
   - æ˜¯å¦åªéœ€è¦ç»„è£…ï¼Ÿ
   â†“
3. ğŸ¯ è®¾è®¡æ–¹æ¡ˆ
   - æœ€å°æ”¹åŠ¨
   - æ¨¡å—åŒ–è®¾è®¡
   - å¾®æœåŠ¡æ€ç»´
   â†“
4. ğŸ’» å®ç°
   - å¤ç”¨ç°æœ‰æ¨¡å—
   - åªå¼€å‘ç¼ºå¤±éƒ¨åˆ†
   â†“
5. âœ… æµ‹è¯•éªŒè¯
```

---

## ğŸ”„ æ›´æ–°è®°å½•

| æ—¥æœŸ | æ›´æ–°å†…å®¹ | æ›´æ–°äºº |
|------|----------|--------|
| 2025-11-24 | åˆå§‹åˆ›å»ºï¼Œç›˜ç‚¹æ ¸å¿ƒæ¨¡å— | AI |
| 2025-11-24 | æ·»åŠ å–œç¥å¿Œç¥åŠŸèƒ½è¯´æ˜ | AI |
| 2025-11-24 | æ·»åŠ FortuneContextService | AI |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¼€å‘è§„èŒƒ](./DEVELOPMENT_GUIDELINES.md)
- [è§„åˆ™ç³»ç»Ÿæ¶æ„](./rule_system_architecture.md)
- [å¿«é€Ÿå¼€å§‹](./å¿«é€Ÿå¼€å§‹-å¼€å‘è€…å¿…è¯».md)
- [æ™ºèƒ½æ„å›¾è¯†åˆ«ç³»ç»Ÿ](./æ™ºèƒ½æ„å›¾è¯†åˆ«ç³»ç»Ÿ-å¼€å‘å®ŒæˆæŠ¥å‘Š.md)

