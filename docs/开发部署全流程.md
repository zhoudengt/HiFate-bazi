# HiFate-bazi 开发部署全流程

> 简单、快速、可靠的开发到生产流程

---

## 🔴 核心原则：零停机

**所有操作必须保证服务不中断！**

| 操作 | 零停机方案 |
|------|-----------|
| 热更新 | Python --reload 自动重载 |
| 版本发布 | Docker 滚动更新 |
| 功能增加 | 向后兼容，增量部署 |
| 数据库变更 | 只增字段，不删字段 |
| 规则更新 | 数据库 + 清 Redis 缓存 |

---

## 📋 流程概览

```
本地开发 → 热更新测试 → 提交代码 → 部署服务器
   ↓           ↓            ↓           ↓
 修改代码    即时生效     git push    自动/手动部署
```

---

## 1️⃣ 本地开发（热更新）

### 启动开发环境

```bash
# 方式一：Docker 热更新（推荐）
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

# 方式二：本地直接运行
./start.sh
```

### 热更新说明

| 文件类型 | 热更新 | 说明 |
|----------|--------|------|
| Python 代码 | ✅ 自动 | 修改后自动重载 |
| HTML/CSS/JS | ✅ 刷新即可 | 刷新浏览器生效 |
| 配置文件 | ❌ 需重启 | 修改后重启服务 |
| 数据库规则 | ✅ 清缓存 | 清 Redis 缓存即可 |

### 清理缓存（规则更新后）

```bash
# 清除所有规则缓存
redis-cli -p 16379 FLUSHDB

# 或清除特定规则
redis-cli -p 16379 DEL "rules:FORMULA_HEALTH"
```

---

## 2️⃣ 测试验证

### 本地测试

```bash
# API 测试
curl http://localhost:8001/api/v1/bazi/analyze \
  -d "year=1990&month=1&day=1&hour=12&gender=male"

# 前端测试
open http://localhost:8001/frontend/formula-analysis.html
```

### 检查服务状态

```bash
./scripts/services/check_services.sh
```

---

## 3️⃣ 代码提交

### 标准流程

```bash
# 1. 查看修改
git status
git diff

# 2. 添加文件
git add .

# 3. 提交（使用规范格式）
git commit -m "[类型] 简短描述

- 修改内容：xxx
- 测试情况：已通过"

# 4. 推送
git push origin master
```

### 提交类型

- `[新增]` - 新功能
- `[修复]` - Bug修复
- `[优化]` - 性能优化
- `[重构]` - 代码重构
- `[文档]` - 文档更新

---

## 4️⃣ 服务器部署（零停机）

### 方式一：一键部署（推荐）

```bash
./deploy.sh
# 选择 2: 打包上传 - 零停机
```

**零停机原理**：
```
1. 本地打包 → 上传到服务器
2. 解压到临时目录（服务继续运行）
3. rsync 增量同步文件
4. docker-compose up -d --build --force-recreate
   → Docker 先启动新容器，确认健康后停止旧容器
```

### 方式二：Git 拉取

```bash
./deploy.sh
# 选择 1: Git 拉取（需要服务器能访问 GitHub）
```

### ⚠️ 禁止操作

```bash
# ❌ 禁止先停再部署
docker-compose down  # 不要这样！
docker-compose up -d

# ✅ 正确方式（零停机）
docker-compose up -d --build --force-recreate
```

---

## 5️⃣ 服务器 Git 仓库方案（推荐）

### 为什么推荐这个方案？

| 对比 | GitHub 拉取 | 服务器 Git |
|------|------------|-----------|
| 网络依赖 | ❌ 依赖 GitHub | ✅ 不依赖外网 |
| 速度 | 慢（国际网络） | ✅ 快（局域网） |
| 可靠性 | 可能失败 | ✅ 100% 可靠 |
| 自动部署 | 需要 CI/CD | ✅ Git hook 自动触发 |

### 架构图

```
本地开发机                     服务器
┌──────────┐    git push     ┌────────────────────────────┐
│  代码    │ ──────────────→ │  /opt/git/hifate-bazi.git  │
│ 修改     │                 │      (Git 裸仓库)           │
└──────────┘                 └────────────┬───────────────┘
                                          │ post-receive hook
                                          │ 自动触发
                                          ↓
                             ┌────────────────────────────┐
                             │  /opt/HiFate-bazi          │
                             │    (生产代码目录)           │
                             │                            │
                             │  docker-compose up -d      │
                             │    (零停机重启)             │
                             └────────────────────────────┘
```

### 首次配置（一次性）

```bash
# 1. 初始化服务器 Git 仓库
./deploy.sh
# 选择 5: 初始化服务器 Git 仓库

# 2. 脚本会自动：
#    - 创建 /opt/git/hifate-bazi.git（裸仓库）
#    - 创建 /opt/HiFate-bazi（生产目录）
#    - 配置 post-receive hook（自动部署）
#    - 本地添加 remote: server
```

### 日常部署

```bash
# 方式一：使用部署脚本
./deploy.sh
# 选择 1: 服务器 Git 推送

# 方式二：直接 git push
git push server master
# hook 自动触发部署，零停机
```

### 手动配置（如果需要）

```bash
# 本地添加服务器 remote
git remote add server ssh://root@your-server/opt/git/hifate-bazi.git

# 推送
git push server master
```

---

## 6️⃣ 其他部署方案

### 方案 B：打包上传（备选）

```bash
./deploy.sh
# 选择 2: 打包上传 - 零停机
```

### 方案 C：GitHub 拉取（需要网络通畅）

```bash
./deploy.sh
# 选择 3: GitHub 拉取
```

### GitHub 拉不到代码的解决方案

1. **使用服务器 Git 方案**（推荐）
2. **使用打包上传方案**
3. **服务器设置代理**：
   ```bash
   git config --global http.proxy http://proxy:port
   ```
4. **使用 Gitee 镜像**：
   ```bash
   git remote add gitee https://gitee.com/your-username/HiFate-bazi.git
   git pull gitee master
   ```

---

## 🚀 一键部署脚本

### 创建快捷部署脚本

```bash
#!/bin/bash
# deploy.sh - 一键部署到服务器

SERVER="user@your-server"
REMOTE_PATH="/path/to/HiFate-bazi"

echo "📦 打包代码..."
tar -czvf /tmp/deploy.tar.gz \
  --exclude='.git' \
  --exclude='node_modules' \
  --exclude='logs' \
  --exclude='.venv' \
  --exclude='__pycache__' \
  .

echo "📤 上传到服务器..."
scp /tmp/deploy.tar.gz $SERVER:/tmp/

echo "🚀 部署中..."
ssh $SERVER << 'EOF'
cd /path/to/HiFate-bazi
docker-compose down
tar -xzvf /tmp/deploy.tar.gz
docker-compose up -d
rm /tmp/deploy.tar.gz
echo "✅ 部署完成！"
EOF

rm /tmp/deploy.tar.gz
echo "🎉 全部完成！"
```

---

## 📊 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│                        本地开发                              │
├─────────────────────────────────────────────────────────────┤
│  1. 修改代码                                                 │
│  2. 热更新自动生效 / 刷新浏览器                               │
│  3. 本地测试验证                                             │
└────────────────────────┬────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                        提交代码                              │
├─────────────────────────────────────────────────────────────┤
│  git add . && git commit -m "[类型] 描述" && git push        │
└────────────────────────┬────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                      服务器部署                              │
├─────────────────────────────────────────────────────────────┤
│  方式一：git pull（需要网络通畅）                             │
│  方式二：tar 打包上传（网络不通时）                           │
│  方式三：deploy_remote.sh 自动化                             │
└────────────────────────┬────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                      验证部署                                │
├─────────────────────────────────────────────────────────────┤
│  curl http://server:8001/api/v1/health                      │
│  查看日志：docker-compose logs -f web                        │
└─────────────────────────────────────────────────────────────┘
```

---

## ⚡ 快速命令参考

| 操作 | 命令 |
|------|------|
| **本地开发** | |
| 启动服务 | `./start.sh` |
| 停止服务 | `./stop.sh` |
| 查看状态 | `./scripts/services/check_services.sh` |
| 清除缓存 | `redis-cli -p 16379 FLUSHDB` |
| **代码提交** | |
| 提交代码 | `git add . && git commit -m "[类型] 描述"` |
| 推送 GitHub | `git push origin master` |
| **部署（推荐）** | |
| 部署到服务器 | `git push server master` |
| 或使用脚本 | `./deploy.sh` → 选择 1 |
| **首次配置** | |
| 初始化服务器 Git | `./deploy.sh` → 选择 5 |
| **服务器操作** | |
| 查看日志 | `ssh server "cd /opt/HiFate-bazi && docker-compose logs -f"` |
| 重启服务 | `./deploy.sh` → 选择 4 |

---

## 🔧 常见问题

### Q: 热更新不生效？
A: 检查是否使用了 `docker-compose.dev.yml`，确保 volume 挂载正确

### Q: 规则更新后不生效？
A: 清除 Redis 缓存：`redis-cli -p 16379 FLUSHDB`

### Q: 服务器拉不到代码？
A: 使用服务器 Git 方案，不依赖 GitHub

### Q: 部署后服务异常？
A: 查看日志：`ssh server "tail -f /var/log/hifate-deploy.log"`

### Q: 部署失败自动回滚了？
A: 查看日志找原因，修复后重新 `git push server master`

---

## 🏆 推荐方案总结

**日常部署（最简单）**：
```bash
git push server master
```

**特点**：
- ✅ 不依赖 GitHub
- ✅ 零停机
- ✅ 自动健康检查
- ✅ 失败自动回滚
- ✅ 完整部署日志

