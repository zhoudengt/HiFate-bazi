# 婚姻分析大模型配置与流程说明

## 📋 目录

1. [大模型配置位置](#大模型配置位置)
2. [Bot ID 配置说明](#bot-id-配置说明)
3. [整体代码流程](#整体代码流程)
4. [调用的大模型](#调用的大模型)
5. [问题排查](#问题排查)

---

## 🔧 大模型配置位置

### 配置文件位置

**主配置文件**：`config/services.env`

```bash
# Coze API 配置
export COZE_ACCESS_TOKEN="pat_PtzrONUsEpMKhUb9mDc5nhyYwBWylvDgpgaFPd8TzM1gWRJZauIxtuUf147OnIde"
export COZE_BOT_ID="7573909067308695606"  # 默认 Bot ID

# 专用 Bot ID 配置
export MARRIAGE_ANALYSIS_BOT_ID="7587253915310096384"  # 感情婚姻分析专用
export INTENT_BOT_ID="7576140933906284571"  # 意图识别专家
export FORTUNE_ANALYSIS_BOT_ID="7576211240901509174"  # 命理分析专家
export DAILY_FORTUNE_ACTION_BOT_ID="7584766797639958555"  # 每日运势行动建议
export XISHEN_JISHEN_BOT_ID="7585861629750181926"  # 喜神忌神AI分析
```

**模板文件**：`env.template`

包含所有可用的环境变量模板。

---

## 🤖 Bot ID 配置说明

### Bot ID 优先级

在 `server/api/v1/marriage_analysis.py` 中，Bot ID 的优先级如下：

```python
# 优先级顺序：
1. 请求参数中的 bot_id（如果有）
2. 环境变量 MARRIAGE_ANALYSIS_BOT_ID
3. 环境变量 COZE_BOT_ID（默认 Bot ID）
```

### 配置缺失问题

**问题**：`bot_id 7587253915310096384` 没有在 `config/services.env` 中配置

**原因**：
- `env.template` 中有配置：`MARRIAGE_ANALYSIS_BOT_ID=7587253915310096384`
- 但 `config/services.env` 中缺少这个配置
- 代码会 fallback 到 `COZE_BOT_ID` (7573909067308695606)

**解决方案**：
✅ 已在 `config/services.env` 中添加：
```bash
export MARRIAGE_ANALYSIS_BOT_ID="7587253915310096384"
```

---

## 🔄 整体代码流程

### 流程图

```
用户请求
    ↓
[前端] marriage-analysis.html
    ├─ 用户填写：出生日期、出生时间、性别
    └─ 点击"开始分析"按钮
    ↓
[前端JS] marriage-analysis.js
    ├─ 表单验证（三个参数必须填写）
    ├─ 发送POST请求到 /api/v1/bazi/marriage-analysis/stream
    └─ 接收SSE流式响应
    ↓
[后端API] server/api/v1/marriage_analysis.py
    ├─ 1. 确定 Bot ID（优先级：参数 > MARRIAGE_ANALYSIS_BOT_ID > COZE_BOT_ID）
    ├─ 2. 处理输入（农历转换、时区转换）
    ├─ 3. 并行获取数据：
    │   ├─ 八字排盘（BaziService.calculate_bazi_full）
    │   └─ 旺衰分析（WangShuaiService.calculate_wangshuai）
    ├─ 4. 规则匹配（婚姻规则 + 桃花规则）
    ├─ 5. 格式化输入数据（JSON格式，包含所有分析数据）
    ├─ 6. 调用 Coze 流式服务（CozeStreamService.stream_custom_analysis）
    └─ 7. 返回SSE流式响应
    ↓
[Coze服务] server/services/coze_stream_service.py
    ├─ 1. 构建API请求（bot_id, prompt, stream=True）
    ├─ 2. 调用 Coze API：POST https://api.coze.cn/open_api/v2/chat
    ├─ 3. 流式读取响应（iter_lines()）
    ├─ 4. 解析SSE格式数据（data: {...}）
    ├─ 5. 提取内容（_extract_content_from_response）
    ├─ 6. 过滤提示词和指令（_is_prompt_or_instruction）
    └─ 7. 返回流式数据（type: progress/complete/error）
    ↓
[外部API] Coze Platform（https://api.coze.cn）
    ├─ Bot ID: 7587253915310096384（婚姻分析专用Bot）
    ├─ 接收JSON格式的prompt（包含八字、规则、用户信息等）
    ├─ 使用大模型生成分析内容（流式输出）
    └─ 返回SSE格式的流式响应
    ↓
[前端] 实时显示分析结果
    ├─ 解析SSE数据（data: {"type": "progress", "content": "..."}）
    ├─ 更新UI（逐字显示内容）
    └─ 显示最终结果
```

### 关键代码位置

#### 1. 前端入口

**文件**：`local_frontend/marriage-analysis.html`
- 表单界面
- 调用 `marriage-analysis.js`

**文件**：`local_frontend/js/marriage-analysis.js`
- 表单验证
- 发送API请求
- 处理SSE流式响应

#### 2. 后端API

**文件**：`server/api/v1/marriage_analysis.py`

**关键函数**：
- `marriage_analysis_stream_generator()` - 流式生成器函数
- Bot ID 确定逻辑（第55-67行）
- 数据获取和格式化（第69-313行）
- Coze服务调用（第315-347行）

#### 3. Coze流式服务

**文件**：`server/services/coze_stream_service.py`

**关键类和方法**：
- `CozeStreamService` - Coze流式服务类
- `stream_custom_analysis()` - 流式生成自定义分析（第262行）
- `_extract_content_from_response()` - 提取响应内容（第448行）
- `_is_prompt_or_instruction()` - 过滤提示词和指令（第510行）

---

## 🤖 调用的大模型

### 大模型平台

**平台**：Coze（https://www.coze.cn/）

**API地址**：`https://api.coze.cn/open_api/v2/chat`

### Bot配置

**Bot ID**：`7587253915310096384`

**Bot名称**：八字命理-感情婚姻分析专用Bot

**Bot职责**：
- 接收结构化的八字数据（JSON格式）
- 分析感情婚姻相关规则匹配结果
- 生成个性化的婚姻分析报告
- 流式输出分析内容

### Bot输入格式（Prompt）

Bot接收的prompt是一个JSON字符串，包含：

```json
{
  "basic_info": {
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "lunar_date": {...}
  },
  "bazi_pillars": {
    "year": {...},
    "month": {...},
    "day": {...},
    "hour": {...}
  },
  "ten_gods_stats": {...},
  "elements": {...},
  "element_counts": {...},
  "matched_rules": {
    "marriage": [...],  // 婚姻规则
    "peach_blossom": [...]  // 桃花规则
  },
  "wangshuai": {...}
}
```

### Bot输出格式

**流式输出（SSE格式）**：

```
data: {"msg_type": "answer", "content": "根据您的八字..."}
data: {"msg_type": "answer", "content": "命盘总论："}
data: {"msg_type": "answer", "content": "您的八字显示..."}
...
data: [DONE]
```

### API调用详情

**请求方式**：POST

**请求头**：
```http
Authorization: Bearer {COZE_ACCESS_TOKEN}
Content-Type: application/json
```

**请求体**：
```json
{
  "bot_id": "7587253915310096384",
  "user": "wuxing_analysis",
  "query": "{JSON格式的prompt}",
  "stream": true
}
```

**响应格式**：SSE（Server-Sent Events）

**超时设置**：60秒

---

## 🔍 问题排查

### 常见问题

#### 1. Bot ID未配置

**症状**：
- API返回错误："Coze Bot ID 配置缺失"
- 使用默认 Bot ID，分析结果不准确

**解决**：
1. 检查 `config/services.env` 中是否有 `MARRIAGE_ANALYSIS_BOT_ID`
2. 如果没有，添加：`export MARRIAGE_ANALYSIS_BOT_ID="7587253915310096384"`
3. 重启服务或触发热更新

#### 2. 流式响应很慢

**症状**：
- 页面显示"正在生成..."很长时间
- 10秒只收到很少的数据

**原因**：
- Coze API 流式输出本身较慢（每个chunk很小）
- 外部API延迟
- Bot处理时间较长

**解决**：
- ✅ 这是正常现象，流式输出已经是最优方案
- ✅ 前端已添加进度显示，用户可以看到实时进度
- ✅ 后端已做性能优化（并行计算、合并查询）

#### 3. "对不起,我无法回答这个问题"

**症状**：
- Bot返回默认错误响应
- 部分内容显示错误信息

**原因**：
- Bot配置或提示词有问题
- Bot无法理解输入数据格式

**解决**：
1. 检查Bot在Coze平台的配置
2. 检查提示词是否正确
3. 检查输入数据格式是否符合Bot期望

#### 4. API认证失败

**症状**：
- HTTP 401 或 403 错误
- "认证失败"错误信息

**解决**：
1. 检查 `COZE_ACCESS_TOKEN` 是否正确
2. 检查Token是否过期
3. 检查Token格式（应该以 `pat_` 开头）

### 调试方法

#### 1. 检查环境变量

```bash
# 检查当前环境变量
env | grep COZE
env | grep MARRIAGE
```

#### 2. 测试API直接调用

```bash
# 测试Coze API
curl -X POST https://api.coze.cn/open_api/v2/chat \
  -H "Authorization: Bearer {COZE_ACCESS_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "bot_id": "7587253915310096384",
    "user": "test",
    "query": "测试",
    "stream": true
  }'
```

#### 3. 查看后端日志

```bash
# 查看服务日志
tail -f logs/server_8001.log | grep -i "marriage\|coze\|bot"
```

#### 4. 检查Bot ID使用情况

在代码中添加日志：
```python
logger.info(f"使用 Bot ID: {bot_id}")
logger.info(f"实际使用的 Bot ID: {actual_bot_id}")
```

---

## 📝 总结

### 配置要点

1. ✅ **Bot ID配置**：`MARRIAGE_ANALYSIS_BOT_ID=7587253915310096384`
2. ✅ **Access Token配置**：`COZE_ACCESS_TOKEN=pat_...`
3. ✅ **优先级**：参数 > 专用Bot ID > 默认Bot ID

### 流程要点

1. ✅ **前端**：表单验证 → 发送请求 → 接收SSE流
2. ✅ **后端**：确定Bot ID → 获取数据 → 格式化 → 调用Coze
3. ✅ **Coze服务**：构建请求 → 调用API → 流式读取 → 解析响应
4. ✅ **大模型**：接收prompt → 生成分析 → 流式输出

### 性能优化

1. ✅ **后端**：并行计算八字和旺衰、合并规则查询
2. ✅ **前端**：表单验证、进度显示
3. ✅ **流式输出**：实时显示，提升用户体验

---

**最后更新**：2025-01-XX
**维护者**：开发团队

