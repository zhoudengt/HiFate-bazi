# æµ‹è¯•è„šæœ¬è™šæ‹Ÿç¯å¢ƒä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

**é—®é¢˜ç°è±¡**ï¼š
è¿è¡Œæµ‹è¯•è„šæœ¬æ—¶å‡ºç° `ModuleNotFoundError: No module named 'grpc'` é”™è¯¯ã€‚

**æ ¹æœ¬åŸå› **ï¼š
æµ‹è¯•è„šæœ¬ç›´æ¥ä½¿ç”¨ç³»ç»Ÿ `python3` æ‰§è¡Œï¼Œæ²¡æœ‰è‡ªåŠ¨åŠ è½½è™šæ‹Ÿç¯å¢ƒï¼ˆ`.venv`ï¼‰ä¸­çš„ä¾èµ–åŒ…ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºé€šç”¨æµ‹è¯•å·¥å…·å‡½æ•°

åˆ›å»ºäº† `scripts/tools/test_utils.py`ï¼ŒåŒ…å« `setup_test_environment()` å‡½æ•°ï¼š

```python
def setup_test_environment():
    """
    è®¾ç½®æµ‹è¯•ç¯å¢ƒ
    1. æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° sys.path
    2. è‡ªåŠ¨æ‰©å±•è™šæ‹Ÿç¯å¢ƒçš„ site-packagesï¼ˆå‚è€ƒ server/start.pyï¼‰
    """
    # è·å–é¡¹ç›®æ ¹ç›®å½•
    script_dir = Path(__file__).resolve().parent
    project_root = script_dir.parent.parent
    
    # æ·»åŠ é¡¹ç›®æ ¹ç›®å½•
    if str(project_root) not in sys.path:
        sys.path.insert(0, str(project_root))
    
    # æ‰©å±•è™šæ‹Ÿç¯å¢ƒè·¯å¾„
    _extend_sys_path_with_site_packages(project_root)
    
    return project_root
```

### 2. ä¿®æ”¹æ‰€æœ‰æµ‹è¯•è„šæœ¬

å·²ä¿®æ”¹ä»¥ä¸‹æµ‹è¯•è„šæœ¬ï¼Œåœ¨å¯¼å…¥é¡¹ç›®æ¨¡å—ä¹‹å‰è°ƒç”¨ `setup_test_environment()`ï¼š

- âœ… `scripts/tools/test_smart_fortune_direct.py`
- âœ… `scripts/tools/test_model_tuning_service.py`
- âœ… `scripts/tools/test_intent_performance.py`
- âœ… `scripts/tools/test_smart_fortune_performance.py`
- âœ… `scripts/tools/test_coze_api_direct.py`
- âœ… `scripts/tools/test_smart_fortune_api.py`
- âœ… `scripts/tools/test_smart_fortune_llm.py`
- âœ… `scripts/tools/check_fortune_llm_config.py`
- âœ… `scripts/tools/analyze_performance_bottlenecks.py`
- âœ… `scripts/tools/generate_api_docs.py`

**ä¿®æ”¹æ–¹å¼**ï¼š
```python
# æ—§ä»£ç 
import sys
import os
project_root = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, project_root)

# æ–°ä»£ç 
import sys
import os
# â­ è®¾ç½®æµ‹è¯•ç¯å¢ƒï¼ˆè‡ªåŠ¨æ‰©å±•è™šæ‹Ÿç¯å¢ƒè·¯å¾„ï¼‰
from test_utils import setup_test_environment
project_root = setup_test_environment()
```

## ğŸ¯ æ•ˆæœ

ä¿®æ”¹åï¼Œæµ‹è¯•è„šæœ¬å¯ä»¥ï¼š
1. âœ… è‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒï¼ˆ`.venv`ï¼‰
2. âœ… å³ä½¿æœªæ¿€æ´»è™šæ‹Ÿç¯å¢ƒä¹Ÿèƒ½æ­£å¸¸è¿è¡Œ
3. âœ… æ­£ç¡®åŠ è½½æ‰€æœ‰ä¾èµ–åŒ…ï¼ˆåŒ…æ‹¬ `grpc`ã€`fastapi` ç­‰ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

### å¦‚æœä»ç„¶å‡ºç° grpc æ¨¡å—é”™è¯¯

å¦‚æœä¿®æ”¹åä»ç„¶å‡ºç° `ImportError: cannot import name 'cygrpc'` ç­‰é”™è¯¯ï¼Œè¯´æ˜è™šæ‹Ÿç¯å¢ƒä¸­çš„ `grpc` æ¨¡å—å®‰è£…ä¸å®Œæ•´ã€‚

**è§£å†³æ–¹æ³•**ï¼š

```bash
# 1. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# 2. é‡æ–°å®‰è£… grpc ç›¸å…³åŒ…
pip uninstall grpcio grpcio-tools -y
pip install grpcio==1.60.0 grpcio-tools==1.60.0

# 3. éªŒè¯å®‰è£…
python3 -c "import grpc; print('âœ… grpc æ¨¡å—åŠ è½½æˆåŠŸ')"
```

### æµ‹è¯•è„šæœ¬ä½¿ç”¨æ–¹å¼

**æ–¹å¼1ï¼šç›´æ¥è¿è¡Œï¼ˆæ¨èï¼‰**
```bash
# è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ
python3 scripts/tools/test_intent_performance.py
```

**æ–¹å¼2ï¼šæ¿€æ´»è™šæ‹Ÿç¯å¢ƒåè¿è¡Œ**
```bash
source .venv/bin/activate
python3 scripts/tools/test_intent_performance.py
```

**æ–¹å¼3ï¼šä½¿ç”¨è™šæ‹Ÿç¯å¢ƒçš„ Python**
```bash
.venv/bin/python3 scripts/tools/test_intent_performance.py
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `scripts/tools/test_utils.py` - æµ‹è¯•å·¥å…·å‡½æ•°
- `server/start.py` - å‚è€ƒå®ç°ï¼ˆ`_extend_sys_path_with_site_packages` å‡½æ•°ï¼‰

## ğŸ”„ æœªæ¥å¼€å‘è§„èŒƒ

**æ–°å¢æµ‹è¯•è„šæœ¬æ—¶**ï¼š
1. å¿…é¡»åœ¨å¯¼å…¥é¡¹ç›®æ¨¡å—ä¹‹å‰è°ƒç”¨ `setup_test_environment()`
2. ä½¿ç”¨ç»Ÿä¸€çš„è·¯å¾„è®¾ç½®æ–¹å¼ï¼Œç¡®ä¿è™šæ‹Ÿç¯å¢ƒä¾èµ–å¯ç”¨

**ç¤ºä¾‹æ¨¡æ¿**ï¼š
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ‹è¯•è„šæœ¬æè¿°
"""
import sys
import os

# â­ è®¾ç½®æµ‹è¯•ç¯å¢ƒï¼ˆè‡ªåŠ¨æ‰©å±•è™šæ‹Ÿç¯å¢ƒè·¯å¾„ï¼‰
from test_utils import setup_test_environment
project_root = setup_test_environment()

# ç°åœ¨å¯ä»¥å®‰å…¨å¯¼å…¥é¡¹ç›®æ¨¡å—
from server.services.xxx import XxxService
```

---

**ä¿®æ”¹æ—¥æœŸ**ï¼š2025-12-02  
**ä¿®æ”¹åŸå› **ï¼šè§£å†³æµ‹è¯•è„šæœ¬æ— æ³•æ‰¾åˆ°è™šæ‹Ÿç¯å¢ƒä¸­ä¾èµ–åŒ…çš„é—®é¢˜

