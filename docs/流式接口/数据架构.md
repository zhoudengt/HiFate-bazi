# 流式接口数据架构

## 数据流转

```
用户请求 → BaziDataOrchestrator → 底层计算 → input_data → LLM → 流式响应
```

## 分层设计

| 层级 | 组件 | 职责 |
|------|------|------|
| API层 | `server/api/v1/*.py` | 路由、请求处理 |
| 数据格式化 | 各接口的 `build_xxx_input_data()` | 构建LLM输入 |
| 数据编排 | `BaziDataOrchestrator` | 统一获取数据 |
| 底层计算 | `BaziService`, `DetailService` | 八字计算 |

## 数据结构

### 底层输出（详细）

```json
{
  "dayun_sequence": [{
    "step": 1,
    "liunians": [{
      "year": 2026,
      "relations": [{"type": "岁运并临"}],
      "liuyue_sequence": [...],  // 冗余
      "liuri_sequence": [...]    // 冗余
    }]
  }]
}
```

### input_data（简化）

```json
{
  "dayun_liunian": {
    "current_dayun": {
      "step": 5,
      "ganzhi": "戊辰",
      "liunians": [{
        "year": 2026,
        "relations": [{"type": "岁运并临"}]
      }]
    }
  }
}
```

## 关键字段

### relations（特殊关系）

每个流年必须包含 `relations` 字段：

```json
{
  "year": 2026,
  "relations": [
    {"type": "岁运并临", "description": "流年与大运干支相同"},
    {"type": "天克地冲", "description": "流年与日柱天克地冲"}
  ]
}
```

关系类型：
- 岁运并临
- 天克地冲（日柱/月柱）
- 天合地合（日柱/月柱）
