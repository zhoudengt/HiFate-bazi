# ç»Ÿä¸€æ•°æ®æºæ¶æ„è®¾è®¡

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜æµå¼æ¥å£çš„ç»Ÿä¸€æ•°æ®æºæ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬æ•°æ®è·å–ã€ç¼–æ’ã€éªŒè¯ç­‰æ ¸å¿ƒæœºåˆ¶ã€‚

**æœ€åæ›´æ–°**ï¼š2026-01-16

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

### æ ¸å¿ƒç›®æ ‡

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šæ‰€æœ‰æµå¼æ¥å£ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®æºï¼Œç¡®ä¿æ•°æ®å®Œå…¨ä¸€è‡´
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ”¯æŒå¹¶è¡Œè·å–ã€ç¼“å­˜æœºåˆ¶ï¼Œå‡å°‘é‡å¤è®¡ç®—
3. **å¯ç»´æŠ¤æ€§**ï¼šç»Ÿä¸€çš„æ•°æ®è·å–é€»è¾‘ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
4. **å‘åå…¼å®¹**ï¼šä¸ä¿®æ”¹åº•å±‚æœåŠ¡ï¼Œåªè¯»è°ƒç”¨ï¼Œç¡®ä¿ç¨³å®šæ€§

### è®¾è®¡åŸåˆ™

- âœ… **å•ä¸€æ•°æ®æº**ï¼šæ‰€æœ‰æµå¼æ¥å£ä»ç»Ÿä¸€çš„æ•°æ®æœåŠ¡è·å–æ•°æ®
- âœ… **åªè¯»è°ƒç”¨**ï¼šä¸ä¿®æ”¹ä»»ä½•åº•å±‚æœåŠ¡ï¼Œç¡®ä¿æ•°æ®æºç¨³å®šæ€§
- âœ… **å¹¶è¡Œè·å–**ï¼šæ”¯æŒå¼‚æ­¥å¹¶è¡Œè·å–å¤šä¸ªæ•°æ®æ¨¡å—ï¼Œæå‡æ€§èƒ½
- âœ… **ç¼“å­˜ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®—
- âœ… **æ•°æ®éªŒè¯**ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§

---

## ğŸ—ï¸ æ¶æ„å±‚æ¬¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æµå¼æ¥å£å±‚                              â”‚
â”‚  (career_wealth_analysis.py, health_analysis.py, ...)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®ç¼–æ’å±‚ (BaziDataOrchestrator)           â”‚
â”‚  - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ•°æ®æ¨¡å—çš„è·å–é€»è¾‘                        â”‚
â”‚  - æ”¯æŒå¹¶è¡Œè®¡ç®—ã€ä¾èµ–è§£æã€é”™è¯¯å¤„ç†                      â”‚
â”‚  - æ”¯æŒå¤§è¿æ¨¡å¼ç­›é€‰                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç»Ÿä¸€æ•°æ®æœåŠ¡å±‚ (BaziDataService)                  â”‚
â”‚  - ç»Ÿä¸€ç®¡ç†å¤§è¿æµå¹´ã€ç‰¹æ®Šæµå¹´æ•°æ®çš„è·å–                  â”‚
â”‚  - æ”¯æŒ7ä¸ªæ ‡å‡†å‚æ•°ï¼ˆæ—¥æœŸã€æ—¶é—´ã€æ€§åˆ«ã€å†æ³•ã€åœ°ç‚¹ç­‰ï¼‰     â”‚
â”‚  - æ”¯æŒå¤šç§å¤§è¿æ¨¡å¼ï¼ˆcurrent, current_with_neighborsç­‰ï¼‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ç»Ÿä¸€æ•°æ®æä¾›è€… (UnifiedBaziDataProvider)           â”‚
â”‚  - ä»¥æ’ç›˜æ¥å£ä¸ºå‡†ï¼ˆBaziDisplayServiceï¼‰                  â”‚
â”‚  - æ‰€æœ‰æ•°æ®ä¸€æ¬¡è·å–ï¼Œç»Ÿä¸€ç»“æ„                            â”‚
â”‚  - ç‰¹æ®Šå¹´ä»½ç›´æ¥ä»æ’ç›˜é€ä¼ ï¼Œä¸åšä»»ä½•è®¡ç®—æˆ–è¿‡æ»¤            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ’ç›˜æœåŠ¡     â”‚ â”‚ æ—ºè¡°æœåŠ¡  â”‚ â”‚ è¯¦ç»†æœåŠ¡  â”‚
â”‚ BaziDisplay â”‚ â”‚ WangShuai â”‚ â”‚ BaziDetailâ”‚
â”‚ Service     â”‚ â”‚ Service   â”‚ â”‚ Service  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶è¯´æ˜

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|----------|------|
| **BaziDataOrchestrator** | `server/services/bazi_data_orchestrator.py` | æ•°æ®ç¼–æ’æœåŠ¡ï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ•°æ®æ¨¡å—çš„è·å–é€»è¾‘ |
| **BaziDataService** | `server/services/bazi_data_service.py` | ç»Ÿä¸€æ•°æ®æœåŠ¡ï¼Œç®¡ç†å¤§è¿æµå¹´ã€ç‰¹æ®Šæµå¹´æ•°æ®çš„è·å– |
| **UnifiedBaziDataProvider** | `server/services/unified_bazi_data_provider.py` | ç»Ÿä¸€æ•°æ®æä¾›è€…ï¼Œä»¥æ’ç›˜æ¥å£ä¸ºå‡†ï¼Œæ‰€æœ‰æ•°æ®ä¸€æ¬¡è·å– |

---

## ğŸ“Š æ•°æ®æµè½¬

### æ•°æ®è·å–æµç¨‹

```
1. æµå¼æ¥å£æ¥æ”¶è¯·æ±‚
   â†“
2. BaziDataOrchestrator.fetch_data()
   - å¤„ç†å†œå†è¾“å…¥å’Œæ—¶åŒºè½¬æ¢
   - æ ¹æ® modules é…ç½®è·å–æ•°æ®
   - æ”¯æŒå¹¶è¡Œè·å–ï¼ˆparallel=Trueï¼‰
   - æ”¯æŒç¼“å­˜ï¼ˆuse_cache=Trueï¼‰
   â†“
3. BaziDataService.get_fortune_data()
   - è·å–å¤§è¿åºåˆ—ï¼ˆæ ¹æ® dayun_mode ç­›é€‰ï¼‰
   - è·å–æµå¹´åºåˆ—ï¼ˆæ ¹æ® target_years ç­›é€‰ï¼‰
   - è·å–ç‰¹æ®Šæµå¹´ï¼ˆåŒ…å« relations å­—æ®µï¼‰
   â†“
4. UnifiedBaziDataProvider.get_unified_data()
   - å¹¶è¡Œè°ƒç”¨ä¸‰ä¸ªæœåŠ¡ï¼š
     * BaziDisplayService.get_fortune_display() - æ’ç›˜æ•°æ®
     * WangShuaiService.calculate_wangshuai() - æ—ºè¡°æ•°æ®
     * BaziDetailService.calculate_detail_full() - è¯¦ç»†æ•°æ®
   â†“
5. æ•°æ®éªŒè¯å’Œè½¬æ¢
   - éªŒè¯æ•°æ®å®Œæ•´æ€§
   - è½¬æ¢ä¸ºç»Ÿä¸€çš„æ•°æ®ç»“æ„
   - ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
   â†“
6. è¿”å›ç»Ÿä¸€çš„æ•°æ®ç»“æ„
```

### æ•°æ®æ¨¡å‹

#### BaziDetailModelï¼ˆç»Ÿä¸€æ•°æ®æ¨¡å‹ï¼‰

```python
class BaziDetailModel(BaseModel):
    """å®Œæ•´å…«å­—è¯¦ç»†æ•°æ®æ¨¡å‹"""
    # åŸºç¡€å…«å­—æ•°æ®
    basic_info: Optional[Dict[str, Any]]
    bazi_pillars: Optional[Dict[str, Any]]
    ten_gods_stats: Optional[Dict[str, Any]]
    elements: Optional[Dict[str, Any]]
    element_counts: Optional[Dict[str, Any]]
    relationships: Optional[Dict[str, Any]]
    
    # å¤§è¿æµå¹´æ•°æ®
    dayun_sequence: List[DayunModel]  # å¤§è¿åºåˆ—
    liunian_sequence: List[LiunianModel]  # æµå¹´åºåˆ—
    special_liunians: List[SpecialLiunianModel]  # ç‰¹æ®Šæµå¹´åˆ—è¡¨
    
    # å½“å‰å¤§è¿æµå¹´ä¿¡æ¯
    current_dayun: Optional[DayunModel]
    current_liunian: Optional[LiunianModel]
    
    # èµ·è¿äº¤è¿ä¿¡æ¯
    qiyun: Optional[Dict[str, Any]]
    jiaoyun: Optional[Dict[str, Any]]
    
    # è¯¦ç»†ä¿¡æ¯ï¼ˆåŸå§‹æ•°æ®ï¼‰
    details: Optional[Dict[str, Any]]
```

#### DayunModelï¼ˆå¤§è¿æ¨¡å‹ï¼‰

```python
class DayunModel(BaseModel):
    """å¤§è¿æ•°æ®æ¨¡å‹"""
    step: int  # å¤§è¿æ­¥éª¤ï¼ˆä»0å¼€å§‹ï¼‰
    stem: str  # å¤©å¹²
    branch: str  # åœ°æ”¯
    ganzhi: str  # å¹²æ”¯ï¼ˆå¿…å¡«å­—æ®µï¼‰
    year_start: Optional[int]  # èµ·å§‹å¹´ä»½
    year_end: Optional[int]  # ç»“æŸå¹´ä»½
    age_range: Optional[Dict[str, int]]  # å¹´é¾„èŒƒå›´
    age_display: Optional[str]  # å¹´é¾„æ˜¾ç¤º
    nayin: Optional[str]  # çº³éŸ³
    main_star: Optional[str]  # ä¸»æ˜Ÿ
    hidden_stems: Optional[List[str]]  # è—å¹²åˆ—è¡¨
    hidden_stars: Optional[List[str]]  # å‰¯æ˜Ÿåˆ—è¡¨
    star_fortune: Optional[str]  # åäºŒé•¿ç”Ÿ
    self_sitting: Optional[str]  # è‡ªå
    kongwang: Optional[str]  # ç©ºäº¡
    deities: Optional[List[str]]  # ç¥ç…åˆ—è¡¨
    details: Optional[Dict[str, Any]]  # è¯¦ç»†ä¿¡æ¯
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. ç»Ÿä¸€æ•°æ®è·å–ï¼ˆBaziDataOrchestratorï¼‰

#### åŠŸèƒ½ç‰¹ç‚¹

- âœ… **æ¨¡å—åŒ–é…ç½®**ï¼šé€šè¿‡ `modules` å­—å…¸é…ç½®éœ€è¦è·å–çš„æ•°æ®æ¨¡å—
- âœ… **å¹¶è¡Œè·å–**ï¼šæ”¯æŒå¼‚æ­¥å¹¶è¡Œè·å–å¤šä¸ªæ•°æ®æ¨¡å—ï¼Œæå‡æ€§èƒ½
- âœ… **ç¼“å­˜æœºåˆ¶**ï¼šä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®—
- âœ… **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®è·å–çš„ç¨³å®šæ€§

#### ä½¿ç”¨ç¤ºä¾‹

```python
from server.services.bazi_data_orchestrator import BaziDataOrchestrator

# é…ç½®éœ€è¦è·å–çš„æ•°æ®æ¨¡å—
modules = {
    'bazi': True,        # å…«å­—åŸºç¡€æ•°æ®
    'wangshuai': True,   # æ—ºè¡°åˆ†æ
    'detail': True       # è¯¦ç»†æ•°æ®
}

# è·å–ç»Ÿä¸€æ•°æ®
unified_data = await BaziDataOrchestrator.fetch_data(
    solar_date="1990-01-15",
    solar_time="12:00",
    gender="male",
    modules=modules,
    use_cache=True,      # ä½¿ç”¨ç¼“å­˜
    parallel=True,       # å¹¶è¡Œè·å–
    calendar_type="solar",
    location=None,
    latitude=None,
    longitude=None
)

# æå–æ•°æ®
bazi_data = unified_data.get('bazi', {})
wangshuai_result = unified_data.get('wangshuai', {})
detail_result = unified_data.get('detail', {})
```

### 2. å¤§è¿æµå¹´æ•°æ®æœåŠ¡ï¼ˆBaziDataServiceï¼‰

#### åŠŸèƒ½ç‰¹ç‚¹

- âœ… **7ä¸ªæ ‡å‡†å‚æ•°**ï¼šæ”¯æŒæ—¥æœŸã€æ—¶é—´ã€æ€§åˆ«ã€å†æ³•ã€åœ°ç‚¹ã€ç»çº¬åº¦ç­‰æ ‡å‡†å‚æ•°
- âœ… **å¤šç§å¤§è¿æ¨¡å¼**ï¼šæ”¯æŒ `current`ã€`current_with_neighbors`ã€`count`ã€`indices` ç­‰æ¨¡å¼
- âœ… **ç»Ÿä¸€å¹´ä»½èŒƒå›´**ï¼šæ”¯æŒ `target_years` é…ç½®ï¼Œç»Ÿä¸€æŸ¥è¯¢æœªæ¥Nå¹´
- âœ… **ç‰¹æ®Šæµå¹´æ”¯æŒ**ï¼šè‡ªåŠ¨è·å–ç‰¹æ®Šæµå¹´ï¼ŒåŒ…å« `relations` å­—æ®µ

#### å¤§è¿æ¨¡å¼è¯´æ˜

| æ¨¡å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `current` | ä»…å½“å‰å¤§è¿ | è¿”å›å½“å‰æ­£åœ¨è¿è¡Œçš„å¤§è¿ |
| `current_with_neighbors` | å½“å‰å¤§è¿åŠå‰åå„ä¸€ä¸ª | è¿”å›3ä¸ªå¤§è¿ï¼ˆå‰ä¸€ä¸ªã€å½“å‰ã€åä¸€ä¸ªï¼‰ |
| `count` | å‰Nä¸ªå¤§è¿ | è¿”å›å‰8ä¸ªå¤§è¿ï¼ˆé»˜è®¤ï¼‰ |
| `indices` | æŒ‡å®šç´¢å¼•çš„å¤§è¿ | è¿”å›æŒ‡å®šç´¢å¼•çš„å¤§è¿ï¼ˆå¦‚[1,2,3]ï¼‰ |

#### ä½¿ç”¨ç¤ºä¾‹

```python
from server.services.bazi_data_service import BaziDataService

# è·å–å®Œæ•´è¿åŠ¿æ•°æ®
fortune_data = await BaziDataService.get_fortune_data(
    solar_date="1990-01-15",
    solar_time="12:00",
    gender="male",
    calendar_type="solar",
    location=None,
    latitude=None,
    longitude=None,
    include_dayun=True,              # åŒ…å«å¤§è¿
    include_liunian=True,             # åŒ…å«æµå¹´
    include_special_liunian=True,      # åŒ…å«ç‰¹æ®Šæµå¹´
    dayun_mode=BaziDataService.DEFAULT_DAYUN_MODE,  # é»˜è®¤æ¨¡å¼
    target_years=BaziDataService.DEFAULT_TARGET_YEARS,  # é»˜è®¤å¹´ä»½èŒƒå›´
    current_time=None
)

# æå–æ•°æ®
dayun_sequence = fortune_data.dayun_sequence
special_liunians = fortune_data.special_liunians
current_dayun = fortune_data.current_dayun
```

### 3. ç»Ÿä¸€æ•°æ®æä¾›è€…ï¼ˆUnifiedBaziDataProviderï¼‰

#### åŠŸèƒ½ç‰¹ç‚¹

- âœ… **ä»¥æ’ç›˜ä¸ºå‡†**ï¼šæ‰€æœ‰æ•°æ®ä»¥ `BaziDisplayService.get_fortune_display()` ä¸ºå‡†
- âœ… **ä¸€æ¬¡è·å–**ï¼šæ‰€æœ‰æ•°æ®ä¸€æ¬¡è·å–ï¼Œç»Ÿä¸€ç»“æ„
- âœ… **é€ä¼ ç‰¹æ®Šå¹´ä»½**ï¼šç‰¹æ®Šå¹´ä»½ç›´æ¥ä»æ’ç›˜é€ä¼ ï¼Œä¸åšä»»ä½•è®¡ç®—æˆ–è¿‡æ»¤
- âœ… **æ•°æ®éªŒè¯**ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§

#### ä½¿ç”¨ç¤ºä¾‹

```python
from server.services.unified_bazi_data_provider import UnifiedBaziDataProvider

# è·å–ç»Ÿä¸€æ•°æ®
unified_data = await UnifiedBaziDataProvider.get_unified_data(
    solar_date="1990-01-15",
    solar_time="12:00",
    gender="male",
    calendar_type="solar",
    location=None,
    latitude=None,
    longitude=None,
    current_time=None
)

# æ•°æ®ä¸æ’ç›˜å®Œå…¨ä¸€è‡´
assert unified_data.special_liunians == display_result['liunian']['list'] ä¸­æœ‰ relations çš„é¡¹
```

---

## ğŸ”„ æ•°æ®ä¸€è‡´æ€§ä¿è¯

### 1. æ•°æ®æºç»Ÿä¸€

- **æ’ç›˜æ•°æ®**ï¼šæ‰€æœ‰å¤§è¿æµå¹´æ•°æ®ä»¥ `BaziDisplayService.get_fortune_display()` ä¸ºå‡†
- **æ—ºè¡°æ•°æ®**ï¼šç»Ÿä¸€ä½¿ç”¨ `WangShuaiService.calculate_wangshuai()`
- **è¯¦ç»†æ•°æ®**ï¼šç»Ÿä¸€ä½¿ç”¨ `BaziDetailService.calculate_detail_full()`

### 2. æ•°æ®éªŒè¯

- **ç±»å‹éªŒè¯**ï¼šä½¿ç”¨ Pydantic æ¨¡å‹è¿›è¡Œç±»å‹éªŒè¯
- **å®Œæ•´æ€§éªŒè¯**ï¼šç¡®ä¿æ‰€æœ‰å¿…å¡«å­—æ®µå­˜åœ¨
- **ä¸€è‡´æ€§éªŒè¯**ï¼šç¡®ä¿ä¸åŒæ•°æ®æºçš„æ•°æ®ä¸€è‡´

### 3. ç‰¹æ®Šæµå¹´å¤„ç†

- **ç›´æ¥é€ä¼ **ï¼šç‰¹æ®Šæµå¹´ç›´æ¥ä»æ’ç›˜é€ä¼ ï¼Œä¸åšä»»ä½•è®¡ç®—æˆ–è¿‡æ»¤
- **relations å­—æ®µ**ï¼šç¡®ä¿æ¯ä¸ªç‰¹æ®Šæµå¹´éƒ½åŒ…å« `relations` å­—æ®µ
- **å½’å±å¤§è¿**ï¼šç¡®ä¿ç‰¹æ®Šæµå¹´æ­£ç¡®å½’å±åˆ°å¯¹åº”çš„å¤§è¿

---

## âš™ï¸ é…ç½®å‚æ•°

### 7ä¸ªæ ‡å‡†å‚æ•°

æ‰€æœ‰æ•°æ®æœåŠ¡ç»Ÿä¸€æ”¯æŒä»¥ä¸‹7ä¸ªæ ‡å‡†å‚æ•°ï¼š

| å‚æ•° | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `solar_date` | str | é˜³å†æ—¥æœŸæˆ–å†œå†æ—¥æœŸ | "1990-01-15" |
| `solar_time` | str | å‡ºç”Ÿæ—¶é—´ | "12:00" |
| `gender` | str | æ€§åˆ« | "male" / "female" |
| `calendar_type` | str | å†æ³•ç±»å‹ | "solar" / "lunar" |
| `location` | str | å‡ºç”Ÿåœ°ç‚¹ï¼ˆå¯é€‰ï¼‰ | "åŒ—äº¬å¸‚" |
| `latitude` | float | çº¬åº¦ï¼ˆå¯é€‰ï¼‰ | 39.9042 |
| `longitude` | float | ç»åº¦ï¼ˆå¯é€‰ï¼‰ | 116.4074 |

### é»˜è®¤é…ç½®

```python
# ç»Ÿä¸€çš„å¤§è¿æ¨¡å¼ï¼ˆç”¨äº5ä¸ªåˆ†ææ¥å£ï¼‰
DEFAULT_DAYUN_MODE = 'current_with_neighbors'  # å½“å‰å¤§è¿åŠå‰åå„ä¸€ä¸ªï¼ˆå…±3ä¸ªï¼‰

# ç»Ÿä¸€çš„å¹´ä»½èŒƒå›´ï¼ˆç”¨äº5ä¸ªåˆ†ææ¥å£ï¼‰
DEFAULT_TARGET_YEARS = [2025, 2026, 2027]  # é»˜è®¤æŸ¥è¯¢æœªæ¥3å¹´
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶è¡Œè·å–

- **å¼‚æ­¥å¹¶è¡Œ**ï¼šä½¿ç”¨ `asyncio.gather()` å¹¶è¡Œè·å–å¤šä¸ªæ•°æ®æ¨¡å—
- **ç‹¬ç«‹æ‰§è¡Œ**ï¼šæ¯ä¸ªæ•°æ®æ¨¡å—ç‹¬ç«‹æ‰§è¡Œï¼Œäº’ä¸é˜»å¡

### 2. ç¼“å­˜æœºåˆ¶

- **å¤šçº§ç¼“å­˜**ï¼šæ”¯æŒ Redis ç¼“å­˜å’Œå†…å­˜ç¼“å­˜
- **ç¼“å­˜é”®ç”Ÿæˆ**ï¼šç»Ÿä¸€çš„ç¼“å­˜é”®ç”Ÿæˆç­–ç•¥
- **ç¼“å­˜å¤±æ•ˆ**ï¼šæ”¯æŒç¼“å­˜å¤±æ•ˆå’Œæ›´æ–°æœºåˆ¶

### 3. æ•°æ®ç­›é€‰

- **æŒ‰éœ€è·å–**ï¼šæ ¹æ® `modules` é…ç½®æŒ‰éœ€è·å–æ•°æ®
- **å¤§è¿ç­›é€‰**ï¼šæ ¹æ® `dayun_mode` ç­›é€‰å¤§è¿ï¼Œå‡å°‘æ•°æ®ä¼ è¾“
- **å¹´ä»½ç­›é€‰**ï¼šæ ¹æ® `target_years` ç­›é€‰æµå¹´ï¼Œå‡å°‘æ•°æ®ä¼ è¾“

---

## ğŸ“ ä½¿ç”¨è§„èŒƒ

### 1. æµå¼æ¥å£å¼€å‘è§„èŒƒ

æ‰€æœ‰æµå¼æ¥å£å¿…é¡»ï¼š

1. **ä½¿ç”¨ç»Ÿä¸€æ•°æ®æœåŠ¡**ï¼šé€šè¿‡ `BaziDataOrchestrator` æˆ– `BaziDataService` è·å–æ•°æ®
2. **æ”¯æŒ7ä¸ªæ ‡å‡†å‚æ•°**ï¼šç¡®ä¿æ‰€æœ‰æ¥å£æ”¯æŒæ ‡å‡†å‚æ•°
3. **æ•°æ®éªŒè¯**ï¼šä½¿ç”¨ `validate_bazi_data()` éªŒè¯æ•°æ®
4. **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶

### 2. æ•°æ®è·å–ç¤ºä¾‹

```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ç»Ÿä¸€æ•°æ®æœåŠ¡
from server.services.bazi_data_orchestrator import BaziDataOrchestrator

modules = {
    'bazi': True,
    'wangshuai': True,
    'detail': True
}

unified_data = await BaziDataOrchestrator.fetch_data(
    solar_date=request.solar_date,
    solar_time=request.solar_time,
    gender=request.gender,
    modules=modules,
    use_cache=True,
    parallel=True,
    calendar_type=request.calendar_type,
    location=request.location,
    latitude=request.latitude,
    longitude=request.longitude
)

# âŒ é”™è¯¯ï¼šç›´æ¥è°ƒç”¨åº•å±‚æœåŠ¡
bazi_result = BaziService.calculate_bazi_full(...)  # ä¸æ¨è
```

### 3. å¤§è¿æµå¹´æ•°æ®è·å–

```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ç»Ÿä¸€æ•°æ®æœåŠ¡
from server.services.bazi_data_service import BaziDataService

fortune_data = await BaziDataService.get_fortune_data(
    solar_date=final_solar_date,
    solar_time=final_solar_time,
    gender=gender,
    calendar_type=calendar_type or "solar",
    location=location,
    latitude=latitude,
    longitude=longitude,
    include_dayun=True,
    include_liunian=True,
    include_special_liunian=True,
    dayun_mode=BaziDataService.DEFAULT_DAYUN_MODE,
    target_years=BaziDataService.DEFAULT_TARGET_YEARS,
    current_time=None
)

# è½¬æ¢ä¸ºå­—å…¸æ ¼å¼ï¼ˆå…¼å®¹ç°æœ‰ä»£ç ï¼‰
dayun_sequence = []
for dayun in fortune_data.dayun_sequence:
    dayun_sequence.append({
        'step': dayun.step,
        'stem': dayun.stem,
        'branch': dayun.branch,
        'ganzhi': dayun.ganzhi,  # âš ï¸ å¿…é¡»åŒ…å« ganzhi å­—æ®µ
        'year_start': dayun.year_start,
        'year_end': dayun.year_end,
        # ... å…¶ä»–å­—æ®µ
    })
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ganzhi å­—æ®µ

- **å¿…å¡«å­—æ®µ**ï¼š`DayunModel` çš„ `ganzhi` å­—æ®µæ˜¯å¿…å¡«çš„
- **è‡ªåŠ¨ç”Ÿæˆ**ï¼šå¦‚æœåŸå§‹æ•°æ®æ²¡æœ‰ `ganzhi` å­—æ®µï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆ `f"{stem}{branch}"`
- **æ•°æ®è½¬æ¢**ï¼šåœ¨è½¬æ¢ä¸ºå­—å…¸æ—¶ï¼Œå¿…é¡»ç¡®ä¿åŒ…å« `ganzhi` å­—æ®µ

### 2. çƒ­æ›´æ–°å…¼å®¹æ€§

- **ç±»å‹è½¬æ¢**ï¼šåœ¨çƒ­æ›´æ–°åœºæ™¯ä¸‹ï¼Œå»ºè®®ä¼ å…¥å­—å…¸è€Œä¸æ˜¯æ¨¡å‹å®ä¾‹ï¼Œè®© Pydantic è‡ªåŠ¨è½¬æ¢
- **é¿å…ç±»å‹ä¸åŒ¹é…**ï¼šé¿å…åœ¨çƒ­æ›´æ–°åå‡ºç°ç±»å‹ä¸åŒ¹é…é—®é¢˜

### 3. æ•°æ®ä¸€è‡´æ€§

- **ä»¥æ’ç›˜ä¸ºå‡†**ï¼šæ‰€æœ‰å¤§è¿æµå¹´æ•°æ®ä»¥æ’ç›˜æ¥å£ä¸ºå‡†
- **ç‰¹æ®Šæµå¹´é€ä¼ **ï¼šç‰¹æ®Šæµå¹´ç›´æ¥ä»æ’ç›˜é€ä¼ ï¼Œä¸åšä»»ä½•è®¡ç®—æˆ–è¿‡æ»¤
- **relations å­—æ®µ**ï¼šç¡®ä¿æ¯ä¸ªç‰¹æ®Šæµå¹´éƒ½åŒ…å« `relations` å­—æ®µ

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **ganzhi å­—æ®µç¼ºå¤±**
   - **é”™è¯¯**ï¼š`Field required for ganzhi`
   - **è§£å†³**ï¼šç¡®ä¿åœ¨åˆ›å»º `DayunModel` æ—¶åŒ…å« `ganzhi` å­—æ®µ

2. **ç±»å‹ä¸åŒ¹é…**
   - **é”™è¯¯**ï¼š`Input should be a valid dictionary or instance of DayunModel`
   - **è§£å†³**ï¼šåœ¨çƒ­æ›´æ–°åœºæ™¯ä¸‹ï¼Œä¼ å…¥å­—å…¸è€Œä¸æ˜¯æ¨¡å‹å®ä¾‹

3. **æ•°æ®ä¸ä¸€è‡´**
   - **é”™è¯¯**ï¼šä¸åŒæ¥å£è¿”å›çš„æ•°æ®ä¸ä¸€è‡´
   - **è§£å†³**ï¼šç¡®ä¿æ‰€æœ‰æ¥å£ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®æœåŠ¡

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®æ¶æ„.md](./æ•°æ®æ¶æ„.md) - æµå¼æ¥å£æ•°æ®æ¶æ„è¯´æ˜
- [å¼€å‘è§„èŒƒ.md](./å¼€å‘è§„èŒƒ.md) - æµå¼æ¥å£å¼€å‘è§„èŒƒ
- [æµå¼æ¥å£input_dataæ•°æ®æµæ˜ç»†.md](./æµå¼æ¥å£input_dataæ•°æ®æµæ˜ç»†.md) - æ•°æ®æµæ˜ç»†è¯´æ˜

---

## ğŸ”„ æ›´æ–°æ—¥å¿—

### 2026-01-16

- âœ… æ·»åŠ  `ganzhi` å­—æ®µæ”¯æŒï¼Œä¿®å¤ `DayunModel` éªŒè¯é”™è¯¯
- âœ… ä¿®å¤çƒ­æ›´æ–°å¯¼è‡´çš„ Pydantic ç±»å‹ä¸åŒ¹é…é—®é¢˜
- âœ… ä¼˜åŒ–æ•°æ®è½¬æ¢é€»è¾‘ï¼Œä¼ å…¥å­—å…¸è®© Pydantic è‡ªåŠ¨è½¬æ¢

### 2025-12-XX

- âœ… åˆå§‹ç‰ˆæœ¬ï¼Œç»Ÿä¸€æ•°æ®æºæ¶æ„è®¾è®¡
