# 流式接口开发规范

## 核心原则

1. **不改底层** - 不修改 `BaziService`、`DetailService` 等底层计算逻辑
2. **保持独立** - 每个接口有独立的 `build_xxx_input_data()` 函数
3. **复用工具** - 使用 `InputDataHelper` 处理公共逻辑

## 公共工具

位置：`server/utils/input_data_helper.py`

```python
from server.utils.input_data_helper import InputDataHelper

# 安全访问字段
data = InputDataHelper.safe_get_dict(input_data, 'shiye_xing_gong')

# 简化流年数据
simplified = InputDataHelper.simplify_liunian(liunian)

# 确保 relations 存在
liunians = InputDataHelper.ensure_relations(liunians)

# 清理冗余字段
cleaned = InputDataHelper.clean_liunian_data(liunian)
```

## 新接口开发步骤

1. 在 `server/api/v1/` 创建接口文件
2. 定义 `build_xxx_input_data()` 构建数据
3. 使用 `BaziDataOrchestrator.fetch_data()` 获取数据
4. 确保流年数据包含 `relations` 字段
5. 注册到 gRPC 网关

## 常见问题

| 问题 | 解决方案 |
|------|----------|
| `KeyError: 'xxx'` | 使用 `InputDataHelper.safe_get_dict()` |
| `format_input_data_for_coze` 未定义 | 从 `general_review_analysis` 导入 |
| relations 字段缺失 | 使用 `InputDataHelper.ensure_relations()` |
