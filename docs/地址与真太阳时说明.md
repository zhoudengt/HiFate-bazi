# 地址、经纬度与真太阳时 - 项目使用说明

## 一、三者如何被使用

### 1. 数据流概览

```
用户输入 (solar_date, solar_time, location?, latitude?, longitude?)
        │
        ▼
BaziInputProcessor.process_input()
        │
        ├── 步骤1：若 calendar_type=lunar → 农历转阳历
        │
        └── 步骤2：若 location 或 (latitude AND longitude) 有值
                    │
                    ├── 获取时区：location 优先 → 经纬度推算
                    ├── 本地时间 → UTC（含夏令时处理）
                    └── 若有 longitude → 计算真太阳时
        │
        ▼
(final_solar_date, final_solar_time) → BaziCalculator → 八字四柱
```

### 2. 各参数优先级与作用

| 参数 | 优先级 | 作用 |
|------|--------|------|
| **location** | 1 | 通过 `timezone_mapping.py` 匹配时区（如 "北京"→Asia/Shanghai） |
| **latitude** | 2 | 与 longitude 一起用于：① 推算时区；② 目前真太阳时只用经度 |
| **longitude** | 2 | ① 推算时区（每15度≈1小时）；② **真太阳时的核心**：时差 = (经度 - 120) × 4 分钟 |

### 3. 真太阳时计算公式

`server/utils/timezone_converter.py` 中：

```python
# 时差（分钟）= (经度 - 120) × 4
# 120 为东经 120°（近似北京标准）
# 每 15 度经度差 1 小时，故每度约 4 分钟
time_diff_minutes = (longitude - 120) * 4
true_solar_time = utc_time + timedelta(minutes=time_diff_minutes)
```

---

## 二、能否导致八字变化？

**能。** 地址/经纬度通过改变用于计算的 `(日期, 时间)`，间接改变八字。

### 1. 主要影响：时柱

- 时柱由 `solar_time` 的**小时**决定（约 2 小时一个时辰）
- 真太阳时或时区转换会改变实际参与计算的时间
- 时间跨越时辰边界时，**时柱**会变

### 2. 次要影响

- **日柱**：若转换后跨越 23:00–01:00（子时），可能换日
- **月柱**：若跨越节气，会变
- **年柱**：若跨越立春，会变

---

## 三、实测案例

### 案例 1：同一出生钟点，不同地点 → 时柱不同

**输入**：1990-06-15 12:00，男

| 出生地 | 用于计算的时刻 | 四柱（仅展示差异） |
|--------|----------------|--------------------|
| 不传地点（按北京） | 1990-06-15 12:00 | 庚午 壬午 辛亥 **甲午** |
| 北京（116.4°E）   | 1990-06-15 02:45（真太阳时） | 庚午 壬午 辛亥 **己丑** |
| 乌鲁木齐（87.6°E）| 1990-06-15 03:50（真太阳时） | 庚午 壬午 辛亥 **庚寅** |
| 柏林（13.4°E）    | 1990-06-15 02:53（真太阳时） | 庚午 壬午 辛亥 **己丑** |

说明：同一「12:00 本地时间」在不同经度下，换算后的真太阳时不同，导致时柱不同。

### 案例 2：跨时辰边界

- 11:55 → 午时（甲午）
- 12:05 → 未时（乙未）

前后仅差 10 分钟，时柱即变。

### 案例 3：乌鲁木齐 23:50

- **不传地点**：按北京 23:50 → 子时（换日）
- **传乌鲁木齐经纬度**：换算为真太阳时约 15:40 同日 → 申时，且日柱不变

---

## 四、相关代码位置

| 功能 | 文件 |
|------|------|
| 输入预处理 | `server/utils/bazi_input_processor.py` |
| 时区与真太阳时 | `server/utils/timezone_converter.py` |
| 地点→时区 | `server/utils/timezone_mapping.py` |
| 八字核心计算 | `core/calculators/LunarConverter.py`、`core/calculators/bazi_core_calculator.py` |

---

## 五、API 调用示例

```bash
# 带地点
curl -X POST "http://localhost:8001/api/v1/bazi/calculate" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-06-15",
    "solar_time": "12:00",
    "gender": "male",
    "location": "北京",
    "latitude": 39.9,
    "longitude": 116.4
  }'

# 仅经纬度（无地点名称）
curl -X POST "http://localhost:8001/api/v1/bazi/calculate" \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-06-15",
    "solar_time": "12:00",
    "gender": "male",
    "latitude": 43.8,
    "longitude": 87.6
  }'
```

若进行了时区/真太阳时转换，响应中会包含 `conversion_info`，示例如下：

```json
{
  "conversion_info": {
    "original_date": "1990-06-15",
    "original_time": "12:00",
    "final_date": "1990-06-15",
    "final_time": "02:45",
    "timezone_info": "Asia/Shanghai (CDT)",
    "true_solar_time": {
      "date": "1990-06-15",
      "time": "02:45"
    }
  }
}
```
