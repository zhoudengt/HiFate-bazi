# 批量修改规则说明

## 概述

`scripts/batch_update_rules.py` 是一个用于批量修改规则匹配内容的工具脚本，支持三种操作模式：

1. **import** - 从 JSON 文件批量导入更新规则
2. **filter** - 按条件筛选并批量更新规则
3. **export** - 导出规则到 JSON 文件（用于编辑后批量更新）

## 使用方法

### 1. 导出规则（用于编辑）

```bash
# 导出所有规则
python scripts/batch_update_rules.py --mode export --output rules_export.json

# 导出特定类型的规则
python scripts/batch_update_rules.py --mode export --output marriage_rules.json --rule-type marriage_ten_gods

# 导出匹配特定模式的规则
python scripts/batch_update_rules.py --mode export --output r_rules.json --rule-code-pattern "R%"
```

### 2. 编辑 JSON 文件

导出的 JSON 文件格式示例：

```json
[
  {
    "rule_code": "R001",
    "rule_name": "规则名称",
    "rule_type": "marriage_ten_gods",
    "priority": 100,
    "enabled": true,
    "conditions": {
      "year_pillar": "甲子"
    },
    "content": {
      "text": "规则内容",
      "type": "static"
    },
    "description": "规则描述"
  }
]
```

**可以修改的字段：**
- `rule_name` - 规则名称
- `content` - 规则内容（JSON 对象）
- `conditions` - 匹配条件（JSON 对象）
- `priority` - 优先级
- `enabled` - 是否启用（true/false）
- `description` - 规则描述

### 3. 导入更新后的规则

```bash
# 导入更新（实际更新数据库）
python scripts/batch_update_rules.py --mode import --file rules_export.json

# 模拟运行（不实际更新，用于测试）
python scripts/batch_update_rules.py --mode import --file rules_export.json --dry-run
```

### 4. 按条件批量更新（无需导出文件）

```bash
# 更新所有婚姻规则的内容
python scripts/batch_update_rules.py --mode filter \
  --rule-type marriage_ten_gods \
  --content-update '{"text": "新内容", "updated_by": "admin"}'

# 更新匹配特定模式的规则
python scripts/batch_update_rules.py --mode filter \
  --rule-code-pattern "R%" \
  --enabled true \
  --priority 200

# 更新规则条件
python scripts/batch_update_rules.py --mode filter \
  --rule-type marriage_element \
  --conditions-update '{"year_pillar": "甲子"}'

# 模拟运行
python scripts/batch_update_rules.py --mode filter \
  --rule-type marriage_ten_gods \
  --content-update '{"text": "新内容"}' \
  --dry-run
```

## 参数说明

### 通用参数

- `--mode` - 操作模式：`import`、`filter`、`export`（必需）
- `--dry-run` - 模拟运行，不实际更新数据库

### Import 模式参数

- `--file` - JSON 文件路径（必需）

### Filter 模式参数

- `--rule-type` - 规则类型筛选（如 `marriage_ten_gods`）
- `--rule-code-pattern` - 规则代码模式（支持 SQL LIKE，如 `R%`、`%marriage%`）
- `--content-update` - 要更新的内容（JSON 字符串，会合并到现有 content）
- `--conditions-update` - 要更新的条件（JSON 字符串，会合并到现有 conditions）
- `--enabled` - 是否启用（`true`/`false`）
- `--priority` - 优先级（整数）

### Export 模式参数

- `--output` - 输出文件路径（必需）
- `--rule-type` - 规则类型筛选（可选）
- `--rule-code-pattern` - 规则代码模式（可选）

## 使用示例

### 示例 1：批量修改所有婚姻规则的内容

```bash
# 1. 导出所有婚姻规则
python scripts/batch_update_rules.py --mode export \
  --output marriage_rules.json \
  --rule-type marriage_ten_gods

# 2. 编辑 marriage_rules.json 文件，修改 content 字段

# 3. 导入更新
python scripts/batch_update_rules.py --mode import --file marriage_rules.json
```

### 示例 2：批量启用/禁用规则

```bash
# 启用所有以 "R" 开头的规则
python scripts/batch_update_rules.py --mode filter \
  --rule-code-pattern "R%" \
  --enabled true

# 禁用所有婚姻规则
python scripts/batch_update_rules.py --mode filter \
  --rule-type marriage_ten_gods \
  --enabled false
```

### 示例 3：批量修改规则优先级

```bash
# 将所有婚姻规则的优先级设置为 200
python scripts/batch_update_rules.py --mode filter \
  --rule-type marriage_ten_gods \
  --priority 200
```

### 示例 4：批量添加内容字段

```bash
# 为所有规则添加 "updated_by" 字段
python scripts/batch_update_rules.py --mode filter \
  --content-update '{"updated_by": "admin", "updated_at": "2025-01-01"}'
```

## 注意事项

1. **备份数据**：批量更新前建议先导出规则作为备份
2. **测试运行**：使用 `--dry-run` 参数先测试，确认无误后再实际更新
3. **版本号**：更新规则后会自动更新规则版本号，触发热加载
4. **JSON 格式**：确保 JSON 格式正确，特别是 `content` 和 `conditions` 字段
5. **合并更新**：`--content-update` 和 `--conditions-update` 会合并到现有字段，不会覆盖整个对象

## 常见问题

### Q: 如何只更新部分字段？

A: 在 JSON 文件中只包含要更新的字段即可，其他字段会自动保留。

### Q: 如何批量删除规则？

A: 使用 `--enabled false` 禁用规则，而不是删除。

### Q: 更新后规则没有生效？

A: 检查规则版本号是否已更新，服务是否支持热加载。可能需要重启服务。

### Q: JSON 文件格式错误怎么办？

A: 使用 JSON 验证工具检查格式，确保所有字符串都用双引号，JSON 对象和数组格式正确。

