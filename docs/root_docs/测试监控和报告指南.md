# 测试监控和报告指南

## 📋 测试触发条件

### 1. 自动触发

#### GitHub Actions CI/CD

**触发条件**：
- ✅ **推送到分支**：推送到 `master` 或 `develop` 分支时自动触发
- ✅ **Pull Request**：创建或更新 Pull Request 时自动触发
- ✅ **手动触发**：在 GitHub Actions 页面手动触发

**触发流程**：
```
代码推送/PR创建
    ↓
GitHub Actions 自动触发
    ↓
执行测试流程：
  1. 代码质量检查（lint）
  2. 单元测试（test）
  3. API 测试（test）
  4. 集成测试（test）
  5. 生成覆盖率报告
  6. 上传测试结果
```

**查看触发记录**：
- 访问：`https://github.com/<owner>/<repo>/actions`
- 查看：`.github/workflows/ci.yml` 的执行历史

### 2. 本地触发

**开发时运行测试**：
```bash
# 运行所有测试
pytest

# 运行特定类型的测试
pytest -m unit          # 单元测试
pytest -m integration   # 集成测试
pytest -m api          # API 测试

# 运行并查看覆盖率
pytest --cov=server --cov=src --cov-report=html --cov-report=term-missing
```

**提交前检查**：
```bash
# 必须确保测试通过
pytest tests/

# 检查覆盖率
pytest --cov=server --cov=src --cov-fail-under=50
```

## 📊 测试结果

### 1. 测试执行结果

#### 成功情况
- ✅ **所有测试通过**
- ✅ **覆盖率达标**（≥ 50%）
- ✅ **代码质量检查通过**

**结果示例**：
```
========================= test session starts ==========================
tests/unit/test_bazi_service.py::TestBaziService::test_calculate_bazi_full_success PASSED
tests/unit/test_bazi_service.py::TestBaziService::test_calculate_bazi_full_female PASSED
...
========================= 56 passed in 2.34s ==========================

---------- coverage: platform darwin, python 3.11.0 -----------
Name                          Stmts   Miss  Cover
--------------------------------------------------
server/services/bazi_service.py    120     45    62%
server/api/v1/bazi.py              85     15    82%
...
--------------------------------------------------
TOTAL                              2500   1200    52%
```

#### 失败情况
- ❌ **测试失败**：某些测试用例失败
- ❌ **覆盖率不足**：覆盖率 < 50%
- ❌ **代码质量检查失败**：代码格式或质量问题

**结果示例**：
```
========================= test session starts ==========================
tests/unit/test_bazi_service.py::TestBaziService::test_calculate_bazi_full_success FAILED
...
========================= 1 failed, 55 passed in 2.34s ==========================

FAILED tests/unit/test_bazi_service.py::TestBaziService::test_calculate_bazi_full_success
AssertionError: assert result["success"] == True
```

### 2. 覆盖率报告

**覆盖率指标**：
- **整体覆盖率**：≥ 50%
- **核心模块覆盖率**（server/services/）：≥ 70%
- **API 端点覆盖率**（server/api/）：≥ 80%
- **工具函数覆盖率**（server/utils/）：≥ 60%

**覆盖率报告位置**：
- **本地**：`htmlcov/index.html`
- **CI/CD Artifacts**：GitHub Actions 下载 `coverage-report`
- **在线**：Codecov（如果配置）

### 3. 测试统计

**测试统计信息**：
- **总测试数**：所有测试用例数量
- **通过数**：成功通过的测试数量
- **失败数**：失败的测试数量
- **跳过数**：跳过的测试数量
- **执行时间**：测试总耗时

## 🔍 测试监控位置

### 1. GitHub Actions

**访问地址**：
- `https://github.com/<owner>/<repo>/actions`

**查看内容**：
- ✅ 测试执行状态（成功/失败）
- ✅ 测试执行日志
- ✅ 覆盖率报告（Artifacts）
- ✅ 测试执行时间

**操作步骤**：
1. 访问 GitHub 仓库
2. 点击 "Actions" 标签
3. 选择 "CI/CD Pipeline" 工作流
4. 查看最新的执行记录
5. 点击具体执行记录查看详情
6. 下载 Artifacts 查看覆盖率报告

### 2. 本地覆盖率报告

**生成报告**：
```bash
# 生成 HTML 覆盖率报告
pytest --cov=server --cov=src --cov-report=html

# 查看报告
open htmlcov/index.html  # macOS
# 或
xdg-open htmlcov/index.html  # Linux
# 或直接在浏览器打开 htmlcov/index.html
```

**报告内容**：
- 📊 整体覆盖率统计
- 📁 各模块覆盖率详情
- 📝 未覆盖代码行标记
- 🔍 可点击查看具体代码

### 3. Codecov（可选）

**如果配置了 Codecov**：
- 访问：`https://codecov.io/gh/<owner>/<repo>`
- 查看：覆盖率趋势、覆盖率变化、未覆盖代码

### 4. 测试日志

**本地测试日志**：
- 测试执行时会在终端输出详细日志
- 失败的测试会显示详细的错误信息

**CI/CD 测试日志**：
- GitHub Actions 中查看测试执行日志
- 包含详细的测试输出和错误信息

## 📈 测试趋势监控

### 1. 覆盖率趋势

**监控指标**：
- 覆盖率是否下降
- 新增代码是否有测试
- 测试覆盖率是否达标

**查看方式**：
- Codecov（如果配置）：查看覆盖率趋势图
- GitHub Actions：对比不同提交的覆盖率

### 2. 测试通过率

**监控指标**：
- 测试通过率是否稳定
- 是否有新增失败的测试
- 测试执行时间是否增加

**查看方式**：
- GitHub Actions：查看测试执行历史
- 本地：运行 `pytest` 查看结果

### 3. 测试执行时间

**监控指标**：
- 测试执行时间是否增加
- 是否有慢速测试需要优化

**查看方式**：
- GitHub Actions：查看测试执行时间
- 本地：运行 `pytest --durations=10` 查看最慢的测试

## 🚨 测试失败处理

### 1. 测试失败时

**立即处理**：
1. **查看失败日志**：GitHub Actions 或本地测试输出
2. **定位问题**：确定是代码问题还是测试问题
3. **修复问题**：修复代码或更新测试
4. **重新运行**：确保测试通过

**禁止操作**：
- ❌ 禁止跳过失败的测试
- ❌ 禁止降低覆盖率要求
- ❌ 禁止删除失败的测试

### 2. 覆盖率不足时

**处理方式**：
1. **查看覆盖率报告**：确定哪些代码未覆盖
2. **补充测试**：为未覆盖的代码编写测试
3. **重新检查**：确保覆盖率达标

## 📝 测试报告示例

### GitHub Actions 测试报告

```
## 🧪 测试结果汇总

### ✅ 测试通过情况
- 代码质量检查: success
- 单元测试: success
- API 测试: success
- 集成测试: success

### 📊 覆盖率报告
- 整体覆盖率: 52%
- 核心模块覆盖率: 68%
- API 端点覆盖率: 82%
- 工具函数覆盖率: 61%

### 📝 查看报告
1. 下载 Artifacts: coverage-report
2. 打开 htmlcov/index.html 查看详细覆盖率
```

### 本地测试报告

```
========================= test session starts ==========================
platform darwin -- Python 3.11.0, pytest-7.4.0, pluggy-1.3.0
rootdir: /Users/zhoudt/Downloads/project/HiFate-bazi
configfile: pytest.ini
plugins: cov-4.1.0
collected 72 items

tests/unit/test_bazi_service.py::TestBaziService::test_calculate_bazi_full_success PASSED
tests/unit/test_bazi_service.py::TestBaziService::test_calculate_bazi_full_female PASSED
...

========================= 72 passed in 3.45s ==========================

---------- coverage: platform darwin, python 3.11.0 -----------
Name                          Stmts   Miss  Cover   Missing
----------------------------------------------------------
server/services/bazi_service.py    120     45    62%   45-50, 80-85
server/api/v1/bazi.py              85     15    82%   120-125
...
----------------------------------------------------------
TOTAL                              2500   1200    52%
```

## 🎯 测试监控检查清单

每次开发新功能后，检查：

- [ ] 测试是否自动触发（GitHub Actions）
- [ ] 测试是否全部通过
- [ ] 覆盖率是否达标（≥ 50%）
- [ ] 测试执行时间是否合理
- [ ] 是否有新增失败的测试
- [ ] 覆盖率报告是否生成
- [ ] 测试日志是否清晰

---

**最后更新**：2025-01-21

