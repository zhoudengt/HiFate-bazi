# 今日运势分析使用案例 - 详细说明

## 📋 功能概述

**今日运势分析**是类似 FateTell "日运日签"的功能，结合用户的八字信息和当前日期（或指定日期），分析该日的运势。

## 🎯 核心特点

1. **结合流日信息**：基于流年、流月、流日进行精准分析
2. **多维度分析**：涵盖事业、财运、感情、健康等各个方面
3. **快速响应**：规则匹配模式 <1秒
4. **灵活查询**：可以查询任意日期的运势（不限于今天）
5. **双模式支持**：规则匹配（快速）和 LLM 生成（个性化）

---

## 📝 详细使用案例

### 案例 1：每日运势查询（类似"日运日签"）

**场景描述：**
用户每天早上想查看今天的运势，了解今天适合做什么、需要注意什么。

**使用方式：**

```bash
# 查询今日运势（不指定 target_date，默认使用今天）
curl -X POST http://127.0.0.1:8001/api/v1/bazi/daily-fortune \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male"
  }'
```

**返回结果：**
```json
{
  "success": true,
  "target_date": "2025-01-17",
  "fortune": {
    "text": "【2025年01月17日运势分析】\n...",
    "summary": "2025年01月17日运势分析",
    "categories": {
      "career": "今日事业运势平稳，适合处理常规工作。",
      "wealth": "今日财运平稳，建议理性消费。",
      "love": "今日感情运势平稳，适合与伴侣沟通交流。",
      "health": "今日健康运势平稳，注意劳逸结合。"
    }
  },
  "liuri_info": {
    "date": "2025-01-17",
    "liuri": "甲子",
    "liuyue": "丁丑",
    "liunian": "乙巳"
  }
}
```

**用户如何使用：**
1. 每天早上打开 App
2. 调用接口获取今日运势
3. 查看分类运势（事业、财运、感情、健康）
4. 根据建议安排今天的工作和生活

**实际应用：**
- 早上推送：App 每天早上 8:00 自动推送今日运势
- 桌面小组件：显示今日运势摘要
- 通知提醒：根据运势建议设置提醒（如"今日适合沟通"）

---

### 案例 2：重要日期运势查询

**场景描述：**
用户想知道某个重要日期的运势，比如：
- 面试日期：2025-02-20
- 签约日期：2025-03-15
- 搬家日期：2025-04-10

**使用方式：**

```bash
# 查询特定日期的运势
curl -X POST http://127.0.0.1:8001/api/v1/bazi/daily-fortune \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "target_date": "2025-02-20"
  }'
```

**返回结果：**
```json
{
  "success": true,
  "target_date": "2025-02-20",
  "fortune": {
    "text": "【2025年02月20日运势分析】\n...",
    "categories": {
      "career": "今日事业运势较好，适合重要决策和面试。",
      "wealth": "今日财运平稳，签约需谨慎。",
      ...
    }
  },
  "liuri_info": {
    "liuri": "乙丑",
    "liuyue": "戊寅",
    "liunian": "乙巳"
  }
}
```

**用户如何使用：**
1. 在 App 中选择"查询特定日期运势"
2. 输入目标日期（如面试日期）
3. 查看该日的运势分析
4. 根据运势建议决定是否调整日期或做好准备

**实际应用：**
- 择日功能：帮助用户选择重要事件的日期
- 决策参考：在重要决策前查询该日运势
- 日程规划：根据运势安排重要活动

---

### 案例 3：使用 LLM 生成个性化运势

**场景描述：**
用户想要更个性化、更详细的运势分析，愿意等待较长时间。

**使用方式：**

```bash
# 使用 LLM 生成模式
curl -X POST http://127.0.0.1:8001/api/v1/bazi/daily-fortune \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "use_llm": true
  }'
```

**返回结果：**
```json
{
  "success": true,
  "target_date": "2025-01-17",
  "fortune": {
    "text": "根据您的八字信息和流日信息，我为您分析今日运势：\n\n【整体运势】\n今日您的日主与流日...\n\n【事业运势】\n从您的八字格局看...\n\n...",
    "summary": "2025年01月17日运势分析（LLM生成）",
    "generated_by": "llm"
  }
}
```

**与规则匹配模式的区别：**
- **规则匹配模式**：快速（<1秒），内容标准化
- **LLM 生成模式**：较慢（5-15秒），内容个性化、更详细

**用户如何使用：**
1. 在 App 中选择"个性化运势分析"
2. 等待 5-15 秒
3. 获得更详细、更个性化的运势分析

---

### 案例 4：定时推送每日运势（类似"日运日签"）

**场景描述：**
App 每天固定时间（如早上 8:00）自动推送今日运势给用户。

**实现方案：**

```python
# 定时任务脚本（示例）
import schedule
import time
import requests
from datetime import date

def send_daily_fortune_to_user(user_id, solar_date, solar_time, gender):
    """发送今日运势给用户"""
    # 1. 调用接口获取今日运势
    response = requests.post(
        "http://127.0.0.1:8001/api/v1/bazi/daily-fortune",
        json={
            "solar_date": solar_date,
            "solar_time": solar_time,
            "gender": gender
        }
    )
    
    if response.status_code == 200:
        result = response.json()
        if result.get('success'):
            fortune = result.get('fortune', {})
            categories = fortune.get('categories', {})
            
            # 2. 构建推送消息
            message = f"【今日运势】{date.today().strftime('%Y年%m月%d日')}\n\n"
            message += f"📈 事业：{categories.get('career', '')}\n"
            message += f"💰 财运：{categories.get('wealth', '')}\n"
            message += f"💕 感情：{categories.get('love', '')}\n"
            message += f"🏥 健康：{categories.get('health', '')}\n"
            
            # 3. 发送推送（这里需要接入推送服务）
            # send_push_notification(user_id, message)
            print(f"发送给用户 {user_id}: {message}")
            return True
    
    return False

# 每天 8:00 执行
schedule.every().day.at("08:00").do(
    send_daily_fortune_to_user,
    user_id="user123",
    solar_date="1990-05-15",
    solar_time="14:30",
    gender="male"
)

# 运行定时任务
while True:
    schedule.run_pending()
    time.sleep(60)
```

**实际应用：**
- 微信小程序：每天推送"日运日签"
- App 推送：每天早上推送今日运势
- 邮件订阅：每天发送运势邮件

---

### 案例 5：批量查询未来一周运势

**场景描述：**
用户想查看未来一周的运势，提前规划。

**使用方式：**

```python
from datetime import date, timedelta
import requests

def get_weekly_fortune(solar_date, solar_time, gender, start_date=None):
    """获取未来一周的运势"""
    if start_date is None:
        start_date = date.today()
    
    weekly_fortune = []
    for i in range(7):
        target_date = start_date + timedelta(days=i)
        
        response = requests.post(
            "http://127.0.0.1:8001/api/v1/bazi/daily-fortune",
            json={
                "solar_date": solar_date,
                "solar_time": solar_time,
                "gender": gender,
                "target_date": target_date.strftime("%Y-%m-%d")
            }
        )
        
        if response.status_code == 200:
            result = response.json()
            if result.get('success'):
                weekly_fortune.append({
                    "date": target_date.strftime("%Y-%m-%d"),
                    "fortune": result.get('fortune')
                })
    
    return weekly_fortune

# 使用
fortune_list = get_weekly_fortune("1990-05-15", "14:30", "male")
for item in fortune_list:
    print(f"{item['date']}: {item['fortune']['summary']}")
```

**返回结果：**
```json
[
  {
    "date": "2025-01-17",
    "fortune": {
      "summary": "2025年01月17日运势分析",
      "categories": {...}
    }
  },
  {
    "date": "2025-01-18",
    "fortune": {...}
  },
  ...
]
```

**实际应用：**
- 周运势视图：App 显示未来一周的运势
- 日程规划：根据一周运势安排重要活动
- 趋势分析：查看运势变化趋势

---

### 案例 6：结合其他功能使用

**场景描述：**
用户想要完整的命理服务，结合多个功能。

**使用流程：**

1. **早上查看今日运势**
```bash
POST /api/v1/bazi/daily-fortune
```
→ 了解今天的整体运势

2. **有重要决策时，使用一事一卦**
```bash
POST /api/v1/bazi/yigua/divinate
{
  "question": "今天适合签约吗？"
}
```
→ 快速占卜，获得决策参考

3. **需要详细分析时，使用 LLM 生成**
```bash
POST /api/v1/bazi/llm-generate
```
→ 获得完整的个性化报告

4. **有疑问时，使用对话接口**
```bash
POST /api/v1/bazi/chat/send
{
  "conversation_id": "...",
  "user_message": "为什么今天的财运不太好？"
}
```
→ 像聊天一样咨询 AI 命理师

---

## 🎯 场景总结

| 场景 | 使用方式 | 响应时间 | 成本 |
|------|---------|---------|------|
| **每日运势查询** | 规则匹配模式 | <1秒 | 低 |
| **重要日期查询** | 规则匹配模式 | <1秒 | 低 |
| **个性化分析** | LLM 生成模式 | 5-15秒 | 高 |
| **定时推送** | 规则匹配模式 | <1秒 | 低 |
| **批量查询** | 规则匹配模式 | <1秒/天 | 低 |

---

## 💡 最佳实践

1. **日常使用**：使用规则匹配模式（快速、成本低）
2. **重要决策**：结合一事一卦和今日运势分析
3. **深度分析**：使用 LLM 生成模式
4. **定时推送**：缓存结果，避免重复计算
5. **批量查询**：使用异步处理，提高效率

---

**文档版本：** v1.0  
**最后更新：** 2025-01-XX

