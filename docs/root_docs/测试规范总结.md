# 测试规范总结

## ✅ 已完成的工作

### 1. 更新开发规范
- ✅ 在 `.cursorrules` 中添加了完整的测试开发规范
- ✅ 要求所有新功能必须同步编写测试案例
- ✅ 要求测试覆盖率必须达到 50% 以上

### 2. 更新测试配置
- ✅ 更新 `pytest.ini`：覆盖率要求从 3% 提升到 50%
- ✅ 更新 `.github/workflows/ci.yml`：增强测试流程，添加 API 测试和集成测试

### 3. 创建测试案例
- ✅ 创建 `tests/api/test_bazi_endpoints.py`：八字 API 端点测试
- ✅ 创建 `tests/api/test_observability.py`：可观测性 API 测试
- ✅ 创建 `tests/unit/test_rule_service.py`：规则服务单元测试

### 4. 创建测试监控文档
- ✅ 创建 `docs/root_docs/测试监控和报告指南.md`：详细的测试监控指南

---

## 🚀 测试触发条件

### 自动触发

#### 1. GitHub Actions CI/CD

**触发时机**：
- ✅ **推送到分支**：推送到 `master` 或 `develop` 分支时
- ✅ **Pull Request**：创建或更新 Pull Request 时
- ✅ **手动触发**：在 GitHub Actions 页面点击 "Run workflow"

**触发流程**：
```
代码推送/PR创建
    ↓
GitHub Actions 自动触发 (.github/workflows/ci.yml)
    ↓
执行测试流程：
  1. 代码质量检查（lint）
  2. 单元测试（test）
  3. API 测试（test）
  4. 集成测试（test）
  5. 生成覆盖率报告
  6. 上传测试结果到 Artifacts
```

**查看方式**：
- 访问：`https://github.com/<owner>/<repo>/actions`
- 查看：`.github/workflows/ci.yml` 的执行历史

### 本地触发

**开发时运行**：
```bash
# 运行所有测试
pytest

# 运行特定类型的测试
pytest -m unit          # 单元测试
pytest -m integration   # 集成测试
pytest -m api          # API 测试

# 运行并查看覆盖率
pytest --cov=server --cov=src --cov-report=html --cov-report=term-missing
```

**提交前检查**：
```bash
# 必须确保测试通过
pytest tests/

# 检查覆盖率（必须 ≥ 50%）
pytest --cov=server --cov=src --cov-fail-under=50
```

---

## 📊 测试结果

### 测试执行结果

#### ✅ 成功情况
- **所有测试通过**
- **覆盖率达标**（≥ 50%）
- **代码质量检查通过**

**结果示例**：
```
========================= test session starts ==========================
tests/unit/test_bazi_service.py::TestBaziService::test_calculate_bazi_full_success PASSED
tests/unit/test_bazi_service.py::TestBaziService::test_calculate_bazi_full_female PASSED
...
========================= 72 passed in 3.45s ==========================

---------- coverage: platform darwin, python 3.11.0 -----------
Name                          Stmts   Miss  Cover
--------------------------------------------------
server/services/bazi_service.py    120     45    62%
server/api/v1/bazi.py              85     15    82%
...
--------------------------------------------------
TOTAL                              2500   1200    52%
```

#### ❌ 失败情况
- **测试失败**：某些测试用例失败
- **覆盖率不足**：覆盖率 < 50%
- **代码质量检查失败**：代码格式或质量问题

**处理方式**：
1. 查看失败日志
2. 修复问题
3. 重新运行测试
4. 确保所有测试通过后才能合并代码

### 覆盖率报告

**覆盖率要求**：
- **整体覆盖率**：≥ 50%
- **核心模块覆盖率**（server/services/）：≥ 70%
- **API 端点覆盖率**（server/api/）：≥ 80%
- **工具函数覆盖率**（server/utils/）：≥ 60%

**覆盖率报告位置**：
- **本地**：`htmlcov/index.html`
- **CI/CD Artifacts**：GitHub Actions 下载 `coverage-report`
- **在线**：Codecov（如果配置）

---

## 🔍 测试监控位置

### 1. GitHub Actions（主要监控位置）

**访问地址**：
- `https://github.com/<owner>/<repo>/actions`

**查看内容**：
- ✅ 测试执行状态（成功/失败）
- ✅ 测试执行日志
- ✅ 覆盖率报告（Artifacts）
- ✅ 测试执行时间
- ✅ 测试结果汇总

**操作步骤**：
1. 访问 GitHub 仓库
2. 点击 "Actions" 标签
3. 选择 "CI/CD Pipeline" 工作流
4. 查看最新的执行记录
5. 点击具体执行记录查看详情
6. 在 "Artifacts" 部分下载 `coverage-report` 查看覆盖率报告

**测试结果汇总示例**：
```
## 🧪 测试结果汇总

### ✅ 测试通过情况
- 代码质量检查: success
- 单元测试: success
- API 测试: success
- 集成测试: success

### 📊 覆盖率报告
- 整体覆盖率: 52%
- 核心模块覆盖率: 68%
- API 端点覆盖率: 82%
- 工具函数覆盖率: 61%

### 📝 查看报告
1. 下载 Artifacts: coverage-report
2. 打开 htmlcov/index.html 查看详细覆盖率
```

### 2. 本地覆盖率报告

**生成报告**：
```bash
# 生成 HTML 覆盖率报告
pytest --cov=server --cov=src --cov-report=html

# 查看报告
open htmlcov/index.html  # macOS
# 或直接在浏览器打开 htmlcov/index.html
```

**报告内容**：
- 📊 整体覆盖率统计
- 📁 各模块覆盖率详情
- 📝 未覆盖代码行标记
- 🔍 可点击查看具体代码

### 3. Codecov（可选）

**如果配置了 Codecov**：
- 访问：`https://codecov.io/gh/<owner>/<repo>`
- 查看：覆盖率趋势、覆盖率变化、未覆盖代码

### 4. 测试日志

**本地测试日志**：
- 测试执行时会在终端输出详细日志
- 失败的测试会显示详细的错误信息

**CI/CD 测试日志**：
- GitHub Actions 中查看测试执行日志
- 包含详细的测试输出和错误信息

---

## 📋 测试规范要求

### 新增功能必须同步编写测试

**要求**：
- ✅ 新增 API 端点必须编写对应的测试案例
- ✅ 新增服务功能必须编写单元测试
- ✅ 新增业务逻辑必须编写集成测试
- ✅ 修改现有功能必须更新相关测试

**检查清单**：
- [ ] 新功能是否有对应的测试文件
- [ ] 测试是否覆盖正常流程
- [ ] 测试是否覆盖异常流程
- [ ] 测试是否覆盖边界情况
- [ ] 测试是否通过 CI/CD 验证
- [ ] 覆盖率是否达到要求（≥ 50%）

### 测试覆盖率要求

**覆盖率目标**：
- **单元测试覆盖率**：≥ 50%（核心模块 ≥ 70%）
- **API 测试覆盖率**：≥ 80%（所有公开 API 必须有测试）
- **集成测试覆盖率**：≥ 60%（关键业务流程必须有测试）

---

## 🎯 快速参考

### 测试命令

```bash
# 运行所有测试
pytest

# 运行特定类型的测试
pytest -m unit          # 单元测试
pytest -m integration   # 集成测试
pytest -m api          # API 测试

# 运行并查看覆盖率
pytest --cov=server --cov=src --cov-report=html --cov-report=term-missing

# 检查覆盖率（必须 ≥ 50%）
pytest --cov=server --cov=src --cov-fail-under=50
```

### 监控位置

1. **GitHub Actions**：`https://github.com/<owner>/<repo>/actions`
2. **本地覆盖率报告**：`htmlcov/index.html`
3. **Codecov**（如果配置）：`https://codecov.io/gh/<owner>/<repo>`

### 测试结果

- **成功**：所有测试通过，覆盖率 ≥ 50%
- **失败**：有测试失败或覆盖率不足，需要修复

---

**最后更新**：2025-01-21

