# åŠå…¬æ¡Œé£æ°´åˆ†æä¿®å¤ - åŒæ­¥åˆ°ç”Ÿäº§æ­¥éª¤

## âœ… ä¿®å¤å®Œæˆ

**ä¿®å¤æ—¶é—´**: 2025-12-12  
**ä¿®å¤å†…å®¹**: åŠå…¬æ¡Œé£æ°´åˆ†æ NoneType é”™è¯¯  
**ä¿®å¤æ–‡ä»¶**:
- `server/api/v2/desk_fengshui_api.py`
- `services/desk_fengshui/analyzer.py`
- `services/desk_fengshui/rule_engine.py`

---

## ğŸ“‹ åŒæ­¥åˆ°ç”Ÿäº§ç¯å¢ƒæ­¥éª¤

### æ­¥éª¤ 1: æäº¤ä»£ç åˆ° Gitï¼ˆæœ¬åœ°ï¼‰

```bash
# 1. æŸ¥çœ‹ä¿®æ”¹çš„æ–‡ä»¶
cd /Users/zhoudt/Downloads/project/HiFate-bazi
git status

# 2. æ·»åŠ ä¿®æ”¹çš„æ–‡ä»¶
git add server/api/v2/desk_fengshui_api.py
git add services/desk_fengshui/analyzer.py
git add services/desk_fengshui/rule_engine.py
git add docs/root_docs/åŠå…¬æ¡Œé£æ°´åˆ†æä¿®å¤è¯´æ˜.md
git add docs/root_docs/åŠå…¬æ¡Œé£æ°´ä¿®å¤-åŒæ­¥åˆ°ç”Ÿäº§æ­¥éª¤.md

# 3. æäº¤
git commit -m "[ä¿®å¤] åŠå…¬æ¡Œé£æ°´åˆ†æ NoneType é”™è¯¯

- ä¿®å¤ server/api/v2/desk_fengshui_api.py ä¸­çš„ result None æ£€æŸ¥
- ä¿®å¤ services/desk_fengshui/analyzer.py ä¸­çš„ä¸­é—´ç»“æœ None æ£€æŸ¥
- ä¿®å¤ services/desk_fengshui/rule_engine.py ä¸­çš„ analysis None æ£€æŸ¥
- æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œé˜²å¾¡æ€§ç¼–ç¨‹

ä¿®å¤é—®é¢˜: 'NoneType' object has no attribute 'get'"

# 4. æ¨é€åˆ° GitHub
git push origin master
```

### æ­¥éª¤ 2: åŒæ­¥åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆNode1 å’Œ Node2ï¼‰

**âš ï¸ é‡è¦**: è¯·åœ¨ç¡®è®¤ä¿®å¤æ— è¯¯åå†æ‰§è¡Œä»¥ä¸‹æ­¥éª¤

#### æ–¹å¼ 1: æ‰‹åŠ¨åŒæ­¥ï¼ˆæ¨èï¼Œé›¶åœæœºï¼‰

```bash
# ============================================
# Node1 åŒæ­¥æ­¥éª¤
# ============================================
ssh root@8.210.52.217 << 'EOF'
cd /opt/HiFate-bazi

# 1. æ‹‰å–æœ€æ–°ä»£ç 
echo "æ‹‰å–æœ€æ–°ä»£ç ..."
git pull origin master

# 2. ä¿®å¤ gRPC ä»£ç ï¼ˆå¦‚æœéœ€è¦ï¼‰
echo "ä¿®å¤ gRPC ä»£ç ..."
python3 scripts/grpc/fix_version_check.py

# 3. é‡å¯ Web æœåŠ¡ï¼ˆé›¶åœæœºï¼Œä½¿ç”¨çƒ­é‡è½½ï¼‰
echo "é‡å¯ Web æœåŠ¡..."
cd deploy/docker
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml --env-file /opt/HiFate-bazi/.env restart web

echo "âœ… Node1 åŒæ­¥å®Œæˆ"
EOF

# ============================================
# Node2 åŒæ­¥æ­¥éª¤
# ============================================
ssh root@47.243.160.43 << 'EOF'
cd /opt/HiFate-bazi

# 1. æ‹‰å–æœ€æ–°ä»£ç 
echo "æ‹‰å–æœ€æ–°ä»£ç ..."
git pull origin master

# 2. ä¿®å¤ gRPC ä»£ç ï¼ˆå¦‚æœéœ€è¦ï¼‰
echo "ä¿®å¤ gRPC ä»£ç ..."
python3 scripts/grpc/fix_version_check.py

# 3. é‡å¯ Web æœåŠ¡ï¼ˆé›¶åœæœºï¼Œä½¿ç”¨çƒ­é‡è½½ï¼‰
echo "é‡å¯ Web æœåŠ¡..."
cd deploy/docker
docker-compose -f docker-compose.prod.yml -f docker-compose.node2.yml --env-file /opt/HiFate-bazi/.env restart web

echo "âœ… Node2 åŒæ­¥å®Œæˆ"
EOF
```

#### æ–¹å¼ 2: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬

```bash
# ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆä¼šæ‹‰å–æœ€æ–°ä»£ç å¹¶é‡å¯æœåŠ¡ï¼‰
bash deploy/scripts/deploy_production.sh
```

### æ­¥éª¤ 3: éªŒè¯ä¿®å¤

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "æ£€æŸ¥ Node1 æœåŠ¡çŠ¶æ€..."
ssh root@8.210.52.217 "docker ps | grep hifate-web"

echo "æ£€æŸ¥ Node2 æœåŠ¡çŠ¶æ€..."
ssh root@47.243.160.43 "docker ps | grep hifate-web"

# 2. æµ‹è¯• APIï¼ˆä½¿ç”¨æµ‹è¯•å›¾ç‰‡ï¼‰
echo "æµ‹è¯• Node1 API..."
curl -X POST http://8.210.52.217/api/v2/desk-fengshui/analyze \
  -F "image=@test_desk.jpg" \
  -F "solar_date=1990-01-15" \
  -F "solar_time=12:00" \
  -F "gender=male" \
  -F "use_bazi=true" \
  -w "\nå“åº”æ—¶é—´: %{time_total}s\n" \
  2>&1 | head -20

# 3. æ£€æŸ¥æ—¥å¿—ï¼ˆç¡®è®¤æ²¡æœ‰ NoneType é”™è¯¯ï¼‰
echo "æ£€æŸ¥ Node1 æ—¥å¿—..."
ssh root@8.210.52.217 "docker logs hifate-web --tail 100 | grep -E 'desk_fengshui|åŠå…¬æ¡Œé£æ°´|NoneType|None' | tail -20"

echo "æ£€æŸ¥ Node2 æ—¥å¿—..."
ssh root@47.243.160.43 "docker logs hifate-web --tail 100 | grep -E 'desk_fengshui|åŠå…¬æ¡Œé£æ°´|NoneType|None' | tail -20"
```

### æ­¥éª¤ 4: å‰ç«¯æµ‹è¯•

1. **è®¿é—®é¡µé¢**ï¼š
   - Node1: http://8.210.52.217/frontend/desk-fengshui.html
   - Node2: http://47.243.160.43/frontend/desk-fengshui.html

2. **æµ‹è¯•åœºæ™¯**ï¼š
   - âœ… ä¸Šä¼ å›¾ç‰‡ + å¡«å†™å®Œæ•´å…«å­—ä¿¡æ¯
   - âœ… ä¸Šä¼ å›¾ç‰‡ + ä¸å¡«å†™å…«å­—ä¿¡æ¯ï¼ˆuse_bazi=Falseï¼‰
   - âœ… ä¸Šä¼ å›¾ç‰‡ + å¡«å†™ä¸å®Œæ•´å…«å­—ä¿¡æ¯ï¼ˆåº”è¯¥è‡ªåŠ¨ç¦ç”¨å…«å­—åˆ†æï¼‰

3. **éªŒè¯ç»“æœ**ï¼š
   - âœ… ä¸å†å‡ºç° `'NoneType' object has no attribute 'get'` é”™è¯¯
   - âœ… åˆ†æç»“æœæ­£å¸¸æ˜¾ç¤º
   - âœ… é”™è¯¯æç¤ºå‹å¥½ï¼ˆå¦‚æœæœ‰é”™è¯¯ï¼‰

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆï¼ˆå¦‚æœéœ€è¦ï¼‰

å¦‚æœä¿®å¤åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# Node1 å›æ»š
ssh root@8.210.52.217 << 'EOF'
cd /opt/HiFate-bazi
git checkout HEAD~1 server/api/v2/desk_fengshui_api.py
git checkout HEAD~1 services/desk_fengshui/analyzer.py
git checkout HEAD~1 services/desk_fengshui/rule_engine.py
cd deploy/docker
docker-compose -f docker-compose.prod.yml -f docker-compose.node1.yml --env-file /opt/HiFate-bazi/.env restart web
EOF

# Node2 å›æ»š
ssh root@47.243.160.43 << 'EOF'
cd /opt/HiFate-bazi
git checkout HEAD~1 server/api/v2/desk_fengshui_api.py
git checkout HEAD~1 services/desk_fengshui/analyzer.py
git checkout HEAD~1 services/desk_fengshui/rule_engine.py
cd deploy/docker
docker-compose -f docker-compose.prod.yml -f docker-compose.node2.yml --env-file /opt/HiFate-bazi/.env restart web
EOF
```

---

## âœ… æ£€æŸ¥æ¸…å•

æ‰§è¡ŒåŒæ­¥å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] æœ¬åœ°ä»£ç å·²æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å·²æäº¤åˆ° Git
- [ ] ä»£ç å·²æ¨é€åˆ° GitHub
- [ ] å·²å‡†å¤‡å¥½å›æ»šæ–¹æ¡ˆ
- [ ] å·²å‡†å¤‡å¥½éªŒè¯æ­¥éª¤

æ‰§è¡ŒåŒæ­¥åï¼Œè¯·éªŒè¯ï¼š

- [ ] æœåŠ¡çŠ¶æ€æ­£å¸¸ï¼ˆæ— é‡å¯ï¼‰
- [ ] API æµ‹è¯•é€šè¿‡
- [ ] å‰ç«¯é¡µé¢æµ‹è¯•é€šè¿‡
- [ ] æ—¥å¿—ä¸­æ—  NoneType é”™è¯¯
- [ ] é”™è¯¯æç¤ºå‹å¥½

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é›¶åœæœºéƒ¨ç½²**ï¼š
   - ä½¿ç”¨ `docker restart` é‡å¯æœåŠ¡ï¼Œä¼šæœ‰çŸ­æš‚ä¸­æ–­ï¼ˆå‡ ç§’é’Ÿï¼‰
   - å¦‚æœæ”¯æŒçƒ­é‡è½½ï¼Œä»£ç ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€é‡å¯

2. **æœåŠ¡ä¾èµ–**ï¼š
   - Web æœåŠ¡ä¾èµ–å¾®æœåŠ¡ï¼ˆdesk-fengshuiï¼‰
   - ç¡®ä¿å¾®æœåŠ¡æ­£å¸¸è¿è¡Œ

3. **æ—¥å¿—ç›‘æ§**ï¼š
   - éƒ¨ç½²åæŒç»­ç›‘æ§æ—¥å¿— 5-10 åˆ†é’Ÿ
   - ç‰¹åˆ«å…³æ³¨ `NoneType` ç›¸å…³çš„é”™è¯¯

---

**å‡†å¤‡å°±ç»ªåï¼Œè¯·ç¡®è®¤æ˜¯å¦å¼€å§‹åŒæ­¥åˆ°ç”Ÿäº§ç¯å¢ƒã€‚**

