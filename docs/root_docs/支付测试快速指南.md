# 🚀 支付测试快速指南

## 5分钟实现支付成功

### 📋 前置条件

1. ✅ 主服务已启动 (端口 8001)
2. ✅ 已安装 stripe 库: `pip install stripe>=7.0.0`
3. ✅ 拥有Stripe测试密钥

---

## 🎯 方法1: 一键测试脚本（最简单）

### 步骤1: 获取Stripe测试密钥

访问: https://dashboard.stripe.com/test/apikeys

登录后复制 **Secret key** (以 `sk_test_` 开头)

### 步骤2: 设置环境变量并运行

```bash
# 设置Stripe密钥
export STRIPE_SECRET_KEY=sk_test_你的密钥

# 运行测试脚本
./test_payment_complete.sh
```

### 步骤3: 在浏览器中完成支付

脚本会自动打开支付页面，使用以下测试卡号：

```
卡号: 4242 4242 4242 4242
过期: 12/25
CVC:  123
邮编: 12345
```

点击"支付"即可！

---

## 🎯 方法2: curl命令行测试

### 第1步: 创建支付会话

```bash
curl -X POST http://127.0.0.1:8001/api/v1/payment/create-session \
  -H "Content-Type: application/json" \
  -d '{
    "amount": "19.90",
    "currency": "USD",
    "product_name": "月订阅会员",
    "customer_email": "test@example.com"
  }' | python3 -m json.tool
```

**返回示例**:
```json
{
  "success": true,
  "session_id": "cs_test_a1B2c3D4...",
  "checkout_url": "https://checkout.stripe.com/c/pay/cs_test_...",
  "status": "created",
  "message": "支付会话创建成功"
}
```

### 第2步: 在浏览器中打开支付链接

复制返回的 `checkout_url` 并在浏览器中打开

### 第3步: 使用测试卡号完成支付

```
卡号: 4242 4242 4242 4242
过期: 12/25
CVC:  123
邮编: 12345
```

### 第4步: 验证支付状态

```bash
curl -X POST http://127.0.0.1:8001/api/v1/payment/verify \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "cs_test_你的session_id"
  }' | python3 -m json.tool
```

**成功响应**:
```json
{
  "success": true,
  "status": "success",  ← 看到这个就成功了！
  "amount": "19.90",
  "currency": "USD"
}
```

---

## 🎯 方法3: 使用前端页面

### 步骤1: 启动前端

```bash
cd frontend
python3 -m http.server 8080
```

### 步骤2: 打开支付页面

访问: http://localhost:8080/third-party-services.html

### 步骤3: 填写支付表单

- **支付渠道**: Stripe (全球)
- **金额**: 19.90
- **货币**: USD (美元)
- **产品名称**: 月订阅会员
- **客户邮箱**: test@example.com

### 步骤4: 点击"创建支付"

会返回支付链接，点击跳转

### 步骤5: 完成支付

使用测试卡号完成支付

---

## 🎯 方法4: Swagger UI测试

### 步骤1: 访问API文档

http://127.0.0.1:8001/docs

### 步骤2: 测试创建支付

1. 找到 **payment** 标签
2. 展开 `POST /api/v1/payment/create-session`
3. 点击 "Try it out"
4. 填写参数:
   ```json
   {
     "amount": "19.90",
     "currency": "USD",
     "product_name": "月订阅会员",
     "customer_email": "test@example.com"
   }
   ```
5. 点击 "Execute"

### 步骤3: 完成支付

复制返回的 `checkout_url` 在浏览器中打开，使用测试卡号完成支付

### 步骤4: 验证支付

在Swagger UI中找到 `POST /api/v1/payment/verify`，填入 `session_id` 验证

---

## 💳 Stripe测试卡号大全

### 成功场景

```
卡号: 4242 4242 4242 4242
用途: 标准测试卡号，支付成功
```

### 需要3D验证

```
卡号: 4000 0027 6000 3184
用途: 测试3D Secure验证流程
```

### 失败场景

```
卡号: 4000 0000 0000 0002
用途: 测试支付失败（卡片被拒绝）

卡号: 4000 0000 0000 9995
用途: 测试余额不足
```

**通用填写信息**:
- 过期日期: 任意未来日期（如 `12/25`）
- CVC: 任意3位数字（如 `123`）
- 邮编: 任意5位数字（如 `12345`）

---

## ⚠️ 常见问题速查

### Q1: STRIPE_SECRET_KEY未配置

```bash
# 设置环境变量
export STRIPE_SECRET_KEY=sk_test_你的密钥

# 或创建.env文件
echo "STRIPE_SECRET_KEY=sk_test_你的密钥" >> .env
```

### Q2: 接口返回404

```bash
# 检查主服务
lsof -i:8001

# 重启服务
python server/start.py
```

### Q3: stripe库未安装

```bash
pip install stripe>=7.0.0
```

### Q4: 无法连接Stripe

- 检查网络连接
- 如在中国大陆，可能需要代理

---

## 📊 成功标志

看到以下任意一个就说明支付成功了：

1. **API返回**: `"status": "success"`
2. **浏览器显示**: "Payment successful" 或支付成功页面
3. **Stripe Dashboard**: 可以在测试模式下看到支付记录

---

## 🎉 测试成功后的下一步

1. ✅ 集成到实际业务流程
2. ✅ 配置支付成功/失败的回调页面
3. ✅ 设置Webhook接收支付事件
4. ✅ 添加更多支付渠道
5. ✅ 部署到生产环境（使用 `sk_live_` 密钥）

---

## 📚 相关文档

- 完整文档: `docs/支付接口完整分析.md`
- 原始指南: `docs/payment_test_guide.md`
- API文档: http://127.0.0.1:8001/docs

---

## 🆘 需要帮助？

1. 查看日志: `tail -f logs/main.log | grep payment`
2. 检查服务状态: `lsof -i:8001`
3. 查看完整错误信息在返回的JSON中

---

**最快捷的方式**: 运行 `./test_payment_complete.sh` 一键测试！

