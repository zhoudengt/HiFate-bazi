# 新功能使用指南 - LLM生成、对话、一事一卦

## 📋 目录

1. [LLM 生成模式（类似 FateTell）](#1-llm-生成模式类似-fatetell)
2. [对话接口（24/7 AI 对话）](#2-对话接口247-ai-对话)
3. [一事一卦功能](#3-一事一卦功能)
4. [今日运势分析（类似 FateTell 的日运日签）](#4-今日运势分析类似-fatetell-的日运日签)
5. [性能说明](#性能说明)
6. [场景对比](#场景对比)

---

## 1. LLM 生成模式（类似 FateTell）

### 🎯 功能说明

**LLM 生成模式**使用大语言模型直接生成完整的命理报告，而不是从规则库中匹配规则。

**与规则匹配模式的区别：**

| 特性 | 规则匹配模式 | LLM 生成模式 |
|------|------------|-------------|
| **生成方式** | 规则匹配 → 精选 → 拼装 | LLM 直接生成 |
| **个性化** | 中等（基于规则元数据） | 高（每次生成都不同） |
| **内容连贯性** | 片段拼接 | 整篇文章 |
| **成本** | 低（本地计算） | 高（需要调用 LLM） |
| **响应时间** | 快（<1秒） | 慢（5-15秒） |
| **可控性** | 高（规则可追溯） | 中（依赖 LLM 质量） |

### 📍 适用场景

✅ **适合使用 LLM 生成模式的场景：**
- 需要完全个性化的报告（每次生成都不同）
- 需要连贯的整篇文章（而非规则片段拼接）
- 需要结合用户具体问题生成针对性内容
- 用户愿意等待较长时间（5-15秒）

❌ **不适合使用 LLM 生成模式的场景：**
- 需要快速响应（<1秒）
- 需要严格控制成本
- 需要规则可追溯
- 需要批量生成报告

### 🔧 API 接口

**接口地址：** `POST /api/v1/bazi/llm-generate`

**请求示例：**

```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/llm-generate \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "user_question": "我想了解我的事业运势和财运"
  }'
```

**请求参数：**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `solar_date` | string | 是 | 阳历日期，格式：YYYY-MM-DD |
| `solar_time` | string | 是 | 出生时间，格式：HH:MM |
| `gender` | string | 是 | 性别：male(男) 或 female(女) |
| `user_question` | string | 否 | 用户问题或分析需求 |
| `access_token` | string | 否 | Coze Access Token（可选） |
| `bot_id` | string | 否 | Coze Bot ID（可选） |
| `api_base` | string | 否 | Coze API 基础URL（可选） |

**响应示例：**

```json
{
  "success": true,
  "report": "根据您的八字信息，我为您生成以下命理分析报告：\n\n【性格特点分析】\n您的日主为...\n\n【事业运势分析】\n从整体格局看...\n\n【财运分析】\n您的财运...\n\n...",
  "bazi_data": {
    "basic_info": {...},
    "bazi_pillars": {...},
    ...
  },
  "prompt_length": 1234,
  "report_length": 1567
}
```

### 📝 详细案例

#### 案例 1：生成完整命理报告

**场景：** 用户想要一份完整的、个性化的命理分析报告

**请求：**
```json
{
  "solar_date": "1990-05-15",
  "solar_time": "14:30",
  "gender": "male"
}
```

**响应：**
- 生成一份 800-1500 字的完整报告
- 包含：性格、事业、财运、感情、健康、流年等各个方面
- 每次生成的内容都不同（完全个性化）

#### 案例 2：针对特定问题生成报告

**场景：** 用户想了解事业运势

**请求：**
```json
{
  "solar_date": "1990-05-15",
  "solar_time": "14:30",
  "gender": "male",
  "user_question": "我想了解我的事业运势，适合什么行业？"
}
```

**响应：**
- 生成一份重点关注事业的分析报告
- 会结合用户的八字信息，给出具体的行业建议
- 内容更针对用户的问题

#### 案例 3：与规则匹配模式对比

**场景：** 同一个八字，对比两种模式

**规则匹配模式：**
```bash
POST /api/v1/bazi/rules/curated
```
- 响应时间：<1秒
- 返回：6-8条精选规则（去冲突、多样化）
- 内容：规则片段拼接

**LLM 生成模式：**
```bash
POST /api/v1/bazi/llm-generate
```
- 响应时间：5-15秒
- 返回：完整报告（800-1500字）
- 内容：LLM 生成的连贯文章

---

## 2. 对话接口（24/7 AI 对话）

### 🎯 功能说明

**对话接口**支持多轮对话，用户可以像与真人命理师聊天一样，随时提问并获得 AI 回复。

**特点：**
- ✅ 多轮对话：支持上下文记忆
- ✅ 24/7 可用：随时可以对话
- ✅ 个性化：基于用户的八字信息
- ✅ 上下文记忆：记住之前的对话内容

### 📍 适用场景

✅ **适合使用对话接口的场景：**
- 用户想要实时咨询（像聊天一样）
- 需要多轮交互（一个问题接一个问题）
- 需要基于之前的对话继续提问
- 需要个性化的建议和解答

❌ **不适合使用对话接口的场景：**
- 只需要一次性查询（不需要对话）
- 需要批量处理（对话是串行的）
- 需要快速响应（对话需要调用 LLM，较慢）

### 🔧 API 接口

#### 2.1 创建对话

**接口地址：** `POST /api/v1/bazi/chat/create`

**请求示例：**

```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/chat/create \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "user_name": "张三"
  }'
```

**响应示例：**

```json
{
  "success": true,
  "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
  "message": "对话已创建"
}
```

#### 2.2 发送消息

**接口地址：** `POST /api/v1/bazi/chat/send`

**请求示例：**

```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/chat/send \
  -H "Content-Type: application/json" \
  -d '{
    "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_message": "我想了解我的事业运势"
  }'
```

**响应示例：**

```json
{
  "success": true,
  "reply": "根据您的八字信息，您的日主为...，在事业方面...",
  "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
  "message_count": 3
}
```

#### 2.3 获取对话历史

**接口地址：** `GET /api/v1/bazi/chat/history/{conversation_id}`

**请求示例：**

```bash
curl http://127.0.0.1:8001/api/v1/bazi/chat/history/550e8400-e29b-41d4-a716-446655440000
```

**响应示例：**

```json
{
  "success": true,
  "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
  "messages": [
    {
      "role": "system",
      "content": "你是一位资深的命理师...",
      "timestamp": "2025-01-XXT10:00:00"
    },
    {
      "role": "user",
      "content": "我想了解我的事业运势",
      "timestamp": "2025-01-XXT10:01:00"
    },
    {
      "role": "assistant",
      "content": "根据您的八字信息...",
      "timestamp": "2025-01-XXT10:01:05"
    }
  ],
  "created_at": "2025-01-XXT10:00:00",
  "updated_at": "2025-01-XXT10:01:05"
}
```

#### 2.4 删除对话

**接口地址：** `DELETE /api/v1/bazi/chat/{conversation_id}`

**请求示例：**

```bash
curl -X DELETE http://127.0.0.1:8001/api/v1/bazi/chat/550e8400-e29b-41d4-a716-446655440000
```

### 📝 详细案例

#### 案例 1：多轮对话咨询

**场景：** 用户想要像与真人命理师聊天一样，逐步了解自己的运势

**步骤 1：创建对话**
```bash
POST /api/v1/bazi/chat/create
{
  "solar_date": "1990-05-15",
  "solar_time": "14:30",
  "gender": "male"
}
```
返回：`conversation_id = "abc123"`

**步骤 2：第一轮对话**
```bash
POST /api/v1/bazi/chat/send
{
  "conversation_id": "abc123",
  "user_message": "我想了解我的事业运势"
}
```
AI 回复：根据您的八字，您在事业方面...

**步骤 3：第二轮对话（基于第一轮）**
```bash
POST /api/v1/bazi/chat/send
{
  "conversation_id": "abc123",
  "user_message": "那我适合什么行业呢？"
}
```
AI 回复：结合您刚才提到的...（会记住第一轮的对话）

**步骤 4：第三轮对话**
```bash
POST /api/v1/bazi/chat/send
{
  "conversation_id": "abc123",
  "user_message": "我的财运怎么样？"
}
```
AI 回复：从您的八字看，财运方面...（会结合之前的对话）

#### 案例 2：对话上下文记忆

**场景：** 验证对话是否记住了之前的对话内容

**对话流程：**

1. 用户："我想了解我的事业运势"
   - AI："根据您的八字，您在事业方面..."

2. 用户："那我适合什么行业呢？"
   - AI："结合您刚才提到的...（会引用第一轮的内容）"

3. 用户："我的财运怎么样？"
   - AI："从您的八字看，财运方面...（会结合之前的对话）"

**关键点：** AI 会记住之前的对话内容，可以基于上下文回答

#### 案例 3：不同用户的不同对话

**场景：** 多个用户同时使用对话功能

**用户 A：**
- `conversation_id = "conv_a"`
- 对话内容：关于事业运势

**用户 B：**
- `conversation_id = "conv_b"`
- 对话内容：关于感情婚姻

**关键点：** 每个用户有独立的对话上下文，互不干扰

---

## 3. 一事一卦功能

### 🎯 功能说明

**一事一卦**基于《周易》六十四卦进行占卜，用户提出一个问题，系统会从六十四卦中抽取一卦，并给出解读和建议。

**特点：**
- ✅ 传统：基于《周易》六十四卦
- ✅ 快速：本地计算，无需调用 LLM（<100ms）
- ✅ 确定性：相同问题在同一时间会得到相同结果
- ✅ 成本低：完全本地计算，无额外成本

### 📍 适用场景

✅ **适合使用一事一卦的场景：**
- 需要快速占卜（<100ms）
- 需要决策参考
- 需要运势占卜
- 需要问题咨询
- 需要低成本解决方案

❌ **不适合使用一事一卦的场景：**
- 需要详细的命理分析（一事一卦是简化的占卜）
- 需要结合八字信息（一事一卦不依赖八字）
- 需要个性化解读（一事一卦是标准化的）

### 🔧 API 接口

#### 3.1 占卜

**接口地址：** `POST /api/v1/bazi/yigua/divinate`

**请求示例：**

```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/yigua/divinate \
  -H "Content-Type: application/json" \
  -d '{
    "question": "我这次投资能成功吗？"
  }'
```

**请求参数：**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `question` | string | 是 | 要占卜的问题 |
| `timestamp` | string | 否 | 时间戳（可选，ISO格式） |

**响应示例：**

```json
{
  "success": true,
  "question": "我这次投资能成功吗？",
  "gua": {
    "number": 11,
    "name": "泰",
    "pinyin": "tài",
    "meaning": "天地",
    "description": "小往大来，吉亨"
  },
  "interpretation": "【卦象】泰卦（tài）\n【卦数】第11卦\n【卦象含义】天地\n【卦辞】小往大来，吉亨\n\n【解读】\n根据您的问题「我这次投资能成功吗？」，抽得泰卦。\n此卦象为天地，卦辞为「小往大来，吉亨」。\n\n【建议】\n此卦较为吉利，建议积极行动，把握时机。\n\n【注意事项】\n以上解读仅供参考，具体决策还需结合实际情况。\n占卜结果不应作为唯一依据，理性思考更为重要。",
  "timestamp": "2025-01-XXT10:00:00"
}
```

#### 3.2 获取六十四卦列表

**接口地址：** `GET /api/v1/bazi/yigua/list`

**请求示例：**

```bash
curl http://127.0.0.1:8001/api/v1/bazi/yigua/list
```

**响应示例：**

```json
{
  "success": true,
  "total": 64,
  "gua_list": [
    {
      "number": 1,
      "name": "乾",
      "pinyin": "qián",
      "meaning": "天",
      "description": "元亨利贞"
    },
    ...
  ]
}
```

### 📝 详细案例

#### 案例 1：投资决策占卜

**场景：** 用户想要投资，但不确定是否应该投资

**请求：**
```json
{
  "question": "我这次投资能成功吗？"
}
```

**响应：**
- 抽得：**泰卦**（第11卦）
- 卦辞：小往大来，吉亨
- 解读：此卦较为吉利，建议积极行动，把握时机

**用户决策：** 根据卦象，可以考虑投资，但需要谨慎评估风险

#### 案例 2：感情问题占卜

**场景：** 用户想知道与某人的感情发展

**请求：**
```json
{
  "question": "我和他的感情会有结果吗？"
}
```

**响应：**
- 抽得：**咸卦**（第31卦）
- 卦辞：亨，利贞，取女吉
- 解读：此卦中性，建议保持平衡，顺势而为

**用户决策：** 感情发展需要时间和耐心，不要急于求成

#### 案例 3：事业选择占卜

**场景：** 用户面临两个工作机会，不知道选择哪个

**请求：**
```json
{
  "question": "我应该选择A公司还是B公司？"
}
```

**响应：**
- 抽得：**晋卦**（第35卦）
- 卦辞：康侯用锡马蕃庶，昼日三接
- 解读：此卦较为吉利，建议积极行动，把握时机

**用户决策：** 可以考虑选择，但需要结合实际情况（薪资、发展前景等）

#### 案例 4：确定性验证

**场景：** 验证相同问题在同一时间会得到相同结果

**请求 1：**
```json
{
  "question": "我这次投资能成功吗？",
  "timestamp": "2025-01-XXT10:00:00"
}
```
结果：**泰卦**（第11卦）

**请求 2（相同问题，相同时间）：**
```json
{
  "question": "我这次投资能成功吗？",
  "timestamp": "2025-01-XXT10:00:00"
}
```
结果：**泰卦**（第11卦）✅ 相同

**请求 3（相同问题，不同时间）：**
```json
{
  "question": "我这次投资能成功吗？",
  "timestamp": "2025-01-XXT11:00:00"
}
```
结果：可能不同（因为时间不同，增加了随机性）

---

## 4. 今日运势分析（类似 FateTell 的日运日签）

### 🎯 功能说明

**今日运势分析**结合用户的八字信息和当前日期（或指定日期），分析该日的运势，包括事业、财运、感情、健康等各个方面。

**特点：**
- ✅ 结合流年、流月、流日信息
- ✅ 分析多个方面（事业、财运、感情、健康）
- ✅ 支持规则匹配和 LLM 生成两种模式
- ✅ 快速响应（规则匹配模式 <1秒）
- ✅ 可以查询任意日期的运势（不限于今天）

### 📍 适用场景

✅ **适合使用今日运势分析的场景：**
- 每日运势查询（类似"日运日签"）
- 特定日期运势分析（如重要决策日）
- 决策参考（了解某一天的运势）
- 需要快速响应（规则匹配模式）

❌ **不适合使用今日运势分析的场景：**
- 需要详细的长期运势分析（建议使用详细八字分析）
- 需要完全个性化的内容（可以使用 LLM 生成模式）

### 🔧 API 接口

**接口地址：** `POST /api/v1/bazi/daily-fortune`

**请求示例：**

```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/daily-fortune \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male",
    "target_date": "2025-01-17"
  }'
```

**请求参数：**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `solar_date` | string | 是 | 用户出生日期（阳历），格式：YYYY-MM-DD |
| `solar_time` | string | 是 | 用户出生时间，格式：HH:MM |
| `gender` | string | 是 | 性别：male(男) 或 female(女) |
| `target_date` | string | 否 | 目标日期（可选，默认为今天），格式：YYYY-MM-DD |
| `use_llm` | boolean | 否 | 是否使用 LLM 生成（可选，默认使用规则匹配） |
| `access_token` | string | 否 | Coze Access Token（可选，use_llm=True 时需要） |
| `bot_id` | string | 否 | Coze Bot ID（可选，use_llm=True 时需要） |

**响应示例：**

```json
{
  "success": true,
  "target_date": "2025-01-17",
  "fortune": {
    "text": "【2025年01月17日运势分析】\n============================================================\n\n流日：甲子\n流月：丁丑\n流年：乙巳\n\n【今日运势】\n1. 今日运势平稳，建议保持积极心态...\n\n【分类运势】\n\n📈 事业运势：\n  今日事业运势平稳，适合处理常规工作。\n\n💰 财运：\n  今日财运平稳，建议理性消费。\n\n💕 感情运势：\n  今日感情运势平稳，适合与伴侣沟通交流。\n\n🏥 健康运势：\n  今日健康运势平稳，注意劳逸结合。\n\n【今日建议】\n1. 保持积极心态，把握机会\n2. 注意劳逸结合，保持健康\n3. 理性决策，避免冲动\n\n以上分析仅供参考，具体决策还需结合实际情况。",
    "summary": "2025年01月17日运势分析",
    "categories": {
      "career": "今日事业运势平稳，适合处理常规工作。",
      "wealth": "今日财运平稳，建议理性消费。",
      "love": "今日感情运势平稳，适合与伴侣沟通交流。",
      "health": "今日健康运势平稳，注意劳逸结合。"
    }
  },
  "liuri_info": {
    "date": "2025-01-17",
    "liuri": "甲子",
    "liuyue": "丁丑",
    "liunian": "乙巳"
  },
  "matched_rules_count": 5
}
```

### 📝 详细案例

#### 案例 1：查询今日运势

**场景：** 用户每天早上想查看今天的运势

**请求：**
```json
{
  "solar_date": "1990-05-15",
  "solar_time": "14:30",
  "gender": "male"
}
```
（不指定 `target_date`，默认使用今天）

**响应：**
- 返回今天的运势分析
- 包含流日、流月、流年信息
- 分析事业、财运、感情、健康等各个方面
- 提供今日建议

#### 案例 2：查询特定日期运势

**场景：** 用户想知道某个重要日期的运势（如面试日、签约日）

**请求：**
```json
{
  "solar_date": "1990-05-15",
  "solar_time": "14:30",
  "gender": "male",
  "target_date": "2025-02-14"
}
```

**响应：**
- 返回 2025-02-14 的运势分析
- 结合该日的流日信息
- 给出该日的建议

#### 案例 3：使用 LLM 生成模式

**场景：** 用户想要更个性化的运势分析

**请求：**
```json
{
  "solar_date": "1990-05-15",
  "solar_time": "14:30",
  "gender": "male",
  "use_llm": true
}
```

**响应：**
- 使用 LLM 生成更个性化的运势分析
- 内容更自然流畅
- 响应时间较长（5-15秒）

#### 案例 4：每日运势查询（类似"日运日签"）

**场景：** 用户每天固定时间查询运势（类似 FateTell 的"日运日签"）

**使用方式：**
1. 每天早上调用接口查询今日运势
2. 可以缓存结果，避免重复计算
3. 可以结合推送功能，定时发送运势

**示例代码：**
```python
# 每天查询今日运势
import requests

def get_daily_fortune(solar_date, solar_time, gender):
    response = requests.post(
        "http://127.0.0.1:8001/api/v1/bazi/daily-fortune",
        json={
            "solar_date": solar_date,
            "solar_time": solar_time,
            "gender": gender
        }
    )
    return response.json()

# 使用
fortune = get_daily_fortune("1990-05-15", "14:30", "male")
print(fortune['fortune']['text'])
```

---

## 性能说明

### ⚡ 性能对比

| 功能 | 响应时间 | 成本 | 并发能力 |
|------|---------|------|---------|
| **规则匹配模式** | <1秒 | 低（本地计算） | 高（可并发） |
| **LLM 生成模式** | 5-15秒 | 高（需要调用 LLM） | 中（受 LLM 限制） |
| **对话接口** | 5-15秒/轮 | 高（需要调用 LLM） | 中（受 LLM 限制） |
| **一事一卦** | <100ms | 低（本地计算） | 高（可并发） |
| **今日运势分析**（规则匹配） | <1秒 | 低（本地计算） | 高（可并发） |
| **今日运势分析**（LLM生成） | 5-15秒 | 高（需要调用 LLM） | 中（受 LLM 限制） |

### 🚀 性能优化措施

1. **异步处理**：所有新功能都使用异步处理，不阻塞主线程
2. **线程池**：使用线程池处理 CPU 密集型任务
3. **缓存**：对话上下文使用 Redis 或内存缓存
4. **可选功能**：所有新功能都是可选的，不影响现有功能
5. **降级方案**：Redis 不可用时自动降级到内存存储

### 📊 性能影响

**对现有服务的影响：**
- ✅ **无影响**：所有新功能都是独立的，不影响现有接口
- ✅ **可选**：如果不需要新功能，可以不启用
- ✅ **异步**：新功能使用异步处理，不阻塞现有服务

**资源消耗：**
- **LLM 生成模式**：每次调用需要 5-15秒，消耗 LLM API 配额
- **对话接口**：每次对话需要 5-15秒，消耗 LLM API 配额
- **一事一卦**：几乎无资源消耗（本地计算）

---

## 场景对比

### 📋 功能选择指南

| 场景 | 推荐功能 | 原因 |
|------|---------|------|
| **需要快速响应（<1秒）** | 规则匹配模式 | 响应快，成本低 |
| **需要完全个性化** | LLM 生成模式 | 每次生成都不同 |
| **需要连贯文章** | LLM 生成模式 | 整篇文章，非片段拼接 |
| **需要实时咨询** | 对话接口 | 像聊天一样，多轮交互 |
| **需要快速占卜** | 一事一卦 | <100ms，成本低 |
| **需要决策参考** | 一事一卦 | 传统占卜，快速 |
| **需要结合八字** | LLM 生成模式 / 对话接口 | 基于八字信息 |
| **需要规则可追溯** | 规则匹配模式 | 每条规则有来源 |
| **需要每日运势** | 今日运势分析 | 结合流日信息，快速 |
| **需要特定日期运势** | 今日运势分析 | 可指定任意日期 |

### 🎯 组合使用建议

**场景 1：完整命理服务**
1. 使用 **规则匹配模式** 快速获取基础分析（<1秒）
2. 使用 **LLM 生成模式** 生成完整报告（5-15秒）
3. 使用 **对话接口** 进行深入咨询（多轮对话）
4. 使用 **一事一卦** 进行快速占卜（<100ms）

**场景 2：快速咨询**
1. 使用 **一事一卦** 快速占卜（<100ms）
2. 使用 **规则匹配模式** 获取基础分析（<1秒）

**场景 3：深度分析**
1. 使用 **LLM 生成模式** 生成完整报告（5-15秒）
2. 使用 **对话接口** 进行深入咨询（多轮对话）

**场景 4：每日运势服务**
1. 使用 **今日运势分析** 查询每日运势（<1秒）
2. 可以定时推送，类似"日运日签"
3. 可以查询任意日期的运势

---

## 总结

### ✅ 已完成的功能

1. **LLM 生成模式**：类似 FateTell 的实时生成
2. **对话接口**：24/7 AI 对话功能
3. **一事一卦**：基于《周易》六十四卦的占卜
4. **今日运势分析**：类似 FateTell 的"日运日签"功能

### 🎯 核心优势

1. **不影响现有性能**：所有新功能都是可选的、异步的
2. **灵活选择**：用户可以根据场景选择合适的功能
3. **成本可控**：一事一卦和规则匹配模式成本低，LLM 功能可选
4. **易于扩展**：所有功能都是模块化的，易于维护和扩展

### 📚 下一步

1. 测试所有新功能
2. 根据用户反馈优化
3. 考虑增加更多功能（如"日运日签"）

---

**文档版本：** v1.0  
**最后更新：** 2025-01-XX  
**维护者：** 开发团队

