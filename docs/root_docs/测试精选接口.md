# 测试精选接口和限流功能

## 问题已解决

1. ✅ **PyJWT 已安装**（用于 JWT 令牌生成）
2. ✅ **测试脚本已创建**（`test_curated_api.py`，不依赖 jq）
3. ✅ **服务器端口**：8001（不是 8000）

## 快速测试步骤

### 1. 启动服务器

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
python server/start.py
```

或者使用虚拟环境：

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
source .venv/bin/activate
python server/start.py
```

服务器会在 **端口 8001** 启动。

### 2. 运行测试脚本（推荐）

在**另一个终端**运行：

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
python test_curated_api.py
```

或者使用虚拟环境：

```bash
cd /Users/zhoudt/Downloads/project/HiFate-bazi
.venv/bin/python test_curated_api.py
```

### 3. 手动测试（使用 curl，不依赖 jq）

#### 步骤 1：登录获取 token

```bash
# 登录（注意端口是 8001）
RESPONSE=$(curl -s -X POST http://127.0.0.1:8001/api/v1/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"admin","password":"admin123"}')

# 提取 token（使用 Python，不依赖 jq）
TOKEN=$(python3 -c "import sys, json; print(json.load(sys.stdin)['access_token'])" <<< "$RESPONSE")

echo "Token: $TOKEN"
```

#### 步骤 2：测试精选接口

```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/rules/curated \
  -H "Authorization: Bearer $TOKEN" \
  -H 'Content-Type: application/json' \
  -d '{
    "solar_date":"1990-05-15",
    "solar_time":"14:30",
    "gender":"male",
    "k":6,
    "use_nlg":false
  }'
```

#### 步骤 3：测试限流（快速发送31次请求）

```bash
# 快速发送31次请求，第31次应该被限流
for i in {1..31}; do
  echo "请求 $i"
  curl -s -X POST http://127.0.0.1:8001/api/v1/bazi/rules/curated \
    -H "Authorization: Bearer $TOKEN" \
    -H 'Content-Type: application/json' \
    -d '{"solar_date":"1990-05-15","solar_time":"14:30","gender":"male","k":6}' \
    | python3 -c "import sys, json; r=json.load(sys.stdin); print('成功' if r.get('success') else r.get('detail', '未知错误'))"
  sleep 0.1
done
```

第31次请求应该返回：
```json
{"detail": "请求过于频繁，每分钟最多30次，请稍后再试"}
```

## 预期结果

### 正常请求（前30次）
- 状态码：200
- 返回：`{"success": true, "rule_count": 6, "curated_rules": [...]}`

### 限流触发（第31次）
- 状态码：429
- 返回：`{"detail": "请求过于频繁，每分钟最多30次，请稍后再试"}`

## 注意事项

1. **端口**：服务器运行在 **8001**，不是 8000
2. **环境变量**：确保设置了 `JWT_SECRET`（如果没有，会使用默认值）
3. **slowapi**：如果未安装 slowapi，限流功能会自动跳过（不影响其他功能）

## 故障排查

### 问题：连接失败
- 检查服务器是否启动：`lsof -ti:8001`
- 检查日志：`tail -f logs/web_app_8001.log`

### 问题：登录失败
- 检查环境变量：`ADMIN_USERNAME` 和 `ADMIN_PASSWORD`（默认：admin/admin123）
- 检查 JWT_SECRET 是否设置

### 问题：限流不工作
- 检查 slowapi 是否安装：`pip list | grep slowapi`
- 如果未安装：`pip install slowapi`

