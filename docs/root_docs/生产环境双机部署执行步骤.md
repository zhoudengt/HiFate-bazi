# ç”Ÿäº§çŽ¯å¢ƒåŒæœºéƒ¨ç½²æ‰§è¡Œæ­¥éª¤

## ðŸ“‹ çŽ¯å¢ƒä¿¡æ¯

- **Node1**: å…¬ç½‘ `8.210.52.217` / ç§ç½‘ `172.18.121.222`
- **Node2**: å…¬ç½‘ `47.243.160.43` / ç§ç½‘ `172.18.121.223`
- **MySQL å¯†ç **: `Yuanqizhan@163`
- **Git ä»“åº“**: `https://github.com/zhoudengt/HiFate-bazi`
- **SECRET_KEY**: `kx9078L34ZoROnneJu8fMmJ70JImvVan88JYvxiewbE`

---

## ðŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: éƒ¨ç½² Node1ï¼ˆä¸»èŠ‚ç‚¹ï¼‰

**1.1 ç™»å½• Node1**
```bash
ssh root@8.210.52.217
```

**1.2 ä¸Šä¼ éƒ¨ç½²è„šæœ¬**
```bash
# åœ¨æœ¬åœ°æ‰§è¡Œï¼ˆä»Žé¡¹ç›®ç›®å½•ï¼‰
scp deploy/scripts/deploy_production_manual.sh root@8.210.52.217:/root/
scp deploy/scripts/init-ecs.sh root@8.210.52.217:/root/
scp deploy/scripts/deploy.sh root@8.210.52.217:/root/
```

**1.3 åœ¨ Node1 ä¸Šæ‰§è¡Œéƒ¨ç½²**
```bash
# åœ¨ Node1 ä¸Šæ‰§è¡Œ
cd /root
bash deploy_production_manual.sh
# å½“æç¤ºèŠ‚ç‚¹ç±»åž‹æ—¶ï¼Œè¾“å…¥ï¼šnode1
```

**æˆ–è€…æ‰‹åŠ¨æ‰§è¡Œ**ï¼š
```bash
# 1. åˆå§‹åŒ–ï¼ˆå®‰è£… Dockerï¼‰
bash init-ecs.sh

# 2. å…‹éš†ä»£ç 
mkdir -p /opt/HiFate-bazi
cd /opt/HiFate-bazi
git clone https://github.com/zhoudengt/HiFate-bazi .

# 3. é…ç½®çŽ¯å¢ƒå˜é‡
cat > .env << 'EOF'
NODE_ID=node1
NODE1_IP=172.18.121.222
NODE2_IP=172.18.121.223
ACR_REGISTRY=registry.cn-hangzhou.aliyuncs.com
ACR_NAMESPACE=hifate
ACR_USERNAME=${ACR_USERNAME:-${ACR_ACCESS_KEY_ID}}  # ä»ŽçŽ¯å¢ƒå˜é‡è¯»å–
ACR_PASSWORD=${ACR_PASSWORD:-${ACR_ACCESS_KEY_SECRET}}  # ä»ŽçŽ¯å¢ƒå˜é‡è¯»å–
IMAGE_TAG=latest
MYSQL_USER=root
MYSQL_PASSWORD=Yuanqizhan@163
MYSQL_DATABASE=hifate_bazi
MYSQL_REPL_PASSWORD=Yuanqizhan@163
REDIS_PASSWORD=
SECRET_KEY=kx9078L34ZoROnneJu8fMmJ70JImvVan88JYvxiewbE
EOF

# 4. éƒ¨ç½²
bash deploy/scripts/deploy.sh node1
```

**1.4 é…ç½® MySQL ä¸»ä»Žå¤åˆ¶ç”¨æˆ·**
```bash
docker exec -it hifate-mysql-master mysql -uroot -pYuanqizhan@163

# åœ¨ MySQL ä¸­æ‰§è¡Œï¼š
CREATE USER 'repl'@'%' IDENTIFIED BY 'Yuanqizhan@163';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;
SHOW MASTER STATUS;
exit;
```

---

### æ­¥éª¤ 2: éƒ¨ç½² Node2ï¼ˆä»ŽèŠ‚ç‚¹ï¼‰

**2.1 ç™»å½• Node2**
```bash
ssh root@47.243.160.43
```

**2.2 ä¸Šä¼ éƒ¨ç½²è„šæœ¬**
```bash
# åœ¨æœ¬åœ°æ‰§è¡Œï¼ˆä»Žé¡¹ç›®ç›®å½•ï¼‰
scp deploy/scripts/deploy_production_manual.sh root@47.243.160.43:/root/
scp deploy/scripts/init-ecs.sh root@47.243.160.43:/root/
scp deploy/scripts/deploy.sh root@47.243.160.43:/root/
```

**2.3 åœ¨ Node2 ä¸Šæ‰§è¡Œéƒ¨ç½²**
```bash
# åœ¨ Node2 ä¸Šæ‰§è¡Œ
cd /root
bash deploy_production_manual.sh
# å½“æç¤ºèŠ‚ç‚¹ç±»åž‹æ—¶ï¼Œè¾“å…¥ï¼šnode2
```

**æˆ–è€…æ‰‹åŠ¨æ‰§è¡Œ**ï¼š
```bash
# 1. åˆå§‹åŒ–ï¼ˆå®‰è£… Dockerï¼‰
bash init-ecs.sh

# 2. å…‹éš†ä»£ç 
mkdir -p /opt/HiFate-bazi
cd /opt/HiFate-bazi
git clone https://github.com/zhoudengt/HiFate-bazi .

# 3. é…ç½®çŽ¯å¢ƒå˜é‡
cat > .env << 'EOF'
NODE_ID=node2
NODE1_IP=172.18.121.222
NODE2_IP=172.18.121.223
ACR_REGISTRY=registry.cn-hangzhou.aliyuncs.com
ACR_NAMESPACE=hifate
ACR_USERNAME=${ACR_USERNAME:-${ACR_ACCESS_KEY_ID}}  # ä»ŽçŽ¯å¢ƒå˜é‡è¯»å–
ACR_PASSWORD=${ACR_PASSWORD:-${ACR_ACCESS_KEY_SECRET}}  # ä»ŽçŽ¯å¢ƒå˜é‡è¯»å–
IMAGE_TAG=latest
MYSQL_USER=root
MYSQL_PASSWORD=Yuanqizhan@163
MYSQL_DATABASE=hifate_bazi
MYSQL_REPL_PASSWORD=Yuanqizhan@163
REDIS_PASSWORD=
SECRET_KEY=kx9078L34ZoROnneJu8fMmJ70JImvVan88JYvxiewbE
EOF

# 4. éƒ¨ç½²
bash deploy/scripts/deploy.sh node2
```

**2.4 é…ç½® MySQL ä»Žåº“**
```bash
docker exec -it hifate-mysql-slave mysql -uroot -pYuanqizhan@163

# åœ¨ MySQL ä¸­æ‰§è¡Œï¼š
CHANGE MASTER TO
    MASTER_HOST='172.18.121.222',
    MASTER_USER='repl',
    MASTER_PASSWORD='Yuanqizhan@163',
    MASTER_AUTO_POSITION=1;
START SLAVE;
SHOW SLAVE STATUS\G
# ç¡®è®¤ Slave_IO_Running å’Œ Slave_SQL_Running éƒ½æ˜¯ Yes
exit;
```

---

### æ­¥éª¤ 3: éªŒè¯éƒ¨ç½²

**3.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€**
```bash
# Node1
ssh root@8.210.52.217 "docker ps | grep hifate"

# Node2
ssh root@47.243.160.43 "docker ps | grep hifate"
```

**3.2 æ£€æŸ¥å¥åº·çŠ¶æ€**
```bash
# Node1
curl http://8.210.52.217/health
curl http://8.210.52.217:8001/health

# Node2
curl http://47.243.160.43/health
curl http://47.243.160.43:8001/health
```

**3.3 æ£€æŸ¥ MySQL ä¸»ä»Žå¤åˆ¶**
```bash
ssh root@47.243.160.43 "docker exec -i hifate-mysql-slave mysql -uroot -pYuanqizhan@163 -e \"SHOW SLAVE STATUS\\G\" | grep -E 'Slave_IO_Running|Slave_SQL_Running'"
```

**3.4 æ£€æŸ¥ Redis ä¸»ä»Žå¤åˆ¶**
```bash
# Node1ï¼ˆä¸»åº“ï¼‰
ssh root@8.210.52.217 "docker exec -it hifate-redis-master redis-cli INFO replication"

# Node2ï¼ˆä»Žåº“ï¼‰
ssh root@47.243.160.43 "docker exec -it hifate-redis-slave redis-cli INFO replication"
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸è¦æ“ä½œæµ‹è¯•çŽ¯å¢ƒ**ï¼šæ‰€æœ‰æ“ä½œéƒ½åœ¨ç”Ÿäº§çŽ¯å¢ƒçš„ Node1 å’Œ Node2 ä¸Šï¼Œä¸è¦å½±å“æµ‹è¯•çŽ¯å¢ƒ `123.57.216.15`
2. **å®‰å…¨ç»„é…ç½®**ï¼šç¡®ä¿ä¸¤å°æœºå™¨ä¹‹é—´å¯ä»¥äº’ç›¸è®¿é—®ï¼ˆå†…ç½‘äº’é€šï¼‰
3. **ç«¯å£å¼€æ”¾**ï¼šç¡®ä¿å®‰å…¨ç»„å¼€æ”¾äº† 80, 443, 22, 3306, 6379 ç«¯å£
4. **MySQL ä¸»ä»Žå¤åˆ¶**ï¼šç¡®ä¿ Node2 å¯ä»¥è®¿é—® Node1 çš„ MySQLï¼ˆå†…ç½‘ IP: 3306ï¼‰
5. **Redis ä¸»ä»Žå¤åˆ¶**ï¼šç¡®ä¿ Node2 å¯ä»¥è®¿é—® Node1 çš„ Redisï¼ˆå†…ç½‘ IP: 6379ï¼‰

---

## ðŸ” æ•…éšœæŽ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker logs hifate-web
docker logs hifate-mysql-master
docker logs hifate-redis-master

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker ps -a
```

### MySQL ä¸»ä»Žå¤åˆ¶å¤±è´¥
```bash
# æ£€æŸ¥ä»Žåº“çŠ¶æ€
docker exec -it hifate-mysql-slave mysql -uroot -pYuanqizhan@163 -e "SHOW SLAVE STATUS\G"

# æ£€æŸ¥ç½‘ç»œè¿žæŽ¥
docker exec -it hifate-mysql-slave ping 172.18.121.222
```

### é•œåƒæ‹‰å–å¤±è´¥
```bash
# æ‰‹åŠ¨ç™»å½• ACR
docker login registry.cn-hangzhou.aliyuncs.com -u ${ACR_USERNAME:-${ACR_ACCESS_KEY_ID}}
# è¾“å…¥å¯†ç ï¼š${ACR_PASSWORD:-${ACR_ACCESS_KEY_SECRET}}

# æ‰‹åŠ¨æ‹‰å–é•œåƒ
docker pull registry.cn-hangzhou.aliyuncs.com/hifate/hifate-bazi:latest
```

---

**æœ€åŽæ›´æ–°**ï¼š2025-01-21

