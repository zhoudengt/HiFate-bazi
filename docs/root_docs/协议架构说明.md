# åè®®æ¶æ„è¯´æ˜

## ğŸ“‹ ç›®å½•

1. [å†…éƒ¨æœåŠ¡é—´è°ƒç”¨åè®®](#1-å†…éƒ¨æœåŠ¡é—´è°ƒç”¨åè®®)
2. [å‰ç«¯æ¥å£åè®®](#2-å‰ç«¯æ¥å£åè®®)
3. [å¤–éƒ¨æœåŠ¡è°ƒç”¨åè®®](#3-å¤–éƒ¨æœåŠ¡è°ƒç”¨åè®®)
4. [åè®®å¯¹æ¯”](#4-åè®®å¯¹æ¯”)
5. [æ¶æ„å›¾](#5-æ¶æ„å›¾)

---

## 1. å†…éƒ¨æœåŠ¡é—´è°ƒç”¨åè®®

### 1.1 ä½¿ç”¨åè®®ï¼š**gRPC**

**è¯´æ˜ï¼š** å†…éƒ¨å¾®æœåŠ¡ä¹‹é—´ä½¿ç”¨ **gRPC** åè®®è¿›è¡Œé€šä¿¡ã€‚

### 1.2 æœåŠ¡åˆ—è¡¨

| æœåŠ¡åç§° | å®¢æˆ·ç«¯ç±» | é»˜è®¤ç«¯å£ | åŠŸèƒ½è¯´æ˜ |
|---------|---------|---------|---------|
| **bazi-core-service** | `BaziCoreClient` | 9001 | å…«å­—æ ¸å¿ƒè®¡ç®—æœåŠ¡ï¼šè®¡ç®—å…«å­—æ’ç›˜ï¼ˆå››æŸ±ã€ç¥ç…ã€åç¥ç­‰åŸºç¡€ä¿¡æ¯ï¼‰ |
| **bazi-fortune-service** | `BaziFortuneClient` | 9002 | å¤§è¿æµå¹´è®¡ç®—æœåŠ¡ï¼šè®¡ç®—å¤§è¿ã€æµå¹´ã€æµæœˆç­‰è¿åŠ¿å‘¨æœŸ |
| **bazi-analyzer-service** | `BaziAnalyzerClient` | 9003 | å…«å­—åˆ†ææœåŠ¡ï¼šæ‰§è¡Œå„ç§åˆ†æå™¨ï¼ˆå¦‚æ—¥æŸ±æ€§åˆ«åˆ†æç­‰ï¼‰ |
| **bazi-rule-service** | `BaziRuleClient` | 9004 | è§„åˆ™åŒ¹é…æœåŠ¡ï¼šåŒ¹é…å…«å­—è§„åˆ™ï¼ˆå©šå§»ã€æ¡ƒèŠ±ç­‰462+æ¡è§„åˆ™ï¼‰ |
| **fortune-analysis-service** | `FortuneAnalysisClient` | 9005 | é¢ç›¸æ‰‹ç›¸åˆ†ææœåŠ¡ï¼šæ‰‹ç›¸å’Œé¢ç›¸å›¾åƒåˆ†æï¼Œç”Ÿæˆå‘½ç†æŠ¥å‘Š |
| **payment-service** | `PaymentClient` | 9006 | æ”¯ä»˜æœåŠ¡ï¼šStripeæ”¯ä»˜é›†æˆï¼Œåˆ›å»ºæ”¯ä»˜ä¼šè¯å’ŒéªŒè¯æ”¯ä»˜çŠ¶æ€ |
| **fortune-rule-service** | `FortuneRuleClient` | 9007 | é¢ç›¸æ‰‹ç›¸è§„åˆ™æœåŠ¡ï¼šé¢ç›¸æ‰‹ç›¸è§„åˆ™åŒ¹é…å’Œå…«å­—èåˆåˆ†æ |

### 1.3 ä»£ç ä½ç½®

**å®¢æˆ·ç«¯å®ç°ï¼š**
- `src/clients/bazi_core_client_grpc.py` - bazi-core-service å®¢æˆ·ç«¯ï¼ˆç«¯å£ 9001ï¼‰
- `src/clients/bazi_fortune_client_grpc.py` - bazi-fortune-service å®¢æˆ·ç«¯ï¼ˆç«¯å£ 9002ï¼‰
- `src/clients/bazi_analyzer_client_grpc.py` - bazi-analyzer-service å®¢æˆ·ç«¯ï¼ˆç«¯å£ 9003ï¼‰
- `src/clients/bazi_rule_client_grpc.py` - bazi-rule-service å®¢æˆ·ç«¯ï¼ˆç«¯å£ 9004ï¼‰
- `services/fortune_analysis/fortune_rule_client.py` - fortune-rule-service å®¢æˆ·ç«¯ï¼ˆç«¯å£ 9007ï¼‰

**æœåŠ¡ç«¯å®ç°ï¼š**
- `services/bazi_core/grpc_server.py` - bazi-core-service æœåŠ¡ç«¯ï¼ˆç«¯å£ 9001ï¼‰
- `services/bazi_fortune/grpc_server.py` - bazi-fortune-service æœåŠ¡ç«¯ï¼ˆç«¯å£ 9002ï¼‰
- `services/bazi_analyzer/grpc_server.py` - bazi-analyzer-service æœåŠ¡ç«¯ï¼ˆç«¯å£ 9003ï¼‰
- `services/bazi_rule/grpc_server.py` - bazi-rule-service æœåŠ¡ç«¯ï¼ˆç«¯å£ 9004ï¼‰
- `services/fortune_analysis/grpc_server.py` - fortune-analysis-service æœåŠ¡ç«¯ï¼ˆç«¯å£ 9005ï¼‰
- `services/payment_service/grpc_server.py` - payment-service æœåŠ¡ç«¯ï¼ˆç«¯å£ 9006ï¼‰
- `services/fortune_rule/grpc_server.py` - fortune-rule-service æœåŠ¡ç«¯ï¼ˆç«¯å£ 9007ï¼‰

### 1.4 è°ƒç”¨ç¤ºä¾‹

```python
# è°ƒç”¨ bazi-core-service
from src.clients.bazi_core_client_grpc import BaziCoreClient

client = BaziCoreClient(base_url="localhost:9001", timeout=30.0)
result = client.calculate_bazi("1990-05-15", "14:30", "male")
```

### 1.5 gRPC ç‰¹ç‚¹

**ä¼˜ç‚¹ï¼š**
- âœ… **é«˜æ€§èƒ½**ï¼šåŸºäº HTTP/2ï¼Œæ”¯æŒå¤šè·¯å¤ç”¨
- âœ… **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ Protocol Buffersï¼Œå¼ºç±»å‹å®šä¹‰
- âœ… **æµå¼ä¼ è¾“**ï¼šæ”¯æŒæµå¼è¯·æ±‚å’Œå“åº”
- âœ… **è·¨è¯­è¨€**ï¼šæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€

**ç¼ºç‚¹ï¼š**
- âŒ **æµè§ˆå™¨ä¸æ”¯æŒ**ï¼šæµè§ˆå™¨æ— æ³•ç›´æ¥è°ƒç”¨ gRPC
- âŒ **è°ƒè¯•å¤æ‚**ï¼šéœ€è¦ä¸“é—¨çš„å·¥å…·æŸ¥çœ‹è¯·æ±‚/å“åº”

### 1.6 é…ç½®æ–¹å¼

é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®æœåŠ¡åœ°å€ï¼š

```bash
# .env æ–‡ä»¶
BAZI_CORE_SERVICE_URL=localhost:9001
BAZI_FORTUNE_SERVICE_URL=localhost:9002
BAZI_ANALYZER_SERVICE_URL=localhost:9003
BAZI_RULE_SERVICE_URL=localhost:9004
FORTUNE_ANALYSIS_SERVICE_URL=localhost:9005
PAYMENT_SERVICE_URL=localhost:9006
FORTUNE_RULE_SERVICE_URL=localhost:9007
```

### 1.7 é™çº§æœºåˆ¶

å¦‚æœ gRPC æœåŠ¡ä¸å¯ç”¨ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§åˆ°æœ¬åœ°è®¡ç®—ï¼š

```python
# åœ¨ server/services/bazi_service.py ä¸­
core_service_url = os.getenv("BAZI_CORE_SERVICE_URL")
if core_service_url:
    try:
        client = BaziCoreClient(base_url=core_service_url, timeout=30.0)
        bazi_result = client.calculate_bazi(solar_date, solar_time, gender)
    except Exception as exc:
        # è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°è®¡ç®—
        calculator = BaziCalculator(solar_date, solar_time, gender)
        bazi_result = calculator.calculate()
```

---

## 2. å‰ç«¯æ¥å£åè®®

### 2.1 ä½¿ç”¨åè®®ï¼š**HTTP REST API**

**è¯´æ˜ï¼š** æä¾›ç»™å‰ç«¯çš„æ¥å£ä½¿ç”¨ **HTTP REST API**ï¼ŒåŸºäº **FastAPI** æ¡†æ¶ã€‚

### 2.2 æ¡†æ¶ï¼šFastAPI

**ç‰¹ç‚¹ï¼š**
- âœ… **é«˜æ€§èƒ½**ï¼šåŸºäº Starlette å’Œ Pydanticï¼Œæ€§èƒ½æ¥è¿‘ NodeJS
- âœ… **è‡ªåŠ¨æ–‡æ¡£**ï¼šè‡ªåŠ¨ç”Ÿæˆ OpenAPI/Swagger æ–‡æ¡£
- âœ… **ç±»å‹éªŒè¯**ï¼šä½¿ç”¨ Pydantic è¿›è¡Œè¯·æ±‚/å“åº”éªŒè¯
- âœ… **å¼‚æ­¥æ”¯æŒ**ï¼šåŸç”Ÿæ”¯æŒ async/await

### 2.3 æ¥å£åˆ—è¡¨

| æ¥å£ç±»å‹ | è·¯å¾„å‰ç¼€ | ç¤ºä¾‹ |
|---------|---------|------|
| **åŸºç¡€å…«å­—** | `/api/v1/bazi/calculate` | è®¡ç®—åŸºç¡€å…«å­—ä¿¡æ¯ |
| **è¯¦ç»†å…«å­—** | `/api/v1/bazi/detail` | è®¡ç®—è¯¦ç»†å…«å­—ï¼ˆå«å¤§è¿æµå¹´ï¼‰ |
| **å‰ç«¯å±•ç¤º** | `/api/v1/bazi/pan/display` | æ’ç›˜å±•ç¤ºï¼ˆå‰ç«¯ä¼˜åŒ–ï¼‰ |
| **å¤§è¿å±•ç¤º** | `/api/v1/bazi/dayun/display` | å¤§è¿å±•ç¤ºï¼ˆå‰ç«¯ä¼˜åŒ–ï¼‰ |
| **æµå¹´å±•ç¤º** | `/api/v1/bazi/liunian/display` | æµå¹´å±•ç¤ºï¼ˆå‰ç«¯ä¼˜åŒ–ï¼‰ |
| **è§„åˆ™åŒ¹é…** | `/api/v1/bazi/rules/match` | è§„åˆ™åŒ¹é… |
| **è§„åˆ™ç²¾é€‰** | `/api/v1/bazi/rules/curated` | è§„åˆ™ç²¾é€‰ |
| **LLMç”Ÿæˆ** | `/api/v1/bazi/llm-generate` | LLM ç”ŸæˆæŠ¥å‘Š |
| **å¯¹è¯æ¥å£** | `/api/v1/bazi/chat/*` | AI å¯¹è¯ |
| **ä¸€äº‹ä¸€å¦** | `/api/v1/bazi/yigua/*` | ä¸€äº‹ä¸€å¦ |
| **ä»Šæ—¥è¿åŠ¿** | `/api/v1/bazi/daily-fortune` | ä»Šæ—¥è¿åŠ¿åˆ†æ |

### 2.4 è¯·æ±‚/å“åº”æ ¼å¼

**è¯·æ±‚æ ¼å¼ï¼š** JSON

```bash
curl -X POST http://127.0.0.1:8001/api/v1/bazi/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "solar_date": "1990-05-15",
    "solar_time": "14:30",
    "gender": "male"
  }'
```

**å“åº”æ ¼å¼ï¼š** JSON

```json
{
  "success": true,
  "data": {
    "bazi": {
      "basic_info": {...},
      "bazi_pillars": {...}
    }
  }
}
```

### 2.5 è®¤è¯æ–¹å¼

**JWT Token è®¤è¯ï¼š**

```bash
# 1. ç™»å½•è·å– Token
curl -X POST http://127.0.0.1:8001/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 2. ä½¿ç”¨ Token è®¿é—®å—ä¿æŠ¤æ¥å£
curl -X POST http://127.0.0.1:8001/api/v1/bazi/rules/curated \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{...}'
```

### 2.6 é™æµæœºåˆ¶

**ä½¿ç”¨ slowapi è¿›è¡Œé™æµï¼š**

```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@router.post("/bazi/rules/curated")
@limiter.limit("30/minute")  # æ¯åˆ†é’Ÿ30æ¬¡
async def get_curated_rules(...):
    ...
```

### 2.7 è‡ªåŠ¨æ–‡æ¡£

**Swagger UIï¼š** `http://127.0.0.1:8001/docs`

**ReDocï¼š** `http://127.0.0.1:8001/redoc`

---

## 3. å¤–éƒ¨æœåŠ¡è°ƒç”¨åè®®

### 3.1 Coze APIï¼ˆLLM æœåŠ¡ï¼‰

**åè®®ï¼š** **HTTP REST API**

**ä»£ç ä½ç½®ï¼š** `src/ai/bazi_ai_analyzer.py`

**è°ƒç”¨æ–¹å¼ï¼š**

```python
# ä½¿ç”¨ requests åº“è°ƒç”¨ Coze API
import requests

headers = {
    "Authorization": f"Bearer {access_token}",
    "Content-Type": "application/json"
}

response = requests.post(
    "https://api.coze.cn/v1/chat",
    headers=headers,
    json=payload,
    timeout=60
)
```

**ç‰¹ç‚¹ï¼š**
- âœ… ä½¿ç”¨æ ‡å‡†çš„ HTTP REST API
- âœ… æ”¯æŒ Bearer Token è®¤è¯
- âœ… è¶…æ—¶æ—¶é—´ï¼š60ç§’

### 3.2 MySQL æ•°æ®åº“

**åè®®ï¼š** **MySQL Protocol**

**ä»£ç ä½ç½®ï¼š** `server/db/mysql_connector.py`

**è¿æ¥æ–¹å¼ï¼š**

```python
import pymysql

connection = pymysql.connect(
    host='localhost',
    port=3306,
    user='root',
    password='123456',
    database='testdb',
    charset='utf8mb4'
)
```

---

## 4. åè®®å¯¹æ¯”

| åè®® | ç”¨é€” | æ€§èƒ½ | æµè§ˆå™¨æ”¯æŒ | ç±»å‹å®‰å…¨ | é€‚ç”¨åœºæ™¯ |
|------|------|------|-----------|---------|---------|
| **gRPC** | å†…éƒ¨æœåŠ¡é—´è°ƒç”¨ | â­â­â­â­â­ | âŒ | âœ… | å¾®æœåŠ¡é—´é€šä¿¡ |
| **HTTP REST** | å‰ç«¯æ¥å£ | â­â­â­â­ | âœ… | âš ï¸ï¼ˆéœ€æ‰‹åŠ¨éªŒè¯ï¼‰ | Web å‰ç«¯ã€ç§»åŠ¨ç«¯ |
| **MySQL Protocol** | æ•°æ®åº“è®¿é—® | â­â­â­â­ | âŒ | âœ… | æ•°æ®æŒä¹…åŒ– |

### 4.1 ä¸ºä»€ä¹ˆå†…éƒ¨ä½¿ç”¨ gRPCï¼Ÿ

**åŸå› ï¼š**
1. **æ€§èƒ½ä¼˜åŠ¿**ï¼šgRPC åŸºäº HTTP/2ï¼Œæ”¯æŒå¤šè·¯å¤ç”¨ï¼Œæ€§èƒ½æ¯” HTTP/1.1 å¥½
2. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ Protocol Buffersï¼Œç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
3. **æµå¼ä¼ è¾“**ï¼šæ”¯æŒæµå¼è¯·æ±‚å’Œå“åº”ï¼Œé€‚åˆå¤§æ•°æ®ä¼ è¾“
4. **è·¨è¯­è¨€**ï¼šæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ï¼Œä¾¿äºå¾®æœåŠ¡æ‹†åˆ†

### 4.2 ä¸ºä»€ä¹ˆå‰ç«¯ä½¿ç”¨ HTTP RESTï¼Ÿ

**åŸå› ï¼š**
1. **æµè§ˆå™¨æ”¯æŒ**ï¼šæµè§ˆå™¨åŸç”Ÿæ”¯æŒ HTTPï¼Œæ— éœ€é¢å¤–åº“
2. **æ˜“äºè°ƒè¯•**ï¼šå¯ä»¥ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ã€Postman ç­‰å·¥å…·
3. **æ ‡å‡†åŒ–**ï¼šREST API æ˜¯ä¸šç•Œæ ‡å‡†ï¼Œå‰ç«¯å¼€å‘è€…ç†Ÿæ‚‰
4. **ç¼“å­˜æ”¯æŒ**ï¼šHTTP æ”¯æŒç¼“å­˜æœºåˆ¶ï¼Œæé«˜æ€§èƒ½

---

## 5. æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ (Browser/Mobile)                 â”‚
â”‚                      HTTP REST API                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ HTTP/JSON
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI Server                            â”‚
â”‚              (server/main.py)                                â”‚
â”‚              Port: 8001                                      â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Routes (server/api/v1/)                         â”‚  â”‚
â”‚  â”‚  - /bazi/calculate                                   â”‚  â”‚
â”‚  â”‚  - /bazi/detail                                      â”‚  â”‚
â”‚  â”‚  - /bazi/pan/display                                 â”‚  â”‚
â”‚  â”‚  - /bazi/rules/curated                               â”‚  â”‚
â”‚  â”‚  - /bazi/llm-generate                                â”‚  â”‚
â”‚  â”‚  - /bazi/chat/*                                      â”‚  â”‚
â”‚  â”‚  - /bazi/yigua/*                                     â”‚  â”‚
â”‚  â”‚  - /bazi/daily-fortune                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Services (server/services/)                          â”‚  â”‚
â”‚  â”‚  - BaziService                                        â”‚  â”‚
â”‚  â”‚  - BaziDetailService                                  â”‚  â”‚
â”‚  â”‚  - BaziDisplayService                                 â”‚  â”‚
â”‚  â”‚  - RuleService                                        â”‚  â”‚
â”‚  â”‚  - LLMGenerateService                                 â”‚  â”‚
â”‚  â”‚  - ChatService                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ gRPC (å¯é€‰)
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ bazi-core-   â”‚ â”‚ bazi-fortune-â”‚ â”‚ bazi-analyzer â”‚ â”‚ bazi-rule-   â”‚
â”‚ service      â”‚ â”‚ service      â”‚ â”‚ service      â”‚ â”‚ service      â”‚
â”‚ (gRPC)       â”‚ â”‚ (gRPC)       â”‚ â”‚ (gRPC)       â”‚ â”‚ (gRPC)       â”‚
â”‚ Port: 9001   â”‚ â”‚ Port: 9002   â”‚ â”‚ Port: 9003   â”‚ â”‚ Port: 9004   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fortune-     â”‚ â”‚ payment-     â”‚ â”‚ fortune-     â”‚
â”‚ analysis     â”‚ â”‚ service       â”‚ â”‚ rule         â”‚
â”‚ service      â”‚ â”‚ (gRPC)        â”‚ â”‚ service      â”‚
â”‚ (gRPC)       â”‚ â”‚ Port: 9006    â”‚ â”‚ (gRPC)       â”‚
â”‚ Port: 9005   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ Port: 9007   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ MySQL Protocol
                         â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   MySQL DB    â”‚
                 â”‚   Port: 3306  â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ HTTP REST API
                         â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Coze API     â”‚
                 â”‚  (External)   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. æ€»ç»“

### 6.1 åè®®ä½¿ç”¨æ€»ç»“

| åœºæ™¯ | åè®® | è¯´æ˜ |
|------|------|------|
| **å‰ç«¯ â†’ åç«¯** | HTTP REST API | FastAPI æ¡†æ¶ï¼ŒJSON æ ¼å¼ |
| **åç«¯ â†’ å¾®æœåŠ¡** | gRPC | é«˜æ€§èƒ½ï¼Œç±»å‹å®‰å…¨ |
| **åç«¯ â†’ æ•°æ®åº“** | MySQL Protocol | æ ‡å‡†æ•°æ®åº“åè®® |
| **åç«¯ â†’ å¤–éƒ¨ API** | HTTP REST API | Coze API ç­‰å¤–éƒ¨æœåŠ¡ |

### 6.2 å…³é”®ç‚¹

1. **å†…éƒ¨æœåŠ¡é—´**ï¼šä½¿ç”¨ gRPCï¼Œæ€§èƒ½é«˜ï¼Œç±»å‹å®‰å…¨ï¼ˆ7ä¸ªå¾®æœåŠ¡ï¼š9001-9007ï¼‰
2. **å‰ç«¯æ¥å£**ï¼šä½¿ç”¨ HTTP REST APIï¼Œæµè§ˆå™¨å‹å¥½ï¼Œæ˜“äºè°ƒè¯•
3. **é™çº§æœºåˆ¶**ï¼šgRPC æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨é™çº§åˆ°æœ¬åœ°è®¡ç®—
4. **è®¤è¯æˆæƒ**ï¼šå‰ç«¯æ¥å£æ”¯æŒ JWT Token è®¤è¯
5. **é™æµä¿æŠ¤**ï¼šä½¿ç”¨ slowapi è¿›è¡Œæ¥å£é™æµ

### 6.3 å¾®æœåŠ¡å®Œæ•´åˆ—è¡¨

| ç«¯å£ | æœåŠ¡åç§° | åŠŸèƒ½è¯´æ˜ |
|------|---------|---------|
| 9001 | bazi-core-service | å…«å­—æ ¸å¿ƒè®¡ç®—æœåŠ¡ï¼šè®¡ç®—å…«å­—æ’ç›˜ï¼ˆå››æŸ±ã€ç¥ç…ã€åç¥ç­‰åŸºç¡€ä¿¡æ¯ï¼‰ |
| 9002 | bazi-fortune-service | å¤§è¿æµå¹´æœåŠ¡ï¼šè®¡ç®—å¤§è¿ã€æµå¹´ã€æµæœˆç­‰è¿åŠ¿å‘¨æœŸ |
| 9003 | bazi-analyzer-service | å…«å­—åˆ†ææœåŠ¡ï¼šæ‰§è¡Œå„ç§åˆ†æå™¨ï¼ˆå¦‚æ—¥æŸ±æ€§åˆ«åˆ†æç­‰ï¼‰ |
| 9004 | bazi-rule-service | è§„åˆ™åŒ¹é…æœåŠ¡ï¼šåŒ¹é…å…«å­—è§„åˆ™ï¼ˆå©šå§»ã€æ¡ƒèŠ±ç­‰462+æ¡è§„åˆ™ï¼‰ |
| 9005 | fortune-analysis-service | é¢ç›¸æ‰‹ç›¸åˆ†ææœåŠ¡ï¼šæ‰‹ç›¸å’Œé¢ç›¸å›¾åƒåˆ†æï¼Œç”Ÿæˆå‘½ç†æŠ¥å‘Š |
| 9006 | payment-service | æ”¯ä»˜æœåŠ¡ï¼šStripeæ”¯ä»˜é›†æˆï¼Œåˆ›å»ºæ”¯ä»˜ä¼šè¯å’ŒéªŒè¯æ”¯ä»˜çŠ¶æ€ |
| 9007 | fortune-rule-service | é¢ç›¸æ‰‹ç›¸è§„åˆ™æœåŠ¡ï¼šé¢ç›¸æ‰‹ç›¸è§„åˆ™åŒ¹é…å’Œå…«å­—èåˆåˆ†æ |

---

---

## 7. çƒ­æ›´æ–°ç³»ç»Ÿ

### 7.1 çƒ­æ›´æ–°æ¦‚è¿°

ç³»ç»Ÿæ”¯æŒ**é›¶åœæœºæ›´æ–°**ï¼Œæ‰€æœ‰ä»£ç æ›´æ–°æ— éœ€é‡å¯æœåŠ¡ã€‚

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- âœ… **æ–‡ä»¶ç›‘æ§**ï¼šå®æ—¶ç›‘æ§æ‰€æœ‰ Python æºä»£ç æ–‡ä»¶ï¼ˆ5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
- âœ… **è‡ªåŠ¨çƒ­æ›´æ–°**ï¼šæ£€æµ‹åˆ°å˜åŒ–åè‡ªåŠ¨é‡æ–°åŠ è½½ï¼ˆ5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
- âœ… **è¯­æ³•æ£€æŸ¥**ï¼šæ›´æ–°å‰è‡ªåŠ¨æ£€æŸ¥ Python è¯­æ³•
- âœ… **ç‰ˆæœ¬ç®¡ç†**ï¼šåŸºäºæ–‡ä»¶ä¿®æ”¹æ—¶é—´å’Œå†…å®¹å“ˆå¸Œçš„ç‰ˆæœ¬æ§åˆ¶
- âœ… **å›æ»šæœºåˆ¶**ï¼šæ›´æ–°å¤±è´¥è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬

### 7.2 çƒ­æ›´æ–°æ¶æ„

```
æ–‡ä»¶ç›‘æ§å™¨ (FileMonitor)
  â†“ 5ç§’æ£€æŸ¥ä¸€æ¬¡
æ£€æµ‹æ–‡ä»¶å˜åŒ–
  â†“
ç‰ˆæœ¬ç®¡ç†å™¨ (VersionManager)
  â†“ 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
çƒ­æ›´æ–°ç®¡ç†å™¨ (HotReloadManager)
  â†“
æ¨¡å—é‡è½½å™¨ (Reloaders)
  - RuleReloader (è§„åˆ™)
  - ContentReloader (å†…å®¹)
  - SourceCodeReloader (æºä»£ç )
```

### 7.3 çƒ­æ›´æ–° API

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/v1/hot-reload/status` | GET | è·å–çƒ­æ›´æ–°çŠ¶æ€ |
| `/api/v1/hot-reload/check` | POST | æ‰‹åŠ¨è§¦å‘çƒ­æ›´æ–°æ£€æŸ¥ |
| `/api/v1/hot-reload/versions` | GET | è·å–æ‰€æœ‰æ¨¡å—ç‰ˆæœ¬å· |
| `/api/v1/hot-reload/reload/{module_name}` | POST | æ‰‹åŠ¨é‡è½½æŒ‡å®šæ¨¡å— |
| `/api/v1/hot-reload/rollback` | POST | å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬ |

### 7.4 ç›‘æ§çš„æ¨¡å—

| æ¨¡å—åç§° | è¯´æ˜ | ç‰ˆæœ¬å·æ¥æº |
|---------|------|-----------|
| **rules** | è§„åˆ™é…ç½® | æ•°æ®åº“ `rule_version` è¡¨ |
| **content** | è§„åˆ™å†…å®¹ | æ•°æ®åº“ `rule_version` è¡¨ |
| **source** | Python æºä»£ç  | æ–‡ä»¶ä¿®æ”¹æ—¶é—´æˆ³ |
| **config** | ç³»ç»Ÿé…ç½® | é…ç½®æ–‡ä»¶ä¿®æ”¹æ—¶é—´ |
| **cache** | ç¼“å­˜æ•°æ® | ç¼“å­˜ç‰ˆæœ¬å· |

### 7.5 ä½¿ç”¨è§„èŒƒ

#### âœ… å¿…é¡»éµå®ˆ

1. **ä»£ç å…¼å®¹æ€§**ï¼šé¿å…å…¨å±€çŠ¶æ€ï¼Œä½¿ç”¨å•ä¾‹æ¨¡å¼
2. **è¯­æ³•æ­£ç¡®**ï¼šæ‰€æœ‰ä»£ç å¿…é¡»é€šè¿‡è¯­æ³•æ£€æŸ¥
3. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰å‡½æ•°éƒ½è¦æœ‰å¼‚å¸¸å¤„ç†
4. **æ—¥å¿—è®°å½•**ï¼šå…³é”®æ“ä½œéƒ½è¦è®°å½•æ—¥å¿—

#### è¯¦ç»†è§„èŒƒ

å‚è€ƒæ–‡æ¡£ï¼š`docs/çƒ­æ›´æ–°ç³»ç»Ÿè®¾è®¡è§„èŒƒ.md`

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.0  
**æœ€åæ›´æ–°ï¼š** 2025-01-XX

