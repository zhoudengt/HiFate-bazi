# ç”Ÿäº§ç¯å¢ƒåŒæœºéƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç¯å¢ƒä¿¡æ¯

### ç”Ÿäº§ç¯å¢ƒ
- **Node1**: 
  - å…¬ç½‘ IP: `8.210.52.217`
  - ç§ç½‘ IP: `172.18.121.222`
- **Node2**: 
  - å…¬ç½‘ IP: `47.243.160.43`
  - ç§ç½‘ IP: `172.18.121.223`
- **MySQL å¯†ç **: `${SSH_PASSWORD}`

### æµ‹è¯•ç¯å¢ƒï¼ˆä¸è¦æ“ä½œï¼‰
- **æµ‹è¯•æœåŠ¡å™¨**: `123.57.216.15`

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### æ–¹å¼ä¸€ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•æ‰§è¡Œ
cd /Users/zhoudt/Downloads/project/HiFate-bazi
bash deploy/scripts/deploy_production.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. åˆå§‹åŒ– Node1 å’Œ Node2ï¼ˆå®‰è£… Dockerï¼‰
2. æç¤ºå…‹éš†ä»£ç 
3. é…ç½®ç¯å¢ƒå˜é‡
4. éƒ¨ç½² Node1
5. é…ç½® MySQL ä¸»ä»å¤åˆ¶
6. éƒ¨ç½² Node2
7. é…ç½® Node2 ä»åº“
8. éªŒè¯éƒ¨ç½²

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

#### æ­¥éª¤ 1: åˆå§‹åŒ– Node1

```bash
# ç™»å½• Node1
ssh root@8.210.52.217

# æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
cd /tmp
curl -fsSL https://raw.githubusercontent.com/your-repo/HiFate-bazi/master/deploy/scripts/init-ecs.sh | bash
# æˆ–æ‰‹åŠ¨ä¸Šä¼  init-ecs.sh åæ‰§è¡Œ
bash init-ecs.sh
```

#### æ­¥éª¤ 2: åˆå§‹åŒ– Node2

```bash
# ç™»å½• Node2
ssh root@47.243.160.43

# æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
cd /tmp
curl -fsSL https://raw.githubusercontent.com/your-repo/HiFate-bazi/master/deploy/scripts/init-ecs.sh | bash
```

#### æ­¥éª¤ 3: å…‹éš†ä»£ç ï¼ˆä¸¤å°æœºå™¨éƒ½æ‰§è¡Œï¼‰

```bash
# Node1
ssh root@8.210.52.217
cd /opt/HiFate-bazi
git clone <ä½ çš„ä»“åº“åœ°å€> .

# Node2
ssh root@47.243.160.43
cd /opt/HiFate-bazi
git clone <ä½ çš„ä»“åº“åœ°å€> .
```

#### æ­¥éª¤ 4: é…ç½®ç¯å¢ƒå˜é‡

**Node1 é…ç½®** (`/opt/HiFate-bazi/.env`):
```bash
NODE_ID=node1
NODE1_IP=172.18.121.222
NODE2_IP=172.18.121.223
ACR_REGISTRY=registry.cn-hangzhou.aliyuncs.com
ACR_NAMESPACE=hifate
ACR_USERNAME=your_acr_username
ACR_PASSWORD=your_acr_password
MYSQL_PASSWORD=${SSH_PASSWORD}
MYSQL_REPL_PASSWORD=${SSH_PASSWORD}
SECRET_KEY=your_random_secret_key
```

**Node2 é…ç½®** (`/opt/HiFate-bazi/.env`):
```bash
NODE_ID=node2
NODE1_IP=172.18.121.222
NODE2_IP=172.18.121.223
ACR_REGISTRY=registry.cn-hangzhou.aliyuncs.com
ACR_NAMESPACE=hifate
ACR_USERNAME=your_acr_username
ACR_PASSWORD=your_acr_password
MYSQL_PASSWORD=${SSH_PASSWORD}
MYSQL_REPL_PASSWORD=${SSH_PASSWORD}
SECRET_KEY=your_random_secret_key
```

#### æ­¥éª¤ 5: éƒ¨ç½² Node1

```bash
ssh root@8.210.52.217
cd /opt/HiFate-bazi
bash deploy/scripts/deploy.sh node1
```

#### æ­¥éª¤ 6: é…ç½® MySQL ä¸»ä»å¤åˆ¶ç”¨æˆ·

```bash
ssh root@8.210.52.217
docker exec -it hifate-mysql-master mysql -uroot -p${SSH_PASSWORD}

# åœ¨ MySQL ä¸­æ‰§è¡Œï¼š
CREATE USER 'repl'@'%' IDENTIFIED BY '${SSH_PASSWORD}';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;
SHOW MASTER STATUS;
```

#### æ­¥éª¤ 7: éƒ¨ç½² Node2

```bash
ssh root@47.243.160.43
cd /opt/HiFate-bazi
bash deploy/scripts/deploy.sh node2
```

#### æ­¥éª¤ 8: é…ç½® Node2 MySQL ä»åº“

```bash
ssh root@47.243.160.43
docker exec -it hifate-mysql-slave mysql -uroot -p${SSH_PASSWORD}

# åœ¨ MySQL ä¸­æ‰§è¡Œï¼š
CHANGE MASTER TO
    MASTER_HOST='172.18.121.222',
    MASTER_USER='repl',
    MASTER_PASSWORD='${SSH_PASSWORD}',
    MASTER_AUTO_POSITION=1;
START SLAVE;
SHOW SLAVE STATUS\G
```

#### æ­¥éª¤ 9: éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
ssh root@8.210.52.217 "docker ps | grep hifate"
ssh root@47.243.160.43 "docker ps | grep hifate"

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://8.210.52.217/health
curl http://47.243.160.43/health

# æ£€æŸ¥ MySQL ä¸»ä»å¤åˆ¶
ssh root@47.243.160.43 "docker exec -i hifate-mysql-slave mysql -uroot -p${SSH_PASSWORD} -e \"SHOW SLAVE STATUS\\G\" | grep -E 'Slave_IO_Running|Slave_SQL_Running'"
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸è¦æ“ä½œæµ‹è¯•ç¯å¢ƒ**ï¼šæ‰€æœ‰æ“ä½œéƒ½åœ¨ç”Ÿäº§ç¯å¢ƒçš„ Node1 å’Œ Node2 ä¸Šï¼Œä¸è¦å½±å“æµ‹è¯•ç¯å¢ƒ `123.57.216.15`
2. **å®‰å…¨ç»„é…ç½®**ï¼šç¡®ä¿ä¸¤å°æœºå™¨ä¹‹é—´å¯ä»¥äº’ç›¸è®¿é—®ï¼ˆå†…ç½‘äº’é€šï¼‰
3. **ç«¯å£å¼€æ”¾**ï¼šç¡®ä¿å®‰å…¨ç»„å¼€æ”¾äº† 80, 443, 22, 3306, 6379 ç«¯å£
4. **MySQL ä¸»ä»å¤åˆ¶**ï¼šç¡®ä¿ Node2 å¯ä»¥è®¿é—® Node1 çš„ MySQLï¼ˆå†…ç½‘ IP: 3306ï¼‰
5. **Redis ä¸»ä»å¤åˆ¶**ï¼šç¡®ä¿ Node2 å¯ä»¥è®¿é—® Node1 çš„ Redisï¼ˆå†…ç½‘ IP: 6379ï¼‰

---

## ğŸ” æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker logs hifate-web
docker logs hifate-mysql-master
docker logs hifate-redis-master

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker ps -a
```

### MySQL ä¸»ä»å¤åˆ¶å¤±è´¥

```bash
# æ£€æŸ¥ä»åº“çŠ¶æ€
docker exec -it hifate-mysql-slave mysql -uroot -p${SSH_PASSWORD} -e "SHOW SLAVE STATUS\G"

# æ£€æŸ¥ç½‘ç»œè¿æ¥
docker exec -it hifate-mysql-slave ping 172.18.121.222
```

### é•œåƒæ‹‰å–å¤±è´¥

```bash
# æ‰‹åŠ¨ç™»å½• ACR
docker login registry.cn-hangzhou.aliyuncs.com -u your_username

# æ‰‹åŠ¨æ‹‰å–é•œåƒ
docker pull registry.cn-hangzhou.aliyuncs.com/hifate/hifate-bazi:latest
```

---

**æœ€åæ›´æ–°**ï¼š2025-01-21

