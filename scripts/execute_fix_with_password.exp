#!/usr/bin/expect -f
# ä½¿ç”¨ expect è‡ªåŠ¨è¾“å…¥å¯†ç æ‰§è¡Œä¿®å¤

set timeout 300

# è·å–å¯†ç ï¼ˆä»ç¯å¢ƒå˜é‡æˆ–å‚æ•°ï¼‰
if {[llength $argv] > 0} {
    set password [lindex $argv 0]
} else {
    set password $env(SSH_PASSWORD)
}

if {$password == ""} {
    puts "âŒ é”™è¯¯: æœªæä¾›å¯†ç "
    puts "ä½¿ç”¨æ–¹æ³•: expect execute_fix_with_password.exp <å¯†ç >"
    puts "æˆ–è®¾ç½®ç¯å¢ƒå˜é‡: export SSH_PASSWORD=<å¯†ç >"
    exit 1
}

set sql_file "scripts/temp_rules_export.sql"
set server "root@8.210.52.217"
set remote_file "/tmp/rules_import.sql"

puts "================================================================================"
puts "ğŸ”§ æ‰§è¡Œä¿®å¤ï¼šåŒæ­¥è§„åˆ™åˆ°ç”Ÿäº§ç¯å¢ƒ"
puts "================================================================================"
puts ""

# æ­¥éª¤ 1: ä¸Šä¼  SQL æ–‡ä»¶
puts "ğŸ“¤ æ­¥éª¤ 1: ä¸Šä¼  SQL æ–‡ä»¶åˆ°ç”Ÿäº§ç¯å¢ƒ..."
spawn scp $sql_file $server:$remote_file

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Permission denied" {
        puts "âŒ å¯†ç é”™è¯¯æˆ–æƒé™è¢«æ‹’ç»"
        exit 1
    }
    "100%" {
        puts "âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ"
    }
    timeout {
        puts "âŒ ä¸Šä¼ è¶…æ—¶"
        exit 1
    }
    eof
}

wait

# æ­¥éª¤ 2: æ‰§è¡Œ SQL å¹¶æ¸…ç†ç¼“å­˜
puts ""
puts "ğŸ“¥ æ­¥éª¤ 2: æ‰§è¡Œ SQL å¹¶æ¸…ç†ç¼“å­˜..."
spawn ssh $server "cd /opt/HiFate-bazi && docker exec -i hifate-mysql-master mysql -uroot -pYuanqizhan@163 hifate_bazi < $remote_file && curl -X POST http://8.210.52.217:8001/api/v1/hot-reload/check"

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Permission denied" {
        puts "âŒ å¯†ç é”™è¯¯æˆ–æƒé™è¢«æ‹’ç»"
        exit 1
    }
    timeout {
        puts "âš ï¸  æ‰§è¡Œè¶…æ—¶ï¼ˆå¯èƒ½æ­£å¸¸ï¼ŒSQL æ–‡ä»¶è¾ƒå¤§ï¼‰"
    }
    eof
}

wait

puts ""
puts "âœ… SQL æ‰§è¡Œå®Œæˆï¼Œç¼“å­˜å·²æ¸…ç†"
puts ""
puts "================================================================================"
puts "âœ… ä¿®å¤å®Œæˆï¼"
puts "================================================================================"

