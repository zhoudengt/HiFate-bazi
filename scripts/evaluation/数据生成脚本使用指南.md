# Coze 和千问数据生成脚本使用指南

## 主评测脚本

### 脚本位置
- **主脚本**: `scripts/evaluation/bazi_evaluator.py`
- **API 客户端**: `scripts/evaluation/api_client.py` (Coze 平台，通过后端代理)
- **百炼客户端**: `scripts/evaluation/bailian/bailian_client.py` (千问平台)

---

## 一、Coze 平台数据生成

### 1.1 仅使用 Coze 平台（默认）

```bash
# 批量处理所有数据
python3 scripts/evaluation/bazi_evaluator.py --input /path/to/test.xlsx

# 处理单条数据（第2行）
python3 scripts/evaluation/bazi_evaluator.py --input /path/to/test.xlsx --row 2

# 显示详细进度
python3 scripts/evaluation/bazi_evaluator.py --input /path/to/test.xlsx --verbose

# 指定并发数（同时处理的用户数）
python3 scripts/evaluation/bazi_evaluator.py --input /path/to/test.xlsx --concurrency 5

# 指定后端 API 地址
python3 scripts/evaluation/bazi_evaluator.py --input /path/to/test.xlsx --base-url http://8.210.52.217:8001
```

### 1.2 明确指定 Coze 平台

```bash
python3 scripts/evaluation/bazi_evaluator.py --input /path/to/test.xlsx --platform coze
```

---

## 二、百炼平台（千问）数据生成

### 2.1 仅使用百炼平台

```bash
# 基本使用（API Key 从环境变量读取）
export DASHSCOPE_API_KEY=sk-91ad3ec784b64fe78c4015827dfd982d
python3 scripts/evaluation/bazi_evaluator.py --input /path/to/test.xlsx --platform bailian

# 通过命令行参数指定 API Key
python3 scripts/evaluation/bazi_evaluator.py \
    --input /path/to/test.xlsx \
    --platform bailian \
    --bailian-api-key sk-91ad3ec784b64fe78c4015827dfd982d

# 显示详细进度
python3 scripts/evaluation/bazi_evaluator.py \
    --input /path/to/test.xlsx \
    --platform bailian \
    --verbose

# 处理单条数据
python3 scripts/evaluation/bazi_evaluator.py \
    --input /path/to/test.xlsx \
    --platform bailian \
    --row 2
```

---

## 三、双平台对比评测（Coze + 千问）

### 3.1 并行对比评测

```bash
# 基本使用（同时调用两个平台，结果并排对比）
python3 scripts/evaluation/bazi_evaluator.py --input /path/to/test.xlsx --platform both

# 显示详细进度
python3 scripts/evaluation/bazi_evaluator.py \
    --input /path/to/test.xlsx \
    --platform both \
    --verbose

# 指定并发数
python3 scripts/evaluation/bazi_evaluator.py \
    --input /path/to/test.xlsx \
    --platform both \
    --concurrency 3

# 完整参数示例
python3 scripts/evaluation/bazi_evaluator.py \
    --input /path/to/test.xlsx \
    --platform both \
    --bailian-api-key sk-91ad3ec784b64fe78c4015827dfd982d \
    --base-url http://8.210.52.217:8001 \
    --concurrency 3 \
    --verbose
```

---

## 四、输出结果说明

### 4.1 Excel 输出列结构

使用 `--platform both` 时，Excel 会包含以下列：

#### Coze 平台结果列（原有位置）
- 日元-六十甲子 (列 16)
- 五行占比分析 (列 17)
- 喜神与忌神 (列 18)
- 事业财富 (列 19)
- 感情婚姻 (列 20)
- 身体健康 (列 21)
- 子女学习 (列 22)
- 总评 (列 23)
- 每日运势 (列 24)
- AI问答相关列 (列 27-32)

#### 百炼平台结果列（新增，在 AI 问答列之后）
- 百炼-五行占比分析 (列 33)
- 百炼-喜神与忌神 (列 34)
- 百炼-事业财富 (列 35)
- 百炼-感情婚姻 (列 36)
- 百炼-身体健康 (列 37)
- 百炼-子女学习 (列 38)
- 百炼-总评 (列 39)
- 百炼-每日运势 (列 40)

---

## 五、脚本文件清单

### 5.1 核心脚本

| 文件 | 说明 |
|-----|------|
| `scripts/evaluation/bazi_evaluator.py` | **主评测脚本**，支持 Coze 和百炼双平台 |
| `scripts/evaluation/api_client.py` | Coze 平台 API 客户端（通过后端代理调用） |
| `scripts/evaluation/bailian/bailian_client.py` | 百炼平台 API 客户端（直接调用 DashScope） |
| `scripts/evaluation/config.py` | 评测配置（平台选择、超时等） |
| `scripts/evaluation/excel_handler.py` | Excel 读写处理 |
| `scripts/evaluation/data_parser.py` | 数据解析工具 |

### 5.2 配置文件

| 文件 | 说明 |
|-----|------|
| `scripts/evaluation/bailian/config.py` | 百炼平台配置（App ID 映射） |
| `scripts/evaluation/config.py` | 评测系统配置 |

---

## 六、快速参考

### 6.1 常用命令组合

```bash
# 1. 仅 Coze（默认）
python3 scripts/evaluation/bazi_evaluator.py -i test.xlsx

# 2. 仅百炼
python3 scripts/evaluation/bazi_evaluator.py -i test.xlsx -p bailian

# 3. 双平台对比
python3 scripts/evaluation/bazi_evaluator.py -i test.xlsx -p both -v

# 4. 单条测试（第2行）
python3 scripts/evaluation/bazi_evaluator.py -i test.xlsx -r 2 -p both -v

# 5. 高并发批量处理
python3 scripts/evaluation/bazi_evaluator.py -i test.xlsx -p both -c 5
```

### 6.2 参数说明

| 参数 | 简写 | 说明 | 默认值 |
|-----|------|------|--------|
| `--input` | `-i` | Excel 文件路径 | 必填 |
| `--platform` | `-p` | 平台选择：coze/bailian/both | coze |
| `--row` | `-r` | 处理指定行（从1开始） | 全部 |
| `--concurrency` | `-c` | 并发数（同时处理的用户数） | 3 |
| `--verbose` | `-v` | 显示详细进度 | False |
| `--base-url` | | 后端 API 地址 | http://8.210.52.217:8001 |
| `--bailian-api-key` | | 百炼 API Key | 从环境变量读取 |

---

## 七、环境变量配置

### 7.1 百炼平台 API Key

```bash
# 方式1：设置环境变量（推荐）
export DASHSCOPE_API_KEY=sk-91ad3ec784b64fe78c4015827dfd982d

# 方式2：在脚本中硬编码（不推荐）
# 方式3：通过命令行参数传递
```

### 7.2 持久化配置（可选）

在 `~/.bashrc` 或 `~/.zshrc` 中添加：

```bash
export DASHSCOPE_API_KEY=sk-91ad3ec784b64fe78c4015827dfd982d
```

---

## 八、依赖安装

### 8.1 必需依赖

```bash
# 安装百炼平台 SDK
pip install dashscope>=1.14.0

# 或从 requirements.txt 安装
pip install -r requirements.txt
```

### 8.2 其他依赖

其他依赖（如 pandas, openpyxl, aiohttp）应该已经在 requirements.txt 中。

---

## 九、故障排查

### 9.1 百炼平台调用失败

```bash
# 检查 API Key
echo $DASHSCOPE_API_KEY

# 检查 dashscope 是否安装
python3 -c "import dashscope; print('OK')"

# 测试百炼客户端
python3 -c "
from scripts.evaluation.bailian import BailianClient
client = BailianClient()
print('客户端初始化成功')
"
```

### 9.2 Coze 平台调用失败

```bash
# 检查后端服务是否运行
curl http://8.210.52.217:8001/api/v1/bazi/data

# 检查网络连接
ping 8.210.52.217
```

---

## 十、示例输出

### 10.1 控制台输出示例

```
[2026-01-07 10:00:00] [INFO] 开始批量评测，共 10 条数据，并发数: 3
[2026-01-07 10:00:01] [INFO] 开始评测: 张三 (1990-05-15 10:00 male) [平台: both]
[2026-01-07 10:00:01] [PROGRESS]   并行调用 Coze API 接口...
[2026-01-07 10:00:05] [PROGRESS]   Coze API 调用完成，耗时: 4.2秒
[2026-01-07 10:00:05] [PROGRESS]   并行调用百炼 API 接口...
[2026-01-07 10:00:08] [PROGRESS]   百炼 API 调用完成，耗时: 3.1秒
[2026-01-07 10:00:08] [INFO] 完成评测: 张三 (总耗时: 7.3秒)
[2026-01-07 10:00:08] [INFO] 进度: 1/10 完成
```

---

## 十一、相关文档

- **百炼模块说明**: `scripts/evaluation/bailian/README.md`
- **需求文档**: `docs/需求/百炼平台千问模型集成需求文档.md`
- **评测系统说明**: `scripts/evaluation/README.md`

---

## 十二、注意事项

1. **API Key 安全**: 不要将 API Key 提交到 Git 仓库
2. **并发控制**: 根据 API 配额调整并发数，避免触发限流
3. **超时设置**: 大模型生成可能需要较长时间，默认超时 300 秒
4. **Excel 格式**: 确保 Excel 文件格式正确，包含必要的列
5. **网络连接**: 确保能访问后端 API 和百炼平台



