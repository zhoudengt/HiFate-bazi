# 多接口传输错误修复计划

## 问题描述

多个流式接口存在传输错误和空内容问题：

1. **传输错误（TransferEncodingError）**：
   - 感情婚姻接口：`/bazi/marriage-analysis/stream`
   - 喜神忌神接口：`/bazi/xishen-jishen/stream`
   - 子女学习接口：`/children-study/stream`

2. **Coze API 返回空内容**：
   - 部分接口返回空内容，导致评测数据缺失

## 问题分析

### 1. 传输错误（TransferEncodingError）

**错误现象**：
```
传输错误: http://8.210.52.217:8001/api/v1/xxx/stream, 
Response payload is not completed: <TransferEncodingError: 400, 
message='Not enough data to satisfy transfer length header.'>
```

**原因**：
- 与总评接口相同的问题
- 流式响应在传输过程中被中断
- 当前的流式读取方式不够稳健

**已修复**：总评接口已添加重试机制和改善的流式读取

### 2. Coze API 返回空内容

**问题现象**：
- `Coze API 返回空内容`
- `StreamResponse.content` 为空字符串

**可能原因**：
1. 服务器端确实没有返回内容（大模型生成失败）
2. 流式读取过程中没有正确收集内容
3. 连接中断但没有保存部分内容
4. 异常处理导致内容丢失

## 修复方案

### 方案1：为所有流式接口添加重试机制 ⭐⭐⭐⭐⭐

**参考**：总评接口的修复方式

**修改文件**: `scripts/evaluation/api_client.py`

**需要添加重试的接口**：
1. ✅ `call_general_review_stream()` - 已修复
2. ❌ `call_marriage_analysis_stream()` - 需要修复
3. ❌ `call_xishen_jishen_stream()` - 需要修复
4. ❌ `call_children_study_stream()` - 需要修复
5. ❌ `call_career_wealth_stream()` - 预防性修复
6. ❌ `call_health_stream()` - 预防性修复
7. ❌ `call_wuxing_proportion_stream()` - 预防性修复
8. ❌ `call_daily_fortune_calendar_stream()` - 预防性修复

**实现方式**：
- 为每个接口添加类似总评接口的重试逻辑
- 或者创建一个通用的重试装饰器/方法

### 方案2：改善空内容检测和处理 ⭐⭐⭐⭐

**问题**：当前代码可能无法正确检测和处理空内容

**需要改进的地方**：
1. **空内容检测**：更严格地检测空内容（区分"确实为空"和"未收集到"）
2. **部分内容保存**：确保即使传输中断，也能保存部分内容
3. **错误信息**：区分不同类型的空内容原因

**改进点**：
- 在 `_post_stream()` 中增强空内容检测
- 在结果处理中增加空内容验证
- 提供更详细的错误信息

### 方案3：统一重试机制（推荐）⭐⭐⭐⭐⭐

**优势**：
- 代码复用，减少重复
- 统一的重试策略
- 易于维护

**实现方式**：
1. 创建一个通用的流式接口重试方法
2. 所有流式接口都使用这个重试方法
3. 可配置重试参数（重试次数、退避策略）

## 详细修复计划

### 步骤1：创建通用重试方法

**文件**: `scripts/evaluation/api_client.py`
**方法**: `_post_stream_with_retry()`

```python
async def _post_stream_with_retry(
    self, 
    endpoint: str, 
    data: Dict[str, Any],
    max_retries: int = 3,
    retry_on_empty: bool = True  # 是否对空内容重试
) -> StreamResponse:
    """
    带重试的流式接口调用
    
    Args:
        endpoint: API端点
        data: 请求数据
        max_retries: 最大重试次数
        retry_on_empty: 是否对空内容重试
        
    Returns:
        StreamResponse对象
    """
    # 重试逻辑...
```

### 步骤2：改善空内容检测

**文件**: `scripts/evaluation/api_client.py`
**方法**: `_post_stream()`

**改进点**：
1. 更严格地检测空内容
2. 区分"完全空"和"部分内容"
3. 提供详细的错误信息

```python
# 检测空内容
if not result.content and not result.data and not result.error:
    # 检查是否真的没有收到任何数据
    if not progress_chunks:
        result.error = "API 返回空内容（未收到任何数据）"
    else:
        result.error = "API 返回空内容（收到数据但无法解析）"
```

### 步骤3：修改各接口使用重试方法

**修改方式**：
- 将所有流式接口的调用改为使用 `_post_stream_with_retry()`
- 或者直接在方法内部调用重试逻辑

**需要修改的方法**：
1. `call_marriage_analysis_stream()`
2. `call_xishen_jishen_stream()`
3. `call_children_study_stream()`
4. `call_career_wealth_stream()`
5. `call_health_stream()`
6. `call_wuxing_proportion_stream()`
7. `call_daily_fortune_calendar_stream()`

### 步骤4：增强结果处理中的空内容检测

**文件**: `scripts/evaluation/bazi_evaluator.py`
**方法**: `evaluate_single()`

**改进点**：
- 在处理结果时，检测空内容并记录
- 提供更详细的错误信息

## 实施步骤

### 阶段1：创建通用重试机制
- [ ] 创建 `_post_stream_with_retry()` 方法
- [ ] 改善空内容检测逻辑

### 阶段2：修改各接口
- [ ] 修改 `call_marriage_analysis_stream()`（重点）
- [ ] 修改 `call_xishen_jishen_stream()`（重点）
- [ ] 修改 `call_children_study_stream()`（重点）
- [ ] 修改其他接口（预防性）

### 阶段3：增强结果处理
- [ ] 改善结果处理中的空内容检测
- [ ] 提供更详细的错误信息

### 阶段4：测试验证
- [ ] 测试传输错误的修复
- [ ] 测试空内容的处理
- [ ] 验证重试机制是否生效

## 风险评估

### ✅ 低风险

1. **复用总评接口的修复方案**：已验证的解决方案
2. **只修改评测脚本**：不影响底层和前端
3. **向后兼容**：不影响现有正常调用

### ⚠️ 需要注意

1. **重试次数**：避免过度重试导致服务器负载过高
2. **空内容判断**：需要准确区分"真的空"和"未收集到"
3. **部分内容保存**：确保部分内容也能正确保存

## 代码变更范围

### 修改的文件

1. **`scripts/evaluation/api_client.py`**
   - 创建通用重试方法
   - 修改各流式接口方法
   - 改善空内容检测

2. **`scripts/evaluation/bazi_evaluator.py`**（可选）
   - 增强结果处理中的空内容检测

### 不改动的文件

- ❌ 底层服务代码（`server/api/v1/`）
- ❌ 前端代码（`local_frontend/`）
- ❌ 其他不相关的文件

## 预期效果

修复后应该：
1. ✅ 减少或消除传输错误（TransferEncodingError）
2. ✅ 提高接口调用成功率（通过重试机制）
3. ✅ 更好地处理空内容（提供详细错误信息）
4. ✅ 即使传输中断，也能保存部分内容

## 测试建议

### 测试1：传输错误修复

```bash
python3 scripts/evaluation/bazi_evaluator.py \
    --input /Users/zhoudt/Desktop/副本10.xlsx \
    --platform coze \
    --concurrency 5 \
    --verbose
```

**验证点**：
- ✅ 感情婚姻接口不再出现传输错误
- ✅ 喜神忌神接口不再出现传输错误
- ✅ 子女学习接口不再出现传输错误

### 测试2：空内容处理

**验证点**：
- ✅ 空内容有明确的错误信息
- ✅ 区分不同类型的空内容原因
- ✅ 部分内容能正确保存
