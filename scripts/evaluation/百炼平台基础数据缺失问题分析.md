# 百炼平台基础数据缺失问题分析

## 问题描述

使用 `--platform bailian` 时，基础八字信息（日元、五行数量、十神、五行喜忌、旺衰、十神格局等）没有提取出来。

## 问题定位

### 代码流程分析

**文件**: `scripts/evaluation/bazi_evaluator.py`
**方法**: `evaluate_single()`

**当前逻辑**：

```python
# 阶段1：并行调用 Coze API
if self.config.use_coze:  # ← 问题在这里！
    coze_tasks = [
        self.api_client.call_bazi_data(...),  # ← 基础数据接口在这里
        self.api_client.call_rizhu_liujiazi(...),
        # ... 其他接口
    ]
    coze_results = await asyncio.gather(*coze_tasks, ...)

# 阶段2：处理 Coze API 返回结果
unified_data = coze_results[0] if coze_results[0] else {}  # ← 如果 use_coze=False，这里是空字典
results['basic'] = self._format_basic_data_from_unified(unified_data)  # ← 空数据
```

### 根本原因

**问题**：基础数据接口 `call_bazi_data()` 被放在了 `if self.config.use_coze:` 分支内

**影响**：
- ✅ 使用 `--platform coze` 时：基础数据正常提取
- ❌ 使用 `--platform bailian` 时：基础数据接口**根本没有被调用**
- ✅ 使用 `--platform both` 时：基础数据正常提取（因为 use_coze=True）

**为什么基础数据应该独立于平台**：
1. 基础数据（日元、五行、十神等）是**计算类接口**，不依赖大模型
2. 无论使用 Coze 还是百炼，都需要基础数据
3. 基础数据接口 `/bazi/data` 是后端计算接口，不是大模型接口

## 问题影响

### 缺失的数据

当使用 `--platform bailian` 时，以下数据无法提取：

| 数据项 | Excel列 | 状态 |
|-------|---------|------|
| 日元（日柱） | DAY_STEM (列5) | ❌ 缺失 |
| 五行数量 | WUXING (列6) | ❌ 缺失 |
| 十神（主星，副星） | SHISHEN (列7) | ❌ 缺失 |
| 五行喜忌 | XI_JI (列8) | ❌ 缺失 |
| 旺衰 | WANGSHUAI (列9) | ❌ 缺失 |
| 十神格局 | GEJU (列10) | ❌ 缺失 |
| 大运流年 | DAYUN_LIUNIAN (列11) | ❌ 缺失 |

### 受影响的功能

1. **Excel 输出**：基础数据列全部为空
2. **百炼 Prompt**：`_build_bailian_prompt()` 方法中，`basic_data` 参数为空，导致百炼智能体无法获取完整的八字信息
3. **数据完整性**：评测结果不完整

## 解决方案

### 方案：基础数据接口独立调用

**原则**：基础数据接口应该**独立于平台选择**，无论使用哪个平台都要调用。

**修改点**：

1. **将基础数据接口调用移出 `if self.config.use_coze:` 分支**
2. **基础数据接口应该始终调用**（无论平台选择）
3. **只有大模型分析接口才需要根据平台选择**

### 修改后的逻辑

```python
# 阶段1：调用基础数据接口（独立于平台）
basic_data_task = self.api_client.call_bazi_data(solar_date, solar_time, gender)
basic_data_result = await basic_data_task
results['basic'] = self._format_basic_data_from_unified(basic_data_result)

# 阶段2：根据平台选择调用大模型接口
if self.config.use_coze:
    # Coze 大模型接口...
    
if self.config.use_bailian:
    # 百炼大模型接口...
    # 使用 results['basic'] 构建 prompt
```

## 代码修改位置

### 需要修改的文件

**文件**: `scripts/evaluation/bazi_evaluator.py`
**方法**: `evaluate_single()`

**修改内容**：
1. 将 `call_bazi_data()` 从 `if self.config.use_coze:` 分支中移出
2. 独立调用基础数据接口
3. 确保基础数据在处理百炼接口之前就已经获取

## 验证方法

修复后，使用以下命令测试：

```bash
python3 scripts/evaluation/bazi_evaluator.py \
    --input /Users/zhoudt/Desktop/副本10.xlsx \
    --platform bailian \
    --row 2 \
    --verbose
```

**验证点**：
- ✅ 基础数据列（日元、五行、十神等）有数据
- ✅ Excel 输出包含完整的八字信息
- ✅ 百炼智能体能获取到完整的八字信息
