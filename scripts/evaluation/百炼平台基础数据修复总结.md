# 百炼平台基础数据修复总结

## 修复完成时间
2026-01-07

## 问题描述

使用 `--platform bailian` 时，基础八字信息（日元、五行数量、十神、五行喜忌、旺衰、十神格局等）没有提取出来。

## 根本原因

基础数据接口 `call_bazi_data()` 被放在了 `if self.config.use_coze:` 分支内，导致：
- ✅ `--platform coze`：基础数据正常提取
- ❌ `--platform bailian`：基础数据接口**根本没有被调用**
- ✅ `--platform both`：基础数据正常提取

## 修复方案

### 核心修改

**原则**：基础数据接口应该**独立于平台选择**，无论使用哪个平台都要调用。

### 修改内容

#### 1. 基础数据接口独立调用

**修改前**：
```python
if self.config.use_coze:
    coze_tasks = [
        call_bazi_data(),  # ← 基础数据在这里
        call_rizhu_liujiazi(),
        # ...
    ]
```

**修改后**：
```python
# 阶段0：基础数据接口独立调用（始终调用）
unified_data = await self.api_client.call_bazi_data(...)
results['basic'] = self._format_basic_data_from_unified(unified_data)

# 阶段1：Coze 大模型接口（只包含大模型接口）
if self.config.use_coze:
    coze_tasks = [
        call_rizhu_liujiazi(),  # ← 基础数据已移出
        # ...
    ]
```

#### 2. 索引调整

由于基础数据从 `coze_tasks` 中移出，所有 `coze_results` 的索引需要 -1：

| 接口 | 原索引 | 新索引 | 说明 |
|-----|--------|--------|------|
| 基础数据 | 0 | 独立调用 | 不再在 coze_results 中 |
| 日元-六十甲子 | 1 | 0 | ✅ 已调整 |
| 五行占比 | 2 | 1 | ✅ 已调整 |
| 喜神忌神 | 3 | 2 | ✅ 已调整 |
| 事业财富 | 4 | 3 | ✅ 已调整 |
| 感情婚姻 | 5 | 4 | ✅ 已调整 |
| 身体健康 | 6 | 5 | ✅ 已调整 |
| 子女学习 | 7 | 6 | ✅ 已调整 |
| 总评 | 8 | 7 | ✅ 已调整 |
| 每日运势 | 9 | 8 | ✅ 已调整 |

## 修改的文件

**文件**: `scripts/evaluation/bazi_evaluator.py`
**方法**: `evaluate_single()`

**修改点**：
1. ✅ 新增阶段0：基础数据接口独立调用
2. ✅ 从 `coze_tasks` 中移除基础数据接口
3. ✅ 调整 `coze_results` 数组大小（从10改为9）
4. ✅ 调整所有索引（-1）
5. ✅ 更新 `stream_mapping` 索引

## 修复效果

### ✅ 修复前

| 平台模式 | 基础数据 | 状态 |
|---------|---------|------|
| `--platform coze` | ✅ 正常 | 正常 |
| `--platform both` | ✅ 正常 | 正常 |
| `--platform bailian` | ❌ 缺失 | **问题** |

### ✅ 修复后

| 平台模式 | 基础数据 | 状态 |
|---------|---------|------|
| `--platform coze` | ✅ 正常 | 正常（行为不变） |
| `--platform both` | ✅ 正常 | 正常（行为不变） |
| `--platform bailian` | ✅ 正常 | **已修复** |

## 验证方法

### 测试1：百炼平台（修复的问题）

```bash
python3 scripts/evaluation/bazi_evaluator.py \
    --input /Users/zhoudt/Desktop/副本10.xlsx \
    --platform bailian \
    --row 2 \
    --verbose
```

**验证点**：
- ✅ 基础数据列（日元、五行、十神等）有数据
- ✅ Excel 输出包含完整的八字信息
- ✅ 百炼智能体能获取到完整的八字信息

### 测试2：Coze 平台（确保现有功能正常）

```bash
python3 scripts/evaluation/bazi_evaluator.py \
    --input /Users/zhoudt/Desktop/副本10.xlsx \
    --platform coze \
    --row 2 \
    --verbose
```

**验证点**：
- ✅ 基础数据正常提取
- ✅ Coze 大模型接口正常调用
- ✅ Excel 输出正常

### 测试3：双平台（确保双平台功能正常）

```bash
python3 scripts/evaluation/bazi_evaluator.py \
    --input /Users/zhoudt/Desktop/副本10.xlsx \
    --platform both \
    --row 2 \
    --verbose
```

**验证点**：
- ✅ 基础数据正常提取
- ✅ Coze 和百炼接口都正常调用
- ✅ Excel 输出包含双平台结果

## 代码变更详情

### 新增代码

```python
# ==================== 阶段0：调用基础数据接口（独立于平台，始终调用）====================
self._log_progress("  调用基础数据接口...")
basic_data_start = time.time()

try:
    unified_data = await self.api_client.call_bazi_data(solar_date, solar_time, gender)
    if isinstance(unified_data, Exception):
        self._log(f"  统一数据接口异常: {unified_data}", "WARN")
        results['basic'] = self._format_basic_data_from_unified({})
    else:
        results['basic'] = self._format_basic_data_from_unified(unified_data)
except Exception as e:
    self._log(f"  统一数据接口异常: {e}", "WARN")
    results['basic'] = self._format_basic_data_from_unified({})

# 如果从八字列解析出了日柱，使用八字列的日柱（优先级更高）
if test_case.day_pillar:
    results['basic']['day_stem'] = test_case.day_pillar

basic_data_time = time.time() - basic_data_start
self._log_progress(f"  基础数据接口完成，耗时: {basic_data_time:.1f}秒")
```

### 修改的代码

1. **coze_tasks 数组**：移除基础数据接口
2. **coze_results 大小**：从 10 改为 9
3. **索引调整**：所有索引 -1
4. **stream_mapping**：所有索引 -1

## 安全性保证

### ✅ 向后兼容

1. **`--platform coze`**：行为完全不变
2. **`--platform both`**：行为完全不变
3. **`--platform bailian`**：修复问题，新增功能

### ✅ 逻辑更清晰

1. **职责分离**：基础数据独立，不依赖平台选择
2. **代码结构**：阶段0（基础数据）→ 阶段1（Coze）→ 阶段2（百炼）
3. **易于维护**：基础数据修改不影响平台选择逻辑

## 注意事项

1. **索引调整**：所有 `coze_results` 索引已正确调整
2. **异常处理**：基础数据异常不影响后续处理
3. **性能影响**：基础数据独立调用，可能略微增加调用时间（但逻辑更清晰）

## 相关文档

- **问题分析**: `scripts/evaluation/百炼平台基础数据缺失问题分析.md`
- **影响分析**: `scripts/evaluation/修改方案影响分析.md`
