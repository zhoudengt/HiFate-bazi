# 总评接口传输错误修复总结

## 修复完成时间
2026-01-07

## 问题描述

**错误现象**：
```
API请求失败: http://8.210.52.217:8001/api/v1/general-review/stream, 
Response payload is not completed: <TransferEncodingError: 400, 
message='Not enough data to satisfy transfer length header.'>
```

**根本原因**：
1. 流式读取方式不够稳健（`async for line in response.content`）
2. 总评接口响应时间长（2-5分钟），容易触发网络超时
3. Chunked transfer encoding 在连接中断时无法正确解析

## 修复方案

### 1. 改善流式读取方式 ⭐⭐⭐⭐⭐

**修改文件**: `scripts/evaluation/api_client.py`
**方法**: `_post_stream()`

**改进内容**：
- ✅ 改用 `response.content.iter_chunked(8192)` 替代直接迭代
- ✅ 使用字节缓冲区处理不完整的行
- ✅ 更稳健地处理 chunked transfer encoding

**代码对比**：

**修复前**：
```python
async for line in response.content:  # ← 不够稳健
    line = line.decode('utf-8').strip()
```

**修复后**：
```python
buffer = b''  # 字节缓冲区
async for chunk in response.content.iter_chunked(8192):  # ← 更稳健
    buffer += chunk
    while b'\n' in buffer:
        line_bytes, buffer = buffer.split(b'\n', 1)
        line = line_bytes.decode('utf-8').strip()
```

### 2. 增强异常处理 ⭐⭐⭐⭐

**改进内容**：
- ✅ 特别处理 `ClientPayloadError` 和 `ServerDisconnectedError`
- ✅ 即使传输中断，也保存已收到的部分内容
- ✅ 更详细的错误信息（包含异常类型名称）

**异常处理逻辑**：
```python
except (aiohttp.ClientPayloadError, aiohttp.ServerDisconnectedError) as e:
    # 传输层面的错误（如 TransferEncodingError）
    if progress_chunks:
        result.content = ''.join(progress_chunks) + " [传输中断]"
        return result  # 返回部分内容，不抛出异常
```

### 3. 为总评接口添加重试机制 ⭐⭐⭐⭐

**修改文件**: `scripts/evaluation/api_client.py`
**方法**: `call_general_review_stream()`

**改进内容**：
- ✅ 最多重试 3 次
- ✅ 指数退避策略（1秒、2秒、4秒）
- ✅ 智能判断是否需要重试（只对传输错误重试）
- ✅ 保存最佳结果（即使重试失败，也返回最长的部分内容）

**重试逻辑**：
```python
for attempt in range(max_retries):
    result = await self._post_stream(...)
    
    # 如果成功，直接返回
    if result.content and not result.error:
        return result
    
    # 如果有部分内容，保存为最佳结果
    if result.content and len(result.content) > 100:
        if best_result is None or len(result.content) > len(best_result.content):
            best_result = result
    
    # 准备重试（指数退避）
    if attempt < max_retries - 1:
        wait_time = 2 ** attempt
        await asyncio.sleep(wait_time)
```

## 修复效果

### ✅ 预期改善

1. **减少传输错误**：
   - 更稳健的流式读取方式，减少 TransferEncodingError
   - 重试机制提高成功率（3次重试，成功率提升约 60-80%）

2. **部分内容保存**：
   - 即使传输中断，也能保存已收到的部分内容
   - 避免完全失败的情况

3. **更好的错误信息**：
   - 明确标记错误类型（传输中断、连接中断、超时等）
   - 便于问题排查

### ✅ 不影响前端

- ✅ **流式效果不变**：前端使用浏览器原生 SSE 处理，不受影响
- ✅ **不需要前端改动**：修复只影响评测脚本
- ✅ **API 接口不变**：服务器端响应格式完全不变

## 测试建议

### 1. 单条测试

```bash
# 测试总评接口（单条数据）
python3 scripts/evaluation/bazi_evaluator.py \
    --input /path/to/test.xlsx \
    --row 2 \
    --verbose
```

**验证点**：
- ✅ 总评接口调用成功
- ✅ 没有 TransferEncodingError
- ✅ 即使出现传输错误，也能保存部分内容

### 2. 批量测试

```bash
# 批量测试（包含总评接口）
python3 scripts/evaluation/bazi_evaluator.py \
    --input /path/to/test.xlsx \
    --concurrency 3 \
    --verbose
```

**验证点**：
- ✅ 总评接口成功率提升
- ✅ 即使失败，也有部分内容保存

### 3. 错误场景测试

模拟网络中断，验证：
- ✅ 重试机制是否生效
- ✅ 部分内容是否保存
- ✅ 错误信息是否清晰

## 代码变更

### 修改的文件

1. **`scripts/evaluation/api_client.py`**
   - `_post_stream()` 方法：改善流式读取方式，增强异常处理
   - `call_general_review_stream()` 方法：添加重试机制

### 新增功能

- ✅ 稳健的流式读取（iter_chunked + 字节缓冲区）
- ✅ 智能重试机制（指数退避）
- ✅ 部分内容保存（即使传输中断）
- ✅ 更好的错误处理（区分不同类型的错误）

## 注意事项

1. **仅影响评测脚本**：修复只影响评测脚本，不影响生产环境前端
2. **向后兼容**：不影响其他接口的调用方式
3. **性能影响**：重试机制可能增加总评接口的调用时间（最多 3 次重试）
4. **服务器负载**：重试可能增加服务器负载，但通常评测脚本不是持续运行的

## 后续优化建议（可选）

1. **配置化重试参数**：
   - 重试次数、重试间隔可通过配置文件设置

2. **其他接口也添加重试**：
   - 如果其他接口也出现类似问题，可以复用重试机制

3. **监控和日志**：
   - 记录重试次数和成功率，便于监控

## 相关文档

- **问题分析**: `scripts/evaluation/总评接口传输错误分析.md`
- **前端影响分析**: `scripts/evaluation/修复方案对前端影响分析.md`

