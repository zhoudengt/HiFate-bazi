<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½• - HiFate</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fatetell-style.css">
</head>
<body>
    <div class="container">
        <div class="login-box">
            <h1>HiFateç³»ç»Ÿ</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="username" value="admin" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="password" value="admin123" required>
                </div>
                <button type="submit" class="btn btn-primary">ç™»å½•</button>
            </form>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="errorMsg" class="error-msg" style="display: none;"></div>
        </div>
    </div>

    <script>
        // è°ƒè¯•ä¿¡æ¯
        console.log('ğŸ“„ å¼€å§‹åŠ è½½ç™»å½•é¡µé¢è„šæœ¬...');
        
        // æ£€æŸ¥è„šæœ¬åŠ è½½çŠ¶æ€
        let scriptsLoaded = {
            config: false,
            api: false,
            auth: false
        };
        
        function checkAllLoaded() {
            if (scriptsLoaded.config && scriptsLoaded.api && scriptsLoaded.auth) {
                console.log('âœ… æ‰€æœ‰è„šæœ¬å·²åŠ è½½');
                console.log('TOKEN_KEY:', typeof TOKEN_KEY !== 'undefined' ? 'âœ…' : 'âŒ');
                console.log('api:', typeof api !== 'undefined' ? 'âœ…' : 'âŒ');
                console.log('Auth:', typeof Auth !== 'undefined' ? 'âœ…' : 'âŒ');
                
                if (typeof Auth === 'undefined') {
                    console.error('âŒ Auth å¯¹è±¡æœªå®šä¹‰ï¼');
                    const errorMsg = document.getElementById('errorMsg');
                    if (errorMsg) {
                        errorMsg.textContent = 'âŒ Auth å¯¹è±¡æœªå®šä¹‰ï¼è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹è¯¦ç»†é”™è¯¯ã€‚';
                        errorMsg.style.color = 'red';
                    }
                    return false;
                }
                
                if (typeof api === 'undefined') {
                    console.error('âŒ api å¯¹è±¡æœªå®šä¹‰ï¼');
                    const errorMsg = document.getElementById('errorMsg');
                    if (errorMsg) {
                        errorMsg.textContent = 'âŒ api å¯¹è±¡æœªå®šä¹‰ï¼è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹è¯¦ç»†é”™è¯¯ã€‚';
                        errorMsg.style.color = 'red';
                    }
                    return false;
                }
                
                return true;
            }
            return false;
        }
    </script>
    
    <!-- æ ¸å¿ƒå·¥å…·ç±» -->
    <script src="js/core/error-handler.js"></script>
    <script src="js/core/dom-utils.js"></script>
    <script src="js/core/validator.js"></script>
    
    <!-- å…ˆå®šä¹‰ initLoginForm å‡½æ•° -->
    <script>
        function initLoginForm() {
            console.log('ğŸ”§ åˆå§‹åŒ–ç™»å½•è¡¨å•...');
            const loginForm = document.getElementById('loginForm');
            if (!loginForm) {
                console.error('âŒ ç™»å½•è¡¨å•æœªæ‰¾åˆ°');
                return;
            }
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = DomUtils.getFormValue('username');
                const password = DomUtils.getFormValue('password');
                
                // éšè—ä¹‹å‰çš„é”™è¯¯
                ErrorHandler.hideError('errorMessage');
                DomUtils.hide('errorMsg');
                
                // å‚æ•°éªŒè¯
                try {
                    Validator.required(username, 'ç”¨æˆ·å');
                    Validator.required(password, 'å¯†ç ');
                } catch (error) {
                    ErrorHandler.showError(error.message, {
                        containerId: 'errorMessage',
                        scrollTo: true
                    });
                    return;
                }
                
                try {
                    console.log('ğŸ” å¼€å§‹ç™»å½•ï¼Œç”¨æˆ·å:', username);
                    await Auth.login(username, password);
                    console.log('âœ… ç™»å½•æˆåŠŸï¼Œè·³è½¬ä¸­...');
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('âŒ ç™»å½•å¤±è´¥:', error);
                    // ä½¿ç”¨ç»Ÿä¸€é”™è¯¯å¤„ç†
                    if (typeof ErrorHandler !== 'undefined') {
                        ErrorHandler.handleApiError(error, {
                            containerId: 'errorMessage',
                            scrollTo: true
                        });
                    } else {
                        // é™çº§æ–¹æ¡ˆ
                        const errorMsg = document.getElementById('errorMsg');
                        if (errorMsg) {
                            errorMsg.textContent = error.message || 'ç™»å½•å¤±è´¥';
                            errorMsg.style.color = 'red';
                            errorMsg.style.display = 'block';
                        }
                    }
                }
            });
            
            console.log('âœ… ç™»å½•è¡¨å•åˆå§‹åŒ–å®Œæˆ');
        }
    </script>
    
    <!-- é…ç½®å’ŒAPI -->
    <script src="config.js" 
            onload="console.log('âœ… config.js åŠ è½½æˆåŠŸ'); scriptsLoaded.config = true; checkAllLoaded();"
            onerror="console.error('âŒ config.js åŠ è½½å¤±è´¥'); if (typeof ErrorHandler !== 'undefined') { ErrorHandler.showError('config.js åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„'); } else { document.getElementById('errorMsg').textContent = 'âŒ config.js åŠ è½½å¤±è´¥'; document.getElementById('errorMsg').style.color = 'red'; }"></script>
    
    <script src="js/api.js"
            onload="console.log('âœ… api.js åŠ è½½æˆåŠŸ'); scriptsLoaded.api = true; checkAllLoaded();"
            onerror="console.error('âŒ api.js åŠ è½½å¤±è´¥'); if (typeof ErrorHandler !== 'undefined') { ErrorHandler.showError('api.js åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„'); } else { document.getElementById('errorMsg').textContent = 'âŒ api.js åŠ è½½å¤±è´¥'; document.getElementById('errorMsg').style.color = 'red'; }"></script>
    
    <script src="js/auth.js"
            onload="console.log('âœ… auth.js åŠ è½½æˆåŠŸ'); scriptsLoaded.auth = true; checkAllLoaded(); if (typeof initLoginForm === 'function') { initLoginForm(); }"
            onerror="console.error('âŒ auth.js åŠ è½½å¤±è´¥'); if (typeof ErrorHandler !== 'undefined') { ErrorHandler.showError('auth.js åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„'); } else { document.getElementById('errorMsg').textContent = 'âŒ auth.js åŠ è½½å¤±è´¥'; document.getElementById('errorMsg').style.color = 'red'; }"></script>
    
    <script>
        // å¤‡ç”¨æ£€æŸ¥ï¼šå¦‚æœ window.load æ—¶è„šæœ¬è¿˜æ²¡åŠ è½½å®Œï¼Œå†æ¬¡æ£€æŸ¥
        window.addEventListener('load', function() {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
            setTimeout(function() {
                if (!checkAllLoaded()) {
                    console.warn('âš ï¸ è„šæœ¬å¯èƒ½æœªå®Œå…¨åŠ è½½ï¼Œå†æ¬¡æ£€æŸ¥...');
                    if (typeof Auth !== 'undefined' && typeof api !== 'undefined' && typeof initLoginForm === 'function') {
                        initLoginForm();
                    }
                } else if (typeof initLoginForm === 'function') {
                    // å¦‚æœæ‰€æœ‰è„šæœ¬å·²åŠ è½½ä½†è¡¨å•æœªåˆå§‹åŒ–ï¼Œå†æ¬¡åˆå§‹åŒ–
                    initLoginForm();
                }
            }, 100);
        });
    </script>
</body>
</html>

