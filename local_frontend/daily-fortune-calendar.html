<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥è¿åŠ¿ - HiFateç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fatetell-layout.css">
    <script src="js/sidebar.js?v=20250115"></script>
    <style>
        .calendar-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .date-selector {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .date-selector label {
            font-weight: bold;
            color: #333;
        }
        
        .date-selector input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .date-selector button {
            padding: 8px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .date-selector button:hover {
            background: #0056b3;
        }
        
        .fortune-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 1200px) {
            .fortune-layout {
                grid-template-columns: 1fr;
            }
        }
        
        .info-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .info-card h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: bold;
            color: #666;
        }
        
        .info-value {
            color: #333;
        }
        
        .fortune-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .fortune-content h3 {
            margin-top: 0;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .fortune-content p {
            line-height: 1.8;
            color: #333;
            white-space: pre-line;
        }
        
        .fortune-content.empty {
            color: #999;
            font-style: italic;
        }
        
        .login-prompt {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-content">
            <div class="content-header">
                <div class="header-left">
                    <button class="back-btn" onclick="history.back()">â†</button>
                    <h1 class="header-title">æ¯æ—¥è¿åŠ¿</h1>
                </div>
                <div class="header-user">
                    <button onclick="Auth.logout()" class="btn btn-secondary">é€€å‡º</button>
                </div>
            </div>
            
            <div class="content-body">
                <div class="calendar-container">
                    <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
                    <div class="date-selector">
                        <label for="dateInput">é€‰æ‹©æ—¥æœŸï¼š</label>
                        <input type="date" id="dateInput" value="">
                        <button onclick="queryFortune()">æŸ¥è¯¢</button>
                        <button onclick="queryToday()">ä»Šå¤©</button>
                    </div>
                    
                    <!-- åŠ è½½æç¤º -->
                    <div id="loading" class="loading" style="display: none;">
                        æ­£åœ¨åŠ è½½æ¯æ—¥è¿åŠ¿ä¿¡æ¯...
                    </div>
                    
                    <!-- é”™è¯¯æç¤º -->
                    <div id="error" class="error" style="display: none;"></div>
                    
                    <!-- å†…å®¹åŒºåŸŸ -->
                    <div id="content" style="display: none;">
                        <div class="fortune-layout">
                            <!-- å·¦ä¾§ï¼šåŸºç¡€ä¸‡å¹´å†ä¿¡æ¯ -->
                            <div>
                                <div class="info-card">
                                    <h2>ğŸ“… åŸºç¡€ä¿¡æ¯</h2>
                                    <div class="info-row">
                                        <span class="info-label">å½“å‰é˜³å†æ—¥æœŸï¼š</span>
                                        <span class="info-value" id="solarDate"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">å½“å‰é˜´å†æ—¥æœŸï¼š</span>
                                        <span class="info-value" id="lunarDate"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">å½“å‰æ˜ŸæœŸå‡ ï¼š</span>
                                        <span class="info-value" id="weekday"></span>
                                    </div>
                                </div>
                                
                                <div class="info-card" style="margin-top: 20px;">
                                    <h2>ğŸ“‹ ä¸‡å¹´å†ä¿¡æ¯</h2>
                                    <div class="info-row">
                                        <span class="info-label">å®œï¼š</span>
                                        <span class="info-value" id="yi"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">å¿Œï¼š</span>
                                        <span class="info-value" id="ji"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">å‰å‡¶ç­‰çº§ï¼š</span>
                                        <span class="info-value" id="luckLevel"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">ç¥ç…æ–¹ä½ï¼šå–œç¥</span>
                                        <span class="info-value" id="xishen"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">ç¥ç…æ–¹ä½ï¼šè´¢ç¥</span>
                                        <span class="info-value" id="caishen"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">ç¥ç…æ–¹ä½ï¼šç¦ç¥</span>
                                        <span class="info-value" id="fushen"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">å†²åˆç…ï¼šå†²</span>
                                        <span class="info-value" id="chong"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">å†²åˆç…ï¼šåˆ</span>
                                        <span class="info-value" id="he"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">å†²åˆç…ï¼šç…</span>
                                        <span class="info-value" id="sha"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">å»ºé™¤ï¼š</span>
                                        <span class="info-value" id="jianchuName"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">åˆ†æ•°ï¼š</span>
                                        <span class="info-value" id="jianchuScore"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">èƒç¥ï¼š</span>
                                        <span class="info-value" id="taishen"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">è§£é‡Šï¼š</span>
                                        <span class="info-value" id="taishenExplanation" style="white-space: pre-line;"></span>
                                    </div>
                                </div>
                                
                                <div class="info-card" style="margin-top: 20px;">
                                    <h2>ğŸ‘¤ å‘½ä¸»ä¿¡æ¯</h2>
                                    <div class="info-row">
                                        <span class="info-label">æ—¥ä¸»ï¼š</span>
                                        <span class="info-value" id="rizhu"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">ä»Šæ—¥åç¥ï¼š</span>
                                        <span class="info-value" id="todayShishen"></span>
                                    </div>
                                </div>
                                
                                <div class="info-card" style="margin-top: 20px;">
                                    <h2>ğŸ¨ å¹¸è¿é¢œè‰²</h2>
                                    <div class="info-row">
                                        <span class="info-label">å¹¸è¿é¢œè‰²ï¼š</span>
                                        <span class="info-value" id="luckyColors"></span>
                                    </div>
                                </div>
                                
                                <div class="info-card" style="margin-top: 20px;">
                                    <h2>ğŸ§­ æ–¹ä½æŒ‡å¼•</h2>
                                    <div class="info-row">
                                        <span class="info-label">è´µäººæŒ‡è·¯ï¼š</span>
                                        <span class="info-value" id="guirenDirections"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">ç˜Ÿç¥æ–¹ä½ï¼š</span>
                                        <span class="info-value" id="wenshenDirections"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å³ä¾§ï¼šè¿åŠ¿å†…å®¹ -->
                            <div>
                                <!-- æ•´ä½“è¿åŠ¿ -->
                                <div class="fortune-content">
                                    <h3>æ•´ä½“è¿åŠ¿ï¼š</h3>
                                    <p id="jiaziFortune" class="empty">æš‚æ— æ•°æ®</p>
                                </div>
                                
                                <!-- åç¥æç¤º -->
                                <div class="fortune-content">
                                    <h3>åç¥æç¤ºï¼š</h3>
                                    <div id="shishenHintContainer">
                                        <p id="shishenHint" class="empty">æš‚æ— æ•°æ®</p>
                                        <div id="loginPrompt" class="login-prompt" style="display: none;">
                                            ğŸ’¡ æç¤ºï¼šç™»å½•åå¯æŸ¥çœ‹åŸºäºæ‚¨ç”Ÿè¾°çš„åç¥æç¤º
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ç”Ÿè‚–ç®€è¿ -->
                                <div class="fortune-content">
                                    <h3>ç”Ÿè‚–ç®€è¿ï¼š</h3>
                                    <p id="zodiacRelations" class="empty">æš‚æ— æ•°æ®</p>
                                </div>
                                
                                <!-- èƒ½é‡å°ç»“ -->
                                <div class="fortune-content">
                                    <h3>èƒ½é‡å°ç»“ï¼š</h3>
                                    <p id="jianchuSummary" class="empty">æš‚æ— æ•°æ®</p>
                                </div>
                                
                                <!-- è¡ŒåŠ¨å»ºè®® -->
                                <div class="fortune-content">
                                    <h3>è¡ŒåŠ¨å»ºè®®ï¼š</h3>
                                    <div id="actionSuggestionsContainer">
                                        <p id="actionSuggestions" class="empty">æš‚æ— æ•°æ®</p>
                                        <button id="generateActionSuggestionsBtn" onclick="generateActionSuggestions()" style="display: none; margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ç”Ÿæˆå»ºè®®</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            Auth.checkAuth();
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            // è‡ªåŠ¨æŸ¥è¯¢ä»Šå¤©çš„è¿åŠ¿
            queryFortune();
        });
        
        // æŸ¥è¯¢æŒ‡å®šæ—¥æœŸçš„è¿åŠ¿
        async function queryFortune() {
            const dateInput = document.getElementById('dateInput');
            const date = dateInput.value || new Date().toISOString().split('T')[0];
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('content').style.display = 'none';
            
            try {
                // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
                const userInfo = UserInfo.load();
                const requestData = {
                    date: date
                };
                
                // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ·»åŠ ç”Ÿè¾°ä¿¡æ¯
                if (userInfo && userInfo.solar_date && userInfo.solar_time && userInfo.gender) {
                    requestData.solar_date = userInfo.solar_date;
                    requestData.solar_time = userInfo.solar_time;
                    requestData.gender = userInfo.gender;
                }
                
                // è°ƒç”¨API
                const result = await api.post('/daily-fortune-calendar/query', requestData);
                
                if (result.success) {
                    displayFortune(result);
                } else {
                    showError(result.error || 'è·å–æ¯æ—¥è¿åŠ¿å¤±è´¥');
                }
            } catch (error) {
                console.error('æŸ¥è¯¢æ¯æ—¥è¿åŠ¿å¤±è´¥:', error);
                showError(error.message || 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // æŸ¥è¯¢ä»Šå¤©çš„è¿åŠ¿
        function queryToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            queryFortune();
        }
        
        // æ˜¾ç¤ºè¿åŠ¿ä¿¡æ¯
        function displayFortune(data) {
            // æ˜¾ç¤ºå†…å®¹åŒºåŸŸ
            document.getElementById('content').style.display = 'block';
            
            // åŸºç¡€ä¿¡æ¯
            document.getElementById('solarDate').textContent = data.solar_date || 'æš‚æ— ';
            document.getElementById('lunarDate').textContent = data.lunar_date || 'æš‚æ— ';
            document.getElementById('weekday').textContent = `${data.weekday || ''} (${data.weekday_en || ''})`;
            
            // ä¸‡å¹´å†ä¿¡æ¯
            document.getElementById('yi').textContent = (data.yi && data.yi.length > 0) ? data.yi.join('ã€') : 'æš‚æ— ';
            document.getElementById('ji').textContent = (data.ji && data.ji.length > 0) ? data.ji.join('ã€') : 'æš‚æ— ';
            document.getElementById('luckLevel').textContent = data.luck_level || 'æš‚æ— ';
            
            // ç¥ç…æ–¹ä½
            const deities = data.deities || {};
            document.getElementById('xishen').textContent = deities.xishen || 'æš‚æ— ';
            document.getElementById('caishen').textContent = deities.caishen || 'æš‚æ— ';
            document.getElementById('fushen').textContent = deities.fushen || 'æš‚æ— ';
            
            // å†²åˆç…
            const chongHeSha = data.chong_he_sha || {};
            document.getElementById('chong').textContent = chongHeSha.chong || 'æš‚æ— ';
            document.getElementById('he').textContent = chongHeSha.he || 'æš‚æ— ';
            document.getElementById('sha').textContent = chongHeSha.sha || 'æš‚æ— ';
            
            // å»ºé™¤ï¼ˆåŒ…å«åˆ†æ•°ï¼‰
            const jianchu = data.jianchu || {};
            document.getElementById('jianchuName').textContent = jianchu.name || 'æš‚æ— ';
            document.getElementById('jianchuScore').textContent = jianchu.score !== null && jianchu.score !== undefined ? jianchu.score : 'æš‚æ— ';
            
            // èƒç¥
            document.getElementById('taishen').textContent = data.taishen || 'æš‚æ— ';
            document.getElementById('taishenExplanation').textContent = data.taishen_explanation || 'æš‚æ— ';
            
            // å‘½ä¸»ä¿¡æ¯
            const masterInfo = data.master_info || {};
            document.getElementById('rizhu').textContent = masterInfo.rizhu || 'æš‚æ— ';
            
            // ä»Šæ—¥åç¥æ˜¾ç¤ºé€»è¾‘
            const todayShishenEl = document.getElementById('todayShishen');
            const userInfo = UserInfo.load();
            if (masterInfo.today_shishen && masterInfo.today_shishen !== 'éœ€è¦æä¾›ç”Ÿè¾°ä¿¡æ¯') {
                // æœ‰åç¥æ•°æ®ï¼Œç›´æ¥æ˜¾ç¤º
                todayShishenEl.textContent = masterInfo.today_shishen;
            } else if (userInfo && userInfo.solar_date && userInfo.solar_time && userInfo.gender) {
                // ç”¨æˆ·å·²ç™»å½•ä¸”æœ‰ç”Ÿè¾°ä¿¡æ¯ï¼Œä½†æŸ¥è¯¢å¤±è´¥
                todayShishenEl.textContent = 'æš‚æ— ';
            } else if (userInfo) {
                // ç”¨æˆ·å·²ç™»å½•ä½†æ²¡æœ‰ç”Ÿè¾°ä¿¡æ¯
                todayShishenEl.textContent = 'è¯·å®Œå–„ç”Ÿè¾°ä¿¡æ¯ä»¥æŸ¥çœ‹ä»Šæ—¥åç¥';
            } else {
                // ç”¨æˆ·æœªç™»å½•
                todayShishenEl.textContent = 'ç™»å½•åå¯æŸ¥çœ‹åŸºäºæ‚¨ç”Ÿè¾°çš„ä»Šæ—¥åç¥';
            }
            
            // å¹¸è¿é¢œè‰²
            document.getElementById('luckyColors').textContent = data.lucky_colors || 'æš‚æ— ';
            
            // æ–¹ä½æŒ‡å¼•
            document.getElementById('guirenDirections').textContent = data.guiren_directions || 'æš‚æ— ';
            document.getElementById('wenshenDirections').textContent = data.wenshen_directions || 'æš‚æ— ';
            
            // ä¿å­˜å®œå¿Œæ•°æ®ç”¨äºç”Ÿæˆè¡ŒåŠ¨å»ºè®®
            window.currentYi = data.yi || [];
            window.currentJi = data.ji || [];
            
            // è¿åŠ¿å†…å®¹
            const jiaziFortuneEl = document.getElementById('jiaziFortune');
            if (data.jiazi_fortune) {
                jiaziFortuneEl.textContent = data.jiazi_fortune;
                jiaziFortuneEl.classList.remove('empty');
            } else {
                jiaziFortuneEl.textContent = 'æš‚æ— æ•°æ®';
                jiaziFortuneEl.classList.add('empty');
            }
            
            const shishenHintEl = document.getElementById('shishenHint');
            const loginPromptEl = document.getElementById('loginPrompt');
            if (data.shishen_hint) {
                shishenHintEl.textContent = data.shishen_hint;
                shishenHintEl.classList.remove('empty');
                loginPromptEl.style.display = 'none';
            } else {
                shishenHintEl.textContent = 'æš‚æ— æ•°æ®';
                shishenHintEl.classList.add('empty');
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
                const userInfo = UserInfo.load();
                if (!userInfo || !userInfo.solar_date) {
                    loginPromptEl.style.display = 'block';
                } else {
                    loginPromptEl.style.display = 'none';
                }
            }
            
            const zodiacRelationsEl = document.getElementById('zodiacRelations');
            if (data.zodiac_relations) {
                zodiacRelationsEl.textContent = data.zodiac_relations;
                zodiacRelationsEl.classList.remove('empty');
            } else {
                zodiacRelationsEl.textContent = 'æš‚æ— æ•°æ®';
                zodiacRelationsEl.classList.add('empty');
            }
            
            const jianchuSummaryEl = document.getElementById('jianchuSummary');
            // ä½¿ç”¨ä¹‹å‰å·²å£°æ˜çš„ jianchu å˜é‡
            if (jianchu && jianchu.summary) {
                jianchuSummaryEl.textContent = jianchu.summary;
                jianchuSummaryEl.classList.remove('empty');
            } else {
                jianchuSummaryEl.textContent = 'æš‚æ— æ•°æ®';
                jianchuSummaryEl.classList.add('empty');
            }
            
            // è¡ŒåŠ¨å»ºè®® - è‡ªåŠ¨å¼€å§‹ç”Ÿæˆ
            const actionSuggestionsEl = document.getElementById('actionSuggestions');
            const generateBtn = document.getElementById('generateActionSuggestionsBtn');
            
            // éšè—æŒ‰é’®ï¼ˆä¸å†éœ€è¦ç‚¹å‡»ï¼‰
            if (generateBtn) {
                generateBtn.style.display = 'none';
            }
            
            // å¦‚æœæœ‰å®œå¿Œæ•°æ®ï¼Œè‡ªåŠ¨å¼€å§‹ç”Ÿæˆè¡ŒåŠ¨å»ºè®®
            if (data.yi && data.yi.length > 0 || data.ji && data.ji.length > 0) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                actionSuggestionsEl.textContent = 'æ­£åœ¨ç”Ÿæˆå»ºè®®...';
                actionSuggestionsEl.classList.remove('empty');
                
                // è‡ªåŠ¨è°ƒç”¨ç”Ÿæˆå‡½æ•°ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
                generateActionSuggestions();
            } else {
                actionSuggestionsEl.textContent = 'æš‚æ— æ•°æ®';
                actionSuggestionsEl.classList.add('empty');
            }
        }
        
        // ç”Ÿæˆè¡ŒåŠ¨å»ºè®®ï¼ˆæµå¼ï¼‰- è‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€æŒ‰é’®
        async function generateActionSuggestions() {
            const yi = window.currentYi || [];
            const ji = window.currentJi || [];
            
            if (yi.length === 0 && ji.length === 0) {
                const actionSuggestionsEl = document.getElementById('actionSuggestions');
                actionSuggestionsEl.textContent = 'æ²¡æœ‰å®œå¿Œæ•°æ®ï¼Œæ— æ³•ç”Ÿæˆå»ºè®®';
                actionSuggestionsEl.classList.add('empty');
                return;
            }
            
            const actionSuggestionsEl = document.getElementById('actionSuggestions');
            
            // æ¸…ç©ºå†…å®¹ï¼Œå‡†å¤‡æ˜¾ç¤ºæµå¼è¾“å‡º
            actionSuggestionsEl.textContent = '';
            actionSuggestionsEl.classList.remove('empty');
            
            try {
                // è°ƒç”¨æµå¼API
                const apiBaseUrl = API_CONFIG.baseURL.replace('/api/v1', '');
                const response = await fetch(`${apiBaseUrl}/api/v1/daily-fortune-calendar/action-suggestions/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        yi: yi,
                        ji: ji
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // è¯»å–SSEæµ
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                
                                if (data.type === 'progress') {
                                    // è¿½åŠ å†…å®¹
                                    if (data.content) {
                                        actionSuggestionsEl.textContent += data.content;
                                    }
                                } else if (data.type === 'complete') {
                                    // å®Œæˆ
                                    if (data.content && data.content.trim()) {
                                        actionSuggestionsEl.textContent = data.content;
                                    } else if (actionSuggestionsEl.textContent.trim()) {
                                        // å¦‚æœå·²æœ‰å†…å®¹ï¼Œä¿æŒç°æœ‰å†…å®¹
                                        // ä¸åšä»»ä½•æ“ä½œ
                                    } else {
                                        // å¦‚æœå®Œæˆä½†æ²¡æœ‰å†…å®¹ï¼Œæ˜¾ç¤ºé”™è¯¯
                                        actionSuggestionsEl.textContent = 'ç”Ÿæˆå¤±è´¥ï¼šè¿”å›å†…å®¹ä¸ºç©º';
                                        actionSuggestionsEl.classList.add('empty');
                                        showError('ç”Ÿæˆå¤±è´¥ï¼šè¿”å›å†…å®¹ä¸ºç©º');
                                    }
                                    return;
                                } else if (data.type === 'error') {
                                    // é”™è¯¯
                                    actionSuggestionsEl.textContent = data.content || 'ç”Ÿæˆå¤±è´¥';
                                    actionSuggestionsEl.classList.add('empty');
                                    showError(data.content || 'ç”Ÿæˆå¤±è´¥');
                                    return;
                                }
                            } catch (e) {
                                console.error('è§£æSSEæ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }
                
                // æµç»“æŸï¼ˆæ­£å¸¸å®Œæˆï¼‰
                
            } catch (error) {
                console.error('ç”Ÿæˆè¡ŒåŠ¨å»ºè®®å¤±è´¥:', error);
                actionSuggestionsEl.textContent = 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                actionSuggestionsEl.classList.add('empty');
                showError(error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
    </script>
</body>
</html>

