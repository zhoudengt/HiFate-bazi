# 前端测试体系配置指南

> **本指南说明如何配置 Vitest（单元测试）和 Playwright（E2E测试）。**

## 一、测试体系概览

### 1.1 测试金字塔

```
        /\
       /E2E\         少量端到端测试（关键流程）
      /------\
     /Integration\   适量集成测试（模块间交互）
    /------------\
   /    Unit      \  大量单元测试（工具类、服务类）
  /----------------\
```

### 1.2 测试覆盖率目标

- 工具类（core/）：> 90%
- 服务类（services/）：> 70%
- 功能模块（features/）：> 60%
- E2E测试（关键流程）：> 80%

## 二、Vitest 单元测试配置

### 2.1 安装依赖

```bash
npm install -D vitest @vitest/ui jsdom
```

### 2.2 创建 vitest.config.js

```javascript
import { defineConfig } from 'vite';

export default defineConfig({
  test: {
    globals: true,
    environment: 'jsdom',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'tests/',
        '*.config.js'
      ]
    },
    include: ['tests/unit/**/*.test.js']
  }
});
```

### 2.3 package.json 脚本

```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:watch": "vitest --watch"
  }
}
```

## 三、单元测试示例

### 3.1 错误处理工具测试

**文件**：`tests/unit/error-handler.test.js`

```javascript
import { describe, it, expect, beforeEach } from 'vitest';
import { ErrorHandler } from '../../js/core/error-handler.js';

describe('ErrorHandler', () => {
  beforeEach(() => {
    document.body.innerHTML = '';
  });

  it('应该显示错误消息', () => {
    ErrorHandler.showError('测试错误');
    const errorDiv = document.getElementById('errorMessage');
    expect(errorDiv).toBeTruthy();
    expect(errorDiv.textContent).toContain('测试错误');
  });

  it('应该处理API错误', () => {
    const error = new Error('网络错误');
    ErrorHandler.handleApiError(error);
    const errorDiv = document.getElementById('errorMessage');
    expect(errorDiv).toBeTruthy();
  });
});
```

### 3.2 DOM工具测试

**文件**：`tests/unit/dom-utils.test.js`

```javascript
import { describe, it, expect, beforeEach } from 'vitest';
import { DomUtils } from '../../js/core/dom-utils.js';

describe('DomUtils', () => {
  beforeEach(() => {
    document.body.innerHTML = '<div id="test"></div>';
  });

  it('应该设置元素文本', () => {
    DomUtils.setText('test', '测试文本');
    const element = document.getElementById('test');
    expect(element.textContent).toBe('测试文本');
  });

  it('应该显示元素', () => {
    const element = document.getElementById('test');
    element.style.display = 'none';
    DomUtils.show('test');
    expect(element.style.display).toBe('block');
  });
});
```

### 3.3 验证工具测试

**文件**：`tests/unit/validator.test.js`

```javascript
import { describe, it, expect } from 'vitest';
import { Validator } from '../../js/core/validator.js';

describe('Validator', () => {
  it('应该验证日期格式', () => {
    expect(() => Validator.date('1990-01-15')).not.toThrow();
    expect(() => Validator.date('invalid')).toThrow();
  });

  it('应该验证时间格式', () => {
    expect(() => Validator.time('12:00')).not.toThrow();
    expect(() => Validator.time('25:00')).toThrow();
  });

  it('应该验证八字输入', () => {
    const validData = {
      solar_date: '1990-01-15',
      solar_time: '12:00',
      gender: 'male'
    };
    expect(() => Validator.baziInput(validData)).not.toThrow();
  });
});
```

## 四、Playwright E2E测试配置

### 4.1 安装依赖

```bash
npm install -D @playwright/test
npx playwright install
```

### 4.2 创建 playwright.config.js

```javascript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:8080',
    trace: 'on-first-retry'
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] }
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] }
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] }
    }
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:8080',
    reuseExistingServer: !process.env.CI
  }
});
```

### 4.3 package.json 脚本

```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:debug": "playwright test --debug"
  }
}
```

## 五、E2E测试示例

### 5.1 登录流程测试

**文件**：`tests/e2e/login.test.js`

```javascript
import { test, expect } from '@playwright/test';

test('应该能够登录', async ({ page }) => {
  await page.goto('/login.html');
  
  await page.fill('#username', 'admin');
  await page.fill('#password', 'admin123');
  await page.click('#loginBtn');
  
  await expect(page).toHaveURL(/index\.html/);
});
```

### 5.2 八字计算测试

**文件**：`tests/e2e/bazi.test.js`

```javascript
import { test, expect } from '@playwright/test';

test('应该能够计算八字', async ({ page }) => {
  await page.goto('/pan.html');
  
  await page.fill('#solar_date', '1990-01-15');
  await page.fill('#solar_time', '12:00');
  await page.selectOption('#gender', 'male');
  await page.click('#submitBtn');
  
  await expect(page.locator('#result')).toBeVisible();
});
```

### 5.3 错误处理测试

**文件**：`tests/e2e/error-handling.test.js`

```javascript
import { test, expect } from '@playwright/test';

test('应该显示错误消息', async ({ page }) => {
  await page.goto('/pan.html');
  
  // 提交空表单
  await page.click('#submitBtn');
  
  // 检查错误消息是否显示
  await expect(page.locator('#errorMessage')).toBeVisible();
  await expect(page.locator('#errorMessage')).toContainText('不能为空');
});
```

## 六、CI/CD 集成

### 6.1 GitHub Actions 示例

**文件**：`.github/workflows/frontend-test.yml`

```yaml
name: Frontend Tests

on:
  push:
    branches: [ master ]
    paths:
      - 'local_frontend/**'
  pull_request:
    branches: [ master ]
    paths:
      - 'local_frontend/**'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        cd local_frontend
        npm ci
    
    - name: Run linter
      run: |
        cd local_frontend
        npm run lint
    
    - name: Run unit tests
      run: |
        cd local_frontend
        npm run test:coverage
    
    - name: Run E2E tests
      run: |
        cd local_frontend
        npm run test:e2e
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        directory: ./local_frontend/coverage
```

## 七、测试执行规范

### 7.1 本地开发

```bash
# 运行所有测试
npm test

# 运行单元测试
npm run test

# 运行E2E测试
npm run test:e2e

# 监视模式（开发时）
npm run test:watch
```

### 7.2 提交前

```bash
# 运行所有测试和检查
npm run lint
npm run format:check
npm test
npm run test:e2e
```

### 7.3 CI/CD

- 每次提交自动运行测试
- 测试失败阻止合并
- 覆盖率报告自动生成

## 八、最佳实践

1. **测试命名**：清晰描述测试内容
2. **测试独立性**：每个测试独立运行
3. **测试覆盖**：优先覆盖关键路径
4. **测试维护**：及时更新测试用例
5. **测试速度**：保持测试快速执行

---

**配置完成后，所有代码提交前会自动运行测试。**

