<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢ç›¸åˆ†æ - HiFateç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fatetell-layout.css">
    <style>
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9f9f9;
        }
        .upload-area:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background: #e7f3ff;
        }
        .preview-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            margin-top: 20px;
        }
        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            display: block;
        }
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 165, 0, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 165, 0, 0.15) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 8px;
        }
        .grid-overlay.active {
            opacity: 1;
        }
        .status-overlay {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        .status-overlay.active {
            opacity: 1;
        }
        .status-overlay::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .play-button.active {
            opacity: 1;
            pointer-events: auto;
        }
        .play-button::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 20px solid #007bff;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            margin-left: 5px;
        }
        .bazi-form {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .insight-item {
            padding: 10px;
            margin: 10px 0;
            background: #f0f8ff;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .category-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .category-title {
            margin: 0 0 12px 0;
            font-size: 18px;
            font-weight: 600;
            color: #007bff;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .category-insights {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .insight-item .category {
            font-weight: bold;
            color: #007bff;
        }
        .recommendation-item {
            padding: 10px;
            margin: 5px 0;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .error {
            padding: 15px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-content">
            <div class="content-header">
                <div class="header-left">
                    <h1 class="header-title">é¢ç›¸åˆ†æ</h1>
                </div>
                <div class="header-user">
                    <a href="index.html" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
                </div>
            </div>
            
            <div class="content-body">
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <p>ğŸ“· ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å¤´éƒ¨é¢ç›¸ç…§ç‰‡</p>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®æ­£é¢æ¸…æ™°ç…§ç‰‡ï¼Œå°ºå¯¸ 800x600 ä»¥ä¸Š
                        </p>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    </div>
                    <div class="preview-container" id="previewContainer" style="display: none;">
                        <img id="previewImage" class="preview-image">
                        <div class="grid-overlay" id="gridOverlay"></div>
                        <div class="status-overlay" id="statusOverlay">æ­£åœ¨è¯†åˆ«é¢éƒ¨ç‰¹å¾</div>
                        <div class="play-button" id="playButton"></div>
                    </div>
                </div>

                <div class="bazi-form" id="baziForm">
                    <h3>å…«å­—ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œæä¾›åå¯ç”Ÿæˆæ›´å‡†ç¡®çš„æŠ¥å‘Šï¼‰</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="useBazi" checked> ç»“åˆå…«å­—åˆ†æ
                        </label>
                    </div>
                    <div id="baziFields">
                        <div class="form-group">
                            <label>é˜³å†æ—¥æœŸï¼š</label>
                            <input type="date" id="solarDate">
                        </div>
                        <div class="form-group">
                            <label>å‡ºç”Ÿæ—¶é—´ï¼š</label>
                            <input type="time" id="solarTime">
                        </div>
                        <div class="form-group">
                            <label>æ€§åˆ«ï¼š</label>
                            <select id="gender">
                                <option value="male">ç”·</option>
                                <option value="female">å¥³</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeFace()" disabled>
                        å¼€å§‹åˆ†æ
                    </button>
                </div>

                <div id="resultSection" class="result-section" style="display: none;">
                    <h2>åˆ†æç»“æœ</h2>
                    <div id="resultContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•
        Auth.checkAuth();

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewImage = document.getElementById('previewImage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const useBaziCheckbox = document.getElementById('useBazi');
        const baziFields = document.getElementById('baziFields');

        let selectedFile = null;

        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                const previewContainer = document.getElementById('previewContainer');
                previewContainer.style.display = 'block';
                analyzeBtn.disabled = false;
                
                // éšè—ç½‘æ ¼å’ŒçŠ¶æ€æç¤ºï¼ˆç­‰å¾…åˆ†ææ—¶æ˜¾ç¤ºï¼‰
                document.getElementById('gridOverlay').classList.remove('active');
                document.getElementById('statusOverlay').classList.remove('active');
                document.getElementById('playButton').classList.remove('active');
            };
            reader.readAsDataURL(file);
        }

        // å…«å­—ä¿¡æ¯å¼€å…³
        useBaziCheckbox.addEventListener('change', () => {
            baziFields.style.display = useBaziCheckbox.checked ? 'block' : 'none';
        });

        // åˆ†æé¢ç›¸
        async function analyzeFace() {
            if (!selectedFile) {
                alert('è¯·å…ˆä¸Šä¼ å¤´éƒ¨é¢ç›¸ç…§ç‰‡');
                return;
            }

            const useBazi = useBaziCheckbox.checked;
            const solarDate = document.getElementById('solarDate').value;
            const solarTime = document.getElementById('solarTime').value;
            const gender = document.getElementById('gender').value;

            if (useBazi && (!solarDate || !solarTime)) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å…«å­—ä¿¡æ¯');
                return;
            }

            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'åˆ†æä¸­...';

            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');
            resultSection.style.display = 'block';
            resultContent.innerHTML = '<div class="loading">æ­£åœ¨åˆ†æï¼Œè¯·ç¨å€™...</div>';

            // æ˜¾ç¤ºç½‘æ ¼è¦†ç›–å’Œè¿›åº¦æç¤º
            const gridOverlay = document.getElementById('gridOverlay');
            const statusOverlay = document.getElementById('statusOverlay');
            const playButton = document.getElementById('playButton');
            
            gridOverlay.classList.add('active');
            statusOverlay.classList.add('active');
            playButton.classList.add('active');

            try {
                // ä½¿ç”¨æµå¼ API
                const formData = new FormData();
                formData.append('image', selectedFile);
                formData.append('use_bazi', useBazi);
                if (useBazi) {
                    formData.append('solar_date', solarDate);
                    formData.append('solar_time', solarTime);
                    formData.append('gender', gender);
                }

                const token = localStorage.getItem('bazi_token');
                const apiKey = API_CONFIG.fortuneApiKey || 'fortune_analysis_default_key_2024';
                
                // ä½¿ç”¨æµå¼æ¥å£ï¼ˆæ·»åŠ  API Key è®¤è¯ï¼‰
                const headers = {
                    'X-API-Key': apiKey
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`${API_CONFIG.baseURL}/fortune/face/analyze/stream`, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                // ä½¿ç”¨ EventSource å¤„ç† SSE æµ
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let finalData = null;
                let lastReceivedData = null;
                let receivedComplete = false;
                let receivedError = false;

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) {
                            console.log('âœ… SSEæµå·²ç»“æŸ');
                            break;
                        }

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    lastReceivedData = data;
                                    console.log('ğŸ“¥ æ”¶åˆ°SSEæ•°æ®:', data.type, data.statusText || '');
                                    
                                    // å‰ç«¯åªè´Ÿè´£å±•ç¤ºï¼Œä¸åšä¸šåŠ¡é€»è¾‘åˆ¤æ–­
                                    // æ ¹æ®åç«¯è¿”å›çš„æŒ‡ä»¤æ›´æ–°UI
                                    if (data.statusText) {
                                        statusOverlay.textContent = data.statusText;
                                    }
                                    
                                    if (data.showGrid !== undefined) {
                                        if (data.showGrid) {
                                            gridOverlay.classList.add('active');
                                        } else {
                                            gridOverlay.classList.remove('active');
                                        }
                                    }
                                    
                                    if (data.showStatus !== undefined) {
                                        if (data.showStatus) {
                                            statusOverlay.classList.add('active');
                                        } else {
                                            statusOverlay.classList.remove('active');
                                        }
                                    }
                                    
                                    if (data.showPlayButton !== undefined) {
                                        if (data.showPlayButton) {
                                            playButton.classList.add('active');
                                        } else {
                                            playButton.classList.remove('active');
                                        }
                                    }
                                    
                                    // æ ¹æ®ç±»å‹æ›´æ–°ç»“æœåŒºåŸŸ
                                    if (data.type === 'start' || data.type === 'progress') {
                                        resultContent.innerHTML = `<div class="loading">${data.statusText || 'æ­£åœ¨åˆ†æ...'}</div>`;
                                    } else if (data.type === 'complete') {
                                        receivedComplete = true;
                                        finalData = data.data;
                                        console.log('âœ… æ”¶åˆ°completeæ¶ˆæ¯ï¼Œæ•°æ®:', finalData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®');
                                        if (finalData) {
                                            console.log('ğŸ“Š æ•°æ®å†…å®¹:', {
                                                success: finalData.success,
                                                insights_count: finalData.insights?.length || 0,
                                                integrated_insights_count: finalData.integrated_insights?.length || 0,
                                                recommendations_count: finalData.recommendations?.length || 0
                                            });
                                        }
                                    } else if (data.type === 'error') {
                                        receivedError = true;
                                        console.error('âŒ æ”¶åˆ°erroræ¶ˆæ¯:', data.error);
                                        throw new Error(data.error || 'åˆ†æå¤±è´¥');
                                    }
                                } catch (e) {
                                    console.error('âŒ è§£æ SSE æ•°æ®å¤±è´¥:', e, 'åŸå§‹æ•°æ®:', line);
                                    // å¦‚æœæ˜¯JSONè§£æé”™è¯¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œ
                                    if (e instanceof SyntaxError) {
                                        continue;
                                    }
                                    // å¦‚æœæ˜¯ä¸šåŠ¡é”™è¯¯ï¼ˆerrorç±»å‹ï¼‰ï¼ŒæŠ›å‡ºå¼‚å¸¸
                                    throw e;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('âŒ SSEæµå¤„ç†é”™è¯¯:', error);
                    // éšè—æ‰€æœ‰è¦†ç›–å±‚
                    gridOverlay.classList.remove('active');
                    statusOverlay.classList.remove('active');
                    playButton.classList.remove('active');
                    resultContent.innerHTML = `<div class="error">åˆ†æå¤±è´¥: ${error.message}</div>`;
                    return;
                }

                // å¤„ç†æœ€ç»ˆç»“æœ
                if (receivedError) {
                    // å¦‚æœæ”¶åˆ°é”™è¯¯ï¼Œå·²ç»åœ¨catchä¸­å¤„ç†äº†
                    return;
                } else if (receivedComplete && finalData) {
                    console.log('âœ… æ˜¾ç¤ºåˆ†æç»“æœ');
                    displayResult(finalData);
                } else if (receivedComplete && !finalData) {
                    console.error('âš ï¸  æ”¶åˆ°completeæ¶ˆæ¯ä½†dataä¸ºç©º');
                    resultContent.innerHTML = '<div class="error">åˆ†æå®Œæˆï¼Œä½†æ•°æ®ä¸ºç©ºã€‚è¯·æ£€æŸ¥åç«¯æ—¥å¿—ã€‚</div>';
                } else {
                    console.error('âš ï¸  æœªæ”¶åˆ°completeæ¶ˆæ¯ï¼Œæœ€åæ”¶åˆ°çš„æ•°æ®:', lastReceivedData);
                    resultContent.innerHTML = `<div class="error">åˆ†æå®Œæˆï¼Œä½†æœªæ”¶åˆ°å®Œæ•´æ•°æ®ã€‚æœ€åçŠ¶æ€: ${lastReceivedData?.statusText || 'æœªçŸ¥'}</div>`;
                }
            } catch (error) {
                console.error('åˆ†æé”™è¯¯:', error);
                // éšè—æ‰€æœ‰è¦†ç›–å±‚
                gridOverlay.classList.remove('active');
                statusOverlay.classList.remove('active');
                playButton.classList.remove('active');
                
                let errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
                
                if (errorMsg === 'Failed to fetch' || errorMsg.includes('fetch')) {
                    errorMsg = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š1) æœåŠ¡æ˜¯å¦è¿è¡Œ 2) ç½‘ç»œè¿æ¥ 3) æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯';
                }
                
                resultContent.innerHTML = `<div class="error">åˆ†æå¤±è´¥ï¼š${errorMsg}</div>`;
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'å¼€å§‹åˆ†æ';
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(data) {
            const resultContent = document.getElementById('resultContent');
            let html = '';

            // ç‰¹å¾ä¿¡æ¯
            if (data.features) {
                html += '<h3>é¢ç›¸ç‰¹å¾</h3>';
                if (data.features.san_ting_ratio) {
                    html += '<p><strong>ä¸‰åœæ¯”ä¾‹ï¼š</strong></p><ul>';
                    html += `<li>ä¸Šåœï¼š${(data.features.san_ting_ratio.upper * 100).toFixed(1)}%</li>`;
                    html += `<li>ä¸­åœï¼š${(data.features.san_ting_ratio.middle * 100).toFixed(1)}%</li>`;
                    html += `<li>ä¸‹åœï¼š${(data.features.san_ting_ratio.lower * 100).toFixed(1)}%</li>`;
                    html += '</ul>';
                }
            }

            // æŒ‰åˆ†ç±»ç»„ç»‡åˆ†ææ´å¯Ÿï¼ˆå·²å»é‡ï¼Œåªä½¿ç”¨insightsï¼Œå› ä¸ºintegrated_insightså·²åŒ…å«åœ¨insightsä¸­ï¼‰
            const allInsights = [];
            if (data.insights && data.insights.length > 0) {
                allInsights.push(...data.insights);
            }
            // æ³¨æ„ï¼šintegrated_insightså·²ç»åŒ…å«åœ¨insightsä¸­ï¼Œä¸éœ€è¦é‡å¤æ·»åŠ 
            // å¦‚æœåç«¯è¿”å›çš„insightsæ²¡æœ‰åŒ…å«integrated_insightsï¼Œåˆ™æ·»åŠ 
            if (data.integrated_insights && data.integrated_insights.length > 0) {
                // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤ï¼Œåªæ·»åŠ ä¸é‡å¤çš„å†…å®¹
                const existingContents = new Set(allInsights.map(i => i.content || ''));
                data.integrated_insights.forEach(insight => {
                    const content = insight.content || '';
                    // æå–æ ¸å¿ƒå†…å®¹ï¼ˆå»é™¤æ‹¬å·å†…çš„è¯¦ç»†è¯´æ˜ï¼‰ç”¨äºå»é‡
                    const coreContent = content.split(/[ï¼ˆ(]/)[0].trim();
                    if (!existingContents.has(coreContent)) {
                        allInsights.push(insight);
                        existingContents.add(coreContent);
                    }
                });
            }
            
            if (allInsights.length > 0) {
                // æŒ‰åˆ†ç±»åˆ†ç»„ï¼ˆå‰ç«¯å†æ¬¡å»é‡ï¼Œç¡®ä¿æ²¡æœ‰é‡å¤ï¼‰
                const categorizedInsights = {
                    'æ€§æ ¼': [],
                    'å¥åº·': [],
                    'æ™ºæ…§': [],
                    'å­¦ä¹ ': [],
                    'æ„Ÿæƒ…': [],
                    'äº‹ä¸š': [],
                    'è´¢è¿': [],
                    'å¤©èµ‹': [],
                    'è¿åŠ¿': [],
                    'ç‰¹æ®Š': [],
                    'ç»¼åˆ': []
                };
                
                // ä½¿ç”¨Setè®°å½•å·²æ·»åŠ çš„æ ¸å¿ƒå†…å®¹ï¼Œé¿å…é‡å¤
                const seenCoreContents = new Set();
                
                allInsights.forEach(insight => {
                    const content = insight.content || '';
                    // æå–æ ¸å¿ƒå†…å®¹ï¼ˆå»é™¤æ‹¬å·å†…çš„è¯¦ç»†è¯´æ˜ï¼‰ç”¨äºå»é‡
                    const coreContent = content.split(/[ï¼ˆ(]/)[0].trim();
                    
                    // å¦‚æœæ ¸å¿ƒå†…å®¹å·²å­˜åœ¨ï¼Œè·³è¿‡
                    if (seenCoreContents.has(coreContent)) {
                        return;
                    }
                    seenCoreContents.add(coreContent);
                    
                    const category = insight.category || 'ç»¼åˆ';
                    if (categorizedInsights[category]) {
                        categorizedInsights[category].push(insight);
                    } else {
                        categorizedInsights['ç»¼åˆ'].push(insight);
                    }
                });
                
                // æŒ‰åˆ†ç±»æ˜¾ç¤º
                html += '<h3>åˆ†ææ´å¯Ÿ</h3>';
                const categoryNames = {
                    'æ€§æ ¼': 'æ€§æ ¼ç‰¹ç‚¹',
                    'å¥åº·': 'å¥åº·çŠ¶å†µ',
                    'æ™ºæ…§': 'æ™ºæ…§èƒ½åŠ›',
                    'å­¦ä¹ ': 'å­¦ä¹ èƒ½åŠ›',
                    'æ„Ÿæƒ…': 'æ„Ÿæƒ…å©šå§»',
                    'äº‹ä¸š': 'äº‹ä¸šå‘å±•',
                    'è´¢è¿': 'è´¢è¿åˆ†æ',
                    'å¤©èµ‹': 'å¤©èµ‹æ‰èƒ½',
                    'è¿åŠ¿': 'è¿åŠ¿åˆ†æ',
                    'ç‰¹æ®Š': 'ç‰¹æ®Šç‰¹å¾',
                    'ç»¼åˆ': 'ç»¼åˆåˆ†æ'
                };
                
                const categoryOrder = ['æ€§æ ¼', 'å¥åº·', 'æ™ºæ…§', 'å­¦ä¹ ', 'æ„Ÿæƒ…', 'äº‹ä¸š', 'è´¢è¿', 'å¤©èµ‹', 'è¿åŠ¿', 'ç‰¹æ®Š', 'ç»¼åˆ'];
                
                categoryOrder.forEach(category => {
                    if (categorizedInsights[category] && categorizedInsights[category].length > 0) {
                        html += `<div class="category-section">
                            <h4 class="category-title">${categoryNames[category] || category}</h4>
                            <div class="category-insights">`;
                        categorizedInsights[category].forEach(insight => {
                            html += `<div class="insight-item">
                                ${insight.content}
                            </div>`;
                        });
                        html += `</div></div>`;
                    }
                });
            }

            // å»ºè®®
            if (data.recommendations && data.recommendations.length > 0) {
                html += '<h3>å»ºè®®</h3>';
                data.recommendations.forEach(rec => {
                    html += `<div class="recommendation-item">${rec}</div>`;
                });
            }

            // ç½®ä¿¡åº¦
            if (data.confidence) {
                html += `<p style="margin-top: 20px; color: #666;">
                    <strong>åˆ†æç½®ä¿¡åº¦ï¼š</strong>${(data.confidence * 100).toFixed(1)}%
                </p>`;
            }

            resultContent.innerHTML = html;
        }
    </script>
</body>
</html>

