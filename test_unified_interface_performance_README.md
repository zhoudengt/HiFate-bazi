# 统一接口性能测试说明

## 测试目标

本测试脚本用于验证统一接口优化方案的性能指标：

1. **首次响应 < 100ms**（快速模式，只计算当前大运）
2. **预热 < 3秒**（10个大运并行计算）
3. **缓存命中 < 10ms**（从缓存读取数据）

## 测试内容

### 测试1：首次响应性能
- **目标**：< 100ms
- **方法**：使用快速模式（`quick_mode=True`），只计算当前大运
- **测试次数**：10次，取平均值
- **验证**：返回数据完整性（基础八字、大运序列等）

### 测试2：缓存命中性能
- **目标**：< 10ms
- **方法**：先执行一次计算填充缓存，然后多次读取缓存
- **测试次数**：20次，取平均值
- **验证**：缓存读取速度

### 测试3：异步预热性能
- **目标**：< 3秒
- **方法**：并行计算10个大运，测量总耗时
- **验证**：10个大运全部计算完成的时间

### 测试4：端到端性能
- **目标**：首次响应 < 100ms，预热 < 3秒
- **方法**：快速模式 + 异步预热，验证完整流程
- **验证**：首次响应时间和预热完成时间

## 运行测试

```bash
# 直接运行测试脚本
python3 test_unified_interface_performance.py

# 或者使用可执行权限
./test_unified_interface_performance.py
```

## 测试环境要求

1. **Python 3.7+**
2. **项目依赖已安装**（`requirements.txt`）
3. **Redis 服务可用**（用于缓存测试）
4. **数据库连接正常**（用于规则匹配等）

## 测试结果解读

### 通过标准

- ✅ **首次响应**：平均响应时间 < 100ms
- ✅ **缓存命中**：平均响应时间 < 10ms
- ✅ **异步预热**：总耗时 < 3秒
- ✅ **端到端**：首次响应 < 100ms 且预热 < 3秒

### 失败处理

如果测试失败，请检查：

1. **首次响应超时**：
   - 检查是否启用了快速模式
   - 检查是否包含了过多数据（旺衰、身宫命宫、规则匹配等）
   - 检查数据库查询性能

2. **缓存命中超时**：
   - 检查 Redis 连接是否正常
   - 检查缓存键格式是否正确
   - 检查缓存写入是否成功

3. **预热超时**：
   - 检查线程池配置
   - 检查大运计算性能
   - 检查是否有资源竞争

## 性能优化建议

如果测试结果不达标，可以考虑：

1. **减少首次响应数据量**：
   - 将部分数据（如规则匹配）改为异步加载
   - 使用更细粒度的缓存策略

2. **优化缓存性能**：
   - 使用本地内存缓存（L1）优先
   - 优化 Redis 连接池配置

3. **优化预热策略**：
   - 增加线程池大小
   - 使用更高效的并发模型（如 asyncio）

## 注意事项

1. **测试数据隔离**：每次测试使用唯一的测试数据，避免缓存冲突
2. **环境一致性**：确保测试环境与生产环境配置一致
3. **资源监控**：测试时注意监控 CPU、内存、网络等资源使用情况
4. **多次测试**：建议多次运行测试，取平均值作为最终结果

