<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ç”Ÿäº§æµå¼æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: #eee; }
        #output { 
            white-space: pre-wrap; 
            background: #16213e; 
            padding: 20px; 
            border-radius: 8px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.8;
        }
        #status { color: #4cc9f0; margin-bottom: 10px; }
        button { 
            background: #7209b7; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        button:hover { background: #560bad; }
        .progress { color: #4cc9f0; }
    </style>
</head>
<body>
    <h1>ç”Ÿäº§ç¯å¢ƒæµå¼æµ‹è¯•</h1>
    <button onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
    <div id="status">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    <div id="output"></div>

    <script>
    async function startTest() {
        const output = document.getElementById('output');
        const status = document.getElementById('status');
        output.textContent = '';
        status.textContent = 'æ­£åœ¨è¿æ¥ç”Ÿäº§API...';
        
        const API = 'http://8.210.52.217:8001';
        let fullContent = '';
        let charQueue = '';
        let isDisplaying = false;
        
        // é€å­—æ˜¾ç¤º
        function displayChar() {
            if (charQueue.length === 0) {
                isDisplaying = false;
                return;
            }
            isDisplaying = true;
            const char = charQueue[0];
            charQueue = charQueue.slice(1);
            fullContent += char;
            output.textContent = fullContent;
            output.scrollTop = output.scrollHeight;
            setTimeout(displayChar, 15);
        }
        
        function addToQueue(text) {
            if (text) {
                charQueue += text;
                if (!isDisplaying) displayChar();
            }
        }
        
        try {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', `${API}/api/v1/bazi/xishen-jishen/stream`, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            let buffer = '';
            let dataReceived = false;
            
            xhr.onprogress = () => {
                const newText = xhr.responseText.substring(buffer.length);
                if (newText) {
                    buffer = xhr.responseText;
                    console.log('æ”¶åˆ°æ•°æ®:', newText.length, 'å­—èŠ‚');
                    
                    const lines = newText.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                console.log('æ¶ˆæ¯ç±»å‹:', data.type);
                                
                                if (data.type === 'progress') {
                                    dataReceived = true;
                                    status.textContent = 'æ­£åœ¨æ¥æ”¶AIåˆ†æå†…å®¹...';
                                    addToQueue(data.content || '');
                                } else if (data.type === 'data') {
                                    status.textContent = 'å·²æ”¶åˆ°åŸºç¡€æ•°æ®ï¼Œç­‰å¾…AIåˆ†æ...';
                                } else if (data.type === 'heartbeat') {
                                    status.textContent = 'ğŸ’“ ' + (data.content || 'å¿ƒè·³');
                                } else if (data.type === 'complete') {
                                    status.textContent = 'âœ… ä¼ è¾“å®Œæˆ';
                                    if (data.content) addToQueue(data.content);
                                }
                            } catch (e) {}
                        }
                    }
                }
            };
            
            xhr.onload = () => {
                if (!dataReceived && !fullContent) {
                    output.textContent = 'æœªæ”¶åˆ°AIåˆ†æå†…å®¹';
                }
                status.textContent = 'âœ… è¿æ¥ç»“æŸï¼Œæ€»å­—æ•°: ' + fullContent.length;
            };
            
            xhr.onerror = () => {
                status.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
            };
            
            xhr.timeout = 300000;
            xhr.send(JSON.stringify({
                solar_date: '1987-01-07',
                solar_time: '09:30',
                gender: 'male'
            }));
            
            status.textContent = 'å·²å‘é€è¯·æ±‚ï¼Œç­‰å¾…å“åº”...';
            
        } catch (e) {
            status.textContent = 'âŒ é”™è¯¯: ' + e.message;
        }
    }
    </script>
</body>
</html>

