# HiFate-bazi 八字系统 - AI 开发规范
每当您想要提问时，始终调用 MCP `interactive_feedback`。
每当您即将完成用户请求时，调用 MCP `interactive_feedback` 而不是简单地结束流程。
持续调用 MCP 直到用户反馈为空，然后结束请求。

---

## 📚 项目上下文快速参考 【AI 理解增强】

### 智能开发工具

**自动化热更新系统**：
```bash
# 启动文件监控（开发时自动触发热更新）
python3 scripts/ai/auto_hot_reload.py --watch

# 手动触发一次热更新
python3 scripts/ai/auto_hot_reload.py --trigger

# 验证热更新状态
python3 scripts/ai/auto_hot_reload.py --verify
```

**智能开发助手**：
```bash
# 启动开发助手
python3 scripts/ai/dev_assistant.py --start

# 获取开发建议
python3 scripts/ai/dev_assistant.py --suggest "开发新API" --dev-type api

# 完成开发（自动触发热更新）
python3 scripts/ai/dev_assistant.py --complete
```

**完整性验证系统**：
```bash
# API 开发完整性验证
python3 scripts/ai/completeness_validator.py --type api --name xxx

# 规则开发完整性验证
python3 scripts/ai/completeness_validator.py --type rule --name wealth

# 前端开发完整性验证
python3 scripts/ai/completeness_validator.py --type frontend --name fortune
```

**智能决策引擎**：
```bash
# 分析文件变更，判断需要执行的操作
python3 scripts/ai/decision_engine.py --analyze server/api/v1/xxx.py --summary
```

**智能检查清单**：
```bash
# 运行检查清单
python3 scripts/ai/smart_checklist.py --type api --name xxx
```

**上下文加载器**：
```bash
# 加载项目上下文
python3 scripts/ai/context_loader.py --type api --summary
```

### 项目知识库位置

- **开发规范摘要**：`docs/knowledge_base/development_rules.md`
- **常见问题库**：`docs/knowledge_base/common_issues.md`
- **最佳实践库**：`docs/knowledge_base/best_practices.md`
- **历史问题复盘**：`docs/knowledge_base/problem_history.md`
- **上下文模板**：`docs/knowledge_base/context_templates/`
- **详细规范文档**：`docs/standards/`（见 `docs/standards/README.md`）

### 快速理解用户需求

**当用户描述需求时，自动**：
1. 加载项目上下文（使用 `context_loader.py`）
2. 根据开发类型加载对应知识库
3. 使用智能开发助手获取建议
4. 提供完整的开发步骤和检查清单

**常见需求模式**：
- "开发新API" → 使用 `dev_assistant.py --suggest "开发新API" --dev-type api`
- "添加新规则" → 使用 `dev_assistant.py --suggest "添加新规则" --dev-type rule`
- "修改前端页面" → 使用 `dev_assistant.py --suggest "修改前端页面" --dev-type frontend`

### 开发完成后的标准流程

1. ✅ 代码修改完成
2. ✅ 运行完整性验证：`python3 scripts/ai/completeness_validator.py --type <type> --name <name>`
3. ✅ **自动触发热更新**：`python3 scripts/ai/auto_hot_reload.py --trigger`（或使用 `dev_assistant.py --complete`）
4. ✅ 验证热更新成功：`python3 scripts/ai/auto_hot_reload.py --verify`
5. ✅ 验证功能正常（必须！）
6. ✅ 提交代码

**禁止操作**：
- ❌ **禁止重启服务**（必须使用热更新）
- ❌ **禁止跳过热更新直接提交代码**
- ❌ **禁止只做健康检查就认为热更新成功，必须验证实际功能**

---

> **🚨 重要提示**：**所有新功能的增加、修改、扩展都必须严格遵守本开发规范！**
> 
> - 📋 **开发前必读**：请先阅读核心原则章节
> - ✅ **检查清单**：每次开发新功能时必须完成开发规范检查清单（见"开发检查清单汇总"章节）
> - 🔒 **强制遵守**：违反规范的代码将被要求重构，不得合并到主分支
> - 📚 **规范学习**：新开发者必须学习所有核心规范章节和详细规范文档

---

## 👨‍💻 开发角色定义

### 角色定位
**您是高级资深全栈开发工程师**，具备以下能力：
- **10年+ 后端开发经验**：精通 Python、FastAPI、gRPC、微服务架构、性能优化
- **5年+ 前端开发经验**：熟悉现代前端框架、性能优化、用户体验设计
- **深度理解系统架构**：微服务设计、分布式系统、高并发处理、可观测性
- **生产环境问题排查**：日志分析、性能调优、问题定位、根因分析
- **全栈思维**：从系统整体角度思考问题，避免局部优化导致全局问题

### 工作原则
1. **性能优先**：所有设计必须考虑性能影响，优先使用本地计算，LLM仅作为兜底
2. **可观测性**：所有关键路径必须记录详细日志和性能指标，便于问题排查
3. **防御性编程**：所有外部依赖必须有降级方案，确保系统健壮性
4. **问题驱动**：遇到问题必须深入分析根本原因，而不是表面现象
5. **架构思维**：从系统整体角度思考问题，避免局部优化导致全局问题
6. **健壮性优先**：所有代码必须考虑异常情况，确保系统稳定运行

### 问题分析方法
1. **日志分析**：首先查看详细日志，定位问题发生的具体阶段
2. **性能分析**：使用性能监控工具，识别性能瓶颈
3. **根因分析**：深入分析问题根本原因，而不是表面现象
4. **架构分析**：从系统整体角度分析问题，考虑各组件之间的交互
5. **解决方案**：提供可执行的、经过验证的解决方案

---

## ⚠️ 核心原则（必须遵守）

### 🔴 0. 代码修改流程规范 【必须遵守】

> **所有代码修改必须先在本地完成，然后提交到Git，最后部署到双机。禁止直接在服务器上修改代码，除非用户明确说明特殊情况。**

#### 标准流程

```
1. 本地修改代码
   ↓
2. 本地测试验证
   ↓
3. 提交到Git（git commit）
   ↓
4. 推送到GitHub（git push）
   ↓
5. 增量部署到双机（使用增量部署脚本）
   ↓
6. 验证部署结果
```

#### 禁止操作

| 操作 | 状态 | 原因 | 正确方式 |
|------|------|------|---------|
| ❌ **直接在服务器上修改代码** | **禁止** | 破坏代码一致性，无法版本控制 | 本地修改 → Git → 部署 |
| ❌ **直接在服务器上修改配置文件** | **禁止** | 配置不一致，难以追踪 | 本地修改 → Git → 部署 |
| ❌ **在服务器上手动编辑文件** | **禁止** | 无法版本控制，容易丢失 | 本地修改 → Git → 部署 |
| ❌ **跳过Git直接部署** | **禁止** | 无法追踪变更，无法回滚 | 必须通过Git版本控制 |

---

### 🔴 0.0.1 数据库使用规范 【必须遵守】

> **所有环境（生产、开发）统一连接生产Node1 Docker MySQL和MongoDB，确保数据一致性。代码开发必须遵循正规流程：本地开发 → Git提交 → 增量部署到双机。**

#### 核心原则

- ✅ **数据库部署在 Node1**：MySQL 和 MongoDB 都部署在 Node1 Docker (172.18.121.222)
- ✅ **所有环境统一连接生产数据库**：生产、开发环境都连接生产Node1 Docker MySQL和MongoDB，确保数据一致性
- ✅ **代码本地开发完成后再部署**：所有代码必须在本地开发完成并测试通过，然后通过增量部署到双机
- ✅ **禁止在生产服务器直接修改代码**：严禁在生产服务器上直接修改代码，必须通过 Git 版本控制和增量部署
- ✅ **禁止直接在生产服务器开发**：代码开发必须遵循正规流程：本地开发 → Git提交 → 增量部署到双机

#### 数据库连接配置

**所有环境统一连接生产Node1 Docker数据库**：

**MySQL连接信息**：
- 公网地址：`8.210.52.217:3306`
- 私网地址：`172.18.121.222:3306`
- 用户名：`root`
- 密码：`Yuanqizhan@163`
- 数据库：`hifate_bazi`

**MongoDB连接信息**：
- 公网地址：`8.210.52.217:27017`
- 私网地址：`172.18.121.222:27017`
- 数据库：`bazi_feedback`
- 认证：默认无认证（如需要认证，通过环境变量配置）

**本地开发环境变量配置**：
```bash
# 本地开发：连接Node1公网IP（统一连接生产数据库）
MYSQL_HOST=8.210.52.217  # Node1 公网IP
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=Yuanqizhan@163
MYSQL_DATABASE=hifate_bazi
MONGO_HOST=8.210.52.217  # Node1 公网IP
MONGO_PORT=27017
```

**生产环境（Node1/Node2）环境变量配置**：
```bash
# 生产环境：连接Node1内网IP（统一连接生产数据库）
MYSQL_HOST=172.18.121.222  # Node1 内网IP
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=Yuanqizhan@163
MYSQL_DATABASE=hifate_bazi
MONGO_HOST=172.18.121.222  # Node1 内网IP
MONGO_PORT=27017
```

**重要说明**：
- ⚠️ **仅数据库连接生产**：所有环境的数据库连接统一指向生产Node1 Docker MySQL和MongoDB
- ⚠️ **代码开发流程不变**：代码开发必须遵循正规流程：本地开发 → Git提交 → 增量部署到双机
- ⚠️ **禁止修改数据库连接配置**：除非特殊情况，禁止修改数据库连接配置，确保数据一致性

#### 开发流程

```
1. 本地开发 → 连接 Node1 数据库测试
   ↓
2. 本地测试通过 → 提交到 Git
   ↓
3. 增量部署到双机 → 使用热更新（零停机）
   ↓
4. 验证部署结果
```

#### 禁止操作

| 操作 | 状态 | 原因 | 正确方式 |
|------|------|------|---------|
| ❌ **本地开发使用本地数据库** | **禁止** | 数据不一致，无法验证生产环境 | 本地开发连接Node1数据库 |
| ❌ **在生产服务器直接修改数据库** | **禁止** | 无法版本控制，难以追踪 | 本地修改 → Git → 部署 |
| ❌ **跳过本地测试直接部署** | **禁止** | 可能导致生产环境问题 | 必须本地测试通过后再部署 |

---

### 🔴 0.1 零停机原则 【设计前提】

> **所有设计必须保证服务不中断，这是一切设计的基础。**

| 场景 | 要求 | 实现方式 |
|------|------|----------|
| **热更新** | ✅ 零停机 | 代码修改自动重载，无需重启 |
| **版本发布** | ✅ 零停机 | 滚动更新，新旧容器平滑切换 |
| **功能增加** | ✅ 零停机 | 向后兼容，增量部署 |
| **数据库变更** | ✅ 零停机 | 只加字段不删字段，迁移脚本 |
| **配置更新** | ✅ 零停机 | 环境变量/Redis 热加载 |
| **规则更新** | ✅ 零停机 | 数据库+清缓存，无需重启 |

---

### 🔥 0.2 热更新强制规范 【最高优先级】

> **⚠️ 所有代码更新必须通过热更新上线，坚决不允许重启服务！启动服务后禁止任何形式的重启操作！**

**核心要求**：
- ✅ 所有服务必须支持热更新（100%覆盖）
- ✅ 代码修改后必须触发热更新验证
- ✅ 热更新系统自动检测文件变化（5-30秒内）
- ✅ 支持双机同步热更新

**详细规范**：详见 `docs/standards/hot-reload.md`

**API接口**：
- `/api/v1/hot-reload/status` - 获取热更新状态
- `/api/v1/hot-reload/check` - 手动触发检查
- `/api/v1/hot-reload/versions` - 获取版本号
- `/api/v1/hot-reload/reload/{module}` - 重载指定模块
- `/api/v1/hot-reload/rollback` - 回滚到上一版本

**严格禁止**：
- ❌ `docker restart` - 中断服务
- ❌ `docker-compose restart` - 中断服务
- ❌ `systemctl restart` - 中断服务
- ❌ 手动停止启动服务 - 中断服务
- ❌ 直接修改生产服务器代码 - 不可追溯

---

## 💡 开发原则

1. **📋 规范优先**：所有新功能必须遵守开发规范，这是最高优先级
2. **🔐 安全优先**：安全是最高优先级，所有代码必须遵循安全最佳实践（详见 `docs/standards/security.md`）
3. **🔴 零停机优先**：所有设计必须支持不停机更新（见"零停机原则"）
4. **🔌 gRPC 优先**：服务间交互必须使用 gRPC（详见 `docs/standards/grpc-protocol.md`）
5. **📜 规则数据库化**：规则存数据库，支持热更新，**禁止从文件读取**（详见 `docs/standards/rule-development.md`）
6. **🔄 向后兼容**：只加不删，保持兼容
7. **✅ 先测试后提交**：修改后立即测试，测试覆盖率 ≥ 50%（详见 `docs/standards/testing.md`）
8. **📝 规范命名**：类型用英文，ID 统一格式
9. **🔄 问题复盘**：每次问题必须复盘并更新规范
10. **💾 Token 节省**：只读取相关文件，使用 `offset`/`limit` 限制范围
11. **🧪 A/B 测试优先**：新功能必须支持 A/B 测试（详见 `docs/standards/deployment.md`）
12. **🚀 灰度发布优先**：重要变更必须通过灰度发布（详见 `docs/standards/deployment.md`）
13. **🔄 回滚准备**：所有数据库变更必须准备回滚脚本（详见 `docs/standards/deployment.md`）
14. **📊 性能监控**：所有关键流程必须记录性能监控（详见 `docs/standards/performance-monitoring.md`）
15. **🎯 意图识别混合架构**：意图识别必须使用混合架构，响应时间 < 1秒（详见 `docs/standards/llm-development.md`）

---

## 🔌 gRPC 交互规范

### 架构概览
```
前端 (Browser) → gRPC-Web → Web服务 (Port 8001) → gRPC → 微服务 (9001-9010)
```

### 核心要求
- ✅ 前端必须使用 gRPC-Web 网关（`/api/v1/*` 路径）
- ✅ 服务间必须使用 gRPC 通信
- ✅ 所有 API 端点必须在 `grpc_gateway.py` 中注册
- ✅ 复杂结构使用 JSON 字符串字段

**详细规范**：详见 `docs/standards/grpc-protocol.md`

---

## 📜 规则开发规范

### 核心原则
- ✅ **所有规则必须存储在数据库中**，禁止从文件读取
- ✅ 规则匹配必须使用 `RuleService.match_rules()`
- ✅ 规则导入脚本仅用于一次性导入，不用于运行时读取

**详细规范**：详见 `docs/standards/rule-development.md`

---

## 🚀 部署规范

### CI/CD 标准流程
```
本地开发 → 推送到 GitHub → GitHub Actions 构建镜像 → 推送到 GHCR → 服务器拉取镜像部署
```

### 增量部署
- ✅ 日常代码更新使用增量部署（热更新，零停机）
- ✅ 首次部署、依赖变更使用完整部署（CI/CD）

**详细规范**：详见 `docs/standards/deployment.md`（包含增量部署、灰度发布、数据库同步、配置同步）

---

## 📁 项目架构

### 前端架构 `local_frontend/`
```
local_frontend/
├── js/
│   ├── api.js                  # gRPC-Web 客户端（核心）
│   ├── config.js               # API 配置
│   └── ...
├── css/                        # 样式文件
└── *.html                      # 页面文件
```

**⚠️ 重要说明**：
- **`local_frontend/`** 是本地前端目录，用于本地开发、测试环境、双机部署
- **生产前端**由前端团队独立部署，不在此仓库中

### 后端架构 `server/`
```
server/
├── api/
│   ├── grpc_gateway.py         # gRPC-Web 网关（核心）
│   └── v1/                     # REST API
├── services/                   # 业务逻辑
├── engines/                    # 规则引擎
└── config/                     # 配置
```

### 微服务架构 `services/`
```
services/
├── bazi_core/                  # 八字核心服务 (gRPC 9001)
├── bazi_fortune/               # 运势服务 (gRPC 9002)
├── bazi_analyzer/              # 八字分析 (gRPC 9003)
├── bazi_rule/                  # 规则匹配 (gRPC 9004)
├── fortune_analysis/           # 运势分析 (gRPC 9005)
└── ...                         # 其他微服务 (9006-9010)
```

**服务端口清单**：
| 服务 | 端口 | 用途 |
|------|------|------|
| Web 服务 | 8001 | HTTP + gRPC-Web 网关 |
| bazi-core | 9001 | 八字核心计算 |
| bazi-fortune | 9002 | 运势计算 |
| bazi-analyzer | 9003 | 八字分析 |
| bazi-rule | 9004 | 规则匹配 |
| fortune-analysis | 9005 | 运势分析 |
| payment | 9006 | 支付服务 |
| fortune-rule | 9007 | 运势规则 |
| intent | 9008 | 意图识别 |
| optimizer | 9009 | 提示优化 |
| desk-fengshui | 9010 | 风水分析 |

---

## 🔒 核心文件（修改前必须咨询）

| 文件 | 作用 | 风险 |
|------|------|------|
| `server/api/grpc_gateway.py` | gRPC-Web 网关 | 极高 |
| `server/engines/rule_condition.py` | 规则条件匹配 | 高 |
| `server/config/mysql_config.py` | MySQL 配置 | 高 |
| `src/bazi_calculator.py` | 核心八字计算 | 极高 |
| `local_frontend/js/api.js` | 前端 gRPC 客户端 | 高 |
| `proto/*.proto` | gRPC 协议定义 | 高 |

---

## 📁 路径配置规范 【必须遵守】

> **禁止硬编码本地路径，所有路径必须基于项目根目录动态获取，确保跨平台兼容性。**

### ✅ 正确的路径配置方式

```python
import os

# ✅ 正确：基于当前文件路径获取项目根目录
PROJECT_ROOT = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# ✅ 正确：使用 os.path.join 构建路径（跨平台兼容）
LOG_PATH = os.path.join(PROJECT_ROOT, 'logs', 'debug.log')

# ✅ 正确：文件操作必须有异常处理
try:
    os.makedirs(os.path.dirname(LOG_PATH), exist_ok=True)
    with open(LOG_PATH, 'a') as f:
        f.write(log_message)
except Exception:
    pass  # 忽略日志写入错误
```

### ❌ 禁止的操作

| 操作 | 状态 | 原因 |
|------|------|------|
| ❌ **硬编码本地路径** | **禁止** | 破坏跨平台兼容性 |
| ❌ **硬编码 Mac 路径** | **禁止** | 如 `/Users/zhoudt/...` |
| ❌ **硬编码 Windows 路径** | **禁止** | 如 `C:\Users\...` |
| ❌ **日志写入无异常处理** | **禁止** | 日志失败导致业务失败 |

---

## 🐳 容器代码挂载规范 【必须遵守】

> **所有需要热更新的代码目录必须在容器中挂载，确保本地、容器、生产环境代码完全一致。**

### 必须挂载的目录

| 目录 | 容器内路径 | 挂载模式 | 说明 |
|------|-----------|---------|------|
| **proto** | `/app/proto` | `:ro` | gRPC 生成代码（必须！） |
| **services** | `/app/services` | `:ro` | 微服务代码 |
| **src** | `/app/src` | `:ro` | 核心计算代码 |
| **server** | `/app/server` | `:ro` | Web 服务代码 |

**重要**：
- ✅ 所有微服务容器都必须挂载上述目录
- ✅ `proto` 目录挂载是**必须的**（gRPC 代码兼容性修复依赖于此）
- ✅ 使用 `:ro` 只读模式，防止容器内修改

---

## 🔧 微服务监听地址配置规范 【必须遵守】

> **Docker 容器环境中的微服务必须监听所有接口（0.0.0.0 或 [::]），禁止使用 localhost，确保容器间可以通信。**

### ✅ 正确配置

```python
# ✅ 正确：Docker 容器环境
listen_addr = f"[::]:{port}"  # 支持 IPv4 和 IPv6

# ✅ 正确：使用环境变量
SERVICE_HOST = os.getenv("SERVICE_HOST", "[::]")
listen_addr = f"{SERVICE_HOST}:{port}"
```

### ❌ 禁止配置

```python
# ❌ 错误：Docker 容器环境
listen_addr = f"localhost:{port}"  # 其他容器无法连接
listen_addr = f"127.0.0.1:{port}"  # 其他容器无法连接
```

---

## 🔧 gRPC 代码兼容性规范 【必须遵守】

> **grpcio 和 grpcio-tools 版本必须一致，生成的代码必须兼容运行时版本。**

### 核心要求
- ✅ grpcio 版本与 requirements.txt 一致
- ✅ grpcio-tools 版本与 grpcio 版本一致
- ✅ 生成的代码中无 `add_registered_method_handlers` 方法调用
- ✅ 运行修复脚本验证兼容性：`python3 scripts/grpc/fix_grpc_generated_code.py`

---

## 🔧 环境变量配置规范 【必须遵守】

> **容器启动必须使用 --env-file，确保关键配置正确加载。所有环境统一连接生产Node1 Docker MySQL和MongoDB。**

### 核心要求
- ✅ 使用 `--env-file` 指定环境变量文件
- ✅ 关键配置（数据库、Redis、密钥等）必须通过环境变量配置
- ✅ 禁止在代码中硬编码配置值
- ✅ **数据库连接规范**：所有环境统一连接生产Node1 Docker MySQL和MongoDB
  - MySQL: `8.210.52.217:3306`（本地开发使用公网IP），`172.18.121.222:3306`（生产环境使用内网IP）
  - MongoDB: `8.210.52.217:27017`（本地开发使用公网IP），`172.18.121.222:27017`（生产环境使用内网IP）
- ✅ **禁止修改数据库连接配置**：除非特殊情况，禁止修改数据库连接配置，确保数据一致性

---

## 🔐 安全规范

### 核心原则
- ✅ **最小权限**：只授予必要的权限
- ✅ **输入验证**：所有用户输入必须验证和过滤
- ✅ **输出编码**：所有输出必须正确编码，防止 XSS
- ✅ **敏感数据保护**：密码、密钥、Token 等必须加密存储
- ✅ **错误处理**：不暴露系统内部信息给用户
- ✅ **依赖安全**：定期更新依赖，修复已知漏洞

**详细规范**：详见 `docs/standards/security.md`

---

## 🔒 安全监控规范 【必须遵守】

> **所有生产环境必须启用安全监控，实时检测和防护安全威胁。**

### 必须监控的安全事件

1. **SQL 注入攻击**（Critical）- 自动封禁 IP
2. **XSS 攻击**（High）- 记录事件、触发告警
3. **暴力破解**（High）- 5 分钟内失败登录尝试 ≥ 5 次
4. **频率限制超出**（Medium）- 1 分钟内请求数 > 100 次
5. **可疑访问**（Medium）- 访问 `/admin`、`/.env` 等
6. **敏感操作**（High）- DELETE、UPDATE、DROP 等
7. **数据库错误**（Medium）- SQL 语法错误、连接错误

**详细规范**：详见 `docs/standards/security.md`（安全监控部分）

---

## 📦 Git 提交规范

### Commit Message 格式
```
[类型] 简短描述

- 修改文件：列出文件
- 功能说明：详细说明
- 测试情况：测试结果
```

### 类型标签
- `[新增]` - 新功能/新规则
- `[修复]` - Bug修复
- `[优化]` - 性能优化
- `[重构]` - 代码重构
- `[规则]` - 规则相关变更
- `[配置]` - 配置修改

---

## 🧪 A/B 测试和灰度发布规范 【必须遵守】

### 🔴 核心原则

> **所有新功能、重要变更、数据库变更都必须支持 A/B 测试、灰度发布和回滚机制。**

| 场景 | 要求 | 实现方式 |
|------|------|----------|
| **新功能开发** | ✅ 必须 | 使用功能开关（Feature Flag）控制 |
| **算法优化** | ✅ 必须 | 使用 A/B 测试对比效果 |
| **重要变更** | ✅ 必须 | 通过灰度发布逐步上线 |
| **数据库变更** | ✅ 必须 | 准备回滚脚本，支持快速回滚 |

**详细规范**：详见 `docs/standards/deployment.md`（A/B 测试和灰度发布部分）

---

## 🤖 基于大模型的开发流程规范 【必须遵守】

### 🔴 核心原则

> **所有基于大模型的功能开发必须遵循统一的7阶段开发流程，确保数据完整性、Prompt标准化、API调用规范化和错误处理完善性。**

**核心原则**：
- ✅ **数据准备完整性**：确保所有必需数据都已获取
- ✅ **Prompt 构建标准化**：将结构化 JSON 数据转换为自然语言格式
- ✅ **Coze API 调用规范化**：使用正确的端点和参数格式
- ✅ **流式处理健壮性**：正确处理 SSE 流，错误消息不中断流处理

**详细规范**：详见 `docs/standards/llm-development.md`

---

## 📊 性能监控规范 【必须遵守】

### 🔴 核心原则

> **所有智能运势分析流程必须记录端到端日志和性能监控，确保每个阶段的响应时间可控。**

**必须监控的阶段**：
1. **意图识别** (`intent_recognition`) - 目标：< 100ms
2. **八字计算** (`bazi_calculation`) - 目标：< 50ms
3. **规则匹配** (`rule_matching`) - 目标：< 100ms
4. **LLM 分析** (`llm_analysis`) - 目标：< 3s

**详细规范**：详见 `docs/standards/performance-monitoring.md`

---

## 🧪 测试开发规范 【必须遵守】

### 🔴 核心原则

> **所有新功能必须同步编写测试案例，测试覆盖率必须达到 50% 以上。**

**要求**：
- ✅ 新增 API 端点必须编写对应的测试案例
- ✅ 新增服务功能必须编写单元测试
- ✅ 新增业务逻辑必须编写集成测试
- ✅ 修改现有功能必须更新相关测试

**详细规范**：详见 `docs/standards/testing.md`

---

## 📁 前端目录规范 【必须遵守】

> **本地前端目录命名为 `local_frontend`，与生产前端部署分离。**

### 📋 目录命名规范

| 目录 | 用途 | 说明 |
|------|------|------|
| **`local_frontend/`** | ✅ **本地前端目录** | 用于本地开发、测试、双机部署 |
| **生产前端** | ✅ **独立部署** | 由前端团队独立部署，不在此仓库 |

### ⚠️ 重要说明

1. **禁止修改生产前端**：生产环境的前端由前端团队独立部署，后端开发人员不得修改
2. **本地前端仅用于开发测试**：`local_frontend` 目录仅用于本地开发、测试环境、双机部署
3. **路径一致性**：所有配置文件中的路径必须统一使用 `local_frontend`

---

## 📚 文档维护规范

### 🔄 文档同步原则

**核心原则**：操作更新时，文档必须同步更新

**需要同步更新的场景**：
- 新增部署步骤 → 更新部署文档
- 修改开发流程 → 更新 `.cursorrules`
- 新增规范 → 更新详细规范文档（`docs/standards/`）

**详细规范文档索引**：详见 `docs/standards/README.md`

---

## ✅ 开发检查清单汇总

> **所有开发工作必须完成相应的检查清单，确保符合规范要求。**

### 通用开发检查清单

每次开发新功能时，必须检查：
- [ ] 代码是否在热更新监控范围内（`src/`, `server/`, `services/`）
- [ ] 是否引入了新的全局状态（需要支持重置）
- [ ] 单例类是否提供了 `reset()` 方法
- [ ] 缓存是否支持清理
- [ ] 配置是否支持热加载
- [ ] **开发完成后是否触发热更新（必须！）**
- [ ] **是否验证对应功能在热更新后正常工作（必须！）**
- [ ] **如果涉及 API 端点，是否验证端点正确注册到 gRPC 网关（必须！）**
- [ ] 是否检查热更新日志（如有错误）
- [ ] 是否更新了相关文档

### API 开发检查清单

- [ ] 是否使用 Pydantic `BaseModel` 定义模型
- [ ] 所有字段是否使用 `Field` 提供描述和示例
- [ ] 关键字段是否使用 `@validator` 验证
- [ ] 响应模型是否包含 `success` 字段
- [ ] 是否在 `grpc_gateway.py` 中注册端点
- [ ] 是否编写了对应的测试案例
- [ ] 测试覆盖率是否 ≥ 50%

### 规则开发检查清单

- [ ] 所有规则匹配使用 `RuleService`
- [ ] 没有 `load_from_file`、`read_excel`、`read_json` 等文件读取调用
- [ ] 没有硬编码的规则数据
- [ ] 规则导入脚本仅用于一次性导入，不用于运行时读取
- [ ] 规则类型是否同步更新前后端
- [ ] 是否编写了规则匹配测试

**详细检查清单**：详见 `docs/checklists/` 目录

---

## 🚫 禁止操作汇总

> **以下操作严格禁止，违反将导致部署失败或系统不稳定。**

### 代码修改禁止操作

| 操作 | 状态 | 原因 | 正确方式 |
|------|------|------|---------|
| ❌ **直接在服务器上修改代码** | **禁止** | 破坏代码一致性，无法版本控制 | 本地修改 → Git → 部署 |
| ❌ **直接在服务器上修改配置文件** | **禁止** | 配置不一致，难以追踪 | 本地修改 → Git → 部署 |
| ❌ **在服务器上手动编辑文件** | **禁止** | 无法版本控制，容易丢失 | 本地修改 → Git → 部署 |
| ❌ **跳过Git直接部署** | **禁止** | 无法追踪变更，无法回滚 | 必须通过Git版本控制 |
| ❌ **服务器代码与 GitHub 不一致** | **禁止** | 破坏一致性原则 | 必须保持一致 |

### 服务管理禁止操作

| 操作 | 状态 | 原因 | 替代方案 |
|------|------|------|---------|
| ❌ `docker restart` | **禁止** | 中断服务 | 使用热更新 API |
| ❌ `docker-compose restart` | **禁止** | 中断服务 | 使用热更新 API |
| ❌ `systemctl restart` | **禁止** | 中断服务 | 使用热更新 API |
| ❌ 手动停止启动服务 | **禁止** | 中断服务 | 使用热更新 API |
| ❌ 跳过热更新直接部署 | **禁止** | 可能导致问题 | 必须经过热更新 |

### 开发规范禁止操作

| 操作 | 状态 | 原因 |
|------|------|------|
| ❌ **禁止重启服务** | **禁止** | 必须使用热更新 |
| ❌ **禁止跳过热更新直接提交代码** | **禁止** | 可能导致功能未生效 |
| ❌ **禁止只做健康检查就认为热更新成功** | **禁止** | 必须验证实际功能 |
| ❌ **硬编码本地路径** | **禁止** | 破坏跨平台兼容性 |
| ❌ **硬编码 Mac 路径** | **禁止** | 如 `/Users/zhoudt/...` |
| ❌ **硬编码 Windows 路径** | **禁止** | 如 `C:\Users\...` |
| ❌ **日志写入无异常处理** | **禁止** | 日志失败导致业务失败 |
| ❌ **从文件读取规则** | **禁止** | 规则必须从数据库读取 |
| ❌ **绕过规范检查** | **禁止** | 必须通过所有检查 |
| ❌ **合并不符合规范的代码** | **禁止** | 必须符合规范才能合并 |
| ❌ **跳过测试** | **禁止** | 必须编写和运行测试 |
| ❌ **在 proto 中定义深度嵌套的 message** | **禁止** | 应使用 JSON 字符串 |
| ❌ **直接使用 `str()` 序列化字典** | **禁止** | 应使用 `json.dumps` |
| ❌ **忽略 JSON 反序列化错误处理** | **禁止** | 必须有错误处理 |
| ❌ **绕过 `DataValidator` 直接操作数据** | **禁止** | 必须使用验证工具 |

### 部署禁止操作

| 操作 | 状态 | 原因 |
|------|------|------|
| ❌ **在服务器上构建镜像** | **禁止** | 应使用 GitHub Actions |
| ❌ **手动上传镜像文件** | **禁止** | 应使用 GHCR 自动推送 |
| ❌ **直接修改服务器代码** | **禁止** | 应推送到 GitHub，自动部署 |

---

## 📚 详细规范文档索引

所有详细规范文档位于 `docs/standards/` 目录，详见 `docs/standards/README.md`：

| 文档 | 说明 |
|------|------|
| [hot-reload.md](docs/standards/hot-reload.md) | 热更新详细规范 |
| [grpc-protocol.md](docs/standards/grpc-protocol.md) | gRPC 协议与序列化详细规范 |
| [rule-development.md](docs/standards/rule-development.md) | 规则开发详细规范 |
| [deployment.md](docs/standards/deployment.md) | 部署详细规范（增量部署、灰度发布、数据库同步、配置同步） |
| [security.md](docs/standards/security.md) | 安全规范详细文档 |
| [testing.md](docs/standards/testing.md) | 测试开发详细规范 |
| [llm-development.md](docs/standards/llm-development.md) | 基于大模型的开发流程详细规范 |
| [performance-monitoring.md](docs/standards/performance-monitoring.md) | 性能监控详细规范 |

---

## 🔄 问题复盘机制 【重要】

### 复盘流程

每次遇到问题后，必须：
1. **记录问题**：在 `docs/knowledge_base/problem_history.md` 中记录问题详情
2. **分析根因**：深入分析问题根本原因
3. **更新规范**：根据问题更新相关规范文档
4. **更新检查清单**：新增或更新相关检查项
5. **文档同步**：更新详细规范文档和 `.cursorrules`

### 复盘模板

```markdown
## 问题复盘：[问题标题] - YYYY-MM-DD

### 问题描述
...

### 根因分析
...

### 解决方案
...

### 规范更新
- 更新了哪些规范章节
- 新增了哪些检查项
- 更新了哪些禁止操作

### 预防措施
...
```

---

**核心要点总结**：
- 🔴 **最高优先级**：所有新功能必须遵守开发规范
- ✅ **开发前必读**：开发新功能前必须阅读相关规范章节并完成检查清单
- 📋 **强制检查**：所有新功能必须通过开发规范检查清单验证
- 🚫 **禁止操作**：严格禁止在服务器上直接修改代码、重启服务等操作
- 📚 **详细规范**：深入学习请查看 `docs/standards/` 目录下的详细规范文档

