# HiFate-bazi å¼€å‘ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° develop åˆ†æ”¯

name: ğŸš€ Deploy to Development

on:
  push:
    branches:
      - develop
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°å¼€å‘æœåŠ¡å™¨
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      # 2. è®¾ç½® SSH
      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
          
      # 3. æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
      - name: ğŸ“ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts
          
      # 4. éƒ¨ç½²åˆ°å¼€å‘æœåŠ¡å™¨
      - name: ğŸš€ Deploy to development server
        run: |
          ssh ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ğŸ”„ å¼€å§‹éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/HiFate-bazi
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git checkout develop
            git pull origin develop
            
            # æ£€æŸ¥å¹¶æ„å»ºåŸºç¡€é•œåƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            echo "ğŸ” æ£€æŸ¥åŸºç¡€é•œåƒ..."
            if ! docker images | grep -q "hifate-base.*latest"; then
              echo "ğŸ”¨ æ„å»ºåŸºç¡€é•œåƒï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼Œå¯èƒ½éœ€è¦5-10åˆ†é’Ÿï¼‰..."
              if [ -f "./scripts/docker/build_base.sh" ]; then
                chmod +x ./scripts/docker/build_base.sh
                ./scripts/docker/build_base.sh
              else
                echo "âš ï¸  åŸºç¡€é•œåƒæ„å»ºè„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡åŸºç¡€é•œåƒä¼˜åŒ–"
              fi
            else
              echo "âœ… åŸºç¡€é•œåƒå·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"
            fi
            
            # åœæ­¢æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker-compose -f docker-compose.yml -f docker-compose.dev.yml down
            
            # æ„å»ºåº”ç”¨é•œåƒï¼ˆä½¿ç”¨åŸºç¡€é•œåƒï¼Œåªéœ€10-20ç§’ï¼‰
            echo "ğŸ”¨ æ„å»ºåº”ç”¨é•œåƒ..."
            docker-compose -f docker-compose.yml -f docker-compose.dev.yml build
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "âœ… å¯åŠ¨æ–°å®¹å™¨..."
            docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15
            
            # å¥åº·æ£€æŸ¥ï¼ˆé‡è¯•æœºåˆ¶ï¼‰
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
            MAX_RETRIES=5
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f -s http://localhost:8001/health > /dev/null 2>&1; then
                HEALTH_CHECK_PASSED=true
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $RETRY_COUNT/$MAX_RETRIES..."
              sleep 5
            done
            
            if [ "$HEALTH_CHECK_PASSED" = true ]; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼æœåŠ¡è¿è¡Œæ­£å¸¸"
            else
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼æœåŠ¡æœªå“åº”"
              echo "ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼š"
              docker-compose -f docker-compose.yml -f docker-compose.dev.yml logs --tail=100
              echo "ğŸ“‹ æŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼š"
              docker-compose -f docker-compose.yml -f docker-compose.dev.yml ps
              exit 1
            fi
            
            echo "ğŸ‰ å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
          EOF
          
      # 5. é€šçŸ¥ï¼ˆå¯é€‰ï¼Œéœ€è¦é…ç½® Slack/é’‰é’‰ç­‰ï¼‰
      - name: ğŸ“¢ Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ å¼€å‘ç¯å¢ƒéƒ¨ç½²å¤±è´¥"
          fi
          
      # 6. æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      - name: ğŸ“Š Deployment summary
        if: success()
        run: |
          echo "=========================================="
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "=========================================="
          echo "ç¯å¢ƒï¼šå¼€å‘ç¯å¢ƒ (Development)"
          echo "åˆ†æ”¯ï¼šdevelop"
          echo "æäº¤ï¼š${{ github.sha }}"
          echo "æäº¤è€…ï¼š${{ github.actor }}"
          echo "è®¿é—®ï¼šhttp://${{ secrets.DEV_SERVER_HOST }}"
          echo "=========================================="

