# ACR é…ç½®æµ‹è¯•å·¥ä½œæµ
# ç”¨äºéªŒè¯ GitHub Secrets ä¸­çš„ ACR é…ç½®æ˜¯å¦æ­£ç¡®
# æ‰‹åŠ¨è§¦å‘ï¼šåœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow"

name: ğŸ§ª Test ACR Configuration

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        type: choice
        options:
          - login_only
          - build_and_push
        default: 'login_only'

jobs:
  test-acr:
    name: æµ‹è¯• ACR é…ç½®
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Check ACR secrets configuration
        id: check_secrets
        env:
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          echo "=========================================="
          echo "ğŸ” æ£€æŸ¥ ACR Secrets é…ç½®"
          echo "=========================================="
          echo ""
          
          # æ£€æŸ¥ secrets æ˜¯å¦å­˜åœ¨
          if [ -n "${ACR_REGISTRY}" ]; then
            echo "âœ… ACR_REGISTRY: å·²é…ç½®"
            echo "   å€¼: ${ACR_REGISTRY}"
          else
            echo "âŒ ACR_REGISTRY: æœªé…ç½®"
            echo "acr_configured=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ -n "${ACR_NAMESPACE}" ]; then
            echo "âœ… ACR_NAMESPACE: å·²é…ç½®"
            echo "   å€¼: ${ACR_NAMESPACE}"
          else
            echo "âŒ ACR_NAMESPACE: æœªé…ç½®"
            echo "acr_configured=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ -n "${ACR_USERNAME}" ]; then
            echo "âœ… ACR_USERNAME: å·²é…ç½®"
            echo "   å€¼: ${ACR_USERNAME}"
          else
            echo "âŒ ACR_USERNAME: æœªé…ç½®"
            echo "acr_configured=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ -n "${ACR_PASSWORD}" ]; then
            echo "âœ… ACR_PASSWORD: å·²é…ç½®ï¼ˆéšè—ï¼‰"
            PASSWORD_LEN=${#ACR_PASSWORD}
            echo "   é•¿åº¦: ${PASSWORD_LEN} å­—ç¬¦"
          else
            echo "âŒ ACR_PASSWORD: æœªé…ç½®"
            echo "acr_configured=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo ""
          echo "âœ… æ‰€æœ‰ ACR Secrets å·²é…ç½®"
          echo "acr_configured=true" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºé•œåƒåç§°æ ¼å¼
          echo ""
          echo "=========================================="
          echo "ğŸ“¦ é•œåƒåç§°æ ¼å¼"
          echo "=========================================="
          IMAGE_BASE="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi"
          echo "å®Œæ•´é•œåƒåç§°: ${IMAGE_BASE}:<tag>"
          echo "ç¤ºä¾‹:"
          echo "  - ${IMAGE_BASE}:master"
          echo "  - ${IMAGE_BASE}:latest"
          echo "  - ${IMAGE_BASE}:abc1234"
          echo ""
      
      - name: ğŸ” Test Docker login to ACR
        id: test_login
        if: steps.check_secrets.outputs.acr_configured == 'true'
        env:
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          echo "=========================================="
          echo "ğŸ” æµ‹è¯• Docker ç™»å½•åˆ° ACR"
          echo "=========================================="
          echo ""
          
          echo "å°è¯•ç™»å½•åˆ°: ${ACR_REGISTRY}"
          echo "ç”¨æˆ·å: ${ACR_USERNAME}"
          echo ""
          
          if echo "${ACR_PASSWORD}" | docker login "${ACR_REGISTRY}" -u "${ACR_USERNAME}" --password-stdin; then
            echo ""
            echo "âœ… Docker ç™»å½•æˆåŠŸï¼"
            echo "login_success=true" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âŒ Docker ç™»å½•å¤±è´¥ï¼"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "1. ACR_USERNAME æˆ– ACR_PASSWORD ä¸æ­£ç¡®"
            echo "2. å¦‚æœä½¿ç”¨ AccessKeyï¼Œè¯·ç¡®è®¤ï¼š"
            echo "   - AccessKey å·²å¯ç”¨"
            echo "   - AccessKey æœ‰ ACR è®¿é—®æƒé™"
            echo "3. å¦‚æœä½¿ç”¨è®¿é—®å‡­è¯ï¼Œè¯·ç¡®è®¤ï¼š"
            echo "   - è®¿é—®å¯†ç å·²è®¾ç½®"
            echo "   - ACR_USERNAME æ˜¯é˜¿é‡Œäº‘è´¦å·ï¼ˆä¸æ˜¯ AccessKey IDï¼‰"
            echo ""
            echo "login_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ğŸ³ Build and push test image
        if: steps.check_secrets.outputs.acr_configured == 'true' && steps.test_login.outputs.login_success == 'true' && github.event.inputs.test_type == 'build_and_push'
        env:
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
        run: |
          echo "=========================================="
          echo "ğŸ³ æ„å»ºå¹¶æ¨é€æµ‹è¯•é•œåƒ"
          echo "=========================================="
          echo ""
          
          IMAGE_NAME="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi"
          TEST_TAG="test-$(date +%s)"
          
          echo "åˆ›å»ºæµ‹è¯• Dockerfile..."
          cat > /tmp/Dockerfile << 'EOF'
          FROM alpine:latest
          RUN echo "ACR é…ç½®æµ‹è¯•æˆåŠŸ" > /test.txt
          CMD cat /test.txt
          EOF
          
          echo "æ„å»ºæµ‹è¯•é•œåƒ..."
          docker build -t "${IMAGE_NAME}:${TEST_TAG}" -t "${IMAGE_NAME}:test-latest" -f /tmp/Dockerfile /tmp
          
          echo "æ¨é€æµ‹è¯•é•œåƒ..."
          docker push "${IMAGE_NAME}:${TEST_TAG}"
          docker push "${IMAGE_NAME}:test-latest"
          
          echo ""
          echo "âœ… æµ‹è¯•é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
          echo "é•œåƒæ ‡ç­¾:"
          echo "  - ${IMAGE_NAME}:${TEST_TAG}"
          echo "  - ${IMAGE_NAME}:test-latest"
          echo ""
      
      - name: ğŸ“Š Test summary
        if: always()
        run: |
          echo "=========================================="
          echo "ğŸ“Š æµ‹è¯•æ€»ç»“"
          echo "=========================================="
          echo ""
          
          if [ "${{ steps.check_secrets.outputs.acr_configured }}" == "true" ]; then
            echo "âœ… ACR Secrets é…ç½®: å®Œæ•´"
          else
            echo "âŒ ACR Secrets é…ç½®: ä¸å®Œæ•´"
          fi
          
          if [ "${{ steps.test_login.outputs.login_success }}" == "true" ]; then
            echo "âœ… Docker ç™»å½•: æˆåŠŸ"
          else
            echo "âŒ Docker ç™»å½•: å¤±è´¥"
          fi
          
          echo ""
          echo "=========================================="
          echo ""
          echo "ğŸ“ ä¸‹ä¸€æ­¥ï¼š"
          echo "1. å¦‚æœç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ ACR_USERNAME å’Œ ACR_PASSWORD"
          echo "2. å¦‚æœç™»å½•æˆåŠŸï¼Œå¯ä»¥è§¦å‘ build-and-push.yml æµ‹è¯•å®Œæ•´æµç¨‹"
          echo "3. æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£: docs/ACRé…ç½®è¯´æ˜.md"
          echo ""

