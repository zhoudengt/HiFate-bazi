# HiFate-bazi æ ‡å‡† CI/CD æµç¨‹
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master æˆ– develop åˆ†æ”¯
# åŠŸèƒ½ï¼šæ„å»º Docker é•œåƒå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ (ACR)
# 
# æ ‡å‡†æµç¨‹ï¼š
#   1. æœ¬åœ°å¼€å‘ â†’ æ¨é€åˆ° GitHub
#   2. GitHub Actions è‡ªåŠ¨æ„å»ºé•œåƒ
#   3. æ¨é€åˆ° ACR
#   4. æœåŠ¡å™¨ä» ACR æ‹‰å–é•œåƒéƒ¨ç½²

name: ğŸ³ Build and Push Docker Image

on:
  push:
    branches: [ master, develop ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'latest'

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æ„å»ºå’Œç¼“å­˜ï¼‰
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
      
      # 3. æ£€æŸ¥ ACR secrets æ˜¯å¦é…ç½®å¹¶è®¾ç½®é•œåƒåç§°
      - name: ğŸ” Check ACR secrets and set image name
        id: check_acr
        run: |
          ACR_REGISTRY="${{ secrets.ACR_REGISTRY }}"
          ACR_NAMESPACE="${{ secrets.ACR_NAMESPACE }}"
          ACR_USERNAME="${{ secrets.ACR_USERNAME }}"
          ACR_PASSWORD="${{ secrets.ACR_PASSWORD }}"
          
          # æ£€æŸ¥ secrets æ˜¯å¦åŒ…å« ***ï¼ˆGitHub Actions éšè—å€¼ï¼‰
          if echo "${ACR_REGISTRY}" | grep -q "\*\*\*" || echo "${ACR_NAMESPACE}" | grep -q "\*\*\*"; then
            echo "âš ï¸  æ£€æµ‹åˆ° secrets è¢«éšè—ï¼ˆ***ï¼‰ï¼Œè§†ä¸ºæœªé…ç½®"
            ACR_REGISTRY=""
            ACR_NAMESPACE=""
            ACR_USERNAME=""
            ACR_PASSWORD=""
          fi
          
          if [ -n "$ACR_REGISTRY" ] && [ -n "$ACR_NAMESPACE" ] && [ -n "$ACR_USERNAME" ] && [ -n "$ACR_PASSWORD" ]; then
            echo "acr_configured=true" >> $GITHUB_OUTPUT
            IMAGE_NAME="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi"
            # å†æ¬¡éªŒè¯é•œåƒåç§°ä¸åŒ…å« ***
            if echo "${IMAGE_NAME}" | grep -q "\*\*\*"; then
              echo "âŒ é”™è¯¯: é•œåƒåç§°åŒ…å«æ— æ•ˆå­—ç¬¦: ${IMAGE_NAME}"
              echo "âŒ è¿™é€šå¸¸æ„å‘³ç€ ACR secrets æœªæ­£ç¡®é…ç½®"
              exit 1
            fi
            echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
            echo "âœ… ACR secrets å·²é…ç½®"
            echo "âœ… é•œåƒåç§°: ${IMAGE_NAME}"
          else
            echo "acr_configured=false" >> $GITHUB_OUTPUT
            IMAGE_NAME="hifate-bazi"
            echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
            echo "âš ï¸  ACR secrets æœªé…ç½®ï¼Œå°†è·³è¿‡é•œåƒæ¨é€"
            echo "âœ… ä½¿ç”¨æœ¬åœ°é•œåƒåç§°: ${IMAGE_NAME}"
          fi
      
      # 4. ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ï¼ˆå¦‚æœé…ç½®äº† secretsï¼‰
      - name: ğŸ” Login to ACR
        if: steps.check_acr.outputs.acr_configured == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      # 5. æå–å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ç­‰ï¼‰
      - name: ğŸ“‹ Extract metadata
        id: meta
        run: |
          IMAGE_NAME="${{ steps.check_acr.outputs.image_name }}"
          
          # éªŒè¯é•œåƒåç§°æ ¼å¼ï¼ˆä¸èƒ½åŒ…å« ***ï¼‰
          # å¦‚æœåŒ…å« ***ï¼Œè¯´æ˜ secrets æœªæ­£ç¡®é…ç½®ï¼Œä½¿ç”¨æœ¬åœ°é•œåƒåç§°
          if echo "${IMAGE_NAME}" | grep -q "\*\*\*"; then
            echo "âš ï¸  è­¦å‘Š: é•œåƒåç§°åŒ…å«æ— æ•ˆå­—ç¬¦: ${IMAGE_NAME}"
            echo "âš ï¸  è¿™é€šå¸¸æ„å‘³ç€ ACR secrets æœªæ­£ç¡®é…ç½®ï¼Œä½¿ç”¨æœ¬åœ°é•œåƒåç§°"
            IMAGE_NAME="hifate-bazi"
          fi
          
          # æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿é•œåƒåç§°æœ‰æ•ˆ
          if [ -z "${IMAGE_NAME}" ] || echo "${IMAGE_NAME}" | grep -q "\*\*\*"; then
            echo "âŒ é”™è¯¯: æ— æ³•ç¡®å®šæœ‰æ•ˆçš„é•œåƒåç§°"
            exit 1
          fi
          
          # ç”Ÿæˆæ ‡ç­¾ï¼ˆä½¿ç”¨æ¢è¡Œç¬¦åˆ†éš”ï¼Œdocker/build-push-action æ”¯æŒï¼‰
          BRANCH="${{ github.ref_name }}"
          SHA="${{ github.sha }}"
          SHA_SHORT="${SHA:0:7}"
          
          # ä½¿ç”¨å¤šè¡Œè¾“å‡ºæ ¼å¼ï¼ˆEOFï¼‰ç”Ÿæˆæ ‡ç­¾
          {
            echo "tags<<EOF"
            echo "${IMAGE_NAME}:${BRANCH}"
            echo "${IMAGE_NAME}:${SHA_SHORT}"
            echo "${IMAGE_NAME}:latest"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæ ‡ç­¾ JSONï¼ˆdocker/build-push-action éœ€è¦çš„æ ¼å¼ï¼‰
          LABELS_JSON="{\"org.opencontainers.image.title\":\"HiFate-bazi\",\"org.opencontainers.image.version\":\"${BRANCH}\",\"org.opencontainers.image.revision\":\"${SHA}\"}"
          echo "labels=${LABELS_JSON}" >> $GITHUB_OUTPUT
          
          echo "âœ… é•œåƒåç§°: ${IMAGE_NAME}"
          echo "âœ… æ ‡ç­¾:"
          echo "  - ${IMAGE_NAME}:${BRANCH}"
          echo "  - ${IMAGE_NAME}:${SHA_SHORT}"
          echo "  - ${IMAGE_NAME}:latest"
      
      # 6. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ steps.check_acr.outputs.acr_configured == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
      
      # 7. æ˜¾ç¤ºé•œåƒä¿¡æ¯
      - name: ğŸ“Š Image info
        run: |
          echo "=========================================="
          echo "âœ… é•œåƒæ„å»ºå®Œæˆï¼"
          if [ "${{ steps.check_acr.outputs.acr_configured }}" == "true" ]; then
            echo "âœ… é•œåƒå·²æ¨é€æˆåŠŸï¼"
            echo "=========================================="
            echo "é•œåƒæ ‡ç­¾ï¼š"
            echo "${{ steps.meta.outputs.tags }}" | tr ' ' '\n'
            echo "=========================================="
            echo "æ‹‰å–å‘½ä»¤ï¼š"
            echo "docker pull ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/hifate-bazi:latest"
          else
            echo "âš ï¸  Docker secrets æœªé…ç½®ï¼Œè·³è¿‡é•œåƒæ¨é€ã€‚"
          fi
          echo "=========================================="
