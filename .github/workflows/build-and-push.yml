# HiFate-bazi æ ‡å‡† CI/CD æµç¨‹
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master æˆ– develop åˆ†æ”¯
# åŠŸèƒ½ï¼šæ„å»º Docker é•œåƒå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ (ACR)

name: ğŸ³ Build and Push Docker Image

on:
  push:
    branches: [ master, develop ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'latest'

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ§¹ Clean up disk space before build
        run: |
          echo "ğŸ“Š æ„å»ºå‰ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -h
          echo ""
          echo "ğŸ§¹ æ¸…ç†ç³»ç»Ÿç©ºé—´..."
          # æ¸…ç†ä¸éœ€è¦çš„å·¥å…·å’Œç¼“å­˜
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          # æ¸…ç† Docker èµ„æº
          docker system prune -af --volumes || true
          docker builder prune -af || true
          echo ""
          echo "ğŸ“Š æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -h
      
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
          driver-opts: |
            image=moby/buildkit:latest
            network=host
      
      - name: ğŸ” Login to ACR
        if: ${{ secrets.ACR_REGISTRY != '' && secrets.ACR_NAMESPACE != '' && secrets.ACR_USERNAME != '' && secrets.ACR_PASSWORD != '' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: ğŸ³ Build and Push Docker image
        id: build
        env:
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
        run: |
          # æ£€æŸ¥ ACR é…ç½®
          if [ -z "$ACR_REGISTRY" ] || [ -z "$ACR_NAMESPACE" ] || [ -z "$ACR_USERNAME" ] || [ -z "$ACR_PASSWORD" ]; then
            echo "âš ï¸  ACR secrets æœªé…ç½®ï¼Œä»…æ„å»ºæœ¬åœ°é•œåƒ"
            IMAGE_BASE="hifate-bazi"
            PUSH_IMAGE=false
          else
            IMAGE_BASE="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi"
            PUSH_IMAGE=true
          fi
          
          # æ³¨æ„ï¼šACR ä¸æ”¯æŒ registry ç±»å‹ç¼“å­˜ï¼Œä½¿ç”¨ GHA ç¼“å­˜æˆ–ä¸ä½¿ç”¨ç¼“å­˜
          echo "â„¹ï¸  ä½¿ç”¨ GitHub Actions ç¼“å­˜åŠ é€Ÿæ„å»º"
          
          # æ„å»ºé•œåƒï¼ˆä½¿ç”¨ BuildKitï¼Œç¦ç”¨ ACR ä¸æ”¯æŒçš„ç‰¹æ€§ï¼‰
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºé•œåƒ..."
          export DOCKER_BUILDKIT=1
          
          # ç¦ç”¨ provenance å’Œ sbomï¼ˆACR ä¸æ”¯æŒè¿™äº›ç‰¹æ€§ï¼‰
          docker buildx build \
            --platform linux/amd64 \
            --file ./Dockerfile \
            --tag "${IMAGE_BASE}:${BRANCH}" \
            --tag "${IMAGE_BASE}:${SHA:0:7}" \
            --tag "${IMAGE_BASE}:latest" \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg VCS_REF=${SHA} \
            --build-arg VERSION=${BRANCH} \
            --provenance=false \
            --sbom=false \
            --output type=docker,dest=/tmp/image.tar \
            --progress=plain \
            .
          
          # å¦‚æœé…ç½®äº† ACRï¼Œæ¨é€é•œåƒ
          if [ "$PUSH_IMAGE" = "true" ]; then
            echo "ğŸ“¤ æ¨é€é•œåƒåˆ° ACR..."
            docker load -i /tmp/image.tar
            docker push "${IMAGE_BASE}:${BRANCH}" || true
            docker push "${IMAGE_BASE}:${SHA:0:7}" || true
            docker push "${IMAGE_BASE}:latest" || true
            
            echo "âœ… é•œåƒæ„å»ºå¹¶æ¨é€å®Œæˆï¼"
            echo "é•œåƒæ ‡ç­¾ï¼š"
            echo "  - ${IMAGE_BASE}:${BRANCH}"
            echo "  - ${IMAGE_BASE}:${SHA:0:7}"
            echo "  - ${IMAGE_BASE}:latest"
          else
            echo "âœ… æœ¬åœ°é•œåƒæ„å»ºå®Œæˆ"
            echo "é•œåƒæ ‡ç­¾ï¼š"
            echo "  - ${IMAGE_BASE}:${BRANCH}"
            echo "  - ${IMAGE_BASE}:latest"
          fi
      
      - name: ğŸ§¹ Clean up after build
        if: always()
        run: |
          echo "ğŸ§¹ æ„å»ºåæ¸…ç†..."
          docker system prune -af --volumes || true
          docker builder prune -af || true
          rm -f /tmp/image.tar || true
          echo "ğŸ“Š æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -h
