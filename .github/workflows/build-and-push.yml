# HiFate-bazi æ ‡å‡† CI/CD æµç¨‹
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master æˆ– develop åˆ†æ”¯
# åŠŸèƒ½ï¼šæ„å»º Docker é•œåƒå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ (ACR)
# 
# æ ‡å‡†æµç¨‹ï¼š
#   1. æœ¬åœ°å¼€å‘ â†’ æ¨é€åˆ° GitHub
#   2. GitHub Actions è‡ªåŠ¨æ„å»ºé•œåƒ
#   3. æ¨é€åˆ° ACR
#   4. æœåŠ¡å™¨ä» ACR æ‹‰å–é•œåƒéƒ¨ç½²

name: ğŸ³ Build and Push Docker Image

on:
  push:
    branches: [ master, develop ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'latest'

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æ„å»ºå’Œç¼“å­˜ï¼‰
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
      
      # 3. æ£€æŸ¥ ACR secrets æ˜¯å¦é…ç½®
      - name: ğŸ” Check ACR configuration
        id: check_acr
        run: |
          # æ£€æŸ¥ secrets æ˜¯å¦é…ç½®ï¼ˆé€šè¿‡æ£€æŸ¥é•¿åº¦ï¼Œè€Œä¸æ˜¯æ£€æŸ¥å€¼ï¼‰
          if [ -n "${{ secrets.ACR_REGISTRY }}" ] && [ -n "${{ secrets.ACR_NAMESPACE }}" ] && \
             [ -n "${{ secrets.ACR_USERNAME }}" ] && [ -n "${{ secrets.ACR_PASSWORD }}" ]; then
            echo "acr_configured=true" >> $GITHUB_OUTPUT
            echo "âœ… ACR secrets å·²é…ç½®"
          else
            echo "acr_configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  ACR secrets æœªé…ç½®ï¼Œå°†è·³è¿‡é•œåƒæ¨é€"
          fi
      
      # 4. ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ï¼ˆå¦‚æœé…ç½®äº† secretsï¼‰
      - name: ğŸ” Login to ACR
        if: steps.check_acr.outputs.acr_configured == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      # 5. æå–å…ƒæ•°æ®ï¼ˆä½¿ç”¨ docker/metadata-action é¿å… secrets æ©ç é—®é¢˜ï¼‰
      - name: ğŸ“‹ Extract metadata (ACR)
        id: meta_acr
        if: steps.check_acr.outputs.acr_configured == 'true'
        uses: docker/metadata-action@v5
        with:
          # ä½¿ç”¨å®Œæ•´çš„é•œåƒåç§°ï¼ˆç›´æ¥å¼•ç”¨ secretsï¼Œä¸é€šè¿‡ shell å˜é‡ï¼‰
          images: ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/hifate-bazi
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=HiFate-bazi
            org.opencontainers.image.description=HiFate å…«å­—ç³»ç»Ÿ
            org.opencontainers.image.vendor=HiFate Team
      
      # 6. æå–å…ƒæ•°æ®ï¼ˆæœ¬åœ°é•œåƒï¼Œå½“ ACR æœªé…ç½®æ—¶ä½¿ç”¨ï¼‰
      - name: ğŸ“‹ Extract metadata (Local)
        id: meta_local
        if: steps.check_acr.outputs.acr_configured != 'true'
        uses: docker/metadata-action@v5
        with:
          images: hifate-bazi
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=HiFate-bazi
            org.opencontainers.image.description=HiFate å…«å­—ç³»ç»Ÿ
            org.opencontainers.image.vendor=HiFate Team
      
      # 7. æ„å»ºå¹¶æ¨é€ Docker é•œåƒï¼ˆACR å·²é…ç½®ï¼‰
      - name: ğŸ³ Build and push Docker image (ACR)
        if: steps.check_acr.outputs.acr_configured == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta_acr.outputs.tags }}
          labels: ${{ steps.meta_acr.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
      
      # 8. ä»…æ„å»º Docker é•œåƒï¼ˆACR æœªé…ç½®ï¼‰
      - name: ğŸ³ Build Docker image (Local)
        if: steps.check_acr.outputs.acr_configured != 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: ${{ steps.meta_local.outputs.tags }}
          labels: ${{ steps.meta_local.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
      
      # 9. æ˜¾ç¤ºé•œåƒä¿¡æ¯
      - name: ğŸ“Š Image info
        run: |
          echo "=========================================="
          echo "âœ… é•œåƒæ„å»ºå®Œæˆï¼"
          if [ "${{ steps.check_acr.outputs.acr_configured }}" == "true" ]; then
            echo "âœ… é•œåƒå·²æ¨é€åˆ° ACRï¼"
            echo "=========================================="
            echo "é•œåƒæ ‡ç­¾ï¼š"
            echo "${{ steps.meta_acr.outputs.tags }}"
            echo "=========================================="
          else
            echo "âš ï¸  ACR secrets æœªé…ç½®ï¼Œè·³è¿‡é•œåƒæ¨é€ã€‚"
            echo "=========================================="
            echo "æœ¬åœ°é•œåƒæ ‡ç­¾ï¼š"
            echo "${{ steps.meta_local.outputs.tags }}"
          fi
          echo "=========================================="
