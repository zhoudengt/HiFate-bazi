# HiFate-bazi æ ‡å‡† CI/CD æµç¨‹
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master æˆ– develop åˆ†æ”¯
# åŠŸèƒ½ï¼šæ„å»º Docker é•œåƒå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ (ACR)

name: ğŸ³ Build and Push Docker Image

on:
  push:
    branches: [ master, develop ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'latest'

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
      
      - name: ğŸ³ Build and Push Docker image
        env:
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
        run: |
          # æ£€æŸ¥ ACR secrets æ˜¯å¦é…ç½®
          if [ -z "$ACR_REGISTRY" ] || [ -z "$ACR_NAMESPACE" ] || [ -z "$ACR_USERNAME" ] || [ -z "$ACR_PASSWORD" ]; then
            echo "âš ï¸  ACR secrets æœªé…ç½®ï¼Œä»…æ„å»ºæœ¬åœ°é•œåƒ"
            docker build --platform linux/amd64 -t hifate-bazi:${BRANCH} -t hifate-bazi:latest .
            echo "âœ… æœ¬åœ°é•œåƒæ„å»ºå®Œæˆ"
            exit 0
          fi
          
          # ç™»å½•åˆ° ACR
          echo "ğŸ” ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."
          echo "$ACR_PASSWORD" | docker login "$ACR_REGISTRY" -u "$ACR_USERNAME" --password-stdin
          
          # æ„å»ºå®Œæ•´é•œåƒåç§°
          IMAGE_BASE="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi"
          
          # æ„å»ºé•œåƒ
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºé•œåƒ..."
          docker build --platform linux/amd64 \
            -t "${IMAGE_BASE}:${BRANCH}" \
            -t "${IMAGE_BASE}:${SHA:0:7}" \
            -t "${IMAGE_BASE}:latest" \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg VCS_REF=${SHA} \
            --build-arg VERSION=${BRANCH} \
            .
          
          # æ¨é€é•œåƒ
          echo "ğŸ“¤ æ¨é€é•œåƒåˆ° ACR..."
          docker push "${IMAGE_BASE}:${BRANCH}"
          docker push "${IMAGE_BASE}:${SHA:0:7}"
          docker push "${IMAGE_BASE}:latest"
          
          echo "âœ… é•œåƒæ„å»ºå¹¶æ¨é€å®Œæˆï¼"
          echo "é•œåƒæ ‡ç­¾ï¼š"
          echo "  - ${IMAGE_BASE}:${BRANCH}"
          echo "  - ${IMAGE_BASE}:${SHA:0:7}"
          echo "  - ${IMAGE_BASE}:latest"
