# HiFate-bazi æ ‡å‡† CI/CD æµç¨‹
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master æˆ– develop åˆ†æ”¯
# åŠŸèƒ½ï¼šæ„å»º Docker é•œåƒå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ (ACR)
# 
# æ ‡å‡†æµç¨‹ï¼š
#   1. æœ¬åœ°å¼€å‘ â†’ æ¨é€åˆ° GitHub
#   2. GitHub Actions è‡ªåŠ¨æ„å»ºé•œåƒ
#   3. æ¨é€åˆ° ACR
#   4. æœåŠ¡å™¨ä» ACR æ‹‰å–é•œåƒéƒ¨ç½²

name: ğŸ³ Build and Push Docker Image

on:
  push:
    branches: [ master, develop ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'latest'

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æ„å»ºå’Œç¼“å­˜ï¼‰
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
      
      # 3. ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ï¼ˆå¦‚æœé…ç½®äº† secretsï¼‰
      - name: ğŸ” Login to ACR
        if: ${{ secrets.ACR_REGISTRY != '' && secrets.ACR_USERNAME != '' && secrets.ACR_PASSWORD != '' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      # 4. æå–å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ç­‰ï¼‰
      - name: ğŸ“‹ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.ACR_REGISTRY != '' && secrets.ACR_NAMESPACE != '' && format('{0}/{1}/hifate-bazi', secrets.ACR_REGISTRY, secrets.ACR_NAMESPACE) || 'hifate-bazi' }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      # 5. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ secrets.ACR_REGISTRY != '' && secrets.ACR_NAMESPACE != '' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
      
      # 6. æ˜¾ç¤ºé•œåƒä¿¡æ¯
      - name: ğŸ“Š Image info
        run: |
          echo "=========================================="
          echo "âœ… é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
          echo "=========================================="
          echo "é•œåƒæ ‡ç­¾ï¼š"
          echo "${{ steps.meta.outputs.tags }}" | tr ' ' '\n'
          echo "=========================================="
          echo "æ‹‰å–å‘½ä»¤ï¼š"
          echo "docker pull ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/hifate-bazi:latest"
          echo "=========================================="
