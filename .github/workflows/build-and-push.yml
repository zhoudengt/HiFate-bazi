# HiFate-bazi æ ‡å‡† CI/CD æµç¨‹
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master æˆ– develop åˆ†æ”¯
# åŠŸèƒ½ï¼šæ„å»º Docker é•œåƒå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ (ACR)
# 
# æ ‡å‡†æµç¨‹ï¼š
#   1. æœ¬åœ°å¼€å‘ â†’ æ¨é€åˆ° GitHub
#   2. GitHub Actions è‡ªåŠ¨æ„å»ºé•œåƒ
#   3. æ¨é€åˆ° ACR
#   4. æœåŠ¡å™¨ä» ACR æ‹‰å–é•œåƒéƒ¨ç½²

name: ğŸ³ Build and Push Docker Image

on:
  push:
    branches: [ master, develop ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'latest'

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æ„å»ºå’Œç¼“å­˜ï¼‰
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
      
      # 3. æ£€æŸ¥ ACR secrets æ˜¯å¦é…ç½®
      - name: ğŸ” Check ACR secrets
        id: check_acr
        run: |
          if [ -n "${{ secrets.ACR_REGISTRY }}" ] && [ -n "${{ secrets.ACR_USERNAME }}" ] && [ -n "${{ secrets.ACR_PASSWORD }}" ] && [ -n "${{ secrets.ACR_NAMESPACE }}" ]; then
            echo "acr_configured=true" >> $GITHUB_OUTPUT
            echo "âœ… ACR secrets å·²é…ç½®"
          else
            echo "acr_configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  ACR secrets æœªé…ç½®ï¼Œå°†è·³è¿‡é•œåƒæ¨é€"
          fi
      
      # 4. ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ï¼ˆå¦‚æœé…ç½®äº† secretsï¼‰
      - name: ğŸ” Login to ACR
        if: steps.check_acr.outputs.acr_configured == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      # 5. æå–å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ç­‰ï¼‰
      - name: ğŸ“‹ Extract metadata
        id: meta
        run: |
          if [ "${{ steps.check_acr.outputs.acr_configured }}" == "true" ]; then
            # ACR å·²é…ç½®ï¼Œä½¿ç”¨ ACR é•œåƒåç§°
            IMAGE_NAME="${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/hifate-bazi"
          else
            # ACR æœªé…ç½®ï¼Œä½¿ç”¨æœ¬åœ°é•œåƒåç§°
            IMAGE_NAME="hifate-bazi"
          fi
          
          # ç”Ÿæˆæ ‡ç­¾
          BRANCH="${{ github.ref_name }}"
          SHA="${{ github.sha }}"
          TAGS="${IMAGE_NAME}:${BRANCH} ${IMAGE_NAME}:${SHA:0:7} ${IMAGE_NAME}:latest"
          
          # ç”Ÿæˆæ ‡ç­¾ JSONï¼ˆdocker/build-push-action éœ€è¦çš„æ ¼å¼ï¼‰
          LABELS_JSON="{\"org.opencontainers.image.title\":\"HiFate-bazi\",\"org.opencontainers.image.version\":\"${BRANCH}\",\"org.opencontainers.image.revision\":\"${SHA}\"}"
          
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "labels=${LABELS_JSON}" >> $GITHUB_OUTPUT
          
          echo "âœ… é•œåƒåç§°: ${IMAGE_NAME}"
          echo "âœ… æ ‡ç­¾: ${TAGS}"
      
      # 6. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ steps.check_acr.outputs.acr_configured == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
      
      # 7. æ˜¾ç¤ºé•œåƒä¿¡æ¯
      - name: ğŸ“Š Image info
        run: |
          echo "=========================================="
          echo "âœ… é•œåƒæ„å»ºå®Œæˆï¼"
          if [ "${{ steps.check_acr.outputs.acr_configured }}" == "true" ]; then
            echo "âœ… é•œåƒå·²æ¨é€æˆåŠŸï¼"
            echo "=========================================="
            echo "é•œåƒæ ‡ç­¾ï¼š"
            echo "${{ steps.meta.outputs.tags }}" | tr ' ' '\n'
            echo "=========================================="
            echo "æ‹‰å–å‘½ä»¤ï¼š"
            echo "docker pull ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/hifate-bazi:latest"
          else
            echo "âš ï¸  Docker secrets æœªé…ç½®ï¼Œè·³è¿‡é•œåƒæ¨é€ã€‚"
          fi
          echo "=========================================="
