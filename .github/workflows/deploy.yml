name: 生产部署（push master）

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy-node1:
    name: Node1 生产部署
    runs-on: ubuntu-latest
    concurrency:
      group: prod-deploy
      cancel-in-progress: false

    steps:
      - name: 检出
        uses: actions/checkout@v4

      - name: 语法检查
        run: |
          python3 -c "
          import ast, sys, glob, os
          err = []
          for p in ['server/**/*.py', 'services/**/*.py', 'core/**/*.py']:
              for f in glob.glob(p, recursive=True):
                  if os.path.isfile(f):
                      try: ast.parse(open(f, encoding='utf-8').read())
                      except SyntaxError as e: err.append(f+':'+str(e.lineno))
          if err: sys.exit(1)
          print('OK')
          "

      - name: Node1 拉代码 + 热更新
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.NODE1_PUBLIC_IP }}
          username: root
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          timeout: 90
          command_timeout: 300
          script: |
            set -e
            cd /opt/HiFate-bazi || { echo "目录不存在"; exit 1; }
            git fetch origin
            git checkout -B master origin/master
            git pull origin master
            echo "版本: $(git rev-parse --short HEAD)"
            curl -sf --max-time 90 -X POST http://localhost:8001/api/v1/hot-reload/reload-all -H "Content-Type: application/json" -d "{}" || true
            sleep 8
            curl -sf --max-time 90 -X POST http://localhost:8001/api/v1/hot-reload/reload-all -H "Content-Type: application/json" -d "{}" || true
            echo "完成"

      - name: 健康检查（可选）
        continue-on-error: true
        run: |
          sleep 12
          curl -sf --max-time 15 "http://${{ secrets.NODE1_PUBLIC_IP }}:8001/health" && echo " 健康" || echo " 无法连通（可能防火墙）"
