# .github/workflows/deploy-aliyun-dual.yml
# é˜¿é‡Œäº‘åŒæœºéƒ¨ç½²å·¥ä½œæµï¼ˆå·²ç¦ç”¨è‡ªåŠ¨è§¦å‘ï¼‰
# 
# âš ï¸ æ³¨æ„ï¼šæ­¤ workflow å·²ç¦ç”¨è‡ªåŠ¨è§¦å‘ï¼Œä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
# æ¨èä½¿ç”¨å¢é‡éƒ¨ç½²è„šæœ¬ï¼šbash deploy/scripts/incremental_deploy_production.sh
# 
# åŠŸèƒ½ï¼š
# - æ„å»º Docker é•œåƒå¹¶æ¨é€åˆ° ACR
# - æ»šåŠ¨éƒ¨ç½²åˆ°åŒèŠ‚ç‚¹ï¼ˆé›¶åœæœºï¼‰
# - è‡ªåŠ¨å¥åº·æ£€æŸ¥å’Œå›æ»š
#
# è§¦å‘æ¡ä»¶ï¼š
# - ä»…æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰

name: ğŸš€ Deploy to Aliyun (Dual Nodes)

on:
  # å·²ç¦ç”¨è‡ªåŠ¨è§¦å‘ï¼Œä½¿ç”¨å¢é‡éƒ¨ç½²è„šæœ¬æ›¿ä»£
  # push:
  #   branches: [master]
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘
    inputs:
      deploy_target:
        description: 'éƒ¨ç½²ç›®æ ‡'
        required: true
        default: 'both'
        type: choice
        options:
          - both      # åŒèŠ‚ç‚¹éƒ½éƒ¨ç½²
          - node1     # ä»…éƒ¨ç½² Node 1
          - node2     # ä»…éƒ¨ç½² Node 2
      skip_build:
        description: 'è·³è¿‡æ„å»ºï¼ˆä½¿ç”¨å·²æœ‰é•œåƒï¼‰'
        required: false
        default: false
        type: boolean

env:
  ACR_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  ACR_NAMESPACE: hifate
  IMAGE_NAME: hifate-bazi

jobs:
  # ============================================
  # Job 1: æ„å»ºå¹¶æ¨é€é•œåƒ
  # ============================================
  build:
    name: ğŸ³ æ„å»º Docker é•œåƒ
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_build != 'true' }}
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_full: ${{ steps.image.outputs.full }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´
        run: |
          echo "ğŸ“Š æ¸…ç†å‰ç£ç›˜ä½¿ç”¨ï¼š"
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          docker system prune -af --volumes || true
          echo "ğŸ“Š æ¸…ç†åç£ç›˜ä½¿ç”¨ï¼š"
          df -h
      
      - name: ğŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
      
      - name: ğŸ” æ£€æŸ¥ ACR é…ç½®
        id: check_acr
        run: |
          if [ -z "${{ secrets.ACR_USERNAME }}" ] || [ -z "${{ secrets.ACR_PASSWORD }}" ]; then
            echo "âŒ ACR secrets æœªé…ç½®"
            echo "éœ€è¦çš„ secrets: ACR_USERNAME, ACR_PASSWORD"
            echo "å¯é€‰ä½†æ¨è: ACR_REGISTRY (é»˜è®¤: registry.cn-hangzhou.aliyuncs.com), ACR_NAMESPACE (é»˜è®¤: hifate)"
            exit 1
          fi
          echo "âœ… ACR secrets å·²é…ç½®"
      
      - name: ğŸ” ç™»å½•é˜¿é‡Œäº‘ ACR
        if: steps.check_acr.outcome == 'success'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: ğŸ·ï¸ ç”Ÿæˆé•œåƒæ ‡ç­¾
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' }}
      
      - name: ğŸ³ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          platforms: linux/amd64
          provenance: false  # âš ï¸ ACR å¿…éœ€ï¼ä¸æ”¯æŒ provenance
          sbom: false  # âš ï¸ ACR å¿…éœ€ï¼ä¸æ”¯æŒ sbom
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
      
      - name: ğŸ“ è¾“å‡ºé•œåƒä¿¡æ¯
        id: image
        run: |
          FULL_IMAGE="${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
          echo "full=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "âœ… é•œåƒæ„å»ºå®Œæˆ: ${FULL_IMAGE}"

  # ============================================
  # Job 2: éƒ¨ç½²åˆ° Node 1
  # ============================================
  deploy-node1:
    name: ğŸš€ éƒ¨ç½²åˆ° Node 1
    needs: build
    runs-on: ubuntu-latest
    if: |
      always() && 
      (needs.build.result == 'success' || needs.build.result == 'skipped') &&
      github.event.inputs.deploy_target != 'node2'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ”‘ è®¾ç½® SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_NODE1_SSH_KEY }}
      
      - name: ğŸ“ æ·»åŠ ä¸»æœºåˆ°å·²çŸ¥ä¸»æœº
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.ALIYUN_NODE1_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸš€ éƒ¨ç½²åˆ° Node 1
        run: |
          ssh ${{ secrets.ALIYUN_NODE1_USER }}@${{ secrets.ALIYUN_NODE1_HOST }} << 'DEPLOY_EOF'
            set -e
            
            echo "========================================"
            echo "ğŸ”„ å¼€å§‹éƒ¨ç½²åˆ° Node 1"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "========================================"
            
            cd /opt/HiFate-bazi
            
            # æ¸…ç†ç£ç›˜ç©ºé—´
            echo "ğŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´..."
            docker system prune -af 2>/dev/null || true
            docker image prune -af 2>/dev/null || true
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git checkout master
            git pull origin master
            
            # ç™»å½• ACR
            echo "ğŸ” ç™»å½• ACR..."
            echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_REGISTRY }} -u ${{ secrets.ACR_USERNAME }} --password-stdin
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
            IMAGE="${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
            docker pull ${IMAGE}
            
            # è®¾ç½®ç¯å¢ƒå˜é‡
            export IMAGE_TAG=latest
            export ACR_REGISTRY=${{ env.ACR_REGISTRY }}
            export ACR_NAMESPACE=${{ env.ACR_NAMESPACE }}
            export NODE_ID=node1
            
            # æ»šåŠ¨æ›´æ–° Web æœåŠ¡ï¼ˆé›¶åœæœºï¼‰
            echo "ğŸ”„ æ»šåŠ¨æ›´æ–° Web æœåŠ¡..."
            docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml up -d --no-deps --force-recreate web
            
            # ç­‰å¾…å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15
            
            # å¥åº·æ£€æŸ¥ï¼ˆå¢å¼ºï¼‰
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
            MAX_RETRIES=10
            RETRY=0
            HEALTH_OK=false
            
            while [ $RETRY -lt $MAX_RETRIES ]; do
              # æ£€æŸ¥åŸºæœ¬å¥åº·ç«¯ç‚¹
              if curl -sf http://localhost:8001/health > /dev/null 2>&1; then
                echo "âœ… åŸºæœ¬å¥åº·æ£€æŸ¥é€šè¿‡"
                
                # æ£€æŸ¥ API ç«¯ç‚¹ï¼ˆæ›´è¯¦ç»†çš„æ£€æŸ¥ï¼‰
                if curl -sf http://localhost:8001/api/v1/health > /dev/null 2>&1; then
                  echo "âœ… API å¥åº·æ£€æŸ¥é€šè¿‡"
                  HEALTH_OK=true
                  break
                else
                  echo "âš ï¸  API å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†åŸºæœ¬å¥åº·æ£€æŸ¥é€šè¿‡"
                  HEALTH_OK=true
                  break
                fi
              fi
              
              RETRY=$((RETRY + 1))
              echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($RETRY/$MAX_RETRIES)"
              
              # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€å’Œæ—¥å¿—ï¼ˆå¸®åŠ©è°ƒè¯•ï¼‰
              if [ $RETRY -eq 3 ] || [ $RETRY -eq 6 ] || [ $RETRY -eq 9 ]; then
                echo "ğŸ“‹ å®¹å™¨çŠ¶æ€ï¼š"
                docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml ps web || true
                echo "ğŸ“‹ æœ€è¿‘æ—¥å¿—ï¼ˆæœ€å 30 è¡Œï¼‰ï¼š"
                docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml logs --tail=30 web || true
              fi
              
              sleep 5
            done
            
            if [ "$HEALTH_OK" != "true" ]; then
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
              docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml logs --tail=50 web
              echo "ğŸ“‹ å®¹å™¨çŠ¶æ€ï¼š"
              docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml ps
              exit 1
            fi
            
            # æ›´æ–°å…¶ä»–å¾®æœåŠ¡
            echo "ğŸ”„ æ›´æ–°å¾®æœåŠ¡..."
            docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml up -d --no-deps \
              bazi-core bazi-fortune bazi-analyzer rule-service fortune-analyzer \
              payment-service fortune-rule intent-service prompt-optimizer desk-fengshui
            
            # æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            echo "========================================"
            echo "âœ… Node 1 éƒ¨ç½²å®Œæˆ"
            echo "========================================"
          DEPLOY_EOF
      
      - name: ğŸ¥ æœ€ç»ˆå¥åº·æ£€æŸ¥
        run: |
          sleep 10
          for i in {1..5}; do
            if curl -sf http://${{ secrets.ALIYUN_NODE1_HOST }}:8001/health; then
              echo "âœ… Node 1 å¥åº·æ£€æŸ¥é€šè¿‡"
              exit 0
            fi
            echo "â³ é‡è¯•å¥åº·æ£€æŸ¥ ($i/5)..."
            sleep 5
          done
          echo "âŒ Node 1 å¥åº·æ£€æŸ¥å¤±è´¥"
          exit 1

  # ============================================
  # Job 3: éƒ¨ç½²åˆ° Node 2ï¼ˆç­‰å¾… Node 1 å®Œæˆï¼‰
  # ============================================
  deploy-node2:
    name: ğŸš€ éƒ¨ç½²åˆ° Node 2
    needs: [build, deploy-node1]
    runs-on: ubuntu-latest
    if: |
      always() && 
      (needs.build.result == 'success' || needs.build.result == 'skipped') &&
      (needs.deploy-node1.result == 'success' || github.event.inputs.deploy_target == 'node2') &&
      github.event.inputs.deploy_target != 'node1'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ”‘ è®¾ç½® SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_NODE2_SSH_KEY }}
      
      - name: ğŸ“ æ·»åŠ ä¸»æœºåˆ°å·²çŸ¥ä¸»æœº
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.ALIYUN_NODE2_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸš€ éƒ¨ç½²åˆ° Node 2
        run: |
          ssh ${{ secrets.ALIYUN_NODE2_USER }}@${{ secrets.ALIYUN_NODE2_HOST }} << 'DEPLOY_EOF'
            set -e
            
            echo "========================================"
            echo "ğŸ”„ å¼€å§‹éƒ¨ç½²åˆ° Node 2"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "========================================"
            
            cd /opt/HiFate-bazi
            
            # æ¸…ç†ç£ç›˜ç©ºé—´
            echo "ğŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´..."
            docker system prune -af 2>/dev/null || true
            docker image prune -af 2>/dev/null || true
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git checkout master
            git pull origin master
            
            # ç™»å½• ACR
            echo "ğŸ” ç™»å½• ACR..."
            echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_REGISTRY }} -u ${{ secrets.ACR_USERNAME }} --password-stdin
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
            IMAGE="${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
            docker pull ${IMAGE}
            
            # è®¾ç½®ç¯å¢ƒå˜é‡
            export IMAGE_TAG=latest
            export ACR_REGISTRY=${{ env.ACR_REGISTRY }}
            export ACR_NAMESPACE=${{ env.ACR_NAMESPACE }}
            export NODE_ID=node2
            
            # æ»šåŠ¨æ›´æ–° Web æœåŠ¡
            echo "ğŸ”„ æ»šåŠ¨æ›´æ–° Web æœåŠ¡..."
            docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml up -d --no-deps --force-recreate web
            
            # ç­‰å¾…å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15
            
            # å¥åº·æ£€æŸ¥ï¼ˆå¢å¼ºï¼‰
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
            MAX_RETRIES=10
            RETRY=0
            HEALTH_OK=false
            
            while [ $RETRY -lt $MAX_RETRIES ]; do
              # æ£€æŸ¥åŸºæœ¬å¥åº·ç«¯ç‚¹
              if curl -sf http://localhost:8001/health > /dev/null 2>&1; then
                echo "âœ… åŸºæœ¬å¥åº·æ£€æŸ¥é€šè¿‡"
                
                # æ£€æŸ¥ API ç«¯ç‚¹ï¼ˆæ›´è¯¦ç»†çš„æ£€æŸ¥ï¼‰
                if curl -sf http://localhost:8001/api/v1/health > /dev/null 2>&1; then
                  echo "âœ… API å¥åº·æ£€æŸ¥é€šè¿‡"
                  HEALTH_OK=true
                  break
                else
                  echo "âš ï¸  API å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†åŸºæœ¬å¥åº·æ£€æŸ¥é€šè¿‡"
                  HEALTH_OK=true
                  break
                fi
              fi
              
              RETRY=$((RETRY + 1))
              echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($RETRY/$MAX_RETRIES)"
              
              # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€å’Œæ—¥å¿—ï¼ˆå¸®åŠ©è°ƒè¯•ï¼‰
              if [ $RETRY -eq 3 ] || [ $RETRY -eq 6 ] || [ $RETRY -eq 9 ]; then
                echo "ğŸ“‹ å®¹å™¨çŠ¶æ€ï¼š"
                docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml ps web || true
                echo "ğŸ“‹ æœ€è¿‘æ—¥å¿—ï¼ˆæœ€å 30 è¡Œï¼‰ï¼š"
                docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml logs --tail=30 web || true
              fi
              
              sleep 5
            done
            
            if [ "$HEALTH_OK" != "true" ]; then
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
              docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml logs --tail=50 web
              echo "ğŸ“‹ å®¹å™¨çŠ¶æ€ï¼š"
              docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml ps
              exit 1
            fi
            
            # æ›´æ–°å…¶ä»–å¾®æœåŠ¡
            echo "ğŸ”„ æ›´æ–°å¾®æœåŠ¡..."
            docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml up -d --no-deps \
              bazi-core bazi-fortune bazi-analyzer rule-service fortune-analyzer \
              payment-service fortune-rule intent-service prompt-optimizer desk-fengshui
            
            # æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            echo "========================================"
            echo "âœ… Node 2 éƒ¨ç½²å®Œæˆ"
            echo "========================================"
          DEPLOY_EOF
      
      - name: ğŸ¥ æœ€ç»ˆå¥åº·æ£€æŸ¥
        run: |
          sleep 10
          for i in {1..5}; do
            if curl -sf http://${{ secrets.ALIYUN_NODE2_HOST }}:8001/health; then
              echo "âœ… Node 2 å¥åº·æ£€æŸ¥é€šè¿‡"
              exit 0
            fi
            echo "â³ é‡è¯•å¥åº·æ£€æŸ¥ ($i/5)..."
            sleep 5
          done
          echo "âŒ Node 2 å¥åº·æ£€æŸ¥å¤±è´¥"
          exit 1

  # ============================================
  # Job 4: éƒ¨ç½²å®Œæˆæ±‡æ€»
  # ============================================
  summary:
    name: ğŸ“Š éƒ¨ç½²æ±‡æ€»
    needs: [build, deploy-node1, deploy-node2]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š è¾“å‡ºéƒ¨ç½²ç»“æœ
        run: |
          echo "========================================"
          echo "ğŸ“Š HiFate åŒèŠ‚ç‚¹éƒ¨ç½²ç»“æœ"
          echo "========================================"
          echo "æ„å»º: ${{ needs.build.result }}"
          echo "Node 1: ${{ needs.deploy-node1.result }}"
          echo "Node 2: ${{ needs.deploy-node2.result }}"
          echo "========================================"
          
          if [ "${{ needs.deploy-node1.result }}" == "success" ] && [ "${{ needs.deploy-node2.result }}" == "success" ]; then
            echo "âœ… åŒèŠ‚ç‚¹éƒ¨ç½²æˆåŠŸï¼"
          elif [ "${{ needs.deploy-node1.result }}" == "success" ] || [ "${{ needs.deploy-node2.result }}" == "success" ]; then
            echo "âš ï¸ éƒ¨åˆ†èŠ‚ç‚¹éƒ¨ç½²æˆåŠŸï¼Œè¯·æ£€æŸ¥å¤±è´¥çš„èŠ‚ç‚¹"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
            exit 1
          fi
      
      - name: ğŸ“¢ å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: always()
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ é’‰é’‰/ä¼ä¸šå¾®ä¿¡é€šçŸ¥
          # ç¤ºä¾‹ï¼šå‘é€åˆ°é’‰é’‰
          # curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
          #   -H 'Content-Type: application/json' \
          #   -d '{
          #     "msgtype": "markdown",
          #     "markdown": {
          #       "title": "HiFate éƒ¨ç½²é€šçŸ¥",
          #       "text": "### HiFate éƒ¨ç½²ç»“æœ\n- æ„å»º: ${{ needs.build.result }}\n- Node1: ${{ needs.deploy-node1.result }}\n- Node2: ${{ needs.deploy-node2.result }}"
          #     }
          #   }'
          echo "é€šçŸ¥å‘é€å®Œæˆ"
