name: CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ä»£ç æ ¼å¼æ£€æŸ¥ï¼ˆBlackï¼‰
        run: |
          black --check server/ src/ services/ || true
      
      - name: å¯¼å…¥æ’åºæ£€æŸ¥ï¼ˆisortï¼‰
        run: |
          isort --check server/ src/ services/ || true
      
      - name: ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆpylintï¼‰
        run: |
          pylint server/ --errors-only --disable=all --enable=E,F || true
      
      - name: ç±»å‹æ£€æŸ¥ï¼ˆmypyï¼‰
        run: |
          mypy server/ --ignore-missing-imports || true
        continue-on-error: true

  # ä»£ç å®¡æŸ¥æ£€æŸ¥
  code-review:
    name: ä»£ç å®¡æŸ¥æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºæ£€æŸ¥
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: 1. å¼€å‘è§„èŒƒç¬¦åˆæ€§æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥å¼€å‘è§„èŒƒç¬¦åˆæ€§..."
          python3 scripts/review/check_cursorrules.py --exit-on-error || exit 1
      
      - name: 2. å®‰å…¨æ¼æ´æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥å®‰å…¨æ¼æ´..."
          python3 scripts/review/check_security.py --exit-on-error || exit 1
      
      - name: 3. çƒ­æ›´æ–°æ”¯æŒæ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥çƒ­æ›´æ–°æ”¯æŒ..."
          python3 scripts/review/check_hot_reload.py || echo "âš ï¸ çƒ­æ›´æ–°æ£€æŸ¥æœ‰è­¦å‘Šï¼Œè¯·ç¡®è®¤"
        continue-on-error: true
      
      - name: 4. ç¼–ç æ–¹å¼æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥ç¼–ç æ–¹å¼..."
          python3 scripts/review/check_encoding.py --exit-on-error || exit 1
      
      - name: 5. gRPC ç«¯ç‚¹æ³¨å†Œæ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥ gRPC ç«¯ç‚¹æ³¨å†Œ..."
          python3 scripts/review/check_grpc.py --exit-on-error || exit 1
      
      - name: 6. æµ‹è¯•è¦†ç›–æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥æµ‹è¯•è¦†ç›–..."
          python3 scripts/review/check_tests.py || echo "âš ï¸ æµ‹è¯•è¦†ç›–æ£€æŸ¥æœ‰è­¦å‘Šï¼Œè¯·ç¡®è®¤"
        continue-on-error: true
      
      - name: ç»¼åˆä»£ç å®¡æŸ¥æ£€æŸ¥
        run: |
          echo "ğŸ” è¿è¡Œç»¼åˆä»£ç å®¡æŸ¥æ£€æŸ¥..."
          python3 scripts/review/code_review_check.py --exit-on-error || exit 1

  # å•å…ƒæµ‹è¯•
  test:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: é‡æ–°ç”Ÿæˆ gRPC ä»£ç 
        run: |
          # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ grpcio-tools ç‰ˆæœ¬ç”Ÿæˆä»£ç 
          python -m grpc_tools.protoc --version || echo "grpc_tools å·²å®‰è£…"
          # éªŒè¯ grpcio ç‰ˆæœ¬
          python -c "import grpc; print(f'grpcio version: {grpc.__version__}')"
          # é‡æ–°ç”Ÿæˆ gRPC ä»£ç 
          bash scripts/grpc/generate_grpc_code.sh || echo "gRPC ä»£ç ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰ä»£ç "
      
      - name: ä¿®å¤ gRPC ç‰ˆæœ¬æ£€æŸ¥
        run: |
          # ç›´æ¥ä¿®å¤æ‰€æœ‰å·²ç”Ÿæˆçš„ gRPC æ–‡ä»¶ï¼ˆç¡®ä¿ç‰ˆæœ¬æ£€æŸ¥è¢«ç¦ç”¨ï¼‰
          python3 scripts/grpc/fix_version_check.py || echo "âš ï¸ ä¿®å¤è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨ä¿®å¤"
          
          # æ‰‹åŠ¨ä¿®å¤æ‰€æœ‰ gRPC æ–‡ä»¶ï¼ˆåŒé‡ä¿é™©ï¼‰
          python3 << 'EOF'
          import re
          import glob
          import os
          
          output_dir = 'proto/generated'
          grpc_files = glob.glob(os.path.join(output_dir, '*_pb2_grpc.py'))
          
          print(f">>> æ‰‹åŠ¨ä¿®å¤ {len(grpc_files)} ä¸ª gRPC æ–‡ä»¶...")
          fixed = 0
          for grpc_file in grpc_files:
              try:
                  with open(grpc_file, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  original = content
                  
                  # ä¿®å¤ç‰ˆæœ¬æ£€æŸ¥ï¼šå…è®¸ç‰ˆæœ¬ç›¸ç­‰
                  content = re.sub(
                      r'_version_not_supported = first_version_is_lower\(GRPC_VERSION, GRPC_GENERATED_VERSION\)',
                      r'_version_not_supported = first_version_is_lower(GRPC_VERSION, GRPC_GENERATED_VERSION) if GRPC_VERSION != GRPC_GENERATED_VERSION else False',
                      content
                  )
                  
                  # ç›´æ¥ç¦ç”¨ç‰ˆæœ¬æ£€æŸ¥
                  content = re.sub(
                      r'if _version_not_supported:',
                      r'if False and _version_not_supported:  # ç‰ˆæœ¬æ£€æŸ¥å·²ç¦ç”¨',
                      content
                  )
                  
                  if content != original:
                      with open(grpc_file, 'w', encoding='utf-8') as f:
                          f.write(content)
                      fixed += 1
                      print(f"  âœ… ä¿®å¤: {os.path.basename(grpc_file)}")
              except Exception as e:
                  print(f"  âŒ ä¿®å¤å¤±è´¥ {os.path.basename(grpc_file)}: {e}")
          
          print(f"\nâœ… æ‰‹åŠ¨ä¿®å¤å®Œæˆï¼å…±ä¿®å¤ {fixed}/{len(grpc_files)} ä¸ªæ–‡ä»¶")
          EOF
          
          # éªŒè¯ä¿®å¤ç»“æœ
          echo "éªŒè¯ä¿®å¤åçš„ç‰ˆæœ¬æ£€æŸ¥é€»è¾‘..."
          python3 -c "
          import glob
          import os
          grpc_files = glob.glob('proto/generated/*_pb2_grpc.py')
          fixed = 0
          for f in grpc_files:
              with open(f, 'r') as file:
                  content = file.read()
                  if 'if False and _version_not_supported' in content:
                      fixed += 1
                      print(f'âœ… {os.path.basename(f)} å·²ä¿®å¤')
          print(f'ä¿®å¤ç»Ÿè®¡: {fixed}/{len(grpc_files)} ä¸ªæ–‡ä»¶å·²ä¿®å¤')
          if fixed < len(grpc_files):
              print('âš ï¸ è­¦å‘Šï¼šéƒ¨åˆ†æ–‡ä»¶å¯èƒ½æœªä¿®å¤')
              exit(1)
          "
          
          # éªŒè¯ç”Ÿæˆçš„ä»£ç å¯ä»¥å¯¼å…¥ï¼ˆæµ‹è¯•æ‰€æœ‰å…³é”®æ–‡ä»¶ï¼‰
          echo "éªŒè¯ gRPC ä»£ç å¯ä»¥å¯¼å…¥..."
          python3 -c "
          import sys
          sys.path.insert(0, 'proto/generated')
          try:
              import bazi_core_pb2_grpc
              print('âœ… bazi_core_pb2_grpc å¯¼å…¥æˆåŠŸ')
          except Exception as e:
              print(f'âŒ bazi_core_pb2_grpc å¯¼å…¥å¤±è´¥: {e}')
              exit(1)
          try:
              import bazi_rule_pb2_grpc
              print('âœ… bazi_rule_pb2_grpc å¯¼å…¥æˆåŠŸ')
          except Exception as e:
              print(f'âŒ bazi_rule_pb2_grpc å¯¼å…¥å¤±è´¥: {e}')
              exit(1)
          " || {
              echo "âŒ gRPC ä»£ç éªŒè¯å¤±è´¥"
              exit 1
          }
      
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        env:
          MYSQL_HOST: localhost
          MYSQL_PORT: 3306
          MYSQL_USER: root
          MYSQL_PASSWORD: test_password
          MYSQL_DATABASE: test_db
          # è®¾ç½® gRPC æœåŠ¡ URLï¼ˆé¿å…å¯¼å…¥æ—¶å‡ºé”™ï¼‰
          BAZI_CORE_SERVICE_URL: localhost:9001
          BAZI_RULE_SERVICE_URL: localhost:9004
          BAZI_FORTUNE_SERVICE_URL: localhost:9002
          BAZI_ANALYZER_SERVICE_URL: localhost:9003
          # éä¸¥æ ¼æ¨¡å¼ï¼ˆå…è®¸æœåŠ¡ä¸å¯ç”¨ï¼‰
          BAZI_CORE_SERVICE_STRICT: "0"
          BAZI_RULE_SERVICE_STRICT: "0"
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: |
          pytest tests/unit/ -v --cov=server --cov=src --cov-report=xml --cov-report=term --cov-report=html --cov-fail-under=50
      
      - name: è¿è¡Œ API æµ‹è¯•
        env:
          MYSQL_HOST: localhost
          MYSQL_PORT: 3306
          MYSQL_USER: root
          MYSQL_PASSWORD: test_password
          MYSQL_DATABASE: test_db
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: |
          pytest tests/api/ -v -m api --cov=server --cov=src --cov-report=term --cov-append
      
      - name: è¿è¡Œé›†æˆæµ‹è¯•
        env:
          MYSQL_HOST: localhost
          MYSQL_PORT: 3306
          MYSQL_USER: root
          MYSQL_PASSWORD: test_password
          MYSQL_DATABASE: test_db
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: |
          pytest tests/integration/ -v -m integration --cov=server --cov=src --cov-report=term --cov-append
      
      - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        run: |
          pytest --cov=server --cov=src --cov-report=html --cov-report=term-missing --cov-report=xml || true
      
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ° Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30
      
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # æµ‹è¯•ç»“æœæ±‡æ€»
  test-summary:
    name: æµ‹è¯•ç»“æœæ±‡æ€»
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: always()
    
    steps:
      - name: ä¸‹è½½è¦†ç›–ç‡æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
      
      - name: æµ‹è¯•ç»“æœæ±‡æ€»
        run: |
          echo "## ğŸ§ª æµ‹è¯•ç»“æœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… æµ‹è¯•é€šè¿‡æƒ…å†µ" >> $GITHUB_STEP_SUMMARY
          echo "- ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- å•å…ƒæµ‹è¯•: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆï¼Œè¯·ä¸‹è½½ Artifacts æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ æŸ¥çœ‹æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½ Artifacts: coverage-report" >> $GITHUB_STEP_SUMMARY
          echo "2. æ‰“å¼€ htmlcov/index.html æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡" >> $GITHUB_STEP_SUMMARY

