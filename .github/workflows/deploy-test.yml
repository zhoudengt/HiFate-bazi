# HiFate-bazi æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master åˆ†æ”¯

name: ğŸ§ª Deploy to Test Environment

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  # æ„å»ºå¹¶æ¨é€é•œåƒ
  build:
    name: æ„å»º Docker é•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
      
      - name: ğŸ³ Build and Push Docker image
        env:
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
        run: |
          # æ£€æŸ¥ ACR secrets æ˜¯å¦é…ç½®
          if [ -z "$ACR_REGISTRY" ] || [ -z "$ACR_NAMESPACE" ] || [ -z "$ACR_USERNAME" ] || [ -z "$ACR_PASSWORD" ]; then
            echo "âš ï¸  ACR secrets æœªé…ç½®ï¼Œè·³è¿‡æ¨é€"
            exit 0
          fi
          
          # ç™»å½•åˆ° ACR
          echo "ğŸ” ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."
          echo "$ACR_PASSWORD" | docker login "$ACR_REGISTRY" -u "$ACR_USERNAME" --password-stdin
          
          # æ„å»ºå®Œæ•´é•œåƒåç§°
          IMAGE_BASE="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi"
          
          # æ„å»ºé•œåƒ
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºé•œåƒ..."
          docker build --platform linux/amd64 \
            -t "${IMAGE_BASE}:${BRANCH}" \
            -t "${IMAGE_BASE}:latest" \
            .
          
          # æ¨é€é•œåƒ
          echo "ğŸ“¤ æ¨é€é•œåƒåˆ° ACR..."
          docker push "${IMAGE_BASE}:${BRANCH}"
          docker push "${IMAGE_BASE}:latest"
          
          echo "âœ… é•œåƒæ„å»ºå¹¶æ¨é€å®Œæˆï¼"

  # éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
  deploy:
    name: éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.TEST_SSH_PRIVATE_KEY }}
          
      - name: ğŸ“ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.TEST_SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸš€ Deploy to test server
        env:
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
          IMAGE_TAG: ${{ github.ref_name }}
          SERVER_USER: ${{ secrets.TEST_SERVER_USER }}
          SERVER_HOST: ${{ secrets.TEST_SERVER_HOST }}
        run: |
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=30 \
            "${SERVER_USER}@${SERVER_HOST}" \
            "ACR_REGISTRY='${ACR_REGISTRY}' ACR_NAMESPACE='${ACR_NAMESPACE}' ACR_USERNAME='${ACR_USERNAME}' ACR_PASSWORD='${ACR_PASSWORD}' IMAGE_TAG='${IMAGE_TAG}'" bash << 'DEPLOY_SCRIPT'
            set -e
            
            echo "ğŸ”„ å¼€å§‹éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
            
            cd /opt/HiFate-bazi
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            if ! git remote | grep -q gitee; then
              git remote add gitee https://gitee.com/zhoudengtang/hifate-prod.git || true
            fi
            git fetch gitee master --force 2>/dev/null && git checkout master && git reset --hard gitee/master || {
              echo "âš ï¸  Git æ‹‰å–å¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰ä»£ç "
            }
            
            # è®¾ç½®é•œåƒæ ‡ç­¾
            if [ -n "${ACR_REGISTRY}" ] && [ -n "${ACR_NAMESPACE}" ]; then
              FULL_IMAGE="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi:${IMAGE_TAG}"
              
              echo "ğŸ” ç™»å½•åˆ° ACR..."
              echo "${ACR_PASSWORD}" | docker login ${ACR_REGISTRY} -u ${ACR_USERNAME} --password-stdin || {
                echo "âš ï¸  ACR ç™»å½•å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ„å»º"
                FULL_IMAGE="hifate-bazi:latest"
              }
              
              if [ "${FULL_IMAGE}" != "hifate-bazi:latest" ]; then
                echo "ğŸ“¥ æ‹‰å–é•œåƒ: ${FULL_IMAGE}..."
                if docker pull ${FULL_IMAGE} 2>&1; then
                  echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ"
                else
                  echo "âš ï¸  æ‹‰å–å¤±è´¥ï¼Œå°è¯• latest"
                  FULL_IMAGE="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi:latest"
                  docker pull ${FULL_IMAGE} 2>&1 || {
                    echo "âš ï¸  ä½¿ç”¨æœ¬åœ°æ„å»º"
                    FULL_IMAGE="hifate-bazi:latest"
                  }
                fi
              fi
            else
              echo "âš ï¸  ACR æœªé…ç½®ï¼Œæœ¬åœ°æ„å»º"
              FULL_IMAGE="hifate-bazi:latest"
              docker build -t hifate-bazi:latest . || exit 1
            fi
            
            echo "ğŸ“¦ ä½¿ç”¨é•œåƒ: ${FULL_IMAGE}"
            
            # æ¸…ç†æ—§å®¹å™¨
            docker compose -f docker-compose.yml -f docker-compose.prod.yml rm -f web 2>/dev/null || true
            
            # å¯åŠ¨æœåŠ¡
            export DOCKER_IMAGE=${FULL_IMAGE}
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps web
            
            # å¥åº·æ£€æŸ¥
            echo "â³ ç­‰å¾…å¯åŠ¨..."
            sleep 20
            
            MAX_RETRIES=5
            for i in $(seq 1 $MAX_RETRIES); do
              if curl -f -s http://localhost:8001/health > /dev/null 2>&1; then
                echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
                docker image prune -f
                exit 0
              fi
              echo "â³ é‡è¯• $i/$MAX_RETRIES..."
              sleep 5
            done
            
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
            docker compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=50 web
            exit 1
          DEPLOY_SCRIPT
      
      - name: ğŸ“Š Deployment summary
        if: success()
        run: |
          echo "ğŸ‰ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          echo "æœåŠ¡å™¨ï¼š${{ secrets.TEST_SERVER_HOST }}"
          echo "æäº¤ï¼š${{ github.sha }}"
