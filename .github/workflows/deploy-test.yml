# HiFate-bazi æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master åˆ†æ”¯ï¼ˆæµ‹è¯•ç¯å¢ƒï¼š123.57.216.15ï¼‰
# åŠŸèƒ½ï¼šä»é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ (ACR) æ‹‰å–é•œåƒå¹¶éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
# 
# æ ‡å‡†æµç¨‹ï¼š
#   1. build-and-push.yml æ„å»ºé•œåƒå¹¶æ¨é€åˆ° ACR
#   2. æœ¬ workflow ä» ACR æ‹‰å–é•œåƒ
#   3. éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨ï¼ˆé›¶åœæœºæ»šåŠ¨æ›´æ–°ï¼‰

name: ğŸ§ª Deploy to Test Environment

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  # æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆä¾èµ– build-and-push.yml çš„é€»è¾‘ï¼‰
  build:
    name: æ„å»º Docker é•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      image_tag: ${{ steps.set_output.outputs.image_tag }}
      acr_configured: ${{ steps.check_acr.outputs.acr_configured }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
      
      - name: ğŸ” Check ACR configuration
        id: check_acr
        run: |
          if [ -n "${{ secrets.ACR_REGISTRY }}" ] && [ -n "${{ secrets.ACR_NAMESPACE }}" ] && \
             [ -n "${{ secrets.ACR_USERNAME }}" ] && [ -n "${{ secrets.ACR_PASSWORD }}" ]; then
            echo "acr_configured=true" >> $GITHUB_OUTPUT
            echo "âœ… ACR secrets å·²é…ç½®"
          else
            echo "acr_configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  ACR secrets æœªé…ç½®"
          fi
      
      - name: ğŸ” Login to ACR
        if: steps.check_acr.outputs.acr_configured == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: ğŸ“‹ Extract metadata
        id: meta
        if: steps.check_acr.outputs.acr_configured == 'true'
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/hifate-bazi
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: ğŸ³ Build and push Docker image
        if: steps.check_acr.outputs.acr_configured == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          provenance: false
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
      
      - name: ğŸ“ Set output
        id: set_output
        run: |
          # ä½¿ç”¨ branch åç§°ä½œä¸ºé»˜è®¤æ ‡ç­¾
          echo "image_tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT

  # éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
  deploy:
    name: éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.TEST_SSH_PRIVATE_KEY }}
          
      - name: ğŸ“ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.TEST_SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸš€ Deploy to test server
        env:
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
          IMAGE_TAG: ${{ needs.build.outputs.image_tag }}
          ACR_CONFIGURED: ${{ needs.build.outputs.acr_configured }}
        run: |
          # å°†éƒ¨ç½²è„šæœ¬å¤åˆ¶åˆ°æœåŠ¡å™¨å¹¶æ‰§è¡Œ
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=30 \
            ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }} \
            "ACR_REGISTRY='${ACR_REGISTRY}' ACR_NAMESPACE='${ACR_NAMESPACE}' ACR_USERNAME='${ACR_USERNAME}' ACR_PASSWORD='${ACR_PASSWORD}' IMAGE_TAG='${IMAGE_TAG}' ACR_CONFIGURED='${ACR_CONFIGURED}'" bash << 'DEPLOY_SCRIPT'
            set -e
            
            echo "ğŸ”„ å¼€å§‹éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/HiFate-bazi
            
            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆä½¿ç”¨ Giteeï¼Œå›½å†…æœåŠ¡å™¨è®¿é—®æ›´å¿«ï¼‰
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            # å¦‚æœ remote æ˜¯ GitHubï¼Œæ·»åŠ  Gitee ä½œä¸ºå¤‡ç”¨
            if ! git remote | grep -q gitee; then
              git remote add gitee https://gitee.com/zhoudengtang/hifate-prod.git || true
            fi
            # å¼ºåˆ¶ä» Gitee é‡ç½®åˆ°æœ€æ–°ä»£ç 
            git fetch gitee master --force 2>/dev/null && git checkout master && git reset --hard gitee/master || {
              git fetch origin master --force 2>/dev/null && git checkout master && git reset --hard origin/master || {
                echo "âš ï¸  Git æ‹‰å–å¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰ä»£ç ç»§ç»­éƒ¨ç½²"
                git checkout master 2>/dev/null || true
              }
            }
            
            # æ£€æŸ¥å¹¶è®¾ç½®é•œåƒæ ‡ç­¾
            if [ "${ACR_CONFIGURED}" == "true" ] && [ -n "${ACR_REGISTRY}" ] && [ -n "${ACR_NAMESPACE}" ]; then
              FULL_IMAGE="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi:${IMAGE_TAG}"
              
              # ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
              echo "ğŸ” ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."
              echo "${ACR_PASSWORD}" | docker login ${ACR_REGISTRY} -u ${ACR_USERNAME} --password-stdin || {
                echo "âš ï¸  ACR ç™»å½•å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ„å»º"
                FULL_IMAGE="hifate-bazi:latest"
              }
              
              # æ‹‰å–æœ€æ–°é•œåƒ
              if [ "${FULL_IMAGE}" != "hifate-bazi:latest" ]; then
                echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ: ${FULL_IMAGE}..."
                if docker pull ${FULL_IMAGE} 2>&1; then
                  echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ"
                else
                  echo "âš ï¸  æ‹‰å– ${IMAGE_TAG} æ ‡ç­¾å¤±è´¥ï¼Œå°è¯• latest æ ‡ç­¾"
                  FULL_IMAGE="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi:latest"
                  if docker pull ${FULL_IMAGE} 2>&1; then
                    echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ"
                  else
                    echo "âš ï¸  æ— æ³•æ‹‰å–è¿œç¨‹é•œåƒï¼Œå°†ä½¿ç”¨æœ¬åœ°æ„å»º"
                    FULL_IMAGE="hifate-bazi:latest"
                  fi
                fi
              fi
            else
              echo "âš ï¸  ACR æœªé…ç½®ï¼Œä½¿ç”¨æœ¬åœ°æ„å»º"
              FULL_IMAGE="hifate-bazi:latest"
              
              # æœ¬åœ°æ„å»ºé•œåƒ
              echo "ğŸ”¨ æœ¬åœ°æ„å»ºé•œåƒ..."
              docker build -t hifate-bazi:latest . || {
                echo "âŒ æœ¬åœ°æ„å»ºå¤±è´¥"
                exit 1
              }
            fi
            
            echo "ğŸ“¦ ä½¿ç”¨é•œåƒ: ${FULL_IMAGE}"
            
            # åªæ¸…ç†å·²åœæ­¢çš„å®¹å™¨ï¼ˆé›¶åœæœºéƒ¨ç½²ï¼‰
            echo "ğŸ§¹ æ¸…ç†å·²åœæ­¢çš„å®¹å™¨..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml rm -f web 2>/dev/null || true
            
            # æ¸…ç†å¯èƒ½å­˜åœ¨çš„åŒååƒµå°¸å®¹å™¨
            CONTAINER_IDS=$(docker ps -a --filter "name=hifate-web" --filter "status=exited" --format "{{.ID}}" 2>/dev/null || true)
            if [ -n "$CONTAINER_IDS" ]; then
              echo "ğŸ§¹ æ¸…ç†åƒµå°¸å®¹å™¨..."
              echo "$CONTAINER_IDS" | xargs -r docker rm -f 2>/dev/null || true
            fi
            
            # è®¾ç½®ç¯å¢ƒå˜é‡å¹¶å¯åŠ¨æœåŠ¡
            export DOCKER_IMAGE=${FULL_IMAGE}
            
            # æ»šåŠ¨æ›´æ–°ï¼ˆé›¶åœæœºéƒ¨ç½²ï¼‰
            echo "ğŸ”„ æ»šåŠ¨æ›´æ–°æœåŠ¡ï¼ˆé›¶åœæœºï¼‰..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps web
            
            # ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨
            echo "â³ ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨..."
            sleep 20
            
            # å¥åº·æ£€æŸ¥ï¼ˆé‡è¯•æœºåˆ¶ï¼‰
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
            MAX_RETRIES=5
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f -s http://localhost:8001/health > /dev/null 2>&1; then
                HEALTH_CHECK_PASSED=true
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $RETRY_COUNT/$MAX_RETRIES..."
              sleep 5
            done
            
            if [ "$HEALTH_CHECK_PASSED" = true ]; then
              echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼æœåŠ¡è¿è¡Œæ­£å¸¸"
              
              # æ›´æ–°å…¶ä»–å¾®æœåŠ¡
              docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps bazi-analyzer 2>/dev/null || true
              sleep 5
              docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps fortune-analyzer 2>/dev/null || true
              sleep 5
              docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps rule-service 2>/dev/null || true
              
              echo "âœ… æ‰€æœ‰æœåŠ¡æ›´æ–°å®Œæˆ"
            else
              echo "âŒ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼æœåŠ¡æœªå“åº”"
              echo "ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼š"
              docker compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=100 web
              echo "ğŸ“‹ æŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼š"
              docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
              exit 1
            fi
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            echo "ğŸ‰ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
          DEPLOY_SCRIPT
      
      - name: ğŸ“Š Deployment summary
        if: success()
        run: |
          echo "=========================================="
          echo "ğŸ‰ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          echo "=========================================="
          echo "ç¯å¢ƒï¼šæµ‹è¯•ç¯å¢ƒ (Test)"
          echo "æœåŠ¡å™¨ï¼š${{ secrets.TEST_SERVER_HOST }}"
          echo "åˆ†æ”¯ï¼šmaster"
          echo "æäº¤ï¼š${{ github.sha }}"
          echo "æäº¤è€…ï¼š${{ github.actor }}"
          echo "è®¿é—®ï¼šhttp://${{ secrets.TEST_SERVER_HOST }}:8001"
          echo "=========================================="