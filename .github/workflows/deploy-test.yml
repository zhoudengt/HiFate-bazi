# HiFate-bazi æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master åˆ†æ”¯ï¼ˆæµ‹è¯•ç¯å¢ƒï¼š123.57.216.15ï¼‰
# åŠŸèƒ½ï¼šä» GitHub Container Registry æ‹‰å–é•œåƒå¹¶éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨

name: ğŸ§ª Deploy to Test Environment

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: []  # å¯ä»¥æ·»åŠ ä¾èµ– build-and-push job
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® SSH
      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.TEST_SSH_PRIVATE_KEY }}
          
      # 3. æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
      - name: ğŸ“ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.TEST_SERVER_HOST }} >> ~/.ssh/known_hosts
      
      # 4. ç­‰å¾…é•œåƒæ„å»ºå®Œæˆï¼ˆå¦‚æœ build-and-push workflow æ­£åœ¨è¿è¡Œï¼‰
      - name: â³ Wait for image build
        run: |
          echo "â³ ç­‰å¾…é•œåƒæ„å»ºå®Œæˆ..."
          MAX_WAIT=600
          WAIT_TIME=0
          while [ $WAIT_TIME -lt $MAX_WAIT ]; do
            if docker pull ghcr.io/${{ github.repository }}/hifate-bazi:master 2>/dev/null; then
              echo "âœ… é•œåƒå·²å¯ç”¨"
              break
            fi
            echo "â³ é•œåƒå°šæœªå°±ç»ªï¼Œç­‰å¾…ä¸­... ($WAIT_TIME/$MAX_WAIT ç§’)"
            sleep 30
            WAIT_TIME=$((WAIT_TIME + 30))
          done
      
      # 5. éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
      - name: ğŸš€ Deploy to test server
        run: |
          ssh ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ğŸ”„ å¼€å§‹éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/HiFate-bazi
            
            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆç”¨äº docker-compose é…ç½®ï¼‰
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git checkout master
            git pull origin master
            
            # ç™»å½•åˆ° GitHub Container Registry
            echo "ğŸ” ç™»å½•åˆ° GitHub Container Registry..."
            if [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
              echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            else
              echo "âš ï¸  GHCR_TOKEN æœªé…ç½®ï¼Œå°è¯•ä½¿ç”¨ GITHUB_TOKEN"
              echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin || {
                echo "âŒ æ— æ³•ç™»å½•åˆ° GitHub Container Registry"
                exit 1
              }
            fi
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
            IMAGE_TAG="ghcr.io/${{ github.repository }}/hifate-bazi:master"
            docker pull ${IMAGE_TAG} || {
              echo "âš ï¸  æ‹‰å– master æ ‡ç­¾å¤±è´¥ï¼Œå°è¯• latest æ ‡ç­¾"
              IMAGE_TAG="ghcr.io/${{ github.repository }}/hifate-bazi:latest"
              docker pull ${IMAGE_TAG}
            }
            
            echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ: ${IMAGE_TAG}"
            
            # æ»šåŠ¨æ›´æ–°ï¼ˆé›¶åœæœºéƒ¨ç½²ï¼‰- ä½¿ç”¨æ‹‰å–çš„é•œåƒ
            echo "ğŸ”„ æ»šåŠ¨æ›´æ–°æœåŠ¡..."
            DOCKER_IMAGE=${IMAGE_TAG} docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml up -d --no-deps web
            
            # ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨
            echo "â³ ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨..."
            sleep 20
            
            # å¥åº·æ£€æŸ¥ï¼ˆé‡è¯•æœºåˆ¶ï¼‰
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
            MAX_RETRIES=5
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f -s http://localhost:8001/health > /dev/null 2>&1; then
                HEALTH_CHECK_PASSED=true
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $RETRY_COUNT/$MAX_RETRIES..."
              sleep 5
            done
            
            if [ "$HEALTH_CHECK_PASSED" = true ]; then
              echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼æœåŠ¡è¿è¡Œæ­£å¸¸"
              
              # æ›´æ–°å…¶ä»–å¾®æœåŠ¡ï¼ˆä½¿ç”¨æ‹‰å–çš„é•œåƒï¼‰
              DOCKER_IMAGE=${IMAGE_TAG} docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml up -d --no-deps bazi-analyzer
              sleep 10
              DOCKER_IMAGE=${IMAGE_TAG} docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml up -d --no-deps fortune-analyzer
              sleep 10
              DOCKER_IMAGE=${IMAGE_TAG} docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml up -d --no-deps rule-service
              
              echo "âœ… æ‰€æœ‰æœåŠ¡æ›´æ–°å®Œæˆ"
            else
              echo "âŒ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼æœåŠ¡æœªå“åº”"
              echo "ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼š"
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=100 web
              echo "ğŸ“‹ æŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼š"
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
              exit 1
            fi
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            echo "ğŸ‰ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
          EOF
      
      # 6. æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      - name: ğŸ“Š Deployment summary
        if: success()
        run: |
          echo "=========================================="
          echo "ğŸ‰ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          echo "=========================================="
          echo "ç¯å¢ƒï¼šæµ‹è¯•ç¯å¢ƒ (Test)"
          echo "æœåŠ¡å™¨ï¼š${{ secrets.TEST_SERVER_HOST }}"
          echo "åˆ†æ”¯ï¼šmaster"
          echo "æäº¤ï¼š${{ github.sha }}"
          echo "æäº¤è€…ï¼š${{ github.actor }}"
          echo "é•œåƒï¼šghcr.io/${{ github.repository }}/hifate-bazi:master"
          echo "è®¿é—®ï¼šhttp://${{ secrets.TEST_SERVER_HOST }}:8001"
          echo "=========================================="

