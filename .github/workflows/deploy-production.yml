# HiFate-bazi ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master åˆ†æ”¯

name: ğŸš€ Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      # 2. è®¾ç½® SSH
      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          
      # 3. æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
      - name: ğŸ“ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts
          
      # 4. å¤‡ä»½æ•°æ®åº“ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
      - name: ğŸ’¾ Backup database
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ğŸ’¾ å¤‡ä»½ç”Ÿäº§æ•°æ®åº“..."
            cd /opt/HiFate-bazi
            
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            mkdir -p backups
            
            # å¤‡ä»½æ•°æ®åº“
            BACKUP_FILE="backups/mysql_backup_$(date +%Y%m%d_%H%M%S).sql"
            docker-compose exec -T mysql mysqldump -u root -p${MYSQL_ROOT_PASSWORD} bazi_system > $BACKUP_FILE
            
            echo "âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆï¼š$BACKUP_FILE"
            
            # ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
            find backups/ -name "mysql_backup_*.sql" -mtime +7 -delete
          EOF
          
      # 5. éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      - name: ğŸš€ Deploy to production server
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ğŸ”„ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/HiFate-bazi
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git checkout master
            git pull origin master
            
            # æ„å»ºæ–°é•œåƒ
            echo "ğŸ”¨ æ„å»ºæ–°é•œåƒ..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache
            
            # æ»šåŠ¨æ›´æ–°ï¼ˆé›¶åœæœºéƒ¨ç½²ï¼‰
            echo "ğŸ”„ æ»šåŠ¨æ›´æ–°æœåŠ¡..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps --build web
            
            # ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨
            echo "â³ ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨..."
            sleep 20
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
            if curl -f http://localhost:8001/api/health; then
              echo "âœ… æ–°ç‰ˆæœ¬è¿è¡Œæ­£å¸¸ï¼Œæ›´æ–°å…¶ä»–æœåŠ¡..."
              
              # æ›´æ–°å…¶ä»–å¾®æœåŠ¡
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps --build bazi-analyzer
              sleep 10
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps --build fortune-analyzer
              sleep 10
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps --build rule-service
              
              echo "âœ… æ‰€æœ‰æœåŠ¡æ›´æ–°å®Œæˆ"
            else
              echo "âŒ æ–°ç‰ˆæœ¬å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå›æ»š..."
              
              # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
              git reset --hard HEAD^
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
              
              echo "âŒ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
              exit 1
            fi
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            # æœ€ç»ˆå¥åº·æ£€æŸ¥
            echo "ğŸ¥ æœ€ç»ˆå¥åº·æ£€æŸ¥..."
            sleep 10
            if curl -f http://localhost:8001/api/health; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸"
            else
              echo "âŒ éƒ¨ç½²åå¥åº·æ£€æŸ¥å¤±è´¥"
              docker-compose logs --tail=50
              exit 1
            fi
            
            echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
          EOF
          
      # 6. é€šçŸ¥ï¼ˆå¯é€‰ï¼Œéœ€è¦é…ç½® Slack/é’‰é’‰ç­‰ï¼‰
      - name: ğŸ“¢ Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥"
          fi
          
      # 7. æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      - name: ğŸ“Š Deployment summary
        if: success()
        run: |
          echo "=========================================="
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "=========================================="
          echo "ç¯å¢ƒï¼šç”Ÿäº§ç¯å¢ƒ (Production)"
          echo "åˆ†æ”¯ï¼šmaster"
          echo "æäº¤ï¼š${{ github.sha }}"
          echo "æäº¤è€…ï¼š${{ github.actor }}"
          echo "è®¿é—®ï¼šhttps://${{ secrets.PROD_SERVER_HOST }}"
          echo "=========================================="
          
      # 8. åˆ›å»ºå‘å¸ƒæ ‡ç­¾
      - name: ğŸ·ï¸ Create release tag
        if: success()
        run: |
          TAG_NAME="v$(date +%Y%m%d_%H%M%S)"
          git tag $TAG_NAME
          git push origin $TAG_NAME
          echo "âœ… å·²åˆ›å»ºå‘å¸ƒæ ‡ç­¾ï¼š$TAG_NAME"

