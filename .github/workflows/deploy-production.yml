# HiFate-bazi ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master åˆ†æ”¯

name: ğŸš€ Deploy to Production

on:
  workflow_dispatch:  # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»æ‰‹åŠ¨éƒ¨ç½²ï¼‰
  workflow_run:
    workflows: ["ğŸ³ Build and Push Docker Image"]  # ç­‰å¾…æ„å»ºå·¥ä½œæµå®Œæˆ
    types:
      - completed
    branches:
      - master

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
    runs-on: ubuntu-latest
    # å¦‚æœæ˜¯é€šè¿‡ workflow_run è§¦å‘ï¼Œç¡®ä¿æ„å»ºå·¥ä½œæµæˆåŠŸ
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      # 2. è®¾ç½® SSH
      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          
      # 3. æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
      - name: ğŸ“ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts
          
      # 4. å¤‡ä»½æ•°æ®åº“ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
      - name: ğŸ’¾ Backup database
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ğŸ’¾ å¤‡ä»½ç”Ÿäº§æ•°æ®åº“..."
            cd /opt/HiFate-bazi
            
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            mkdir -p backups
            
            # å¤‡ä»½æ•°æ®åº“ï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„æ•°æ®åº“åï¼‰
            BACKUP_FILE="backups/mysql_backup_$(date +%Y%m%d_%H%M%S).sql"
            DB_NAME="${MYSQL_DATABASE:-hifate_bazi}"
            docker-compose exec -T mysql mysqldump -u root -p${MYSQL_ROOT_PASSWORD} ${DB_NAME} > $BACKUP_FILE
            
            echo "âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆï¼š$BACKUP_FILE"
            
            # ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
            find backups/ -name "mysql_backup_*.sql" -mtime +7 -delete
          EOF
          
      # 5. æ£€æŸ¥ ACR é…ç½®
      - name: ğŸ” Check ACR configuration
        id: check_acr
        run: |
          if [ -n "${{ secrets.ACR_REGISTRY }}" ] && [ -n "${{ secrets.ACR_NAMESPACE }}" ] && \
             [ -n "${{ secrets.ACR_USERNAME }}" ] && [ -n "${{ secrets.ACR_PASSWORD }}" ]; then
            echo "acr_configured=true" >> $GITHUB_OUTPUT
            echo "âœ… ACR secrets å·²é…ç½®"
            echo "ACR_REGISTRY=${{ secrets.ACR_REGISTRY }}" >> $GITHUB_OUTPUT
            echo "ACR_NAMESPACE=${{ secrets.ACR_NAMESPACE }}" >> $GITHUB_OUTPUT
          else
            echo "acr_configured=false" >> $GITHUB_OUTPUT
            echo "âŒ ACR secrets æœªé…ç½®ï¼Œæ— æ³•éƒ¨ç½²"
            exit 1
          fi
      
      # 6. ç­‰å¾…é•œåƒæ„å»ºå®Œæˆï¼ˆå¦‚æœ build-and-push workflow æ­£åœ¨è¿è¡Œï¼‰
      - name: â³ Wait for image build
        if: steps.check_acr.outputs.acr_configured == 'true'
        env:
          ACR_REGISTRY: ${{ steps.check_acr.outputs.ACR_REGISTRY }}
          ACR_NAMESPACE: ${{ steps.check_acr.outputs.ACR_NAMESPACE }}
        run: |
          echo "â³ ç­‰å¾…é•œåƒæ„å»ºå®Œæˆ..."
          # ç­‰å¾…æœ€å¤š 10 åˆ†é’Ÿï¼Œæ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡
          MAX_WAIT=600
          WAIT_TIME=0
          IMAGE_BASE="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi"
          
          while [ $WAIT_TIME -lt $MAX_WAIT ]; do
            if docker pull ${IMAGE_BASE}:master 2>/dev/null; then
              echo "âœ… é•œåƒå·²å¯ç”¨: ${IMAGE_BASE}:master"
              break
            fi
            echo "â³ é•œåƒå°šæœªå°±ç»ªï¼Œç­‰å¾…ä¸­... ($WAIT_TIME/$MAX_WAIT ç§’)"
            sleep 30
            WAIT_TIME=$((WAIT_TIME + 30))
          done
          
          if [ $WAIT_TIME -ge $MAX_WAIT ]; then
            echo "âš ï¸  ç­‰å¾…è¶…æ—¶ï¼Œå°†å°è¯•æ‹‰å– latest æ ‡ç­¾"
          fi
      
      # 7. éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      - name: ğŸš€ Deploy to production server
        if: steps.check_acr.outputs.acr_configured == 'true'
        env:
          ACR_REGISTRY: ${{ steps.check_acr.outputs.ACR_REGISTRY }}
          ACR_NAMESPACE: ${{ steps.check_acr.outputs.ACR_NAMESPACE }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} << EOF
            set -e
            
            echo "ğŸ”„ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/HiFate-bazi
            
            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆç”¨äº docker-compose é…ç½®ï¼‰
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git checkout master
            git pull origin master
            
            # ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ (ACR)
            echo "ğŸ” ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ (ACR)..."
            echo "${ACR_PASSWORD}" | docker login ${ACR_REGISTRY} -u ${ACR_USERNAME} --password-stdin || {
              echo "âŒ ACR ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ ACR secrets é…ç½®"
              echo "éœ€è¦çš„ secrets: ACR_REGISTRY, ACR_NAMESPACE, ACR_USERNAME, ACR_PASSWORD"
              exit 1
            }
            echo "âœ… ACR ç™»å½•æˆåŠŸ"
            
            # æ£€æŸ¥ MySQL å’Œ Redis æ˜¯å¦è¿è¡Œ
            echo "ğŸ” æ£€æŸ¥ MySQL å’Œ Redis æœåŠ¡..."
            if ! docker ps --format "{{.Names}}" | grep -q "hifate-mysql"; then
              echo "âš ï¸  MySQL å®¹å™¨æœªè¿è¡Œï¼Œå¯åŠ¨ MySQL..."
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d mysql
              echo "â³ ç­‰å¾… MySQL å¯åŠ¨..."
              sleep 20
            else
              echo "âœ… MySQL å®¹å™¨æ­£åœ¨è¿è¡Œ"
            fi
            
            if ! docker ps --format "{{.Names}}" | grep -q "hifate-redis"; then
              echo "âš ï¸  Redis å®¹å™¨æœªè¿è¡Œï¼Œå¯åŠ¨ Redis..."
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d redis
              echo "â³ ç­‰å¾… Redis å¯åŠ¨..."
              sleep 10
            else
              echo "âœ… Redis å®¹å™¨æ­£åœ¨è¿è¡Œ"
            fi
            
            # éªŒè¯ MySQL è¿æ¥
            echo "ğŸ” éªŒè¯ MySQL è¿æ¥..."
            MAX_MYSQL_RETRIES=10
            MYSQL_RETRY=0
            MYSQL_READY=false
            while [ $MYSQL_RETRY -lt $MAX_MYSQL_RETRIES ]; do
              if docker exec hifate-mysql mysqladmin ping -h localhost -u root -p"${MYSQL_ROOT_PASSWORD}" --silent 2>/dev/null; then
                MYSQL_READY=true
                echo "âœ… MySQL è¿æ¥æ­£å¸¸"
                break
              fi
              MYSQL_RETRY=$((MYSQL_RETRY + 1))
              echo "â³ MySQL è¿æ¥å¤±è´¥ï¼Œé‡è¯• $MYSQL_RETRY/$MAX_MYSQL_RETRIES..."
              sleep 3
            done
            
            if [ "$MYSQL_READY" = false ]; then
              echo "âŒ MySQL è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ MySQL å®¹å™¨çŠ¶æ€å’Œå¯†ç é…ç½®"
              docker logs hifate-mysql --tail=30
              exit 1
            fi
            
            # æ‹‰å–æœ€æ–°é•œåƒï¼ˆä»é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ ACRï¼‰
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
            IMAGE_BASE="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi"
            IMAGE_TAG="${IMAGE_BASE}:master"
            
            if docker pull ${IMAGE_TAG} 2>&1; then
              echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ: ${IMAGE_TAG}"
            else
              echo "âš ï¸  æ‹‰å– master æ ‡ç­¾å¤±è´¥ï¼Œå°è¯• latest æ ‡ç­¾"
              IMAGE_TAG="${IMAGE_BASE}:latest"
              if docker pull ${IMAGE_TAG} 2>&1; then
                echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ: ${IMAGE_TAG}"
              else
                echo "âŒ æ— æ³•æ‹‰å–é•œåƒï¼Œè¯·æ£€æŸ¥ï¼š"
                echo "   1. é•œåƒæ˜¯å¦å·²æ„å»ºå¹¶æ¨é€åˆ° ACR"
                echo "   2. ACR ç™»å½•æ˜¯å¦æˆåŠŸ"
                echo "   3. é•œåƒæ ‡ç­¾æ˜¯å¦æ­£ç¡®"
                exit 1
              fi
            fi
            
            # åªæ¸…ç†å·²åœæ­¢çš„å®¹å™¨ï¼ˆé›¶åœæœºéƒ¨ç½²ï¼‰
            echo "ğŸ§¹ æ¸…ç†å·²åœæ­¢çš„å®¹å™¨..."
            # åªåˆ é™¤å·²åœæ­¢çš„å®¹å™¨ï¼Œä¸å½±å“æ­£åœ¨è¿è¡Œçš„å®¹å™¨
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml rm -f web 2>/dev/null || true
            
            # æ¸…ç†å¯èƒ½å­˜åœ¨çš„åŒååƒµå°¸å®¹å™¨ï¼ˆå·²åœæ­¢ä½†æœªåˆ é™¤çš„ï¼‰
            CONTAINER_IDS=$(docker ps -a --filter "name=hifate-web" --filter "status=exited" --format "{{.ID}}" 2>/dev/null || true)
            if [ -n "$CONTAINER_IDS" ]; then
              echo "ğŸ§¹ æ¸…ç†åƒµå°¸å®¹å™¨..."
              echo "$CONTAINER_IDS" | xargs -r docker rm -f 2>/dev/null || true
            fi
            
            # æ»šåŠ¨æ›´æ–°ï¼ˆé›¶åœæœºéƒ¨ç½²ï¼‰- Docker Compose ä¼šè‡ªåŠ¨å¤„ç†
            # up å‘½ä»¤ä¼šå…ˆå¯åŠ¨æ–°å®¹å™¨ï¼Œå¥åº·æ£€æŸ¥é€šè¿‡åå†åœæ­¢æ—§å®¹å™¨
            echo "ğŸ”„ æ»šåŠ¨æ›´æ–°æœåŠ¡ï¼ˆé›¶åœæœºï¼‰..."
            DOCKER_IMAGE=${IMAGE_TAG} docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml up -d --no-deps web
            
            # ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨
            echo "â³ ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨..."
            sleep 20
            
            # å¥åº·æ£€æŸ¥ï¼ˆå¢å¼ºé‡è¯•æœºåˆ¶ï¼‰
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
            MAX_RETRIES=10  # å¢åŠ é‡è¯•æ¬¡æ•°ï¼ˆç”Ÿäº§ç¯å¢ƒæ›´ä¸¥æ ¼ï¼‰
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              # æ£€æŸ¥åŸºæœ¬å¥åº·ç«¯ç‚¹
              if curl -f -s http://localhost:8001/health > /dev/null 2>&1; then
                echo "âœ… åŸºæœ¬å¥åº·æ£€æŸ¥é€šè¿‡"
                
                # æ£€æŸ¥ API ç«¯ç‚¹ï¼ˆæ›´è¯¦ç»†çš„æ£€æŸ¥ï¼‰
                if curl -f -s http://localhost:8001/api/v1/health > /dev/null 2>&1; then
                  echo "âœ… API å¥åº·æ£€æŸ¥é€šè¿‡"
                  HEALTH_CHECK_PASSED=true
                  break
                else
                  echo "âš ï¸  API å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†åŸºæœ¬å¥åº·æ£€æŸ¥é€šè¿‡"
                  # å¦‚æœåŸºæœ¬å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œä¹Ÿè®¤ä¸ºæˆåŠŸï¼ˆå‘åå…¼å®¹ï¼‰
                  HEALTH_CHECK_PASSED=true
                  break
                fi
              fi
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $RETRY_COUNT/$MAX_RETRIES..."
              
              # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€å’Œæ—¥å¿—ï¼ˆå¸®åŠ©è°ƒè¯•ï¼‰
              if [ $RETRY_COUNT -eq 3 ] || [ $RETRY_COUNT -eq 6 ] || [ $RETRY_COUNT -eq 9 ]; then
                echo "ğŸ“‹ å®¹å™¨çŠ¶æ€ï¼š"
                docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml ps web || true
                echo "ğŸ“‹ æœ€è¿‘æ—¥å¿—ï¼ˆæœ€å 30 è¡Œï¼‰ï¼š"
                docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml logs --tail=30 web || true
              fi
              
              sleep 5
            done
            
            if [ "$HEALTH_CHECK_PASSED" = true ]; then
              echo "âœ… æ–°ç‰ˆæœ¬è¿è¡Œæ­£å¸¸ï¼Œæ›´æ–°å…¶ä»–æœåŠ¡..."
              
              # æ›´æ–°å…¶ä»–å¾®æœåŠ¡ï¼ˆä½¿ç”¨æ‹‰å–çš„é•œåƒï¼‰
              DOCKER_IMAGE=${IMAGE_TAG} docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml up -d --no-deps bazi-analyzer
              sleep 10
              DOCKER_IMAGE=${IMAGE_TAG} docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml up -d --no-deps fortune-analyzer
              sleep 10
              DOCKER_IMAGE=${IMAGE_TAG} docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml up -d --no-deps rule-service
              
              echo "âœ… æ‰€æœ‰æœåŠ¡æ›´æ–°å®Œæˆ"
            else
              echo "âŒ æ–°ç‰ˆæœ¬å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå›æ»š..."
              
              # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼ˆæ‹‰å–ä¸Šä¸€ä¸ª commit çš„é•œåƒï¼‰
              echo "ğŸ”„ å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬..."
              PREVIOUS_SHA=$(git rev-parse HEAD^)
              IMAGE_BASE="${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi"
              PREVIOUS_IMAGE="${IMAGE_BASE}:${PREVIOUS_SHA:0:7}"
              
              # æ¸…ç†å·²åœæ­¢çš„å®¹å™¨ï¼ˆå›æ»šæ—¶ä¹Ÿéœ€è¦é›¶åœæœºï¼‰
              echo "ğŸ§¹ æ¸…ç†å·²åœæ­¢çš„å®¹å™¨..."
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml rm -f web 2>/dev/null || true
              CONTAINER_IDS=$(docker ps -a --filter "name=hifate-web" --filter "status=exited" --format "{{.ID}}" 2>/dev/null || true)
              if [ -n "$CONTAINER_IDS" ]; then
                echo "$CONTAINER_IDS" | xargs -r docker rm -f 2>/dev/null || true
              fi
              
              # å°è¯•æ‹‰å–ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„é•œåƒ
              if docker pull ${PREVIOUS_IMAGE} 2>/dev/null; then
                echo "âœ… æ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„é•œåƒ: ${PREVIOUS_IMAGE}"
                DOCKER_IMAGE=${PREVIOUS_IMAGE} docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml up -d --no-deps web
              else
                echo "âš ï¸  æœªæ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„é•œåƒï¼Œå°è¯• latest æ ‡ç­¾"
                FALLBACK_IMAGE="${IMAGE_BASE}:latest"
                if docker pull ${FALLBACK_IMAGE} 2>/dev/null; then
                  echo "âœ… ä½¿ç”¨ latest æ ‡ç­¾å›æ»š: ${FALLBACK_IMAGE}"
                  DOCKER_IMAGE=${FALLBACK_IMAGE} docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.image.yml up -d --no-deps web
                else
                  echo "âŒ æ— æ³•å›æ»šï¼šæ‰¾ä¸åˆ°å¯ç”¨çš„é•œåƒ"
                  echo "è¯·æ‰‹åŠ¨æ£€æŸ¥ ACR ä¸­çš„é•œåƒæˆ–è”ç³»ç®¡ç†å‘˜"
                  exit 1
                fi
              fi
              
              echo "âŒ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
              exit 1
            fi
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            # æœ€ç»ˆå¥åº·æ£€æŸ¥ï¼ˆå¢å¼ºé‡è¯•æœºåˆ¶ï¼‰
            echo "ğŸ¥ æœ€ç»ˆå¥åº·æ£€æŸ¥..."
            sleep 10
            MAX_FINAL_RETRIES=5  # å¢åŠ é‡è¯•æ¬¡æ•°
            FINAL_RETRY_COUNT=0
            FINAL_HEALTH_CHECK_PASSED=false
            
            while [ $FINAL_RETRY_COUNT -lt $MAX_FINAL_RETRIES ]; do
              # æ£€æŸ¥åŸºæœ¬å¥åº·ç«¯ç‚¹
              if curl -f -s http://localhost:8001/health > /dev/null 2>&1; then
                echo "âœ… æœ€ç»ˆåŸºæœ¬å¥åº·æ£€æŸ¥é€šè¿‡"
                
                # æ£€æŸ¥ API ç«¯ç‚¹
                if curl -f -s http://localhost:8001/api/v1/health > /dev/null 2>&1; then
                  echo "âœ… æœ€ç»ˆ API å¥åº·æ£€æŸ¥é€šè¿‡"
                  FINAL_HEALTH_CHECK_PASSED=true
                  break
                else
                  echo "âš ï¸  æœ€ç»ˆ API å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†åŸºæœ¬å¥åº·æ£€æŸ¥é€šè¿‡"
                  FINAL_HEALTH_CHECK_PASSED=true
                  break
                fi
              fi
              
              FINAL_RETRY_COUNT=$((FINAL_RETRY_COUNT + 1))
              echo "â³ æœ€ç»ˆå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $FINAL_RETRY_COUNT/$MAX_FINAL_RETRIES..."
              sleep 5
            done
            
            if [ "$FINAL_HEALTH_CHECK_PASSED" = true ]; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸"
            else
              echo "âŒ éƒ¨ç½²åå¥åº·æ£€æŸ¥å¤±è´¥"
              echo "ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼š"
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=100 web
              echo "ğŸ“‹ æŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼š"
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
              exit 1
            fi
            
            echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
          EOF
          
      # 8. é€šçŸ¥ï¼ˆå¯é€‰ï¼Œéœ€è¦é…ç½® Slack/é’‰é’‰ç­‰ï¼‰
      - name: ğŸ“¢ Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥"
          fi
          
      # 9. æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      - name: ğŸ“Š Deployment summary
        if: success()
        run: |
          echo "=========================================="
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "=========================================="
          echo "ç¯å¢ƒï¼šç”Ÿäº§ç¯å¢ƒ (Production)"
          echo "åˆ†æ”¯ï¼šmaster"
          echo "æäº¤ï¼š${{ github.sha }}"
          echo "æäº¤è€…ï¼š${{ github.actor }}"
          echo "è®¿é—®ï¼šhttps://${{ secrets.PROD_SERVER_HOST }}"
          echo "=========================================="
          
      # 10. åˆ›å»ºå‘å¸ƒæ ‡ç­¾
      - name: ğŸ·ï¸ Create release tag
        if: success()
        run: |
          TAG_NAME="v$(date +%Y%m%d_%H%M%S)"
          git tag $TAG_NAME
          git push origin $TAG_NAME
          echo "âœ… å·²åˆ›å»ºå‘å¸ƒæ ‡ç­¾ï¼š$TAG_NAME"

