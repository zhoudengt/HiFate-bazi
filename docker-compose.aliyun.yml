# docker-compose.aliyun.yml
# 阿里云双机部署专用配置
# 使用方式：docker-compose -f docker-compose.yml -f docker-compose.aliyun.yml up -d

version: '3.8'

services:
  # ============================================
  # 主 Web 服务（覆盖基础配置）
  # ============================================
  web:
    image: ${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-web
    ports:
      - "8001:8001"
    environment:
      # 环境
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
      NODE_ID: ${NODE_ID:-node1}
      
      # 阿里云 RDS MySQL（使用外部数据库）
      MYSQL_HOST: ${RDS_MYSQL_HOST}
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      
      # 阿里云 Redis（使用外部缓存）
      REDIS_HOST: ${ALIYUN_REDIS_HOST}
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      
      # 内部服务地址（同节点容器）
      BAZI_CORE_SERVICE_URL: bazi-compute:9001
      BAZI_FORTUNE_SERVICE_URL: bazi-compute:9001
      BAZI_ANALYZER_SERVICE_URL: bazi-compute:9001
      FORTUNE_ANALYSIS_SERVICE_URL: bazi-compute:9001
      BAZI_RULE_SERVICE_URL: rule-engine:9004
      FORTUNE_RULE_SERVICE_URL: rule-engine:9004
      PAYMENT_SERVICE_URL: payment-service:9006
      INTENT_SERVICE_URL: intent-service:9008
      PROMPT_OPTIMIZER_SERVICE_URL: prompt-optimizer:9009
      DESK_FENGSHUI_SERVICE_URL: desk-fengshui:9010
      
      # 其他配置
      COZE_ACCESS_TOKEN: ${COZE_ACCESS_TOKEN:-}
      COZE_BOT_ID: ${COZE_BOT_ID:-}
      SECRET_KEY: ${SECRET_KEY}
      TZ: Asia/Shanghai
    volumes:
      - ./logs/web:/app/logs
    # 移除本地 MySQL/Redis 依赖（使用阿里云托管服务）
    depends_on: []
    restart: always
    networks:
      - hifate-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ============================================
  # 微服务配置（全部使用阿里云 RDS/Redis）
  # ============================================
  
  bazi-compute:
    image: ${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-bazi-compute
    ports:
      - "9001:9001"
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
      MYSQL_HOST: ${RDS_MYSQL_HOST}
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: ${ALIYUN_REDIS_HOST}
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      SERVICE_PORT: 9001
      TZ: Asia/Shanghai
    command: python services/bazi_compute/grpc_server.py --port 9001
    depends_on: []
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 800M

  rule-engine:
    image: ${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-rule-engine
    ports:
      - "9004:9004"
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
      MYSQL_HOST: ${RDS_MYSQL_HOST}
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: ${ALIYUN_REDIS_HOST}
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      SERVICE_PORT: 9004
      TZ: Asia/Shanghai
    command: python services/rule_engine/grpc_server.py --port 9004
    depends_on: []
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 400M

  payment-service:
    image: ${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-payment-service
    ports:
      - "9006:9006"
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
      MYSQL_HOST: ${RDS_MYSQL_HOST}
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: ${ALIYUN_REDIS_HOST}
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      SERVICE_PORT: 9006
      TZ: Asia/Shanghai
    command: python services/payment_service/grpc_server.py --port 9006
    volumes:
      - ./logs/payment-service:/app/logs
    depends_on: []
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  intent-service:
    image: ${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-intent-service
    ports:
      - "9008:9008"
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
      MYSQL_HOST: ${RDS_MYSQL_HOST}
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: ${ALIYUN_REDIS_HOST}
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      SERVICE_PORT: 9008
      SERVICE_HOST: 0.0.0.0
      COZE_ACCESS_TOKEN: ${COZE_ACCESS_TOKEN:-}
      INTENT_BOT_ID: ${INTENT_BOT_ID:-}
      TZ: Asia/Shanghai
    command: python services/intent_service/grpc_server.py
    volumes:
      - ./logs/intent-service:/app/logs
    depends_on: []
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  prompt-optimizer:
    image: ${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-prompt-optimizer
    ports:
      - "9009:9009"
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
      MYSQL_HOST: ${RDS_MYSQL_HOST}
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: ${ALIYUN_REDIS_HOST}
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      SERVICE_PORT: 9009
      SERVICE_HOST: 0.0.0.0
      COZE_ACCESS_TOKEN: ${COZE_ACCESS_TOKEN:-}
      COZE_BOT_ID: ${COZE_BOT_ID:-}
      TZ: Asia/Shanghai
    command: python services/prompt_optimizer/grpc_server.py
    volumes:
      - ./logs/prompt-optimizer:/app/logs
    depends_on: []
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  desk-fengshui:
    image: ${ACR_REGISTRY}/${ACR_NAMESPACE}/hifate-bazi:${IMAGE_TAG:-latest}
    container_name: hifate-desk-fengshui
    ports:
      - "9010:9010"
    environment:
      APP_ENV: production
      DEBUG: "False"
      LOG_LEVEL: WARNING
      MYSQL_HOST: ${RDS_MYSQL_HOST}
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-hifate_bazi}
      REDIS_HOST: ${ALIYUN_REDIS_HOST}
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      SERVICE_PORT: 9010
      TZ: Asia/Shanghai
    command: python services/desk_fengshui/grpc_server.py --port 9010
    volumes:
      - ./logs/desk-fengshui:/app/logs
    depends_on: []
    restart: always
    networks:
      - hifate-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

# ============================================
# 禁用本地数据库服务（使用阿里云托管服务）
# ============================================
  mysql:
    # 禁用本地 MySQL，使用阿里云 RDS
    profiles:
      - disabled

  redis:
    # 禁用本地 Redis，使用阿里云 Redis
    profiles:
      - disabled

networks:
  hifate-network:
    driver: bridge
