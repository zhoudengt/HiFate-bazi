# A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒè§„èŒƒ ã€å¿…é¡»éµå®ˆã€‘

## ğŸ”´ æ ¸å¿ƒåŸåˆ™

> **æ‰€æœ‰æ–°åŠŸèƒ½ã€é‡è¦å˜æ›´ã€æ•°æ®åº“å˜æ›´éƒ½å¿…é¡»æ”¯æŒ A/B æµ‹è¯•ã€ç°åº¦å‘å¸ƒå’Œå›æ»šæœºåˆ¶ã€‚**

| åœºæ™¯ | è¦æ±‚ | å®ç°æ–¹å¼ |
|------|------|----------|
| **æ–°åŠŸèƒ½å¼€å‘** | âœ… å¿…é¡» | ä½¿ç”¨åŠŸèƒ½å¼€å…³ï¼ˆFeature Flagï¼‰æ§åˆ¶ |
| **ç®—æ³•ä¼˜åŒ–** | âœ… å¿…é¡» | ä½¿ç”¨ A/B æµ‹è¯•å¯¹æ¯”æ•ˆæœ |
| **é‡è¦å˜æ›´** | âœ… å¿…é¡» | é€šè¿‡ç°åº¦å‘å¸ƒé€æ­¥ä¸Šçº¿ |
| **æ•°æ®åº“å˜æ›´** | âœ… å¿…é¡» | å‡†å¤‡å›æ»šè„šæœ¬ï¼Œæ”¯æŒå¿«é€Ÿå›æ»š |
| **æ€§èƒ½ä¼˜åŒ–** | âœ… æ¨è | ä½¿ç”¨ A/B æµ‹è¯•éªŒè¯æ•ˆæœ |

## ğŸ“‹ A/B æµ‹è¯•å¼€å‘è§„èŒƒ

### 1. æ–°åŠŸèƒ½å¿…é¡»æ”¯æŒ A/B æµ‹è¯•

**è¦æ±‚**ï¼š
- æ‰€æœ‰æ–°åŠŸèƒ½ã€ç®—æ³•ä¼˜åŒ–ã€UI å˜æ›´å¿…é¡»æ”¯æŒ A/B æµ‹è¯•
- ä½¿ç”¨ `server/utils/ab_test.py` æ¡†æ¶
- åˆ›å»ºå®éªŒï¼Œåˆ†é…å˜ä½“ï¼Œè®°å½•äº‹ä»¶

**å¼€å‘æµç¨‹**ï¼š

```python
# 1. å¯¼å…¥ A/B æµ‹è¯•æ¡†æ¶
from server.utils.ab_test import get_ab_test_manager, Experiment, ExperimentStatus

# 2. åˆ›å»ºå®éªŒï¼ˆåœ¨æœåŠ¡å¯åŠ¨æ—¶æˆ–é€šè¿‡ APIï¼‰
manager = get_ab_test_manager()
experiment = Experiment(
    name="æ–°ç®—æ³•æµ‹è¯•",
    description="æµ‹è¯•æ–°çš„å…«å­—è®¡ç®—ç®—æ³•",
    status=ExperimentStatus.RUNNING,
    traffic_percent=50.0,  # 50% æµé‡
    variants={"A": 50, "B": 50}  # A/B å„ 50%
)
manager.create_experiment(experiment)

# 3. åœ¨ä»£ç ä¸­ä½¿ç”¨
variant = manager.assign_variant("æ–°ç®—æ³•æµ‹è¯•", user_id=user_id)
if variant == "A":
    result = old_algorithm.calculate()
elif variant == "B":
    result = new_algorithm.calculate()

# 4. è®°å½•ç”¨æˆ·è¡Œä¸ºäº‹ä»¶
manager.record_event("æ–°ç®—æ³•æµ‹è¯•", user_id, "click", {"button": "submit"})
```

## ğŸš© åŠŸèƒ½å¼€å…³å¼€å‘è§„èŒƒ

### 1. æ–°åŠŸèƒ½å¿…é¡»ä½¿ç”¨åŠŸèƒ½å¼€å…³

**è¦æ±‚**ï¼š
- æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»é€šè¿‡åŠŸèƒ½å¼€å…³æ§åˆ¶
- æ”¯æŒå¿«é€Ÿå¼€å¯/å…³é—­ï¼Œæ— éœ€é‡æ–°éƒ¨ç½²
- æ”¯æŒç™¾åˆ†æ¯”ç°åº¦ã€ç™½åå•ã€é»‘åå•

**å¼€å‘æµç¨‹**ï¼š

```python
# 1. å¯¼å…¥åŠŸèƒ½å¼€å…³æ¡†æ¶
from server.utils.feature_flag import get_feature_flag_manager, FeatureFlag, FlagType

# 2. åˆ›å»ºåŠŸèƒ½å¼€å…³ï¼ˆåœ¨æœåŠ¡å¯åŠ¨æ—¶æˆ–é€šè¿‡ APIï¼‰
manager = get_feature_flag_manager()
flag = FeatureFlag(
    name="æ–°åŠŸèƒ½",
    description="æ–°åŠŸèƒ½å¼€å…³",
    enabled=True,
    flag_type=FlagType.PERCENTAGE,  # ç™¾åˆ†æ¯”å¼€å…³
    value=10.0  # 10% æµé‡
)
manager.create_flag(flag)

# 3. åœ¨ä»£ç ä¸­æ£€æŸ¥å¼€å…³
if manager.is_enabled("æ–°åŠŸèƒ½", user_id=user_id):
    # ä½¿ç”¨æ–°åŠŸèƒ½
    result = new_feature.process()
else:
    # ä½¿ç”¨æ—§åŠŸèƒ½æˆ–è·³è¿‡
    result = old_feature.process()
```

**åŠŸèƒ½å¼€å…³ç±»å‹**ï¼š
- `FlagType.BOOLEAN` - å¸ƒå°”å¼€å…³ï¼ˆå…¨éƒ¨å¼€å¯/å…³é—­ï¼‰
- `FlagType.PERCENTAGE` - ç™¾åˆ†æ¯”å¼€å…³ï¼ˆç°åº¦å‘å¸ƒï¼‰
- `FlagType.WHITELIST` - ç™½åå•ï¼ˆæŒ‡å®šç”¨æˆ·ï¼‰
- `FlagType.BLACKLIST` - é»‘åå•ï¼ˆæ’é™¤ç”¨æˆ·ï¼‰

## ğŸš€ ç°åº¦å‘å¸ƒè§„èŒƒ

### 1. é‡è¦å˜æ›´å¿…é¡»é€šè¿‡ç°åº¦å‘å¸ƒ

**è¦æ±‚**ï¼š
- æ‰€æœ‰é‡è¦åŠŸèƒ½å˜æ›´ã€æ€§èƒ½ä¼˜åŒ–ã€æ¶æ„è°ƒæ•´å¿…é¡»é€šè¿‡ç°åº¦å‘å¸ƒ
- ä» 10% æµé‡å¼€å§‹ï¼Œé€æ­¥å¢åŠ åˆ° 100%
- ç›‘æ§å…³é”®æŒ‡æ ‡ï¼Œéšæ—¶å‡†å¤‡å›æ»š

**ç°åº¦å‘å¸ƒæµç¨‹**ï¼š

```bash
# 1. å¼€å‘æ–°åŠŸèƒ½
git checkout -b feature/new-feature
# ... å¼€å‘ä»£ç  ...

# 2. åˆ›å»ºåŠŸèƒ½å¼€å…³ï¼ˆ10% æµé‡ï¼‰
# ä½¿ç”¨ API æˆ–ä»£ç åˆ›å»ºåŠŸèƒ½å¼€å…³

# 3. æ‰§è¡Œç°åº¦å‘å¸ƒ
./deploy.sh
# é€‰æ‹© 8) ç°åº¦å‘å¸ƒ

# 4. ç›‘æ§ç°åº¦ç‰ˆæœ¬
docker logs -f hifate-bazi-web-gray

# 5. é€æ­¥å¢åŠ æµé‡ï¼ˆå¦‚æœæ­£å¸¸ï¼‰
# è°ƒæ•´è´Ÿè½½å‡è¡¡å™¨é…ç½®ï¼š10% â†’ 20% â†’ 50% â†’ 100%

# 6. å¦‚æœå¼‚å¸¸ï¼Œç«‹å³å›æ»š
./deploy.sh
# é€‰æ‹© 10) ç°åº¦å‘å¸ƒå›æ»š
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
- é”™è¯¯ç‡ï¼ˆåº” < 1%ï¼‰
- å“åº”æ—¶é—´ï¼ˆä¸åº”æ˜æ˜¾å¢åŠ ï¼‰
- ä¸šåŠ¡æŒ‡æ ‡ï¼ˆè½¬åŒ–ç‡ã€ç”¨æˆ·æ»¡æ„åº¦ç­‰ï¼‰
- ç³»ç»Ÿèµ„æºï¼ˆCPUã€å†…å­˜ã€æ•°æ®åº“è¿æ¥ç­‰ï¼‰

## ğŸ”„ æ•°æ®åº“å›æ»šè§„èŒƒ

### 1. æ‰€æœ‰æ•°æ®åº“å˜æ›´å¿…é¡»å‡†å¤‡å›æ»šè„šæœ¬

**è¦æ±‚**ï¼š
- æ‰€æœ‰æ•°æ®åº“è¿ç§»å¿…é¡»åŒæ—¶å‡†å¤‡å›æ»šè„šæœ¬
- å›æ»šè„šæœ¬å¿…é¡»ç»è¿‡æµ‹è¯•éªŒè¯
- å›æ»šè„šæœ¬å‘½åè§„èŒƒï¼š`rollback_YYYYMMDD_HHMMSS_description.sql`

**å›æ»šè„šæœ¬è§„èŒƒ**ï¼š
- å¿…é¡»ä½¿ç”¨äº‹åŠ¡ï¼ˆ`START TRANSACTION` / `COMMIT`ï¼‰
- å¿…é¡»ä½¿ç”¨ `IF EXISTS` é¿å…é”™è¯¯
- å¿…é¡»åŒ…å«éªŒè¯ SQLï¼ˆå¯é€‰ï¼‰
- å¿…é¡»è®°å½•å›æ»šæ—¥å¿—

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ˜¯å¦åˆ›å»ºäº†å›æ»šè„šæœ¬
- [ ] å›æ»šè„šæœ¬æ˜¯å¦ç»è¿‡æµ‹è¯•éªŒè¯
- [ ] å›æ»šè„šæœ¬æ˜¯å¦ä½¿ç”¨äº‹åŠ¡
- [ ] æ˜¯å¦å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒå¿«é€Ÿæ‰§è¡Œå›æ»š

## ğŸ“ å¼€å‘æ£€æŸ¥æ¸…å•

æ¯æ¬¡å¼€å‘æ–°åŠŸèƒ½æˆ–é‡è¦å˜æ›´æ—¶ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

### A/B æµ‹è¯•æ£€æŸ¥
- [ ] æ˜¯å¦åˆ›å»ºäº† A/B æµ‹è¯•å®éªŒ
- [ ] æ˜¯å¦åœ¨ä»£ç ä¸­æ­£ç¡®åˆ†é…å˜ä½“
- [ ] æ˜¯å¦è®°å½•äº†å…³é”®äº‹ä»¶
- [ ] æ˜¯å¦å¯ä»¥é€šè¿‡ API æŸ¥çœ‹ç»Ÿè®¡

### åŠŸèƒ½å¼€å…³æ£€æŸ¥
- [ ] æ˜¯å¦åˆ›å»ºäº†åŠŸèƒ½å¼€å…³
- [ ] æ˜¯å¦åœ¨ä»£ç ä¸­æ­£ç¡®æ£€æŸ¥å¼€å…³
- [ ] æ˜¯å¦æ”¯æŒå¿«é€Ÿå…³é—­
- [ ] æ˜¯å¦å¯ä»¥é€šè¿‡ API åˆ‡æ¢

### ç°åº¦å‘å¸ƒæ£€æŸ¥
- [ ] æ˜¯å¦æ‰§è¡Œäº†ç°åº¦å‘å¸ƒ
- [ ] æ˜¯å¦é…ç½®äº†æµé‡åˆ†é…
- [ ] æ˜¯å¦ç›‘æ§äº†å…³é”®æŒ‡æ ‡
- [ ] æ˜¯å¦å‡†å¤‡äº†å›æ»šæ–¹æ¡ˆ

### æ•°æ®åº“å›æ»šæ£€æŸ¥
- [ ] æ˜¯å¦åˆ›å»ºäº†å›æ»šè„šæœ¬
- [ ] å›æ»šè„šæœ¬æ˜¯å¦ç»è¿‡æµ‹è¯•
- [ ] æ˜¯å¦å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒå¿«é€Ÿæ‰§è¡Œ

